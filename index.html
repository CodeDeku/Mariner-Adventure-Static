<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edward Jones: The Mariner of the Damned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
		/* --- CORE LAYOUT & TYPOGRAPHY --- */
		body { font-family: 'Crimson Text', serif; background-color: #050a10; color: #cdd5e0; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
		h1, h2, h3, .cinzel { font-family: 'Cinzel', serif; }
		.journal-font { font-family: 'Dancing Script', cursive; font-size: 1.2rem; line-height: 1.6; color: #94a3b8; }
		::-webkit-scrollbar { width: 8px; }
		::-webkit-scrollbar-track { background: #0f172a; }
		::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
		.text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
		.fade-in { animation: fadeIn 0.8s ease-in; }
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		
		/* FIX #3: Force Spectral Text Color */
		.spectral-text-glow { color: #93c5fd !important; text-shadow: 0 0 5px rgba(59, 130, 246, 0.6); font-weight: 700; }
		
		/* --- NEW UI: RADIAL MENU & BACKPACK --- */
		/* RADIAL CONTAINER */
		.radial-container { 
			position: relative; width: 100%; height: 160px; 
			display: flex; align-items: center; justify-content: center;
		}

		/* HUB: Central Status */
		.radial-hub { 
			position: absolute; 
			top: calc(50% - 40px); left: calc(50% - 40px); 
			width: 80px; height: 80px; 
			border-radius: 50% !important;
			background-color: #0f172a !important; 
			background-image: radial-gradient(circle at 30% 30%, #164e63 0%, #1e293b 50%, #0f172a 100%) !important;
			border: 1px solid #22d3ee !important;
			z-index: 20; 
			display: flex; flex-direction: column; align-items: center; justify-content: center; 
			transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 
				inset 0 0 20px rgba(34, 211, 238, 0.1),
				inset 4px 4px 10px rgba(255, 255, 255, 0.1),
				0 0 15px rgba(34, 211, 238, 0.4) !important;
		}

		/* Drained State */
		.radial-hub.drained { 
			border-color: #475569 !important; 
			box-shadow: none !important; 
			background-color: #0f172a !important; 
			background-image: radial-gradient(circle, #0f172a 30%, #020617 100%) !important;
			color: #64748b;
		}
		.radial-hub.drained div { opacity: 0.5; filter: grayscale(1); }
		
		.radial-hub:not(.drained) {
			border: 1px solid #22d3ee !important; 
			box-shadow: 
				inset 0 0 20px rgba(34, 211, 238, 0.1),
				inset 4px 4px 10px rgba(255, 255, 255, 0.1),
				0 0 15px rgba(34, 211, 238, 0.4) !important; 
		}
		/* RADIAL GRID MASK */
		.radial-grid-mask {
			position: absolute;
			inset: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			border-radius: 0.25rem;
			perspective: 600px;
			z-index: 0;
		}
		.radial-planar-grid {
			position: absolute;
			inset: -50%;
			width: 200%;
			height: 200%;
			z-index: 0;
			background-image: 
				linear-gradient(rgba(34, 211, 238, 0.15) 1px, transparent 1px),
				linear-gradient(90deg, rgba(34, 211, 238, 0.15) 1px, transparent 1px);
			background-size: 40px 40px;
			transform: rotateX(60deg) translateY(-50px) translateZ(-60px);
			transform-origin: center center;
			-webkit-mask-image: linear-gradient(to top, transparent 0%, black 40%, black 80%, transparent 100%);
			mask-image: linear-gradient(to top, transparent 0%, black 40%, black 80%, transparent 100%);
			pointer-events: none;
		}

		/* TETHERS: Connection Lines */
		.spectral-tether { 
			position: absolute; height: 3px; width: 42%; 
			top: 50%; left: 50%; z-index: 5; 
			transform-origin: left center; 
			background: linear-gradient(90deg, #334155 0%, #0f172a 100%);
			border-radius: 2px; overflow: hidden; 
		}
		.spectral-tether::after {
			content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 0%; 
			background: linear-gradient(90deg, #22d3ee, #cffafe); 
			box-shadow: 0 0 10px #22d3ee;
			transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		}
		.spectral-tether.flowing::after { width: 100%; }
		.tether-nw { transform: rotate(200deg); } .tether-ne { transform: rotate(340deg); } 
		.tether-sw { transform: rotate(160deg); } .tether-se { transform: rotate(20deg); }

		/* CREW NODES */
		.crew-node { 
			position: absolute; 
			width: 120px; 
			height: 55px; 
			background-color: #0f172a !important;
			background-image: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
			border: 1px solid #374151; 
			border-radius: 4px; 
			display: flex; flex-direction: column; align-items: center; justify-content: center; 
			z-index: 10; 
			cursor: pointer; 
			transition: all 0.3s ease-out; 
		}
		
		/* CREW ACTIVE STATE (Directional Gradients) */
		.crew-node.charged {
			border: 1px solid #22d3ee !important; 
			box-shadow: 
				inset 0 0 20px rgba(34, 211, 238, 0.1),
				inset 4px 4px 10px rgba(255, 255, 255, 0.1),
				0 0 15px rgba(34, 211, 238, 0.4) !important; 
			background-color: #1e293b !important;
			transition: all 0.2s ease-out; 
			z-index: 20;
		}

		/* Directional Gradients */
		#node-gareth.charged { background-image: radial-gradient(circle at 100% 100%, rgba(34, 211, 238, 0.25) 0%, #1e293b 50%, #0f172a 100%) !important; }
		#node-quinn.charged { background-image: radial-gradient(circle at 0% 100%, rgba(34, 211, 238, 0.25) 0%, #1e293b 50%, #0f172a 100%) !important; }
		#node-talon.charged { background-image: radial-gradient(circle at 100% 0%, rgba(34, 211, 238, 0.25) 0%, #1e293b 50%, #0f172a 100%) !important; }
		#node-bones.charged { background-image: radial-gradient(circle at 0% 0%, rgba(34, 211, 238, 0.25) 0%, #1e293b 50%, #0f172a 100%) !important; }
		.node-nw { top: 0%; left: 0%; } .node-ne { top: 0%; right: 0%; } 
		.node-sw { bottom: 0%; left: 0%; } .node-se { bottom: 0%; right: 0%; }

		.crew-node:hover { border-color: #94a3b8; transform: translateY(-1px); }
		.crew-node.charged { 
			border-color: #22d3ee; 
			box-shadow: 0 0 15px rgba(34, 211, 238, 0.4), inset 0 0 10px rgba(34, 211, 238, 0.1); 
			z-index: 30; 
		}
		.crew-node.charged:hover {
			border-color: #67e8f9 !important;
			box-shadow: 0 0 20px rgba(34, 211, 238, 0.6) !important;
			transform: translateY(-1px);
		}
		.crew-node.charged .crew-node-name { color: #fff; text-shadow: 0 0 5px #22d3ee; }
		.crew-node.charged .crew-node-skill { color: #22d3ee; }
		.crew-node.used { 
			background-color: #0f172a !important; 
			background-image: radial-gradient(circle, #0f172a 30%, #020617 100%) !important;
			border-color: #374151 !important; 
			color: #334155 !important; 
			opacity: 1 !important; 
			z-index: 5; 
			box-shadow: inset 0 0 5px rgba(0,0,0,0.8); 
			cursor: not-allowed; 
			transform: scale(0.98);
			pointer-events: none; 
		}
		.crew-node-name { font-size: 0.875rem; font-weight: 700; color: #94a3b8; transition: color 0.3s; }
		.crew-node-skill { font-size: 0.75rem; color: #64748b; line-height: 1; text-align: center; }
		
		/* --- DREAMSCAPE & TAROT UI --- */
		.dream-blur-active {
			/* Force GPU layer to prevent lag during blur */
			transform: translateZ(0);
			will-change: filter; 
			filter: blur(8px) brightness(0.4) grayscale(0.5);
			pointer-events: none;
			transition: filter 0.5s ease-out; /* Faster timing for responsiveness */
		}
		
		.dream-banner-bottom {
			object-position: bottom; 
		}

		#dreamscape-overlay {
			position: fixed; inset: 0; z-index: 100;
			display: flex; align-items: center; justify-content: center;
			opacity: 0; pointer-events: none; 
			/* GPU Optimize Opacity */
			will-change: opacity;
			transition: opacity 0.4s ease-out;
			background: radial-gradient(circle at center, rgba(15, 23, 42, 0.95) 0%, rgba(2, 6, 23, 0.98) 100%);
			padding: 1rem;
		}

		#dreamscape-overlay.active { opacity: 1; pointer-events: auto; }

		.dream-modal-content {
			width: 100%; max-width: 950px; max-height: 95vh; overflow-y: auto;
			background-color: #020617; border: 2px solid #22d3ee; 
			box-shadow: inset 0 0 60px rgba(34, 211, 238, 0.05), 0 0 50px rgba(34, 211, 238, 0.2); 
			border-radius: 4px; display: flex; flex-direction: column;
			/* GPU Optimize Scale */
			will-change: transform;
			transform: scale(0.95); 
			transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Slight bounce effect */
		}

		#dreamscape-overlay.active .dream-modal-content { transform: scale(1); }

		/* --- TAROT CARDS (Optimized Hover) --- */
		.crew-card {
			background: 
				radial-gradient(circle at 50% 30%, rgba(30, 58, 138, 0.4) 0%, transparent 60%),
				linear-gradient(180deg, #0f172a 0%, #020617 100%);
			border: 1px solid #1e40af; border-radius: 8px; padding: 2px;
			display: flex; flex-direction: column; align-items: center; text-align: center;
			cursor: pointer; position: relative; overflow: hidden;
			min-height: 280px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
			/* GPU Optimize Hover */
			transform: translateZ(0);
			will-change: transform, box-shadow;
			transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s;
		}

		/* Re-apply the Grid Effect (Visuals untouched) */
		.crew-card::before, .crew-card::after {
			content: ''; position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.3;
			background-image: 
				linear-gradient(45deg, transparent 48%, #22d3ee 48%, #22d3ee 52%, transparent 52%),
				linear-gradient(-45deg, transparent 48%, #22d3ee 48%, #22d3ee 52%, transparent 52%);
			background-size: 10px 10px;
			mask-image: radial-gradient(circle, transparent 60%, black 100%);
			-webkit-mask-image: radial-gradient(circle, transparent 60%, black 100%);
		}

		.crew-card-inner {
			width: 100%; height: 100%; border: 1px solid rgba(34, 211, 238, 0.3);
			border-radius: 6px; padding: 1rem; display: flex; flex-direction: column;
			align-items: center; background: transparent; z-index: 2; position: relative;
		}

		.crew-card:hover { 
			transform: translateY(-5px) scale(1.02); 
			border-color: #22d3ee; 
			box-shadow: 0 0 30px rgba(34, 211, 238, 0.2); 
		}
		.crew-card:hover .crew-card-inner { border-color: #67e8f9; background: linear-gradient(180deg, rgba(30, 58, 138, 0.2) 0%, transparent 100%); }

		.crew-card.selected { border-color: #22d3ee !important; box-shadow: 0 0 40px rgba(34, 211, 238, 0.5) !important; background: linear-gradient(180deg, #1e3a8a 0%, #020617 100%) !important; }
		.crew-card i { font-size: 3rem; margin: 0.75rem 0; color: #e0e7ff; text-shadow: 0 0 15px #22d3ee; transition: all 0.3s; }
		.crew-card:hover i { transform: scale(1.1); text-shadow: 0 0 25px #22d3ee, 0 0 5px white; }

		.crew-boon-container { margin-top: auto; width: 100%; background: rgba(15, 23, 42, 0.8); border: 1px solid #1e40af; padding: 0.5rem; border-radius: 4px; }

		/* NARRATIVE TEXT STYLING */
		.dream-narrative {
			font-family: 'Crimson Text', serif; font-size: 1.1rem; color: #cbd5e1;
			line-height: 1.6; margin-bottom: 1.5rem; text-align: center;
			max-width: 90%; margin-left: auto; margin-right: auto;
			text-shadow: 0 2px 4px rgba(0,0,0,0.8); border-top: 1px solid rgba(34,211,238,0.1); border-bottom: 1px solid rgba(34,211,238,0.1);
			padding: 1rem 0;
		}
		.status-text-item { display: flex; align-items: center; font-family: 'Cinzel', serif; font-weight: bold; font-size: 0.9rem; white-space: nowrap; }
		.status-text-item.levelup { color: #cffafe; text-shadow: 0 0 10px rgba(34, 211, 238, 0.5); animation: pulse-cyan 2s infinite; }

		/* BACKPACK MODAL */
		#inventory-combined-container { position: relative; z-index: 50; }

		#backpack-modal { 
			position: absolute; 
			bottom: 0; 
			left: 105%; /* Pushes it to the right side of the button */
			width: 250px; 
			background-color: rgba(15, 23, 42, 0.98); 
			border: 1px solid #475569; 
			backdrop-filter: blur(8px); 
			z-index: 100; 
			box-shadow: 0 5px 20px rgba(0,0,0,0.8); 
			border-radius: 0.5rem;
		}

		/* Mobile Adjustments: Pop UP instead of RIGHT */
		@media (max-width: 768px) {
			#backpack-modal {
				left: 0;
				bottom: 110%; /* Above button */
				width: 100%;
			}
		}

		/* --- BUTTON BASE --- */
		.btn-game { 
			transition: all 0.2s ease-out; position: relative; overflow: hidden; 
			padding: 12px; width: 100%; display: flex; align-items: center; justify-content: space-between; 
			border-radius: 4px; text-transform: uppercase; letter-spacing: 0.05em; 
			font-size: 1rem; font-weight: 700; cursor: pointer; user-select: none; z-index: 1;
		}
		.btn-game span, .btn-game i, .btn-game div { position: relative; z-index: 5; }
		.btn-game:active { transform: translateY(1px); }
		.btn-game:hover { transform: translateY(-1px); } 
		.btn-disabled-cost { opacity: 0.4; cursor: not-allowed; background-color: #1f2937 !important; border-color: #475569 !important; box-shadow: none !important; transform: none !important; }

		/* --- BUTTON VARIANTS --- */
		/* Standard Button */
		.btn-standard, .btn-game.bg-gray-800 { background: linear-gradient(180deg, #1f2937 0%, #111827 100%) !important; border: 1px solid #475569 !important; color: #cdd5e0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
		.btn-standard:hover, .btn-game.bg-gray-800:hover { border-color: #fbbf24 !important; background: linear-gradient(180deg, #334155 0%, #1f2937 100%) !important; }

		/* Hero (Blue/Surge) */
		@keyframes hero-pulse { 0%, 100% { box-shadow: 0 0 4px rgba(59, 130, 246, 0.2); border-color: #60a5fa; } 50% { box-shadow: 0 0 12px rgba(59, 130, 246, 0.5); border-color: #93c5fd; } }
		.btn-hero { background: linear-gradient(90deg, rgba(30, 58, 138, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); border: 1px solid #60a5fa; color: #dbeafe; animation: hero-pulse 3s infinite ease-in-out; }
		.btn-hero:hover { background: linear-gradient(90deg, rgba(30, 58, 138, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%); box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); border-color: #93c5fd !important; }
		.hero-icon { color: #60a5fa; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.8)); }

		/* Fire (Red/Burn) */
		.btn-fire-glow { background: linear-gradient(90deg, rgba(127, 29, 29, 0.3) 0%, rgba(69, 10, 10, 0.5) 100%); border: 1px solid #f87171; color: #fecaca; box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); }
		.btn-fire-glow:hover { border-color: #fca5a5 !important; box-shadow: 0 0 15px rgba(248, 113, 113, 0.6) !important; }

		/* Shadow (Purple/Mist) */
		.btn-shadow-glow { background: linear-gradient(90deg, rgba(88, 28, 135, 0.3) 0%, rgba(59, 7, 100, 0.5) 100%); border: 1px solid #a78bfa; color: #e9d5ff; box-shadow: 0 0 5px rgba(139, 92, 246, 0.2); }
		.btn-shadow-glow:hover { border-color: #d8b4fe !important; box-shadow: 0 0 15px rgba(167, 139, 250, 0.6) !important; }

		/* Success/Safe */
		.btn-success-glow { background: linear-gradient(180deg, #374151 0%, #1f2937 100%); border: 1px solid #9ca3af; color: #f3f4f6; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
		.btn-success-glow:hover { background: linear-gradient(180deg, #4b5563 0%, #374151 100%) !important; border-color: #d1d5db !important; color: white !important; }

		/* Keen Senses (Indigo) */
		@keyframes keen-pulse { 0%, 100% { border-color: #d97706; box-shadow: 0 0 2px rgba(217, 119, 6, 0.2); } 50% { border-color: #fbbf24; box-shadow: 0 0 8px rgba(251, 191, 36, 0.4); } }
		.btn-keen-senses { background: linear-gradient(90deg, rgba(49, 46, 129, 0.4) 0%, rgba(30, 27, 75, 0.6) 100%); border: 1px solid #d97706; color: #e0e7ff; animation: keen-pulse 3s infinite ease-in-out; }
		.btn-keen-senses:hover { border-color: #fcd34d !important; box-shadow: 0 0 12px rgba(251, 191, 36, 0.5) !important; }

		/* Lantern (Yellow) */
		@keyframes lantern-pulse { 0%, 100% { border-color: #f59e0b; box-shadow: inset 0 0 5px rgba(139, 92, 246, 0.1); } 50% { border-color: #fcd34d; box-shadow: inset 0 0 15px rgba(139, 92, 246, 0.3); } }
		.btn-lantern-glow { background: linear-gradient(90deg, rgba(88, 28, 135, 0.4) 0%, rgba(66, 32, 6, 0.4) 100%); border: 1px solid #f59e0b; color: #fef3c7; animation: lantern-pulse 3s infinite ease-in-out; }
		.btn-lantern-glow:hover { border-color: #fde047 !important; box-shadow: 0 0 12px rgba(253, 224, 71, 0.4) !important; }

		/* Anchor (Cyan) */
		.btn-anchor { background: linear-gradient(180deg, #1f2937 0%, #111827 100%); border: 1px solid #475569; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); color: #22d3ee !important; }
		.btn-anchor:hover { border-color: #fbbf24 !important; background: linear-gradient(180deg, #334155 0%, #1f2937 100%) !important; }

		/* Planewalk (Glitch) */
		@keyframes spectral-pulse { 0%, 100% { box-shadow: 0 0 4px rgba(59, 130, 246, 0.3); border-color: #3b82f6; } 50% { box-shadow: 0 0 12px rgba(59, 130, 246, 0.6); border-color: #60a5fa; } }
		.btn-planewalk-reveal { background-color: rgba(30, 58, 138, 0.3); border: 1px solid #60a5fa; color: #cffafe; animation: spectral-pulse 2s infinite ease-in-out; }
		.btn-planewalk-reveal:hover { background-color: rgba(30, 58, 138, 0.5) !important; border-color: #22d3ee !important; box-shadow: 0 0 15px rgba(34, 211, 238, 0.5) !important; }
		.spectral-active { animation: spectral-pulse 2s infinite ease-in-out !important; background-color: rgba(30, 58, 138, 0.3); border-color: #60a5fa !important; }

		/* Pulse (Search) */
		@keyframes pulse-amber { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.3); border-color: #f59e0b; } 70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); border-color: #fbbf24; } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; } }
		.btn-pulse { background: linear-gradient(90deg, rgba(120, 53, 15, 0.3) 0%, rgba(69, 26, 3, 0.5) 100%); border: 1px solid #f59e0b; color: #fef3c7; animation: pulse-amber 2s infinite; }
		.btn-pulse:hover { border-color: #fbbf24 !important; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4) !important; }

		/* Hold Button */
		.btn-channel { background: linear-gradient(90deg, #1e1b4b 0%, #312e81 100%); border: 1px solid #818cf8; color: #e0e7ff; overflow: hidden; user-select: none; touch-action: none; }
		.btn-channel::before { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(139, 92, 246, 0.6); z-index: 0; transition: width 0s; }
		.btn-channel.channeling::before { width: 100%; transition: width var(--channel-duration, 3000ms) linear; }
		.btn-content-wrapper { position: relative; z-index: 10; display: flex; width: 100%; align-items: center; }

		/* --- FX ANIMATIONS --- */
		/* 1. Fire Wipe */
		@keyframes burn-mask { 0% { clip-path: inset(0 0 0 0); opacity: 1; filter: brightness(1); } 30% { background-color: #ef4444; color: #000; border-color: #fca5a5; filter: brightness(2) contrast(1.5); } 50% { clip-path: inset(0 0 0 0); opacity: 0.8; transform: scale(1.02); } 100% { clip-path: inset(0 0 0 100%); opacity: 0; transform: scale(0.95); background-color: #000; } }
		@keyframes burn-line { 0% { transform: translateX(-100%); opacity: 0; } 40% { opacity: 1; } 100% { transform: translateX(100%); opacity: 0; } }
		.fx-burn-active { pointer-events: none; animation: burn-mask 1.8s cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important; }
		.fx-burn-active::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, #fbbf24 90%, transparent 100%); width: 100%; height: 100%; z-index: 10; opacity: 0; animation: burn-line 1.8s linear forwards !important; }

		/* 2. Mist/Shadow */
		@keyframes mist-dissolve-smoke { 0% { transform: scale(1); filter: blur(0px); opacity: 1; letter-spacing: 0.05em; -webkit-mask-position: 100% 0; mask-position: 100% 0; } 45% { transform: scale(1.05); filter: blur(2px); opacity: 0.9; -webkit-mask-position: 90% 0; mask-position: 90% 0; } 100% { transform: scale(1.3) translateX(20px); filter: blur(15px); opacity: 0; letter-spacing: 0.5em; -webkit-mask-position: 0% 0; mask-position: 0% 0; } }
		.fx-mist-active { pointer-events: none; -webkit-mask: linear-gradient(to right, transparent 40%, black 80%); mask: linear-gradient(to right, transparent 40%, black 80%); -webkit-mask-size: 250% 100%; mask-size: 250% 100%; animation: mist-dissolve-smoke 1.8s ease-in forwards !important; color: #d8b4fe !important; border-color: rgba(167, 139, 250, 0.3) !important; }

		/* 3. Skill Check Shake */
		@keyframes dice-rattle { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(-2px, 1px) rotate(-1deg); } 50% { transform: translate(2px, -1px) rotate(1deg); } 75% { transform: translate(-1px, -2px) rotate(0deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
		.fx-skill-active { pointer-events: none; animation: dice-rattle 0.1s linear infinite; }

		/* Icon Spin for Skill Checks */
		@keyframes icon-spin { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.4); color: #fbbf24; } 100% { transform: rotate(360deg) scale(1); color: #cdd5e0; } }

		/* Success Pulse (Green) */
		@keyframes success-pulse { 0% { border-color: #10b981; background-color: #064e3b; transform: scale(1); } 30% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); border-color: #34d399; transform: scale(1.02); } 100% { border-color: #475569; background-color: #1f2937; transform: scale(1); } }
		.fx-skill-success { pointer-events: none; animation: success-pulse 0.6s ease-out forwards; }
		.fx-skill-success i { color: #34d399 !important; transition: color 0.2s; }

		/* Failure Shake (Red) - NOW WITH GLOW */
		@keyframes fail-shake { 0% { border-color: #ef4444; background-color: #450a0a; transform: translateX(0); box-shadow: 0 0 0 rgba(239, 68, 68, 0); } 20% { transform: translateX(-4px); box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); } 40% { transform: translateX(4px); box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); } 60% { transform: translateX(-2px); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); } 80% { transform: translateX(2px); } 100% { border-color: #475569; background-color: #1f2937; transform: translateX(0); box-shadow: 0 0 0 rgba(239, 68, 68, 0); } 
		}
		.fx-skill-fail { pointer-events: none; animation: fail-shake 0.5s ease-out forwards; }
		.fx-skill-fail i { color: #f87171 !important; transition: color 0.2s; }

		.fx-skill-active i { animation: icon-spin 0.8s ease-out forwards; }

		/* 4. Hero Surge */
		@keyframes hero-shockwave { 0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.7), inset 0 0 0 0 rgba(255, 255, 255, 0.5); border-color: #60a5fa; transform: scale(1); } 15% { box-shadow: 0 0 50px 20px rgba(96, 165, 250, 0.5), inset 0 0 60px 20px rgba(255, 255, 255, 0.8); border-color: #fff; background-color: #1e3a8a; transform: scale(1.1); color: #fff; text-shadow: 0 0 10px #fff; } 100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); transform: scale(1); opacity: 0; } }
		.fx-hero-active { pointer-events: none; animation: hero-shockwave 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; color: #fff !important; z-index: 20; }

		/* 5. Planar Glitch - CLEAN REVISION (Updated from Lab) */
        @keyframes glitch-step {
            0% { transform: translate(0); opacity: 1; border-color: #60a5fa; }
            
            /* 1. Digital Jitter */
            10% { transform: translate(-2px, 0); clip-path: inset(0 0 0 0); }
            20% { transform: translate(2px, 0); border-color: #fff; }
            
            /* 2. THE BLACK IMPACT (0.1s HOLD) */
            30% { 
                background-color: #000 !important; 
                border-color: #000 !important; 
                color: #333 !important; 
                transform: scale(0.98);
                box-shadow: none !important;
            }
            35% {
                background-color: #000 !important;
                transform: scale(0.98);
            }

            /* 3. THE RIFT (Violet Step) */
            36% {
                background-color: #2e1065 !important; /* Deep Violet */
                border-color: #d8b4fe !important;      /* Pale Violet */
                color: #fff !important;
                transform: translate(4px, 0);          /* Sidestep */
                box-shadow: 0 0 10px #a855f7 !important;
            }
            
            /* 4. Glitch Out */
            60% { transform: translate(-4px, 0); opacity: 1; }
            80% { transform: translate(0, 0); opacity: 0.8; filter: hue-rotate(20deg); }
            
            /* 5. Gone */
            100% { 
                opacity: 0; 
                transform: scale(0.95);
                filter: blur(2px);
            }
        }
        .fx-glitch-active { 
            pointer-events: none; 
            animation: glitch-step 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards !important; 
            z-index: 50; 
        }

        /* 6. SAIL HOIST (New from Lab) */
        @keyframes sail-hoist {
            0% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(0.95); filter: brightness(0.8); border-color: #fff; } 
            40% { transform: scale(1.02) skewX(-2deg); filter: brightness(1.2); } 
            100% { transform: translateX(120%) translateY(-10px) skewX(-5deg); opacity: 0; filter: blur(2px); } 
        }
        .fx-sail-active {
            animation: sail-hoist 1.5s ease-in forwards;
            pointer-events: none;
            z-index: 50;
        }

		/* --- GAME UTILS --- */
		.prologue-blur { filter: blur(4px); opacity: 0.5; pointer-events: none; transition: all 1s; }
		.prologue-active { opacity: 1; filter: none; }
		.log-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
		.log-visible { opacity: 1; pointer-events: auto; transform: translateY(0); transition: all 1s ease-out; }
		.crew-free-use-glow { animation: pulse-purple 2s infinite; background-color: rgba(88, 28, 135, 0.5); border-color: #a855f7 !important; color: #f3e8ff !important; }
		@keyframes pulse-purple { 0%, 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.5); border-color: #a855f7; } 50% { box-shadow: 0 0 18px rgba(192, 132, 252, 0.8); border-color: #c084fc; } }
		.tutorial-pulse { animation: pulse-amber-border 2s infinite; border: 2px solid #f59e0b !important; background-color: rgba(180, 83, 9, 0.4); z-index: 10; }
		@keyframes pulse-amber-border { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); border-color: #f59e0b; } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); border-color: #fbbf24; } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; } }
		@keyframes item-pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 10px 0 rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.8); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); } }
		.item-consumable { animation: item-pulse 3s infinite; }
		#inf-marker { transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
		.text-fire { color: #fb923c; text-shadow: 0 0 8px rgba(249, 115, 22, 0.6); font-weight: 700; }
		.text-void { color: #c084fc; text-shadow: 0 0 8px rgba(147, 51, 234, 0.5); font-weight: 700; }
		.text-spectral { color: #67e8f9; text-shadow: 0 0 8px rgba(34, 211, 238, 0.6); font-weight: 700; }
		.text-item { color: #fcd34d; text-shadow: 0 0 5px rgba(245, 158, 11, 0.4); font-weight: 700; }
		.text-danger { color: #f87171; text-shadow: 0 0 5px rgba(220, 38, 38, 0.6); font-weight: 700; }
		.text-blood { color: #ef4444; text-shadow: 0 0 8px rgba(220, 38, 38, 0.8); font-weight: 700; font-family: 'Cinzel', serif; }
		.text-spectral-d8 { color: #67e8f9; text-shadow: 0 0 10px #67e8f9; }
		.memory-keyword { color: #93c5fd; text-shadow: 0 0 8px rgba(59, 130, 246, 0.5); cursor: help; position: relative; font-weight: 600; border-bottom: 1px solid transparent; transition: all 0.3s ease; }
		.memory-keyword:hover { text-shadow: 0 0 12px rgba(59, 130, 246, 0.9), 0 0 2px #fff; color: #bfdbfe; }
		.memory-keyword:hover::after { content: attr(data-lore); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background: #0f172a; border: 1px solid #3b82f6; color: #e2e8f0; padding: 10px; border-radius: 4px; width: 240px; font-size: 0.85rem; line-height: 1.4; z-index: 100; pointer-events: none; font-family: 'Crimson Text', serif; box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); text-align: center; white-space: normal; animation: fadeInTooltip 0.2s forwards; }
		.memory-keyword:hover::before { content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(0px); border-width: 6px; border-style: solid; border-color: #3b82f6 transparent transparent transparent; z-index: 100; animation: fadeInTooltip 0.2s forwards; }
		@keyframes fadeInTooltip { to { opacity: 1; } }
		#fx-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 20; transition: box-shadow 0.5s ease; }
		@keyframes rift-pulse-anim { 0%, 100% { box-shadow: inset 0 0 20px 0px rgba(139, 92, 246, 0.1); background-color: rgba(139, 92, 246, 0.05); } 50% { box-shadow: inset 0 0 80px 20px rgba(139, 92, 246, 0.4); background-color: rgba(139, 92, 246, 0.15); } }
		.fx-rift-pulse { animation: rift-pulse-anim 4s infinite ease-in-out; mix-blend-mode: overlay; }
		@keyframes rift-collapse-anim { 0% { box-shadow: inset 0 0 30px 10px rgba(109, 40, 217, 0.4); background-color: rgba(88, 28, 135, 0.05); } 50% { box-shadow: inset 0 0 90px 30px rgba(139, 92, 246, 0.5); background-color: rgba(124, 58, 237, 0.10); } 100% { box-shadow: inset 0 0 30px 10px rgba(109, 40, 217, 0.4); background-color: rgba(88, 28, 135, 0.05); } }
		.fx-rift-collapsed { animation: rift-collapse-anim 4s infinite ease-in-out !important; mix-blend-mode: normal !important; z-index: 25; border: 1px solid rgba(139, 92, 246, 0.4); }
		@keyframes flash-red-anim { 0% { background-color: rgba(220, 38, 38, 0.6); } 100% { background-color: transparent; } }
		.fx-flash-red { animation: flash-red-anim 0.4s ease-out forwards; }
		#vignette-overlay { box-shadow: inset 0 0 80px 30px rgba(127, 29, 29, 0.5); }
		.vignette-active { opacity: 1 !important; }
		@keyframes heartbeat-anim { 0% { box-shadow: inset 0 0 20px 5px rgba(234, 88, 12, 0.1); } 50% { box-shadow: inset 0 0 60px 20px rgba(245, 158, 11, 0.3); } 100% { box-shadow: inset 0 0 20px 5px rgba(234, 88, 12, 0.1); } }
		.fx-heartbeat-slow { animation: heartbeat-anim 3s infinite ease-in-out; opacity: 1 !important; }
		.fx-heartbeat-fast { animation: heartbeat-anim 0.8s infinite ease-in-out; opacity: 1 !important; }
		.water-stained { background-color: #1e293b; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23334155' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"); }

		/* --- FIX #4: ETHEREAL PLANE & PUZZLES --- */
		body.plane-ethereal { background-color: #020617; transition: background-color 1s ease; }
		body.plane-ethereal .text-amber-500, body.plane-ethereal .text-amber-600 { color: #22d3ee !important; text-shadow: 0 0 10px rgba(34, 211, 238, 0.6); }
		body.plane-ethereal .text-gray-300, body.plane-ethereal .text-gray-400 { color: #e2e8f0 !important; }
		body.plane-ethereal h1, body.plane-ethereal h2, body.plane-ethereal h3 { color: #67e8f9 !important; text-shadow: 0 0 15px rgba(103, 232, 249, 0.4); }
		body.plane-ethereal #stats-panel, body.plane-ethereal #main-scene-text, body.plane-ethereal #journal-container { background-color: rgba(15, 23, 42, 0.8) !important; backdrop-filter: blur(5px); box-shadow: 0 0 30px rgba(34, 211, 238, 0.05); }
		body.plane-ethereal .bg-gray-800:not(#stats-panel):not(#journal-container) { background-color: rgba(15, 23, 42, 0.6) !important; box-shadow: none !important; }
		body.plane-ethereal .border-gray-700 { border-color: #1e3a8a !important; box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); }
		
		/* Ethereal Button Override - targeting btn-standard specifically to fix Act 2 styling */
		body.plane-ethereal .btn-game:not(.btn-hero):not(.btn-fire-glow):not(.btn-shadow-glow):not(.btn-success-glow):not(.btn-keen-senses):not(.btn-lantern-glow):not(.btn-planewalk-reveal),
		body.plane-ethereal .btn-standard { 
			background: linear-gradient(90deg, rgba(30, 27, 75, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%) !important; 
			border-color: #4f46e5 !important; 
			color: #e0e7ff !important; 
			box-shadow: 0 0 10px rgba(79, 70, 229, 0.2); 
		}
		body.plane-ethereal .btn-game:not(.btn-hero):hover { border-color: #22d3ee !important; box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); transform: translateX(5px); }
		
		body.plane-ethereal .water-stained { background-image: none !important; background: linear-gradient(180deg, #0f172a 0%, #172554 100%) !important; }
		body.plane-ethereal #journal-container { border-color: #60a5fa !important; }
		body.plane-ethereal .journal-font { color: #bae6fd !important; font-family: 'Dancing Script', cursive !important; }
		body.plane-ethereal #scene-image { filter: brightness(1.1) contrast(1.05); mix-blend-mode: normal; }
		body.plane-ethereal .clean-spectral-title { box-shadow: none !important; background: transparent !important; border-color: #1e3a8a !important; }
		.bg-tether { background: linear-gradient(90deg, #06b6d4 0%, #cffafe 100%); box-shadow: 0 0 10px rgba(34, 211, 238, 0.6); }
		.map-active #scene-image { filter: brightness(1.1) !important; border: 2px solid #22d3ee; }

		/* Puzzle Styles */
		.slow-type::after { content: '|'; animation: blink 0.7s infinite; font-weight: 700; color: #93c5fd; }
		@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
		.circuit-panel { background-color: #111827; border: 1px solid #374151; padding: 20px; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); display: flex; gap: 15px; justify-content: center; margin-top: 1rem; margin-bottom: 1rem; }
		.circuit-node { width: 45px; height: 45px; border-radius: 8px; background-color: #0f172a; border: 2px solid #475569; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; font-weight: bold; color: #94a3b8; cursor: pointer; transition: all 0.2s; }
		.circuit-node.active { border-color: #f59e0b; background-color: #451a03; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); color: #fef3c7; transform: scale(1.1); }
		.circuit-node.success { border-color: #10b981; background-color: #064e3b; color: #34d399; cursor: default; }
		.circuit-node.error { border-color: #ef4444; background-color: #450a0a; color: #fca5a5; animation: shake 0.3s; }
		@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
		@keyframes planar-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(167, 139, 250, 0.2), inset 0 0 8px rgba(103, 232, 249, 0.2); } 50% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.5), inset 0 0 15px rgba(103, 232, 249, 0.5); } }
		#compass-container { width: 220px; height: 220px; position: relative; border-radius: 50%; background: radial-gradient(#1e1b4b, #020617); border: 2px solid #60a5fa; animation: planar-pulse 4s infinite ease-in-out; margin: 20px auto; touch-action: none; }
		#compass-needle { position: absolute; width: 4px; height: 100px; top: 50%; left: 50%; margin-left: -2px; margin-top: -100px; transform-origin: center bottom; cursor: grab; z-index: 10; }
		#compass-needle:active { cursor: grabbing; }
		#needle-head { position: absolute; top: 0; left: -6px; width: 16px; height: 16px; transform: rotate(45deg); background-color: #67e8f9; box-shadow: 0 0 8px #67e8f9; }
		#needle-body { width: 100%; height: 100%; background: linear-gradient(to top, #4c1d95 20%, #67e8f9 100%); }
		#compass-target { position: absolute; width: 80px; height: 80px; border-radius: 50%; background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981; top: 68px; left: 68px; transform-origin: center center; pointer-events: none; }
		#compass-needle.aligned #needle-head { background-color: #34d399; box-shadow: 0 0 15px #10b981; }
		#compass-needle:not(.aligned) { transition: transform 0.05s linear; }
		/* --- SKILL CHECK BUTTON (Active) --- */
		.btn-game.border-cyan-500:not(.fx-skill-success):not(.fx-skill-fail):not(.fx-skill-active) {
			border: 1px solid #22d3ee !important; 
			box-shadow: 0 0 10px rgba(34, 211, 238, 0.3), inset 0 0 10px rgba(34, 211, 238, 0.1) !important;
			background: linear-gradient(90deg, rgba(34, 211, 238, 0.2) 0%, #1e293b 50%, #0f172a 100%) !important; 
			transition: all 0.2s ease-out; 
			z-index: 20;
		}

		/* --- 2. THE CREW HOVER (Lift & Lighten) --- */
		.btn-game.border-cyan-500:not(.fx-skill-success):not(.fx-skill-fail):not(.fx-skill-active):hover {
			border-color: #67e8f9 !important;
			background: linear-gradient(90deg, rgba(22, 78, 99, 0.95) 0%, #374151 100%) !important;
			box-shadow: 0 0 15px rgba(34, 211, 238, 0.5) !important;
			transform: translateY(-2px);
		}

		/* --- 3. THE ANIMATION FIX (Critical) --- */
		/* When shaking, we must DISABLE transitions so the button moves instantly */
		.btn-game.border-cyan-500.fx-skill-active {
			transition: none !important; /* Stop trying to smooth the shake */
			border-color: #fbbf24 !important; /* Revert to Amber "Rolling" color */
			/* Do NOT set transform: none here, or it will freeze! */
		}
    </style>
</head>
<body class="min-h-screen md:h-screen md:overflow-hidden overflow-y-auto bg-[#050a10] text-[#cdd5e0] select-none flex flex-col">

    <div id="app-loading" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black text-white">
        <div class="text-4xl cinzel text-blue-500 mb-4 animate-pulse text-center px-4">Edward Jones:<br>The Mariner of the Damned</div>
        <div class="text-gray-400 cinzel text-sm">Summoning the Crew...</div>
    </div>

    <div class="fixed top-4 right-4 z-50">
        <button id="audio-toggle" class="bg-gray-800/80 border border-gray-600 text-gray-400 p-2 rounded-full hover:text-amber-500 transition-colors w-10 h-10 flex items-center justify-center shadow-lg backdrop-blur">
            <i class="fas fa-volume-mute"></i>
        </button>
    </div>

    <div id="main-game-container" class="grid grid-cols-1 md:flex md:flex-row max-w-7xl mx-auto w-full p-2 pb-32 md:p-4 gap-4 md:h-full h-auto">
        
        <div class="contents md:flex md:flex-col md:w-1/3 gap-3 shrink-0 relative z-50">
            
            <div class="order-1 md:order-none relative w-full aspect-video md:aspect-[4/3] bg-gray-900 rounded border border-gray-700 overflow-hidden shadow-2xl shrink-0 group">
                <button id="reset-game-btn" onclick="confirmReset()" class="absolute top-2 left-2 z-30 text-[10px] border border-red-900/50 text-red-400 bg-black/60 hover:text-red-200 hover:bg-red-900/80 px-2 py-1 rounded transition-all cinzel font-bold backdrop-blur-sm">
                    <i class="fas fa-skull mr-1"></i>New Game
                </button>

                <div id="fx-overlay"></div>
				<div id="vignette-overlay" class="absolute inset-0 pointer-events-none z-20 transition-opacity duration-500 opacity-0"></div>

                <div id="image-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-gray-500 z-10" style="display: none;">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-amber-600"></i>
                        <span class="text-xs cinzel tracking-widest text-amber-600">Manifesting Vision...</span>
                    </div>
                </div>
                <img id="scene-image" src="" alt="Scene Visualization" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000">
                
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4">
                    <h2 id="scene-title" class="text-xl cinzel text-amber-500 text-shadow"></h2>
                </div>
            </div>

            <div id="stats-panel" class="order-4 md:order-none bg-gray-800/80 rounded border border-gray-700 p-3 flex flex-col gap-3 shadow-lg backdrop-blur-sm relative transition-all duration-1000">
                <div>
					<div class="flex justify-between text-sm cinzel text-gray-400 mb-1">
						<span>Edward Jones</span>
						<span id="hp-text">20/20</span>
					</div>
					<div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-gray-700">
						<div id="hp-bar" class="bg-red-800 h-full w-full transition-all duration-500"></div>
					</div>
				</div>

				<div id="doom-counter-display" class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative hidden mt-2">
					<div class="flex justify-between items-center cinzel text-xs uppercase tracking-wider font-bold">
						<span class="text-purple-400"><i class="fas fa-bolt mr-1"></i>Rift Stability</span>
						<span id="doom-timer-text"></span>
					</div>
					<div class="relative w-full h-1 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
						<div id="doom-bar" class="absolute inset-0 bg-purple-600 transition-all duration-500"></div>
					</div>
				</div>

				<div id="tether-display" class="bg-gray-900 p-2 rounded border border-cyan-700 flex flex-col text-[10px] gap-2 relative hidden mt-2 transition-all duration-500">
					<div class="flex justify-between items-center cinzel text-xs uppercase tracking-wider font-bold">
						<span class="text-cyan-400"><i class="fas fa-link mr-1"></i>Spectral Tether</span>
						<span id="tether-text" class="text-cyan-100">20 Turns</span>
					</div>
					<div class="relative w-full h-1 bg-gray-800 rounded-full border border-cyan-900 overflow-hidden">
						<div id="tether-bar" class="absolute inset-0 bg-tether transition-all duration-500 w-full"></div>
					</div>
				</div>

				<div class="bg-gray-900 p-2 pb-3 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative mt-2">
					<div class="flex justify-between items-center cinzel text-[10px] uppercase tracking-wider font-bold">
						<span class="text-blue-400"><i class="fas fa-shield-alt mr-1"></i>Order</span>
						<span id="inf-status-text" class="text-gray-500 text-[9px] truncate max-w-[140px] text-center">Unknown</span>
						<span class="text-emerald-400">Chaos<i class="fas fa-skull-crossbones ml-1"></i></span>
					</div>
					<div class="relative w-full h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
						<div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-gray-800 to-emerald-900 opacity-60"></div>
						<div id="inf-marker" class="absolute top-0 bottom-0 w-1.5 bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] z-10 rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
					</div>
				</div>

				<div class="radial-container mt-2">
					<div id="tether-gareth" class="spectral-tether tether-nw"></div>
					<div id="tether-quinn" class="spectral-tether tether-ne"></div>
					<div id="tether-talon" class="spectral-tether tether-sw"></div>
					<div id="tether-bones" class="spectral-tether tether-se"></div>
					<div id="radial-hub" class="radial-hub">
						<div class="cinzel font-bold text-cyan-200 text-xs leading-tight text-center mt-2">GUIDING<br>VOICE</div>
						<div class="text-cyan-400 text-xs mt-0.5 font-bold animate-pulse tracking-widest">+1d4</div>
					</div>
				</div>

				<div id="abilities-combined-container" class="grid grid-cols-2 gap-2 mt-2">
					<div id="planar-skills-container" class="hidden h-full flex flex-col">
						<div class="text-xs cinzel font-bold uppercase tracking-wider text-cyan-400 border-b border-cyan-900/50 mb-1 pb-1">Skills</div>
						<button onclick="window.gameFunctions.togglePlaneWalk()" class="flex-1 p-2 rounded border border-cyan-800 bg-gray-900/60 text-cyan-100 flex items-center justify-center gap-2 hover:bg-cyan-900/20 transition-all">
							<span class="text-[10px] cinzel font-bold uppercase">Plane Walk</span>
							<i class="fas fa-shoe-prints text-sm text-cyan-400"></i>
						</button>
					</div>
					<div id="companion-panel" class="hidden h-full flex flex-col">
						<div class="text-xs cinzel font-bold uppercase tracking-wider text-emerald-400 border-b border-emerald-900/50 mb-1 pb-1">Allies</div>
						<div id="companions-list" class="flex-1 flex flex-col gap-1 justify-center"></div>
					</div>
				</div>

				<div id="inventory-combined-container" class="mt-auto relative z-50"> 
					<div id="backpack-modal" class="hidden p-4 rounded-lg gap-2 flex flex-col transition-all duration-300">
						<div class="text-center cinzel text-amber-500 font-bold border-b border-gray-700 pb-2 mb-2">Captain's Pack</div>
						
						<div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
							<div class="flex items-center gap-2">
								<i class="fas fa-coins text-[20px] text-amber-500"></i>
								<div class="flex flex-col leading-none">
									<span class="text-[10px] text-gray-500 uppercase tracking-wider">Shillings</span>
									<span id="shillings-display" class="text-amber-100 font-mono">0</span>
								</div>
							</div>
							<div id="supplies-display" class="flex items-center gap-2 hidden">
								<div class="flex flex-col leading-none items-end">
									<span class="text-[10px] text-gray-500 uppercase tracking-wider">Supplies</span>
									<span id="supplies-count" class="text-indigo-100 font-mono">0</span>
								</div>
								<i class="fas fa-anchor text-[20px] text-indigo-400"></i>
							</div>
						</div>
						
						<div id="item-desc-area" class="text-xs text-gray-400 h-8 italic mb-2 text-center leading-tight flex items-center justify-center bg-gray-800/50 border border-gray-600/50 rounded px-1 shrink-0">
							Hover to inspect.
						</div>
						<div id="inventory-panel" class="flex flex-col gap-1 max-h-[250px] overflow-y-auto pr-1"></div>
					</div>
					
					<button id="btn-combined-pack" onclick="window.gameFunctions.toggleBackpack()" class="w-full p-2 rounded bg-gray-900 border border-amber-700/50 hover:border-amber-500 hover:bg-gray-800 text-amber-500 hover:text-amber-100 transition-all shadow-md relative z-50 mt-2">
						<div class="flex items-center gap-3 w-full">
							<span class="cinzel font-bold tracking-wider text-sm">Captain's Pack</span>
							<div id="pack-resources-display" class="ml-auto flex items-center gap-3 font-bold text-sm"></div>
						</div>
					</button>
				</div>
                
            </div>
        </div>

        <div class="contents md:flex md:flex-col md:w-2/3 gap-4">
             <div id="main-scene-text" class="order-2 md:order-none bg-[#111318] rounded border border-gray-700 p-6 shadow-inner relative min-h-[160px] h-auto shrink-0 transition-all flex flex-col justify-center">
                <div class="text-center text-gray-500 italic">Initializing Story...</div>
            </div>
            <div class="order-3 md:order-none shrink-0 flex flex-col gap-2">
                <div id="choices-area" class="grid grid-cols-1 gap-2">
                    </div>
            </div>
            <div class="order-5 md:order-none w-full flex flex-col shrink-0">
				<div id="journal-container" class="order-5 md:order-none log-hidden h-96 md:h-[476px] shrink-0 rounded border border-gray-600 bg-gray-800 shadow-2xl flex flex-col overflow-hidden relative mb-6">
				<div class="bg-[#0f172a] text-center py-1 border-b border-gray-700 z-10 shadow-md">
					<h3 class="cinzel text-amber-600 text-sm tracking-[0.2em] font-bold">The Log of The Trident's Kiss</h3>
				</div>
				<div id="journal-scroll-area" class="flex-1 min-h-0 water-stained p-6 overflow-y-auto">
					<div id="journal-content" class="space-y-6">
						 </div>
					<div class="h-4"></div>
				</div>
				<div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
			</div>
			</div>
        </div>
    </div><div class="w-full h-40 md:hidden shrink-0 pointer-events-none"></div>
	
	<div id="dreamscape-overlay">
    <div class="dream-modal-content">
        <div class="relative h-40 md:h-64 w-full bg-black overflow-hidden border-b-2 border-cyan-900 shrink-0">
    		<img src="images/dreamscape_banner.jpg" class="w-full h-full object-cover object-[center_80%] opacity-60">
				<div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent"></div>
				<div class="absolute top-0 left-0 right-0 h-full flex flex-col items-center justify-center p-4 text-center">
					<h2 class="text-3xl md:text-5xl cinzel text-cyan-400 text-shadow tracking-widest mt-4">Dreamscape Sanctuary</h2>
				</div>
			</div>
			<div class="p-4 md:p-6 bg-[#0f172a] flex-1">
				<div class="flex flex-wrap justify-center gap-6 mb-4 cinzel font-bold text-sm tracking-widest uppercase">
					<div class="flex items-center text-emerald-400 drop-shadow-md">
						<i class="fas fa-heart mr-2"></i> +5 Max HP
					</div>
					<div class="flex items-center text-red-400 drop-shadow-md">
						<i class="fas fa-fist-raised mr-2"></i> +1 Base Dmg
					</div>
					<div class="flex items-center text-purple-400 drop-shadow-md">
						<i class="fas fa-bed mr-2"></i> Long Rest
					</div>
				</div>

				<div id="dream-text-container" class="dream-narrative min-h-[80px] flex items-center justify-center"></div>

				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4" id="dream-card-grid">
					</div>

				<div class="mt-6 flex justify-center">
					<button id="btn-wake-up" onclick="window.gameFunctions.confirmDreamSelection()" class="hidden px-8 py-3 bg-transparent border-2 border-cyan-500 text-cyan-400 rounded hover:bg-cyan-900/30 hover:text-white hover:border-white transition-all cinzel font-bold text-sm shadow-[0_0_20px_rgba(34,211,238,0.3)] tracking-widest uppercase">
						Confirm Bond & Wake Up
					</button>
				</div>
			</div>
		</div>
	</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CRITICAL IMPORT: BRING IN THE SCENES ---
        import { scenes } from './scenes.js';

        // --- GLOBAL GLUE ---
        // Expose scenes object globally for non-module script access and debugging
        window.scenes = scenes;
        window.gameFunctions = {}; 
        window.itemRegistry = {}; // Defined later, but globally accessible
        window.applyDamage = null; // Defined later, but globally callable
        window.resolveCombatRound = null;
        window.resolveHordeRound = null;
        window.allyCommand = null;
        window.getBonusForSkill = null; // Defined later, used in renderChoices/skill checks


        // 2. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDlg5dETZJpbJ9GzMV01pUYA06XbFmySbw",
            authDomain: "edward-jones-75546.firebaseapp.com",
            projectId: "edward-jones-75546",
            storageBucket: "edward-jones-75546.firebasestorage.app",
            messagingSenderId: "76799051768",
            appId: "1:76799051768:web:fdd3641b597adfc6a0780d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "edward-jones-standalone";
        let user;
        const MAX_OVERHEAL_CAP = 25;

        // --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                this.ambience = new Audio('audio/ambience.mp3'); this.ambience.loop = true; this.ambience.volume = 0.3;
                this.clickSound = new Audio('audio/click.mp3'); this.clickSound.volume = 0.4;
                this.gaspSound = new Audio('audio/gasp.mp3'); this.gaspSound.volume = 0.3;
                this.clashSound = new Audio('audio/clash.mp3'); this.clashSound.volume = 0.5;
                this.coinsSound = new Audio('audio/coins.mp3'); this.coinsSound.volume = 0.4;
                this.vulnerableSound = new Audio('audio/vulnerable.mp3'); this.vulnerableSound.volume = 0.6; this.vulnerableSound.loop = true;
                this.ghostSound = new Audio('audio/ghost2.mp3'); this.ghostSound.volume = 0.5;
                this.diceSound = new Audio('audio/dice.mp3'); this.diceSound.volume = 0.7; 
                this.successSound = new Audio('audio/success.mp3'); this.successSound.volume = 0.6; 
                this.failSound = new Audio('audio/fail.mp3'); this.failSound.volume = 0.7; 

                this.isMuted = true;
                this.hasInteracted = false;
                this.playedVulnerable = false;

                const btn = document.getElementById('audio-toggle');
                btn.onclick = () => this.toggleMute();
            }

            playSFX(soundObj) {
                if (!this.isMuted) {
                    const sound = soundObj.cloneNode();
                    sound.volume = soundObj.volume;
                    sound.play().catch(e => console.log("Audio play blocked"));
                }
            }
            
            playDice() { this.playSFX(this.diceSound); }
            playSuccess() { this.playSFX(this.successSound); }
            playFail() { this.playSFX(this.failSound); }
            playClick() { this.playSFX(this.clickSound); }
            playGasp() { this.playSFX(this.gaspSound); }
            playClash() { this.playSFX(this.clashSound); }
            playCoins() { this.playSFX(this.coinsSound); }
            playGhost() { this.playSFX(this.ghostSound); }
            
            checkVulnerable(currentHP, maxHP) {
                const pct = (currentHP / maxHP) * 100;
                if (pct <= 30) {
                    if (!this.playedVulnerable && !this.isMuted) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                        this.playedVulnerable = true;
                    }
                } else {
                    this.vulnerableSound.pause();
                    this.vulnerableSound.currentTime = 0;
                    this.playedVulnerable = false;
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById('audio-toggle');
                const icon = btn.querySelector('i');

                if (!this.isMuted) {
                    this.ambience.play().catch(e => console.log("Autoplay blocked"));
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-high');
                    btn.classList.add('text-amber-500', 'border-amber-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                    if(this.playedVulnerable) this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                } else {
                    this.ambience.pause();
                    this.vulnerableSound.pause();
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-volume-mute');
                    btn.classList.remove('text-amber-500', 'border-amber-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
            }
        }
        const audioManager = new AudioManager();
        window.audioManager = audioManager;

        // --- FX MANAGER ---
        class FXManager {
            constructor() {
                this.overlay = document.getElementById('fx-overlay');
                this.vignette = document.getElementById('vignette-overlay');
            }
            clearEffects() {
                this.overlay.classList.remove('fx-rift-pulse', 'fx-flash-red'); 
                if (!gameState.isRiftCollapse) {
                    this.overlay.classList.remove('fx-rift-collapsed');
                }
            }
            flashRed() {
                this.overlay.classList.add('fx-flash-red');
                setTimeout(() => { if(this.overlay) this.overlay.classList.remove('fx-flash-red'); }, 400);
            }
            setVignette(active) {
                if(active) this.vignette.classList.add('vignette-active');
                else this.vignette.classList.remove('vignette-active');
            }
        }
        const fxManager = new FXManager();
        window.fxManager = fxManager;

        // --- STATIC IMAGE MAPPING ---
		const sceneImages = {
			'prologue_storm': 'images/storm.jpg', 'prologue_abyss': 'images/abyss.jpg', 'start': 'images/wreckage.jpg',
			'start_medicine_success': 'images/wreckage.jpg', 'start_medicine_fail': 'images/wreckage.jpg', 'wreckage_success': 'images/chest.jpg',
			'wreckage_fail': 'images/sand_empty.jpg', 'treeline': 'images/forest.jpg', 'treeline_prepared': 'images/forest.jpg',
			'road_encounter': 'images/guard_road.jpg', 'trail_success': 'images/smuggler_cove_high.jpg', 'trail_success_talon': 'images/smuggler_cove_high.jpg',
			'trail_fail': 'images/stumble_guard.jpg', 'guard_talk': 'images/guard_face.jpg', 'guard_respect': 'images/guard_salute.jpg',
			'guard_bribe': 'images/guard_bribe.jpg', 'guard_scared': 'images/guard_scared.jpg', 'combat_guard': 'images/combat_hammer.jpg',
			'smuggler_meet': 'images/smuggler_standoff.jpg', 'smuggler_cargo': 'images/smuggler_pay.jpg', 'smuggler_friend': 'images/smuggler_rum.jpg',
			'smuggler_pay': 'images/smuggler_pay.jpg', 'market_crossroads': 'images/market.jpg', 'market_stall': 'images/merchant.jpg',
			'market_sell': 'images/merchant.jpg', 'buy_rum': 'images/merchant.jpg', 'buy_potion': 'images/merchant.jpg',
			'buy_rope': 'images/merchant.jpg', 'buy_torch': 'images/merchant.jpg', 'sell_cargo': 'images/merchant.jpg',
			'sell_rope': 'images/merchant.jpg', 'sell_torch': 'images/merchant.jpg', 'sell_potion': 'images/merchant.jpg',
			'sell_rum': 'images/merchant.jpg', 'lighthouse_split': 'images/lighthouse_far.jpg', 'cliff_climb': 'images/cliff.jpg',
			'climb_fail': 'images/fall_cliff.jpg', 'dark_caves': 'images/caves.jpg', 'dark_caves_illuminated': 'images/caves.jpg',
			'dark_fail': 'images/cave_injury.jpg', 'lighthouse_arrival': 'images/lighthouse_door.jpg', 'ending_order': 'images/guards_win.jpg',
			'ending_chaos': 'images/smugglers_win.jpg', 'ending_neutral_check': 'images/lockpick.jpg', 'ending_neutral_success': 'images/lockpick.jpg',
			'ending_neutral_fail': 'images/lighthouse_door.jpg', 'lighthouse_vigil': 'images/dream.jpg', 'captain_orders': 'images/lighthouse_vigil.jpg',
			'lighthouse_morning': 'images/lighthouse_morning.jpg', 'learn_absorb': 'images/lighthouse_morning.jpg', 'learn_primeval': 'images/lighthouse_morning.jpg',
			'cliffside_overlook': 'images/cliffside_overlook.jpg', 'overlook_scan_success': 'images/cliffside_overlook.jpg', 'overlook_scan_fail': 'images/cliffside_overlook.jpg',
			'overlook_hasten_fail': 'images/cliffside_overlook.jpg', 'meeting_the_stranger': 'images/cliffside_overlook.jpg', 'town_descent': 'images/town_descent.jpg',
			'town_square': 'images/town_square.jpg', 'alchemist_triage': 'images/plague_doctor.jpg', 'alchemist_secret_stock': 'images/alchemist_secret.jpg',
			'alchemist_sell': 'images/plague_doctor.jpg', 'sell_locket_alch': 'images/plague_doctor.jpg', 'buy_fire': 'images/plague_doctor.jpg',
			'buy_water': 'images/plague_doctor.jpg', 'buy_tincture': 'images/plague_doctor.jpg', 'buy_salts': 'images/plague_doctor.jpg',
			'buy_powder': 'images/plague_doctor.jpg', 'sell_potion_alch': 'images/plague_doctor.jpg', 'sell_mushroom_alch': 'images/plague_doctor.jpg',
			'sell_fire': 'images/plague_doctor.jpg', 'sell_water': 'images/plague_doctor.jpg', 'sell_tincture': 'images/plague_doctor.jpg',
			'blackwater_tavern': 'images/tavern_dark.jpg', 'eat_gruel_instant': 'images/tavern_dark.jpg', 'buy_gruel_to_go': 'images/tavern_dark.jpg',
			'tavern_gambler': 'images/tavern_gambler.jpg', 'tavern_confiscate_dice': 'images/tavern_gambler.jpg', 'tavern_payout': 'images/tavern_gambler.jpg',
			'tavern_expose_success': 'images/tavern_gambler.jpg', 'tavern_expose_fail': 'images/tavern_gambler.jpg', 'tavern_rest_success': 'images/tavern_dark.jpg',
			'town_docks': 'images/docks.jpg', 'docks_sell_cargo': 'images/docks.jpg', 'docks_work': 'images/docks_work.jpg',
			'docks_dive_success': 'images/docks_treasure.jpg', 'docks_dive_fail': 'images/docks_work.jpg', 'docks_smuggler_success': 'images/docks.jpg',
			'docks_smuggler_fail': 'images/docks.jpg', 'gather_info_smelter': 'images/tavern_dark.jpg', 'gather_info_chapel': 'images/tavern_dark.jpg',
			'smelter_entry': 'images/steam_pipe.jpg', 'smelter_side_rope': 'images/smelter_workers.jpg', 'smelter_safe': 'images/steam_pipe.jpg',
			'smelter_damage': 'images/steam_pipe.jpg', 'smelter_workers': 'images/smelter_workers.jpg', 'smelter_containment_success': 'images/smelter_workers.jpg',
			'smelter_save_workers_success': 'images/smelter_workers.jpg', 'smelter_save_workers_fail': 'images/smelter_workers.jpg', 'smelter_stage1_start': 'images/slag_horror.jpg',
			'smelter_stage2_clean': 'images/slag_horror_close.jpg', 'smelter_stage2_damaged': 'images/slag_horror_close.jpg', 'smelter_victory_lubricant': 'images/slag_horror_exposed.jpg',
			'smelter_victory_ring': 'images/slag_horror_exposed.jpg', 'smelter_victory_item': 'images/slag_horror_exposed.jpg', 'smelter_victory_skill': 'images/slag_horror_exposed.jpg',
			'smelter_victory_brute': 'images/slag_horror_exposed.jpg', 'chapel_entry': 'images/fog_cemetery.jpg', 'chapel_side_torch': 'images/chapel_vestry.jpg',
			'chapel_safe': 'images/fog_cemetery.jpg', 'chapel_damage': 'images/fog_cemetery.jpg', 'chapel_vestry': 'images/chapel_vestry.jpg',
			'chapel_rescue_success': 'images/chapel_vestry.jpg', 'chapel_rescue_fail': 'images/chapel_vestry.jpg', 'chapel_ignore_drowning': 'images/chapel_vestry.jpg',
			'chapel_stage1_reveal': 'images/drowned_spectre.jpg', 'chapel_stage2_finish': 'images/drowned_spectre_close.jpg', 'chapel_stage2_hit_damaged': 'images/drowned_spectre_close.jpg',
			'chapel_stage2_miss_damaged': 'images/drowned_spectre_close.jpg', 'chapel_victory_water': 'images/drowned_spectre_close.jpg', 'chapel_victory_sword': 'images/drowned_spectre_close.jpg',
			'chapel_victory_item': 'images/drowned_spectre_close.jpg', 'chapel_victory_skill': 'images/drowned_spectre_close.jpg', 'chapel_victory_brute': 'images/drowned_spectre_close.jpg',
			'rift_collapse_punishment': 'images/rift_collapse_red.jpg', 'finale_ritual_start': 'images/town_square.jpg', 'edward_death': 'images/abyss.jpg',
			'act2_arrival': 'images/manor_ethereal.jpg', 'act2_tether_fail': 'images/rift_collapse_red.jpg', 'manor_foyer': 'images/manor_foyer.jpg',
			'manor_map_view': 'images/manor_blueprint.jpg', 'manor_library': 'images/manor_library.jpg', 'library_success': 'images/manor_library.jpg',
			'library_fail': 'images/manor_library.jpg', 'manor_servants_passage': 'images/manor_library.jpg', 'manor_crawlspace': 'images/manor_hall.jpg',
			'cub_encounter': 'images/displacer_cub.jpg', 'cub_tame_success': 'images/displacer_cub.jpg', 'cub_tame_fail': 'images/displacer_cub.jpg',
			'manor_kitchens': 'images/manor_kitchens.jpg', 'manor_ballroom_encounter': 'images/manor_ballroom.jpg', 'manor_ballroom_safe': 'images/manor_ballroom.jpg',
			'gareth_spar_success': 'images/manor_ballroom.jpg', 'gareth_spar_fail': 'images/manor_ballroom.jpg', 'beast_blink_distract': 'images/manor_ballroom.jpg',
			'beast_true_sight': 'images/manor_ballroom.jpg', 'beast_fail': 'images/manor_ballroom.jpg', 'manor_hall': 'images/manor_hall.jpg',
			'manor_mimic_reveal': 'images/mimic.jpg', 'manor_mimic_trap': 'images/mimic.jpg', 'manor_mimic_victory': 'images/manor_hall.jpg',
			'manor_mimic_victory_combat': 'images/manor_hall.jpg', 'manor_automaton_encounter': 'images/brass_automaton.jpg', 'automaton_sunder_fail': 'images/brass_automaton.jpg',
			'automaton_blink_bypass': 'images/brass_automaton.jpg', 'automaton_brute_force': 'images/brass_automaton.jpg', 'automaton_victory_sword': 'images/brass_automaton.jpg',
			'automaton_disable_success': 'images/brass_automaton.jpg', 'automaton_disable_fail': 'images/brass_automaton.jpg', 'manor_staircase': 'images/manor_staircase.jpg',
			'staircase_fail': 'images/manor_staircase.jpg', 'manor_anchor_door': 'images/manor_staircase.jpg', 'act2_finale_resolution': 'images/manor_staircase.jpg',
			'manor_forge': 'images/manor_kitchens.jpg', 'manor_forge_combine': 'images/manor_kitchens.jpg', 'manor_foyer_safe': 'images/manor_foyer.jpg',
			'manor_library_safe': 'images/manor_library.jpg', 'library_research_success': 'images/manor_library.jpg', 'library_research_fail': 'images/manor_library.jpg',
			'manor_crawlspace_safe': 'images/manor_hall.jpg', 'talon_scavenge_gears': 'images/manor_hall.jpg', 'talon_scavenge_rare': 'images/manor_hall.jpg',
			'talon_scavenge_food': 'images/manor_hall.jpg', 'manor_cellar_puzzle': 'images/circuit_puzzle.jpg', 'manor_cellar_success': 'images/circuit_puzzle.jpg',
			'manor_hall_safe': 'images/manor_hall.jpg', 'manor_kitchens_safe': 'images/manor_kitchens.jpg', 'act3_long_rest': 'images/manor_foyer.jpg',
			'wolf_estate_safe': 'images/manor_foyer.jpg', 'anchor_decision_point': 'images/manor_staircase.jpg', 'act3_name_ship': 'images/pirate_ship_at_sea.jpg',
			'act3_intro_ship': 'images/pirate_ship_at_sea.jpg', 'port_provisioner': 'images/town_docks.jpg', 'port_provisioner_sell': 'images/town_docks.jpg',
			'sea_map_hub': 'images/map_compass.jpg', 'sea_feeding_grounds': 'images/feeding_grounds.jpg', 'feeding_success': 'images/feeding_grounds.jpg',
			'feeding_fail': 'images/feeding_grounds.jpg', 'sea_flotsam_event': 'images/pirate_ship_at_sea.jpg', 'flotsam_success': 'images/pirate_ship_at_sea.jpg',
			'flotsam_fail': 'images/pirate_ship_at_sea.jpg', 'sea_fish_success': 'images/pirate_ship_at_sea.jpg', 'sea_fish_fail': 'images/pirate_ship_at_sea.jpg',
			'sea_event_fog': 'images/fog_at_sea.jpg', 'sea_fog_puzzle': 'images/fog_at_sea.jpg', 'sea_fog_success': 'images/fog_at_sea.jpg',
			'sea_fog_partial': 'images/fog_at_sea.jpg', 'sea_fog_fail': 'images/fog_at_sea.jpg', 'sea_navy_encounter': 'images/navy_ship.jpg',
			'sea_navy_clean': 'images/navy_ship.jpg', 'sea_navy_caught': 'images/navy_ship.jpg', 'sea_navy_jettison': 'images/navy_ship.jpg',
			'sea_navy_combat': 'images/navy_ship.jpg', 'sea_sanguine_tithe_event': 'images/navy_ship.jpg', 'silas_reckoning_logic': 'images/navy_ship.jpg',
			'silas_reckoning_success': 'images/navy_ship.jpg', 'silas_reckoning_combat': 'images/navy_ship.jpg', 'tithe_combat': 'images/navy_ship.jpg',
			'tithe_loot_success': 'images/navy_ship.jpg', 'post_spire_rest': 'images/pirate_ship_at_sea.jpg', 'citadel_reaction_logic': 'images/iron_citadel.jpg',
			'silas_final_words': 'images/pirate_ship_at_sea.jpg', 'sea_scavenger_encounter': 'images/pirate_ship_at_sea.jpg', 'bleak_dogtooth': 'images/bleak_coast.jpg',
			'dogtooth_intimidate_success': 'images/bleak_coast.jpg', 'dogtooth_intimidate_fail': 'images/bleak_coast.jpg', 'dogtooth_lore_success': 'images/bleak_coast.jpg',
			'dogtooth_lore_fail': 'images/bleak_coast.jpg', 'dogtooth_cliff_wall': 'images/dogtooth_cliff_wall.jpg', 'silas_sanctuary': 'images/dogtooth_cliff_wall.jpg',
			'silas_recruit_success': 'images/dogtooth_cliff_wall.jpg', 'dogtooth_envoy': 'images/bleak_coast.jpg', 'envoy_mercy_kill': 'images/bleak_coast.jpg',
			'envoy_turn': 'images/bleak_coast.jpg', 'dogtooth_lab_ruins': 'images/bleak_coast.jpg', 'envoy_turn': 'images/bleak_coast.jpg',
			'hub_order': 'images/iron_citadel.jpg', 'order_quartermaster': 'images/iron_citadel.jpg', 'barracks_clue_found': 'images/iron_citadel.jpg',
			'barracks_clue_fail': 'images/iron_citadel.jpg', 'order_petrified_ward': 'images/iron_citadel.jpg', 'ward_medicine_success': 'images/iron_citadel.jpg',
			'ward_medicine_fail': 'images/iron_citadel.jpg', 'ward_donate_rum': 'images/iron_citadel.jpg', 'ward_bloom_event': 'images/coral_hulk.jpg',
			'ward_bloom_combat': 'images/coral_hulk.jpg', 'ward_bloom_success': 'images/coral_hulk.jpg', 'ward_bloom_fail': 'images/coral_hulk.jpg',
			'order_quest_fence_start': 'images/iron_citadel.jpg', 'order_quest_start': 'images/iron_citadel.jpg', 'coral_hulk_intro': 'images/coral_hulk.jpg',
			'coral_hulk_combat': 'images/coral_hulk.jpg', 'coral_hulk_victory': 'images/coral_hulk.jpg', 'hub_chaos': 'images/titans_molt.jpg',
			'chaos_market': 'images/titans_molt.jpg', 'chaos_secret_shop_check': 'images/titans_molt.jpg', 'chaos_secret_success': 'images/titans_molt.jpg',
			'chaos_secret_fail': 'images/titans_molt.jpg', 'molt_traitor_confront': 'images/titans_molt.jpg', 'traitor_execute': 'images/titans_molt.jpg',
			'traitor_mercy': 'images/titans_molt.jpg', 'traitor_blackmail': 'images/titans_molt.jpg', 'chaos_fence_confrontation': 'images/titans_molt.jpg',
			'fence_resolution_order': 'images/titans_molt.jpg', 'fence_resolution_chaos': 'images/titans_molt.jpg', 'fence_resolution_neutral': 'images/titans_molt.jpg',
			'chaos_quest_start': 'images/titans_molt.jpg', 'sanguine_spire_entry': 'images/gothic_sea_spire.jpg', 'sanguine_spire_combat': 'images/gothic_sea_spire.jpg',
			'spire_combat_loop': 'images/gothic_sea_spire.jpg', 'spire_victory': 'images/gothic_sea_spire.jpg', 'ending_champion': 'images/abyss.jpg',
			'ending_protector': 'images/lighthouse_morning.jpg', 'default': 'https://placehold.co/600x400/0f172a/1e293b?text=The+Void'
		};
    
    // --- GAME STATE FACTORY ---
    function createInitialState() {
        return {
            currentSceneId: 'prologue_storm', currentHP: 20, maxHP: 20, shillings: 0, influence: 0, doomTimer: 20,
            guidingDieSize: 4, act1Started: false, isRiftCollapse: false, hasLoggedCollapse: false, isAbsorbCharged: false,
            isSurpriseRound: false, knowsSmelterSecret: false, knowsChapelSecret: false, hasObservedGambler: false, 
            hasSearchedSmugglerDrop: false, docksWorkCount: 0, quinnLogistics: false, hasDivedTreasure: false,
            act2Started: false, isEthereal: false, tetherTimer: 20, returnSceneId: null, hallLooted: false, hasBlinkSkill: false,
            act3Started: false, cellarUnlocked: false, pendingDestination: null, factionAligned: null, shipName: "The Iron Lung",
            supplies: 10, knownIslands: ['port_hub'], currentLocation: 'port_hub', silasJoined: false, silasVengeanceActive: false,
            inventory: [], skills: [], crewUseFree: false, lastCrewUsedId: null, 
            crew: {
                gareth: { id: 'gareth', name: 'Captain Gareth', skill: 'Intimidation & Insight', used: false, desc: 'Add +1d4 to Intimidation & Insight' },
                quinn: { id: 'quinn', name: 'Quinn', skill: 'Investigation & History', used: false, desc: 'Add +1d4 to Investigation & History' },
                talon: { id: 'talon', name: 'Talon', skill: 'Survival & Perception', used: false, desc: 'Add +1d4 to Survival & Perception' },
                bones: { id: 'bones', name: 'Bones', skill: 'Medicine & Nature', used: false, desc: 'Add +1d4 to Medicine & Nature' }
            },
            history: [],
            companions: {
                silas: { joined: false, name: "Silas", desc: "Wolf King's Seneschal (Passive: Pack Tactics)", active: false },
                blink: { joined: false, name: "Blink", desc: "Displacer Cub (Active: Phase Shift)", active: false }
            },
            isBossCombat: false, enemyHP: 0, maxEnemyHP: 0, currentEnemy: '', enemies: {}, activeEnemies: [], maxElderHP: 0, 
            nextAttackCrit: false, negateNextDamage: false, baseDamage: 0, crewSkillBonuses: { gareth: 0, quinn: 0, talon: 0, bones: 0 },
            activeBoons: [], dreamTransitionPending: null, allyCooldowns: { silas: 0, blink: 0 }, passiveDefenseBonus: 0,
        };
    }
    let gameState = createInitialState();
    let activeCrewMember = null;

    // --- UTILITY: CREW SKILL CHECKER ---
    function getBonusForSkill(crewMember, skillType) {
        const expertise = {
            'Captain Gareth': ['Insight', 'Intimidation'],
            'Quinn': ['Investigation', 'History'],
            'Talon': ['Survival', 'Perception'],
            'Bones': ['Nature', 'Medicine']
        };
        const allowedSkills = expertise[crewMember.name] || [];
        return allowedSkills.includes(skillType);
    }
    window.getBonusForSkill = getBonusForSkill;


    // --- PUZZLE MANAGER ---
    const puzzleManager = {
        typeBanter: function(elementId, text, speed = 25) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = ''; el.classList.add('slow-type');
            let i = 0;
            function type() {
                if (!document.getElementById(elementId)) return;
                if (i < text.length) { el.innerHTML += text.charAt(i); i++; setTimeout(type, speed); } 
                else { el.classList.remove('slow-type'); }
            }
            type();
        },
        initCircuit: function() {
            const correctSequence = [1, 3, 2]; let userSequence = [];
            const nodes = document.querySelectorAll('.circuit-node');
            nodes.forEach(node => {
                node.addEventListener('click', (e) => {
                    if (e.target.classList.contains('success') || e.target.classList.contains('active')) return;
                    const val = parseInt(e.target.dataset.value);
                    if (val === correctSequence[userSequence.length]) {
                        userSequence.push(val); e.target.classList.add('active'); e.target.classList.remove('error'); audioManager.playClick();
                        if (userSequence.length === correctSequence.length) {
                            nodes.forEach(n => n.classList.add('success'));
                            document.getElementById('circuit-message').innerHTML = "<span class='text-emerald-400'>Circuit Stabilized.</span>";
                            audioManager.playCoins(); setTimeout(() => renderScene('manor_cellar_success'), 1000);
                        }
                    } else {
                        e.target.classList.add('error'); document.getElementById('circuit-message').innerHTML = "<span class='text-red-400'>Error! Resetting...</span>";
                        userSequence = []; audioManager.playClash();
                        setTimeout(() => { nodes.forEach(n => n.classList.remove('active', 'error')); document.getElementById('circuit-message').innerHTML = "Input Sequence..."; }, 800);
                    }
                });
            });
        },
        compassTimer: null, isCompassAligned: false,
        initCompass: function() {
            if (this.compassTimer) cancelAnimationFrame(this.compassTimer);
            this.isCompassAligned = false;
            const needle = document.getElementById('compass-needle');
            const targetAngle = Math.floor(Math.random() * 140) + 20;
            document.getElementById('compass-target').style.transform = `rotateZ(${targetAngle}deg)`;
            let visualRotation = 0, lastRawAngle = 0, isDragging = false, startTime = Date.now();
            const DURATION = 10; 

            const getAngle = (x, y) => {
                const rect = document.getElementById('compass-container').getBoundingClientRect();
                const cx = rect.left + rect.width / 2; const cy = rect.top + rect.height / 2;
                let a = Math.atan2(y - cy, x - cx) * (180 / Math.PI) + 90;
                return a < 0 ? a + 360 : a;
            };
            const updateLoop = () => {
                if (!document.getElementById('compass-container')) return;
                const elapsed = (Date.now() - startTime) / 1000;
                const left = Math.max(0, DURATION - elapsed);
                if(document.getElementById('compass-timer-text')) document.getElementById('compass-timer-text').innerText = left.toFixed(1);
                if (this.isCompassAligned && left > 0) { renderScene('sea_fog_success'); return; }
                if (left <= 0) { renderScene('sea_fog_fail'); return; }
                this.compassTimer = requestAnimationFrame(updateLoop);
            };
            const dragMove = (e) => {
                if (!isDragging || this.isCompassAligned) return;
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.touches[0].clientY; // Fix touch Y coordinate
                const currAngle = getAngle(clientX, clientY);
                let delta = currAngle - lastRawAngle;
                if (delta > 180) delta -= 360; if (delta < -180) delta += 360;
                visualRotation += delta;
                needle.style.transform = `rotateZ(${visualRotation}deg)`;
                lastRawAngle = currAngle;
                let checkRot = visualRotation % 360; if (checkRot < 0) checkRot += 360;
                if (checkRot > targetAngle - 12 && checkRot < targetAngle + 12) {
                    this.isCompassAligned = true; needle.classList.add('aligned'); needle.style.transform = `rotateZ(${targetAngle}deg)`; 
                }
            };
            needle.addEventListener('mousedown', (e) => { isDragging = true; lastRawAngle = getAngle(e.clientX, e.clientY); });
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', () => isDragging = false);
            needle.addEventListener('touchstart', (e) => { isDragging = true; lastRawAngle = getAngle(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('touchend', () => isDragging = false);
            updateLoop();
        }
    };

    // --- GAME FUNCTIONS ---
    window.gameFunctions.checkForContraband = function() { return gameState.inventory.some(itemName => { const item = itemRegistry[itemName]; return item && item.isContraband; }); };
    
    // --- CORE GAME ENGINE FUNCTIONS (Must be accessible from scenes.js via window) ---
    function initCombat(enemyName, hp, damageRange) {
        gameState.isBossCombat = true; gameState.currentEnemy = enemyName; gameState.enemyHP = hp; gameState.maxEnemyHP = hp; gameState.enemyDamageRange = damageRange;
        gameState.enemies = {}; gameState.activeEnemies = []; gameState.allyCooldowns.silas = 0; gameState.allyCooldowns.blink = 0;
    }
    window.initCombat = initCombat;

    function initHordeCombat(baseName, hpPerEnemy, damageRange, count) {
        gameState.isBossCombat = true; gameState.currentEnemy = baseName; gameState.enemies = {}; gameState.activeEnemies = []; gameState.maxElderHP = hpPerEnemy; gameState.enemyDamageRange = damageRange;
        let totalHP = 0;
        for (let i = 0; i < count; i++) { const name = `${baseName} ${String.fromCharCode(65 + i)}`; gameState.enemies[name] = hpPerEnemy; gameState.activeEnemies.push(name); totalHP += hpPerEnemy; }
        gameState.enemyHP = totalHP; gameState.maxEnemyHP = totalHP; gameState.allyCooldowns.silas = 0; gameState.allyCooldowns.blink = 0;
    }
    window.initHordeCombat = initHordeCombat;

    // --- COMBAT RESOLVERS ---
    window.resolveCombatRound = function(attackType) {
        const state = window.gameState || gameState;
        let playerDmg = 0; let log = "";
        const levelBonus = (state.baseDamage || 0);
        
        if (attackType === 'valor_strike') { playerDmg = Math.floor(Math.random() * 8) + 6 + levelBonus; log += "Valor Strike! "; } 
        else if (attackType === 'heavy_strike') playerDmg = Math.floor(Math.random() * 6) + 2 + levelBonus;
        else if (attackType === 'item_holy_water') { playerDmg = 25; log += "Holy Water burns! "; }
        else if (attackType === 'item_fire') { playerDmg = 20; log += "Alchemical Fire! "; }
        else if (attackType === 'item_flash') { playerDmg = 0; log += "Flash Powder blinded them! "; }
        else if (attackType === 'item_sun_star') { playerDmg = 25; log += "Sun-Star Grenade! "; }
        else if (attackType === 'item_stake_driver') { playerDmg = Math.floor(Math.random() * 8) + 4 + levelBonus; log += "Stake Driver fired! "; }
        else if (attackType === 'reflect_stance') { playerDmg = 0; } // Damage is dealt back on reflection check

        if (state.battleRhythm && playerDmg > 0) { playerDmg *= 2; state.battleRhythm = false; const idx = state.inventory.indexOf("Battle Rhythm"); if (idx > -1) state.inventory.splice(idx, 1); log += "(Battle Rhythm x2) "; }
        if (state.nextAttackCrit && playerDmg > 0) { playerDmg = Math.floor(playerDmg * 2.5); state.nextAttackCrit = false; log += "(Phase Strike Crit) "; }
        if (state.activeBoons.includes('ghost_hunter') && state.isEthereal && playerDmg > 0) { playerDmg += 2; log += "(Ghost Hunter +2) "; }

        state.enemyHP -= playerDmg;
        if (playerDmg > 0) log += `Dealt <b>${playerDmg}</b> damage. `;

        if (state.enemyHP <= 0) {
            state.enemyHP = 0; state.isBossCombat = false; window.audioManager.playClash();
            addToHistory(log + ` The ${state.currentEnemy} falls!`, 'combat');
            if (state.currentEnemy === 'Coral-Hulk') renderScene('coral_hulk_victory'); else renderScene('spire_victory');
            return;
        }

        let enemySkipped = (attackType === 'item_flash' || attackType === 'item_stake_driver' || attackType === 'item_sun_star');
        if (!enemySkipped) {
            let enemyDmg = Math.floor(Math.random() * (state.enemyDamageRange[1] - state.enemyDamageRange[0] + 1)) + state.enemyDamageRange[0];
            if (attackType === 'reflect_stance') {
                log += ` Mirror Shield reflected ${enemyDmg} damage back!`; state.enemyHP -= enemyDmg; enemyDmg = 0;
                if (state.enemyHP <= 0) { state.isBossCombat = false; renderScene('coral_hulk_victory'); return; }
            } else {
                if (state.inventory.includes("Mirror Shield")) enemyDmg = Math.max(0, enemyDmg - 1);
                if (state.inventory.includes("Salt-Warped Spyglass") && state.influence <= -15) enemyDmg = Math.max(0, enemyDmg - 1);
                if (state.negateNextDamage) { enemyDmg = 0; state.negateNextDamage = false; log += " Silas blocked the attack!"; } 
                else {
                    const oldHP = state.currentHP; state.currentHP = window.applyDamage(state.currentHP, enemyDmg);
                    const taken = oldHP - state.currentHP;
                    if (taken > 0) { log += ` Enemy hit for <b>${taken}</b> damage!`; window.fxManager.flashRed(); } 
                    else { log += " Attack absorbed."; }
                }
            }
        }
        if (state.currentEnemy === 'Coral-Hulk' && state.enemyHP > 0) { state.enemyHP = Math.min(state.maxEnemyHP, state.enemyHP + 5); log += " (Regen +5)"; }
        if (state.allyCooldowns.silas > 0) state.allyCooldowns.silas--;
        if (state.allyCooldowns.blink > 0) state.allyCooldowns.blink--;
        addToHistory(log, 'combat'); updateUI(); renderScene(state.currentSceneId);
    };
    window.resolveCombatRound = resolveCombatRound;

    window.resolveHordeRound = function(attackType, targetElder) {
        const state = window.gameState || gameState;
        let playerDmg = 0; let log = ""; let eldersKilled = 0; const levelBonus = (state.baseDamage || 0);

        if (attackType === 'valor_strike') playerDmg = Math.floor(Math.random() * 8) + 6 + levelBonus;
        else if (attackType === 'heavy_strike') playerDmg = Math.floor(Math.random() * 6) + 2 + levelBonus;
        else if (attackType === 'item_holy_water') playerDmg = 25;
        else if (attackType === 'item_fire') playerDmg = 20;
        else if (attackType === 'item_sun_star') playerDmg = 25;
        else if (attackType === 'item_stake_driver') playerDmg = Math.floor(Math.random() * 8) + 4 + levelBonus;

        let isAOE = (attackType === 'item_holy_water' || attackType === 'item_fire' || attackType === 'item_sun_star');
        let isStun = (attackType === 'item_flash' || attackType === 'item_sun_star' || attackType === 'item_stake_driver');
        let isForce = state.isEthereal && state.currentEnemy.includes('Vampire');

        if (state.activeBoons.includes('ghost_hunter') && state.isEthereal && playerDmg > 0) playerDmg += 2;
        if (isForce && state.activeEnemies.length === 1 && playerDmg > 0) playerDmg += 2;
        if (state.nextAttackCrit && playerDmg > 0) { playerDmg = Math.floor(playerDmg * 2.5); state.nextAttackCrit = false; log += "(Crit) "; }
        if (gameState.battleRhythm && playerDmg > 0) { playerDmg = playerDmg * 2; gameState.battleRhythm = false; const idx = gameState.inventory.indexOf("Battle Rhythm"); if (idx > -1) gameState.inventory.splice(idx, 1); log += "(Battle Rhythm x2) "; }


        const targets = isAOE ? [...state.activeEnemies] : [targetElder];
        targets.forEach(elder => {
            if (!state.activeEnemies.includes(elder)) return;
            let dmg = playerDmg;
            if (!isAOE && !isStun && state.activeEnemies.length >= 2 && !state.isEthereal && attackType !== 'none') {
                if (Math.random() < 0.3) { dmg = 0; log += `${elder} Evaded. `; }
            }
            if (dmg > 0) {
                state.enemies[elder] = Math.max(0, state.enemies[elder] - dmg); log += `${elder}: -${dmg}. `;
                if (state.enemies[elder] <= 0) { eldersKilled++; log += `${elder} Destroyed! `; }
            }
        });

        state.activeEnemies = state.activeEnemies.filter(e => state.enemies[e] > 0);
        state.enemyHP = state.activeEnemies.reduce((sum, e) => sum + state.enemies[e], 0);

        if (state.activeEnemies.length === 0) {
            state.isBossCombat = false; window.audioManager.playClash(); addToHistory(log + " Victory!", 'combat'); renderScene('spire_victory'); return;
        }

        if (eldersKilled === 1 && state.activeEnemies.length === 2) { log += "Elders shriek (Stun Cooldowns). "; state.allyCooldowns.silas++; state.allyCooldowns.blink++; }
        if (eldersKilled === 2 && state.activeEnemies.length === 1) { const last = state.activeEnemies[0]; state.enemies[last] += 20; log += "Last Elder absorbs power (+20 HP). "; }

        if (!isStun) {
            if (state.negateNextDamage) { state.negateNextDamage = false; log += " Silas blocked retaliation."; } 
            else {
                let incoming = 0;
                state.activeEnemies.forEach(() => { incoming += Math.floor(Math.random() * (state.enemyDamageRange[1] - state.enemyDamageRange[0] + 1)) + state.enemyDamageRange[0]; });
                if (state.inventory.includes("Mirror Shield")) incoming = Math.max(0, incoming - state.activeEnemies.length);
                const oldHP = state.currentHP; state.currentHP = window.applyDamage(state.currentHP, incoming);
                const taken = oldHP - state.currentHP;
                if (taken > 0) { log += ` Horde hit for ${taken} damage.`; window.fxManager.flashRed(); }
            }
        } else { log += " Enemies Stunned."; }

        if (state.allyCooldowns.silas > 0) state.allyCooldowns.silas--;
        if (state.allyCooldowns.blink > 0) state.allyCooldowns.blink--;
        addToHistory(log, 'combat'); updateUI(); renderScene(state.currentSceneId);
    };
    window.resolveHordeRound = resolveHordeRound;

    window.allyCommand = function(allyId) {
        const state = window.gameState || gameState;
        if (state.isBossCombat && state.allyCooldowns[allyId] === 0) {
            if (allyId === 'silas') {
                state.negateNextDamage = true; let cd = 2;
                if (state.silasVengeanceActive && state.currentEnemy.includes('Vampire')) { cd = 1; addToHistory("Vengeance: Intercept Ready!", 'system'); }
                state.allyCooldowns.silas = cd; addToHistory("Silas Intercepting!", 'system');
            } else if (allyId === 'blink') {
                state.nextAttackCrit = true; state.allyCooldowns.blink = 3; addToHistory("Blink Phase Shift!", 'system');
            }
            if (state.activeEnemies && state.activeEnemies.length > 0) window.resolveHordeRound('none', 'none');
            else window.resolveCombatRound('none');
        } else { addToHistory("Ally unavailable.", 'system'); }
        saveGame(); updateUI();
    };
    window.allyCommand = allyCommand;

    window.gameFunctions.togglePlaneWalk = function() {
        if (!gameState.skills.includes("Plane Walking")) { addToHistory("You do not know how to walk the planes yet.", "system"); return; }
        gameState.isEthereal = !gameState.isEthereal;
        if (gameState.isEthereal) { document.body.classList.add('plane-ethereal'); audioManager.playGhost(); } 
        else { document.body.classList.remove('plane-ethereal'); audioManager.playClick(); }
        renderScene(gameState.currentSceneId, false);
    };

    window.gameFunctions.toggleBackpack = function() {
        const modal = document.getElementById('backpack-modal'); const btn = document.getElementById('btn-combined-pack');
        if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); audioManager.playClick(); } else { modal.classList.add('hidden'); }
    };
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('backpack-modal'); const btn = document.getElementById('btn-combined-pack');
        if (modal && !modal.classList.contains('hidden')) { if (!modal.contains(event.target) && !btn.contains(event.target)) { modal.classList.add('hidden'); } }
    });

    // --- DAMAGE APPLICATION (Must be globally accessible for onEnter logic in scenes.js) ---
    function applyDamage(currentHP, damageAmount, damageType = 'physical') {
        let finalDamage = damageAmount;
        if (damageType === 'psychic' && gameState.activeBoons.includes('iron_will')) finalDamage = Math.max(0, finalDamage - 2);
        if ((damageType === 'poison' || damageType === 'acid') && gameState.activeBoons.includes('chemical_resist')) finalDamage = Math.floor(finalDamage / 2);
        if (gameState.inventory.includes("Salt-Warped Spyglass") && gameState.influence <= -15) finalDamage = Math.max(0, finalDamage - 1);
        if (gameState.negateNextDamage) { finalDamage = 0; gameState.negateNextDamage = false; addToHistory("Silas intercepted!", 'system'); }
        let finalHP = Math.max(0, currentHP - finalDamage);
        if (finalHP === 0 && gameState.activeBoons.includes('hold_the_line') && !gameState.holdTheLineUsed) { finalHP = 1; gameState.holdTheLineUsed = true; addToHistory("HOLD THE LINE! (1 HP)", 'danger'); }
        if (finalHP === 0) { const idx = gameState.inventory.indexOf("Phoenix Draft"); if (idx > -1) { gameState.inventory.splice(idx, 1); finalHP = 10; addToHistory(`*Phoenix Draft Shatters! +10 HP*`, 'system'); fxManager.flashRed(); } }
        return Math.max(0, finalHP);
    }
    window.applyDamage = applyDamage;

    // --- ITEM REGISTRY ---
    const itemRegistry = {
        "Captain's Tricorn": { name: "Captain's Tricorn", type: 'key', icon: 'fa-hat-cowboy', color: 'text-blue-500', desc: "Passive: A symbol of authority. +1 to Intimidation checks." },
        "Compass": { name: "Compass", type: 'key', icon: 'fa-compass', color: 'text-indigo-400', desc: "Passive: Violently hums near planar energy." },
        "Rusted Cutlass": { name: "Rusted Cutlass", type: 'key', icon: 'fa-khanda', color: 'text-gray-400', desc: "Passive: Reduces damage taken in combat events." },
        "Ship's Log": { name: "Ship's Log", type: 'key', icon: 'fa-book-open', color: 'text-amber-700', desc: "Key Item: Records of the damned. Unlocks your history." },
        "Curious Cargo": { name: "Curious Cargo", type: 'key', icon: 'fa-box-open', color: 'text-yellow-600', desc: "Contraband. Sell at Market or Cove.", isContraband: true, btnText: "SELL", action: (state) => { return "Must be sold at a merchant."; } },
        "Rum": { name: "Rum", type: 'consumable', icon: 'fa-wine-bottle', color: 'text-amber-500', btnText: "DRINK", desc: "Consumable: Potent grog. Restores 5 HP. Cannot repair Spectral HP.", action: (state) => { if (state.currentHP >= state.maxHP) { return "Your natural vitality is full. The burning grog offers no comfort to the Spectral Shield."; } let healAmount = 5; if (state.activeBoons.includes('triage')) healAmount += 2; const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount); const idx = state.inventory.indexOf("Rum"); if (idx > -1) state.inventory.splice(idx, 1); const boonText = state.activeBoons.includes('triage') ? " (Triage +2)" : ""; return `Drank Rum. Healed ${state.currentHP - oldHP} HP${boonText}.`; } },
        "Healing Potion": { name: "Healing Potion", type: 'consumable', icon: 'fa-flask', color: 'text-red-500', btnText: "DRINK", desc: "Consumable: Alchemical vitality. Restores 10 HP. Cannot repair Spectral HP.", action: (state) => { if (state.currentHP >= state.maxHP) return "Your health is full."; let healAmount = 10; if (state.activeBoons.includes('triage')) healAmount += 2; const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount); const idx = state.inventory.indexOf("Healing Potion"); if (idx > -1) state.inventory.splice(idx, 1); const boonText = state.activeBoons.includes('triage') ? " (Triage +2)" : ""; return `Drank Potion. Healed ${state.currentHP - oldHP} HP${boonText}.`; } },
        "Rope": { name: "Rope", type: 'key', icon: 'fa-chain', color: 'text-yellow-700', desc: "Passive: Essential for climbing cliffs." },
        "Torch": { name: "Torch", type: 'key', icon: 'fa-fire', color: 'text-orange-500', desc: "Passive: Illuminates dark caves." },
        "Pearlescent Mushroom": { name: "Pearlescent Mushroom", type: 'consumable', icon: 'fa-cloud-meatball', color: 'text-purple-400', btnText: "EAT", desc: "Consumable: Grants a free use of a Crew member's skill on the next check.", action: (state) => { if (state.crewUseFree) { return "Active."; } if (!state.crewUseFree) { state.crewUseFree = true; const idx = state.inventory.indexOf("Pearlescent Mushroom"); if (idx > -1) state.inventory.splice(idx, 1); return `Consumed Mushroom. Clarity gained!`; } state.inventory.splice(state.inventory.indexOf("Pearlescent Mushroom"), 1); state.crewUseFree = true; return "A soft purple light suffuses your mind. Your next Crew use will be free."; } },
        "Salt-Warped Spyglass": { name: "Salt-Warped Spyglass", type: 'key', icon: 'fa-eye', color: 'text-cyan-400', desc: "Key: A heavy brass instrument. The lens seems to shift focus on its own." },
        "Silver Locket": { name: "Silver Locket", type: 'key', icon: 'fa-heart', color: 'text-gray-300', btnText: "SELL", desc: "Passive: A sentimental item. Might be worth something." },
        "Gruel": { name: "Gruel", type: 'consumable', icon: 'fa-bowl-food', color: 'text-gray-400', btnText: "EAT", desc: "Consumable: Cheap, watery sustenance. Restores 2 HP. Cannot repair Spectral HP.", action: (state) => { if (state.currentHP >= state.maxHP) { return "You are full. The watery gruel offers no comfort to the Spectral Shield."; } const healAmount = 2; const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount); const idx = state.inventory.indexOf("Gruel"); if (idx > -1) state.inventory.splice(idx, 1); return `Ate Gruel. Healed ${state.currentHP - oldHP} HP.`; } },
        "Dead Man's Die": { name: "Dead Man's Die", type: 'consumable', icon: 'fa-dice-six', color: 'text-gray-200', btnText: "INSPECT", desc: "Consumable: A bone die loaded to cheat fate. Allows you to escape a failure outcome once." },
        "Strange Coin": { name: "Strange Coin", type: 'key', icon: 'fa-circle-notch', color: 'text-yellow-600', desc: "Passive: Ancient currency. May open doors not made of wood." },
        "Vitality Tincture": { name: "Vitality Tincture", type: 'consumable', icon: 'fa-syringe', color: 'text-red-300', btnText: "DRINK", desc: "Consumable: High-grade restorative. Restores 15 HP. Cannot repair Spectral HP.", action: (state) => { if (state.currentHP >= state.maxHP) { return "Your natural vitality is full. Tinctures cannot repair the Spectral Shield."; } let healAmount = 15; if (state.activeBoons.includes('triage')) healAmount += 2; const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount); const idx = state.inventory.indexOf("Vitality Tincture"); if (idx > -1) state.inventory.splice(idx, 1); const boonText = state.activeBoons.includes('triage') ? " (Triage +2)" : ""; return `Drank Tincture. Healed ${state.currentHP - oldHP} HP${boonText}.`; } },
        "Smelling Salts": { name: "Smelling Salts", type: 'consumable', icon: 'fa-spray-can', color: 'text-purple-400', btnText: "USE", desc: "Consumable: Revives a single used Crew Member (except the last one used).", action: (state) => { const usedCrew = Object.values(state.crew).filter(c => c.used); if (usedCrew.length === 0) { return "No crew members are currently exhausted."; } const revivableCrew = usedCrew.filter(c => c.id !== state.lastCrewUsedId); if (revivableCrew.length === 0) { return `Cannot revive ${state.lastCrewUsedId.charAt(0).toUpperCase() + state.lastCrewUsedId.slice(1)}: they were last used for a check.`; } const crewToRevive = revivableCrew[0]; state.crew[crewToRevive.id].used = false; const idx = state.inventory.indexOf("Smelling Salts"); if (idx > -1) state.inventory.splice(idx, 1); return `Used Salts. ${crewToRevive.name} is now available.`; } },
        "Flash Powder": { name: "Flash Powder", type: 'consumable', icon: 'fa-bomb', color: 'text-yellow-300', btnText: "THROW", desc: "Consumable: Guarantees escape from current combat (if in combat)." },
        "Industrial Lubricant": { name: "Industrial Lubricant", type: 'consumable', icon: 'fa-oil-can', color: 'text-gray-400', btnText: "USE", desc: "Counter: Oily solvent. Critical for Slag Horror (Fire Path)." },
        "Holy Water": { name: "Holy Water", type: 'consumable', icon: 'fa-cross', color: 'text-blue-200', btnText: "COMBINE", desc: "A sealed flask of consecrated water. Too precious to drink, but potent against the wicked." },
        "Alchemical Fire": { name: "Alchemical Fire", type: 'consumable', icon: 'fa-fire', color: 'text-orange-600', btnText: "IGNITE", desc: "Counter: Volatile mixture. Critical for Drowned Spectre (Shadow Path).", isCombinable: true },
        "Phoenix Draft": { name: "Phoenix Draft", type: 'key', icon: 'fa-feather', color: 'text-red-400', btnText: "PASSIVE", desc: "Key Item: Alchemical reserve. Automatically prevents death once, healing 10 HP. Consumed on use." },
        "Sword of Valor": { name: "Sword of Valor", type: 'weapon', icon: 'fa-star', color: 'text-yellow-400', desc: "A gleaming cutlass, sharp enough to cut the veil. Deals 1d8+1 Magic Damage.", damage: '1d8+1', isCombinable: true },
        "Ring of Brass": { name: "Ring of Brass", type: 'key', icon: 'fa-ring', color: 'text-amber-500', desc: "Legendary (Wolves of Valor): Doubles Primeval Awareness range. Grants Keen Senses (Perception advantage on hidden objects)." },
        "Spectral Lantern": { name: "Spectral Lantern", type: 'gear', icon: 'fa-lightbulb', color: 'text-amber-400', desc: "A lantern whose light burns cold and does not cast shadows. Grants +1 Defense (AC). Can be used at the Spectral Forge.", isCombinable: true, onAcquire: (state) => { state.passiveDefenseBonus += 1; }, onRemove: (state) => { state.passiveDefenseBonus -= 1; } },
        "Manor Blueprint": { name: "Manor Blueprint", type: 'key', icon: 'fa-map-signs', color: 'text-cyan-400', btnText: "VIEW", desc: "Passive: Schematics of the Vanishing Manor. Reveals the current room location via the 'Check Blueprint' action." },
        "Mimic's Bile": { name: "Mimic's Bile", type: 'ingredient', icon: 'fa-vial', color: 'text-green-500', desc: "Highly corrosive digestive acid, harvested from a Mimic's core. Deals Acid Damage.", isContraband: true, isCombinable: true, action: (state) => { return "A corrosive ingredient for the Spectral Forge. Do not drink."; } },
        "Mind-Expanding Grog": { name: "Mind-Expanding Grog", type: 'consumable', icon: 'fa-glass-water', color: 'text-purple-300', btnText: "DRINK", desc: "Consumable: A potent mix of spirits and mushroom extract. Acts as a Long Rest and grants one free Crew use.", action: (state) => { state.currentHP = state.maxHP; Object.values(state.crew).forEach(c => c.used = false); state.crewUseFree = true; const idx = state.inventory.indexOf("Mind-Expanding Grog"); if (idx > -1) state.inventory.splice(idx, 1); return "The grog is surprisingly smooth, followed by a rush of clarity. Your wounds close, your Crew awakens, and your next Guiding Voice is free."; } },
        "The Warding Ember": { name: "The Warding Ember", type: 'passive', icon: 'fa-gem', color: 'text-red-600', desc: "The Spectral Lantern fused with Alchemical Fire. It burns with protective intensity, permanently granting +2 Defense (AC).", onAcquire: (state) => { state.passiveDefenseBonus += 2; } },
        "Acid-Etched Sword of Valor": { name: "Acid-Etched Sword of Valor", type: 'weapon', icon: 'fa-biohazard', color: 'text-green-500', desc: "The blade is etched with glowing acid, effective against armor. Deals 1d8+1 Magic Damage, and an extra 1d4 Acid Damage (Ignores 1 AC).", damage: '1d8+1 + 1d4 (Acid vs Armor)', isCombined: true, },
        "Radiant-Washed Sword of Valor": { name: "Radiant-Washed Sword of Valor", type: 'weapon', icon: 'fa-sun', color: 'text-blue-200', desc: "The blade hums with purified light. Deals 1d8+1 Magic Damage, and an extra 1d4 Radiant Damage against Undead.", damage: '1d8+1 + 1d4 (Radiant vs Undead)', isCombined: true, },
        "Ember-Heart": { name: "Ember-Heart", type: 'key', icon: 'fa-fire-burner', color: 'text-orange-500', desc: "Quest Item: A molten core. The Order needs it for the Foundry; Rook needs it for the Bio-Reactor.", isContraband: true },
        "Nutrient Slurry": { name: "Nutrient Slurry", type: 'consumable', icon: 'fa-jar', color: 'text-green-500', btnText: "EAT", desc: "Consumable: Rendered Hyper-Coral paste. Tastes like ash and ambition. Restores 8 HP.", action: (state) => { if (state.currentHP >= state.maxHP) return "You are full."; const healAmount = 8; const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount); const idx = state.inventory.indexOf("Nutrient Slurry"); if (idx > -1) state.inventory.splice(idx, 1); return `Ate Slurry. Healed ${state.currentHP - oldHP} HP.`; } },
        "Royal Signet Ring": { name: "Royal Signet Ring", type: 'key', icon: 'fa-ring', color: 'text-blue-300', desc: "A silver ring bearing the crest of the Citadel. Proof of a guard's death.", btnText: "SELL", action: (state) => "Can be returned to the Citadel for a reward or sold." },
        "Volatile Mutagen": { name: "Volatile Mutagen", type: 'consumable', icon: 'fa-syringe', color: 'text-purple-500', btnText: "INJECT", desc: "A glowing syringe of experimental beast blood. Highly unstable. 50% chance to gain +2 Max HP, 50% chance to take massive Poison damage. Can be stabilized at a Forge.", isCombinable: true, action: (state) => { if (Math.random() > 0.5) { state.maxHP += 2; state.currentHP += 2; const idx = state.inventory.indexOf("Volatile Mutagen"); if (idx > -1) state.inventory.splice(idx, 1); return "Success! The mutagen rewrites your DNA. +2 Max HP."; } else { state.currentHP = window.applyDamage(state.currentHP, 6, 'poison'); const idx = state.inventory.indexOf("Volatile Mutagen"); if (idx > -1) state.inventory.splice(idx, 1); fxManager.flashRed(); return "Rejection! Your veins burn. Took 6 Poison Damage."; } } },
        "Stabilized Mutagen": { name: "Stabilized Mutagen", type: 'consumable', icon: 'fa-dna', color: 'text-emerald-400', btnText: "INJECT", desc: "Refined beast blood. Safe to use. Permanently increases Max HP by 3.", action: (state) => { state.maxHP += 3; state.currentHP += 3; const idx = state.inventory.indexOf("Stabilized Mutagen"); if (idx > -1) state.inventory.splice(idx, 1); return "Injected. +3 Max HP."; } },
        "Beast Whistle": { name: "Beast Whistle", type: 'key', icon: 'fa-dog', color: 'text-gray-400', desc: "A silver whistle used by Vampires to command their experiments. May allow you to bypass feral beasts." },
        "Sun-Star Grenade": { name: "Sun-Star Grenade", type: 'consumable', icon: 'fa-bomb', color: 'text-orange-400', btnText: "THROW", desc: "A volatile fusion of Flash Powder and Alchemical Fire. Deals 25 Damage AND Stuns the enemy (skips their next turn).", action: (state) => { if (!state.isBossCombat) return "Save this for a worthy foe."; state.enemyHP -= 25; return "<b>BOOM!</b> The grenade erupts with the heat of a star! Dealt 25 Damage and blinded the enemy!"; } },
        "Captain's Reserve": { name: "Captain's Reserve", type: 'consumable', icon: 'fa-flask', color: 'text-amber-600', btnText: "DRINK", desc: "Rum distilled with Vitality Tincture. Heals 25 HP and cures all status effects. Tastes like victory.", action: (state) => { const oldHP = state.currentHP; state.currentHP = Math.min(state.maxHP, state.currentHP + 25); const idx = state.inventory.indexOf("Captain's Reserve"); if (idx > -1) state.inventory.splice(idx, 1); return `Downed the Captain's Reserve. Healed ${state.currentHP - oldHP} HP. You feel invincible.`; } },
        "Snare Trap": { name: "Snare Trap", type: 'key', icon: 'fa-link', color: 'text-gray-400', desc: "A Beast Whistle rigged to a heavy Rope loop. Can be used to instantly capture/defeat a Beast enemy without rolling." },
        "Feeding Ground Map": { name: "Feeding Ground Map", type: 'key', icon: 'fa-map', color: 'text-indigo-400', desc: "A waterproof chart marked with the Leviathan's hunting patterns. Unlocks a high-risk loot location." },
        "Mirror Shield": { name: "Mirror Shield", type: 'gear', icon: 'fa-shield-alt', color: 'text-gray-200', desc: "Order Reward: A polished silver tower shield. Passive: -1 Damage taken. Active: Reflects the first attack of a round." },
        "Scale-Stake Driver": { name: "Scale-Stake Driver", type: 'weapon', icon: 'fa-crosshairs', color: 'text-orange-600', desc: "Chaos Reward: A heavy crossbow carved from Leviathan scale. Active: Deals damage and Stuns the enemy." },
        "Gilded Sextant": { name: "Gilded Sextant", type: 'passive', icon: 'fa-compass-drafting', color: 'text-yellow-400', desc: "Passive: An instrument of impossible precision. Reduces Supply cost of all sea travel by 1." },
        "Codex of Tides": { name: "Codex of Tides", type: 'passive', icon: 'fa-book-atlas', color: 'text-blue-300', desc: "Passive: Quinn's research notes. Grants Advantage (roll twice/bonus) on History & Investigation checks." },
        "Battle Rhythm": { name: "Battle Rhythm", type: 'passive', icon: 'fa-stopwatch', color: 'text-red-500', desc: "Status: You have sparred with Gareth. Your next combat attack deals Double Damage. (One use)." },
        "Deep-Iron Ingot": { name: "Deep-Iron Ingot", type: 'ingredient', icon: 'fa-cube', color: 'text-gray-400', desc: "A heavy bar of cold iron dredged from the abyss. Can be forged into a weapon." },
        "Deep-Forged Cutlass": { name: "Deep-Forged Cutlass", type: 'weapon', icon: 'fa-khanda', color: 'text-indigo-400', desc: "A Sword of Valor fused with Deep-Iron. Heavy, brutal, and unbreakable. Deals 1d10+2 Damage.", damage: '1d10+2' },
        "Brass Gears": { name: "Brass Gears", type: 'ingredient', icon: 'fa-cogs', color: 'text-amber-600', desc: "High-value scrap scavenged from the Manor walls. Can be sold or crafted.", btnText: "SELL", action: (state) => "Sell at a Quartermaster for coin, or use at the Forge." },
        "Grapple Hook": { name: "Grapple Hook", type: 'gear', icon: 'fa-anchor', color: 'text-gray-300', desc: "Passive: A climber's best friend. Automatically passes vertical Athletics checks." },
        "Skeleton Key": { name: "Skeleton Key", type: 'key', icon: 'fa-key', color: 'text-white', desc: "Key: A bone key that opens high-security lockboxes in Faction Hubs." },
    };
    window.itemRegistry = itemRegistry;


    // --- DREAMSCAPE & LEVEL UP LOGIC ---
    const dreamscapeConfig = {
        'act1_transition': {
            nextScene: 'lighthouse_morning',
            narrative: "The storm has passed, but the sea demands a price. The crew stands before you in the grey morning mist. They look to you for orders, but their eyes are hollow.",
            boons: {
                gareth: { title: "Violence of Action", effect: "Advantage on Round 1", desc: "Roll twice for attacks in the first round of combat." },
                quinn: { title: "Logistics Officer", effect: "Reveal Hidden Costs", desc: "See Time/Doom costs before making choices." },
                talon: { title: "Scavenger's Eye", effect: "+1 Shilling Found", desc: "Gain extra coin whenever you loot or sell." },
                bones: { title: "Triage Protocol", effect: "+2 Consumable Heal", desc: "Potions and food heal +2 additional HP." }
            }
        },
        'act2_transition': {
            nextScene: 'act2_arrival',
            narrative: "You drift between the material and the spectral. The Vanishing Manor awaits in the negative space of the world. Physics is breaking down; gravity is a suggestion. <span class='text-cyan-400'>Who will anchor you to reality?</span>",
            boons: {
                gareth: { title: "Iron Will", effect: "-2 Psychic Damage", desc: "Resistance to mental trauma and sanity checks." },
                quinn: { title: "Efficient Pathing", effect: "Free Safe Movement", desc: "0 Tether cost to move between safe rooms." },
                talon: { title: "Ghost Hunter", effect: "+2 Dmg vs Spectral", desc: "Bonus damage against Ethereal enemies." },
                bones: { title: "Spectral Metabolism", effect: "Regen 1 HP on Move", desc: "Heal 1 HP when entering a new room." }
            }
        },
        'act3_transition': {
            nextScene: 'act3_name_ship',
            narrative: "The Rift is closed, but the open sea is a battlefield. The factions are moving, and the water turns red with the Sanguine Tithe. <span class='text-cyan-400'>Choose your strength for the final war.</span>",
            boons: {
                gareth: { title: "Hold the Line", effect: "Death Defiance", desc: "Survive a lethal blow at 1 HP (Once per rest)." },
                quinn: { title: "Master Navigator", effect: "-1 Supply Cost", desc: "Sea travel costs 1 less Supply." },
                talon: { title: "Hunter's Mark", effect: "Crit Range 19-20", desc: "Critical hits land on rolls of 19 or 20." },
                bones: { title: "Alchemical Resistance", effect: "Resist Acid/Poison", desc: "Take half damage from Acid and Poison." }
            }
        }
    };
    let selectedDreamCrew = null;
    
    window.gameFunctions.startDreamscape = function(transitionType) {
        gameState.dreamTransitionPending = transitionType;
        const config = dreamscapeConfig[transitionType];
        
        // 1. Universal Level Up Mechanics
        gameState.maxHP += 5;
        gameState.currentHP = gameState.maxHP;
        gameState.baseDamage += 1;
        
        // 2. Conditional Die Upgrade (ONLY for Act 3)
        let dieHtml = ''; // Default: Empty string (Hidden)
        
        if (transitionType === 'act3_transition') {
            gameState.guidingDieSize = 6; // Upgrade to d6
            dieHtml = `<div class="flex items-center text-cyan-400 drop-shadow-md animate-pulse font-bold"><i class="fas fa-arrow-up mr-2"></i> Guiding Die (d6)</div>`;
        } else {
            gameState.guidingDieSize = gameState.guidingDieSize || 4; 
        }
        
        // 3. Setup UI
        document.getElementById('main-game-container').classList.add('dream-blur-active');
        const overlay = document.getElementById('dreamscape-overlay');
        overlay.classList.add('active');
        
        // 4. Update the Modal Header
        const modalHeader = overlay.querySelector('.p-4.md\\:p-6 .flex.flex-wrap');
        if (modalHeader) {
            modalHeader.innerHTML = `
                <div class="flex items-center text-purple-400 drop-shadow-md">
                    <i class="fas fa-arrow-up mr-2"></i> Level Up!
                </div>
                <div class="flex items-center text-emerald-400 drop-shadow-md">
                    <i class="fas fa-heart mr-2"></i> +5 Max HP
                </div>
                <div class="flex items-center text-red-400 drop-shadow-md">
                    <i class="fas fa-fist-raised mr-2"></i> +1 Base Dmg
                </div>
                ${dieHtml} `;
        }
        
        document.getElementById('dream-text-container').innerHTML = `"${config.narrative}"`;
        document.getElementById('btn-wake-up').classList.add('hidden');
        selectedDreamCrew = null;

        // 5. Render Cards
        const grid = document.getElementById('dream-card-grid');
        grid.innerHTML = '';
        
        const crews = [
            { id: 'gareth', icon: 'fa-anchor', role: 'Captain' },
            { id: 'quinn', icon: 'fa-scroll', role: 'Quartermaster' },
            { id: 'talon', icon: 'fa-eye', role: 'Scout' },
            { id: 'bones', icon: 'fa-flask', role: 'Surgeon' }
        ];

        crews.forEach(c => {
            const boon = config.boons[c.id];
            const card = document.createElement('div');
            card.className = `crew-card group`;
            card.id = `card-${c.id}`;
            card.onclick = () => window.gameFunctions.selectDreamCrew(c.id);
            
            card.innerHTML = `
                <div class="crew-card-inner">
                    <i class="fas ${c.icon}"></i>
                    <h4 class="text-cyan-100 font-cinzel font-bold text-lg mb-1 border-b border-cyan-500/30 pb-1 w-full">${c.id.charAt(0).toUpperCase() + c.id.slice(1)}</h4>
                    <p class="text-gray-400 text-xs italic mb-auto">${c.role} (+1 Skill)</p>
                    <div class="crew-boon-container">
                        <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-1">Boon: ${boon.title}</div>
                        <div class="text-sm text-white font-cinzel font-bold mb-1">${boon.effect}</div>
                        <div class="text-[10px] text-gray-400 leading-tight">${boon.desc}</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    };
    
    window.gameFunctions.selectDreamCrew = function(crewId) {
        selectedDreamCrew = crewId;
        document.querySelectorAll('.crew-card').forEach(c => c.classList.remove('selected'));
        document.getElementById(`card-${crewId}`).classList.add('selected');
        const btn = document.getElementById('btn-wake-up');
        btn.classList.remove('hidden');
        btn.innerText = `BOND WITH ${crewId.toUpperCase()}`;
    };

    window.gameFunctions.confirmDreamSelection = function() {
        if (!selectedDreamCrew) return;
        
        const transition = gameState.dreamTransitionPending;
        const config = dreamscapeConfig[transition];
        
        gameState.crewSkillBonuses[selectedDreamCrew] += 1;
        
        const boonMap = {
            'act1_transition': { gareth: 'violence_of_action', quinn: 'logistics', talon: 'scavenger', bones: 'triage' },
            'act2_transition': { gareth: 'iron_will', quinn: 'efficient_pathing', talon: 'ghost_hunter', bones: 'spectral_metabolism' },
            'act3_transition': { gareth: 'hold_the_line', quinn: 'master_navigator', talon: 'hunters_mark', bones: 'chemical_resist' }
        };
        
        const boonId = boonMap[transition][selectedDreamCrew];
        if (!gameState.activeBoons.includes(boonId)) {
            gameState.activeBoons.push(boonId);
        }

        document.getElementById('dreamscape-overlay').classList.remove('active');
        document.getElementById('main-game-container').classList.remove('dream-blur-active');
        
        if (boonId === 'logistics') gameState.quinnLogistics = true;
        if (boonId === 'violence_of_action') gameState.isSurpriseRound = true;

        renderScene(config.nextScene);
        saveGame();
    };


    // --- MARKET BLUEPRINTS (Global Definitions for all merchants) ---
    const MARKET_BUY_OPTIONS = [ { item: "Healing Potion", nextScene: 'buy_potion', cost: 5 }, { item: "Rope", nextScene: 'buy_rope', cost: 3 }, { item: "Torch", nextScene: 'buy_torch', cost: 2 }, { item: "Rum", nextScene: 'buy_rum', cost: 4 } ];
    const ALCHEMIST_BUY_OPTIONS = [ { item: "Vitality Tincture", nextScene: 'buy_tincture', cost: 15, doomCost: 0 }, { item: "Smelling Salts", nextScene: 'buy_salts', cost: 8, doomCost: 0 }, { item: "Flash Powder", nextScene: 'buy_powder', cost: 10, doomCost: 0 }, { item: "Alchemical Fire", nextScene: 'buy_fire', cost: 12, doomCost: 0 }, { item: "Holy Water", nextScene: 'buy_water', cost: 12, doomCost: 0 } ];
    const TAVERN_BUY_OPTIONS = [ { item: "Gruel", nextScene: 'buy_gruel_to_go', cost: 1 } ];
    const SHIP_SUPPLIES_OPTIONS = [ { item: "Supplies", cost: 10, amount: 5 }, { item: "Supplies", cost: 18, amount: 10 } ];
    const MARKET_SELL_OPTIONS = [ { item: "Curious Cargo", nextScene: 'sell_cargo', value: 10, doomCost: 1 }, { item: "Rope", nextScene: 'sell_rope', value: 2, doomCost: 0 }, { item: "Torch", nextScene: 'sell_torch', value: 1, doomCost: 0 }, { item: "Healing Potion", nextScene: 'sell_potion', value: 3, doomCost: 0 }, { item: "Rum", nextScene: 'sell_rum', value: 2, doomCost: 0 } ];
    const ALCHEMIST_SELL_OPTIONS = [ { item: "Silver Locket", nextScene: 'sell_locket_alch', value: 10, doomCost: 0 }, { item: "Alchemical Fire", nextScene: 'sell_fire', value: 20, doomCost: 0 }, { item: "Holy Water", nextScene: 'sell_water', value: 20, doomCost: 0 }, { item: "Vitality Tincture", nextScene: 'sell_tincture', value: 7, doomCost: 0 }, { item: "Healing Potion", nextScene: 'sell_potion_alch', value: 4, doomCost: 0 }, { item: "Pearlescent Mushroom", nextScene: 'sell_mushroom_alch', value: 12, doomCost: 0 } ];

    function combineItems(baseItem, ingredient, resultItem) {
        if (!gameState.inventory.includes(baseItem) || !gameState.inventory.includes(ingredient)) return "Error: Missing ingredients.";
        const bIdx = gameState.inventory.indexOf(baseItem); const iIdx = gameState.inventory.indexOf(ingredient);
        const baseDef = itemRegistry[baseItem]; if (baseDef && baseDef.onRemove) baseDef.onRemove(gameState);
        gameState.inventory.splice(Math.max(bIdx, iIdx), 1); gameState.inventory.splice(Math.min(bIdx, iIdx), 1);
        gameState.inventory.push(resultItem);
        const resDef = itemRegistry[resultItem]; if (resDef && resDef.onAcquire) resDef.onAcquire(gameState);
        saveGame(); updateUI();
        return `${baseItem} and ${ingredient} combined into <span class="text-item">${resDef.name}</span>!`;
    }


    // --- ENGINE: RENDER ---
    async function renderScene(sceneId, logText = true) {
        const scene = scenes[sceneId];
        
        if (!scene) { console.error("Missing scene:", sceneId); return; }
        
        if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
            renderScene('edward_death');
            return;
        }

        // --- 1. HANDLE RIFT COLLAPSE LOGIC ---
        if (gameState.doomTimer <= 0 && gameState.act1Started) {
            if (!gameState.isRiftCollapse && !gameState.hasLoggedCollapse) {
                gameState.isRiftCollapse = true;
                gameState.hasLoggedCollapse = true; 
                
                gameState.maxHP = Math.max(1, gameState.maxHP - 5);
                gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);
                
                addToHistory(`!!! RIFT COLLAPSE !!! The veil has ruptured. All Skill Check DCs are permanently increased by 2. Max HP reduced by 5 due to toxic air.`, 'system');
            }
        }
        
        // --- 2. HANDLE TETHER FAILURE ---
        if (gameState.tetherTimer <= 0 && gameState.act2Started && sceneId !== 'act2_tether_fail') {
             renderScene('act2_tether_fail');
             return;
        }
       
        // --- 3. HANDLE VISUAL THEMES ---
        if (gameState.isEthereal) {
            document.body.classList.add('plane-ethereal');
        } else {
            document.body.classList.remove('plane-ethereal');
        }
        
        // --- 4. HANDLE LOGIC/ROLL SCENES ---
        if (scene.isLogic) {
            let roll;
            let logMsg = "";

            if (gameState.pendingRoll) {
                roll = gameState.pendingRoll.total;
                logMsg = gameState.pendingRoll.log;
                gameState.pendingRoll = null;
            } else {
                // Fallback / Safety Roll
                roll = Math.floor(Math.random() * 20) + 1;
                let dc = gameState.isRiftCollapse ? (gameState.lastDC || 10) + 2 : (gameState.lastDC || 10);
                logMsg = `Check (DC ${dc}): Rolled d20 (${roll})`;
                
                // Apply Rift Penalty for manual rolls too
                if (gameState.isRiftCollapse) { 
                    roll = Math.max(1, roll - 2); 
                    logMsg += ` - 2 (Rift Penalty)`;
                }
            }

            const dcToCheck = gameState.lastDC || 10;
            const isSuccess = roll >= dcToCheck;
            
            const colorClass = isSuccess ? '!text-emerald-400' : '!text-red-400';
            addToHistory(`${logMsg} <span class="${colorClass}">= ${roll}</span>`, 'roll');
            
            const nextId = scene.resolve(roll, gameState); 
            saveGame();
            renderScene(nextId); 
            return;
        }

        gameState.currentSceneId = sceneId;
        fxManager.clearEffects(); 

        // --- 5. HANDLE VISUAL PULSE FX ---
        const isProloguePulse = ['prologue_storm', 'prologue_abyss'].includes(sceneId);
        const isAct1Pulse = gameState.act1Started && !gameState.isRiftCollapse && gameState.doomTimer > 0 &&
            ['town_square', 'lighthouse_vigil', 'smelter_stage1_start', 'chapel_stage1_reveal', 'town_docks', 'blackwater_tavern', 'alchemist_triage'].includes(sceneId);
        const isAct2Pulse = gameState.act2Started && sceneId !== 'act2_tether_fail';

        if (isProloguePulse || isAct1Pulse || isAct2Pulse) {
            document.getElementById('fx-overlay').classList.add('fx-rift-pulse');
        }
        if (gameState.isRiftCollapse) {
            document.getElementById('fx-overlay').classList.add('fx-rift-collapsed');
        }

        // --- 6. EXECUTE ONENTER ---
        if (scene.onEnter) {
            const msg = scene.onEnter(gameState);
            if (msg && logText) {
                addToHistory(msg, 'system');
            }
            saveGame();
        }
        
        // --- 7. TEXT & TITLE ---
        let displayTitle = scene.title;
        let displayText = scene.text;
        const isDeath = sceneId === 'edward_death';
        
        // --- 8. INJECT BOSS HEALTH BAR ---
        if (gameState.isBossCombat) {
            if (gameState.activeEnemies && gameState.activeEnemies.length > 0) {
                let hordeHPBar = '';
                let totalHP = 0;
                gameState.activeEnemies.forEach(elderName => {
                    const elderHP = gameState.enemies[elderName];
                    const pct = (elderHP / gameState.maxElderHP) * 100;
                    totalHP += elderHP;
                    hordeHPBar += `<div class="w-full bg-gray-900 border border-red-900 rounded h-4 mt-1 mb-1 relative overflow-hidden shadow-lg"><div class="bg-red-700 h-full transition-all duration-300" style="width: ${pct}%"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] cinzel font-bold text-white shadow-black drop-shadow-md tracking-widest">${elderName}: ${elderHP} / ${gameState.maxElderHP}</div></div>`;
                });
                const totalPct = (totalHP / gameState.maxEnemyHP) * 100;
                displayText = `<div class="w-full bg-gray-900 border border-red-500 rounded h-2 mb-3 relative overflow-hidden"><div class="bg-red-600 h-full transition-all duration-300" style="width: ${totalPct}%"></div></div><div class="text-xs text-red-400 cinzel mb-2">Horde Total HP: ${totalHP} / ${gameState.maxEnemyHP}</div>${hordeHPBar}` + displayText;
            }
            else if (gameState.enemyHP > 0) { 
                const pct = (gameState.enemyHP / gameState.maxEnemyHP) * 100;
                displayText = `<div class="w-full bg-gray-900 border border-red-900 rounded h-6 mt-2 mb-6 relative overflow-hidden shadow-lg"><div class="bg-red-700 h-full transition-all duration-300" style="width: ${pct}%"></div><div class="absolute inset-0 flex items-center justify-center text-xs cinzel font-bold text-white shadow-black drop-shadow-md tracking-widest">${gameState.currentEnemy}: ${gameState.enemyHP} / ${gameState.maxEnemyHP}</div></div>` + displayText;
            }
        }

        // --- 9. INJECT SHIP NAME (Act 3) ---
        if (sceneId === 'act3_intro_ship' || sceneId === 'sea_map_hub') {
            if (gameState.shipName) {
                displayTitle = gameState.shipName;
                displayText = displayText.replace('[SHIP_NAME]', gameState.shipName);
                displayText = displayText.replace('your ship', `the ${gameState.shipName}`);
            }
        }
        
        // --- 10. RENDER TO DOM ---
        const textEl = document.getElementById('main-scene-text');
        const isDeathScene = sceneId === 'edward_death';
        let titleClass = isDeathScene ? 'text-red-500' : 'text-amber-500';
        let textClass = isDeathScene ? 'text-red-300' : 'text-gray-300';
        
        let finalHtml = `<h2 class="2xl cinzel ${titleClass} mb-2">${displayTitle}</h2><p class="text-lg leading-relaxed ${textClass} fade-in">${displayText}</p>`;
        
        // Banter Typewriter Logic
        if (scene.banter) {
            Object.keys(scene.banter).forEach(crewId => {
                const crewMember = gameState.crew[crewId];
                if (crewMember && (!crewMember.used || gameState.crewUseFree)) {
                     finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in"><span class="font-bold text-xs uppercase block mb-1">${crewMember.name}:</span> <span id="banter-type-${crewId}"></span></div>`;
                }
            });
        }
        
        // Dynamic Banter Logic (Only for non-scripted scenes)
        const isScriptedScene = scene.banter || scene.isBoss || scene.isRest || scene.choices.some(c => c.type === 'skill');
        if (!isScriptedScene && !sceneId.startsWith('prologue') && gameState.act1Started) {
             const dynamicLine = getDynamicBanter();
             if (dynamicLine) {
                  finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in"><span class="font-bold text-xs uppercase block mb-1">${dynamicLine.name}:</span> <span id="banter-type-dynamic"></span></div>`;
             }
        }
        
        textEl.innerHTML = finalHtml;
        document.getElementById('scene-title').innerText = displayTitle;
        activeCrewMember = null; 

        // RENDER IMAGE
        const imgKey = sceneId || 'default';
        const imgUrl = sceneImages[imgKey] || sceneImages['default'];
        document.getElementById('scene-image').src = imgUrl; 
        document.getElementById('scene-image').style.opacity = 1;

        // Render Choices using the ROBUST logic
        renderChoices(scene.choices, isDeath);
        
        // --- PUZZLE & BANTER HOOKS ---
        if (sceneId === 'manor_cellar_puzzle') setTimeout(() => puzzleManager.initCircuit(), 100);
        if (sceneId === 'sea_fog_puzzle') setTimeout(() => puzzleManager.initCompass(), 100);

        if (scene.banter || isScriptedScene) {
            // Apply typewriter effect after DOM update
            if (scene.banter) {
                Object.keys(scene.banter).forEach(crewId => {
                    const targetId = `banter-type-${crewId}`;
                    const textToType = scene.banter[crewId];
                    // Delay typing for staggered effect
                    setTimeout(() => {
                        if(document.getElementById(targetId)) puzzleManager.typeBanter(targetId, textToType + '"');
                    }, 500); 
                });
            }
            if (dynamicLine) {
                setTimeout(() => {
                    if(document.getElementById('banter-type-dynamic')) puzzleManager.typeBanter('banter-type-dynamic', dynamicLine.line + '"');
                }, 500);
            }
        }
        
        // --- VIGNETTE FX ---
        const hpPct = (gameState.currentHP / gameState.maxHP) * 100;
        if (hpPct <= 30) fxManager.setVignette(true);
        else fxManager.setVignette(false);

        updateUI();
    }

    // --- RE-IMPLEMENTING ROBUST RENDER CHOICES ---
    function renderChoices(choices, isDeathScene) {
        const container = document.getElementById('choices-area');
        container.innerHTML = '';

        const currentSceneId = gameState.currentSceneId;
        const currentSceneStock = scenes[currentSceneId] ? scenes[currentSceneId].stock : {};
        const marketStock = scenes['market_stall'].stock;
        
        let processedChoices = [...choices]; 
        
        // Dynamic Injections (Restored full logic)
        if (currentSceneId === 'alchemist_triage' && gameState.inventory.includes('Strange Coin') && !gameState.inventory.includes('Phoenix Draft')) {
            const sellIndex = processedChoices.findIndex(c => c.nextScene === 'alchemist_sell');
            const newChoice = { text: "Offer Strange Coin (Trade for Phoenix Draft)", nextScene: 'alchemist_secret_stock', type: 'action', reqItem: 'Strange Coin', consume: true, doomCost: 0, customClass: 'btn-hero' };
            if (sellIndex !== -1) processedChoices.splice(sellIndex, 0, newChoice);
            else processedChoices.push(newChoice); 
        }
        // Market logic (simplified but kept dynamic)
        else if (currentSceneId === 'market_stall') {
            const sellWaresNav = choices.find(c => c.nextScene === 'market_sell');
            const isMainGame = gameState.act1Started || gameState.act2Started || gameState.act3Started;
            const returnTarget = isMainGame ? 'town_square' : 'market_crossroads';
            const leaveNav = { text: "Leave", nextScene: returnTarget, type: 'travel', doomCost: 0 };
            processedChoices = []; 
            MARKET_BUY_OPTIONS.forEach(sale => {
                const actualStock = currentSceneStock[sale.item] || 0;
                const itemDef = itemRegistry[sale.item];
                const isHealing = itemDef && (itemDef.name || '').includes('Heal') || (itemDef.name || '').includes('Rum');
                const isFull = gameState.currentHP >= gameState.maxHP;
                const canAfford = gameState.shillings >= sale.cost;
                if (actualStock > 0) processedChoices.push({ text: `Buy ${sale.item.split('(')[0].trim()}`, nextScene: sale.nextScene, type: 'action', cost: sale.cost, stockItem: sale.item, doomCost: 0, isDisabled: !canAfford || (isHealing && isFull) });
            });
            if (sellWaresNav) processedChoices.push(sellWaresNav);
            processedChoices.push(leaveNav);
        }
        // Selling logic
        else if (currentSceneId === 'market_sell') {
            const backToBuyNav = choices.find(c => c.nextScene === 'market_stall');
            const isMainGame = gameState.act1Started || gameState.act2Started || gameState.act3Started;
            const returnTarget = isMainGame ? 'town_square' : 'market_crossroads';
            const leaveNav = { text: "Stop Selling", nextScene: returnTarget, type: 'travel', doomCost: 0 };
            processedChoices = []; 
            MARKET_SELL_OPTIONS.forEach(sell => {
                if (gameState.inventory.includes(sell.item)) {
                    if (sell.item === 'Curious Cargo' && marketStock['Curious Cargo'] === 0 && !gameState.act3Started) return; 
                    processedChoices.push({ text: `Sell ${sell.item.split('(')[0].trim()}`, nextScene: sell.nextScene, type: 'action', reqItem: sell.item, value: sell.value, doomCost: sell.doomCost });
                }
            });
            if (backToBuyNav) processedChoices.push(backToBuyNav);
            processedChoices.push(leaveNav);
        } 
        // Alchemist Selling logic (needs to be full, as previous simplification was wrong)
        else if (currentSceneId === 'alchemist_sell') {
             const backToBuyNav = choices.find(c => c.nextScene === 'alchemist_triage');
             const returnNav = choices.find(c => c.nextScene === 'town_square');
             processedChoices = []; 
             ALCHEMIST_SELL_OPTIONS.forEach(sell => {
                 if (gameState.inventory.includes(sell.item)) {
                     let isDisabled = false;
                     // Prevent selling unique artifacts once set on a path
                     const isArtifactSell = sell.nextScene === 'sell_fire' || sell.nextScene === 'sell_water';
                     const hasRing = gameState.inventory.includes("Ring of Brass");
                     const hasSword = gameState.inventory.includes("Sword of Valor");
                     if (isArtifactSell && (hasRing || hasSword)) isDisabled = true;
                     
                     processedChoices.push({ text: `Sell ${sell.item.split('(')[0].trim()}`, nextScene: sell.nextScene, type: 'action', reqItem: sell.item, value: sell.value, doomCost: sell.doomCost, isDisabled: isDisabled });
                 }
             });
             if (backToBuyNav) processedChoices.push(backToBuyNav);
             if (returnNav) processedChoices.push(returnNav);
        } 
        else if (currentSceneId === 'spire_combat_loop') {
            processedChoices = scenes['spire_combat_loop'].choices;
        }

        // --- BUTTON GENERATION LOOP ---
        processedChoices.forEach(c => {
            // Requirements Logic
            if (c.reqItem && !gameState.inventory.includes(c.reqItem)) return;
            if (c.reqItems && Array.isArray(c.reqItems)) {
                if (!c.reqItems.every(item => gameState.inventory.includes(item))) return;
            }
            if (c.reqSmuggler && gameState.influence < c.reqSmuggler) return;
            if (c.reqGuard && gameState.influence > -c.reqGuard) return;
            if (c.reqNotItem && gameState.inventory.includes(c.reqNotItem)) return; 
            if (c.reqFlag && !gameState[c.reqFlag]) return;
            if (c.reqNotFlag && gameState[c.reqNotFlag]) return; 
            if (c.type === 'combine' && c.reqItems && c.reqItems.some(item => !gameState.inventory.includes(item))) return;

            const btn = document.createElement('button');
            
            // --- STYLING & ICONS ---
            let rawText = c.text;
            let icon = '<i class="fas fa-chevron-right text-gray-500 group-hover:text-amber-100"></i>';
            let content = `<span class="cinzel font-bold text-gray-300 group-hover:text-amber-100">${rawText}</span>`;
            let supplementalText = '';
            
            let isDisabled = false;
            let disabledClass = '';
            
            if (c.cost && gameState.shillings < c.cost) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
            if (c.suppliesCost && gameState.supplies < c.suppliesCost) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
            if (c.costHP !== undefined && gameState.currentHP <= c.costHP) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
            let disabledResult = c.isDisabled;
            if (typeof disabledResult === 'function') disabledResult = disabledResult(gameState);
            if (disabledResult) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
            
            if (c.type === 'combine' && isDisabled) { rawText = `${rawText} (Missing Item)`; }
            
            const isHeroButton = c.customClass && c.customClass.includes('btn-hero');
            const isSkillCheck = c.type === 'skill';
            const isTradeButton = c.cost || c.value || c.shillingGain;

            const alignmentClass = (isSkillCheck || isTradeButton || c.chaosGain || c.orderGain || c.costHP !== undefined || c.shillingGain || c.doomCost !== undefined || c.tetherCost !== undefined || c.suppliesCost !== undefined || c.reqFlag || c.type === 'combine') ? 'justify-start' : 'justify-between';
            let btnClass = "";
            
            if (isDeathScene) {
                btnClass = `btn-game w-full p-3 text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-red-900 border-red-700 hover:bg-red-800 hover:border-amber-500 text-white text-xl text-center`;
            } else if (c.customClass) {
                btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 ${c.customClass}`;
                if (c.customClass.includes('btn-success-glow')) icon = '<i class="fas fa-ear-listen text-gray-300"></i>';
                else if (c.customClass.includes('btn-keen-senses')) icon = '<i class="fas fa-eye text-purple-300"></i>';
                else if (c.customClass.includes('btn-lantern-glow')) icon = '<i class="fas fa-lightbulb text-yellow-300"></i>';
                else if (c.customClass.includes('btn-anchor')) icon = '<i class="fas fa-anchor text-cyan-300"></i>';
                else if (isHeroButton) icon = '<i class="fas fa-star hero-icon"></i>';
                else icon = '<i class="fas fa-chevron-right text-white"></i>';

            } else {
                btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-gray-800 border-gray-600 hover:border-amber-500 hover:bg-gray-750 text-gray-300 group`;
            }
            
            if (isDisabled) {
                btnClass += ` ${disabledClass}`;
                btn.disabled = true;
            }

            if (isTradeButton) icon = '<i class="fas fa-coins text-amber-500"></i>';
            if (c.type === 'reset') icon = '<i class="fas fa-sync-alt text-gray-400 group-hover:text-white"></i>';
            if (c.type === 'combine') icon = '<i class="fas fa-hammer text-yellow-500"></i>';

            if (isSkillCheck) {
                const displayDC = gameState.isRiftCollapse ? c.dc + 2 : c.dc;
                supplementalText += ` <span class="spectral-text-glow text-sm uppercase tracking-wider ml-2 mr-4">[${c.skill} DC ${displayDC}]</span>`;
                
                if (activeCrewMember) {
                    const hasBonus = getBonusForSkill(activeCrewMember, c.skill);
                    if (hasBonus) {
                        btnClass = btnClass.replace('border-gray-600', 'border-cyan-500 ring-1 ring-cyan-400');
                        const dieType = gameState.isEthereal ? '8' : (gameState.guidingDieSize || '4');
                        supplementalText += ` <span class="text-cyan-300 text-[12px] font-bold animate-pulse">+ 1d${dieType} (${activeCrewMember.name})</span>`;
                    }
                }
                icon = '<i class="fas fa-dice-d20 spectral-text-glow"></i>';
            }

            btn.className = btnClass;

            let indicators = [];
            if (c.cost) indicators.push({ text: `-${c.cost}s`, color: 'text-amber-500' });
            else if (c.value) indicators.push({ text: `+${c.value}s`, color: 'text-amber-500' });
            else if (c.shillingGain) indicators.push({ text: `+${c.shillingGain}s`, color: 'text-amber-500' });
            if (c.suppliesCost) { indicators.push({ text: `-${c.suppliesCost} Supplies`, color: 'text-indigo-400' }); }
            if (c.costHP !== undefined) indicators.push({ text: `-${c.costHP} HP`, color: 'text-red-400' });
            if (c.chaosGain) indicators.push({ text: `+${c.chaosGain} Chaos`, color: 'text-emerald-400' });
            else if (c.orderGain) indicators.push({ text: `+${c.orderGain} Order`, color: 'text-blue-400' });
            
            const hasLogistics = gameState.quinnLogistics || gameState.activeBoons.includes('logistics');
            const isStandardAct1Scene = gameState.act1Started && !scenes[currentSceneId].isBoss && !scenes[currentSceneId].isRest;

            if (gameState.act1Started && hasLogistics && isStandardAct1Scene) {
                const hasExplicitCost = c.doomCost !== undefined;
                const cost = hasExplicitCost ? c.doomCost : (isStandardAct1Scene ? 1 : 0);
                if (cost >= 0 && c.type !== 'reset' && c.nextScene !== 'lighthouse_vigil') {
                    if (cost > 0) indicators.push({ text: `-${cost} Time`, color: 'text-purple-400' }); 
                    else if (cost === 0 && (hasExplicitCost || c.type === 'travel')) indicators.push({ text: `0 Time`, color: 'text-purple-400' });
                }
            } 
            else if (gameState.act2Started) {
                const hasExplicitCost = c.tetherCost !== undefined;
                let cost = hasExplicitCost ? c.tetherCost : (scenes[currentSceneId].isBoss || scenes[currentSceneId].isRest ? 0 : 1);
                if (gameState.activeBoons.includes('efficient_pathing') && cost === 1 && !hasExplicitCost) { cost = 0; }
                if (cost >= 0 && c.type !== 'reset') {
                    if (cost > 0) indicators.push({ text: `-${cost} Turns`, color: 'text-cyan-400' }); 
                    else if (cost === 0 && (hasExplicitCost || gameState.activeBoons.includes('efficient_pathing'))) { indicators.push({ text: `0 Turns`, color: 'text-cyan-400' }); }
                }
            }
            
            let indicatorString = '';
            indicators.forEach(ind => { indicatorString += ` <span class="${ind.color} text-sm ml-1">(${ind.text})</span>`; });
            
            if (supplementalText) content += supplementalText;
            if (indicatorString) btn.innerHTML = `<div class="btn-content-wrapper ${alignmentClass}">${content} ${indicatorString} <span class="ml-auto">${icon}</span></div>`;
            else btn.innerHTML = `${content} <span class="ml-auto">${icon}</span>`;

            // --- CLICK HANDLERS (Same as stable version) ---
            if (c.type === 'hold') {
                let holdTimer = null;
                const duration = 3000;
                btn.style.setProperty('--channel-duration', `${duration}ms`);

                const startChannel = (e) => {
                    if (e.type === 'touchstart') e.preventDefault(); 
                    if (btn.disabled) return;
                    btn.classList.add('channeling');
                    holdTimer = setTimeout(async () => {
                        fxManager.setVignette(false); 
                        fxManager.clearEffects();     
                        if (c.nextScene === 'act2_arrival') {
                            gameState.isEthereal = true; 
                            document.body.classList.add('plane-ethereal'); 
                            await saveGame(); 
                        }
                        renderScene(c.nextScene);
                    }, duration);
                };
                const cancelChannel = (e) => {
                    if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
                    btn.classList.remove('channeling');
                };
                btn.addEventListener('mousedown', startChannel);
                btn.addEventListener('mouseup', cancelChannel);
                btn.addEventListener('mouseleave', cancelChannel);
                btn.addEventListener('touchstart', startChannel);
                btn.addEventListener('touchend', cancelChannel);
                btn.onclick = null; 
            } 
            else {
                btn.onclick = (e) => {
                    if (btn.disabled) { audioManager.playClick(); return; }

                    if (c.type === 'skill') {
                        const allBtns = document.querySelectorAll('.btn-game');
                        allBtns.forEach(b => b.disabled = true);
                        audioManager.playDice();

                        btn.classList.add('fx-skill-active'); 

                        let roll = Math.floor(Math.random() * 20) + 1;
                        let logMsg = `Check (DC ${gameState.isRiftCollapse ? c.dc + 2 : c.dc}): Rolled d20 (${roll})`;
                        
                        gameState.lastSkillType = c.skill;
                        gameState.lastDC = gameState.isRiftCollapse ? c.dc + 2 : c.dc;
                        gameState.lastCrewUsedId = null;

                        if (c.skill === 'Intimidation' && gameState.inventory.includes("Captain's Tricorn")) {
                            roll += 1; logMsg += ` + 1 (Tricorn)`;
                        }

                        if (activeCrewMember) {
                            const isSkilled = getBonusForSkill(activeCrewMember, c.skill);
                            const crewKey = activeCrewMember.id;
                            if (isSkilled) { 
                                const dieSize = gameState.isEthereal ? 8 : (gameState.guidingDieSize || 4); 
                                const bonus = Math.floor(Math.random() * dieSize) + 1;
                                roll += bonus;
                                const dieLabel = gameState.isEthereal ? `(Spectral D8!)` : `(${activeCrewMember.name})`;
                                logMsg += ` + ${bonus} ${dieLabel}`; 
                                
                                if (gameState.crewUseFree) {
                                    addToHistory(`*Mushroom consumed for FREE GUIDANCE.*`, 'system');
                                    gameState.crewUseFree = false;
                                } else {
                                    gameState.crew[crewKey].used = true;
                                }
                                if (roll >= gameState.lastDC) gameState.lastCrewUsedId = crewKey;
                            } else {
                                logMsg += ` + 0 (${activeCrewMember.name} - Invalid Skill)`;
                            }
                            activeCrewMember = null;
                        }

                        if (gameState.isRiftCollapse) { roll = Math.max(1, roll - 2); logMsg += ` - 2 (Rift Penalty)`; }

                        const isSuccess = roll >= gameState.lastDC;

                        setTimeout(() => {
                            btn.classList.remove('fx-skill-active');
                            if (isSuccess) {
                                audioManager.playSuccess();
                                btn.classList.add('fx-skill-success');
                            } else {
                                audioManager.playFail();
                                btn.classList.add('fx-skill-fail');
                            }

                            setTimeout(() => {
                                gameState.pendingRoll = { total: roll, log: logMsg };
                                renderScene(c.nextScene);
                            }, 600);
                        }, 800);
                        return; 
                    }

                    // STANDARD LOGIC & FX
                    let fxClass = null;
                    let fxDuration = 0;

                    if (c.customClass) {
                        if (c.customClass.includes('btn-fire-glow')) { fxClass = 'fx-burn-active'; fxDuration = 1800; }
                        else if (c.customClass.includes('btn-shadow-glow')) { fxClass = 'fx-mist-active'; fxDuration = 1800; }
                        else if (c.customClass.includes('btn-hero')) { fxClass = 'fx-hero-active'; fxDuration = 1200; }
                        else if (c.customClass.includes('btn-planewalk-reveal')) { fxClass = 'fx-glitch-active'; fxDuration = 1200; }
                        else if (c.customClass.includes('btn-anchor')) { fxClass = 'fx-sail-active'; fxDuration = 1500; }
                    }

                    const executeAction = () => {
                        if (c.nextScene === 'manor_map_view') {
                            gameState.returnSceneId = gameState.currentSceneId; 
                            renderScene('manor_map_view');
                            return;
                        }

                        if (c.cost || c.value || c.shillingGain) audioManager.playCoins();
                        
                        if (c.type === 'combine') { const result = combineItems(c.reqItems[0], c.reqItems[1], c.nextScene); if (result) addToHistory(result, 'system'); renderScene(c.nextScene); return; }
                        if (c.type === 'reset') { resetGame(); return; }
                        if (c.action && typeof c.action === 'function') {
                            const result = c.action(gameState);
                            if (result) addToHistory(result, 'system');
                            if (c.nextScene) renderScene(c.nextScene); else updateUI();
                            return; 
                        }

                        if (c.type === 'action' && (currentSceneId === 'market_stall' || currentSceneId === 'alchemist_triage' || currentSceneId === 'blackwater_tavern') && c.stockItem) {
                            scenes[currentSceneId].stock[c.stockItem] = Math.max(0, scenes[currentSceneId].stock[c.stockItem] - 1);
                        }
                        
                        if (c.consume && c.reqItem) { const idx = gameState.inventory.indexOf(c.reqItem); if (idx > -1) { gameState.inventory.splice(idx, 1); addToHistory(`${c.reqItem} consumed.`, 'system'); } }
                        if (c.consumeItems && Array.isArray(c.consumeItems)) { c.consumeItems.forEach(itemToConsume => { const idx = gameState.inventory.indexOf(itemToConsume); if (idx > -1) { gameState.inventory.splice(idx, 1); addToHistory(`${itemToConsume} consumed.`, 'system'); } }); }

                        if (c.cost) gameState.shillings -= c.cost;
                        if (c.costHP !== undefined) gameState.currentHP = applyDamage(gameState.currentHP, c.costHP);

                        let extraGold = 0;
                        if (gameState.inventory.includes("Salt-Warped Spyglass") && gameState.influence >= 15) { extraGold = 1; addToHistory("Passive (Privateer's Lens): Found +1 extra Shilling.", 'system'); }
                        if (gameState.activeBoons.includes('scavenger')) { extraGold += 1; addToHistory("Scavenger's Eye: Found +1 extra Shilling.", 'system'); }
                        
                        if (c.shillingGain || c.value) {
                            if (c.shillingGain) gameState.shillings += (c.shillingGain + extraGold);
                            if (c.value) gameState.shillings += (c.value + extraGold);
                        }
                        
                        if (c.chaosGain) gameState.influence = Math.min(50, gameState.influence + c.chaosGain);
                        if (c.orderGain) gameState.influence = Math.max(-50, gameState.influence - c.orderGain); 
                        
                        if (gameState.act1Started && c.doomCost !== 0) {
                            const cost = c.doomCost !== undefined ? c.doomCost : 1; 
                            gameState.doomTimer = Math.max(0, gameState.doomTimer - cost);
                            if (gameState.doomTimer > 0) addToHistory(`Rift Stability: ${gameState.doomTimer} turns remaining.`, 'system');
                        }

                        if (gameState.act2Started) {
                            const hasExplicitCost = c.tetherCost !== undefined;
                            let cost = hasExplicitCost ? c.tetherCost : (scenes[currentSceneId].isBoss || scenes[currentSceneId].isRest ? 0 : 1);
                            if (gameState.activeBoons.includes('efficient_pathing') && cost === 1 && !hasExplicitCost) { cost = 0; }
                            if (cost > 0) gameState.tetherTimer = Math.max(0, gameState.tetherTimer - cost);
                            if (gameState.activeBoons.includes('spectral_metabolism') && c.type === 'travel' && c.nextScene !== currentSceneId) { gameState.currentHP = Math.min(gameState.maxHP, gameState.currentHP + 1); addToHistory("Spectral Metabolism: Healed 1 HP.", 'system'); }
                        }
                        
                        if (scenes[gameState.currentSceneId].journal) addToHistory(scenes[gameState.currentSceneId].journal, 'entry');

                        renderScene(c.nextScene);
                    };

                    if (fxClass && !isDeathScene) {
                        const allBtns = document.querySelectorAll('.btn-game');
                        allBtns.forEach(b => b.disabled = true);
                        btn.classList.add(fxClass);
                        setTimeout(() => { executeAction(); }, fxDuration);
                    } else {
                        executeAction();
                    }
                };
            }
            container.appendChild(btn);
        });
    }

    function updateUI() {
        const state = window.gameState || gameState;
        const statsPanel = document.getElementById('stats-panel');
        const journalContainer = document.getElementById('journal-container');
        
        // 1. Prologue/Journal Visibility FIX
        const sceneId = gameState.currentSceneId;
        const isPrologueScene = sceneId && (sceneId.startsWith('prologue') || sceneId === 'start');
        
        if (isPrologueScene) {
            statsPanel.classList.add('prologue-blur');
            statsPanel.classList.remove('prologue-active');
            journalContainer.classList.add('log-hidden');
            journalContainer.classList.remove('log-visible');
        } else {
            statsPanel.classList.remove('prologue-blur');
            statsPanel.classList.add('prologue-active');
            
            if(gameState.inventory.includes("Ship's Log")) {
                journalContainer.classList.remove('log-hidden');
                journalContainer.classList.add('log-visible');
            } else {
                journalContainer.classList.add('log-hidden');
                journalContainer.classList.remove('log-visible');
            }
        }
        
        // 2. HP Bar
        const displayMaxHP = gameState.maxHP;
        const hpToDisplay = gameState.currentHP;
        const hpPct = (hpToDisplay / displayMaxHP) * 100;
        const bar = document.getElementById('hp-bar');
        bar.style.width = `${Math.min(100, hpPct)}%`;
        bar.className = `h-full transition-all duration-500 ${hpToDisplay < (displayMaxHP * 0.3) ? 'bg-red-600 animate-pulse' : 'bg-red-800'}`;
        document.getElementById('hp-text').innerText = `${hpToDisplay}/${displayMaxHP}`; 
        audioManager.checkVulnerable(gameState.currentHP, gameState.maxHP);

        // 3. Meters (Doom/Tether)
        const doomDisplay = document.getElementById('doom-counter-display');
        const tetherDisplay = document.getElementById('tether-display');
        if (gameState.act1Started && !gameState.act2Started && !gameState.act3Started) { doomDisplay.classList.remove('hidden'); document.getElementById('doom-timer-text').textContent = `${gameState.doomTimer} Turns`; document.getElementById('doom-bar').style.width = `${(gameState.doomTimer / 20) * 100}%`; } else { doomDisplay.classList.add('hidden'); }
        if (gameState.act2Started) { tetherDisplay.classList.remove('hidden'); document.getElementById('tether-text').textContent = `${gameState.tetherTimer} Turns`; document.getElementById('tether-bar').style.width = `${(gameState.tetherTimer / 20) * 100}%`; } else { tetherDisplay.classList.add('hidden'); }
        
        // 4. Influence Marker
        const inf = gameState.influence || 0;
        const pct = ((inf + 50) / 100) * 100;
        const marker = document.getElementById('inf-marker');
        if (marker) marker.style.left = `${Math.max(0, Math.min(100, pct))}%`;
        const infText = document.getElementById('inf-status-text');
        if (infText) {
            if (inf <= -30) infText.textContent = "Sworn to the Crown";
            else if (inf <= -15) infText.textContent = "Watchman";
            else if (inf >= 30) infText.textContent = "Pirate Lord";
            else if (inf >= 15) infText.textContent = "Privateer";
            else infText.textContent = "Neutral";
        }

        // 5. Radial Crew (FIX: Ensures crew names/skills use breaks for proper layout)
        renderRadialCrew();
        
        // 6. Companion and Planar Skill Visibility
        const isSilasJoined = gameState.companions.silas.joined;
        const isBlinkJoined = gameState.companions.blink.joined;
        const hasPlaneWalk = gameState.skills.includes("Plane Walking");
        const companionPanel = document.getElementById('companion-panel');
        const planarContainer = document.getElementById('planar-skills-container');
        const abilitiesWrapper = document.getElementById('abilities-combined-container'); 
        
        if (isSilasJoined || isBlinkJoined) { 
            companionPanel.classList.remove('hidden');
            renderCompanions(isSilasJoined, isBlinkJoined);
        } else { companionPanel.classList.add('hidden'); }

        if (hasPlaneWalk) planarContainer.classList.remove('hidden');
        else planarContainer.classList.add('hidden');

        if ((isSilasJoined || isBlinkJoined) || hasPlaneWalk) {
            abilitiesWrapper.classList.remove('hidden');
            abilitiesWrapper.classList.add('grid');
        } else {
            abilitiesWrapper.classList.add('hidden');
            abilitiesWrapper.classList.remove('grid');
        }

        // 7. Backpack & Supplies
        document.getElementById('shillings-display').innerText = gameState.shillings;
        const packDisplay = document.getElementById('pack-resources-display');
        if (packDisplay) {
            let html = `<span class="text-amber-500">${gameState.shillings} <i class="fas fa-coins text-[10px]"></i></span>`;
            if (gameState.act3Started) { 
                 html += `<span class="text-indigo-400 ml-2">${gameState.supplies} <i class="fas fa-anchor text-[10px]"></i></span>`;
            }
            packDisplay.innerHTML = html;
        }

        const suppliesDisplay = document.getElementById('supplies-display');
        if (gameState.act3Started) {
            suppliesDisplay.classList.remove('hidden');
            document.getElementById('supplies-count').innerText = gameState.supplies;
        } else { suppliesDisplay.classList.add('hidden'); }

        renderInventoryList();
    }
    
    // --- UTILITY/HELPER FUNCTIONS (RESTORED FROM STABLE) ---

    function renderCompanions(silas, blink) {
        const list = document.getElementById('companions-list');
        list.innerHTML = '';
        
        const createRow = (name, role, icon, color) => {
            const div = document.createElement('div');
            div.className = "p-2 bg-gray-900 border border-gray-700/50 rounded flex items-center justify-between";
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${icon} text-lg ${color}"></i>
                    <div>
                        <span class="font-bold text-xs cinzel ${color.replace('text-','text-')}-200 block">${name}</span>
                        <span class="text-[9px] text-gray-500 uppercase tracking-wider block">${role}</span>
                    </div>
                </div>
            `;
            return div;
        };

        if(silas) list.appendChild(createRow('Silas', 'Seneschal', 'fa-moon', 'text-emerald-400'));
        if(blink) list.appendChild(createRow('Blink', 'Phase-Cub', 'fa-paw', 'text-purple-400'));
    }

    function renderInventoryList() {
        const invContainer = document.getElementById('inventory-panel');
        invContainer.innerHTML = '';
        
        if (gameState.inventory.length === 0) {
            invContainer.innerHTML = '<div class="text-center text-[10px] text-gray-600 italic py-2">Inventory Empty</div>';
            return;
        }

        const descArea = document.getElementById('item-desc-area');
        const defaultText = "Hover to inspect.";

        gameState.inventory.forEach(itemName => {
            const itemDef = itemRegistry[itemName] || { icon: 'fa-box', color: 'text-gray-500', desc: "Unknown item." };
            const el = document.createElement('div');
            el.className = "group w-full flex items-center justify-between p-2 rounded border border-gray-700/50 bg-gray-900/60 hover:bg-gray-800 transition-all cursor-default relative shrink-0";
            
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-lg w-5 text-center ${itemDef.color}"><i class="fas ${itemDef.icon}"></i></div>
                    <span class="text-xs cinzel text-gray-300 group-hover:text-gray-100">${itemName.split('(')[0]}</span>
                </div>
            `;
            
            // Add Use Button if Consumable
            if(itemDef.type === 'consumable' && itemDef.btnText) {
                 const btn = document.createElement('button');
                 btn.className = "px-2 py-1 bg-emerald-900/40 border border-emerald-600/30 text-emerald-500 text-[9px] font-bold rounded hover:bg-emerald-600 hover:text-white transition-all tracking-wider";
                 btn.innerText = itemDef.btnText;
                 btn.onclick = (e) => {
                     e.stopPropagation();
                     audioManager.playClick();
                     const res = itemDef.action(gameState);
                     addToHistory(res, 'system');
                     updateUI();
                 };
                 el.appendChild(btn);
            }

            el.onmouseenter = () => {
                descArea.innerText = itemDef.desc || defaultText;
                descArea.classList.add('text-amber-400');
            };
            el.onmouseleave = () => {
                descArea.innerText = defaultText;
                descArea.classList.remove('text-amber-400');
            };
            invContainer.appendChild(el);
        });
    }

    function renderRadialCrew() {
        const container = document.querySelector('.radial-container');
        if (!container) return; 

        const crewKeys = ['gareth', 'quinn', 'talon', 'bones']; 
        
        // 1. INITIAL BUILD (Check if nodes exist and rebuild if necessary)
        if (!document.getElementById('node-gareth')) { 
            // Rebuild all layers if the base nodes are missing (e.g., after a full state reset/load)
            container.innerHTML = `
                <div class="radial-grid-mask">
                    <div class="radial-planar-grid"></div>
                </div>
                <div id="tether-gareth" class="spectral-tether tether-nw"></div>
                <div id="tether-quinn" class="spectral-tether tether-ne"></div>
                <div id="tether-talon" class="spectral-tether tether-sw"></div>
                <div id="tether-bones" class="spectral-tether tether-se"></div>
                <div id="radial-hub" class="radial-hub">
                    <div class="cinzel font-bold text-cyan-200 text-xs leading-tight text-center mt-2">GUIDING<br>VOICE</div>
                    <div class="text-cyan-400 text-xs mt-0.5 font-bold animate-pulse tracking-widest">+1d${gameState.guidingDieSize || 4}</div>
                </div>
            `;
            
            crewKeys.forEach((key, idx) => {
                const btn = document.createElement('div');
                btn.id = `node-${key}`; 
                btn.className = 'crew-node';
                
                if (idx === 0) btn.classList.add('node-nw'); 
                else if (idx === 1) btn.classList.add('node-ne');
                else if (idx === 2) btn.classList.add('node-sw'); 
                else if (idx === 3) btn.classList.add('node-se');
                
                btn.onclick = () => {
                    const currentCrew = gameState.crew[key];
                    if (currentCrew.used && !gameState.crewUseFree) return;
                    toggleCrewSelection(key); 
                };
                container.appendChild(btn);
            });
        }

        // 2. STATE UPDATE
        const hub = document.getElementById('radial-hub');
        const isAnyActive = activeCrewMember !== null;
        if(hub) {
            if(isAnyActive) hub.classList.add('drained');
            else hub.classList.remove('drained');
            hub.querySelector('.tracking-widest').innerHTML = `+1d${gameState.guidingDieSize || 4}`;
        }


        crewKeys.forEach(key => {
            const c = gameState.crew[key]; 
            const btn = document.getElementById(`node-${key}`);
            const tether = document.getElementById(`tether-${key}`);
            
            if (!btn || !tether) return;

            const isUsed = c.used;
            const isActive = activeCrewMember && activeCrewMember.id === c.id;

            let displayName = c.name;
            if(c.name.includes(' ')) displayName = c.name.split(' ')[0]; 
            if(key === 'gareth') displayName = "Gareth"; 
            
            let content = `<span class="crew-node-name">${displayName}</span><span class="crew-node-skill">${c.skill.replace('&', '<br>&')}</span>`;
            
            if(isUsed && !gameState.crewUseFree) content += `<i class="fas fa-lock absolute top-1 right-1 text-xs text-gray-500"></i>`;
            if(gameState.crewUseFree && !isUsed) content += `<i class="fas fa-star absolute top-1 right-1 text-xs text-purple-400 animate-pulse"></i>`;
            
            btn.innerHTML = content;

            if (isActive) {
                btn.classList.add('charged');
                tether.classList.add('flowing');
            } else {
                btn.classList.remove('charged');
                tether.classList.remove('flowing');
            }

            if (isUsed && !gameState.crewUseFree) {
                btn.classList.add('used');
            } else {
                btn.classList.remove('used');
            }
        });
    }

    function toggleCrewSelection(crewKey) {
        const c = gameState.crew[crewKey];
        if (activeCrewMember && activeCrewMember.id === c.id) {
            activeCrewMember = null; // Deselect
            audioManager.playClick();
        } else {
            activeCrewMember = c; // Select
            audioManager.playGhost();
        }
        updateUI();
        // Re-render choices to update button borders/text
        renderChoices(scenes[gameState.currentSceneId].choices, false); 
    }

    function scrollToBottom() {
		const area = document.getElementById('journal-scroll-area');
		requestAnimationFrame(() => {
			area.scrollTop = area.scrollHeight;
		});
	}

    function rebuildJournal() {
        const container = document.getElementById('journal-content');
        container.innerHTML = gameState.history.join('');
        scrollToBottom();
    }
    
    // Journal History function (re-added to work correctly)
    function addToHistory(text, type = 'entry') {
        let html = '';
        const journalContainer = document.getElementById('journal-container');

        // Logic to insert the full style, including keyword highlighting
        if (type === 'entry') {
            const keywords = /(Captain Gareth|Quinn|Talon|Bones|Silas|Wolf King|Ring of Brass|Sword of Valor|Smelter|Chapel|Sanguine Spire|Bleak Dogtooth|Vampire|Iron Lung|Absorb Elements|Primeval Awareness|Phoenix Draft|Manor Blueprint|Spectral Lantern|The Warding Ember|Mimic's Bile|Mind-Expanding Grog|Radiant-Washed Sword of Valor|Acid-Etched Sword of Valor|Rift Core Fragment)/g;
            const processedText = text.replace(keywords, '<span class="spectral-text-glow">$1</span>');
            html = `<div class="journal-font pb-4 border-b border-gray-700/30 text-gray-400 fade-in">${processedText}</div>`;
        } else if (type === 'system') {
            html = `<div class="text-xs text-amber-500 font-mono mb-2 fade-in">> ${text}</div>`;
        } else if (type === 'roll') {
            // Updated to spectral-text-glow for better roll visibility
            html = `<div class="text-xs spectral-text-glow font-bold mb-2 fade-in font-serif">${text}</div>`;
        } else if (type === 'danger') {
            html = `<div class="text-xs text-red-400 font-bold mb-2 fade-in font-serif">${text}</div>`;
        }
        if (type === 'combat') {
            html = `<div class="text-xs text-red-100 border-l-2 border-red-600 pl-2 mb-2 font-mono bg-red-900/20 p-2 shadow-inner fade-in">${text}</div>`;
        }

        if(html) gameState.history.push(html);
        if(journalContainer) {
             rebuildJournal();
        }
    }


    // --- FIREBASE AND INITIALIZATION ---
    async function init() {
        window.confirmReset = confirmReset;
        window.resetGame = resetGame; 
        
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                // FIX: Ensure Firebase is awaited before proceeding with load/render
                await setupRealtimeListener();
                
                document.getElementById('app-loading').classList.add('fade-out');
                setTimeout(() => {
                    const el = document.getElementById('app-loading');
                    if(el) el.remove();
                }, 500);
            }
        });

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    async function setupRealtimeListener() {
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
        
        try {
            const snap = await getDoc(docRef);
            if (!snap.exists()) {
                // Initialize Stocks on first run
                scenes['market_stall'].stock = { "Healing Potion": 1, "Rope": 1, "Torch": 1, "Curious Cargo": 1, "Rum": 0 };
                scenes['alchemist_triage'].stock = { "Vitality Tincture": 2, "Smelling Salts": 3, "Flash Powder": 1, "Alchemical Fire": 1, "Holy Water": 1 };
                scenes['blackwater_tavern'].stock = { "Gruel": 5 };

                const safeState = JSON.parse(JSON.stringify(gameState));
                safeState.market_stall_stock = scenes['market_stall'].stock;
                safeState.alchemist_triage_stock = scenes['alchemist_triage'].stock;
                safeState.blackwater_tavern_stock = scenes['blackwater_tavern'].stock;

                await setDoc(docRef, safeState);
                renderScene('prologue_storm');
            } else {
                const data = snap.data();
                
                const savedState = { ...createInitialState(), ...data }; 
                gameState = savedState;
                
                // Restore Stock
                if (data.market_stall_stock) scenes['market_stall'].stock = data.market_stall_stock;
                if (data.alchemist_triage_stock) scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                if (data.blackwater_tavern_stock) scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;

                if (gameState.isEthereal) document.body.classList.add('plane-ethereal');
                
                renderScene(gameState.currentSceneId, false);
                rebuildJournal(); // Restore history view
            }
        } catch (e) {
            console.error("Load error", e);
            renderScene('prologue_storm');
        }

        onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                if (JSON.stringify(data) !== JSON.stringify(gameState)) {
                    // Update stocks in memory before updating gameState
                    if (data.market_stall_stock) scenes['market_stall'].stock = data.market_stall_stock;
                    if (data.alchemist_triage_stock) scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                    if (data.blackwater_tavern_stock) scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;
                    
                    gameState = { ...gameState, ...data };
                    
                    if (gameState.isEthereal) document.body.classList.add('plane-ethereal');
                    else document.body.classList.remove('plane-ethereal');
                    
                    updateUI(); // Only update UI, renderScene is for navigation/logic
                }
            }
        });
    }

    async function saveGame() {
        if (!user) return;
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
        const safeState = JSON.parse(JSON.stringify(gameState));
        
        // Save current stock levels
        safeState.market_stall_stock = scenes['market_stall'].stock;
        safeState.alchemist_triage_stock = scenes['alchemist_triage'].stock;
        safeState.blackwater_tavern_stock = scenes['blackwater_tavern'].stock;

        await setDoc(docRef, safeState);
    }

    let resetConfirmTimer = null;
    function confirmReset() {
        const btn = document.getElementById('reset-game-btn');
        if (btn.classList.contains('bg-red-900')) {
            resetGame();
            clearTimeout(resetConfirmTimer);
            btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
            btn.classList.remove('bg-red-900', 'text-white');
            btn.classList.add('text-red-400', 'bg-black/60');
        } else {
            btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Confirm?';
            btn.classList.remove('text-red-400', 'bg-black/60');
            btn.classList.add('bg-red-900', 'text-white');
            resetConfirmTimer = setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                btn.classList.remove('bg-red-900', 'text-white');
                btn.classList.add('text-red-400', 'bg-black/60');
            }, 3000);
        }
    }

    async function resetGame() {
        gameState = createInitialState();
        
        // Reset Stocks
        scenes['market_stall'].stock = { "Healing Potion": 1, "Rope": 1, "Torch": 1, "Curious Cargo": 1, "Rum": 0 };
        scenes['alchemist_triage'].stock = { "Vitality Tincture": 2, "Smelling Salts": 3, "Flash Powder": 1, "Alchemical Fire": 1, "Holy Water": 1 };
        scenes['blackwater_tavern'].stock = { "Gruel": 5 };
        
        const workBtn = scenes['town_docks'].choices.find(c => c.nextScene === 'docks_work');
        if (workBtn) workBtn.costHP = 2; 
        
        // Reset core flags
        gameState.isAbsorbCharged = false;
        gameState.isSurpriseRound = false;
        gameState.isRiftCollapse = false;
        gameState.act1Started = false;
        gameState.hasObservedGambler = false;
        gameState.hasSearchedSmugglerDrop = false;
        gameState.docksWorkCount = 0;
        gameState.quinnLogistics = false;
        gameState.isEthereal = false;
        gameState.hallLooted = false;
        gameState.hasBlinkSkill = false;
        gameState.act2Started = false;
        gameState.tetherTimer = 20;
        gameState.act3Started = false;
        gameState.shipName = "The Iron Lung";
        gameState.knownIslands = ['port_hub'];
        gameState.currentLocation = 'port_hub';
        gameState.supplies = 10;
        gameState.companions.silas.joined = false;
        gameState.silasJoined = false;

        document.getElementById('journal-content').innerHTML = '';
        await saveGame();
        renderScene('prologue_storm');
        rebuildJournal();
        document.getElementById('inf-status-text').textContent = "Unknown to all";
        document.getElementById('item-desc-area').textContent = "Hover over an item to inspect it.";
    }


    // DEV MENU (KONAMI)
    (function() {
        const k=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a']; let idx=0;
        document.addEventListener('keydown', (e) => {
            if(e.key === k[idx] || e.key.toLowerCase() === k[idx]) { idx++; if(idx===k.length) { activateDev(); idx=0; } } else idx=0;
        });
        function activateDev() {
            if(document.getElementById('dev-menu')) { document.getElementById('dev-menu').remove(); return; }
            const m = document.createElement('div'); m.id='dev-menu'; m.className="fixed top-10 left-10 z-[200] bg-gray-950 border-2 border-amber-600 p-4 rounded text-xs font-mono text-amber-500 w-64";
            m.innerHTML = `<h3 class=\"font-bold border-b border-gray-700 mb-2\">DEV COMMAND</h3><div class=\"grid grid-cols-2 gap-2\"><button onclick=\"window.devJump('act1')\" class=\"bg-gray-800 p-1\">Act 1</button><button onclick=\"window.devJump('act2')\" class=\"bg-gray-800 p-1\">Act 2</button><button onclick=\"window.devJump('act3')\" class=\"bg-gray-800 p-1\">Act 3</button><button onclick=\"window.devGrant()\" class=\"bg-green-900 p-1\">God Mode</button></div>`;
            document.body.appendChild(m);
        }
        window.devJump = (loc) => { 
            if(loc==='act1') { gameState.act1Started=true; renderScene('town_square'); }
            if(loc==='act2') { gameState.act2Started=true; gameState.isEthereal=true; renderScene('manor_foyer'); }
            if(loc==='act3') { gameState.act3Started=true; gameState.shipName="Dev Ship"; renderScene('sea_map_hub'); }
        };
        window.devGrant = (type) => { 
            if (type === 'godmode') { 
                gameState.maxHP=50; gameState.currentHP=50; gameState.shillings=100; 
                gameState.inventory.push("Sword of Valor", "Ring of Brass", "Spectral Lantern"); 
                updateUI(); 
            } else if (type === 'level') {
                window.gameFunctions.startDreamscape('act1_transition');
            }
        };
    })();

    init();
</script>
</body>
</html>