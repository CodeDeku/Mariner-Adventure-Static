<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edward Jones: The Mariner of the Damned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS Font Awesome for dynamic icon switching -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Crimson Text', serif;
            background-color: #050a10;
            color: #cdd5e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1, h2, h3, .cinzel {
            font-family: 'Cinzel', serif;
        }
        .journal-font {
            font-family: 'Dancing Script', cursive;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #94a3b8; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .btn-game {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            padding: 12px; /* Consistent p-3 size for all base buttons */
        }
        .btn-game:active { transform: translateY(1px); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
		/* --- CHANNEL BUTTON (HOLD INTERACTION) --- */
        .btn-channel {
            position: relative;
            background: linear-gradient(90deg, #1e1b4b 0%, #312e81 100%); /* Deep Indigo */
            border: 1px solid #818cf8;
            color: #e0e7ff;
            overflow: hidden;
            user-select: none; /* Prevent text highlighting while holding */
            -webkit-user-select: none;
            touch-action: none; /* Prevent scrolling while holding on mobile */
        }
        
        /* The Progress Bar Overlay */
        .btn-channel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: rgba(139, 92, 246, 0.6); /* Violet Glow */
            z-index: 0;
            transition: width 0s; /* Default: Instant reset */
        }
        
        /* The Animation State */
        .btn-channel.channeling::before {
            width: 100%;
            transition: width var(--channel-duration) linear;
        }
        
        /* Ensure text stays on top of the progress bar */
        .btn-content-wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            width: 100%;
            align-items: center;
        }
		
        /* SPECTRAL BLUE/GLOW DEFINITIONS (Centralized Theme) */
        
        /* Crew Selection Active Glow (Border/Shadow) */
        @keyframes spectral-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); border-color: #3b82f6; }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); border-color: #60a5fa; }
        }
        /* Applies to crew box and active crew indicator */
        .spectral-active { 
            animation: spectral-pulse 2s infinite; 
            background-color: rgba(30, 58, 138, 0.3); /* Dark Blue Background */
            border-color: #60a5fa !important;
        }

        /* Text Color for all spectral elements (Skill Check, Banter, Lore, Journal Links, Dice Icon) */
        .spectral-text-glow {
            color: #93c5fd; /* Light Blue-300: High contrast, ghostly tone */
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.6);
            font-weight: 700;
        }
        /* End Spectral Definitions */


        /* Custom glow for FREE USE / Mushroom */
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.5); border-color: #a855f7; }
            50% { box-shadow: 0 0 18px rgba(192, 132, 252, 0.8); border-color: #c084fc; }
        }
        .crew-free-use-glow {
            animation: pulse-purple 2s infinite;
            background-color: rgba(88, 28, 135, 0.5); /* deep violet */
            border-color: #a855f7 !important;
            color: #f3e8ff !important;
        }


        /* --- TUTORIAL PULSE (AMBER) --- */
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); border-color: #f59e0b; }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); border-color: #fbbf24; }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; }
        }
        .tutorial-pulse { 
            animation: pulse-amber 2s infinite; 
            border: 2px solid #f59e0b !important; 
            background-color: rgba(180, 83, 9, 0.4); /* Dark Amber background */
            z-index: 10;
        }

        @keyframes item-pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 10px 0 rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
        }
        .item-consumable { animation: item-pulse 3s infinite; }

        #inf-marker { transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- HERO / ABILITY BUTTON STYLING (UNIFIED SIZE) --- */
        
        /* Base styles for all glowing/custom buttons */
        .btn-hero, .btn-fire-glow, .btn-shadow-glow, .btn-success-glow, .btn-keen-senses {
            padding: 12px; /* FORCED CONSISTENT PADDING (p-3 equivalent) */
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        @keyframes hero-pulse {
            0% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); border-color: #93c5fd; }
            100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }
        }

        .btn-hero {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); /* Blue gradient */
            border: 1px solid #60a5fa;
            color: #dbeafe; /* Very light blue text */
            animation: hero-pulse 2s infinite;
        }
        
        .btn-hero:hover {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
            transform: translateY(-1px);
        }
        
        /* Icon styling for hero buttons */
        .hero-icon {
            color: #60a5fa;
            filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.8));
        }

        /* --- FIRE ELEMENTAL GLOW (Absorb Elements) - DIALED BACK --- */
        @keyframes fire-pulse {
            /* Softer glow spread and opacity */
            0%, 100% { box-shadow: 0 0 3px rgba(239, 68, 68, 0.3); border-color: #f87171; }
            50% { box-shadow: 0 0 10px rgba(248, 113, 113, 0.5); border-color: #fca5a5; } /* Max spread reduced from 20px to 10px; Opacity reduced to 0.5 */
        }
        .btn-fire-glow {
            /* Reduced base opacity of background */
            background: linear-gradient(90deg, rgba(185, 28, 28, 0.3) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid #f87171;
            color: #fecaca;
            animation: fire-pulse 2s infinite;
        }

        /* --- SHADOW/VOID GLOW (Primeval Awareness) - DIALED BACK --- */
        @keyframes shadow-pulse {
            /* Softer glow spread and opacity */
            0%, 100% { box-shadow: 0 0 3px rgba(139, 92, 246, 0.3); border-color: #a78bfa; }
            50% { box-shadow: 0 0 10px rgba(167, 139, 250, 0.5); border-color: #d8b4fe; } /* Max spread reduced from 20px to 10px; Opacity reduced to 0.5 */
        }
        .btn-shadow-glow {
            /* Reduced base opacity of background */
            background: linear-gradient(90deg, rgba(88, 28, 135, 0.3) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid #a78bfa;
            color: #e9d5ff;
            animation: shadow-pulse 2s infinite;
        }

        /* --- SUCCESS GLOW (Info Bypass) - UPDATED TO WHISPER TONE --- */
		.btn-success-glow {
			background-color: rgba(243, 244, 246, 0.1); /* White/Gray Base */
			border: 1px solid #9ca3af; /* Gray-400 */
			box-shadow: 0 0 8px rgba(156, 163, 175, 0.3); /* Soft, subtle glow */
			color: #f9fafb; /* Lightest Gray text */
			transition: all 0.2s;
		}
		.btn-success-glow:hover {
			background-color: rgba(243, 244, 246, 0.2);
			box-shadow: 0 0 12px rgba(255, 255, 255, 0.4); /* White glow on hover */
			transform: translateY(-1px);
		}
        
        /* --- KEEN SENSES GLOW (Violet Border) --- */
        @keyframes keen-senses-pulse {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(168, 85, 247, 0.4); 
                border-color: #a855f7; 
            }
            50% { 
                box-shadow: 0 0 12px rgba(192, 132, 252, 0.7); 
                border-color: #c084fc; 
            }
        }
        .btn-keen-senses {
            /* Keep standard button background/text but add glow */
            background-color: #1f2937; /* Dark slate base for look and feel */
            border: 1px solid #475569; /* Starting standard border */
            color: #e9d5ff; /* Light text (similar to shadow glow) */
            animation: keen-senses-pulse 2s infinite;
        }
        .btn-keen-senses:hover {
            border-color: #c084fc; /* Brighter border on hover */
            background-color: #334155; /* Slightly lighter background on hover */
            transform: translateY(-1px);
        }

        /* --- UNAFFORDABLE STYLING (New) --- */
        .btn-disabled-cost {
            opacity: 0.4;
            cursor: not-allowed;
            /* Override hover effects for visual feedback */
            background-color: #1f2937 !important; /* Dark slate */
            border-color: #475569 !important; /* Slate-600 */
        }
        .btn-disabled-cost:hover {
             transform: none; /* No lift effect on hover */
             box-shadow: none;
        }


        /* --- LORE TOOLTIPS --- */
        /* Updated LORE Tooltip styling to use SPECTRAL GLOW for consistency */
        .memory-keyword {
            color: #93c5fd; /* Spectral text color */
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5); /* Soft Glow */
            cursor: help;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 1px solid transparent; 
        }
        .memory-keyword:hover {
            text-shadow: 0 0 12px rgba(59, 130, 246, 0.9), 0 0 2px #fff; /* Intense Glow */
            color: #bfdbfe; /* Lighter Spectral Blue */
        }
        /* Tooltip Box */
        .memory-keyword:hover::after {
            content: attr(data-lore);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #0f172a; /* Slate-900 */
            border: 1px solid #3b82f6; /* Blue-500 */
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            width: 240px;
            font-size: 0.85rem;
            line-height: 1.4;
            z-index: 100;
            pointer-events: none;
            font-family: 'Crimson Text', serif;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            text-align: center;
            white-space: normal;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* Tooltip Arrow */
        .memory-keyword:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0px);
            border-width: 6px;
            border-style: solid;
            border-color: #3b82f6 transparent transparent transparent;
            z-index: 100;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }

        /* --- ATMOSPHERIC FX --- */
        #fx-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
            transition: box-shadow 0.5s ease;
        }

		/* --- UNIFIED RIFT FX SYSTEM --- */

		/* State 1: Rift Pulse (The Threat) 
		   Used in Act 1 Hubs and Boss Intros to show magical instability. */
		@keyframes rift-pulse-anim {
			0%, 100% { box-shadow: inset 0 0 20px 0px rgba(139, 92, 246, 0.1); background-color: rgba(139, 92, 246, 0.05); }
			50% { box-shadow: inset 0 0 80px 20px rgba(139, 92, 246, 0.4); background-color: rgba(139, 92, 246, 0.15); }
		}
		.fx-rift-pulse {
			animation: rift-pulse-anim 4s infinite ease-in-out;
			mix-blend-mode: overlay;
		}
		/* State 2: Rift Collapsed (The Failure) - DIALED BACK & VISIBLE */
		@keyframes rift-collapse-anim {
			/* REDUCED INTENSITY AND SPREAD */
			0% { 
				box-shadow: inset 0 0 30px 10px rgba(109, 40, 217, 0.4); /* Reduced size and opacity */
				background-color: rgba(88, 28, 135, 0.05); 
			}
			50% { 
				box-shadow: inset 0 0 90px 30px rgba(139, 92, 246, 0.5); /* Reduced size and opacity */
				background-color: rgba(124, 58, 237, 0.10); /* Reduced background flash */
			}
			100% { 
				box-shadow: inset 0 0 30px 10px rgba(109, 40, 217, 0.4); 
				background-color: rgba(88, 28, 135, 0.05); 
			}
		}

		.fx-rift-collapsed {
			animation: rift-collapse-anim 4s infinite ease-in-out !important; 
			mix-blend-mode: normal !important; 
			z-index: 25;
			border: 1px solid rgba(139, 92, 246, 0.4); 
		}

        @keyframes flash-red-anim {
            0% { background-color: rgba(220, 38, 38, 0.6); }
            100% { background-color: transparent; }
        }
        .fx-flash-red {
            animation: flash-red-anim 0.4s ease-out forwards;
        }

        /* REPLACE .fx-vignette-low WITH THIS ID STYLING */
		#vignette-overlay {
			box-shadow: inset 0 0 80px 30px rgba(127, 29, 29, 0.5); /* Stronger red */
		}
		.vignette-active {
			opacity: 1 !important;
		}

        .water-stained {
            background-color: #1e293b;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23334155' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Blur UI when in prologue */
        .prologue-blur { filter: blur(4px); opacity: 0.5; pointer-events: none; transition: all 1s; }
        .prologue-active { opacity: 1; filter: none; }
        
        /* Hidden Log State */
        .log-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .log-visible { opacity: 1; pointer-events: auto; transform: translateY(0); transition: all 1s ease-out; }

        /* --- ETHEREAL PLANE THEME (SYSTEM OVERRIDE) --- */
        
        /* 1. Global Background & Transition */
        body.plane-ethereal {
            background-color: #020617; /* Slate-950: Deep Void */
            transition: background-color 1s ease;
        }

        /* 2. TEXT SHIFTS: Gold/Amber becomes Cyan/Spectral */
        body.plane-ethereal .text-amber-500,
        body.plane-ethereal .text-amber-600,
        body.plane-ethereal .text-amber-700 {
            color: #22d3ee !important; /* Cyan-400 */
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.6);
        }
        body.plane-ethereal .text-gray-300,
        body.plane-ethereal .text-gray-400 {
            color: #e2e8f0 !important; /* Slate-200: Cold White */
        }
        /* Override Cinzel headers to be spectral blue */
        body.plane-ethereal h1, 
        body.plane-ethereal h2, 
        body.plane-ethereal h3 {
            color: #67e8f9 !important; /* Cyan-300 */
            text-shadow: 0 0 15px rgba(103, 232, 249, 0.4);
        }

        /* 3. PANEL TRANSFORMATIONS: Wood/Stone becomes Void Glass */
        /* Targets: Stats Panel, Main Text Area, Journal Container */
        body.plane-ethereal .bg-gray-800,
        body.plane-ethereal .bg-gray-900,
        body.plane-ethereal .bg-\[\#111318\] { 
            background-color: rgba(15, 23, 42, 0.8) !important; /* Slate-900 semi-transparent */
            backdrop-filter: blur(5px); /* Glass effect */
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.05); /* Slight cyan ambient glow */
        }

        /* 4. BORDER GLOW: Rusted Iron becomes Starlight Silver */
        body.plane-ethereal .border-gray-700,
        body.plane-ethereal .border-gray-600 {
            border-color: #1e3a8a !important; /* Blue-900 */
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); /* Blue Glow */
        }

        /* 5. JOURNAL OVERRIDE: Remove Paper, Add Void */
        body.plane-ethereal .water-stained {
            background-image: none !important; /* Remove paper texture */
            background: linear-gradient(180deg, #0f172a 0%, #172554 100%) !important; /* Void Gradient */
        }
        body.plane-ethereal #journal-container {
            border-color: #60a5fa !important; /* Blue-400 Border */
        }
        body.plane-ethereal .journal-font {
            color: #bae6fd !important; /* Light Sky Blue text */
            font-family: 'Dancing Script', cursive !important;
        }

        /* 6. STANDARD BUTTON OVERRIDE (The "Normal" Travel Buttons) */
        /* We target the standard grey buttons specifically */
        body.plane-ethereal .btn-game:not(.btn-hero):not(.btn-fire-glow):not(.btn-shadow-glow):not(.btn-success-glow):not(.btn-keen-senses) {
            background: linear-gradient(90deg, rgba(30, 27, 75, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%) !important; /* Indigo-950 */
            border-color: #4f46e5 !important; /* Indigo-600 */
            color: #e0e7ff !important; /* Indigo-100 */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.2);
        }
        body.plane-ethereal .btn-game:not(.btn-hero):hover {
            border-color: #22d3ee !important; /* Cyan Hover */
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
            transform: translateX(5px); /* Ethereal Drift movement */
        }
        
        /* 7. SCENE IMAGE FILTER: Invert/Spectral */
        body.plane-ethereal #scene-image {
            filter: hue-rotate(190deg) saturate(0.8) contrast(1.2) brightness(0.8);
            mix-blend-mode: luminosity; /* Ghostly B&W feel */
        }
    </style>
</head>
<body>

    <div id="app-loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white">
        <div class="text-4xl cinzel text-blue-500 mb-4 animate-pulse text-center px-4">Edward Jones:<br>The Mariner of the Damned</div>
        <div class="text-gray-400 cinzel text-sm">Summoning the Crew...</div>
    </div>

    <!-- Audio Toggle Button (Fixed Position) -->
    <div class="fixed top-4 right-4 z-50">
        <button id="audio-toggle" class="bg-gray-800/80 border border-gray-600 text-gray-400 p-2 rounded-full hover:text-amber-500 transition-colors w-10 h-10 flex items-center justify-center shadow-lg backdrop-blur">
            <!-- Default Icon: Muted -->
            <i class="fas fa-volume-mute"></i>
        </button>
    </div>

    <div class="grid grid-cols-1 md:flex md:flex-row max-w-7xl mx-auto w-full p-2 md:p-4 gap-4 mb-8">
        
        <div class="contents md:flex md:flex-col md:w-1/3 gap-3 shrink-0">
            
            <div class="order-1 md:order-none relative w-full aspect-square md:aspect-[4/3] bg-gray-900 rounded border border-gray-700 overflow-hidden shadow-2xl shrink-0 group">
                <button id="reset-game-btn" onclick="confirmReset()" class="absolute top-2 left-2 z-30 text-[10px] border border-red-900/50 text-red-400 bg-black/60 hover:text-red-200 hover:bg-red-900/80 px-2 py-1 rounded transition-all cinzel font-bold backdrop-blur-sm">
                    <i class="fas fa-skull mr-1"></i>New Game
                </button>

                <!-- New FX Overlay -->
                <div id="fx-overlay"></div>
				<div id="vignette-overlay" class="absolute inset-0 pointer-events-none z-20 transition-opacity duration-500 opacity-0"></div>

                <img id="scene-image" src="" alt="Scene Visualization" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000">
                
                <!-- NEW IMAGE LOADER STRUCTURE FIX -->
                <div id="image-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-amber-600"></i>
                        <span class="text-xs cinzel tracking-widest text-amber-600">Manifesting Vision...</span>
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4">
                    <h2 id="scene-title" class="text-xl cinzel text-amber-500 text-shadow"></h2>
                </div>
            </div>

            <div id="stats-panel" class="order-4 md:order-none bg-gray-800/80 rounded border border-gray-700 p-3 flex flex-col gap-3 shadow-lg backdrop-blur-sm relative transition-all duration-1000">
                
                <div>
                    <div class="flex justify-between text-sm cinzel text-gray-400 mb-1">
                        <span>Edward Jones</span>
                        <span id="hp-text">20/20</span>
                    </div>
                    <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-gray-700">
                        <div id="hp-bar" class="bg-red-800 h-full w-full transition-all duration-500"></div>
                    </div>
                </div>
                
                <!-- PLANAR INSTABILITY (DOOM COUNTER) DISPLAY -->
                <!-- HIDDEN BY DEFAULT, ONLY SHOW IN ACT 1 VIA JS -->
                <div id="doom-counter-display" class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative hidden">
                    <div class="flex justify-between items-center cinzel text-xs uppercase tracking-wider font-bold">
                        <span class="text-purple-400"><i class="fas fa-bolt mr-1"></i>Rift Stability</span>
                        <span id="doom-timer-text"></span>
                    </div>
                    <div class="relative w-full h-1 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
                        <div id="doom-bar" class="absolute inset-0 bg-purple-600 transition-all duration-500"></div>
                    </div>
                </div>
                <!-- END PLANAR INSTABILITY -->


                <div class="grid grid-cols-1 gap-2 text-sm">
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex items-center justify-between">
                        <span class="text-amber-500 cinzel"><i class="fas fa-coins mr-2"></i>Shillings</span>
                        <span id="shillings-display" class="font-bold text-gray-200">0</span>
                    </div>

                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative">
                        <div class="flex justify-between items-center cinzel text-[10px] uppercase tracking-wider font-bold">
                            <span class="text-blue-400"><i class="fas fa-shield-alt mr-1"></i>Order</span>
                            <span class="text-gray-500">Neutral</span>
                            <span class="text-emerald-400">Chaos<i class="fas fa-skull-crossbones ml-1"></i></span>
                        </div>
                        
                        <div class="relative w-full h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-gray-800 to-emerald-900 opacity-60"></div>
                            
                            <div id="inf-marker" class="absolute top-0 bottom-0 w-1.5 bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] z-10 rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
                        </div>
                        <div class="text-center text-[10px] text-gray-500 italic" id="inf-status-text">Unknown to all</div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400">Guiding Voice (+1d4)</span>
                        <span class="text-[10px] text-gray-600 italic">Resets on Long Rest</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2" id="crew-panel">
                        </div>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400"><i class="fas fa-briefcase mr-1"></i> Inventory</span>
                    </div>

                    <div id="item-desc-area" class="text-[12px] text-gray-400 h-8 italic mb-2 text-center leading-tight flex items-center justify-center bg-gray-900/50 border border-gray-700/50 rounded px-2 transition-all duration-300">
                        Hover over an item to inspect it.
                    </div>

                    <div id="inventory-panel" class="flex flex-col gap-1">
                        </div>
                </div>
            </div>
        </div>

        <div class="contents md:flex md:flex-col md:w-2/3 gap-4">
            
            <div id="main-scene-text" class="order-2 md:order-none bg-[#111318] rounded border border-gray-700 p-6 shadow-inner relative flex flex-col justify-center min-h-[160px]">
                <div class="text-center text-gray-500 italic">Initializing Story...</div>
            </div>

            <div class="order-3 md:order-none shrink-0 flex flex-col gap-2">
                 <div id="active-crew-indicator" class="hidden text-center text-blue-400 text-xs cinzel animate-pulse mb-1">
                    <i class="fas fa-ghost mr-1"></i> <span id="active-crew-name"></span> is guiding your next move...
                </div>
                <div id="choices-area" class="grid grid-cols-1 gap-2">
                    </div>
            </div>

            <div id="journal-container" class="order-5 md:order-none log-hidden h-96 md:h-[476px] shrink-0 rounded border border-gray-600 bg-gray-800 shadow-2xl flex flex-col overflow-hidden relative">
                <div class="bg-[#0f172a] text-center py-1 border-b border-gray-700 z-10 shadow-md">
                    <h3 class="cinzel text-amber-600 text-sm tracking-[0.2em] font-bold">The Log of The Trident's Kiss</h3>
                </div>
                <div id="journal-scroll-area" class="flex-1 water-stained p-6 overflow-y-auto">
                    <div id="journal-content" class="space-y-6">
                         </div>
                    <div class="h-4"></div>
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
			apiKey: "AIzaSyDlg5dETZJpbJ9GzMV01pUYA06XbFmySbw",
			authDomain: "edward-jones-75546.firebaseapp.com",
			projectId: "edward-jones-75546",
			storageBucket: "edward-jones-75546.firebasestorage.app",
			messagingSenderId: "76799051768",
			appId: "1:76799051768:web:fdd3641b597adfc6a0780d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "edward-jones-standalone";
        let user;
        
        const MAX_OVERHEAL_CAP = 25; // Define the absolute maximum HP allowed

        // --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                // Setup Ambience Loop
                this.ambience = new Audio('audio/ambience.mp3');
                this.ambience.loop = true;
                this.ambience.volume = 0.3; // Quiet by default
                
                // Setup SFX
                this.clickSound = new Audio('audio/click.mp3');
                this.clickSound.volume = 0.5;
                
                this.gaspSound = new Audio('audio/gasp.mp3');
                this.gaspSound.volume = 0.6;
                
                this.clashSound = new Audio('audio/clash.mp3');
                this.clashSound.volume = 0.5;
                
                this.coinsSound = new Audio('audio/coins.mp3');
                this.coinsSound.volume = 0.5;
                
                this.vulnerableSound = new Audio('audio/vulnerable.mp3');
                this.vulnerableSound.volume = 0.6;
                this.vulnerableSound.loop = true; // Loop the panting sound
                
                this.ghostSound = new Audio('audio/ghost.mp3');
                this.ghostSound.volume = 0.4;

                this.isMuted = true;
                this.hasInteracted = false;
                
                // Track if vulnerable sound played this scene to prevent looping
                this.playedVulnerable = false;

                // Bind toggle button
                const btn = document.getElementById('audio-toggle');
                btn.onclick = () => this.toggleMute();
            }

            playSFX(soundObj) {
                if (!this.isMuted) {
                    // Clone to allow overlapping sounds
                    const sound = soundObj.cloneNode();
                    sound.volume = soundObj.volume;
                    sound.play().catch(e => console.log("Audio play blocked"));
                }
            }

            playClick() { this.playSFX(this.clickSound); }
            playGasp() { this.playSFX(this.gaspSound); }
            playClash() { this.playSFX(this.clashSound); }
            playCoins() { this.playSFX(this.coinsSound); }
            playGhost() { this.playSFX(this.ghostSound); }
            
            checkVulnerable(currentHP, maxHP) {
                const pct = (currentHP / maxHP) * 100;
                
                if (pct <= 30) {
                    // Player is vulnerable
                    if (!this.playedVulnerable && !this.isMuted) {
                        // Play the looping sound directly (not a clone)
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                        this.playedVulnerable = true;
                    }
                } else {
                    // Player is healed above threshold - Stop Sound
                    this.vulnerableSound.pause();
                    this.vulnerableSound.currentTime = 0;
                    this.playedVulnerable = false;
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById('audio-toggle');
                const icon = btn.querySelector('i');

                if (!this.isMuted) {
                    // Active State
                    this.ambience.play().catch(e => console.log("Autoplay blocked"));
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-high'); // Active Speaker Icon
                    btn.classList.add('text-amber-500', 'border-amber-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                    
                    // Resume vulnerable sound if active
                    if(this.playedVulnerable) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                    }
                } else {
                    // Muted State
                    this.ambience.pause();
                    this.vulnerableSound.pause(); // Ensure panting stops on mute
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-volume-mute'); // Muted Speaker Icon
                    btn.classList.remove('text-amber-500', 'border-amber-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
            }
        }

        const audioManager = new AudioManager();

        // --- FX MANAGER ---
		class FXManager {
			constructor() {
				this.overlay = document.getElementById('fx-overlay');
				// NEW: Capture the separate vignette element
				this.vignette = document.getElementById('vignette-overlay');
			}

			clearEffects() {
				// Only clear the Rift/Atmosphere effects from the main overlay
				this.overlay.classList.remove('fx-rift-pulse', 'fx-rift-collapsed', 'fx-flash-red'); 
			}

			flashRed() {
				this.overlay.classList.add('fx-flash-red');
				setTimeout(() => this.overlay.classList.remove('fx-flash-red'), 400);
			}
			
			setVignette(active) {
				// Toggle the opacity class on the separate element
				if(active) this.vignette.classList.add('vignette-active');
				else this.vignette.classList.remove('vignette-active');
			}
		}
        
        const fxManager = new FXManager();

        // --- STATIC IMAGE MAPPING ---
		const sceneImages = {
			'prologue_storm': 'images/storm.jpg',
			'prologue_abyss': 'images/abyss.jpg',
			'start': 'images/wreckage.jpg',
			'wreckage_success': 'images/chest.jpg',
			'wreckage_fail': 'images/sand_empty.jpg', 
			'treeline': 'images/forest.jpg',
			'treeline_prepared': 'images/forest.jpg',
			'road_encounter': 'images/guard_road.jpg',
			'trail_success': 'images/smuggler_cove_high.jpg',
			'trail_success_talon': 'images/smuggler_cove_high.jpg',
			'trail_fail': 'images/stumble_guard.jpg', 
			'guard_talk': 'images/guard_face.jpg',
			'guard_respect': 'images/guard_salute.jpg', 
			'guard_bribe': 'images/guard_bribe.jpg', 
			'guard_scared': 'images/guard_scared.jpg', 
			'combat_guard': 'images/combat_hammer.jpg', 
			'smuggler_meet': 'images/smuggler_standoff.jpg',
            'smuggler_cargo': 'images/smuggler_pay.jpg',			
			'smuggler_friend': 'images/smuggler_rum.jpg', 
			'smuggler_pay': 'images/smuggler_pay.jpg', 
			'market_crossroads': 'images/market.jpg',
			'market_stall': 'images/merchant.jpg',
			'market_sell': 'images/merchant.jpg', 
			'buy_potion': 'images/merchant.jpg',
			'buy_rope': 'images/merchant.jpg',
			'buy_torch': 'images/merchant.jpg',
			'sell_rope': 'images/merchant.jpg',
			'sell_torch': 'images/merchant.jpg',
            'sell_cargo': 'images/merchant.jpg', 
			'sell_potion': 'images/merchant.jpg',
			'sell_rum': 'images/merchant.jpg',
			'lighthouse_split': 'images/lighthouse_far.jpg',
			'cliff_climb': 'images/cliff.jpg',
			'climb_fail': 'images/fall_cliff.jpg', 
			'dark_caves': 'images/caves.jpg',
            'dark_caves_illuminated': 'images/caves.jpg', 
			'dark_fail': 'images/cave_injury.jpg', 
			'lighthouse_arrival': 'images/lighthouse_door.jpg',
            'edward_death': 'images/abyss.jpg', // Renamed Death Scene
			'ending_order': 'images/guards_win.jpg',
			'ending_chaos': 'images/smugglers_win.jpg',
			'ending_neutral_check': 'images/lockpick.jpg', 
            'ending_neutral_success': 'images/lockpick.jpg',
			'lighthouse_vigil': 'images/dream.jpg',
			'lighthouse_rest': 'images/dream.jpg', // Placeholder image kept for consistency, but scene is removed from flow
            // --- ACT 1 SCENE IMAGES ---
            'lighthouse_morning': 'images/lighthouse_morning.jpg', // Skill unlock scene
            'captain_orders': 'images/lighthouse_vigil.jpg', // NEW SCENE
            'town_descent': 'images/town_descent.jpg', // Descent scene
            'town_square': 'images/town_square.jpg', // Hub: Wide shot of the chaotic port
            'alchemist_triage': 'images/plague_doctor.jpg', // Merchant: Plague doctor theme
            'blackwater_tavern': 'images/tavern_dark.jpg', // Rest/Info Hub: Dark tavern interior
            'smelter_entry': 'images/steam_pipe.jpg', // Fire Path: Steam Hazard
            'chapel_entry': 'images/fog_cemetery.jpg', // Shadow Path: Fog Maze
            'town_docks': 'images/docks.jpg', // NEW: Docks
            'docks_work': 'images/docks_work.jpg', // NEW: Docks Work
            'tavern_gambler': 'images/tavern_gambler.jpg', // NEW: Gambler/Keen Senses
            'cliffside_overlook': 'images/cliffside_overlook.jpg', // NEW: Descent Overlook
            'smelter_workers': 'images/smelter_workers.jpg', // NEW: Smelter Antechamber
            'chapel_vestry': 'images/chapel_vestry.jpg', // NEW: Chapel Antechamber
            // Item Check Reward Scenes
            'smelter_side_rope': 'images/smelter_workers.jpg', // Rope shortcut reward
            'chapel_side_torch': 'images/chapel_vestry.jpg', // Torch shortcut reward
            // NEW SECRET SCENE
            'alchemist_secret_stock': 'images/alchemist_secret.jpg',
            // Boss Fight Images
            'smelter_foundry': 'images/slag_horror.jpg', // Fire Boss
            'chapel_crypt': 'images/drowned_spectre.jpg', // Shadow Boss
            // MULTI-STAGE BOSSES
            'smelter_stage1_start': 'images/slag_horror.jpg', 
            'smelter_stage2': 'images/slag_horror_close.jpg',
            'smelter_stage3': 'images/slag_horror_exposed.jpg',
            'chapel_stage1_reveal': 'images/drowned_spectre.jpg', 
            'chapel_stage2_finish': 'images/drowned_spectre_close.jpg',
			'finale_completed': 'images/guards_win.jpg', // New scene for ending completion
			'default': 'https://placehold.co/600x400/0f172a/1e293b?text=The+Void' 
		};
        
        // --- GAME DATA FACTORY ---
        function createInitialState() {
            // Note: Initial stock is defined on the scene objects (e.g., scenes['market_stall'].stock)
            return {
                currentSceneId: 'prologue_storm', 
                currentHP: 20,
                maxHP: 20,
                shillings: 0, 
                // NEW: Tracks the styling state
                isEthereal: false, 
                inventory: [], 
                skills: [], // NEW: Hidden tracking for Absorb Elements / Primeval Awareness
                influence: 0, 
                crewUseFree: false, 
                lastCrewUsedId: null, 
                crew: {
                    gareth: { id: 'gareth', name: 'Captain Gareth', skill: 'Insight', used: false, desc: 'Add +1d4 to Initiative & Insight' },
                    quinn: { id: 'quinn', name: 'Quinn', skill: 'Investigation', used: false, desc: 'Add +1d4 to Investigation & History' },
                    talon: { id: 'talon', name: 'Talon', skill: 'Perception', used: false, desc: 'Add +1d4 to Survival & Perception' },
                    bones: { id: 'bones', name: 'Bones', skill: 'Survival', used: false, desc: 'Add +1d4 to Nature & Foraging' }
                },
                history: [],
                // NEW: Information Flags for Act 1 Shortcuts
                knowsSmelterSecret: false,
                knowsChapelSecret: false,
                // NEW: Doom Counter (Starts at 20 - INCREASED MAX STABILITY)
                doomTimer: 20,
                act1Started: false,
                // NEW: Status Flags for Boss Fights
                isAbsorbCharged: false, // For Absorb Elements
                isSurpriseRound: false, // For Primeval Awareness/Ambush
                isRiftCollapse: false, // For Doom Counter Failure State
                hasLoggedCollapse: false, // FIX 2A: Flag to prevent repeated logging of Rift Collapse penalty
                // NEW FLAGS FOR ONE-TIME ACTIONS (Task 3 Fix)
                hasObservedGambler: false, 
                hasSearchedSmugglerDrop: false,
                // NEW: Docks work exhaustion counter
                docksWorkCount: 0,
                // NEW FLAG: Quinn's Logistics (Doom Cost UI Reveal)
                quinnLogistics: false,
				hasDivedTreasure: false,
            };
        }

        let gameState = createInitialState();
        let activeCrewMember = null;

        // Interactive Items Definition
        const itemRegistry = {
            "Ship's Log": { type: 'key', icon: 'fa-book-skull', color: 'text-amber-700', desc: "Key Item: Records of the damned. Unlocks your history." },
            "Captain's Tricorn": { type: 'key', icon: 'fa-hat-cowboy', color: 'text-blue-500', desc: "Passive: A symbol of authority. +1 to Intimidation checks." },
            "Rum": {
                name: "Rum",
                type: 'consumable',
                icon: 'fa-wine-bottle',
                color: 'text-amber-500',
                btnText: "DRINK",
                desc: "Consumable: Potent grog. Restores 5 HP. Cannot repair Spectral HP.",
                action: (state) => {
                    // FIX: Block usage if at natural max HP or higher
                    if (state.currentHP >= state.maxHP) {
                        return "Your natural vitality is full. The burning grog offers no comfort to the Spectral Shield.";
                    }

                    const healAmount = 5;
                    const oldHP = state.currentHP;
                    
                    // FIX: Cap healing at state.maxHP (20), never MAX_OVERHEAL_CAP (25)
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);

                    const idx = state.inventory.indexOf("Rum");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Rum. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Gruel": {
				name: "Gruel",
				type: 'consumable',
				icon: 'fa-bowl-food',
				color: 'text-gray-400',
				btnText: "EAT",
				desc: "Consumable: Cheap, watery sustenance. Restores 2 HP. Cannot repair Spectral HP.",
				action: (state) => {
					// FIX: Block usage if at natural max HP or higher (Spectral Shield)
					if (state.currentHP >= state.maxHP) {
						return "You are full. The watery gruel offers no comfort to the Spectral Shield.";
					}

					const healAmount = 2;
					const oldHP = state.currentHP;
					
					// FIX: Cap healing at state.maxHP (20), never MAX_OVERHEAL_CAP (25)
					state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
					
					// Only consume item if we actually healed
					const idx = state.inventory.indexOf("Gruel");
					if (idx > -1) state.inventory.splice(idx, 1);
					
					return `Ate Gruel. Healed ${state.currentHP - oldHP} HP.`;
				}
			},
            "Healing Potion": {
				name: "Healing Potion",
				type: 'consumable',
				icon: 'fa-flask',
				color: 'text-red-500',
				btnText: "DRINK",
				desc: "Consumable: Alchemical vitality. Restores 10 HP. Cannot repair Spectral HP.",
				action: (state) => {
					// FIX: Block usage if at natural max HP or higher
					if (state.currentHP >= state.maxHP) {
						return "Your natural vitality is full. Potions cannot repair the Spectral Shield.";
					}

					const healAmount = 10;
					const oldHP = state.currentHP;
					
					// FIX: Cap healing at state.maxHP
					state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
					
					const idx = state.inventory.indexOf("Healing Potion");
					if (idx > -1) state.inventory.splice(idx, 1);
					return `Drank Potion. Healed ${state.currentHP - oldHP} HP.`;
				}
			},
            "Phoenix Draft": { // NEW ITEM: PHOENIX DRAFT
                name: "Phoenix Draft",
                type: 'key',
                icon: 'fa-feather',
                color: 'text-red-400',
                btnText: "PASSIVE",
                desc: "Key Item: Alchemical reserve. Automatically prevents death once, healing 10 HP. Consumed on use.",
                action: (state) => {
                    return `A powerful reserve, best saved for when death calls.`;
                }
            },
            "Pearlescent Mushroom": { 
                type: 'consumable',
                icon: 'fa-cloud-meatball', 
                color: 'text-purple-300',
                btnText: "EAT",
                desc: "Consumable: A medicinal mushroom used for mental clarity. (Free Guiding Voice)",
                action: (state) => {
                    if (state.crewUseFree) {
                        return "The residual clarity remains. You can only benefit from one mushroom at a time.";
                    }
                    state.crewUseFree = true;
                    // FIX 2: Mushroom consumption added here
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    
                    return `Consumed Pearlescent Mushroom. Clarity gained! (Free Guiding Voice available)`;
                }
            },
            "Curious Cargo": { // NEW ITEM: Influence driver
                name: "Curious Cargo",
                type: 'key',
                icon: 'fa-box-open', 
                color: 'text-yellow-600',
                desc: "Passive: A heavy crate of mysterious goods.",
                btnText: "SELL",
                action: (state) => {
                    return "Must be sold at the Market or traded at the Cove.";
                }
            },
            "Industrial Lubricant": {
                name: "Industrial Lubricant",
                type: 'consumable',
                icon: 'fa-oil-can',
                color: 'text-gray-400',
                btnText: "USE",
                desc: "Counter: Oily solvent. Critical for Slag Horror (Fire Path).",
                action: (state) => {
                    return `Save for the Slag Horror encounter.`;
                }
            },
            "Silver Locket": {
                name: "Silver Locket",
                type: 'key',
                icon: 'fa-heart',
                color: 'text-gray-300',
                btnText: "SELL",
                desc: "Passive: A sentimental item. Might be worth something."
            },
            "Rusted Cutlass": { type: 'key', icon: 'fa-khanda', color: 'text-gray-400', desc: "Passive: Reduces damage taken in combat events." },
            "Rope": { type: 'key', icon: 'fa-om', color: 'text-yellow-700', desc: "Passive: Essential for climbing cliffs." },
            "Torch": { type: 'key', icon: 'fa-fire', color: 'text-orange-500', desc: "Passive: Illuminates dark caves." },
            "Strange Coin": { type: 'key', icon: 'fa-circle-notch', color: 'text-yellow-600', desc: "Passive: Ancient currency. May open doors not made of wood." },
            "Dead Man's Die": { // NEW ITEM: Reroll Token
                name: "Dead Man's Die",
                type: 'consumable',
                icon: 'fa-dice-six', 
                color: 'text-gray-200',
                btnText: "INSPECT",
                desc: "Consumable: A bone die loaded to cheat fate. Allows you to escape a failure outcome once.",
                action: (state) => {
                    return `Keep this for when luck runs out (Fail States).`;
                }
            },
            
            // --- LEGENDARY ARTIFACTS (WOLVES OF VALOR) ---
            "Ring of Brass": { 
                type: 'key', 
                icon: 'fa-ring', 
                color: 'text-amber-500', 
                desc: "Legendary (Wolves of Valor): Doubles Primeval Awareness range. Grants Keen Senses (Perception advantage on hidden objects)." 
            },
            "Sword of Valor": { 
                type: 'key', 
                icon: 'fa-sword', 
                color: 'text-blue-500', 
                desc: "Legendary (Wolves of Valor): +1 to attack/damage. Deals extra Force damage to Undead. Required for the Ritual." 
            },
			"Compass": { type: 'key', icon: 'fa-compass', color: 'text-indigo-400', desc: "Passive: Violently hums near planar energy." },
            
            // --- ALCHEMIST ITEMS ---
            "Vitality Tincture": { 
				name: "Vitality Tincture",
				type: 'consumable',
				icon: 'fa-heart-circle-plus', 
				color: 'text-red-300',
				btnText: "DRINK",
				desc: "Consumable: High-grade restorative. Restores 15 HP. Cannot repair Spectral HP.",
				action: (state) => {
					// FIX: Block usage if at natural max HP or higher
					if (state.currentHP >= state.maxHP) {
						return "Your natural vitality is full. Tinctures cannot repair the Spectral Shield.";
					}

					const healAmount = 15;
					const oldHP = state.currentHP;
					
					// FIX: Cap healing at state.maxHP
					state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
					
					const idx = state.inventory.indexOf("Vitality Tincture");
					if (idx > -1) state.inventory.splice(idx, 1);
					return `Drank Tincture. Healed ${state.currentHP - oldHP} HP.`;
				}
			},
            "Smelling Salts": { 
                name: "Smelling Salts",
                type: 'consumable',
                icon: 'fa-spray-can', 
                color: 'text-purple-400',
                btnText: "USE",
                desc: "Consumable: Revives a single used Crew Member (except the last one used).",
                action: (state) => {
                    const usedCrew = Object.values(state.crew).filter(c => c.used);
                    if (usedCrew.length === 0) {
                        return "No crew members are currently exhausted.";
                    }
                    
                    // Cannot revive the last crew member used in a skill check
                    const revivableCrew = usedCrew.filter(c => c.id !== state.lastCrewUsedId);

                    if (revivableCrew.length === 0) {
                        return `Cannot revive ${state.lastCrewUsedId.charAt(0).toUpperCase() + state.lastCrewUsedId.slice(1)}: they were last used for a check.`;
                    }
                    
                    // For simplicity, just revive the first revivable one found
                    const crewToRevive = revivableCrew[0];
                    state.crew[crewToRevive.id].used = false;
                    
                    const idx = state.inventory.indexOf("Smelling Salts");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    
                    return `Used Salts. ${crewToRevive.name} is now available.`;
                }
            },
            "Flash Powder": { 
                name: "Flash Powder",
                type: 'consumable',
                icon: 'fa-sparkles', 
                color: 'text-yellow-300',
                btnText: "THROW",
                desc: "Consumable: Guarantees escape from current combat (if in combat).",
                action: (state) => {
                    return `Save for a desperate combat escape.`;
                }
            },
            // --- NEW ARTIFACT CONSUMABLES (Boss Fight Counters) ---
            "Alchemical Fire": { 
                name: "Alchemical Fire",
                type: 'consumable',
                icon: 'fa-fire-alt', 
                color: 'text-orange-600',
                btnText: "IGNITE",
                desc: "Counter: Volatile mixture. Critical for Drowned Spectre (Shadow Path).",
                action: (state) => {
                    return `Save for the Drowned Spectre encounter.`;
                }
            },
            "Holy Water": { 
                name: "Holy Water",
                type: 'consumable',
                icon: 'fa-cross', 
                color: 'text-blue-200',
                btnText: "SPLASH",
                desc: "Counter: Consecrated water. Critical for Slag Horror (Fire Path).",
                action: (state) => {
                    return `Save for the Slag Horror encounter.`;
                }
            },
        };
        
        function getBonusForSkill(crewMember, skillType) {
            // Mapping based on character sheet
            const expertise = {
                'Captain Gareth': ['Insight', 'Initiative'],
                'Quinn': ['Investigation', 'History'],
                'Talon': ['Survival', 'Perception'],
                'Bones': ['Survival', 'Nature', 'Medical'] // Bones has overlaps
            };

            const allowedSkills = expertise[crewMember.name] || [];
            return allowedSkills.includes(skillType);
        }

        // --- DYNAMIC BANTER DATA (NEW) ---
        const dynamicBanter = {
            'gareth': [
                "Keep your feet moving, Mariner. A dead ship needs a fast Captain.",
                "The storm is behind us, but the fog ahead is thicker. Stay alert.",
                "Do you feel that? The planar veil is thinning again. Hurry.",
                "There is no easy port in this chaos. Pick a heading and hold it true."
            ],
            'quinn': [
                "I've checked the manifest twice; we're running low on luck, Edward.",
                "Keep track of the shillings! Coin is the only stable metric left in this world.",
                "This path is inefficient, Captain. Logically, we should have gone the other way.",
                "Hmph. More wreckage. Always more wreckage."
            ],
            'talon': [
                "Watch the ground, Edward. The dead leave tracks too.",
                "Something smells wrong. Not rot*new* wrong. Be ready.",
                "The shadows here are deeper than they should be. It's a good place to hide, or be hunted.",
                "Rustling in the brush. Just wind... or something that hunts in the wind."
            ],
            'bones': [
                "I could use a long rest, Edward. My bones are cold and tired.",
                "Are you eating enough? You can't run on sea-water and guilt, Captain.",
                "This town is sick. I can taste the fever in the air.",
                "Keep the cutlass sharp. I don't like the look of these locals."
            ]
        };

        function getDynamicBanter() {
            // 20% chance check to inject banter
            if (Math.random() > 0.80) {
                const availableCrew = Object.keys(gameState.crew).filter(id => !gameState.crew[id].used);
                
                if (availableCrew.length === 0) return null;

                const randomCrewId = availableCrew[Math.floor(Math.random() * availableCrew.length)];
                const crewName = gameState.crew[randomCrewId].name;
                const lines = dynamicBanter[randomCrewId];
                
                if (lines && lines.length > 0) {
                    const randomLine = lines[Math.floor(Math.random() * lines.length)];
                    return { name: crewName, line: randomLine };
                }
            }
            return null;
        }
        // --- END DYNAMIC BANTER DATA (NEW) ---


        // --- MARKET BLUEPRINTS (Global Definitions for all merchants) ---
        // This is the single source of truth for item pricing and scene flow
        const MARKET_BUY_OPTIONS = [
            { item: "Healing Potion", nextScene: 'buy_potion', cost: 5 },
            { item: "Rope", nextScene: 'buy_rope', cost: 3 },
            { item: "Torch", nextScene: 'buy_torch', cost: 2 },
            { item: "Rum", nextScene: 'buy_rum', cost: 4 } // NEW: Rum is now a purchasable blueprint item
        ];
        
        // NEW: Triage Alchemist Stock Definition
        // FIX: Set doomCost to 0 on the *blueprint* for sales actions, but the button logic overrides based on the scene flow
        const ALCHEMIST_BUY_OPTIONS = [
            { item: "Vitality Tincture", nextScene: 'buy_tincture', cost: 15, doomCost: 0 },
            { item: "Smelling Salts", nextScene: 'buy_salts', cost: 8, doomCost: 0 },
            { item: "Flash Powder", nextScene: 'buy_powder', cost: 10, doomCost: 0 },
            { item: "Alchemical Fire", nextScene: 'buy_fire', cost: 12, doomCost: 0 }, // Alchemist sells boss counters
            { item: "Holy Water", nextScene: 'buy_water', cost: 12, doomCost: 0 }
        ];
        
        // NEW: Tavern Gruel Stock Definition
        const TAVERN_BUY_OPTIONS = [
             { item: "Gruel", nextScene: 'buy_gruel_to_go', cost: 1 } // Renamed 'Buy Gruel' to 'Buy Gruel (To Go)'
        ];

        const MARKET_SELL_OPTIONS = [
            // FIX: Curious Cargo is the ONLY exception to the 0 doom cost rule in Act 1 sales
            { item: "Curious Cargo", nextScene: 'sell_cargo', value: 10, doomCost: 1 }, 
            { item: "Rope", nextScene: 'sell_rope', value: 2, doomCost: 0 },
            { item: "Torch", nextScene: 'sell_torch', value: 1, doomCost: 0 },
            { item: "Healing Potion", nextScene: 'sell_potion', value: 3, doomCost: 0 },
            { item: "Rum", nextScene: 'sell_rum', value: 2, doomCost: 0 }
        ];
        
        // NEW: Alchemist Sell Options
        const ALCHEMIST_SELL_OPTIONS = [
            { item: "Silver Locket", nextScene: 'sell_locket_alch', value: 10, doomCost: 0 }, // New sell item
            { item: "Alchemical Fire", nextScene: 'sell_fire', value: 20, doomCost: 0 },
            { item: "Holy Water", nextScene: 'sell_water', value: 20, doomCost: 0 },
            { item: "Vitality Tincture", nextScene: 'sell_tincture', value: 7, doomCost: 0 }, // Can sell back the costly items at a loss
            // Can sell the demo's high-value items to the Alchemist for a higher price
            { item: "Healing Potion", nextScene: 'sell_potion_alch', value: 4, doomCost: 0 }, 
            { item: "Pearlescent Mushroom", nextScene: 'sell_mushroom_alch', value: 12, doomCost: 0 }
        ];
        // --- END MARKET BLUEPRINTS ---
        

        // --- SCENE DATABASE ---
        const scenes = {
            'prologue_storm': {
                title: "The Planar Storm",
				text: "The deck of The Trident's Kiss heaves. The sky isn't just storming; it hates you. Above, the clouds are a bleeding violet bruise. Captain Gareth stands at the wheel, singing against the gale. '...But who pays the toll for the army of dead?!' he roars. Quinn is frantically tying down crates, screaming that the manifest is slipping away.",
				journal: "The sky didn't just storm; it hated us. Gareth held the wheel until the wood splintered in his grip. I remember the sound of the mainmast snapping more than the thunder. The sea has come to collect.",
                // REMOVED GARETH BANTER HERE
                choices: [
                    { text: "Help Quinn secure the cargo", nextScene: 'prologue_abyss', type: 'travel' },
                    { text: "Stand with the Captain", nextScene: 'prologue_abyss', type: 'travel' }
                ]
            },
            'prologue_abyss': {
                title: "The God of the Deep",
				text: "A wave of pure magical force shatters the hull. The freezing dark claims you instantly. You sink, drifting into the abyss, and see IT risinga colossal shadow, vast as a mountain. The screams of Gareth, Quinn, Talon, and Bones are silenced by the water... only to re-ignite inside your skull, burning hotter than the freezing deep.",
				journal: "I died. I know I died. But the Shadow beneath the waves spat me back out. Now, I am not alone in my own skin.",
                choices: [
                    { text: "Gasp for air (Wake Up)", nextScene: 'start', type: 'travel' }
                ]
            },
			'start': {
                title: "The Wreckage",
				text: "You gasp, lungs burning, and retch salt water onto the grey sand. The storm has passed, but the silence of the beach is a lie. Inside your mind, the scream of the dying ship continues. They don't realize they are dead.<br><br>You find your hand cramping, clutching the Captain's Tricorn Hat with a death grip. Beside you, the Compass hums with a violet vibration. You are alive, but you have become a life raft for the damned.",
				journal: "Woke up choking on sand. Gareth's hat is in my handI can't let go of it. The Compass is screaming, and the crew... they are loud. So loud. They don't know they're ghosts.",
				banter: {
					'quinn': "The manifest! The logs! We can't be erased, Edward. Find the records or we never existed!"
				},
                onEnter: (state) => {
                    audioManager.playGasp();
                    let msg = "";
                    if (!state.inventory.includes("Captain's Tricorn")) {
                        state.inventory.push("Captain's Tricorn");
                        msg += "Started with Tricorn. ";
                    }
                    if (!state.inventory.includes("Compass")) {
                        state.inventory.push("Compass");
                        msg += "Found Compass. ";
                    }
                    return msg;
                },
                choices: [
                    { text: "Search the debris", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'wreckage_search': {
                isLogic: true,
                resolve: (roll) => roll >= 8 ? 'wreckage_success' : 'wreckage_fail'
            } ,
			'wreckage_success': {
                title: "Salvage",
				text: "Quinn guides your hand to a buried chest. Inside, a pouch of Shillings and a Rusted Cutlass. You strap the blade to your beltthe rust flakes away as your hand touches the hilt, remembering a fight you haven't fought yet. Quinn points frantically to a damp book lying nearbythe Ship's Log.",
				journal: "Salvaged what I could. A rusted blade feels heavy, but Quinn finally shut up once I found the Log. Writing this down gives me something to focus on besides the voices.",
                onEnter: (state) => {
                    const items = ["Rusted Cutlass", "Ship's Log"];
                    let found = false;
                    items.forEach(i => {
                        if(!state.inventory.includes(i)) {
                            state.inventory.push(i);
                            found = true;
                        }
                    });
                    state.shillings += 7; 
                    audioManager.playCoins();
                    
                    if (found) return "Found: Cutlass, Log & 7 Shillings.";
                    return "Found: 7 Shillings.";
                },
                choices: [{ text: "Move to Treeline", nextScene: 'treeline_prepared', type: 'travel' }]
            },
            'wreckage_fail': {
                title: "Empty Sands",
                text: "You dig through the driftwood until your fingers bleed, but the tide has claimed the rest. You find nothing but wet sand and splinters.",
                journal: "Scavenging yielded nothing. I am leaving the shore with empty pockets.",
                choices: [{ text: "Move to Treeline", nextScene: 'treeline', type: 'travel' }]
            },
            'treeline_prepared': {
				title: "The Whispering Woods",
				text: "The forest looms ahead, trees twisted like grasping hands. You adjust the weight of your gear. The voices are a dull murmur. A well-traveled road cuts through the center, but Talon notices a faint game trail disappearing into the brush.",
				journal: "The forest is watching. Gareth wants to march like a soldier; Talon wants to skulk like a wolf. I have to decide who to listen to before I go mad.",
				banter: {
					'gareth': "The King's Road is the only path for a proper vessel. March on.",
					'talon': "Roads are for sheep and slaughter. The brush hides us. I smell a game trail the soldiers missed."
				},
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' } // Clean text
                ]
            },
            'treeline': {
                title: "The Whispering Woods",
                text: "The forest looms ahead. As you step forward, Quinn screams in your mind. 'The Log! Don't leave the history!' You stumble, looking down to see the water-logged Ship's Log at your feet. You pick it up to silence him.",
                journal: "Quinn wouldn't let me leave without the Log. I found it at the treeline.",
                onEnter: (state) => {
                    if(!state.inventory.includes("Ship's Log")) {
                        state.inventory.push("Ship's Log");
                        return "Obtained Ship's Log.";
                    }
                    return null;
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' } // Clean text
                ]
            },
            'road_encounter': {
                title: "The King's Guard",
                text: "A heavy-set <span class='memory-keyword' data-lore='The iron fist of the Crown. They despise the supernatural and govern with martial law.'>Royal Guard</span> in plate armor blocks the path. 'Halt! Identify yourself!'",
                journal: "Royal Guard. Shining armor covering a rotten core. He looks at me like driftwood that needs burning.",
                choices: [
                    { text: "Speak diplomatically", nextScene: 'guard_talk', type: 'dialogue' },
                    { text: "Attack him", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
            // Modified Logic Scene to check for Talon being used
            'trail_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    const success = roll >= state.lastDC;
                    
                    if (success) {
                        // If successful AND Talon was the crew used, go to special cargo scene
                        if (state.lastCrewUsedId === 'talon') {
                            return 'trail_success_talon';
                        }
                        // Otherwise (success with Bones or no crew), send to normal success
                        return 'trail_success';
                    }
                    
                    return 'trail_fail';
                }
            },
            // Original trail_success text is now for Bones or no crew (no cargo)
            'trail_success': {
                title: "Hidden Signs",
                text: "You struggle through the thorns but emerge near a hidden cove, overlooking a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "The trail was tough, but we found a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    // RE-IMPLEMENTED BASE CHAOS GAIN
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            // NEW SCENE for Talon's specific success (acquiring cargo)
            'trail_success_talon': {
                title: "Smuggler's Route",
                text: "Talon guides your movement, emphasizing silence and observation. You emerge near a hidden cove, spotting a marked crate abandoned near the tideline. You grab it just before noticing a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "Talon's skill led me through the brush. Found some mysterious Cargo and reached a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    // RE-IMPLEMENTED BASE CHAOS GAIN
                    state.influence = Math.min(20, state.influence + 4); 
                    if (!state.inventory.includes("Curious Cargo")) {
                        state.inventory.push("Curious Cargo");
                        return "Found Curious Cargo. Secrets Learned (Chaos +4).";
                    }
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'trail_fail': {
                title: "Lost",
                text: "The undergrowth fights you. You stumble out of the brush, loud and covered in burrs, right in front of a Royal Guard.",
                journal: "Tried the hidden path, but made too much noise. Stumbled right into a Guard.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Scratch Damage."; 
                },
                choices: [
                    { text: "Confront the Guard", nextScene: 'road_encounter', type: 'dialogue' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'trail_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ] 
            },
            'guard_talk': {
                title: "The Interrogation",
                text: "The Guard eyes your ragged clothes. 'You look like wreckage refuse. We have reports of smugglers. Make it worth my while, or I'll haul you in.'",
                journal: "The Guard is corrupt. He wants a bribe or a reason to let me go.",
                banter: {
                    'gareth': "Stand tall. Authority respects strength, or gold."
                },
                choices: [
                    { text: "Bribe him", nextScene: 'guard_bribe', type: 'action', cost: 5 }, 
                    // Order Gain Choice
                    { text: "Show Respect", nextScene: 'guard_respect', type: 'dialogue', orderGain: 4 },
                    { text: "Intimidate him", nextScene: 'guard_intimidate_check', type: 'skill', dc: 13, skill: 'Insight' }, // Clean text
                    { text: "Attack", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
			'guard_respect': {
                title: "Order and Law",
                text: "You salute with practiced discipline. 'Just a shipwrecked sailor, sir. Keeping to the road.' The Guard straightens, recognizing the posture. 'Carry on then. And take theseget yourself a warm meal.' He flicks two silver coins at you.",
                journal: "Played the part of the good sailor. Saluted the uniform, not the man. It worked. Order has its uses, even if it tastes like bile.",
                onEnter: (state) => {
                    // APPLY NEGATIVE INFLUENCE SHIFT (Order)
                    state.influence = Math.max(-20, state.influence - 4); 
                    state.shillings += 2; // Add 2 Shillings
                    audioManager.playCoins();
                    return "Showed Respect (+4 Order). Received 2 Shillings.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'guard_bribe': {
                title: "The Toll",
                text: "He bites the gold. 'Get moving. Head to the Market, don't linger here.'",
                journal: "Paid the toll. I played the game and walked away unscathed.",
                onEnter: (state) => { 
                    audioManager.playCoins();
                    return "Bribed Guard (Neutral Act)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'guard_intimidate_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    let finalRoll = roll;
                    
                    // Passive Bonus: Captain's Tricorn (+1 Intimidation)
                    if (state.inventory.includes("Captain's Tricorn")) {
                        finalRoll += 1;
                        // Passing 'roll' as the type makes this text Blue/Spectral to match the dice log
                        addToHistory(`Passive Bonus (Captain's Tricorn): +1. Final Result: ${finalRoll}`, 'roll');
                    }
                    
                    return finalRoll >= 13 ? 'guard_scared' : 'combat_guard';
                }
            },
            'guard_scared': {
                title: "Spectral Fear",
                text: "You channel Gareth's command. Your eyes flare with pale light. The Guard stumbles back, terrified. 'Go! Just go!'",
                journal: "Gareth spoke through me. The Guard fled in terror.",
                onEnter: (state) => { 
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Guard Terrified (Chaos +4)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'combat_guard': {
                title: "The Clash",
                text: "He unhooks a heavy warhammer from his belt. You move to intercept him, driving the momentum into a brutal close-quarters struggle. You barely deflect the crushing weight of his strikes, fighting until he finally falls. You survive, but you are now an enemy of the crown.",
                journal: "Had combat the Guard. I am an outlaw now.",
                onEnter: (state) => { 
                    audioManager.playClash();
                    let minDmg = 10;
                    let varDmg = 6;
                    
                    // Passive Bonus: Rusted Cutlass (Reduces Damage)
                    if (state.inventory.includes("Rusted Cutlass")) {
                        minDmg = 6; // Reduced base damage
                        addToHistory("Passive: Cutlass reduced combat damage.", 'system');
                    }
                    
                    const dmg = Math.floor(Math.random() * varDmg) + minDmg; 
                    state.currentHP = applyDamage(state.currentHP, dmg);
                    fxManager.flashRed(); 
                    state.influence = 20; // Max Chaos
                    return `Took ${dmg} damage. Became Outlaw (Max Chaos).`;
                },
                choices: [{ text: "Limp to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_meet': {
                title: "The Cove",
                text: "The men draw blades as you approach. 'One step closer and you're fish food!'",
                journal: "Found the smugglers. They aren't friendly.",
                choices: [
                    // FIX: Changed type to 'dialogue' for max visibility of conditional travel
                    { text: "Flash 'The Mariner's Sign'", nextScene: 'smuggler_friend', type: 'dialogue', reqSmuggler: 3 },
                    // FIX: Ensure 'Curious Cargo' button is only available if player has the item (reqItem is the correct check here)
                    { text: "Offer Curious Cargo", nextScene: 'smuggler_cargo', type: 'action', reqItem: 'Curious Cargo', chaosGain: 6 },
                    { text: "Buy safe passage", nextScene: 'smuggler_pay', type: 'action', cost: 5 },
                    { text: "Run to Market", nextScene: 'market_crossroads', type: 'dialogue' }
                ]
            },
            // SMUGGLER TRADE SCENE (Chaos Only, No Coin)
            'smuggler_cargo': {
                title: "A Smuggler's Trust",
                text: "The lead smuggler inspects the crate, nodding slowly. 'This is high-value. You've earned our trust, Mariner. Your loyalty is payment enough.'",
                journal: "Traded Curious Cargo directly to the smugglers.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0; // Consume merchant's willingness to buy this type of cargo
                    state.influence = Math.min(20, state.influence + 6); // High Chaos gain
                    return "Gave Cargo. Chaos +6.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_friend': {
                title: "Old Alliances",
                text: "They recognize the sign. 'The Mariner lives? Then you drink for free tonight.' They toss you a bottle from their own supply.",
                journal: "The smugglers recognized the code. Shared their Rum.",
                onEnter: (state) => {
                     state.inventory.push("Rum");
                     return "Received Rum.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_pay': {
                title: "Business",
                text: "They take the coin. 'Don't let the Guard see you.'",
                journal: "Paid the toll. I played the game and walked away unscathed.",
                onEnter: (state) => {
                    audioManager.playCoins();
                    return "Paid Smugglers.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'market_crossroads': {
                title: "The Crossroads", // RENAMED TO AVOID HUB CONFUSION
                text: "You arrive at a ramshackle market outside of the port town. You can buy basic supplies here, or push on toward the Lighthouse.",
                journal: "Reached the a small Market. I should stock up before the final push.",
                choices: [
                    { text: "Visit the Market Merchant", nextScene: 'market_stall', type: 'travel' },
                    { text: "Head to the Lighthouse", nextScene: 'lighthouse_split', type: 'travel' }
                ]
            },
            'market_stall': {
                title: "The Merchant",
                text: "A hooded figure displays goods on a crate. 'Coin for survival, traveler?'",
                journal: null,
                // --- LOCAL STOCK DEFINITION ---
                stock: {
                    "Healing Potion": 1,
                    "Rope": 1,
                    "Torch": 1,
                    "Curious Cargo": 1, // Logic: He wants to BUY 1. He does not sell this.
                    "Rum": 0 // Starts at 0. He only sells it if you sell him one first.
                },
                // --- END LOCAL STOCK ---
                banter: {
                    'quinn': "Buy what you can, but we need inventory, not junk."
                },
                // FIX 1: Initial choices defined here, rendered by renderChoices
                choices: [
                    { text: "Sell Wares", nextScene: 'market_sell', type: 'travel', doomCost: 0 }, 
                    { text: "Leave", nextScene: 'market_crossroads', type: 'travel', doomCost: 0 }
                ]
            },
            'market_sell': {
                title: "The Merchant - Selling",
                text: "The merchant eyes your gear. 'I can take some of that off your hands for a fair price.'",
                journal: null,
                // FIX 1: Initial choices defined here, rendered by renderChoices
                choices: [
                    { text: "Back to Buying", nextScene: 'market_stall', type: 'travel', doomCost: 0 }
                ]
            },
            // Merchant Sale Scene (Coin Only, No Influence)
            'sell_cargo': {
                title: "The Transaction",
                text: "The merchant accepts the crate without comment, paying the agreed price.",
                journal: "Sold the Curious Cargo for coin.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0; // Consume merchant's willingness to buy this type of cargo
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+10s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_rope': {
                title: "Sold",
                text: "You hand over the rope.",
                journal: "I sold the rope.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rope");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2;
                    scenes['market_stall'].stock["Rope"] = (scenes['market_stall'].stock["Rope"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Rope (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_torch': {
                title: "Sold",
                text: "You hand over the torch.",
                journal: "I sold the torch.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Torch");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 1;
                    scenes['market_stall'].stock["Torch"] = (scenes['market_stall'].stock["Torch"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Torch (+1s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_potion': {
                title: "Sold",
                text: "You hand over the potion.",
                journal: "I sold the potion.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 3;
                    scenes['market_stall'].stock["Healing Potion"] = (scenes['market_stall'].stock["Healing Potion"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Potion (+3s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_rum': {
                title: "Sold",
                text: "You hand over the bottle of rum.",
                journal: "I handed over the bottle of rum.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rum");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2; 
                    scenes['market_stall'].stock["Rum"] = (scenes['market_stall'].stock["Rum"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Rum (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            // NEW SCENE: buy_rum (for dynamic repurchasing)
             'buy_rum': {
                title: "Purchase",
                text: "You exchange coin for the bottle of grog.",
                journal: "I bought a bottle of rum.",
                onEnter: (state) => { 
                    state.inventory.push("Rum"); 
                    scenes['market_stall'].stock["Rum"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Rum."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_potion': {
                title: "Purchase",
                text: "You exchange coin for the red liquid.",
                journal: "I bought a healing potion.",
                onEnter: (state) => { 
                    state.inventory.push("Healing Potion"); 
                    scenes['market_stall'].stock["Healing Potion"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Potion."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_rope': {
                title: "Purchase",
                text: "You coil the sturdy hemp rope over your shoulder.",
                journal: "I bought a coil of rope.",
                onEnter: (state) => { 
                    state.inventory.push("Rope"); 
                    scenes['market_stall'].stock["Rope"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Rope."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_torch': {
                title: "Purchase",
                text: "A simple torch, dipped in pitch.",
                journal: "I bought a torch.",
                onEnter: (state) => { 
                    state.inventory.push("Torch"); 
                    scenes['market_stall'].stock["Torch"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Torch."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'lighthouse_split': {
                title: "The Final Approach",
                text: "The Lighthouse stands atop a jagged cliff. Two paths present themselves: a sheer climb up the rock face, or a dark, winding tunnel through the sea caves below.",
                journal: "Two ways to the top: climb the cliff or brave the dark caves.",
                choices: [
                    { text: "Climb the Cliff", nextScene: 'cliff_climb', type: 'travel' },
                    { text: "Enter the Sea Caves", nextScene: 'dark_caves', type: 'travel' }
                ]
            }, 
			'cliff_climb': {
				title: "The Precipice",
				text: "The wind howls, threatening to tear you from the rock. The Lighthouse is a sheer vertical ascent from here. The stone is slick with sea-spray and blood from previous climbers.",
				journal: "The cliff was a wall of jagged teeth. One slip and I'd join the wreck below. Gareth was screaming at me to push through the pain, to climb until my fingers bled.",
				banter: {
					'gareth': "Pull yourself up, or the sea takes us back!" // Hints at Athletics DC 14
				},
				choices: [
					{ text: "Use Rope (Safe Climb)", nextScene: 'faction_check', type: 'action', reqItem: 'Rope', consume: true },
					{ text: "Free Solo", nextScene: 'climb_check', type: 'skill', dc: 14, skill: 'Athletics' }
				]
			},
            'climb_check': {
                isLogic: true,
                // FIX: Direct successful roll to faction_check
                resolve: (roll) => roll >= 14 ? 'faction_check' : 'climb_fail'
            },
            'climb_fail': {
                title: "Slip and Fall",
                text: "You slide twenty feet, shredding skin against stone before catching a root.",
                journal: "Almost fell to my death. Climbing without rope was foolish.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 5); 
                    fxManager.flashRed();
                    return "Took 5 Damage."; 
                },
                // Redirects to lighthouse_arrival to proceed to faction_check
                choices: [
                    { text: "Keep Climbing (Arrive at Lighthouse)", nextScene: 'lighthouse_arrival', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'lighthouse_arrival', // Redirect to success-like path
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'dark_caves': {
                title: "The Abyss Below",
				text: "The air is thick and smells of rot. It is pitch black. You can hear things skittering on the damp stone, but you cannot see them.",
				journal: "The caves felt heavy, like the stone was trying to push the air out of my lungs. Bones told me to close my eyes and smell the way forward.",
                banter: {
                    'bones': "Your eyes are useless here. Damp... dark... good place for mushrooms, bad for ankles."
                },
                choices: [
                    { text: "Light Torch (Safe Passage)", nextScene: 'dark_caves_illuminated', type: 'action', reqItem: 'Torch', consume: true },
                    { text: "Stumble in Dark", nextScene: 'dark_check', type: 'skill', dc: 14, skill: 'Perception' } // Clean text
                ]
            },
            // Updated Mushroom Scene
            'dark_caves_illuminated': {
                title: "Torch's End",
                text: "The damp, choking air of the caves extinguishes your torch within minutes, plunging you into darkness. But then, a pale glow reveals itself. A patch of smooth mushrooms provides an eerie illumination. You remember Bones's banter and collect the specimen for its promised clarity.",
                journal: "The torch died in the damp air, but I found the Pearlescent Mushroom by its own light.",onEnter: (state) => {
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found: Pearlescent Mushroom.";
                    }
                    return "Torch expended.";
                },
                // FIX: Direct successful path to faction_check
                choices: [{ text: "Proceed to Exit (Arrive at Lighthouse)", nextScene: 'faction_check', type: 'travel' }]
            },
            'dark_check': {
                isLogic: true,
                // FIX: Direct successful roll to faction_check
                resolve: (roll) => roll >= 14 ? 'faction_check' : 'dark_fail'
            },
            'dark_fail': {
                title: "Unseen Dangers",
                text: "In the dark, you trip over unseen rocks and twist your ankle. Something scuttles away in the shadows.",
                journal: "The caves were too dark. I got hurt.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 4); 
                    fxManager.flashRed();
                    return "Took 4 Damage."; 
                },
                // Redirects to lighthouse_arrival to proceed to faction_check
                choices: [
                    { text: "Limp to the Exit", nextScene: 'lighthouse_arrival', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'lighthouse_arrival', // Redirect to success-like path
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'lighthouse_arrival': {
                title: "The Beacon",
                text: "You reach the heavy iron doors of the Lighthouse. But you are not alone.",
                journal: "Made it to the Lighthouse doors. Someone is waiting.",
                choices: [
                    // This button is necessary for flow from fail states (climb_fail/dark_fail)
                    { text: "Confront them", nextScene: 'faction_check', type: 'travel' }
                ]
            },
            'faction_check': {
                isLogic: true,
                resolve: (r, state) => {
                    if (state.influence <= -4) return 'ending_order'; 
                    if (state.influence >= 4) return 'ending_chaos'; 
                    // Neutral path now leads to the skill check scene for testing
                    return 'ending_neutral_check'; 
                }
            },
            'ending_order': {
                title: "Checkpoint: The Deputy", // RENAMED
                text: "A squad of Royal Guards stands at the door, pikes grounded. Their captain steps forward, his gauntlet striking his breastplate in a sharp salute. 'We have eyes on the road, citizen. In a land governed by rot, you kept to the code. The Lighthouse is yours to secure, Deputy.' They part ranks, granting you passage with the discipline of a king's court.",
                journal: "The Guards respect me. They let me pass without question. Order has its uses.",
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
			'ending_chaos': {
                title: "Checkpoint: Smuggler's Ally", // RENAMED
                text: "Smugglers lounge by the entrance. 'The Mariner lives? Then you drink for free tonight.' They toss you a key.",
                journal: "The smugglers see me as one of their own. They gave me the key.",
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral_check': {
                title: "Checkpoint: The Locked Door", // RENAMED
                text: "The clearing is empty. The presence you sensed was only the crew's anticipation screaming in your mind. There is no welcome partyjust the wind and a barred door. You must find a way to breach the lock alone.",
                journal: "The Lighthouse is sealed. I need to find the mechanism to enter.",
                choices: [
                    // Insight DC 15 (Captain Gareth)
                    { text: "Analyze the mechanism", nextScene: 'neutral_lock_logic', type: 'skill', dc: 15, skill: 'Insight' }, // Clean text
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'ending_neutral_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'neutral_lock_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'ending_neutral_success' : 'ending_neutral_fail'
            },
            'ending_neutral_success': {
                title: "Checkpoint: The Shadow Entrance", // RENAMED
                // Updated narrative text to reference Gareth
                text: "Captain Gareth's voice is calm, analyzing the door's weak points instantly. The ancient mechanism bows to your superior insight, and the heavy bolt slides back. You slip inside, unseen and unopposed.",
                journal: "I forced the lock open and entered the lighthouse. Nobody saw me.",
                // REDIRECTED to Lighthouse Vigil
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral_fail': {
                title: "Checkpoint: The Shadow Fails", // RENAMED
                text: "Your attempt to understand the mechanism jams the lock further. The noise echoes in the wind, and you must hurry before someone investigates. You quickly force the door, abandoning subtlety.",
                journal: "I failed the mechanism check. I forced the door and entered the lighthouse.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Damage (Hurry)."; 
                },
                // REDIRECTED to Lighthouse Vigil
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'lighthouse_vigil': {
                title: "Charting Course",
                text: "The lighthouse lamp cuts a bright path through the dark, but your gaze is fixed on the water-warped pages of the Ship's Log. The ink has run on the coordinates, but Gareth's handwriting remains clear on the final pagethe lyrics to the 'Wolf King's Toll'.<br><br>The bickering voices in your mind fall silent. Then, softly, they begin to hum the melody in unison. It is not a myth; it is a map. To ferry your crew to the afterlife, you must locate these lost artifacts known as the Wolves of Valor.",
                journal: null,
                isRest: true, // Tag as rest scene to prevent doom counter decrement
                onEnter: (state) => {
                    // UPDATED SHANTY TEXT TO INCLUDE ALL VERSES
                    const shanty = `The shanty holds the truth. I must find the Ring and the Blade to save my crew. I am the Captain now.<br><br>
                      <i class='spectral-text-glow'>Theres a tax for the coin and a tax for the bread,<br>
                      But who pays the toll for the army of dead?<br>
                      The Wolf King did, so the legends say,<br>
                      To call back the souls who lost their way.<br><br>
                      He found the Ring of ancient Brass,<br>
					  And the Blade that lets no Vampire pass.<br>
                      He gave them a home and a people to keep,<br>
                      And woke the crew from their deep cold sleep.<br><br>
                      The dead stood fast 'til the war was won,<br>
                      Then vanished like mist in the morning sun.<br>
                      Now the Ring and the Blade are lost at sea,<br>
                      Waiting for a Captain as cursed as he.</i>`;
                    
                    addToHistory(shanty, 'entry');
                    
                    // HP CLAMPING FIX: Only reset HP if current is below max
                    if (state.currentHP < state.maxHP) {
                        state.currentHP = state.maxHP;
                    }
                    
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    // NEW: Docks work exhaustion reset
                    state.docksWorkCount = 0;
                    return "Mission Accepted: Find the Wolves of Valor. HP and Crew Use Restored.";
                },
                choices: [
                    // MODIFIED: Leads to the Captain's Orders choice scene
                    { text: "Ask the Crew for Final Orders", nextScene: 'captain_orders', type: 'dialogue' } 
                ]
            },
            // --- NEW SCENE: CAPTAIN'S ORDERS ---
            'captain_orders': {
                title: "The Captain's Orders",
                text: "Before you descend into the Port of Shadows, the crew manifests in the lantern's light. They know the odds. Each offers a final, unique advantage, but you have the focus to maintain only one. Choose who to listen to.",
                journal: "The crew offered their aid. I had to choose a permanent advantage for Act 1.",
                choices: [
                    { 
                        text: "Gareth: 'Violence of Action' (First Combat has Advantage)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.isSurpriseRound = true; 
                            return "Gareth's tactical advice grants a free Surprise Round on the first boss."; 
                        }
                    },
                    { 
                        text: "Bones: 'The Last Meal' (Overheal to 25/20 HP)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            // FIX 3: Overheal logic: Set currentHP to 25. MaxHP remains 20.
                            state.currentHP = MAX_OVERHEAL_CAP; 
                            return "Bones prepared a feast. Overhealed to 25 HP."; 
                        }
                    },
                    { 
                        text: "Quinn: 'Logistical Mapping' (Reveal Doom Costs)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.quinnLogistics = true; 
                            return "Quinn mapped the city. Doom Costs are now visible on all choices."; 
                        }
                    },
                    { 
                        text: "Talon: 'Forward Recon' (Unlock Secret Paths)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.knowsSmelterSecret = true; 
                            state.knowsChapelSecret = true; 
                            return "Talon scouted ahead. Smelter and Chapel shortcuts unlocked."; 
                        }
                    }
                ]
            },
            // --- END NEW SCENE ---
			// REMOVED 'lighthouse_rest' SCENE
            // --- ACT 1: LEVEL UP SEQUENCE (SKILL UNLOCK) ---
            'lighthouse_morning': {
                title: "The First Morning",
                text: "The chaotic surge of power that courses through you is threatening to splinter your mind. You pull the **Compass** from your beltits needle is violently vibrating, demanding command. You must give the raw planar energy shape by focusing entirely on a single technique. **This choice is absolute.** The path you forge now is permanent, Mariner; it will determine your strength and define the immediate danger you face in the Port of Shadows.",
                journal: "The crew warned me of Fire and Shadow. I must choose how to prepare.",
                banter: { // Now uses the built-in Banter system
                    'gareth': "The town is bleeding. Fire and ruin in the Smelter District.",
                    'talon': "Things that refuse to stay dead hide in the fog of the Sunken Chapel."
                },
                choices: [
                    { 
                        text: "Learn to Endure (Absorb Elements)", 
                        nextScene: 'learn_absorb', 
                        type: 'dialogue',
                        customClass: 'btn-fire-glow' // NEW: Custom Class for Fire Style
                    }, 
                    { 
                        text: "Learn to See (Primeval Awareness)", 
                        nextScene: 'learn_primeval', 
                        type: 'dialogue',
                        customClass: 'btn-shadow-glow' // NEW: Custom Class for Shadow Style
                    }
                ]
            },
            'learn_absorb': {
                title: "Gareth's Lesson",
                text: "Gareth grips your shoulder. 'Fire burns only if you let it in. Capture it.' You feel a cold resilience settle in your veins. You understand now how to turn the elements against themselves.",
                journal: "I learned Absorb Elements. I am ready for the fire.",
                onEnter: (state) => {
                    if (!state.skills.includes("Absorb Elements")) {
                        state.skills.push("Absorb Elements");
                    }
                    // FIX 2: If HP is greater than max HP (20), keep it (overheal persistence)
                    if (state.currentHP > state.maxHP) {
                        // HP persists, maxHP remains 20
                    } else {
                         state.currentHP = state.maxHP; // Clamp to max if below
                    }
                    // NEW: START DOOM COUNTER
                    state.act1Started = true;
                    return "Unlocked: Absorb Elements. HP checked. Act 1 Commencing.";
                },
                // MODIFIED: Jump to the new Cliffside Overlook scene
                choices: [{ text: "Descend to the Town", nextScene: 'cliffside_overlook', type: 'travel' }]
            },
            'learn_primeval': {
                title: "Talon's Lesson",
                text: "Talon covers your eyes. 'The dead leave a wake in the ether. Look with your mind.' When you open your eyes, the world hums with hidden outlines. The unseen is now visible to you.",
                journal: "I learned Primeval Awareness. The undead cannot hide from me.",
                onEnter: (state) => {
                    if (!state.skills.includes("Primeval Awareness")) {
                        state.skills.push("Primeval Awareness");
                    }
                    // FIX 2: If HP is greater than max HP (20), keep it (overheal persistence)
                    if (state.currentHP > state.maxHP) {
                        // HP persists, maxHP remains 20.
                    } else {
                        state.currentHP = state.maxHP; // Clamp to max if below
                    }
                    // NEW: START DOOM COUNTER
                    state.act1Started = true;
                    return "Unlocked: Primeval Awareness. HP checked. Act 1 Commencing.";
                },
                // MODIFIED: Jump to the new Cliffside Overlook scene
                choices: [{ text: "Descend to the Town", nextScene: 'cliffside_overlook', type: 'travel' }]
            },
            // --- NEW SCENE: CLIFFSIDE OVERLOOK ---
            'cliffside_overlook': {
                title: "Cliffside Overlook",
                text: "The path winds along the sheer cliff face, providing a terrifying view of the Port of Shadows below. You see the chaos: smoke rising from the **Smelter** and a thick, unnatural fog shrouding the **Chapel** district. You must decide whether to scan the area for threats or hasten your descent.",
                journal: "Reached the overlook. The Port is a warzone. Must be cautious.",
				banter: {
						'talon': "Wait. Look at the shadows near those rocks. People leave valuable things behind when they run.", // Hints at Perception DC 14
						'gareth': "We don't have time to scavenge like rats! Move your feet!" // Hints at Athletics DC 10
					},
                choices: [
                    { 
                        text: "Scan the Road for Guards and Loot", // Clean text
                        nextScene: 'overlook_scan_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Perception' 
                    },
                    { 
                        text: "Hasten Descent", // Clean text
                        nextScene: 'overlook_hasten_check', 
                        type: 'skill', 
                        dc: 10, 
                        skill: 'Athletics',
                        doomCost: 0 // NO DOOM COST
                    }
                ]
            },
            'overlook_scan_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'overlook_scan_success' : 'overlook_hasten_fail'
            },
            'overlook_scan_success': {
                title: "Talon's Eye",
                text: "Talon guides your focus. You spot a discarded pack near a large rock formationa traveler was robbed or fled quickly. It holds a small but valuable Silver Locket.",
                journal: "Talon spotted a discarded Locket. Easy coin.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Silver Locket")) {
                        state.inventory.push("Silver Locket");
                        return "Found Silver Locket.";
                    }
                    return "Found nothing else of value.";
                },
                choices: [{ text: "Continue Descent", nextScene: 'town_descent', type: 'travel' }]
            },
            'overlook_scan_fail': {
                title: "Blinded by the View",
                text: "You stumble over loose scree and fall awkwardly, twisting your knee slightly.",
                journal: "Failed the scan. Must be more careful.",
                choices: [
                    { text: "Continue Descent", nextScene: 'town_descent', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'overlook_scan_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'overlook_hasten_check': {
                isLogic: true,
                resolve: (roll) => roll >= 10 ? 'town_descent' : 'overlook_hasten_fail'
            },
            'overlook_hasten_fail': {
                title: "A Misplaced Step",
                text: "You stumble over loose scree and fall awkwardly, twisting your knee slightly.",
                journal: "Hasted descent failed. Took minor damage.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 2);
                    fxManager.flashRed();
                    return "Took 2 Damage.";
                },
                choices: [
                    { text: "Reach the Gates", nextScene: 'town_descent', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'town_descent', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            // --- END NEW SCENES ---
            
            'town_descent': {
				title: "The Descent",
				text: "You arrive at the main city gate. The chaos here is raw. Your Compass vibrates violently, the needle splitting in two. One ghostly needle glows <span class='text-orange-500'>Orange</span> toward the Smelter. The other turns <span class='text-gray-500'>Black</span> toward the Chapel.",
				journal: "The Compass cracked. It's pulling me apart. Smelter fire to the East, Chapel fog to the West. Gareth is rightI can't save everyone. I have to choose.",
				banter: {
					'gareth': "Hold fast! A Captain who chases two headings sails in circles! Choose a target, Mister Jones. Fire or Fogpick your poison!"
				},
                choices: [
                    { text: "Enter the Port of Shadows", nextScene: 'town_square', type: 'travel' }
                ]
            },
            'town_square': {
                title: "Port of Shadows",
                text: "", // Dynamic text populated by onEnter
                choices: [
                    { 
                        text: "Investigate Smelter District", 
                        nextScene: 'smelter_entry', 
                        type: 'travel', 
                        reqNotItem: 'Sword of Valor', // Blade from Fire Path
                        customClass: 'btn-fire-glow' 
                    },
                    { 
                        text: "Investigate Sunken Chapel", 
                        nextScene: 'chapel_entry', 
                        type: 'travel',
                        reqNotItem: 'Ring of Brass', // Ring from Shadow Path
                        customClass: 'btn-shadow-glow'						
                    },
                    { text: "Visit The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                    { text: "Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                    { text: "Explore the Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 } // NEW DOCKS BUTTON
                ],
                onEnter: (state) => {
                    const hasRing = state.inventory.includes("Ring of Brass");
                    const hasBlade = state.inventory.includes("Sword of Valor");
                    
                    // Base choices for the hub
                    let newChoices = [
                        { 
                            text: "Investigate Smelter District", 
                            nextScene: 'smelter_entry', 
                            type: 'travel', 
                            reqNotItem: 'Sword of Valor', // Blade from Fire Path
                            customClass: 'btn-fire-glow' 
                        },
                        { 
                            text: "Investigate Sunken Chapel", 
                            nextScene: 'chapel_entry', 
                            type: 'travel',
                            reqNotItem: 'Ring of Brass', // Ring from Shadow Path
                            customClass: 'btn-shadow-glow' 
                        },
                        { text: "Visit The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                        { text: "Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                        { text: "Explore the Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 } // NEW DOCKS BUTTON
                    ];

                    // STATE 2: FINALE UNLOCKED - Remove exploration choices, force ritual preparation
                    if (hasRing && hasBlade) {
                        scenes['town_square'].text = "The Rift is tearing the sky apart. Violet lightning strikes the cobblestones. You have the Ring and the Blade. The Wolf King's ritual is the only way to close this wound.";
                        newChoices = [
                            { text: "Prepare the Wolf King's Ritual", nextScene: 'finale_ritual_start', type: 'combat', customClass: 'btn-hero' },
                            { text: "Visit Madam Alara, The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                            { text: "Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                            // ADDED DOCKS BACK FOR LATE-GAME TRADING/HEALING
                            { text: "Explore the Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 } 
                        ];
                        scenes['town_square'].choices = newChoices;
                        return "Finale Unlocked.";
                    }
                    
                    // Dynamic Text Logic
                    if (hasRing) {
                        scenes['town_square'].text = "You return with the Ring of Brass. Fog from the Sunken Chapel is flooding the streets, choking the light. The Shadow threat has escalated while you were away. You must pursue the Fire Path now.";
                    } 
                    else if (hasBlade) {
                        scenes['town_square'].text = "You return with the Sword of Valor. Ash falls from the Smelter District like gray snow. The Fire threat has escalated while you were away. You must pursue the Shadow Path now.";
                    } 
                    else {
                        scenes['town_square'].text = "The Port is in chaos. Civilians flee toward the docks. To the East, the Smelter District burns with an unnatural heat. To the West, the Sunken Chapel lies in a pool of dark fog. Your Compass tracks both.";
                    }
                    
                    // Filter choices based on acquired items
                    scenes['town_square'].choices = newChoices.filter(choice => {
                        // Hide Fire Path if Blade is acquired (unless it's the Ritual scene)
                        if (choice.nextScene === 'smelter_entry' && hasBlade) return false;
                        // Hide Shadow Path if Ring is acquired
                        if (choice.nextScene === 'chapel_entry' && hasRing) return false;
                        return true;
                    });
                    
                },
                // Choices now generated in onEnter
            },
            
            // --- NEW HUB SCENES ---
            // DOCKS SCENE (NEW) - Includes dynamic cost calculation
            'town_docks': {
                title: "The Rotting Docks",
                text: "The sea is black and restless. The remains of piers stretch into the cold water. Sailors work in silence, hauling heavy crates, trying to ignore the end of the world. You see a shifty-eyed <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smuggler</span> checking his manifest.",
                journal: "The piers were rotting under our feet. The sailors worked with their heads down, terrified. Bones thought the water looked cold enough to kill.",
				banter: {
					'bones': "That water's cold enough to stop a heart. If you're going diving for lost coin, you better have the lungs of a whale.", // Hints at Survival DC 16
					'talon': "Smugglers love false bottoms and hidden knots. Look closer..." // Hints at Perception DC 14
				},
                choices: [
                    // NEW CHOICE: Sell Curious Cargo directly here for a premium (+15s). This button is now handled by renderChoices visibility.
                    { text: "Sell Curious Cargo to Smuggler", nextScene: 'docks_sell_cargo', type: 'action', reqItem: 'Curious Cargo', value: 15, doomCost: 0 },
                    // WORK BUTTON (costHP: 2 is the base, adjusted in onEnter)
                    { text: "Work the Lines", nextScene: 'docks_work', type: 'action', costHP: 2, chaosGain: 1, shillingGain: 3, doomCost: 1 }, 
                    { 
                        text: "Dive for Sunken Treasure", 
                        nextScene: 'docks_dive_check', 
                        type: 'skill', 
                        dc: 16, 
                        skill: 'Survival',
                        doomCost: 1,
                        reqNotFlag: 'hasDivedTreasure' // FIX: Hides button only after success
                    },
                    { 
                        // FIX: Added reqNotFlag
                        text: "Search for Smuggler's Drop", 
                        nextScene: 'docks_smuggler_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Perception', 
                        reqItem: 'Ring of Brass', // Keen Senses check to find hidden goods
                        reqNotFlag: 'hasSearchedSmugglerDrop', // NEW: Hides after use
                        customClass: 'btn-keen-senses',
                        doomCost: 1
                    }, 
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    // NEW LOGIC: Calculate Progressive Cost and update the button for the UI
                    const workBtn = scenes['town_docks'].choices.find(c => c.nextScene === 'docks_work');
                    if (workBtn) {
                        // Base Cost (2) + Number of times worked previously
                        const exhaustion = state.docksWorkCount || 0;
                        workBtn.costHP = 2 + exhaustion;
                    }
                    return null;
                }
            },
            // NEW SCENE: DOCKS SELL CARGO (Premium Payout)
            'docks_sell_cargo': {
                title: "Smuggler's Trade",
                text: "The Smuggler nods approvingly at the quality of the cargo. 'Good eye, Mariner. Here's your cut, a little extra for your trouble.'",
                journal: "Sold the Curious Cargo to a Smuggler for a premium.",
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    // The payout is handled by the choice button logic (value: 15)
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+15s) to Smuggler.";
                },
            },
            // DOCKS WORK SCENE (NEW) - Increments the counter and reports the cost
            'docks_work': {
                title: "Hard Labor",
                text: "You haul crates and tie lines until your muscles ache and your hands blister.",
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    // Calculate what the cost WAS for this action (Base 2 + previous count)
                    const costPaid = 2 + (state.docksWorkCount || 0);
                    
                    // Increment the counter (used for next time's calculation)
                    state.docksWorkCount = (state.docksWorkCount || 0) + 1;
                    
                    audioManager.playCoins();
                    
                    // Note: Shillings/Chaos gain and HP damage are handled by the button click logic
                    // Report the values based on what was *just paid/gained*
                    return `Worked. Earned 3 Shillings. Took ${costPaid} HP (Exhaustion Level ${state.docksWorkCount}). Chaos +1.`;
                },
            },
            // NEW SCENE: DOCKS HIGH RISK DIVE
            'docks_dive_check': {
                isLogic: true,
                resolve: (roll) => roll >= 16 ? 'docks_dive_success' : 'docks_dive_fail'
            },
            'docks_dive_success': {
                title: "The Gilded Chest",
                text: "You hold your breath until your lungs burn, leveraging the dock pilings to dive deep. You surface with a watertight strongbox containing a pouch of gold and gemsenough to buy any artifact the Alchemist sells.",
                journal: "Risked the depths and found high-value treasure.",
                onEnter: (state) => {
                    state.hasDivedTreasure = true; // FIX: Lock the treasure so it can't be farmed
                    state.shillings += 15; 
                    audioManager.playCoins();
                    return "Found Gems (+15s).";
                },
                choices: [{ text: "Surface", nextScene: 'town_docks', type: 'travel', doomCost: 0 }]
            },
            'docks_dive_fail': {
                title: "The Undertow",
                text: "The current catches you, slamming you against the rotting pilings. You barely make it back to the surface, gasping and empty-handed.",
                journal: "The dive failed. Took damage from the current.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 4);
                    fxManager.flashRed();
                    return "Took 4 Damage.";
                },
                choices: [
                    { text: "Climb Out", nextScene: 'town_docks', type: 'travel' },
                     // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'docks_dive_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            // DOCKS SMUGGLER LOGIC (Ring of Brass required for button visibility)
            'docks_smuggler_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'docks_smuggler_success' : 'docks_smuggler_fail'
            },
            'docks_smuggler_success': {
                title: "Hidden Stash",
                text: "The Ring of Brass magnifies your senses. You catch the faint smell of brine and tar. Behind a pile of old nets, you find a small, consecrated bottle. Holy Watera counter to Fire.",
                journal: "Keen Senses worked. Found Holy Water, likely smuggled.",
                onEnter: (state) => {
                    state.hasSearchedSmugglerDrop = true; // Task 3 Fix: Set flag to prevent future use
                    if (!state.inventory.includes("Holy Water")) {
                        state.inventory.push("Holy Water");
                    }
                    return "Found Holy Water!";
                },
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }]
            },
            'docks_smuggler_fail': {
                title: "Nothing But Wood",
                text: "The search yields nothing but wet splinters. You wasted time.",
                journal: "The search was fruitless.",
                onEnter: (state) => {
                    state.hasSearchedSmugglerDrop = true; // Task 3 Fix: Set flag to prevent future use
                    return null;
                },
                choices: [
                    { text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'docks_smuggler_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            
            // TAVERN KEEN SENSES (NEW)
            'blackwater_tavern': {
				title: "The Blackwater Tavern",
				text: "The interior is dim, smelling of stale brine and fear. Men speak in hushed tones, glancing at the door. This is where the broken come to hide. Rest is costly, but information is sometimes free.",
				journal: "The Blackwater stank of defeat. But Quinn was rightthe walls have ears. I sat in the dark and listened to the dying city breathe.",
				banter: {
					'gareth': "That gambler in the corner... Watch his hands.", // Hints at Insight DC 16
				},
                isRest: true, // Tag as rest scene to prevent doom counter decrement
                stock: { // NEW STOCK FOR GRUEL
                    "Gruel": 5 
                },
                choices: [
                    // PAID REST OPTION (Task 3 Fix: Added doomCost: 3)
                    { text: "Pay for a Cot (Full Rest)", nextScene: 'tavern_rest_success', type: 'action', cost: 10, doomCost: 3 },
                    // NEW: EAT GRUEL (Instant Consume, checks HP)
                    { text: "Eat Gruel Now", nextScene: 'eat_gruel_instant', type: 'action', cost: 1, stockItem: 'Gruel', doomCost: 0 },
                    // NEW: BUY GRUEL (To Go, adds to inventory)
                    { text: "Buy Gruel (To Go)", nextScene: 'buy_gruel_to_go', type: 'action', cost: 1, stockItem: 'Gruel', doomCost: 0 },
                    // INFORMATION GATHERING
                    // Task 4 Fix: Added reqNotFlag
                    { 
                        text: "Listen to Engineer's Rumors (Smelter)", 
                        nextScene: 'gather_info_smelter', 
                        type: 'dialogue', 
                        reqNotFlag: 'knowsSmelterSecret',
                        doomCost: 1 // FIX: Dialogue/Action costs 1 turn in a hub
                    },
                    { 
                        text: "Listen to Gravedigger's Warnings (Chapel)", 
                        nextScene: 'gather_info_chapel', 
                        type: 'dialogue', 
                        reqNotFlag: 'knowsChapelSecret',
                        doomCost: 1 // FIX: Dialogue/Action costs 1 turn in a hub
                    },
                    { 
                        // FIX: Added reqNotFlag for visibility (Task 3 Fix)
                        // FIX: Updated button text to be concise. Added doomCost: 1
                        text: "Observe the Card Game", 
                        nextScene: 'tavern_gambler', 
                        type: 'action', 
                        reqItem: 'Ring of Brass',
                        reqNotFlag: 'hasObservedGambler', // NEW: Hides after use
                        customClass: 'btn-keen-senses',
                        doomCost: 1 // FIX: Action costs 1 turn in a hub
                    }, 
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            // NEW SCENE (Task 1): Eat Gruel (Instant consumption, checks HP)
            // Locate 'eat_gruel_instant' inside const scenes:

			'eat_gruel_instant': {
				title: "Gruel Consumed",
				text: "You take a moment to consume the cheap gruel. It settles your stomach, but barely.",
				journal: "I instantly consumed gruel for a small amount of healing.",
				onEnter: (state) => {
					// FIX: Check against state.maxHP (20), NOT MAX_OVERHEAL_CAP (25).
					// If the player has Spectral HP (e.g., 22 HP), this will now trigger, preserving the shield logic.
					if (state.currentHP >= state.maxHP) {
						state.shillings += 1; // Refund cost
						scenes['blackwater_tavern'].stock["Gruel"] += 1; // Refund stock
						audioManager.playCoins();
						return "Your natural health is full. The Gruel offers no benefit to your Spectral Shield. (Shilling refunded)";
					}
					
					const healAmount = 2;
					const oldHP = state.currentHP;
					
					// FIX: Cap healing at state.maxHP (20)
					state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
					
					return `Ate Gruel. Healed ${state.currentHP - oldHP} HP.`;
				},
				choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }]
			},
            // NEW SCENE (Task 1): Buy Gruel (To Go, adds to inventory)
            'buy_gruel_to_go': {
                title: "Gruel To Go",
                text: "The server slides you a small, sealed pouch of dried gruel.",
                journal: "I bought gruel to-go and added it to my inventory.",
                onEnter: (state) => { 
                    state.inventory.push("Gruel"); 
                    scenes['blackwater_tavern'].stock["Gruel"] -= 1; // Consume stock
                    // Note: Shilling is already consumed by the button logic (choice.cost: 1)
                    return "Bought Gruel (To Go). Added to Inventory.";
                },
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }]
            },
            'tavern_gambler': {
				title: "Keen Senses at the Table",
				text: "With the Ring's power, you hear itor rather, you don't. The man in the corner has no heartbeat. The cards slide into his sleeve with supernatural grace. He is a corpse playing at life. You confront him.",
				journal: "The Ring showed me a dead man winning a living man's game. The rot in this town goes deeper than the flooded cellars.",
                onEnter: (state) => {
                    state.hasObservedGambler = true; // Task 3 Fix: Set flag to prevent future use
                    return null; // Return null so the main text still shows the confrontation
                },
                choices: [
                    // FIX 3: Confiscate dice button is ONLY here
                    { 
                        text: "Confiscate the Dice (Neutral)", 
                        nextScene: 'tavern_confiscate_dice', 
                        type: 'action', 
                        reqNotItem: "Dead Man's Die",
                        doomCost: 0 
                    },
                    { text: "Blackmail him", nextScene: 'tavern_payout', type: 'action', chaosGain: 3, shillingGain: 10, doomCost: 0 },
                    { text: "Expose him", nextScene: 'tavern_expose_check', type: 'skill', dc: 16, skill: 'Insight', orderGain: 3, doomCost: 0 }, // Removed redundant skill text
                    { text: "Leave him alone", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }
                ]
            },
            // NEW SCENE: Confiscate Dice (FIX 4)
            'tavern_confiscate_dice': {
                title: "The Toll for a Cheater",
                text: "You silently relieve the corpse of his loaded bone die. He doesn't move to stop you; he merely smiles, his empty eyes following you to the door. A neutral act that may save your life.",
                journal: "Confiscated a Dead Man's Die from the gambler.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Dead Man's Die")) {
                        state.inventory.push("Dead Man's Die");
                    }
                    return "Found Dead Man's Die.";
                }
            },
            'tavern_payout': {
                title: "A Quiet Exchange",
                text: "The man's eyes flicker to the spectral light of your Ring. He slips a heavy purse into your hand without a word. He's gone before you can count it.",
                journal: "Blackmailed the undead gambler.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    // DOUBLE DIP FIX: Removed state.shillings += 10; and state.influence += 3;
                    audioManager.playCoins();
                    return "Blackmail Successful. +10 Shillings, Chaos +3.";
                },
            },
            'tavern_expose_check': {
                isLogic: true,
                resolve: (roll) => roll >= 16 ? 'tavern_expose_success' : 'tavern_expose_fail'
            },
            'tavern_expose_success': {
                title: "Justice Served",
                text: "Gareth's clear, authoritative voice rings in your mind. You slam your hand on the table and cite the exact law he broke. The man is forced to return his winnings and flees. Order is restored, and the others buy you a drink.",
                journal: "Exposed the cheater. Gained 3 Order influence.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    // DOUBLE DIP FIX: Removed state.influence -= 3;
                    return "Exposed Cheater. Order +3.";
                },
            },
            'tavern_expose_fail': {
                title: "Public Scorn",
                text: "You accuse the man, but your words are muddled. The other patrons laugh at you. The cheater remains, simply smiling.",
                journal: "Failed to expose the cheater. Embarrassing.",
                choices: [
                    { text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'tavern_expose_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'alchemist_triage': {
				title: "Madam Alara, Triage Alchemist",
				text: "Madam Alara, encased in her beaked mask, tends to the wounded with the cold efficiency of a butcher. She doesn't offer comfort, only chemistry. Her wares are potentshe deals only in true survival.",
				journal: "Madam Alara. She'd distill her own mother if it made a potent tonic. Her prices are robbery, but her potions might be the only reason I survive the night.",
				stock: {
                    "Vitality Tincture": 2,
                    "Smelling Salts": 3,
                    "Flash Powder": 1,
                    "Alchemical Fire": 1, 
                    "Holy Water": 1 
                },
                choices: [
                    // This choice is dynamically generated in renderChoices below
                    // { text: "Offer Strange Coin", nextScene: 'alchemist_secret_stock', type: 'action', reqItem: 'Strange Coin', consume: true, doomCost: 0 },
                    // FIX: DoomCost is 0 for navigation
                    { text: "Sell Wares", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            // NEW SCENE: Secret Coin Trade
            'alchemist_secret_stock': {
                title: "The Alchemist's Reserve",
                text: "Madam Alara takes the Strange Coina brass piece from an ancient kingdomand her head snaps up. 'I recognize this metal. It's from the kingdom of the Wolf King,' she hisses. 'You honor my trade. This Draft is my reserve, a single draught that cheats the ferryman. Use it wisely, Mariner.'",
                journal: "Traded the Strange Coin for the Alchemist's ultimate reserve: the Phoenix Draft.",
                choices: [
                    { text: "Return to Triage", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    if (!state.inventory.includes("Phoenix Draft")) {
                        state.inventory.push("Phoenix Draft");
                        return "Acquired Phoenix Draft.";
                    }
                    return null;
                }
            },
            'alchemist_sell': {
                title: "Triage Alchemist - Selling",
                text: "Alara inspects your items, sometimes offering a premium for rare components. 'Speak your price, Mariner. Time is coin.'",
                journal: null,
                choices: [
                    // FIX: DoomCost is 0 for navigation
                    { text: "Back to Buying", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            // NEW SELL SCENE: Selling the Locket
            'sell_locket_alch': {
                title: "Sentiment's Price",
                text: "Madam Alara cleans the silver locket with a sterile cloth. 'Sentiment holds value in chaos,' she remarks, sliding you the promised coin.",
                journal: "Sold the Silver Locket for 10 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Silver Locket");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Locket (+10s) to Alchemist.";
                },
            },
            // NEW BUY SCENES FOR ALCHEMIST STOCK (Boss Consumables)
            'buy_fire': {
                title: "Purchase",
                text: "The Alchemical Fire is hot to the touch. A deadly weapon for the Shadow path.",
                journal: "I purchased Alchemical Fire.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Alchemical Fire"); 
                    scenes['alchemist_triage'].stock["Alchemical Fire"] -= 1;
                    audioManager.playCoins();
                    return "Bought Alchemical Fire."; 
                },
            },
            'buy_water': {
                title: "Purchase",
                text: "The Holy Water is cold and consecrated. A deadly weapon for the Fire path.",
                journal: "I purchased Holy Water.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Holy Water"); 
                    scenes['alchemist_triage'].stock["Holy Water"] -= 1;
                    audioManager.playCoins();
                    return "Bought Holy Water."; 
                },
            },
            'buy_tincture': {
                title: "Purchase",
                text: "The Vitality Tincture burns cold in your hand.",
                journal: "I purchased a high-grade Vitality Tincture.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Vitality Tincture"); 
                    scenes['alchemist_triage'].stock["Vitality Tincture"] -= 1;
                    audioManager.playCoins();
                    return "Bought Tincture."; 
                },
            },
            'buy_salts': {
                title: "Purchase",
                text: "Smelling Salts. A desperate measure for desperate times.",
                journal: "I purchased Smelling Salts.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Smelling Salts"); 
                    scenes['alchemist_triage'].stock["Smelling Salts"] -= 1;
                    audioManager.playCoins();
                    return "Bought Smelling Salts."; 
                },
            },
            'buy_powder': {
                title: "Purchase",
                text: "Flash Powder. Quick, loud, and effective.",
                journal: "I purchased Flash Powder.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Flash Powder"); 
                    scenes['alchemist_triage'].stock["Flash Powder"] -= 1;
                    audioManager.playCoins();
                    return "Bought Flash Powder."; 
                },
            },
            'sell_potion_alch': {
                title: "Sold for Premium",
                text: "The Alchemist pays a premium for the components in your standard Potion.",
                journal: "Sold a Healing Potion for 4 Shillings to the Alchemist.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 4; // Higher value than market merchant (3s)
                    audioManager.playCoins();
                    return "Sold Potion (+4s) to Alchemist.";
                },
            },
             'sell_mushroom_alch': {
                title: "Sold for Premium",
                text: "The Alchemist recognizes the power in the Pearlescent Mushroom. 'A valuable specimen,' she murmurs.",
                journal: "Sold the Pearlescent Mushroom for 12 Shillings to the Alchemist.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 12; 
                    audioManager.playCoins();
                    return "Sold Mushroom (+12s) to Alchemist.";
                },
            },
            'sell_fire': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Alchemical Fire.",
                journal: "I sold the Alchemical Fire artifact for 20 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Alchemical Fire");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Alchemical Fire (+20s).";
                },
            },
            'sell_water': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Holy Water.",
                journal: "I sold the Holy Water artifact for 20 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Holy Water (+20s).";
                },
            },
            'sell_tincture': {
                title: "Sold Back",
                text: "The Alchemist buys back her own tincture at a loss.",
                journal: "Sold Vitality Tincture at a loss.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Vitality Tincture");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 7; 
                    // ITEM STOCK FIX: Increment Alchemist stock
                    scenes['alchemist_triage'].stock["Vitality Tincture"] = (scenes['alchemist_triage'].stock["Vitality Tincture"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Tincture (+7s).";
                },
            },
            'tavern_rest_success': {
                title: "A Night's Respite",
                text: "You find an empty cot in the dusty cellar. The gentle sway of your hoisted hammock lulls the bickering crew into a temporary, cohesive silence.",
                journal: "Paid 10 Shillings for a good night's rest. The voices are quiet.",
                isRest: true, // Tag as rest scene to prevent doom counter decrement
                choices: [
                    // FIX: doomCost 0 for travel from rest scene
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    // FIX 2: Do not reset currentHP to maxHP if the current HP is higher (overheal persistence)
                    if (state.currentHP < state.maxHP) {
                        state.currentHP = state.maxHP;
                    }
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    // NEW: Docks work exhaustion reset
                    state.docksWorkCount = 0;
                    return "Paid 10s. HP, Crew Use, and Exhaustion Restored.";
                },
            },
            // NEW: INFORMATION SCENES
            'gather_info_smelter': {
                title: "Smelter District Tip",
                text: "The exhausted engineer whispers, 'The release valves are rusted shut. Quinn's knowledge won't work unless you know the **counter-clockwise, double-turn** trick. That'll save your life.'",
                journal: "Learned the secret to bypassing the Smelter's Steam Hazard.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    state.knowsSmelterSecret = true;
                    return "New Information Gained (Smelter Path).";
                },
            },
            'gather_info_chapel': {
                title: "Sunken Chapel Tip",
                text: "The pale gravedigger warns you, 'Don't follow the sound; follow the silence. The paths are a maze, but the silent, **weeping angel statues** mark the safe, true route.'",
                journal: "Learned the safe route through the Sunken Chapel's Fog Maze.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    state.knowsChapelSecret = true;
                    return "New Information Gained (Chapel Path).";
                },
            },
            // --- END HUB SCENES ---

            // --- FIRE PATH SCENES ---
            'smelter_entry': {
                title: "Smelter District: Steam Vents",
                text: "The path is blocked by a burst steam pipe spitting magical fire. The main valve is screaming and rusted over. You need to use your abilities or brute force here.",
				journal: "The heat hit me like a hammer. The pipes were screaming. Quinn started shouting about torque and pressure, but Talon just pointed at the walls.",
                banter: {
					'quinn': "That valve isn't jammed; it's pressurized! Use your head, not your muscle!", // Hints at Investigation DC 15
					'talon': "Why fight the steam? That massive pipe network runs up the outside wall. It's steep, but if we have a rope, we can make it." // Hints at Rope
				},
                choices: [
                    // NEW CHOICE: ROPE SIDE QUEST (Task 2)
                    {
                        text: "Use Rope to Climb to Upper Catwalk",
                        nextScene: 'smelter_side_rope',
                        type: 'action',
                        reqItem: 'Rope',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 1: INFO CHECK (Automatic Success) - DOOM COST 0
                    { 
                        text: "Attempt Counter-Clockwise Double-Turn (Secret)", 
                        nextScene: 'smelter_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsSmelterSecret',
                        doomCost: 0,
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 2: HERO BUTTON (Absorb Elements) - DOOM COST 0
                    { 
                        text: "Channel Absorb Elements (Absorb Heat)", 
                        nextScene: 'smelter_boss_absorb_bridge', // FIXED: Points to bridge scene to set flag
                        type: 'action', 
                        reqSkill: 'Absorb Elements', 
                        doomCost: 0,
                        customClass: 'btn-fire-glow' 
                    },
                    // OPTION 3: SKILL CHECK (Quinn/Investigation) - DOOM COST 1 (Default)
                    { text: "Analyze & Attempt to Turn Valve", nextScene: 'smelter_roll', type: 'skill', dc: 15, skill: 'Investigation' }
                ]
            },
             // --- NEW LOGIC BRIDGE SCENES (CRITICAL FIX) ---
            'smelter_absorb_bridge': {
                isLogic: true,
                resolve: (roll, state) => {
                    state.isAbsorbCharged = true;
                    return 'smelter_safe';
                }
            },
			// NEW SCENE: Specific bridge for Boss Fight to break the loop
			'smelter_boss_absorb_bridge': {
				isLogic: true,
				resolve: (roll, state) => {
					state.isAbsorbCharged = true; // Set the flag for Stage 2
					return 'smelter_stage2_clean'; // Go directly to Stage 2, skipping the loop
				}
			},
            // FIX 3: Primeval bridge now skips straight to stage 2 completion scene
            'chapel_primeval_bridge': {
                isLogic: true,
                resolve: (roll, state) => {
                    state.isSurpriseRound = true;
                    return 'chapel_stage2_finish';
                }
            },
            // --- END LOGIC BRIDGE SCENES ---
            // ROPE SIDE QUEST REWARD
            'smelter_side_rope': {
                title: "Catwalk Bypass",
                text: "The Rope holds fast long enough for you to ascend quickly to the quieter upper catwalk, bypassing the deadly vents below. Tucked away in a maintenance crate, you find a glint of ancient metal: a Strange Coin.",
                journal: "Used Rope to bypass the vents. Found a Strange Coin and 5 Shillings.",
                choices: [{ text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' }],
                onEnter: (state) => { 
                    state.shillings += 5; // ADDED: 5 Shillings
                    audioManager.playCoins();

                    if (!state.inventory.includes("Strange Coin")) {
                        state.inventory.push("Strange Coin");
                        return "Rope consumed. Found Strange Coin and 5 Shillings!"; 
                    }
                    return "Rope consumed. Found 5 Shillings.";
                },
            },
            'smelter_safe': { 
                title: "Safe Passage", 
                text: "You pass safely.", 
                choices: [{ text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' }]
            },
            'smelter_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'smelter_safe' : 'smelter_damage' },
            'smelter_damage': { 
                title: "Burned", 
                text: "You take a burn running past the valve.", 
                choices: [
                    { text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'smelter_safe', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ],
                onEnter: (s) => { 
                    s.currentHP = applyDamage(s.currentHP, 5); 
                    fxManager.flashRed();
                    return "Took 5 Fire Damage."; 
                }, 
            },
            // --- NEW SCENE: SMELTER ANTECHAMBER (Order/Chaos Choice) ---
            'smelter_workers': {
                title: "Smelter District: Trapped Workers",
                text: "You enter the main engine room. A heavy support beam has collapsed, trapping three exhausted workers near the pit. They beg for aid. The structural groans suggest you have very little time.",
                journal: "I found men pinned by a beam, baking alive. I had to choose between saving them and securing the primary objective.",
				banter: {
					'gareth': "Heave! Put your back into it! A Captain protects his people!" // Hints at Athletics DC 15
				},
                choices: [
                    // ORDER PATH: Heroism/Time Cost
                    { 
                        text: "Attempt Rescue", 
                        nextScene: 'smelter_save_workers_check', 
                        type: 'skill', 
                        dc: 15, 
                        skill: 'Athletics',
                        orderGain: 5 
                    },
                    // CHAOS PATH: Pragmatism/No Time Cost
                    { 
                        text: "Prioritize Containment", 
                        nextScene: 'smelter_containment_success', // Direct success
                        type: 'travel',
                        chaosGain: 3,
                        doomCost: 0
                    }
                ]
            },
            // NEW SCENE: PRAGMATIC SUCCESS (Chaos)
            'smelter_containment_success': {
                title: "Containment Established",
                text: "You slam the heavy blast doors shut, sealing the fireand the workersinside. Their screams are cut short by the roar of the furnaces. It is a cold calculus, but the primary objective is now more secure. You spot a bucket of Industrial Lubricant they dropped outside the door.",
                journal: "I sealed the doors. The workers are gone, but I found Industrial Lubricant. The mission comes first. Chaos +3.",
                choices: [{ text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Industrial Lubricant")) {
                        state.inventory.push("Industrial Lubricant");
                    }
                    state.influence = Math.min(20, state.influence + 3);
                    return "Sacrificed workers for containment. Chaos +3. Found Lubricant.";
                }
            },
            'smelter_save_workers_check': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'smelter_save_workers_success' : 'smelter_save_workers_fail'
            },
            'smelter_save_workers_success': {
                title: "Order Restored",
                text: "You strain every muscle to lift the beam. The workers escape and quickly point to a bucket of Industrial Lubricant on a shelf'If you can't beat the fire, blind the beast!' they shout before fleeing. You take the bucket.",
                journal: "Saved the workers. Gained Order +5 and Industrial Lubricant.",
                choices: [{ text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Industrial Lubricant")) {
                        state.inventory.push("Industrial Lubricant");
                    }
                    state.influence = Math.max(-20, state.influence - 5);
                    return "Found Lubricant. Order +5.";
                },
            },
            'smelter_save_workers_fail': {
                title: "A Vicious Price",
                text: "You strain yourself, but the beam won't budge. The Slag Horror's roar echoes closer. You must abandon them. The crew's anguish deals a psychic blow.",
                journal: "Failed to save the workers. Took psychic damage from the crew's anguish.",
                choices: [
                    { text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'smelter_save_workers_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ],
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 3);
                    fxManager.flashRed();
                    state.influence = Math.max(-20, state.influence - 2); // Minor Order loss from failure
                    return "Took 3 Psychic Damage. Order +2 (Failed Rescue).";
                },
            },
            // --- END SMELTER ANTECHAMBER ---
            
            // --- NEW MULTI-STAGE BOSS FIGHT: SLAG HORROR ---
            'smelter_stage1_start': {
                title: "Slag Horror: Stage 1 - The Heat Wave",
                text: "The <span class='text-red-500 font-bold'>Slag Horror</span> rises from the molten iron, its core glowing. It prepares to spew a wave of magma. You must find a way to mitigate the heat to get close enough to strike. You spot the hilt of the **Sword of Valor** suspended in its chest.",
				journal: "The beast rose from the slag, dripping liquid iron. It didn't look like a monster; it looked like an industrial accident given hate and form.",
				banter: {
					'gareth': "It's winding up! Don't stand theremove!" // Hints at Athletics DC 14
				},
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // COUNTER 1: Item Bypass
                    { 
                        text: "Throw Holy Water", 
                        nextScene: 'smelter_victory_item', // Skip directly to victory
                        type: 'action', 
                        reqItem: 'Holy Water',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    // COUNTER 2: Skill Mitigation (Absorb Elements) - Sets flag for stage 2
                    { 
                        text: "Channel Absorb Elements", 
                        nextScene: 'smelter_boss_absorb_bridge', // FIXED: Points to bridge scene to set flag
                        type: 'action', 
                        reqSkill: 'Absorb Elements', 
                        doomCost: 0,
                        customClass: 'btn-fire-glow' 
                    },
                    // COUNTER 3: Brute Force (High Damage)
                    { 
                        text: "Dodge the Magma Wave", 
                        nextScene: 'smelter_dodge_logic', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Athletics',
                        doomCost: 1 // FIX 2: Added doomCost to skill check in boss
                    },
                    // ESCAPE OPTION
                    { text: "Throw Flash Powder and Flee", nextScene: 'town_square', type: 'action', reqItem: 'Flash Powder', consume: true, doomCost: 1 } // FIX 2: Added doomCost to escape
                ]
            },
            'smelter_dodge_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                    if (roll >= 14) {
                         state.pendingDamage = 4; // Minor Damage on success
                         return 'smelter_stage2_damaged';
                    } else {
                         state.pendingDamage = 8; // Major Damage on fail
                         return 'smelter_stage2_damaged';
                    }
                }
            },
            'smelter_stage2_clean': {
                title: "Slag Horror: Stage 2 - The Shell",
                text: "The magma wave was negated. The Horror's molten shell is now soft but thick, making a direct attack difficult. It's preparing a solidifying strike.",
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // COUNTER 1: Industrial Lubricant (Worker reward)
                    { 
                        text: "Douse with Industrial Lubricant",
                        nextScene: 'smelter_victory_lubricant', 
                        type: 'action',
                        reqItem: 'Industrial Lubricant',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    // COUNTER 2: Ring of Brass (If Shadow Path was done first)
                    { 
                        text: "Activate Ring of Brass", 
                        nextScene: 'smelter_victory_ring', 
                        type: 'action', 
                        reqItem: 'Ring of Brass',
                        customClass: 'btn-hero' // Blue Hero Button
                    },
                    // COUNTER 3: Charged Strike (If Absorb Elements was used in Stage 1)
                    {
                        text: "Strike with Absorb-Charged Blade",
                        nextScene: 'smelter_victory_skill', 
                        type: 'combat',
                        reqFlag: 'isAbsorbCharged',
                        customClass: 'btn-fire-glow'
                    },
                    // COUNTER 4: Brute Force
                    { text: "Hack at the Shell (Brute Force)", nextScene: 'smelter_victory_brute', type: 'combat' }
                ]
            },
            'smelter_stage2_damaged': {
                title: "Slag Horror: Stage 2 - Scorched and Striking",
                text: "You are scorched and bleeding from the magma wave, but you are close. The Horror's molten shell is thick. You must finish this now.",
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // SAME CHOICES as stage 2 clean, just with less HP
                    { 
                        text: "Douse with Industrial Lubricant",
                        nextScene: 'smelter_victory_lubricant', 
                        type: 'action',
                        reqItem: 'Industrial Lubricant',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Activate Ring of Brass", 
                        nextScene: 'smelter_victory_ring', 
                        type: 'action', 
                        reqItem: 'Ring of Brass',
                        customClass: 'btn-hero' 
                    },
                    {
                        text: "Strike with Absorb-Charged Blade",
                        nextScene: 'smelter_victory_skill', 
                        type: 'combat',
                        reqFlag: 'isAbsorbCharged',
                        customClass: 'btn-fire-glow'
                    },
                    { text: "Hack at the Shell", nextScene: 'smelter_victory_brute', type: 'combat' }
                ],
                onEnter: (state) => {
                    // Apply the damage calculated in the logic scene
                    state.currentHP = applyDamage(state.currentHP, state.pendingDamage || 0);
                    fxManager.flashRed();
                    return `Took ${state.pendingDamage} Fire Damage approaching the boss.`;
                },
            },
            // Victory scenes consolidated (all grant Sword of Valor)
            'smelter_victory_lubricant': {
                title: "Slag Horror Defeated",
                text: "The Slag Horror is shattered. The **Sword of Valor** is yours.",
                journal: "Defeated the Slag Horror and claimed the Sword of Valor.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel', }],
                onEnter: (state) => {
                    state.isAbsorbCharged = false; // Clear flag
                    if (!state.inventory.includes("Sword of Valor")) state.inventory.push("Sword of Valor");
                    return "Acquired Sword of Valor.";
                },
            },
            'smelter_victory_ring': {
                title: "Slag Horror Defeated",
                text: "The Slag Horror is shattered. The **Sword of Valor** is yours.",
                journal: "Flawless victory over the Slag Horror using the Ring's power. Claimed the Sword of Valor.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isAbsorbCharged = false; // Clear flag
                    if (!state.inventory.includes("Sword of Valor")) state.inventory.push("Sword of Valor");
                    return "Acquired Sword of Valor.";
                },
            },
            'smelter_victory_item': {
                title: "Slag Horror Defeated",
                text: "The Slag Horror is shattered. The **Sword of Valor** is yours.",
                journal: "Used Holy Water to defeat the Slag Horror. Claimed the Sword of Valor.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isAbsorbCharged = false; // Clear flag
                    if (!state.inventory.includes("Sword of Valor")) state.inventory.push("Sword of Valor");
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return "Used Holy Water. Acquired Sword of Valor.";
                },
            },
            'smelter_victory_skill': {
                title: "Slag Horror Defeated",
                text: "The Slag Horror is shattered. The **Sword of Valor** is yours. You are scorched by the blast.",
                journal: "Defeated the Slag Horror with Absorb Elements. Claimed the Sword of Valor.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isAbsorbCharged = false; // Clear flag
                    state.currentHP = applyDamage(state.currentHP, 4); // Minor Damage
                    fxManager.flashRed();
                    if (!state.inventory.includes("Sword of Valor")) state.inventory.push("Sword of Valor");
                    return "Took 4 DMG. Acquired Sword of Valor.";
                },
            },
            'smelter_victory_brute': {
                title: "Slag Horror Defeated",
                text: "The Slag Horror is shattered. The **Sword of Valor** is yours. You are heavily wounded.",
                journal: "Brute force victory over the Slag Horror, taking heavy damage. Claimed the Sword of Valor.",
                choices: [{ text: "Limp to Town Square", nextScene: 'town_square', type: 'travel', doomCost: 2 }],
                onEnter: (state) => {
                    state.isAbsorbCharged = false; // Clear flag
                    state.currentHP = applyDamage(state.currentHP, 10); // Major Damage
                    fxManager.flashRed();
                    if (!state.inventory.includes("Sword of Valor")) state.inventory.push("Sword of Valor");
                    return "Took 10 DMG. Acquired Sword of Valor.";
                },
            },
            // --- END MULTI-STAGE BOSS FIGHT: SLAG HORROR ---


            // --- SHADOW PATH SCENES ---
            'chapel_entry': {
                title: "Sunken Chapel: The Fog Maze",
                text: "The cemetery is covered in unnatural fog. The paths loop back on themselves, and you cannot see. The silence here is heavy.",
				journal: "The silence of the Chapel was heavy. The fog felt intentional. It wanted me lost.",
                banter: {
					'talon': "The fog moves against the wind. Something is disturbing it.", // Hints at Perception DC 15
					'bones': "You can't fight what you can't see. Light a torch." // Hints at Torch
				},
                choices: [
                    // NEW CHOICE: TORCH SIDE QUEST (Task 2)
                    {
                        text: "Use Torch to Illuminate the Vestry",
                        nextScene: 'chapel_side_torch',
                        type: 'action',
                        reqItem: 'Torch',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 1: INFO CHECK (Automatic Success) - DOOM COST 0
                    { 
                        text: "Follow the Weeping Angel Statues", 
                        nextScene: 'chapel_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsChapelSecret',
                        doomCost: 0,
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 2: HERO BUTTON (Primeval Awareness) - DOOM COST 0
                    { 
                        text: "Channel Primeval Awareness", 
                        nextScene: 'chapel_primeval_bridge', // FIXED: Points to bridge scene to set flag
                        type: 'action', 
                        reqSkill: 'Primeval Awareness',
                        doomCost: 0,
                        customClass: 'btn-shadow-glow' 
                    },
                    // OPTION 3: SKILL CHECK (Talon/Perception) - DOOM COST 1 (Default)
                    { text: "Attempt to Track Movement", nextScene: 'chapel_roll', type: 'skill', dc: 15, skill: 'Perception' }
                ]
            },
            // NEW SCENE: TORCH SIDE QUEST REWARD (Task 2)
            'chapel_side_torch': {
                title: "A Sudden Brightness",
                text: "The flame crackles, momentarily thinning the black fog. You see a set of stairs leading to an upper levela quick path! On a dry shelf near the top, you find a Pearlescent Mushroom, left to dry.",
                journal: "Used Torch to bypass the fog maze. Found a Pearlescent Mushroom.",
                choices: [{ text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' }],
                onEnter: (state) => { 
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found Pearlescent Mushroom!"; 
                    }
                    return "Torch expended.";
                },
            },
            'chapel_safe': { 
                title: "Found Path", 
                text: "You navigate the fog safely.", 
                choices: [{ text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' }]
            },
            'chapel_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'chapel_safe' : 'chapel_damage' },
            'chapel_damage': { 
                title: "Ambushed", 
                text: "A shadow creature ambushes you.", 
                choices: [
                    { text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' },
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'chapel_safe', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ],
                onEnter: (s) => { 
                    s.currentHP = applyDamage(s.currentHP, 6); 
                    fxManager.flashRed();
                    return "Took 6 Shadow Damage."; 
                }, 
            },
            // --- NEW SCENE: CHAPEL ANTECHAMBER (Order/Chaos Choice) ---
            'chapel_vestry': {
                title: "Sunken Chapel: Flooded Vestry",
                text: "The vestry is flooded with black, polluted water. A panicked man is caught in the undertow, struggling to keep his head above the foul tide. He screams for help. The water is necroticEdward's mind screams for him not to touch it.",
                journal: "A man was drowning in the vestry. The water looked necrotic, thick with rot. I had to choose between my duty to the living and the sanctity of the mission.",
				banter: {
					'gareth': "He's going under! You have the strength to pull him out, Edward. Don't let him drown!" // Hints at Athletics DC 14
				},
                choices: [
                    // ORDER PATH: Heroism/Time Cost
                    { 
                        text: "Attempt Rescue", 
                        nextScene: 'chapel_rescue_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Athletics',
                        orderGain: 4
                    },
                    // CHAOS PATH: Pragmatism/No Time Cost
                    { 
                        text: "Prioritize Containment", 
                        nextScene: 'chapel_ignore_drowning', 
                        type: 'dialogue',
                        chaosGain: 4,
                        doomCost: 0
                    }
                ]
            },
            'chapel_rescue_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'chapel_rescue_success' : 'chapel_rescue_fail'
            },
            'chapel_rescue_success': {
                title: "Mercy's Reward",
                text: "You pull the panicked man from the black water. Gasping, he hands you a small, heavy silver hearta family locket. 'Sell this, please. For my family.'",
                journal: "Saved the man. Gained Order +4 and a Silver Locket.",
                choices: [{ text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' }], // DIRECT TO BOSS
                onEnter: (state) => {
                    if (!state.inventory.includes("Silver Locket")) {
                        state.inventory.push("Silver Locket");
                    }
                    state.influence = Math.max(-20, state.influence - 4);
                    return "Found Silver Locket. Order +4.";
                },
            },
            'chapel_rescue_fail': {
                title: "Overwhelmed",
                text: "The black water and the man's panic are too much. He slips from your grasp and is pulled under. The undertow bruises your legs.",
                journal: "Failed the rescue. Took damage from the undertow.",
                choices: [
                    { text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' }, // DIRECT TO BOSS
                    // NEW: Dead Man's Die Cheat Fate option
                    { 
                        text: "Cheat Fate (Use Dead Man's Die)", 
                        nextScene: 'chapel_rescue_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'chapel_ignore_drowning': {
                title: "Looting the Drowned",
                text: "You ignore the man's screams. He drowns quickly. You search his floating corpse and find only a damp, useless map, but Talon spots something shining behind the altara consecrated bottle of Holy Water, untouched by the black tide.",
                journal: "Ignored the drowning man. Gained Chaos +4 and Holy Water.",
                choices: [{ text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' }], // DIRECT TO BOSS
                onEnter: (state) => {
                    if (!state.inventory.includes("Holy Water")) {
                        state.inventory.push("Holy Water");
                    }
                    state.influence = Math.min(20, state.influence + 4);
                    return "Found Holy Water. Chaos +4.";
                },
            },
            // --- END CHAPEL ANTECHAMBER ---
            
            // --- NEW MULTI-STAGE BOSS FIGHT: DROWNED SPECTRE ---
            'chapel_stage1_reveal': {
                title: "Drowned Spectre: Stage 1 - The Ambush",
                text: "The crypt is flooded. The <span class='text-gray-400 font-bold'>Drowned Spectre</span> is present but invisible in the thick, churning black fog. It will strike from the dark unless you can pinpoint its true location. On its skeletal finger glints the **Ring of Brass**.",
				journal: "The Spectre was everywhere and nowhere. A cold touch on my neck. A whisper in my ear. Talon told me to stop looking with my eyes.",
				banter: {
					'talon': "It's circling us. Stop looking with your eyes. Watch for the displacement in the fog." // Hints at Perception DC 14
				},
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // COUNTER 1: Item Bypass (If Fire Path was done first)
                    { 
                        text: "Strike with Sword of Valor", 
                        nextScene: 'chapel_victory_sword', 
                        type: 'action', 
                        reqItem: 'Sword of Valor',
                        customClass: 'btn-hero' 
                    },
                    // COUNTER 2: Skill Mitigation (Primeval Awareness)
                    { 
                        text: "Channel Primeval Awareness", 
                        nextScene: 'chapel_primeval_bridge', // FIXED: Points to bridge scene to set flag
                        type: 'action', 
                        reqSkill: 'Primeval Awareness',
                        doomCost: 0,
                        customClass: 'btn-shadow-glow' 
                    },
                    // COUNTER 3: Ring of Brass Passive (Keen Senses)
                    { 
                        text: "Use Ring of Brass", 
                        nextScene: 'chapel_stage2_finish', // Go to finish phase clean
                        type: 'action', 
                        reqItem: 'Ring of Brass',
                        customClass: 'btn-keen-senses' 
                    },
                    // COUNTER 4: Brute Force (High Damage)
                    { 
                        text: "Swing Wildly into the Fog", 
                        nextScene: 'chapel_attack_logic', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Perception',
                        doomCost: 1 // FIX 2: Added doomCost to skill check in boss
                    },
                    // ESCAPE OPTION
                    { text: "Throw Flash Powder and Flee", nextScene: 'town_square', type: 'action', reqItem: 'Flash Powder', consume: true, doomCost: 1 } // FIX 2: Added doomCost to escape
                ]
            },
            'chapel_attack_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                    if (roll >= 14) {
                         state.pendingDamage = 4; // Minor Damage on success
                         return 'chapel_stage2_hit_damaged';
                    } else {
                         state.pendingDamage = 8; // Major Damage on fail
                         return 'chapel_stage2_miss_damaged';
                    }
                }
            },
            'chapel_stage2_finish': {
                title: "Drowned Spectre: Stage 2 - Banishment",
                text: "The Spectre is revealed. It knows it's been found and lunges at you, attempting to possess your mind. You must banish it now.",
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // COUNTER 1: Alchemical Fire
                    { 
                        text: "Throw Alchemical Fire", 
                        nextScene: 'chapel_victory_item', 
                        type: 'action', 
                        reqItem: 'Alchemical Fire',
                        consume: true,
                        customClass: 'btn-fire-glow'
                    },
                    // COUNTER 2: Charged Strike (If Surprise Round was set by Primeval Awareness in entry scene)
                    {
                        text: "Strike with Surprise Advantage",
                        nextScene: 'chapel_victory_skill', 
                        type: 'combat',
                        reqFlag: 'isSurpriseRound',
                        customClass: 'btn-shadow-glow'
                    },
                    // COUNTER 3: Brute Force (High Sanity Damage)
                    { text: "Engage in Psychic Struggle (Brute Force)", nextScene: 'chapel_victory_brute', type: 'combat' }
                ]
            },
            'chapel_stage2_hit_damaged': {
                title: "Drowned Spectre: Stage 2 - Found, But Wounded",
                text: "Your wild strike grazed the Spectre, but it lashed out, dealing psychic damage. It's now revealed and attempts possession.",
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // SAME CHOICES as stage 2 clean
                    { 
                        text: "Throw Alchemical Fire", 
                        nextScene: 'chapel_victory_item', 
                        type: 'action', 
                        reqItem: 'Alchemical Fire',
                        consume: true,
                        customClass: 'btn-fire-glow'
                    },
                    {
                        text: "Strike with Surprise Advantage",
                        nextScene: 'chapel_victory_skill', 
                        type: 'combat',
                        reqFlag: 'isSurpriseRound', // Still can use the skill's initial surprise bonus
                        customClass: 'btn-shadow-glow'
                    },
                    { text: "Engage in Psychic Struggle (Brute Force)", nextScene: 'chapel_victory_brute', type: 'combat' }
                ],
                onEnter: (state) => {
                    // Apply the damage calculated in the logic scene
                    state.currentHP = applyDamage(state.currentHP, state.pendingDamage || 0);
                    fxManager.flashRed();
                    return `Took ${state.pendingDamage} Psychic Damage. The Spectre is now visible.`;
                },
            },
            'chapel_stage2_miss_damaged': {
                title: "Drowned Spectre: Stage 2 - Missed and Drained",
                text: "Your attack missed, and the Spectre drained a huge portion of your life force. It is revealed but you are heavily wounded. Finish this now!",
                isBoss: true, // Tag as boss scene (No doom cost)
                choices: [
                    // SAME CHOICES as stage 2 clean
                    { 
                        text: "Throw Alchemical Fire", 
                        nextScene: 'chapel_victory_item', 
                        type: 'action', 
                        reqItem: 'Alchemical Fire',
                        consume: true,
                        customClass: 'btn-fire-glow'
                    },
                    {
                        text: "Strike with Surprise Advantage",
                        nextScene: 'chapel_victory_skill', 
                        type: 'combat',
                        reqFlag: 'isSurpriseRound',
                        customClass: 'btn-shadow-glow'
                    },
                    { text: "Engage in Psychic Struggle (Brute Force)", nextScene: 'chapel_victory_brute', type: 'combat' }
                ]
                ,
                onEnter: (state) => {
                    // Apply the damage calculated in the logic scene
                    state.currentHP = applyDamage(state.currentHP, state.pendingDamage || 0);
                    fxManager.flashRed();
                    return `Took ${state.pendingDamage} Psychic Damage. The Spectre is visible, but you are drained.`;
                },
            },
            // Victory scenes consolidated (all grant Ring of Brass)
             'chapel_victory_water': {
                title: "Drowned Spectre Defeated",
                text: "The Drowned Spectre is banished. The **Ring of Brass** is yours. You are drenched, but victorious.",
                journal: "Used Holy Water to defeat the Drowned Spectre. Claimed the Ring of Brass.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isSurpriseRound = false; // Clear flag
                    if (!state.inventory.includes("Ring of Brass")) state.inventory.push("Ring of Brass");
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return "Used Holy Water. Acquired Ring of Brass.";
                },
            },
            'chapel_victory_sword': {
                title: "Drowned Spectre Defeated",
                text: "The Drowned Spectre is banished. The **Ring of Brass** is yours. The Sword cuts through the void.",
                journal: "Flawless victory over the Spectre using the Sword of Valor. Claimed the Ring of Brass.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isSurpriseRound = false; // Clear flag
                    if (!state.inventory.includes("Ring of Brass")) state.inventory.push("Ring of Brass");
                    return "Acquired Ring of Brass.";
                },
            },
            'chapel_victory_item': {
                title: "Drowned Spectre Defeated",
                text: "The Drowned Spectre is banished. The **Ring of Brass** is yours. The Alchemical fire burns away the shadows.",
                journal: "Used Alchemical Fire to defeat the Drowned Spectre. Claimed the Ring of Brass.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isSurpriseRound = false; // Clear flag
                    if (!state.inventory.includes("Ring of Brass")) state.inventory.push("Ring of Brass");
                    const idx = state.inventory.indexOf("Alchemical Fire");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return "Used Alchemical Fire. Acquired Ring of Brass.";
                },
            },
            'chapel_victory_skill': {
                title: "Drowned Spectre Defeated",
                text: "The Drowned Spectre is banished. The **Ring of Brass** is yours. You are drained but intact.",
                journal: "Defeated the Spectre with Primeval Awareness. Claimed the Ring of Brass.",
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }],
                onEnter: (state) => {
                    state.isSurpriseRound = false; // Clear flag
                    state.currentHP = applyDamage(state.currentHP, 5); // Minor Psychic Damage
                    fxManager.flashRed();
                    if (!state.inventory.includes("Ring of Brass")) state.inventory.push("Ring of Brass");
                    return "Took 5 DMG. Acquired Ring of Brass.";
                },
            },
            'chapel_victory_brute': {
                title: "Drowned Spectre Defeated",
                text: "The Drowned Spectre is banished. The **Ring of Brass** is yours. Your mind is fractured by the psychic blow.",
                journal: "Brute force victory over the Spectre, taking heavy sanity damage. Claimed the Ring of Brass.",
                choices: [{ text: "Limp to Town Square", nextScene: 'town_square', type: 'travel', doomCost: 2 }],
                onEnter: (state) => {
                    state.isSurpriseRound = false; // Clear flag
                    state.currentHP = applyDamage(state.currentHP, 12); // Major Psychic Damage
                    fxManager.flashRed();
                    if (!state.inventory.includes("Ring of Brass")) state.inventory.push("Ring of Brass");
                    return "Took 12 DMG. Acquired Ring of Brass.";
                },
            },
            // --- END MULTI-STAGE BOSS FIGHT: DROWNED SPECTRE ---
            
			'finale_ritual_start': { 
                title: "The Wolf King's Ritual", 
                text: "The Ring and the Blade flare in your hands, vibrating with a hum that rattles your teeth. The Rift above screams, a violet wound in the sky. To close it, you must become the anchor. You must channel the artifacts until the gateway shatters.<br><br><span class='text-purple-400 italic'>Hold the button to channel the ritual...</span>", 
                isBoss: true, 
                choices: [
                    { 
                        text: "Channel the Power", 
                        nextScene: 'act2_ethereal_drift', 
                        type: 'hold', 
                        customClass: 'btn-channel',
                        doomCost: 0
                    }
                ] 
            },

            'act2_ethereal_drift': {
                title: "Act 2: The Ethereal Drift",
                text: "The world shatters. The Port of Shadows, the Smelter, the Chapelthey dissolve into mist. You are no longer on the Material Plane. You are drifting in the Ethereal, a ghost among ghosts. The Rift is closed, but you are on the wrong side of it.<br><br>The voices of your crew are crystal clear now. They are not in your head; they are standing beside you on the deck of a spectral ship sailing through starlight.<br><br><span class='cinzel text-xl text-blue-400'>End of Act 1</span>",
                journal: "I closed the Rift, but the recoil threw me into the Ethereal Plane. I am truly the Mariner of the Damned now.",
                onEnter: (state) => {
                    // --- WORLD STATE: RIFT CLOSED ---
                    state.act1Started = false;    // Hides Doom UI Bar & Stops Button Turn Counts
                    state.isRiftCollapse = false; // Removes Purple/Red Overlay logic
                    state.doomTimer = 0;          // Resets the internal counter (optional cleanup)
                    state.quinnLogistics = false; // Hides the "0 Turns" text on buttons
                    
                    return "Act 1 Complete. The Rift is Closed. Welcome to the Ethereal Plane.";
                },
                choices: [
                    { 
                        text: "Restart Game", 
                        type: 'reset',
                        doomCost: 0
                    }
                ]
            },

            'edward_death': {
                title: "The Mariner's End",
                text: "The voices fall silent, only to surge back in a deafening, cold chorus that rips through your mind. The debt is paid. The Planar Storm claims its last crewman, pulling you into the abyss. You feel the crushing presence of the Leviathan one final time.",
                journal: "Edward Jones is lost to the deep. The voices of the damned are finally silenced.",
                choices: [
                    { 
                        text: "Awaken (Restart Game)", 
                        type: 'reset',
                        customClass: 'btn-hero',
						doomCost: 0						// Force rendering
                    }
                ]
            }
        };

        // --- CORE FUNCTIONS ---
        // NEW HELPER: Applies damage while ensuring HP doesn't go below 0.
        function applyDamage(currentHP, damageAmount) {
            let finalHP = Math.max(0, currentHP - damageAmount);
            
            // PHOENIX DRAFT CHECK
            if (finalHP === 0) {
                const phoenixIndex = gameState.inventory.indexOf("Phoenix Draft");
                if (phoenixIndex > -1) {
                    gameState.inventory.splice(phoenixIndex, 1); // Consume the item
                    finalHP = 10; // Restore HP
                    addToHistory(`*The Phoenix Draft shatters, pulling you back from the abyss! Restored 10 HP.*`, 'system');
                    fxManager.flashRed(); // Still show the flash of damage/shock
                }
            }

            // Clamps HP at 0 (after potential Phoenix Draft save)
            return Math.max(0, finalHP);
        }

        // Helper function to provide initial stock data structure
        scenes['market_stall'].stock = {
            "Healing Potion": 1,
            "Rope": 1,
            "Torch": 1,
            "Curious Cargo": 1, 
            "Rum": 1 
        };
        // NEW: Alchemist stock initialization
        scenes['alchemist_triage'].stock = {
            "Vitality Tincture": 2,
            "Smelling Salts": 3,
            "Flash Powder": 1,
            "Alchemical Fire": 1, 
            "Holy Water": 1 
        };
        // NEW: Tavern stock initialization
        scenes['blackwater_tavern'].stock = {
            "Gruel": 5 
        };
        
        async function generateSceneImage(sceneId) {
            const key = sceneId || 'default';
            const url = sceneImages[key] || sceneImages['default'];
            
            const imgEl = document.getElementById('scene-image');
            const loader = document.getElementById('image-loader');
            
            // Hide image, show loader immediately for visual feedback
            imgEl.style.opacity = 0;
            loader.style.display = 'flex';
            imgEl.src = ''; // Clear previous image

            // Use a temporary image object to manage loading state reliably
            const tempImg = new Image();
            tempImg.src = url;

            tempImg.onload = () => {
                // Once loaded, apply source, hide loader, and fade in
                imgEl.src = url;
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };

            tempImg.onerror = () => {
                // Fallback to placeholder on error
                console.warn(`Failed to load image for scene: ${sceneId}. Falling back to placeholder.`);
                imgEl.src = sceneImages['default'];
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };
        }

        async function init() {
            window.confirmReset = confirmReset;
            window.resetGame = resetGame; 

            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    user = u;
                    await setupRealtimeListener();
                    document.getElementById('app-loading').classList.add('fade-out');
                    setTimeout(() => document.getElementById('app-loading').remove(), 500);
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        async function setupRealtimeListener() {
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            
            try {
                const snap = await getDoc(docRef);
                if (!snap.exists()) {
                    await setDoc(docRef, gameState);
                    renderScene('prologue_storm');
                } else {
                    const data = snap.data();
                    if (data.influence === undefined) {
                        data.influence = 0; 
                        delete data.guardInfluence;
                        delete data.smugglerInfluence;
                    }
                    // Merge saved data with default to ensure new fields are included
                    const savedState = { ...createInitialState(), ...data }; 
                    gameState = savedState;
                    
                    // --- PERSIST SCENE STOCK CHANGES ---
                    // This ensures any purchases/sales made before the last save persist 
                    // on the scene object, not just in the state.
                    if (data.market_stall_stock) {
                         scenes['market_stall'].stock = data.market_stall_stock;
                    }
                    if (data.alchemist_triage_stock) {
                        scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                    }
                    // NEW: Tavern Stock Persistence
                    if (data.blackwater_tavern_stock) {
                        scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;
                    }

                    // --- PLANAR THEME TOGGLE (ON PAGE LOAD) ---
                    if (gameState.isEthereal) {
                        document.body.classList.add('plane-ethereal');
                    } else {
                        document.body.classList.remove('plane-ethereal');
                    }
                    
                    renderScene(gameState.currentSceneId, false);
                    rebuildJournal();
                }
            } catch (e) {
                console.error("Save error", e);
                renderScene('prologue_storm');
            }

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (JSON.stringify(data) !== JSON.stringify(gameState)) {
                        
                        // Apply scene specific stock changes from Firestore to the runtime scene object
                        if (data.market_stall_stock) {
                            scenes['market_stall'].stock = data.market_stall_stock;
                            delete data.market_stall_stock; // Don't overwrite gameState with this old field
                        }
                        if (data.alchemist_triage_stock) {
                            scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                            delete data.alchemist_triage_stock;
                        }
                        // NEW: Tavern Stock Persistence
                        if (data.blackwater_tavern_stock) {
                            scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;
                            delete data.blackwater_tavern_stock;
                        }

                        gameState = { ...gameState, ...data };
                        
                        // --- PLANAR THEME TOGGLE (ON REALTIME UPDATE) ---
                        if (gameState.isEthereal) {
                            document.body.classList.add('plane-ethereal');
                        } else {
                            document.body.classList.remove('plane-ethereal');
                        }
                        
                        updateUI();
                    }
                }
            });
        }

        async function saveGame() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            const safeState = JSON.parse(JSON.stringify(gameState));
            
            // --- ATTACH SCENE STOCK TO SAVED STATE ---
            safeState.market_stall_stock = scenes['market_stall'].stock;
            safeState.alchemist_triage_stock = scenes['alchemist_triage'].stock;
            safeState.blackwater_tavern_stock = scenes['blackwater_tavern'].stock; // NEW: Tavern Stock Save

            await setDoc(docRef, safeState);
        }

        let resetConfirmTimer = null;
        function confirmReset() {
            const btn = document.getElementById('reset-game-btn');
            if (btn.classList.contains('bg-red-900')) {
                resetGame();
                clearTimeout(resetConfirmTimer);
                btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                btn.classList.remove('bg-red-900', 'text-white');
                btn.classList.add('text-red-400', 'bg-black/60');
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Confirm?';
                btn.classList.remove('text-red-400', 'bg-black/60');
                btn.classList.add('bg-red-900', 'text-white');
                resetConfirmTimer = setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                    btn.classList.remove('bg-red-900', 'text-white');
                    btn.classList.add('text-red-400', 'bg-black/60');
                }, 3000);
            }
        }

        async function resetGame() {
            // Reset state
            gameState = createInitialState();
            
            // Reset scene data manually (needed for market stock)
            scenes['market_stall'].stock = {
                "Healing Potion": 1,
                "Rope": 1,
                "Torch": 1,
                "Curious Cargo": 1, 
                "Rum": 0 
            };
            scenes['alchemist_triage'].stock = {
                "Vitality Tincture": 2,
                "Smelling Salts": 3,
                "Flash Powder": 1,
                "Alchemical Fire": 1, 
                "Holy Water": 1 
            };
            scenes['blackwater_tavern'].stock = { // NEW: Tavern Stock Reset
                "Gruel": 5 
            };
            
            // FIX 1: Reset the Docks Work cost manually
            const workBtn = scenes['town_docks'].choices.find(c => c.nextScene === 'docks_work');
            if (workBtn) workBtn.costHP = 2; // Reset to base cost
            
            // Clear boss flags which may persist in the scene definitions (if not explicitly cleared on win/loss)
            gameState.isAbsorbCharged = false;
            gameState.isSurpriseRound = false;
            gameState.isRiftCollapse = false;
            // gameState.hasLoggedCollapse is already in createInitialState
            gameState.act1Started = false; // Ensure Act 1 starts false on reset
            // Reset one-time flags
            gameState.hasObservedGambler = false;
            gameState.hasSearchedSmugglerDrop = false;
            // NEW: Docks work exhaustion counter reset
            gameState.docksWorkCount = 0;
            // NEW: Quinn's Logistics reset
            gameState.quinnLogistics = false;
            // NEW: Ethereal flag reset
            gameState.isEthereal = false;


            document.getElementById('journal-content').innerHTML = '';
            await saveGame();
            renderScene('prologue_storm');
            rebuildJournal();
            document.getElementById('inf-status-text').textContent = "Unknown to all";
            document.getElementById('item-desc-area').textContent = "Hover over an item to inspect it.";
        }

        function rebuildJournal() {
            const container = document.getElementById('journal-content');
            container.innerHTML = gameState.history.join('');
            scrollToBottom();
        }

        function scrollToBottom() {
            const area = document.getElementById('journal-scroll-area');
            area.scrollTop = area.scrollHeight;
        }

        function addToHistory(text, type = 'entry') {
            let html = '';
            if (type === 'entry') {
                // Apply spectral-text-glow to crew names in the journal
                const processedText = text.replace(/(Captain Gareth|Gareth|Quinn|Talon|Bones|Wolf King|Ring of Brass|Sword of Valor|Smelter|Chapel|Absorb Elements|Primeval Awareness|Phoenix Draft)/g, '<span class="spectral-text-glow">$1</span>');
                html = `<div class="journal-font pb-4 border-b border-gray-700/30 text-gray-400 fade-in">${processedText}</div>`;
            } else if (type === 'system') {
                html = `<div class="text-xs text-amber-500 font-mono mb-2 fade-in">> ${text}</div>`;
            } else if (type === 'roll') {
                // Apply spectral-text-glow to roll results
                html = `<div class="text-xs spectral-text-glow font-bold mb-2 fade-in font-serif">${text}</div>`;
            }
            gameState.history.push(html);
            rebuildJournal();
        }
        
        async function renderScene(sceneId, logText = true) {
            const scene = scenes[sceneId];
            if (!scene) return;
            
            // --- DEATH CHECK 0: Check previous state before processing current scene logic ---
            // If the player entered this scene already dead (e.g., from damage applied in a previous scene's logic)
            // This prevents a journal entry from the current scene being added before the death scene loads
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }

            // --- PLANAR THEME TOGGLE ---
            // This applies the Act 2 CSS theme globally
            if (gameState.isEthereal) {
                document.body.classList.add('plane-ethereal');
            } else {
                document.body.classList.remove('plane-ethereal');
            }

            // ... existing updateUI code ...
            const statsPanel = document.getElementById('stats-panel');


            if (scene.isLogic) {
                let roll = Math.floor(Math.random() * 20) + 1;
                let crewUsedName = "None";
                let logMsg = `Check (DC ${gameState.lastDC || 10}): Rolled d20 (${roll})`;
                
                // Clear last used crew ID before a new check
                gameState.lastCrewUsedId = null;

                if (activeCrewMember) {
                    const isSkilled = getBonusForSkill(activeCrewMember, gameState.lastSkillType);
                    const crewKey = activeCrewMember.id;
                    
                    if (isSkilled) { 
                        const bonus = Math.floor(Math.random() * 4) + 1;
                        roll += bonus;
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + ${bonus} (${crewUsedName})`;
                        
                        // MUSHROOM LOGIC CHECK (APPLY COST OR FREE USE)
                        if (gameState.crewUseFree) {
                            // Free use: DO NOT mark as used, but consume the mushroom effect.
                            addToHistory(`*Pearlescent Mushroom consumed for FREE GUIDANCE.*`, 'system');
                            gameState.crewUseFree = false; // CONSUME EFFECT
                        } else {
                            // Normal use: Mark as used.
                            gameState.crew[crewKey].used = true;
                        }
                        
                        // Store the ID of the crew member used on this check (used for Talon Cargo logic)
                        if (roll >= gameState.lastDC) {
                            gameState.lastCrewUsedId = crewKey;
                        }
                        
                    } else if (gameState.crewUseFree) {
                         // Crew selected, mushroom active, but SKILL DOESN'T MATCH.
                         // No bonus is granted. Mushroom effect is conserved.
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + 0 (${crewUsedName} - Invalid Skill, Mushroom conserved)`;
                        addToHistory(`*Mushroom conserved: ${crewUsedName} doesn't have expertise in ${gameState.lastSkillType}.*`, 'system');
                        // DO NOT set crewUseFree = false here
                    } else {
                        // Crew selected, mushroom inactive, skill doesn't match.
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + 0 (${crewUsedName} - Invalid Skill)`;
                        // Do not mark as used if skill was invalid
                    }
                    
                    activeCrewMember = null;
                }

                addToHistory(`${logMsg} = ${roll}`, 'roll');
                
                // Resolve logic scene immediately based on this roll
                const nextId = scene.resolve(roll, gameState); 
                saveGame();
                renderScene(nextId); 
                return;
            }

            gameState.currentSceneId = sceneId;
            
			// --- FX TRIGGER LOGIC ---
            // FX are cleared *before* the new scene FX are applied
            fxManager.clearEffects(); 

            // PRIORITY 1: Has the Rift Collapsed? (Permanent Game State)
            // CHECK: Is the Rift collapsed AND are we NOT in a scene where it should be hidden/closed?
            if (gameState.isRiftCollapse && !['finale_completed', 'edward_death', 'act2_ethereal_drift'].includes(sceneId)) {
                // Shows the failure overlay
                document.getElementById('fx-overlay').classList.add('fx-rift-collapsed');
            }

            // PRIORITY 2: Is the Rift Pulse active? (Atmospheric State)
            else if (['prologue_storm', 'prologue_abyss', 'town_square', 'lighthouse_vigil', 'smelter_stage1_start', 'chapel_stage1_reveal', 'town_docks', 'blackwater_tavern'].includes(sceneId)) {
                document.getElementById('fx-overlay').classList.add('fx-rift-pulse');
            }

            if (scene.onEnter && logText) {
                const msg = scene.onEnter(gameState);
                // Apply damage and then check death immediately
                if (msg) addToHistory(msg, 'system');
                saveGame();
            }

            // --- DOOM COUNTER LOGIC (Planar Instability) ---
            const isBossScene = scenes[sceneId].isBoss;
            
            // The actual decrement logic is now inside the `btn.onclick` function.
            // This logic below handles the state if the doom timer hit 0 on the last click.
            if (gameState.doomTimer <= 0 && gameState.act1Started) {
                
                // FIX 2B: Apply penalties and log the message ONLY ONCE
                if (!gameState.isRiftCollapse && !gameState.hasLoggedCollapse) {
                    
                    // Set both collapse flags (The penalty applies here only once)
                    gameState.isRiftCollapse = true;
                    gameState.hasLoggedCollapse = true; 
                    
                    // Apply penalties and log the message
                    gameState.maxHP = Math.max(1, gameState.maxHP - 5);
                    gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP); // Clamp current HP
                    addToHistory(`!!! RIFT COLLAPSE !!! The veil has ruptured. All Skill Check DCs are permanently increased by 2. Max HP reduced by 5 due to toxic air.`, 'system');
                }
            }
            
            // --- DEATH CHECK 1: Immediately check if onEnter killed the player ---
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }

            // --- VIGNETTE CHECK (FIXED) ---
            // Apply low health vignette if HP is <= 30%
            const hpPct = (gameState.currentHP / gameState.maxHP) * 100;
            if (hpPct <= 30) {
                fxManager.setVignette(true);
            } else {
                fxManager.setVignette(false);
            }

            const textEl = document.getElementById('main-scene-text');
            // Check if we are in the Death scene to apply unique styling
            const isDeathScene = sceneId === 'edward_death';
            
            // Restore default text styling for normal scenes, use red only for death scene
            let titleClass = isDeathScene ? 'text-red-500' : 'text-amber-500';
            let textClass = isDeathScene ? 'text-red-300' : 'text-gray-300';

            
            let finalHtml = `<h2 class="2xl cinzel ${titleClass} mb-2">${scene.title}</h2><p class="text-lg leading-relaxed ${textClass} fade-in">${scene.text}</p>`;
            
            // --- BANTER INJECTION (AUTOMATIC) ---
            
            // 1. Scripted Banter (always prioritized if available)
            if (scene.banter) {
                Object.keys(scene.banter).forEach(crewId => {
                    if (gameState.crew[crewId] && !gameState.crew[crewId].used) {
                        // Apply spectral glow to banter text (MODIFIED)
                         finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in">
                                <span class="font-bold text-xs uppercase block mb-1">${gameState.crew[crewId].name}:</span>
                                "${scene.banter[crewId]}"
                              </div>`;
                    }
                });
            }
            
            // 2. Dynamic Banter Injection (20% chance on non-boss/non-scripted scenes)
            const isScriptedScene = scene.banter || scene.isBoss || scene.isRest || scene.choices.some(c => c.type === 'skill');
            // If the scene has no dedicated banter, is not a boss/rest scene, and we're past the prologue
            if (!isScriptedScene && !sceneId.startsWith('prologue') && gameState.act1Started) {
                 const dynamicLine = getDynamicBanter();
                 if (dynamicLine) {
                      finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in">
                            <span class="font-bold text-xs uppercase block mb-1">${dynamicLine.name}:</span>
                            "${dynamicLine.line}"
                          </div>`;
                 }
            }
            
            textEl.innerHTML = finalHtml;
            document.getElementById('scene-title').innerText = scene.title;
            
            activeCrewMember = null; 
            
            generateSceneImage(sceneId);
            renderChoices(scene.choices, isDeathScene); // Pass death status to renderChoices
            updateUI();
        }

        function renderChoices(choices, isDeathScene = false) {
            const container = document.getElementById('choices-area');
            container.innerHTML = '';

            // --- LOCAL STOCK UTILITY ---
            const currentSceneId = gameState.currentSceneId;
            const currentSceneStock = scenes[currentSceneId] ? scenes[currentSceneId].stock : {};
            const marketStock = scenes['market_stall'].stock; // Reference for selling logic
            
            // Collect all choices, starting with static ones
            let processedChoices = [...choices]; 
            
            // --- DYNAMIC INJECTION: ALCHEMIST SECRET STOCK ---
            // Inject trade option if on Alchemist Triage scene and has the coin, and Phoenix Draft hasn't been acquired
            if (currentSceneId === 'alchemist_triage' && gameState.inventory.includes('Strange Coin') && !gameState.inventory.includes('Phoenix Draft')) {
                // Find insertion point before 'Sell Wares' or 'Return to Port Square'
                const sellIndex = processedChoices.findIndex(c => c.nextScene === 'alchemist_sell');
                const newChoice = {
                    text: "Offer Strange Coin",
                    nextScene: 'alchemist_secret_stock',
                    type: 'action',
                    reqItem: 'Strange Coin',
                    consume: true,
                    doomCost: 0
                };

                if (sellIndex !== -1) {
                    processedChoices.splice(sellIndex, 0, newChoice);
                } else {
                    processedChoices.push(newChoice); // Fallback to end of list
                }
            }
            // --- END DYNAMIC INJECTION ---


            // Handle dynamic generation for Market Scenes
            if (currentSceneId === 'market_stall') {
                // FIX 1: Retrieve all original navigation buttons first
                const sellWaresNav = choices.find(c => c.nextScene === 'market_sell');
                const leaveNav = choices.find(c => c.nextScene === 'market_crossroads');
                
                processedChoices = []; 

                // 1. Generate Dynamic Buy Options
                MARKET_BUY_OPTIONS.forEach(sale => {
                    // Check local stock for this item name
                    const actualStock = currentSceneStock[sale.item] || 0;
                    
                    // Check if player has max HP (if buying healing item)
                    const itemDef = itemRegistry[sale.item];
					const isHealingItem = itemDef && itemDef.name && itemDef.name.includes('Heal');
                    const isFullHP = gameState.currentHP >= gameState.maxHP;
                    
                    // RULE: Only display if in stock (actualStock > 0)
                    if (actualStock > 0) {
                        processedChoices.push({
                            text: `Buy ${sale.item.split('(')[0].trim()} (Stock: ${actualStock})`,
                            nextScene: sale.nextScene,
                            type: 'action',
                            cost: sale.cost,
                            stockItem: sale.item,
                            doomCost: 0, // FIX: Market stall is PROLOGUE (no doom)
                            isDisabled: isHealingItem && isFullHP
                        });
                    }
                });
                
                // 2. Add static navigation back in
                // Rename the selling button text
                if (sellWaresNav) {
                    processedChoices.push(sellWaresNav);
                }
                
                if (leaveNav) {
                    processedChoices.push(leaveNav);
                }

            } else if (currentSceneId === 'market_sell') {
                // Retrieve all original navigation buttons first
                const backToBuyNav = choices.find(c => c.nextScene === 'market_stall');
                const leaveNav = choices.find(c => c.nextScene === 'market_crossroads');
                
                processedChoices = []; 

                // Get sell options from blueprint
                const currentSellOptions = MARKET_SELL_OPTIONS;

                // Generate Dynamic Sell Options
                currentSellOptions.forEach(sell => {
                    // Check if the player has the item in inventory
                    if (gameState.inventory.includes(sell.item)) {
                        
                        // Special check for Curious Cargo: Merchant won't buy it if stock is 0 (one-time buy)
                        if (sell.item === 'Curious Cargo' && marketStock['Curious Cargo'] === 0) {
                            return; 
                        }
                        
                        processedChoices.push({
                            text: `Sell ${sell.item.split('(')[0].trim()} (+${sell.value}s)`, 
                            nextScene: sell.nextScene,
                            type: 'action',
                            reqItem: sell.item,
                            value: sell.value,
                            doomCost: sell.doomCost // Use explicit doomCost from blueprint (0 or 1 for cargo)
                        });
                    }
                });
                // Add back the navigation choices
                if (backToBuyNav) {
                    processedChoices.push(backToBuyNav);
                }
                if (leaveNav) {
                    processedChoices.push(leaveNav);
                }
                
            } else if (currentSceneId === 'alchemist_triage') {
                 // Isolate navigation choices and prepare to regenerate buy options
                const sellWaresNav = processedChoices.find(c => c.nextScene === 'alchemist_sell');
                const returnNav = processedChoices.find(c => c.nextScene === 'town_square');
                const secretTrade = processedChoices.find(c => c.nextScene === 'alchemist_secret_stock'); // Get the injected choice

                processedChoices = []; 

                // 1. Inject the secret trade button first if it exists
                if (secretTrade) {
                    processedChoices.push(secretTrade);
                }

                // 2. Generate Dynamic Buy Options
                ALCHEMIST_BUY_OPTIONS.forEach(sale => {
                    const itemText = sale.item.split('(')[0].trim();
                    const actualStock = currentSceneStock[sale.item] || 0;
                    
                    // Check if buying healing item when full HP
                    const itemDef = itemRegistry[sale.item];
					const isHealingItem = itemDef && (itemDef.name.includes('Tincture') || itemDef.name.includes('Potion'));
                    const isFullHP = gameState.currentHP >= gameState.maxHP;
                    
                    
                    // RULE: Only display if in stock (actualStock > 0)
                    if (actualStock > 0) {
                        processedChoices.push({
                            text: `Buy ${itemText} (${sale.cost}s)`,
                            nextScene: sale.nextScene,
                            type: 'action',
                            cost: sale.cost,
                            stockItem: sale.item,
                            doomCost: sale.doomCost, // FIX: Use explicit doomCost from blueprint (0)
                            isDisabled: isHealingItem && isFullHP
                        });
                    }
                });
                
                // 3. Add static navigation back in
                if (sellWaresNav) {
                    sellWaresNav.text = "Sell Wares (Premium)"; 
                    processedChoices.push(sellWaresNav);
                }
                
                if (returnNav) {
                    processedChoices.push(returnNav);
                }

            } else if (currentSceneId === 'alchemist_sell') {
                // Isolate navigation choices and prepare to regenerate sell options
                const backToBuyNav = choices.find(c => c.nextScene === 'alchemist_triage');
                const returnNav = choices.find(c => c.nextScene === 'town_square');
                
                processedChoices = []; 
                
				// Get sell options from blueprint
				const currentSellOptions = ALCHEMIST_SELL_OPTIONS;

				// Generate Dynamic Sell Options (Alchemist Stock)
				currentSellOptions.forEach(sell => {
					// RULE: Only display if player has the item in inventory
					if (gameState.inventory.includes(sell.item)) {
                        // FIX: Check if selling back Alchemist stock that is already maxed
                        let isDisabled = false;
                        if (sell.nextScene === 'sell_tincture' && currentSceneStock["Vitality Tincture"] >= 2) {
                            isDisabled = true; // Cannot sell back if Alchemist is fully stocked (max 2)
                        }

						processedChoices.push({
							// FIX: Removed manual (+${sell.value}s) string to avoid duplication
							text: `Sell ${sell.item.split('(')[0].trim()}`, 
							nextScene: sell.nextScene,
							type: 'action',
							reqItem: sell.item,
							value: sell.value,
							doomCost: sell.doomCost, // FIX: Use explicit doomCost from blueprint (0)
                            isDisabled: isDisabled
						});
					}
				});
                // Add back the navigation choices
                if (backToBuyNav) processedChoices.push(backToBuyNav);
                if (returnNav) processedChoices.push(returnNav);
            }
            // NEW: Blackwater Tavern Rest/Gruel Logic (Task 2 & 3)
            else if (currentSceneId === 'blackwater_tavern') {
                const restOption = choices.find(c => c.nextScene === 'tavern_rest_success');
                const returnOption = choices.find(c => c.nextScene === 'town_square');
                const gamblerOption = choices.find(c => c.nextScene === 'tavern_gambler');
                const infoSmelter = choices.find(c => c.nextScene === 'gather_info_smelter');
                const infoChapel = choices.find(c => c.nextScene === 'gather_info_chapel');
                const instantEat = choices.find(c => c.nextScene === 'eat_gruel_instant');
                const buyToGo = choices.find(c => c.nextScene === 'buy_gruel_to_go');
                // FIX 3: Confiscate dice button is ONLY in tavern_gambler, so don't retrieve it here.

                // Clear base choices to rebuild
                processedChoices = []; 
                const gruelStock = currentSceneStock['Gruel'] || 0;
                const canAfford = gameState.shillings >= 1;
                // FIX 3: Check if current HP is >= MaxHP (20). If so, healing is strictly wasteful/blocked by shield rule.
                const isHealingWasteful = gameState.currentHP >= gameState.maxHP; 
                
                // 1. Instant Eat Gruel (conditional visibility/disability)
                if (instantEat) {
                    let instantEatText = `Eat Gruel Now (Stock: ${gruelStock})`;
                    // Disable if full HP (20+), out of stock, or can't afford
                    let instantEatDisabled = !canAfford || gruelStock <= 0 || isHealingWasteful; 

                    processedChoices.push({
                        ...instantEat, 
                        text: instantEatText, 
                        cost: instantEat.cost, 
                        doomCost: 0, 
                        isDisabled: instantEatDisabled,
                    });
                }

                // 2. Buy Gruel (To Go)
                if (buyToGo) {
                    let buyToGoText = `Buy Gruel (To Go) (Stock: ${gruelStock})`;
                    // Disable if out of stock, or can't afford
                    let buyToGoDisabled = gruelStock <= 0 || !canAfford;

                    processedChoices.push({
                        ...buyToGo,
                        text: buyToGoText,
                        cost: buyToGo.cost, 
                        doomCost: 0, 
                        isDisabled: buyToGoDisabled
                    });
                }


                // 3. Rest Option (Task 3 Fix: doomCost: 3 added in scene definition)
                if (restOption) processedChoices.push(restOption);
                
                // 4. Info/Gambler options (non-cost options)
                if (infoSmelter && !gameState.knowsSmelterSecret) processedChoices.push(infoSmelter);
                if (infoChapel && !gameState.knowsChapelSecret) processedChoices.push(infoChapel);
                
                if (gamblerOption) processedChoices.push(gamblerOption);
                if (returnOption) processedChoices.push(returnOption);

            }
            // NEW: Docks Dynamic Work Button logic
            else if (currentSceneId === 'town_docks') {
                 // The onEnter logic handles updating the costHP on the WORK button.
                 const workBtn = choices.find(c => c.nextScene === 'docks_work');
                 const currentCost = workBtn.costHP !== undefined ? workBtn.costHP : 2;
                 const canAffordHP = gameState.currentHP > currentCost;
                 
                 // Find the button and update its isDisabled state based on HP cost
                 const processedWorkBtn = {
                    ...workBtn, 
                    text: workBtn.text, 
                    isDisabled: !canAffordHP,
                    // The doomCost: 1 is already on the button object itself
                 };

                 // Replace the original work button with the processed one
                 processedChoices = processedChoices.map(c => c.nextScene === 'docks_work' ? processedWorkBtn : c);
            }


            // --- Process Choices and Create Buttons ---
            processedChoices.forEach(choice => {
                
                // --- VISIBILITY (OMIT) CHECKS: Apply OMIT logic first ---
                
                // Check for required items (reqItem) and omit if missing.
                if (choice.reqItem && !gameState.inventory.includes(choice.reqItem)) {
                     // This correctly handles: Sell Curious Cargo, Search Smuggler's Drop (Ring of Brass), Use Rope, Use Torch
                     return;
                }
                
                // --- GENERAL REQUIREMENTS CHECK (Non-item reqs) ---
                if (choice.reqSmuggler && gameState.influence < choice.reqSmuggler) return;
                if (choice.reqGuard && gameState.influence > -choice.reqGuard) return;
                
                if (choice.reqNotItem && gameState.inventory.includes(choice.reqNotItem)) return; // NEW NOT ITEM CHECK
                // NEW: Information Flag Check
                if (choice.reqFlag && !gameState[choice.reqFlag]) return;
                if (choice.reqNotFlag && gameState[choice.reqNotFlag]) return; // Task 4: Reverse logic check

                // SKILL CHECK: If choice requires a skill, hide it if player doesn't have it
                if (choice.reqSkill && !gameState.skills.includes(choice.reqSkill) && choice.type !== 'skill') return;


                // --- DISABILITY (GREY OUT) CHECKS ---
                let isDisabled = false;
                let disabledClass = '';
                
                // Check 1: Affordability (Cost is defined for this choice AND player can't afford it)
                if (choice.cost && gameState.shillings < choice.cost) {
                    isDisabled = true;
                    disabledClass = 'btn-disabled-cost';
                }
                // Check 2: Health Cost (Crucial Docks Fix)
                if (choice.costHP !== undefined && gameState.currentHP <= choice.costHP) {
                    isDisabled = true;
                    disabledClass = 'btn-disabled-cost';
                }
                // Check 3: Custom disability flag (used for instant Gruel eat and now Buy Gruel)
                if (choice.isDisabled) {
                    isDisabled = true;
                    disabledClass = 'btn-disabled-cost';
                }
                
                
                const btn = document.createElement('button');
                
                // Determine styling: Is this a Hero/Skill moment?
                let isHeroButton = choice.reqSkill ? true : false;
                let isCustomClassButton = choice.customClass ? true : false;
                // FIXED LINE:
				// Added "choice.nextScene &&" to ensure we don't crash on Reset buttons
				let isTradeButton = choice.cost || choice.value || choice.shillingGain || (choice.nextScene && choice.nextScene.includes('sell') && currentSceneId.includes('alchemist'));
                let isSkillCheck = choice.type === 'skill';

                const alignmentClass = (isSkillCheck || isTradeButton || choice.chaosGain || choice.orderGain || choice.costHP !== undefined || choice.shillingGain || choice.doomCost !== undefined || choice.reqFlag) ? 'justify-start' : 'justify-between';
                
                let btnClass = "";
                
                if (isDeathScene) {
                    // Death button is always full red and large
                    btnClass = `btn-game w-full p-3 text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-red-900 border-red-700 hover:bg-red-800 hover:border-amber-500 text-white text-xl text-center`;
                } else if (isCustomClassButton) {
                    // Custom classes need the base styling mixed in for padding, shadow, etc.
                    // FIX 2: Check for Captain's Orders buttons (spectral-active) and style them similarly to Hero.
                    if (choice.customClass && choice.customClass.includes('spectral-active')) {
                         btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 spectral-active text-blue-100 ring-1 ring-blue-400 hover:ring-white`;
                    } else {
                        // All other custom classes (fire/shadow/hero/keen)
                        btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 ${choice.customClass}`;
                    }
                } else {
                    // STANDARD NARRATIVE/TRADE BUTTONS (Default grey button)
                    btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-gray-800 border-gray-600 hover:border-amber-500 hover:bg-gray-750 text-gray-300 group`;
                }
                
                // Apply disability visual override if necessary
                if (isDisabled) {
                    btnClass += ` ${disabledClass}`;
                    btn.disabled = true;
                }



				btn.className = btnClass;

                // --- EVENT HANDLER SPLIT ---
                
                // 1. HOLD INTERACTION (EXCLUSIVE)
                if (choice.type === 'hold') {
                    let holdTimer = null;
                    const duration = 3000; // Duration must match CSS logic
                    
                    // Sync CSS animation speed to JS timer
                    btn.style.setProperty('--channel-duration', `${duration}ms`);

                    const startChannel = (e) => {
                        // Prevent touch scrolling/selection while holding
                        if (e.type === 'touchstart') e.preventDefault(); 
                        
                        if (btn.disabled) return;
                        
                        btn.classList.add('channeling');
                        audioManager.playGhost(); 

                        holdTimer = setTimeout(async () => {
                            // SUCCESS: Channel Complete
                            audioManager.playClash(); 
                            
                            // *** ACT 2 TRANSITION FIX: Apply Ethereal theme immediately before renderScene ***
                            fxManager.setVignette(false); // FIX 1: Explicitly disable the low HP vignette
                            fxManager.clearEffects();     // FIX 1: Clear persistent visual effects (rift collapsed/pulse)
                            
                            gameState.isEthereal = true; // Set the state
                            document.body.classList.add('plane-ethereal'); // Apply the CSS class immediately
                            await saveGame(); // Save the state change before rendering the next scene to ensure persistence
                            
                            renderScene(choice.nextScene);
                        }, duration);
                    };

                    const cancelChannel = (e) => {
                        if (holdTimer) {
                            clearTimeout(holdTimer);
                            holdTimer = null;
                        }
                        btn.classList.remove('channeling');
                    };

                    // Mouse Events
                    btn.addEventListener('mousedown', startChannel);
                    btn.addEventListener('mouseup', cancelChannel);
                    btn.addEventListener('mouseleave', cancelChannel);

                    // Touch Events (Mobile)
                    btn.addEventListener('touchstart', startChannel);
                    btn.addEventListener('touchend', cancelChannel);
                    
                    // CRITICAL: Kill standard click so a quick tap does nothing
                    btn.onclick = null; 
                } 
                
                // 2. STANDARD CLICK INTERACTION (EXCLUSIVE)
                else {
                    btn.onclick = (e) => {
                        // If disabled, just play click sound and stop execution
                        if (btn.disabled) {
                             audioManager.playClick();
                             return;
                        }
                        
                        audioManager.playClick();
                        
                        if (choice.type === 'reset') {
                            resetGame();
                            return;
                        }
                        
                        // Mushroom Warning Check
                        if (gameState.crewUseFree && choice.type !== 'skill' && choice.type !== 'dialogue' && !choice.nextScene.includes('captain_orders')) {
                            addToHistory(`*Warning: The Pearlescent Mushroom's clarity is best saved for a crucial skill check.*`, 'system');
                        }

                        // Stock Checks
                        if (choice.type === 'action' && (currentSceneId === 'market_stall' || currentSceneId === 'alchemist_triage' || currentSceneId === 'blackwater_tavern') && choice.stockItem) {
                             const currentStock = scenes[currentSceneId].stock[choice.stockItem] || 0;
                             if (currentStock <= 0) {
                                addToHistory(`${choice.stockItem} is out of stock.`, 'system');
                                renderScene(currentSceneId); 
                                return;
                            }
                        }
                        
                        // Curious Cargo Check
                        if (choice.type === 'action' && choice.reqItem === 'Curious Cargo' && currentSceneId === 'market_sell') {
                             if (marketStock['Curious Cargo'] <= 0) {
                                addToHistory(`The Market Merchant has no need for another Curious Cargo.`, 'system');
                                renderScene(currentSceneId);
                                return;
                            }
                        }

                        // Consume Items
                        if (choice.consume && choice.reqItem) {
                            const idx = gameState.inventory.indexOf(choice.reqItem);
                            if (idx > -1) {
                                gameState.inventory.splice(idx, 1);
                                addToHistory(`${choice.reqItem} used and discarded.`, 'system');
                            }
                        }

                        // Journal Entry
                        const currentScene = scenes[gameState.currentSceneId];
                        if (currentScene.journal !== null && currentScene.journal !== undefined) {
                            addToHistory(currentScene.journal, 'entry');
                        }

                        // Apply Costs & Gains
                        if (choice.cost) gameState.shillings -= choice.cost;
                        if (choice.costHP !== undefined) gameState.currentHP = applyDamage(gameState.currentHP, choice.costHP); 
                        if (choice.shillingGain) gameState.shillings += choice.shillingGain;
                        if (choice.value) gameState.shillings += choice.value;
                        if (choice.chaosGain) gameState.influence = Math.min(20, gameState.influence + choice.chaosGain);
                        if (choice.orderGain) gameState.influence = Math.max(-20, gameState.influence - choice.orderGain); 
                        
                        // Crew Selection Hook
                        if (choice.nextScene === 'lighthouse_morning' && currentSceneId === 'captain_orders' && choice.onSelect) {
                            choice.onSelect(gameState);
                        }

                        // Doom Counter Decrement
                        if (gameState.act1Started && choice.doomCost !== 0) {
                            const cost = choice.doomCost !== undefined ? choice.doomCost : 1; 
                            gameState.doomTimer = Math.max(0, gameState.doomTimer - cost);
                            
                            if (gameState.doomTimer > 0) {
                                addToHistory(`Rift Stability: ${gameState.doomTimer} turns remaining.`, 'system');
                            }
                            
                            // FIX 2: Replaced the old redundant collapse logic with a check against the new hasLoggedCollapse flag
                            if (gameState.doomTimer <= 0 && !gameState.isRiftCollapse) {
                                gameState.isRiftCollapse = true;
                                gameState.hasLoggedCollapse = true; // Logged the message
                                
                                gameState.maxHP = Math.max(1, gameState.maxHP - 5);
                                gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);
                                addToHistory(`!!! RIFT COLLAPSE !!! The veil has ruptured. All Skill Check DCs are permanently increased by 2. Max HP reduced by 5 due to toxic air.`, 'system');
                            }
                        }
                        
                        // Handle Skill Checks vs Standard Navigation
                        if (choice.type === 'skill') {
                            gameState.lastSkillType = choice.skill;
                            let finalDC = choice.dc;
                            // Check for permanent difficulty increase after rift collapse
                            if (gameState.isRiftCollapse) { 
                                finalDC += 2;
                                addToHistory(`Rift Penalty: DC increased by 2 (New DC: ${finalDC})`, 'system');
                            }
                            gameState.lastDC = finalDC;
                            renderScene(choice.nextScene);
                            return;
                        }
                        
                        if (choice.type !== 'skill') {
                            renderScene(choice.nextScene);
                        }
                    };
                }


                
                // Default icon for travel/dialogue buttons
                let icon = '<i class="fas fa-chevron-right text-gray-300 group-hover:text-amber-100"></i>';
                
                // Get the *raw* button text without cost duplication.
                let rawText = choice.text; 
                
                let content = `<span class="cinzel font-bold text-gray-300 group-hover:text-amber-100">${rawText}</span>`;
                let supplementalText = '';
                
                // Check if button is colored and adjust default icon color
                if (isCustomClassButton) {
                    // Custom classes need the base styling mixed in for padding, shadow, etc.
                    content = `<span class="cinzel font-bold text-white">${rawText}</span>`;
                    
                    // NEW FIX: Success Glow Icon (Whisper)
                    if (choice.customClass === 'btn-success-glow') {
                         icon = '<i class="fas fa-ear-listen text-gray-300"></i>';
                    }
                    // Custom Icon Logic for Keen Senses
                    else if (choice.customClass === 'btn-keen-senses') {
                         icon = '<i class="fas fa-eye text-purple-300"></i>';
                    } else if (choice.customClass && choice.customClass.includes('spectral-active')) {
                         // FIX 2: Captain's orders buttons use chevron and spectral glow
                         icon = '<i class="fas fa-chevron-right text-white"></i>';
                    } else {
                        // General custom button icon (e.g. Fire/Shadow/Hero/Final Reset)
                        icon = '<i class="fas fa-chevron-right text-white"></i>';
                    }
                }
                
                // Override icon for trade buttons
                if (isTradeButton) {
                    icon = '<i class="fas fa-coins text-amber-500"></i>';
                }
				if (choice.type === 'reset') {
					icon = '<i class="fas fa-sync-alt text-gray-400 group-hover:text-white"></i>';
				}

                if (isSkillCheck) {
                    // Skill notation and dice icon are aligned immediately after the label
                    // Apply spectral glow effect (MODIFIED)
                    supplementalText += ` <span class="spectral-text-glow text-sm uppercase tracking-wider ml-2 mr-4">[${choice.skill} DC ${choice.dc}]</span>`;
                    // Dice icon also receives spectral glow (MODIFIED)
                    icon = '<i class="fas fa-dice-d20 spectral-text-glow"></i>';
                } else if (isHeroButton) {
                    // Hero Button Icon (NEW)
                    icon = '<i class="fas fa-star hero-icon"></i>'; 
                }
                
                // --- Consistent Currency/Value/Influence Display ---
                let indicators = [];

                // 1. Shilling Cost/Value/Gain (Money Indicators)
                if (choice.cost) {
                    indicators.push({ text: `-${choice.cost}s`, color: 'text-amber-500' });
                } else if (choice.value) {
                    indicators.push({ text: `+${choice.value}s`, color: 'text-amber-500' });
                } else if (choice.shillingGain) {
                    indicators.push({ text: `+${choice.shillingGain}s`, color: 'text-amber-500' });
                }

                // 2. Health Cost/Gain
                // Use !== undefined check to include the 0 HP base cost for dynamic calculation
                if (choice.costHP !== undefined) { 
                    indicators.push({ text: `-${choice.costHP} HP`, color: 'text-red-400' });
                }

                // 3. Chaos/Order Gain
                if (choice.chaosGain) {
                    indicators.push({ text: `+${choice.chaosGain} Chaos`, color: 'text-emerald-400' });
                } else if (choice.orderGain) {
                    indicators.push({ text: `+${choice.orderGain} Order`, color: 'text-blue-400' });
                }
                
				// 4. Doom Cost
				// FIX: Check if Quinn's Logistics is active AND the cost is > 0 OR it's explicitly defined as 0 on an action button.
				const isStandardAct1Scene = gameState.act1Started && !scenes[currentSceneId].isBoss && !scenes[currentSceneId].isRest;
				const hasExplicitCost = choice.doomCost !== undefined;
                const cost = hasExplicitCost ? choice.doomCost : (isStandardAct1Scene ? 1 : 0);
                
				if (gameState.act1Started && gameState.quinnLogistics && cost >= 0 && choice.type !== 'reset') {
					if (cost > 0) {
						indicators.push({ text: `-${cost} Turns`, color: 'text-purple-400' });
					} else if (cost === 0 && (hasExplicitCost || choice.type === 'travel')) {
						// Only display '0 Turns' if it's explicitly 0 (shopping) or a travel button in Act 1 (for consistency)
						indicators.push({ text: `0 Turns`, color: 'text-purple-400' });
					}
				}

                // Build supplemental text string using all indicators
                let indicatorString = '';
                indicators.forEach(ind => {
                    // Append a space, then the indicator text, wrapped in its span
                    indicatorString += ` <span class="${ind.color} text-sm ml-1">(${ind.text})</span>`;
                });

				// 1. Always append the Skill Info (supplementalText) to the content if it exists.
                // This ensures it renders even if there are no costs (indicatorString).
                if (supplementalText) {
                    content += supplementalText;
                }

                // 2. Render the button HTML
                if (indicatorString) {
                    // Case A: We have Costs/Gains/Indicators
                    // render content + indicators + right-aligned icon
                    // NEW: Wrap content for z-index layering
					btn.innerHTML = `<div class="btn-content-wrapper ${alignmentClass}">${content} ${indicatorString} <span class="ml-auto">${icon}</span></div>`;
                } else {
                    // Case B: No costs (Prologue/Standard Travel)
                    // We still add <span class="ml-auto"> to force the icon to the far right,
                    // which fixes the alignment issue for Skill Checks using 'justify-start'.
                    btn.innerHTML = `${content} <span class="ml-auto">${icon}</span>`;
                }


                container.appendChild(btn);
            });
        }

        function updateUI() {
            // PROLOGUE & LOG UI HANDLING
            const statsPanel = document.getElementById('stats-panel');
            const journalContainer = document.getElementById('journal-container');
            const sceneId = gameState.currentSceneId;
            
            if (sceneId && sceneId.startsWith('prologue')) {
                statsPanel.classList.add('prologue-blur');
                journalContainer.classList.add('log-hidden');
                journalContainer.classList.remove('log-visible');
            } else {
                statsPanel.classList.remove('prologue-blur');
                statsPanel.classList.add('prologue-active');
                
                if(gameState.inventory.includes("Ship's Log")) {
                    journalContainer.classList.remove('log-hidden');
                    journalContainer.classList.add('log-visible');
                } else {
                    journalContainer.classList.add('log-hidden');
                    journalContainer.classList.remove('log-visible');
                }
            }

            // HP
            const baseMaxHP = 20; // Define base max HP for display purposes
            
            // FIX 3: HP Display Logic (Handles Overheal)
            // If current HP is 25 (overheal), the displayed max HP should still be 20.
            const displayMaxHP = gameState.maxHP; // Should be 20 unless reduced by rift collapse
            const hpToDisplay = gameState.currentHP;

            // Bar calculation uses the actual maxHP for percentage
            const hpPct = (hpToDisplay / displayMaxHP) * 100;
            const bar = document.getElementById('hp-bar');
            
            bar.style.width = `${Math.min(100, hpPct)}%`;
            bar.className = `h-full transition-all duration-500 ${hpToDisplay < (displayMaxHP * 0.3) ? 'bg-red-600 animate-pulse' : 'bg-red-800'}`;
            
            document.getElementById('hp-text').innerText = `${hpToDisplay}/${displayMaxHP}`; 

            // Check for low health audio
            audioManager.checkVulnerable(gameState.currentHP, gameState.maxHP);
            
            // Note: Vignette check moved to renderScene()
            
            // --- DOOM COUNTER UI ---
            const doomDisplay = document.getElementById('doom-counter-display');
            const doomText = document.getElementById('doom-timer-text');
            const doomBar = document.getElementById('doom-bar');
            const maxDoom = 20; // UPDATED MAX RIFT STABILITY

            if (gameState.act1Started) {
                doomDisplay.classList.remove('hidden'); // Show the doom counter
                doomText.textContent = `${gameState.doomTimer} Turns`;
                const doomPct = (gameState.doomTimer / maxDoom) * 100;
                doomBar.style.width = `${doomPct}%`;
                
                // Flash red when timer is low or collapsed
                if (gameState.isRiftCollapse) {
                    doomBar.classList.add('bg-red-700', 'animate-pulse');
                    doomBar.classList.remove('bg-purple-600');
                    doomText.textContent = `COLLAPSED!`;
                    doomText.classList.add('text-red-500');
                } else if (gameState.doomTimer <= 5) {
                    doomBar.classList.add('bg-yellow-600', 'animate-pulse');
                    doomBar.classList.remove('bg-purple-600');
                    doomText.classList.add('text-yellow-500');
                } else {
                     doomBar.classList.remove('bg-red-700', 'bg-yellow-600', 'animate-pulse');
                     doomBar.classList.add('bg-purple-600');
                     doomText.classList.remove('text-red-500');
                }
            } else {
                doomDisplay.classList.add('hidden'); // Hide doom counter outside Act 1
            }
            
            // Money
            document.getElementById('shillings-display').innerText = gameState.shillings;
            
            // Influence
            const inf = gameState.influence || 0;
            const pct = ((inf + 20) / 40) * 100;
            const marker = document.getElementById('inf-marker');
            if (marker) marker.style.left = `${Math.max(0, Math.min(100, pct))}%`;
            
            const infText = document.getElementById('inf-status-text');
            if (infText) {
                if (inf < -10) infText.textContent = "Sworn to the Crown";
                else if (inf < -5) infText.textContent = "Respected by Guards";
                else if (inf > 10) infText.textContent = "Pirate Lord";
                else if (inf > 5) infText.textContent = "Known Smuggler";
                else infText.textContent = "Unknown / Neutral";
            }

            // Crew UI
            const ind = document.getElementById('active-crew-indicator');
            const nameSpan = document.getElementById('active-crew-name');
            if (activeCrewMember) {
                ind.classList.remove('hidden');
                nameSpan.innerText = activeCrewMember.name;
            } else {
                ind.classList.add('hidden');
            }

            const crewContainer = document.getElementById('crew-panel');
            crewContainer.innerHTML = '';
            
            // Define fixed order of keys
            const crewOrder = ['gareth', 'quinn', 'talon', 'bones'];
            
            crewOrder.forEach(key => {
                const c = gameState.crew[key];
                if (!c) return; // Safety check

                const btn = document.createElement('button');
                const isSelected = activeCrewMember && activeCrewMember.name === c.name;
                // Determine if this crew member is available for FREE USE
                const isAvailableForFreeUse = gameState.crewUseFree && !c.used;

                let baseClass = "p-2 rounded border text-left transition-all relative overflow-hidden ";
                
                
                if (c.used) { 
                    // Used crew members are disabled
                    baseClass += "bg-black/50 border-gray-800 text-gray-700 cursor-not-allowed opacity-50";
                } else if (gameState.crewUseFree && isSelected) {
                     // Mushroom active AND this member is SELECTED: Apply purple glow to selected member
                     baseClass += "crew-free-use-glow";
                } else if (gameState.crewUseFree && !isSelected) {
                    // Mushroom active but NOT SELECTED: Apply purple pulse *only* if no crew member is active
                    if (!activeCrewMember) {
                        baseClass += "crew-free-use-glow";
                    } else {
                         baseClass += "bg-gray-800 border-gray-600 text-gray-300 hover:border-gray-400 hover:bg-gray-700"; // Normal styling if another crew member is already selected
                    }
                } else if (isSelected) {
                    // Standard selection glow
                    // Use new spectral-active class (MODIFIED)
                    baseClass += "spectral-active text-blue-100 ring-1 ring-blue-400";
                } else {
                    baseClass += "bg-gray-800 border-gray-600 text-gray-300 hover:border-gray-400 hover:bg-gray-700";
                }

                // --- TUTORIAL PULSE LOGIC FIX ---
                // Only pulse Quinn at the start if he is not used AND no one is selected
                if (gameState.currentSceneId === 'start' && c.name === 'Quinn' && !c.used && !activeCrewMember) {
                    baseClass += " tutorial-pulse";
                }
                // --- END TUTORIAL PULSE FIX ---

                btn.className = baseClass;
                // Only disable if USED
                btn.disabled = c.used; 
                btn.innerHTML = `
                    <div class="font-bold text-[12px] cinzel leading-tight">${c.name}</div>
                    <div class="text-[10px] ${isSelected || isAvailableForFreeUse ? 'text-white' : 'text-gray-500'}">${c.skill}</div>
                    ${c.used ? '<i class="fas fa-lock absolute top-1 right-1 text-[10px]"></i>' : ''}
                    ${isAvailableForFreeUse ? '<i class="fas fa-star absolute top-1 right-1 text-[10px] text-purple-300"></i>' : ''}
                `;
                btn.onclick = () => {
                    audioManager.playClick();
                    
                    if (isSelected) {
                        activeCrewMember = null;
                    } else {
                        activeCrewMember = c;
                        audioManager.playGhost(); // Only play when selecting
                    }
                    updateUI();
                };
                crewContainer.appendChild(btn);
            });

            // Inventory List View
            const invContainer = document.getElementById('inventory-panel');
            invContainer.innerHTML = '';
            
            // SCALABILITY FIX: Add scrolling for large inventories
            invContainer.className = "flex flex-col gap-1 max-h-[220px] overflow-y-auto pr-1"; // Added max-height & scroll

            const descArea = document.getElementById('item-desc-area');
            const defaultText = "Hover over an item to inspect it.";

            // Reset description area appearance
            descArea.innerText = defaultText;
            descArea.classList.remove('text-amber-400');
            descArea.classList.add('text-gray-400'); 
            
            if (gameState.inventory.length === 0) {
                invContainer.innerHTML = '<div class="text-center text-[10px] text-gray-600 italic py-2">Inventory Empty</div>';
            } else {
			// SORTING LOGIC: Consumables First, then Newest at Top
            // 1. Reverse the array first so newest items (end of array) come first.
            // 2. Sort by type, returning 0 if types match to preserve the reversed (newest) order.
            const sortedInventory = [...gameState.inventory].reverse().sort((a, b) => {
                const itemA = itemRegistry[a] || { type: 'misc' };
                const itemB = itemRegistry[b] || { type: 'misc' };

                // Priority 1: Consumables float to the top
                if (itemA.type === 'consumable' && itemB.type !== 'consumable') return -1;
                if (itemA.type !== 'consumable' && itemB.type === 'consumable') return 1;

                // Priority 2: Maintain relative order (which is now Newest-First due to .reverse())
                return 0;
            });

                sortedInventory.forEach(itemName => {
                    const itemDef = itemRegistry[itemName] || { type: 'misc', icon: 'fa-box', color: 'text-gray-500', desc: "A strange item." };
                    const isConsumable = itemDef.type === 'consumable';
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = `group w-full flex items-center justify-between p-2 rounded border transition-all cursor-default relative shrink-0 ${
                        isConsumable 
                        ? 'bg-gray-900/80 border-emerald-900/50 hover:border-emerald-500 hover:bg-gray-800' 
                        : 'bg-gray-900/60 border-gray-800 hover:border-gray-600'
                    }`;

                    // Left Side: Icon + Name
                    const leftSide = document.createElement('div');
                    leftSide.className = 'flex items-center gap-3';
                    leftSide.innerHTML = `
                        <div class="text-lg w-5 text-center ${itemDef.color}"><i class="fas ${itemDef.icon}"></i></div>
                        <span class="text-xs cinzel text-gray-300 group-hover:text-gray-100 transition-colors">${itemName.split('(')[0].trim()}</span>
                    `;
                    itemRow.appendChild(leftSide);

                    // Right Side: Action Button or Tag
                    const rightSide = document.createElement('div');
                    if (isConsumable && itemDef.btnText !== 'USE' && itemDef.btnText !== 'INSPECT' && itemDef.btnText !== 'THROW') { // Only show button for consumable items that have a direct action (Heal/Revive)
                        const actionBtn = document.createElement('button');
                        actionBtn.className = "px-2 py-1 bg-emerald-900/40 border border-emerald-600/30 text-emerald-500 text-[9px] font-bold rounded hover:bg-emerald-600 hover:text-white transition-all tracking-wider";
                        actionBtn.innerText = itemDef.btnText || "USE";
                        actionBtn.onclick = (e) => {
                            e.stopPropagation();
                            audioManager.playClick();
                            const result = itemDef.action(gameState);
                            addToHistory(result, 'system');
                            saveGame();
                            updateUI();
                        };
                        rightSide.appendChild(actionBtn);
                    } else {
                        const tag = document.createElement('span');
                        tag.className = "text-[9px] text-gray-600 uppercase tracking-wider font-bold opacity-50 group-hover:opacity-100 transition-opacity";
                        tag.innerText = itemDef.btnText || "PASSIVE";
                        rightSide.appendChild(tag);
                    }
                    itemRow.appendChild(rightSide);

                    // Hover Description Logic
                    itemRow.onmouseenter = () => {
                        descArea.innerText = itemDef.desc || defaultText;
                        descArea.classList.add('text-amber-400');
                        descArea.classList.remove('text-gray-400');
                    };
                    itemRow.onmouseleave = () => {
                        descArea.innerText = defaultText;
                        descArea.classList.remove('text-amber-400');
                        descArea.classList.add('text-gray-400');
                    };

                    invContainer.appendChild(itemRow);
                });
            }
        }

        init();
    </script>
</body>
</html>