<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edward Jones: The Mariner of the Damned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen md:h-screen md:overflow-hidden overflow-y-auto bg-[#050a10] text-[#cdd5e0] select-none flex flex-col">

    <div id="app-loading" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black text-white">
        <div class="text-4xl cinzel text-blue-500 mb-4 animate-pulse text-center px-4">Edward Jones:<br>The Mariner of the Damned</div>
        <div class="text-gray-400 cinzel text-sm">Summoning the Crew...</div>
    </div>

    <div class="fixed top-4 right-4 z-50">
        <button id="audio-toggle" class="bg-gray-800/80 border border-gray-600 text-gray-400 p-2 rounded-full hover:text-amber-500 transition-colors w-10 h-10 flex items-center justify-center shadow-lg backdrop-blur">
            <i class="fas fa-volume-mute"></i>
        </button>
    </div>

    <div id="main-game-container" class="grid grid-cols-1 md:flex md:flex-row max-w-7xl mx-auto w-full p-2 pb-32 md:p-4 gap-4 md:h-full h-auto">
        
        <div class="contents md:flex md:flex-col md:w-1/3 gap-3 shrink-0 relative z-50">
            
            <div class="order-1 md:order-none relative w-full aspect-video md:aspect-[4/3] bg-gray-900 rounded border border-gray-700 overflow-hidden shadow-2xl shrink-0 group">
                <button id="reset-game-btn" onclick="confirmReset()" class="absolute top-2 left-2 z-30 text-[10px] border border-red-900/50 text-red-400 bg-black/60 hover:text-red-200 hover:bg-red-900/80 px-2 py-1 rounded transition-all cinzel font-bold backdrop-blur-sm">
                    <i class="fas fa-skull mr-1"></i>New Game
                </button>

                <div id="fx-overlay"></div>
				<div id="vignette-overlay" class="absolute inset-0 pointer-events-none z-20 transition-opacity duration-500 opacity-0"></div>

                <div id="image-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-gray-500 z-10" style="display: none;">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-amber-600"></i>
                        <span class="text-xs cinzel tracking-widest text-amber-600">Manifesting Vision...</span>
                    </div>
                </div>
                <img id="scene-image" src="" alt="Scene Visualization" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000">
                
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4">
                    <h2 id="scene-title" class="text-xl cinzel text-amber-500 text-shadow"></h2>
                </div>
            </div>

            <div id="stats-panel" class="order-4 md:order-none bg-gray-800/80 rounded border border-gray-700 p-3 flex flex-col gap-3 shadow-lg backdrop-blur-sm relative transition-all duration-1000">
                <div>
					<div class="flex justify-between text-sm cinzel text-gray-400 mb-1">
						<span>Edward Jones</span>
						<span id="hp-text">20/20</span>
					</div>
					<div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-gray-700">
						<div id="hp-bar" class="bg-red-800 h-full w-full transition-all duration-500"></div>
					</div>
				</div>
				<div id="enemy-status-effects" class="flex gap-2 mt-2 flex-wrap"></div>

				<div id="doom-counter-display" class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative hidden mt-2">
					<div class="flex justify-between items-center cinzel text-xs uppercase tracking-wider font-bold">
						<span class="text-purple-400"><i class="fas fa-bolt mr-1"></i>Rift Stability</span>
						<span id="doom-timer-text"></span>
					</div>
					<div class="relative w-full h-1 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
						<div id="doom-bar" class="absolute inset-0 bg-purple-600 transition-all duration-500"></div>
					</div>
				</div>

				<div id="tether-display" class="bg-gray-900 p-2 rounded border border-cyan-700 flex flex-col text-[10px] gap-2 relative hidden mt-2 transition-all duration-500">
					<div class="flex justify-between items-center cinzel text-xs uppercase tracking-wider font-bold">
						<span class="text-cyan-400"><i class="fas fa-link mr-1"></i>Spectral Tether</span>
						<span id="tether-text" class="text-cyan-100">20 Turns</span>
					</div>
					<div class="relative w-full h-1 bg-gray-800 rounded-full border border-cyan-900 overflow-hidden">
						<div id="tether-bar" class="absolute inset-0 bg-tether transition-all duration-500 w-full"></div>
					</div>
				</div>

				<div class="bg-gray-900 p-2 pb-3 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative mt-2">
					<div class="flex justify-between items-center cinzel text-[10px] uppercase tracking-wider font-bold">
						<span class="text-blue-400"><i class="fas fa-shield-alt mr-1"></i>Order</span>
						<span id="inf-status-text" class="text-gray-500 text-[9px] truncate max-w-[140px] text-center">Unknown</span>
						<span class="text-emerald-400">Chaos<i class="fas fa-skull-crossbones ml-1"></i></span>
					</div>
					<div class="relative w-full h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
						<div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-gray-800 to-emerald-900 opacity-60"></div>
						<div id="inf-marker" class="absolute top-0 bottom-0 w-1.5 bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] z-10 rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
					</div>
				</div>

				<div class="radial-container mt-2">
					<div class="radial-grid-mask"><div class="radial-planar-grid"></div></div>
					<div id="tether-gareth" class="spectral-tether tether-nw"></div>
					<div id="tether-quinn" class="spectral-tether tether-ne"></div>
					<div id="tether-talon" class="spectral-tether tether-sw"></div>
					<div id="tether-bones" class="spectral-tether tether-se"></div>
					<div id="radial-hub" class="radial-hub">
						<div class="cinzel font-bold text-cyan-200 text-xs leading-tight text-center mt-2">GUIDING<br>VOICE</div>
						<div class="text-cyan-400 text-xs mt-0.5 font-bold animate-pulse tracking-widest">+1d4</div>
					</div>
					<div id="node-gareth" class="crew-node node-nw" onclick="window.toggleCrewSelection('gareth')"></div>
					<div id="node-quinn" class="crew-node node-ne" onclick="window.toggleCrewSelection('quinn')"></div>
					<div id="node-talon" class="crew-node node-sw" onclick="window.toggleCrewSelection('talon')"></div>
					<div id="node-bones" class="crew-node node-se" onclick="window.toggleCrewSelection('bones')"></div>
				</div>
				
				<div id="abilities-combined-container" class="grid grid-cols-2 gap-2 mt-2 hidden">
					<div id="planar-skills-container" class="hidden h-full flex flex-col">
						<div class="text-xs cinzel font-bold uppercase tracking-wider text-cyan-400 border-b border-cyan-900/50 mb-1 pb-1">Horizon Walker</div>
						<div id="planar-skills-list" class="flex flex-col gap-1">
							</div>
					</div>
					
					<div id="companion-panel" class="hidden h-full flex flex-col">
						<div class="text-xs cinzel font-bold uppercase tracking-wider text-emerald-400 border-b border-emerald-900/50 mb-1 pb-1">Allies</div>
						<div id="companions-list" class="flex flex-col gap-1">
							</div>
					</div>
				</div>

				<div id="inventory-combined-container" class="mt-auto relative z-50"> 
					<div id="backpack-modal" class="hidden p-4 rounded-lg gap-2 flex flex-col transition-all duration-300">
						<div class="text-center cinzel text-amber-500 font-bold border-b border-gray-700 pb-2 mb-2">Captain's Pack</div>
						
						<div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
							<div class="flex items-center gap-2">
								<i class="fas fa-coins text-[20px] text-amber-500"></i>
								<div class="flex flex-col leading-none">
									<span class="text-[10px] text-gray-500 uppercase tracking-wider">Shillings</span>
									<span id="shillings-display" class="text-amber-100 font-mono">0</span>
								</div>
							</div>
							<div id="supplies-display" class="flex items-center gap-2 hidden">
								<div class="flex flex-col leading-none items-end">
									<span class="text-[10px] text-gray-500 uppercase tracking-wider">Supplies</span>
									<span id="supplies-count" class="text-indigo-100 font-mono">0</span>
								</div>
								<i class="fas fa-anchor text-[20px] text-indigo-400"></i>
							</div>
						</div>
						
						<div id="item-desc-area" class="text-xs text-gray-400 h-8 italic mb-2 text-center leading-tight flex items-center justify-center bg-gray-800/50 border border-gray-600/50 rounded px-1 shrink-0">
							Hover to inspect.
						</div>
						<div id="inventory-panel" class="flex flex-col gap-1 max-h-[250px] overflow-y-auto pr-1"></div>
					</div>
					
					<button id="btn-combined-pack" onclick="window.gameFunctions.toggleBackpack()" class="w-full p-2 rounded bg-gray-900 border border-amber-700/50 hover:border-amber-500 hover:bg-gray-800 text-amber-500 hover:text-amber-100 transition-all shadow-md relative z-50 mt-2">
						<div class="flex items-center gap-3 w-full">
							<span class="cinzel font-bold tracking-wider text-sm">Captain's Pack</span>
							<div id="pack-resources-display" class="ml-auto flex items-center gap-3 font-bold text-sm"></div>
						</div>
					</button>
				</div>
                
            </div>
        </div>

        <div class="contents md:flex md:flex-col md:w-2/3 gap-4">
             <div id="main-scene-text" class="order-2 md:order-none bg-[#111318] rounded border border-gray-700 p-6 shadow-inner relative min-h-[160px] h-auto shrink-0 transition-all flex flex-col justify-center">
                <div class="text-center text-gray-500 italic">Initializing Story...</div>
            </div>
            <div class="order-3 md:order-none shrink-0 flex flex-col gap-2">
                <div id="choices-area" class="grid grid-cols-1 gap-2">
                    </div>
            </div>
            <div class="order-5 md:order-none w-full flex flex-col shrink-0">
				<div id="journal-container" class="order-5 md:order-none log-hidden h-96 md:h-[476px] shrink-0 rounded border border-gray-600 bg-gray-800 shadow-2xl flex flex-col overflow-hidden relative mb-6">
				<div class="bg-[#0f172a] text-center py-1 border-b border-gray-700 z-10 shadow-md">
					<h3 class="cinzel text-amber-600 text-sm tracking-[0.2em] font-bold">The Log of The Trident's Kiss</h3>
				</div>
				<div id="journal-scroll-area" class="flex-1 min-h-0 water-stained p-6 overflow-y-auto">
					<div id="journal-content" class="space-y-6">
						 </div>
					<div class="h-4"></div>
				</div>
				<div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
			</div>
			</div>
        </div>
    </div>
	<div class="order-last w-full h-32 md:hidden shrink-0"></div>
	
	<div id="dreamscape-overlay">
    <div class="dream-modal-content">
        <div class="relative h-40 md:h-64 w-full bg-black overflow-hidden border-b-2 border-cyan-900 shrink-0">
    		<img src="images/dreamscape_banner.jpg" class="w-full h-full object-cover object-[center_80%] opacity-60">
				<div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent"></div>
				<div class="absolute top-0 left-0 right-0 h-full flex flex-col items-center justify-center p-4 text-center">
					<h2 class="text-3xl md:text-5xl cinzel text-cyan-400 text-shadow tracking-widest mt-4">Dreamscape Sanctuary</h2>
				</div>
			</div>
			<div class="p-4 md:p-6 bg-[#0f172a] flex-1">
				<div class="flex flex-wrap justify-center gap-6 mb-4 cinzel font-bold text-sm tracking-widest uppercase">
					<div class="flex items-center text-emerald-400 drop-shadow-md">
						<i class="fas fa-heart mr-2"></i> +5 Max HP
					</div>
					<div class="flex items-center text-red-400 drop-shadow-md">
						<i class="fas fa-fist-raised mr-2"></i> +1 Base Dmg
					</div>
					<div class="flex items-center text-purple-400 drop-shadow-md">
						<i class="fas fa-bed mr-2"></i> Long Rest
					</div>
				</div>

				<div id="dream-text-container" class="dream-narrative min-h-[80px] flex items-center justify-center"></div>

				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4" id="dream-card-grid">
					</div>

				<div class="mt-6 flex justify-center">
					<button id="btn-wake-up" onclick="window.gameFunctions.confirmDreamSelection()" class="hidden px-8 py-3 bg-transparent border-2 border-cyan-500 text-cyan-400 rounded hover:bg-cyan-900/30 hover:text-white hover:border-white transition-all cinzel font-bold text-sm shadow-[0_0_20px_rgba(34,211,238,0.3)] tracking-widest uppercase">
						Confirm Bond & Wake Up
					</button>
				</div>
			</div>
		</div>
	</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
		
		// --- IMPORT NEW MODULES ---
		import { sceneImages, itemRegistry, STATUS_EFFECTS } from './assets.js';

		// --- ATTACH TO WINDOW (Bridge for legacy code & assets.js) ---
		window.sceneImages = sceneImages;
		window.itemRegistry = itemRegistry;
		window.STATUS_EFFECTS = STATUS_EFFECTS;

        const firebaseConfig = {
			apiKey: "AIzaSyDlg5dETZJpbJ9GzMV01pUYA06XbFmySbw",
			authDomain: "edward-jones-75546.firebaseapp.com",
			projectId: "edward-jones-75546",
			storageBucket: "edward-jones-75546.firebasestorage.app",
			messagingSenderId: "76799051768",
			appId: "1:76799051768:web:fdd3641b597adfc6a0780d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "edward-jones-standalone";
        let user;
        const MAX_OVERHEAL_CAP = 25;

        // ... [Keep existing Audio/FX Managers] ...
		// --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                this.ambience = new Audio('audio/ambience.mp3');
                this.ambience.loop = true;
                this.ambience.volume = 0.3;
                
                this.clickSound = new Audio('audio/click.mp3');
                this.clickSound.volume = 0.4;
                
                this.gaspSound = new Audio('audio/gasp.mp3');
                this.gaspSound.volume = 0.3;
                
                this.clashSound = new Audio('audio/clash.mp3');
                this.clashSound.volume = 0.5;
                
                this.coinsSound = new Audio('audio/coins.mp3');
                this.coinsSound.volume = 0.4;
                
                this.vulnerableSound = new Audio('audio/vulnerable.mp3');
                this.vulnerableSound.volume = 0.6;
                this.vulnerableSound.loop = true;
                
                this.ghostSound = new Audio('audio/ghost2.mp3');
                this.ghostSound.volume = 0.5;
				
				
				this.diceSound = new Audio('audio/dice.mp3');
				this.diceSound.volume = 0.7; // Volume for the rattle
				this.successSound = new Audio('audio/success.mp3');
				this.successSound.volume = 0.6; // Volume for the "ding"
				this.failSound = new Audio('audio/fail.mp3');
				this.failSound.volume = 0.7; // Volume for the "dun-dun"

                this.isMuted = true;
                this.hasInteracted = false;
                
                this.playedVulnerable = false;

                const btn = document.getElementById('audio-toggle');
                btn.onclick = () => this.toggleMute();
            }

            playSFX(soundObj) {
                if (!this.isMuted) {
                    const sound = soundObj.cloneNode();
                    sound.volume = soundObj.volume;
                    sound.play().catch(e => console.log("Audio play blocked"));
                }
            }
			
			// --- NEW SKILL CHECK PLAYERS ---
			playDice() { this.playSFX(this.diceSound); }
			playSuccess() { this.playSFX(this.successSound); }
			playFail() { this.playSFX(this.failSound); }
			// -----------------------------

            playClick() { this.playSFX(this.clickSound); }
            playGasp() { this.playSFX(this.gaspSound); }
            playClash() { this.playSFX(this.clashSound); }
            playCoins() { this.playSFX(this.coinsSound); }
            playGhost() { this.playSFX(this.ghostSound); }
            
            checkVulnerable(currentHP, maxHP) {
                const pct = (currentHP / maxHP) * 100;
                
                if (pct <= 30) {
                    if (!this.playedVulnerable && !this.isMuted) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                        this.playedVulnerable = true;
                    }
                } else {
                    this.vulnerableSound.pause();
                    this.vulnerableSound.currentTime = 0;
                    this.playedVulnerable = false;
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById('audio-toggle');
                const icon = btn.querySelector('i');

                if (!this.isMuted) {
                    this.ambience.play().catch(e => console.log("Autoplay blocked"));
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-high');
                    btn.classList.add('text-amber-500', 'border-amber-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                    
                    if(this.playedVulnerable) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                    }
                } else {
                    this.ambience.pause();
                    this.vulnerableSound.pause();
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-volume-mute');
                    btn.classList.remove('text-amber-500', 'border-amber-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
            }
        }

        const audioManager = new AudioManager();
		window.audioManager = audioManager;

        // --- FX MANAGER ---
		class FXManager {
			constructor() {
				this.overlay = document.getElementById('fx-overlay');
				this.vignette = document.getElementById('vignette-overlay');
			}

			clearEffects() {
				this.overlay.classList.remove('fx-rift-pulse', 'fx-flash-red'); 
				
				if (!gameState.isRiftCollapse) {
					this.overlay.classList.remove('fx-rift-collapsed');
				}
			}

			flashRed() {
				this.overlay.classList.add('fx-flash-red');
				setTimeout(() => this.overlay.classList.remove('fx-flash-red'), 400);
			}
			
			setVignette(active) {
				if(active) this.vignette.classList.add('vignette-active');
				else this.vignette.classList.remove('vignette-active');
			}
		}
        
        const fxManager = new FXManager();
		window.fxManager = fxManager;
		
		function rebuildJournal() {
            const container = document.getElementById('journal-content');
            if (container) container.innerHTML = gameState.history.join('');
            scrollToBottom();
        }

        function scrollToBottom() {
            const area = document.getElementById('journal-scroll-area');
            if (area) {
                requestAnimationFrame(() => {
                    area.scrollTop = area.scrollHeight;
                });
            }
        }

        function addToHistory(text, type = 'entry') {
            let html = '';
            if (type === 'entry') {
                const processedText = text.replace(/(Captain Gareth|Gareth|Quinn|Talon|Bones|Silas|Wolf King|Ring of Brass|Sword of Valor|Smelter|Chapel|Sanguine Spire|Bleak Dogtooth|Vampire|Iron Lung|Absorb Elements|Primeval Awareness|Phoenix Draft|Manor Blueprint|Spectral Lantern|The Warding Ember|Mimic's Bile|Mind-Expanding Grog|Radiant-Washed Sword of Valor|Acid-Etched Sword of Valor)/g, '<span class="spectral-text-glow">$1</span>');
                html = `<div class="journal-font pb-4 border-b border-gray-700/30 text-gray-400 fade-in">${processedText}</div>`;
            } else if (type === 'system') {
                html = `<div class="text-xs text-amber-500 font-mono mb-2 fade-in">> ${text}</div>`;
            } else if (type === 'roll') {
                html = `<div class="text-xs spectral-text-glow font-bold mb-2 fade-in font-serif">${text}</div>`;
            } else if (type === 'danger') {
                html = `<div class="text-xs text-red-400 font-bold mb-2 fade-in font-serif">${text}</div>`;
            }
            if (type === 'combat') {
                html = `<div class="text-xs text-red-100 border-l-2 border-red-600 pl-2 mb-2 font-mono bg-red-900/20 p-2 shadow-inner fade-in">${text}</div>`;
            }
            if(html) gameState.history.push(html);
            rebuildJournal();
        }
        window.addToHistory = addToHistory; 
        window.rebuildJournal = rebuildJournal;

        // --- STATIC IMAGE MAPPING ---
		// --- Previously SceneImages ---
        
        // --- GAME DATA FACTORY ---
		function createInitialState() {
			return {
				currentSceneId: 'prologue_storm', 
				currentHP: 20,
				maxHP: 20,
				shillings: 0, 
				influence: 0, 
				doomTimer: 20,
				guidingDieSize: 4,
				
				// --- FLAGS ---
				act1Started: false,
				isRiftCollapse: false,
				act2Started: false,
				isEthereal: false,
				tetherTimer: 20,
				act3Started: false,
				
				// --- NEW COMBAT FLAGS ---
				player: {
					specialization: null, // 'AE' (Absorb) or 'PA' (Awareness) - Set in Act 1
					weapon: { name: 'Rusted Cutlass', damage: '1d6' } 
				},
				combat: {
					enemy: null,
					enemyHP: 0,
					enemyMaxHP: 0,
					enemyDamage: '1d6',
					damageType: 'physical',
					enemyStatus: [], 
					isPlayerTurn: true,
					
					// SKILL FLAGS (Toggles)
					blade_enhanced_active: false,
					hunters_mark_used_this_turn: false,
					ae_primed: null, 
					blink_used_this_turn: false,
					silas_used_this_turn: false
				},

				// ... Keep your existing inventory, history, and crew objects ...
				inventory: [], 
				skills: [],
				crew: {
					gareth: { id: 'gareth', name: 'Captain Gareth', skill: 'Intimidation & Insight', used: false },
					quinn: { id: 'quinn', name: 'Quinn', skill: 'Investigation & History', used: false },
					talon: { id: 'talon', name: 'Talon', skill: 'Survival & Perception', used: false },
					bones: { id: 'bones', name: 'Bones', skill: 'Medicine & Nature', used: false }
				},
				history: [],
				companions: {
					silas: { joined: false, name: "Silas", desc: "Seneschal", active: false },
					blink: { joined: false, name: "Blink", desc: "Phase-Cub", active: false }
				},
				allyCooldowns: { silas: 0, blink: 0 },
				
				// ... (Keep existing game flags) ...
				knowsSmelterSecret: false,
				knowsChapelSecret: false,
				hasObservedGambler: false, 
				hasSearchedSmugglerDrop: false,
				docksWorkCount: 0,
				quinnLogistics: false,
				hasDivedTreasure: false,
				hallLooted: false,
				hasBlinkSkill: false,
				cellarUnlocked: false,
				pendingDestination: null,
				factionAligned: null,
				shipName: "The Iron Lung",
				supplies: 10, 
				knownIslands: ['port_hub'],
				currentLocation: 'port_hub',
				silasJoined: false,
				silasVengeanceActive: false,
				activeEnemies: [],
				enemies: {},
				activeBoons: [],
			};
		}
        let gameState = createInitialState();
		window.gameState = gameState;
        let activeCrewMember = null;
		
		
		// --- PUZZLE LOGIC MANAGER ---
        const puzzleManager = {
            // 1. BANTER TYPEWRITER
            typeBanter: function(elementId, text, speed = 25) {
                const el = document.getElementById(elementId);
                if (!el) return;
                el.innerHTML = ''; // Clear for typing
                el.classList.add('slow-type');
                
                let i = 0;
                function type() {
                    // Check if element still exists (in case user clicked away)
                    if (!document.getElementById(elementId)) return;
                    
                    if (i < text.length) {
                        el.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    } else {
                        el.classList.remove('slow-type');
                    }
                }
                type();
            },

            // 2. CIRCUIT PUZZLE
            initCircuit: function() {
                const correctSequence = [1, 3, 2];
                let userSequence = [];
                const nodes = document.querySelectorAll('.circuit-node');
                const msgEl = document.getElementById('circuit-message');

                nodes.forEach(node => {
                    node.addEventListener('click', (e) => {
                        const val = parseInt(e.target.dataset.value);
                        
                        // Prevent clicking locked nodes
                        if (e.target.classList.contains('success') || e.target.classList.contains('active')) return;

                        if (val === correctSequence[userSequence.length]) {
                            // CORRECT
                            userSequence.push(val);
                            e.target.classList.add('active');
                            e.target.classList.remove('error');
                            audioManager.playClick();

                            if (userSequence.length === correctSequence.length) {
                                // WIN
                                nodes.forEach(n => n.classList.add('success'));
                                msgEl.innerHTML = "<span class='text-emerald-400'>Circuit Stabilized. Sequence Accepted.</span>";
                                audioManager.playCoins();
                                setTimeout(() => {
                                    renderScene('manor_cellar_success');
                                }, 1000);
                            }
                        } else {
                            // WRONG
                            e.target.classList.add('error');
                            msgEl.innerHTML = "<span class='text-red-400'>Error! Circuit overloaded. Resetting...</span>";
                            userSequence = [];
                            audioManager.playClash();
                            setTimeout(() => {
                                nodes.forEach(n => n.classList.remove('active', 'error'));
                                msgEl.innerHTML = "Input Sequence...";
                            }, 800);
                        }
                    });
                });
            },

            // 3. COMPASS PUZZLE
            compassTimer: null,
            isCompassAligned: false,
            
            initCompass: function() {
                if (this.compassTimer) cancelAnimationFrame(this.compassTimer);
                this.isCompassAligned = false;
                
                const needle = document.getElementById('compass-needle');
                const target = document.getElementById('compass-target');
                const timerText = document.getElementById('compass-timer-text');
                const container = document.getElementById('compass-container');
                
                // Random Target Angle (Top Hemisphere)
                const targetAngle = Math.floor(Math.random() * 140) + 20;
                target.style.transform = `rotateZ(${targetAngle}deg)`;

                let visualRotation = 0;
                let lastRawAngle = 0;
                let isDragging = false;
                let startTime = Date.now();
                const DURATION = 10; 

                const getAngle = (x, y) => {
                    const rect = container.getBoundingClientRect();
                    const cx = rect.left + rect.width / 2;
                    const cy = rect.top + rect.height / 2;
                    let a = Math.atan2(y - cy, x - cx) * (180 / Math.PI) + 90;
                    return a < 0 ? a + 360 : a;
                };

                const updateLoop = () => {
                    if (!document.getElementById('compass-container')) return; // Stop if scene changed

                    const elapsed = (Date.now() - startTime) / 1000;
                    const left = Math.max(0, DURATION - elapsed);
                    if(timerText) timerText.innerText = left.toFixed(1);

                    if (this.isCompassAligned && left > 0) {
                         renderScene('sea_fog_success');
                         return;
                    }
                    if (left <= 0) {
                        renderScene('sea_fog_fail');
                        return;
                    }
                    this.compassTimer = requestAnimationFrame(updateLoop);
                };

                const checkAlign = (currAngle) => {
                    const margin = 12;
                    if (currAngle > targetAngle - margin && currAngle < targetAngle + margin) {
                        this.isCompassAligned = true;
                        needle.classList.add('aligned');
                        needle.style.transform = `rotateZ(${targetAngle}deg)`; 
                    }
                };

                const dragStart = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    lastRawAngle = getAngle(clientX, clientY);
                };

                const dragMove = (e) => {
                    if (!isDragging || this.isCompassAligned) return;
                    e.preventDefault();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    const currAngle = getAngle(clientX, clientY);
                    let delta = currAngle - lastRawAngle;
                    
                    if (delta > 180) delta -= 360;
                    if (delta < -180) delta += 360;
                    
                    visualRotation += delta;
                    needle.style.transform = `rotateZ(${visualRotation}deg)`;
                    lastRawAngle = currAngle;
                    
                    let checkRot = visualRotation % 360;
                    if (checkRot < 0) checkRot += 360;
                    checkAlign(checkRot);
                };

                const dragEnd = () => { isDragging = false; };

                needle.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('mouseup', dragEnd);
                needle.addEventListener('touchstart', dragStart, {passive: false});
                document.addEventListener('touchmove', dragMove, {passive: false});
                document.addEventListener('touchend', dragEnd);

                updateLoop();
            }
        };
		
        window.gameFunctions = {};
		// --- DREAMSCAPE DATA & LOGIC ---
		const dreamscapeConfig = {
			'act1_transition': {
				nextScene: 'lighthouse_morning',
				narrative: "The storm has passed, but the sea demands a price. The crew stands before you in the grey morning mist. They look to you for orders, but their eyes are hollow.",
				boons: {
					gareth: { title: "Violence of Action", effect: "Advantage on Round 1", desc: "Roll twice for attacks in the first round of combat." },
					quinn: { title: "Logistics Officer", effect: "Reveal Hidden Costs", desc: "See Time/Doom costs before making choices." },
					talon: { title: "Scavenger's Eye", effect: "+1 Shilling Found", desc: "Gain extra coin whenever you loot or sell." },
					bones: { title: "Triage Protocol", effect: "+2 Consumable Heal", desc: "Potions and food heal +2 additional HP." }
				}
			},
			'act2_transition': {
				nextScene: 'act2_arrival',
				narrative: "You drift between the material and the spectral. The Vanishing Manor awaits in the negative space of the world. Physics is breaking down; gravity is a suggestion. <span class='text-cyan-400'>Who will anchor you to reality?</span>",
				boons: {
					gareth: { title: "Iron Will", effect: "-2 Psychic Damage", desc: "Resistance to mental trauma and sanity checks." },
					quinn: { title: "Efficient Pathing", effect: "Free Safe Movement", desc: "0 Tether cost to move between safe rooms." },
					talon: { title: "Ghost Hunter", effect: "+2 Dmg vs Spectral", desc: "Bonus damage against Ethereal enemies." },
					bones: { title: "Spectral Metabolism", effect: "Regen 1 HP on Move", desc: "Heal 1 HP when entering a new room." }
				}
			},
			'act3_transition': {
				nextScene: 'act3_name_ship',
				narrative: "The Rift is closed, but the open sea is a battlefield. The factions are moving, and the water turns red with the Sanguine Tithe.",
				boons: {
					gareth: { title: "Hold the Line", effect: "Death Defiance", desc: "Survive a lethal blow at 1 HP (Once per rest)." },
					quinn: { title: "Master Navigator", effect: "-1 Supply Cost", desc: "Sea travel costs 1 less Supply." },
					talon: { title: "Hunter's Mark", effect: "Crit Range 19-20", desc: "Critical hits land on rolls of 19 or 20." },
					bones: { title: "Alchemical Resistance", effect: "Resist Acid/Poison", desc: "Take half damage from Acid and Poison." }
				}
			}
		};

		let selectedDreamCrew = null;

		window.gameFunctions.startDreamscape = function(transitionType) {
			gameState.dreamTransitionPending = transitionType;
			const config = dreamscapeConfig[transitionType];
			
			// 1. Universal Level Up Mechanics
			gameState.maxHP += 5;
			gameState.currentHP = gameState.maxHP;
			gameState.baseDamage += 1;
			
			// 2. Conditional Die Upgrade (ONLY for Act 3)
			let dieHtml = ''; // Default: Empty string (Hidden)
			
			if (transitionType === 'act3_transition') {
				gameState.guidingDieSize = 6; // Upgrade to d6
				// Render ONLY if upgrading
				dieHtml = `
					<div class="flex items-center text-cyan-400 drop-shadow-md animate-pulse font-bold">
						<i class="fas fa-arrow-up mr-2"></i> Guiding Die (d6)
					</div>
				`;
			} else {
				// Keeps current size (d4), but displays nothing
				gameState.guidingDieSize = gameState.guidingDieSize || 4; 
			}
			
			// 3. Setup UI
			document.getElementById('main-game-container').classList.add('dream-blur-active');
			const overlay = document.getElementById('dreamscape-overlay');
			overlay.classList.add('active');
			
			// 4. Update the Modal Header
			const modalHeader = overlay.querySelector('.p-4.md\\:p-6 .flex.flex-wrap');
			if (modalHeader) {
				modalHeader.innerHTML = `
					<div class="flex items-center text-purple-400 drop-shadow-md">
						<i class="fas fa-arrow-up mr-2"></i> Level Up!
					</div>
					<div class="flex items-center text-emerald-400 drop-shadow-md">
						<i class="fas fa-heart mr-2"></i> +5 Max HP
					</div>
					<div class="flex items-center text-red-400 drop-shadow-md">
						<i class="fas fa-fist-raised mr-2"></i> +1 Base Dmg
					</div>
					${dieHtml} `;
			}
			
			document.getElementById('dream-text-container').innerHTML = `"${config.narrative}"`;
			document.getElementById('btn-wake-up').classList.add('hidden');
			selectedDreamCrew = null;

			// 5. Render Cards
			const grid = document.getElementById('dream-card-grid');
			grid.innerHTML = '';
			
			const crews = [
				{ id: 'gareth', icon: 'fa-anchor', role: 'Captain' },
				{ id: 'quinn', icon: 'fa-scroll', role: 'Quartermaster' },
				{ id: 'talon', icon: 'fa-eye', role: 'Scout' },
				{ id: 'bones', icon: 'fa-flask', role: 'Surgeon' }
			];

			crews.forEach(c => {
				const boon = config.boons[c.id];
				const card = document.createElement('div');
				card.className = `crew-card group`;
				card.id = `card-${c.id}`;
				card.onclick = () => window.gameFunctions.selectDreamCrew(c.id);
				
				card.innerHTML = `
					<div class="crew-card-inner">
						<i class="fas ${c.icon}"></i>
						<h4 class="text-cyan-100 font-cinzel font-bold text-lg mb-1 border-b border-cyan-500/30 pb-1 w-full">${c.id.charAt(0).toUpperCase() + c.id.slice(1)}</h4>
						<p class="text-gray-400 text-xs italic mb-auto">${c.role} (+1 Skill)</p>
						<div class="crew-boon-container">
							<div class="text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-1">Boon: ${boon.title}</div>
							<div class="text-sm text-white font-cinzel font-bold mb-1">${boon.effect}</div>
							<div class="text-[10px] text-gray-400 leading-tight">${boon.desc}</div>
						</div>
					</div>
				`;
				grid.appendChild(card);
			});
		};

		// Function 2: Select Card
		window.gameFunctions.selectDreamCrew = function(crewId) {
			selectedDreamCrew = crewId;
			
			// Visual Selection
			document.querySelectorAll('.crew-card').forEach(c => c.classList.remove('selected'));
			document.getElementById(`card-${crewId}`).classList.add('selected');
			
			// Show Button
			const btn = document.getElementById('btn-wake-up');
			btn.classList.remove('hidden');
			btn.innerText = `BOND WITH ${crewId.toUpperCase()}`;
		};

		// Function 3: Confirm & End
		window.gameFunctions.confirmDreamSelection = function() {
			if (!selectedDreamCrew) return;
			
			const transition = gameState.dreamTransitionPending;
			const config = dreamscapeConfig[transition];
			
			// Apply Rewards
			gameState.crewSkillBonuses[selectedDreamCrew] += 1;
			
			// Map crew ID to specific boon ID for tracking
			const boonMap = {
				'act1_transition': { gareth: 'violence_of_action', quinn: 'logistics', talon: 'scavenger', bones: 'triage' },
				'act2_transition': { gareth: 'iron_will', quinn: 'efficient_pathing', talon: 'ghost_hunter', bones: 'spectral_metabolism' },
				'act3_transition': { gareth: 'hold_the_line', quinn: 'master_navigator', talon: 'hunters_mark', bones: 'chemical_resist' }
			};
			
			const boonId = boonMap[transition][selectedDreamCrew];
			if (!gameState.activeBoons.includes(boonId)) {
				gameState.activeBoons.push(boonId);
			}

			// Cleanup UI
			document.getElementById('dreamscape-overlay').classList.remove('active');
			document.getElementById('main-game-container').classList.remove('dream-blur-active');
			
			// Custom Logic Flags based on selection (Legacy compatibility)
			if (boonId === 'logistics') gameState.quinnLogistics = true;
			if (boonId === 'violence_of_action') gameState.isSurpriseRound = true;

			// Proceed
			renderScene(config.nextScene);
			saveGame();
		};
		
		
		// 1. CONTRABAND CHECKER
		window.gameFunctions.checkForContraband = function() {
			return gameState.inventory.some(itemName => {
				const item = itemRegistry[itemName];
				return item && item.isContraband;
			});
		};
		
		
		// --- UNIFIED COMBAT ENGINE (Combos + Bosses + Horde) ---

		// 1. Combat Initialization
		function initCombat(enemyName, hp, damageRange) {
			gameState.isBossCombat = true;
			gameState.currentEnemy = enemyName;
			
			// Sync New Combat Object
			gameState.combat.enemy = { name: enemyName };
			gameState.combat.enemyHP = hp;
			gameState.combat.enemyMaxHP = hp;
			gameState.combat.enemyDamage = '1d6'; // Base fallback
			gameState.combat.damageType = 'physical';
			gameState.combat.enemyStatus = [];
			
			// Sync Legacy Variables (For UI compatibility)
			gameState.enemyHP = hp;
			gameState.maxEnemyHP = hp;
			gameState.enemyDamageRange = damageRange;

			// Reset Arrays
			gameState.activeEnemies = [];
			gameState.enemies = {};
			gameState.allyCooldowns.silas = 0;
			gameState.allyCooldowns.blink = 0;
			
			updateUI();
		}

		function initHordeCombat(baseName, hpPerEnemy, damageRange, count) {
			initCombat(baseName, hpPerEnemy * count, damageRange);
			gameState.maxElderHP = hpPerEnemy; // Track individual max for UI bars

			let totalHP = 0;
			for (let i = 0; i < count; i++) {
				const name = `${baseName} ${String.fromCharCode(65 + i)}`; // Elder A, Elder B
				gameState.enemies[name] = hpPerEnemy;
				gameState.activeEnemies.push(name);
				totalHP += hpPerEnemy;
			}
			// Override total HP tracking
			gameState.combat.enemyHP = totalHP;
			gameState.enemyHP = totalHP;
			gameState.combat.enemyMaxHP = totalHP;
			gameState.maxEnemyHP = totalHP;
		}

		// 2. Helpers
		window.rollDice = function(diceString) {
			if (!diceString) return 0;
			if (typeof diceString === 'number') return diceString;
			const parts = diceString.match(/(\d+)d(\d+)([\+\-]\d+)?/);
			if (!parts) return parseInt(diceString) || 0;
			let total = 0;
			const numDice = parseInt(parts[1]);
			const dieSize = parseInt(parts[2]);
			const modifier = parseInt(parts[3]) || 0;
			for (let i = 0; i < numDice; i++) { total += Math.floor(Math.random() * dieSize) + 1; }
			return total + modifier;
		};

		window.applyStatusEffect = (state, effectName, duration) => {
			if (!state.combat.enemyStatus) state.combat.enemyStatus = [];
			const existing = state.combat.enemyStatus.find(s => s.name === effectName);
			if (existing) existing.duration = duration;
			else state.combat.enemyStatus.push({ name: effectName, duration: duration });
		};

		window.renderStatusEffects = () => {
			const container = document.getElementById('enemy-status-effects');
			if (!container) return;
			let html = '';
			// Buffs
			if (gameState.combat.blade_enhanced_active) html += `<div class="status-indicator text-indigo-300 border-indigo-500 bg-indigo-900/40"><i class="fas fa-bolt mr-1"></i> Blade</div>`;
			if (gameState.combat.ae_primed) html += `<div class="status-indicator text-cyan-300 border-cyan-500 bg-cyan-900/40 animate-pulse"><i class="fas fa-shield-halved mr-1"></i> Primed</div>`;
			// Debuffs
			if (gameState.combat.enemyStatus) {
				gameState.combat.enemyStatus.forEach(status => {
					const def = window.STATUS_EFFECTS[status.name];
					if (def) html += `<div class="status-indicator ${def.color} border-current"><i class="fas ${def.icon} mr-1"></i> ${def.name}</div>`;
				});
			}
			container.innerHTML = html;
		};

		// 3. MAIN ATTACK LOGIC (Combos & Damage)
		window.attackEnemy = (comboType = 'standard') => {
			const state = window.gameState;
			
			// --- A. HORDE TARGETING ---
			// If fighting Horde (Elders), we default damage to the first active target
			let targetName = state.combat.enemy.name;
			if (state.activeEnemies && state.activeEnemies.length > 0) {
				targetName = state.activeEnemies[0];
			}

			// --- B. DAMAGE CALCULATION ---
			let baseDmgStr = state.inventory.includes("Sword of Valor") ? '1d8+2' : (state.player.weapon.damage || '1d6');
			if(state.baseDamage) baseDmgStr += `+${state.baseDamage}`; // Level Up Bonus

			let baseDamage = window.rollDice(baseDmgStr);
			let bonusDamage = 0;
			let log = "";
			
			// BOON: Ghost Hunter
			if (state.activeBoons.includes('ghost_hunter') && (state.isEthereal || targetName.includes('Spectre') || targetName.includes('Beast'))) {
				bonusDamage += 2;
			}

			// COMBO TREE
			switch (comboType) {
				case 'zephyrStrike':
					bonusDamage += window.rollDice('1d8');
					log = "<b>Zephyr Strike!</b> Force energy ripples through the target.";
					break;
				case 'surgicalStrike':
					bonusDamage += window.rollDice('1d8');
					log = "<b>Surgical Strike!</b> You hit the exposed nerve.";
					break;
				case 'planarStrike':
					const element = (state.combat.ae_primed && state.combat.ae_primed.type) ? state.combat.ae_primed.type : 'Force';
					bonusDamage += window.rollDice('1d8') + window.rollDice('1d8'); 
					log = `<b>Howling Planar Strike!</b> The absorbed ${element} erupts!`;
					state.combat.ae_primed = null; 
					break;
				case 'tripAttack':
					bonusDamage += window.rollDice('2d8'); 
					window.applyStatusEffect(state, 'prone', 1);
					log = "<b>Dire Wolf Trip!</b> Blink exposes the throat! CRITICAL HIT + PRONE!";
					break;
				case 'wolfBite':
					bonusDamage += window.rollDice('1d10');
					const heal = Math.floor((baseDamage + bonusDamage) / 2);
					state.currentHP = Math.min(state.maxHP, state.currentHP + heal);
					log = `<b>White Wolf's Bite!</b> Silas opens the guard. You strike and heal for ${heal} HP!`;
					break;
				case 'huntersEdge':
					bonusDamage += window.rollDice('1d10');
					window.applyStatusEffect(state, 'vulnerable', 1);
					log = "<b>Hunter's Edge!</b> A devastating coordinated assault.";
					break;
				case 'elementalStrike':
					bonusDamage += window.rollDice('1d8');
					log = "<b>Elemental Retaliation!</b> You discharge the stored energy.";
					state.combat.ae_primed = null;
					break;
				default: // Heavy Strike / Valor Strike
					log = `Strike against ${targetName}.`;
					break;
			}

			// --- C. STATUS MULTIPLIERS ---
			let totalDamage = baseDamage + bonusDamage;
			
			// Critical (Phase Strike or Hunter's Mark Boon)
			if (state.nextAttackCrit) {
				totalDamage = Math.floor(totalDamage * 2.5);
				state.nextAttackCrit = false;
				log += " <span class='text-emerald-400 font-bold'>PHASE CRIT!</span>";
			}

			// Vulnerable
			const isVulnerable = state.combat.enemyStatus.find(s => s.name === 'vulnerable');
			if (isVulnerable) {
				totalDamage = Math.floor(totalDamage * 1.5);
				log += " <span class='text-red-500 font-bold'>(Vulnerable! x1.5)</span>";
				state.combat.enemyStatus = state.combat.enemyStatus.filter(s => s.name !== 'vulnerable');
			}

			// --- D. APPLY DAMAGE ---
			
			// HORDE DISTRIBUTION
			if (state.activeEnemies && state.activeEnemies.length > 0) {
				// Apply to specific target in horde
				if (state.enemies[targetName] > 0) {
					state.enemies[targetName] = Math.max(0, state.enemies[targetName] - totalDamage);
					if (state.enemies[targetName] <= 0) {
						log += ` <span class='text-blood'>${targetName} is destroyed!</span>`;
						state.activeEnemies = state.activeEnemies.filter(e => e !== targetName);
					}
				}
				// Re-calculate Total HP based on remaining horde
				let newTotal = 0;
				Object.values(state.enemies).forEach(val => newTotal += val);
				state.combat.enemyHP = newTotal;
				state.enemyHP = newTotal;
			} 
			// SINGLE BOSS DISTRIBUTION
			else {
				state.combat.enemyHP -= totalDamage;
				state.enemyHP = state.combat.enemyHP;
			}

			// --- E. CLEANUP & NEXT TURN ---
			state.combat.blade_enhanced_active = false;
			state.combat.blink_used_this_turn = false;
			state.combat.hunters_mark_used_this_turn = false;
			state.combat.silas_used_this_turn = false;

			addToHistory(`${log} Dealt <b>${totalDamage}</b> damage.`, 'combat');
			window.fxManager.flashRed();
			updateUI();
			renderScene(state.currentSceneId, false);

			// VICTORY CHECK
			if (state.combat.enemyHP <= 0) {
				setTimeout(() => window.resolveCombatRound('check_victory'), 500);
			} else {
                // CORAL HULK REGENERATION (Must be placed before enemyTurn)
                if (state.currentEnemy === 'Coral-Hulk') {
                    const regenAmount = 5;
                    state.combat.enemyHP = Math.min(state.combat.enemyMaxHP, state.combat.enemyHP + regenAmount);
                    state.enemyHP = state.combat.enemyHP;
                    addToHistory(` <span class='text-red-400 font-bold'>The Hyper-Coral knits flesh together (+${regenAmount} HP Regen).</span>`, 'combat');
                }
				setTimeout(window.enemyTurn, 1000);
			}
		};

		// 4. ENEMY TURN LOGIC
		window.enemyTurn = () => {
			const state = window.gameState;
			if (state.combat.enemyHP <= 0) return;

			// CHECK CC (PRONE)
			const isProne = state.combat.enemyStatus.find(s => s.name === 'prone');
			if (isProne) {
				addToHistory(`${state.currentEnemy} is Prone and cannot act!`, 'combat');
				state.combat.enemyStatus = state.combat.enemyStatus.filter(s => s.name !== 'prone');
				state.combat.isPlayerTurn = true;
				updateUI();
				window.renderStatusEffects();
				return;
			}

			// DAMAGE CALCULATION
			let damage = 0;
			let attacksCount = 1;
			
			// Horde Logic (Act 3 Elders)
			if (state.activeEnemies && state.activeEnemies.length > 0) {
				attacksCount = state.activeEnemies.length;
				state.activeEnemies.forEach(e => {
					damage += Math.floor(Math.random() * 4) + 4; // 4-8 dmg per elder
				});
			} else {
				// Single Boss
				damage = window.rollDice(state.enemyDamageRange ? `1d${state.enemyDamageRange[1]}` : '1d8');
			}

			// MITIGATION (Shield/Silas)
			if (state.inventory.includes("Mirror Shield")) damage = Math.max(0, damage - attacksCount);
			if (state.negateNextDamage) {
				damage = 0;
				state.negateNextDamage = false;
				addToHistory(`<span class='text-emerald-400 font-bold'>Silas Intercepted the attack!</span>`, 'system');
			}

			// ABSORB ELEMENTS REACTION (If damageType is elemental)
			// Bosses like Slag Elemental sets damageType to 'fire'
			if (state.player.specialization === 'AE' && state.combat.damageType !== 'physical') {
				damage = Math.floor(damage / 2);
				state.combat.ae_primed = { type: state.combat.damageType, bonusDmg: '1d8' };
				addToHistory(`Absorb Elements! Damage halved. Blade is ${state.combat.damageType.toUpperCase()} PRIMED.`, 'system');
			}

			// APPLY
			if (damage > 0) {
				const oldHP = state.currentHP;
				state.currentHP = window.applyDamage(state.currentHP, damage, state.combat.damageType);
				addToHistory(`${state.currentEnemy} hits for ${oldHP - state.currentHP} damage.`, 'danger');
				window.fxManager.flashRed();
			}

			// TICK COOLDOWNS
			if (state.allyCooldowns.silas > 0) state.allyCooldowns.silas--;
			if (state.allyCooldowns.blink > 0) state.allyCooldowns.blink--;

			state.combat.isPlayerTurn = true;
			updateUI();
		};
        window.enemyTurn = enemyTurn;

		// 5. ITEM/UTILITY BRIDGE
		// This handles Consumables and Victory Checks
		window.resolveCombatRound = function(attackType) {
			const state = window.gameState;

			// Victory Routing
			if (attackType === 'check_victory') {
				const enemy = state.combat.enemy.name || "";
				if (state.combat.enemyHP <= 0) {
					if (enemy.includes("Slag")) renderScene('smelter_victory_generic'); 
					else if (enemy.includes("Spectre")) renderScene('chapel_victory_generic');
					else if (enemy.includes("Coral")) renderScene('coral_hulk_victory');
					else renderScene('spire_victory');
				}
				return;
			}

			// Consumable Logic
			let damage = 0;
			let log = "";

			if (attackType === 'item_holy_water') { damage = 25; log = "Holy Water burns the target!"; }
			else if (attackType === 'item_fire') { damage = 20; log = "Alchemical Fire erupts!"; }
			else if (attackType === 'item_stake_driver') { 
				damage = 15; 
				window.applyStatusEffect(state, 'prone', 1);
				log = "Stake Driver impact! Target Stunned.";
			}
			else if (attackType === 'item_flash') {
				damage = 0;
				window.applyStatusEffect(state, 'prone', 1);
				log = "Flash Powder! Enemy Blinded (Prone).";
			}

			if (damage > 0) {
				// Apply to Horde or Single
				if (state.activeEnemies && state.activeEnemies.length > 0) {
					// AOE logic for items? Or Single? Let's say AOE for Holy Water/Fire
					state.activeEnemies.forEach(e => {
						state.enemies[e] = Math.max(0, state.enemies[e] - damage);
					});
					// Recalc total
					let sum = 0; Object.values(state.enemies).forEach(v=>sum+=v);
					state.combat.enemyHP = sum;
					state.enemyHP = sum;
				} else {
					state.combat.enemyHP -= damage;
					state.enemyHP = state.combat.enemyHP;
				}
				
				addToHistory(log + ` Dealt ${damage} damage.`, 'combat');
				window.fxManager.flashRed();
			}

			if (state.combat.enemyHP <= 0) {
				window.resolveCombatRound('check_victory');
			} else {
				setTimeout(window.enemyTurn, 1000);
			}
		};

		// 6. ALLY COMMAND (Free Action)
		window.allyCommand = function(allyId) {
			const state = gameState;
			if (state.allyCooldowns[allyId] > 0) {
				addToHistory("Ally on Cooldown!", 'system');
				return;
			}

			if (allyId === 'silas') {
				state.negateNextDamage = true;
				state.combat.silas_used_this_turn = true; // Trigger for Combo
				state.allyCooldowns.silas = 3;
				addToHistory("Silas Intercept Ready! (Combo Enabled)", 'system');
			}
			else if (allyId === 'blink') {
				state.nextAttackCrit = true;
				state.combat.blink_used_this_turn = true; // Trigger for Combo
				state.allyCooldowns.blink = 3;
				addToHistory("Blink Phase Shift! (Crit + Combo Enabled)", 'system');
			}
			
			audioManager.playClick();
			updateUI();
			// Re-render scene to update attack buttons to "Combo" state
			renderScene(state.currentSceneId, false);
		};

		// 7. DYNAMIC BUTTON GENERATOR
		window.generateCombatChoices = function(state) {
			let choices = [];
			const { combat, player } = state;
			
			// --- DETERMINE ATTACK BUTTON ---
			let attackName = "Strike with Weapon";
			let attackType = "standard";
			let customClass = ""; // Default grey

			// Combo Logic
			if (combat.blade_enhanced_active) {
				if (combat.blink_used_this_turn) {
					attackName = "Dire Wolf Trip Attack (Crit + Prone)";
					attackType = "tripAttack";
					customClass = "spectral-glow-btn";
				} 
				else if (combat.silas_used_this_turn) {
					if (player.specialization === 'PA') {
						attackName = "Hunter's Edge (Vulnerable)";
						attackType = "huntersEdge";
						customClass = "spectral-glow-btn";
					} else {
						attackName = "The White Wolf's Bite (Heal)";
						attackType = "wolfBite";
						customClass = "spectral-glow-btn";
					}
				}
				else if (combat.ae_primed) {
					attackName = "Howling Planar Strike (Force + Element)";
					attackType = "planarStrike";
					customClass = "spectral-glow-btn";
				}
				else if (combat.hunters_mark_used_this_turn) {
					attackName = "Surgical Strike (Crit Chance)";
					attackType = "surgicalStrike";
					customClass = "spectral-glow-btn";
				}
				else {
					attackName = "Zephyr Strike (Force Dmg)";
					attackType = "zephyrStrike";
					customClass = "spectral-glow-btn";
				}
			} else if (combat.ae_primed) {
				attackName = "Elemental Retaliation";
				attackType = "elementalStrike";
				customClass = "spectral-glow-btn";
			}

			// Add Main Attack
			choices.push({
				text: attackName,
				action: () => window.attackEnemy(attackType),
				type: 'action',
				customClass: customClass
			});

			// Add Consumables
			const combatItems = [
				{ id: 'Holy Water', func: 'item_holy_water', style: 'btn-success-glow' },
				{ id: 'Alchemical Fire', func: 'item_fire', style: 'btn-fire-glow' },
				{ id: 'Sun-Star Grenade', func: 'item_sun_star', style: 'btn-fire-glow' },
				{ id: 'Flash Powder', func: 'item_flash', style: '' },
				{ id: 'Scale-Stake Driver', func: 'item_stake_driver', style: 'btn-fire-glow' }
			];

			combatItems.forEach(item => {
				if (state.inventory.includes(item.id)) {
					choices.push({
						text: `Use ${item.id}`,
						action: () => window.resolveCombatRound(item.func),
						type: 'action',
						consume: true,
						reqItem: item.id,
						customClass: item.style
					});
				}
			});

			return choices;
		};
		
		window.initCombat = initCombat;
		window.initHordeCombat = initHordeCombat;

        // 1. PLANE WALK LOGIC
        window.gameFunctions.togglePlaneWalk = function() {
            if (!gameState.skills.includes("Plane Walking")) {
                addToHistory("You do not know how to walk the planes yet.", "system");
                return;
            }
            
            gameState.isEthereal = !gameState.isEthereal;
            
            if (gameState.isEthereal) {
                document.body.classList.add('plane-ethereal');
                audioManager.playGhost();
            } else {
                document.body.classList.remove('plane-ethereal');
                audioManager.playClick();
            }
            
            renderScene(gameState.currentSceneId, false);
        };

        // 2. BLINK LOGIC (Companion Interaction)
			window.gameFunctions.triggerBlink = function() {
				if (!gameState.companions.blink.joined) return;

				const currentScene = scenes[gameState.currentSceneId];
				if (currentScene.isBoss) {
					addToHistory("Blink hisses at the enemy, his fur shifting colors. Look for a [Command Blink] option in the choices!", "system");
					audioManager.playGhost();
					return;
				}

				if (gameState.tetherTimer > 2) {
					gameState.tetherTimer -= 2;
					const heal = Math.floor(Math.random() * 4) + 1;
					gameState.currentHP = Math.min(gameState.maxHP, gameState.currentHP + heal);
					
					addToHistory(`*You and Blink phase into the deep ether for a moment of respite.*`, 'entry');
					addToHistory(`Healed ${heal} HP. Tether reduced by 2 turns.`, 'system');
					audioManager.playGhost();
					
					updateUI(); 
				} else {
					addToHistory("The Tether is too unstable to phase out right now!", "system");
				}
			};
			
				
        // --- END WINDOW FUNCTIONS ---

        // --- DAMAGE CALCULATION LOGIC ---
        function calculatePlayerDamage(enemyType) {
            let dmg = Math.floor(Math.random() * 8) + 4;
            
            if (gameState.inventory.includes("Sword of Valor")) {
                dmg += 1;
                
                // VAMPIRE SCALING LOGIC
                if (enemyType === "Vampire Thrall") dmg += 2;
                else if (enemyType === "Vampire Bride") dmg += 3;
                else if (enemyType === "Vampire Elder") dmg += 4;

                if (enemyType.includes("Vampire")) {
                    addToHistory(`The Sword of Valor strikes deep (+${dmg - 4} bonus damage).`, 'system');
                }
            }
            return dmg;
        }

        const enemyRegistry = {
            "thrall": { type: "Vampire Thrall" },
            "bride": { type: "Vampire Bride" },
            "elder": { type: "Vampire Elder" },
            "ghoul": { type: "Ghoul" }
        };

        // --- Previously const itemRegistry ---
        
        function getBonusForSkill(crewMember, skillType) {
            const expertise = {
                'Captain Gareth': ['Insight', 'Intimidation'],
                'Quinn': ['Investigation', 'History'],
                'Talon': ['Survival', 'Perception'],
                'Bones': ['Nature', 'Medicine']
            };

            const allowedSkills = expertise[crewMember.name] || [];
            return allowedSkills.includes(skillType);
        }

        // --- DYNAMIC BANTER DATA ---
        const dynamicBanter = {
            'gareth': [
                "Keep your feet moving, Mariner. A dead ship needs a fast Captain.",
                "The storm is behind us, but the fog ahead is thicker. Stay alert.",
                "Do you feel that? The planar veil is thinning again. Hurry.",
                "There is no easy port in this chaos. Pick a heading and hold it true."
            ],
            'quinn': [
                "I've checked the manifest twice; we're running low on luck, Edward.",
                "Keep track of the shillings! Coin is the only stable metric left in this world.",
                "This path is inefficient, Captain. Logically, we should have gone the other way.",
                "Hmph. More wreckage. Always more wreckage."
            ],
            'talon': [
                "Watch the ground, Edward. The dead leave tracks too.",
                "Something smells wrong. Not rot*new* wrong. Be ready.",
                "The shadows here are deeper than they should be. It's a good place to hide, or be hunted.",
                "Rustling in the brush. Just wind... or something that hunts in the wind."
            ],
            'bones': [
                "I could use a long rest, Edward. My bones are cold and tired.",
                "Are you eating enough? You can't run on sea-water and guilt, Captain.",
                "This town is sick. I can taste the fever in the air.",
                "Keep the cutlass sharp. I don't like the look of these locals."
            ]
        };

        function getDynamicBanter() {
            if (Math.random() > 0.80) {
                const availableCrew = Object.keys(gameState.crew).filter(id => !gameState.crew[id].used);
                
                if (availableCrew.length === 0) return null;

                const randomCrewId = availableCrew[Math.floor(Math.random() * availableCrew.length)];
                const crewName = gameState.crew[randomCrewId].name;
                const lines = dynamicBanter[randomCrewId];
                
                if (lines && lines.length > 0) {
                    const randomLine = lines[Math.floor(Math.random() * lines.length)];
                    return { name: crewName, line: randomLine };
                }
            }
            return null;
        }
        // --- END DYNAMIC BANTER DATA ---


        // --- MARKET BLUEPRINTS (Global Definitions for all merchants) ---
        const MARKET_BUY_OPTIONS = [
            { item: "Healing Potion", nextScene: 'buy_potion', cost: 5 },
            { item: "Rope", nextScene: 'buy_rope', cost: 3 },
            { item: "Torch", nextScene: 'buy_torch', cost: 2 },
            { item: "Rum", nextScene: 'buy_rum', cost: 4 }
        ];
        
        const ALCHEMIST_BUY_OPTIONS = [
            { item: "Vitality Tincture", nextScene: 'buy_tincture', cost: 15, doomCost: 0 },
            { item: "Smelling Salts", nextScene: 'buy_salts', cost: 8, doomCost: 0 },
            { item: "Flash Powder", nextScene: 'buy_powder', cost: 10, doomCost: 0 },
            { item: "Alchemical Fire", nextScene: 'buy_fire', cost: 12, doomCost: 0 },
            { item: "Holy Water", nextScene: 'buy_water', cost: 12, doomCost: 0 }
        ];
        
        const TAVERN_BUY_OPTIONS = [
             { item: "Gruel", nextScene: 'buy_gruel_to_go', cost: 1 }
        ];

        const SHIP_SUPPLIES_OPTIONS = [
             { item: "Supplies", cost: 10, amount: 5 },
             { item: "Supplies", cost: 18, amount: 10 }
        ];

        const MARKET_SELL_OPTIONS = [
            { item: "Curious Cargo", nextScene: 'sell_cargo', value: 10, doomCost: 1 }, 
            { item: "Rope", nextScene: 'sell_rope', value: 2, doomCost: 0 },
            { item: "Torch", nextScene: 'sell_torch', value: 1, doomCost: 0 },
            { item: "Healing Potion", nextScene: 'sell_potion', value: 3, doomCost: 0 },
            { item: "Rum", nextScene: 'sell_rum', value: 2, doomCost: 0 }
        ];
        
        const ALCHEMIST_SELL_OPTIONS = [
            { item: "Silver Locket", nextScene: 'sell_locket_alch', value: 10, doomCost: 0 },
            { item: "Alchemical Fire", nextScene: 'sell_fire', value: 20, doomCost: 0 },
            { item: "Holy Water", nextScene: 'sell_water', value: 20, doomCost: 0 },
            { item: "Vitality Tincture", nextScene: 'sell_tincture', value: 7, doomCost: 0 },
            { item: "Healing Potion", nextScene: 'sell_potion_alch', value: 4, doomCost: 0 }, 
            { item: "Pearlescent Mushroom", nextScene: 'sell_mushroom_alch', value: 12, doomCost: 0 }
        ];
        // --- END MARKET BLUEPRINTS ---
        
        // --- SCENE DATABASE (Ordered by Act Flow) ---
        const scenes = {
            // --- PROLOGUE ---
            'prologue_storm': {
                title: "The Planar Storm",
				text: "The deck of The Trident's Kiss heaves. The sky isn't just storming; it hates you. Above, the clouds are a bleeding violet bruise. Captain Gareth stands at the wheel, singing against the gale. '...But who pays the toll for the army of dead?!' he roars. Quinn is frantically tying down crates, screaming that the manifest is slipping away.",
				journal: "The sky didn't just storm; it hated us. Gareth held the wheel until the wood splintered in his grip. I remember the sound of the mainmast snapping more than the thunder. The sea has come to collect.",
                choices: [
                    { text: "Help Quinn secure the cargo", nextScene: 'prologue_abyss', type: 'travel' },
                    { text: "Stand with the Captain", nextScene: 'prologue_abyss', type: 'travel' }
                ]
            },
            'prologue_abyss': {
                title: "The God of the Deep",
				text: "A wave of pure magical force shatters the hull. The freezing dark claims you instantly. You sink, drifting into the abyss, and see IT risinga colossal shadow, vast as a mountain. The screams of Gareth, Quinn, Talon, and Bones are silenced by the water... only to re-ignite inside your skull, burning hotter than the freezing deep.",
				journal: "I died. I know I died. But the Shadow beneath the waves spat me back out. Now, I am not alone in my own skin.",
				onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 5);
                    fxManager.flashRed();
                    return "The magical wave crushed you. Took 5 Damage.";
                },
                choices: [
                    { text: "Gasp for air (Wake Up)", nextScene: 'start', type: 'travel' }
                ]
            },
			
            // --- ACT 1: WRECKAGE & INITIAL JOURNEY ---
			'start': {
                title: "The Wreckage",
				text: "You gasp, lungs burning, and retch salt water onto the grey sand. The storm has taken a break, but the silence of the beach is a lie. Inside your mind, the scream of the dying ship continues. They don't realize they are dead.<br><br>You find your hand cramping, clutching the <span class='text-item'>Captain's Tricorn Hat</span> with a death grip. Beside you, the <span class='text-item'>Compass</span> hums with a <span class='text-void'>violet vibration</span>. You are alive, but you have become a life raft for the damned.",
				journal: "Woke up choking on sand. Gareth's hat is in my handI can't let go of it. The Compass is screaming, and the crew... they are loud. So loud. They don't know they're ghosts.",
				banter: {
					'quinn': "The manifest! The logs! We can't be erased, Edward. Find the records or we never existed!"
				},
                onEnter: (state) => {
                    audioManager.playGasp();
                    let msg = "";
                    if (!state.inventory.includes("Captain's Tricorn")) {
                        state.inventory.push("Captain's Tricorn");
                        msg += "Started with Tricorn. ";
                    }
                    if (!state.inventory.includes("Compass")) {
                        state.inventory.push("Compass");
                        msg += "Found Compass. ";
                    }
                    return msg;
                },
                choices: [
                    { text: "Assess Injuries", nextScene: 'start_medicine_check', type: 'skill', dc: 10, skill: 'Medicine' },
                    { text: "Search Debris", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'start_medicine_check': {
                isLogic: true,
                resolve: (roll) => roll >= 10 ? 'start_medicine_success' : 'start_medicine_fail'
            },
            'start_medicine_success': {
                title: "Field Triage",
                text: "Bones guides your hands. You find a patch of sea-kelp to bind the worst of the cuts and cough the remaining water from your lungs. You feel steady.",
                onEnter: (state) => {
                    state.currentHP = Math.min(state.maxHP, state.currentHP + 2);
                    return "Bones stabilized you. Healed 2 HP.";
                },
                choices: [
                    { text: "Search the debris", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'start_medicine_fail': {
                title: "Shaking Hands",
                text: "You try to check your wounds, but your hands are shaking too violently from the cold. You accomplish nothing.",
                choices: [
                    { text: "Search the debris", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'wreckage_search': {
                isLogic: true,
                resolve: (roll) => roll >= 8 ? 'wreckage_success' : 'wreckage_fail'
            } ,
			'wreckage_success': {
                title: "Salvage",
				text: "Quinn guides your hand to a buried chest. Inside, a pouch of <span class='text-item'>Shillings</span> and a <span class='text-item'>Rusted Cutlass</span>. You strap the blade to your beltthe rust flakes away as your hand touches the hilt, remembering a fight you haven't fought yet. Quinn points frantically to a damp book lying nearbythe <span class='text-item'>Ship's Log</span>.",
				journal: "Salvaged what I could. A rusted blade feels heavy, but Quinn finally shut up once I found the Log. Writing this down gives me something to focus on besides the voices.",
                onEnter: (state) => {
                    const items = ["Rusted Cutlass", "Ship's Log"];
                    let found = false;
                    items.forEach(i => {
                        if(!state.inventory.includes(i)) {
                            state.inventory.push(i);
                            found = true;
                        }
                    });
                    state.shillings += 7; 
                    audioManager.playCoins();
                    
                    if (found) return "Found: Cutlass, Log & 7 Shillings.";
                    return "Found: 7 Shillings.";
                },
                choices: [{ text: "Move to Treeline", nextScene: 'treeline_prepared', type: 'travel' }]
            },
            'wreckage_fail': {
                title: "Empty Sands",
                text: "You dig through the driftwood until your fingers bleed, but the tide has claimed the rest. You find nothing but wet sand and splinters.",
                journal: "Scavenging yielded nothing. I am leaving the shore with empty pockets.",
                choices: [{ text: "Move to Treeline", nextScene: 'treeline', type: 'travel' }]
            },
            
            // ACT 1: ROAD / SMUGGLERS / MARKET
            'treeline_prepared': {
				title: "The Whispering Woods",
				text: "The forest looms ahead, trees twisted like grasping hands. You adjust the weight of your gear. The voices are a dull murmur. A well-traveled road cuts through the center, but Talon notices a faint game trail disappearing into the brush.",
				journal: "The forest is watching. Gareth wants to march like a soldier; Talon wants to skulk like a wolf. I have to decide who to listen to before I go mad.",
				banter: {
					'gareth': "The King's Road is the only path for a proper vessel. March on.",
					'talon': "Roads are for sheep and slaughter. The brush hides us. I smell a game trail the soldiers missed."
				},
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'treeline': {
                title: "The Whispering Woods",
                text: "The forest looms ahead. As you step forward, Quinn screams in your mind. 'The Log! Don't leave the history!' You stumble, looking down to see the water-logged <span class='text-item'>Ship's Log</span> at your feet. You pick it up to silence him.",
                journal: "Quinn wouldn't let me leave without the Log. I found it at the treeline.",
                onEnter: (state) => {
                    if(!state.inventory.includes("Ship's Log")) {
                        state.inventory.push("Ship's Log");
                        return "Obtained Ship's Log.";
                    }
                    return null;
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'road_encounter': {
                title: "The King's Guard",
                text: "A heavy-set <span class='memory-keyword' data-lore='The iron fist of the Crown. They despise the supernatural and govern with martial law.'>Royal Guard</span> in plate armor blocks the path. 'Halt! Identify yourself!'",
                journal: "Royal Guard. Shining armor covering a rotten core. He looks at me like driftwood that needs burning.",
                choices: [
                    { text: "Speak diplomatically", nextScene: 'guard_talk', type: 'dialogue' },
                    { text: "Attack him", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
            'trail_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    const success = roll >= state.lastDC;
                    
                    if (success) {
                        if (state.lastCrewUsedId === 'talon') {
                            return 'trail_success_talon';
                        }
                        return 'trail_success';
                    }
                    
                    return 'trail_fail';
                }
            },
            'trail_success': {
                title: "Hidden Signs",
                text: "You struggle through the thorns but emerge near a hidden cove, overlooking a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "The trail was tough, but we found a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    state.influence = Math.min(50, state.influence + 4); 
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'trail_success_talon': {
                title: "Smuggler's Route",
                text: "Talon guides your movement, emphasizing silence and observation. You emerge near a hidden cove, spotting a marked crate abandoned near the tideline. You grab it just before noticing a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "Talon's skill led me through the brush. Found some mysterious Cargo and reached a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    state.influence = Math.min(50, state.influence + 4); 
                    if (!state.inventory.includes("Curious Cargo")) {
                        state.inventory.push("Curious Cargo");
                        return "Found Curious Cargo. Secrets Learned (Chaos +4).";
                    }
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'trail_fail': {
                title: "Lost",
                text: "The undergrowth fights you. You stumble out of the brush, loud and covered in burrs, right in front of a Royal Guard.",
                journal: "Tried the hidden path, but made too much noise. Stumbled right into a Guard.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Scratch Damage."; 
                },
                choices: [
                    { text: "Confront the Guard", nextScene: 'road_encounter', type: 'dialogue' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'trail_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ] 
            },
            'guard_talk': {
                title: "The Interrogation",
                text: "The Guard eyes your ragged clothes. 'You look like wreckage refuse. We have reports of smugglers. Make it worth my while, or I'll haul you in.'",
                journal: "The Guard is corrupt. He wants a bribe or a reason to let me go.",
                banter: {
                    'gareth': "Stand tall. Authority respects strength, or gold."
                },
                choices: [
                    { text: "Bribe him", nextScene: 'guard_bribe', type: 'action', cost: 5 }, 
                    { text: "Show Respect", nextScene: 'guard_respect', type: 'dialogue', orderGain: 4 },
                    { text: "Intimidate him", nextScene: 'guard_intimidate_check', type: 'skill', dc: 13, skill: 'Intimidation' },
                    { text: "Attack", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
			'guard_respect': {
                title: "Order and Law",
                text: "You salute with practiced discipline. 'Just a shipwrecked sailor, sir. Keeping to the road.' The Guard straightens, recognizing the posture. 'Carry on then. And take theseget yourself a warm meal.' He flicks two silver coins at you.",
                journal: "Played the part of the good sailor. Saluted the uniform, not the man. I worked. Order has its uses, even if it tastes like bile.",
                onEnter: (state) => {
                    state.influence = Math.max(-50, state.influence - 4); 
                    state.shillings += 2;
                    audioManager.playCoins();
                    return "Showed Respect (Order +4). Received 2 Shillings.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'guard_bribe': {
                title: "The Toll",
                text: "He bites the gold. 'Get moving. Head to the Market, don't linger here.'",
                journal: "Paid the toll. I played the game and walked away unscathed.",
                onEnter: (state) => { 
                    audioManager.playCoins();
                    return "Bribed Guard (Neutral Act)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'guard_intimidate_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    let finalRoll = roll;
                    
                    if (state.inventory.includes("Captain's Tricorn")) {
                        finalRoll += 1;
                        addToHistory(`Passive Bonus (Captain's Tricorn): +1. Final Result: ${finalRoll}`, 'roll');
                    }
                    
                    return finalRoll >= 13 ? 'guard_scared' : 'combat_guard';
                }
            },
            'guard_scared': {
                title: "Spectral Fear",
                text: "You channel Gareth's command. Your eyes flare with pale light. The Guard stumbles back, terrified. 'Go! Just go!'",
                journal: "Gareth spoke through me. The Guard fled in terror.",
                onEnter: (state) => { 
                    state.influence = Math.min(50, state.influence + 4); 
                    return "Guard Terrified (Chaos +4)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'combat_guard': {
                title: "The Clash",
                text: "He unhooks a heavy warhammer from his belt. You move to intercept him, driving the momentum into a brutal close-quarters struggle. You barely deflect the crushing weight of his strikes, fighting until he finally falls. You survive, but you are now an enemy of the crown.",
                journal: "Had combat the Guard. I am an outlaw now.",
                choices: [
                    { 
                        text: "Continue (Take Damage and Proceed)", 
                        nextScene: 'market_crossroads', 
                        type: 'travel' 
                    }
                ],
                onEnter: (state) => { 
                    audioManager.playClash();
                    let minDmg = 10;
                    let varDmg = 6;
                    
                    if (state.inventory.includes("Rusted Cutlass")) {
                        minDmg = 6;
                        addToHistory("Passive: Cutlass reduced combat damage.", 'system');
                    }
                    
                    const dmg = Math.floor(Math.random() * varDmg) + minDmg; 
                    state.currentHP = applyDamage(state.currentHP, dmg);
                    fxManager.flashRed(); 
                    state.influence = 50;
                    return `Took ${dmg} damage. Became Outlaw (Max Chaos).`;
                }
            },
            'smuggler_meet': {
                title: "The Cove",
                text: "The men draw blades as you approach. 'One step closer and you're fish food!'",
                journal: "Found the smugglers. They aren't friendly.",
                choices: [
                    { text: "Flash 'The Mariner's Sign'", nextScene: 'smuggler_friend', type: 'dialogue', reqSmuggler: 3 },
                    { text: "Offer Curious Cargo", nextScene: 'smuggler_cargo', type: 'action', reqItem: 'Curious Cargo', chaosGain: 6 },
                    { text: "Buy safe passage", nextScene: 'smuggler_pay', type: 'action', cost: 5 },
                    { text: "Run to Market", nextScene: 'market_crossroads', type: 'dialogue' }
                ]
            },
            'smuggler_cargo': {
                title: "A Smuggler's Trust",
                text: "The lead smuggler inspects the crate, nodding slowly. 'This is high-value. You've earned our trust, Mariner. Your loyalty is payment enough.'",
                journal: "Traded Curious Cargo directly to the smugglers.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0;
                    state.influence = Math.min(50, state.influence + 6);
                    return "Gave Cargo. Chaos +6.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_friend': {
                title: "Old Alliances",
                text: "They recognize the sign. 'The Mariner lives? Then you drink for free tonight.' They toss you a bottle from their own supply.",
                journal: "The smugglers recognized the code. Shared their Rum.",
                onEnter: (state) => {
                     state.inventory.push("Rum");
                     return "Received Rum.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_pay': {
                title: "Business",
                text: "They take the coin. 'Don't let the Guard see you.'",
                journal: "Paid the toll. I played the game and walked away unscathed.",
                onEnter: (state) => { 
                    audioManager.playCoins();
                    return "Paid Smugglers."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'market_crossroads': {
                title: "The Crossroads",
                text: "You arrive at a ramshackle market outside of the port town. You can buy basic supplies here, or push on toward the Lighthouse.",
                journal: "Reached the a small Market. I should stock up before the final push.",
                choices: [
                    { text: "Visit the Market Merchant", nextScene: 'market_stall', type: 'travel' },
                    { text: "Head to the Lighthouse", nextScene: 'lighthouse_split', type: 'travel' }
                ]
            },
            
            // ACT 1: MARKET SCENES
            'market_stall': {
                title: "The Merchant",
                text: "A hooded figure displays goods on a crate. 'Coin for survival, traveler?'",
                journal: null,
                stock: {
                    "Healing Potion": 1,
                    "Rope": 1,
                    "Torch": 1,
                    "Curious Cargo": 1, 
                    "Rum": 0 
                },
                banter: {
                    'quinn': "Buy what you can, but we need inventory, not junk."
                },
                choices: [
                    { text: "Sell Wares", nextScene: 'market_sell', type: 'travel', doomCost: 0 }, 
                    { text: "Leave", nextScene: 'market_crossroads', type: 'travel', doomCost: 0 }
                ]
            },
            'buy_rum': {
                title: "Purchase",
                text: "You exchange coin for the bottle of grog.",
                journal: "I bought a bottle of rum.",
                onEnter: (state) => { 
                    state.inventory.push("Rum"); 
                    scenes['market_stall'].stock["Rum"] -= 1;
                    audioManager.playCoins();
                    return "Bought Rum."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_potion': {
                title: "Purchase",
                text: "You exchange coin for the red liquid.",
                journal: "I bought a healing potion.",
                onEnter: (state) => { 
                    state.inventory.push("Healing Potion"); 
                    scenes['market_stall'].stock["Healing Potion"] -= 1;
                    audioManager.playCoins();
                    return "Bought Potion."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_rope': {
                title: "Purchase",
                text: "You coil the sturdy hemp rope over your shoulder.",
                journal: "I bought a coil of rope.",
                onEnter: (state) => { 
                    state.inventory.push("Rope"); 
                    scenes['market_stall'].stock["Rope"] -= 1;
                    audioManager.playCoins();
                    return "Bought Rope."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'buy_torch': {
                title: "Purchase",
                text: "A simple torch, dipped in pitch.",
                journal: "I bought a torch.",
                onEnter: (state) => { 
                    state.inventory.push("Torch"); 
                    scenes['market_stall'].stock["Torch"] -= 1;
                    audioManager.playCoins();
                    return "Bought Torch."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel', doomCost: 0 }]
            },
            'market_sell': {
                title: "The Merchant - Selling",
                text: "The merchant eyes your gear. 'I can take some of that off your hands for a fair price.'",
                choices: [
                    { text: "Back to Buying", nextScene: 'market_stall', type: 'travel', doomCost: 0 },
                    { text: "Leave", nextScene: 'market_crossroads', type: 'travel', doomCost: 0 }
                ]
            },
            'sell_cargo': {
                title: "The Transaction",
                text: "The merchant accepts the crate without comment, paying the agreed price.",
                journal: "Sold the Curious Cargo for coin.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0;
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+10s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_rope': {
                title: "Sold",
                text: "You hand over the rope.",
                journal: "I sold the rope.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rope");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2;
                    scenes['market_stall'].stock["Rope"] = (scenes['market_stall'].stock["Rope"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Rope (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_torch': {
                title: "Sold",
                text: "You hand over the torch.",
                journal: "I sold the torch.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Torch");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 1;
                    scenes['market_stall'].stock["Torch"] = (scenes['market_stall'].stock["Torch"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Torch (+1s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_potion': {
                title: "Sold",
                text: "You hand over the potion.",
                journal: "I sold the potion.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 3;
                    scenes['market_stall'].stock["Healing Potion"] = (scenes['market_stall'].stock["Healing Potion"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Potion (+3s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            'sell_rum': {
                title: "Sold",
                text: "You hand over the bottle of rum.",
                journal: "I handed over the bottle of rum.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rum");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2; 
                    scenes['market_stall'].stock["Rum"] = (scenes['market_stall'].stock["Rum"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Rum (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel', doomCost: 0 }]
            },
            
            // ACT 1: LIGHTHOUSE FINAL PATH
            'lighthouse_split': {
                title: "The Final Approach",
                text: "The Lighthouse stands atop a jagged cliff. Two paths present themselves: a sheer climb up the rock face, or a dark, winding tunnel through the sea caves below.",
                journal: "Two ways to the top: climb the cliff or brave the dark caves.",
                choices: [
                    { text: "Climb the Cliff", nextScene: 'cliff_climb', type: 'travel' },
                    { text: "Enter the Sea Caves", nextScene: 'dark_caves', type: 'travel' }
                ]
            }, 
			'cliff_climb': {
				title: "The Precipice",
				text: "The wind howls, threatening to tear you from the rock. The Lighthouse is a sheer vertical ascent from here. The stone is slick with sea-spray and blood from previous climbers.",
				journal: "The cliff was a wall of jagged teeth. One slip and I'd join the wreck below. Gareth was screaming at me to push through the pain, to climb until my fingers bled.",
				banter: {
					'gareth': "Pull yourself up, or the sea takes us back!"
				},
				choices: [
					{ text: "Use Rope (Safe Climb)", nextScene: 'faction_check', type: 'action', reqItem: 'Rope', consume: true },
					{ text: "Free Solo", nextScene: 'climb_check', type: 'skill', dc: 14, skill: 'Athletics' }
				]
			},
            'climb_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'faction_check' : 'climb_fail'
            },
            'climb_fail': {
                title: "Slip and Fall",
                text: "You slide twenty feet, shredding skin against stone before catching a root.",
                journal: "Almost fell to my death. Climbing without rope was foolish.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 5); 
                    fxManager.flashRed();
                    return "Took 5 Scratch Damage."; 
                },
                choices: [
                    { text: "Keep Climbing (Arrive at Lighthouse)", nextScene: 'lighthouse_arrival', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'lighthouse_arrival',
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'dark_caves': {
                title: "The Abyss Below",
				text: "The air is thick and smells of rot. It is pitch black. You can hear things skittering on the damp stone, but you cannot see them.",
				journal: "The caves felt heavy, like the stone was trying to push the air out of my lungs. Bones told me to close my eyes and smell the way forward.",
                banter: {
                    'bones': "That air is thick. Your eyes are useless here. Locate the draft or light a torch."
                },
                choices: [
                    { text: "Light Torch (Safe Passage)", nextScene: 'dark_caves_illuminated', type: 'action', reqItem: 'Torch', consume: true },
                    { text: "Navigate by Airflow", nextScene: 'dark_check', type: 'skill', dc: 14, skill: 'Nature' } 
                ]
            },
            'dark_caves_illuminated': {
                title: "Torch's End",
                text: "The damp, choking air of the caves extinguishes your torch within minutes, plunging you into darkness. But then, a pale glow reveals itself. A patch of smooth mushrooms provides an eerie illumination. You remember Bones's banter and collect the specimen for its promised clarity.",
                journal: "The torch died in the damp air, but I found the Pearlescent Mushroom by its own light.",onEnter: (state) => {
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found: Pearlescent Mushroom.";
                    }
                    return "Torch expended.";
                },
                choices: [{ text: "Proceed to Exit (Arrive at Lighthouse)", nextScene: 'faction_check', type: 'travel' }]
            },
            'dark_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'faction_check' : 'dark_fail'
            },
            'dark_fail': {
                title: "Unseen Dangers",
                text: "In the dark, you trip over unseen rocks and twist your ankle. Something scuttles away in the shadows.",
                journal: "The caves were too dark. I got hurt.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 4); 
                    fxManager.flashRed();
                    return "Took 4 Damage."; 
                },
                choices: [
                    { text: "Limp to the Exit", nextScene: 'lighthouse_arrival', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'lighthouse_arrival',
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'lighthouse_arrival': {
                title: "The Beacon",
                text: "You reach the heavy iron doors of the Lighthouse. But you are not alone.",
                journal: "Made it to the Lighthouse doors. Someone is waiting.",
                choices: [
                    { text: "Confront them", nextScene: 'faction_check', type: 'travel' }
                ]
            },
            
            // ACT 1: FACTION ENDINGS
            'faction_check': {
                isLogic: true,
                resolve: (r, state) => {
                    if (state.influence <= -4) return 'ending_order'; 
                    if (state.influence >= 4) return 'ending_chaos'; 
                    return 'ending_neutral_check'; 
                }
            },
            'ending_order': {
                title: "Checkpoint: The Deputy",
                text: "A squad of Royal Guards stands at the door, pikes grounded. Their captain steps forward, his gauntlet striking his breastplate in a sharp salute. 'We have eyes on the road, citizen. In a land governed by rot, you kept to the code. The Lighthouse is yours to secure, Deputy.' They part ranks, granting you passage with the discipline of a king's court.",
                journal: "The Guards respect me. They let me pass without question. Order has its uses.",
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
			'ending_chaos': {
                title: "Checkpoint: Smuggler's Ally",
                text: "Smugglers lounge by the entrance. 'The Mariner lives? Then you drink for free tonight.' They toss you a key.",
                journal: "The smugglers see me as one of their own. They gave me the key.",
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral_check': {
                title: "Checkpoint: The Locked Door",
                text: "The clearing is empty. The presence you sensed was only the crew's anticipation screaming in your mind. There is no welcome partyjust the wind and a barred door. You must find a way to breach the lock alone.",
                journal: "The Lighthouse is sealed. I need to find the mechanism to enter.",
                choices: [
                    { text: "Analyze the mechanism", nextScene: 'neutral_lock_logic', type: 'skill', dc: 15, skill: 'Insight' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'ending_neutral_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'neutral_lock_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'ending_neutral_success' : 'ending_neutral_fail'
            },
            'ending_neutral_success': {
                title: "Checkpoint: The Shadow Entrance",
                text: "Captain Gareth's voice is calm, analyzing the door's weak points instantly. The ancient mechanism bows to your superior insight, and the heavy bolt slides back. You slip inside, unseen and unopposed.",
                journal: "I forced the lock open and entered the lighthouse. Nobody saw me.",
                choices: [{ text: "Enter and Rest (Start Act 1)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral_fail': {
                title: "Checkpoint: The Shadow Fails",
                text: "Your attempt to understand the mechanism jams the lock further. The noise echoes in the wind, and you must hurry before someone investigates. You quickly force the door, abandoning subtlety.",
                journal: "I failed the mechanism check. I forced the door and entered the lighthouse.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Damage (Hurry)."; 
                },
                choices: [
					{ 
						text: "Rest & Prepare (Level Up)", 
						type: 'action', 
						action: () => window.gameFunctions.startDreamscape('act1_transition') 
					} 
				]
            },
            
            // --- ACT 1: HUB & ABILITIES ---
            'lighthouse_vigil': {
				title: "Charting Course",
				text: "The lighthouse lamp cuts a bright path through the dark, but your gaze is fixed on the water-warped pages of the Ship's Log. The ink has run on the coordinates, but Gareth's handwriting remains clear on the final pagethe lyrics to the 'Wolf King's Toll'.<br><br>The bickering voices in your mind fall silent. Then, softly, they begin to hum the melody in unison. It is not a myth; it is a map. To ferry your crew to the afterlife, you must locate these lost artifacts known as the Wolves of Valor.",
				journal: null,
				isRest: true,
				onEnter: (state) => {
					const shanty = `The shanty holds the truth. I must find the Ring and the Blade to save my crew. I am the Captain now.<br><br>
					  <i class='spectral-text-glow'>Theres a tax for the coin and a tax for the bread,<br>
					  But who pays the toll for the army of dead?<br>
					  The Wolf King did, so the legends say,<br>
					  To call back the souls who lost their way.<br><br>
					  He found the Ring of ancient Brass,<br>
					  And the Blade that lets no Vampire pass.<br>
					  He gave them a home and a people to keep,<br>
					  And woke the crew from their deep cold sleep.<br><br>
					  The dead stood fast 'til the war was won,<br>
					  Then vanished like mist in the morning sun.<br>
					  Waiting for a Captain as cursed as he.</i>`;
					
					addToHistory(shanty, 'entry');
					
					if (state.currentHP < state.maxHP) {
						state.currentHP = state.maxHP;
					}
					
					Object.keys(state.crew).forEach(k => state.crew[k].used = false);
					state.docksWorkCount = 0;
					state.holdTheLineUsed = false;
					return "Mission Accepted: Find the Wolves of Valor. HP and Crew Use Restored.";
				},
				choices: [
					{ 
						text: "Rest & Prepare (Level Up)", 
						type: 'action', 
						action: () => window.gameFunctions.startDreamscape('act1_transition') 
					} 
				]
			},
            'captain_orders': {
                title: "The Captain's Orders",
                text: "Before you descend into the Port of Shadows, the crew manifests in the lantern's light. They know the odds. Each offers a final, unique advantage, but you have the focus to maintain only one. Choose who to listen to.",
                journal: "The crew offered their aid. I had to choose a permanent advantage for Act 1.",
                choices: [
                    { 
                        text: "Gareth: 'Violence of Action' (First Combat has Advantage)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.isSurpriseRound = true; 
                            return "Gareth's tactical advice grants a free Surprise Round on the first boss."; 
                        }
                    },
                    { 
                        text: "Bones: 'The Last Meal' (Overheal to 25/20 HP)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.currentHP = MAX_OVERHEAL_CAP; 
                            return "Bones prepared a feast. Overhealed to 25 HP."; 
                        }
                    },
                    { 
                        text: "Quinn: 'Logistics' (Reveals Time Costs)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.quinnLogistics = true; 
                            return "Quinn hands you a chronometer. You can now see the Time Cost of every action."; 
                        }
                    },
                    { 
                        text: "Talon: 'Forward Recon' (Unlock Secret Paths)", 
                        nextScene: 'lighthouse_morning', 
                        type: 'dialogue',
                        customClass: 'btn-game spectral-active',
                        onSelect: (state) => { 
                            state.knowsSmelterSecret = true; 
                            state.knowsChapelSecret = true; 
                            return "Talon scouted ahead. Smelter and Chapel shortcuts unlocked."; 
                        }
                    }
                ]
            },
            'lighthouse_morning': {
                title: "The First Morning",
                text: "The chaotic surge of power that courses through you is threatening to splinter your mind. You pull the <span class='text-item'>Compass</span> from your beltits needle is violently vibrating, demanding command. You must give the raw planar energy shape by focusing entirely on a single technique. <span class='text-danger'>This choice is absolute.</span> The path you forge now is permanent, Mariner; it will determine your strength and define the immediate danger you face in the Port of Shadows.",
                banter: {
                    'gareth': "The town is bleeding. Fire and ruin in the Smelter District.",
                    'talon': "Things that refuse to stay dead hide in the fog of the Sunken Chapel."
                },
                choices: [
                    { 
                        text: "Learn to Endure (Absorb Elements)", 
                        nextScene: 'learn_absorb', 
                        type: 'dialogue',
                        customClass: 'btn-fire-glow'
                    }, 
                    { 
                        text: "Learn to See (Primeval Awareness)", 
                        nextScene: 'learn_primeval', 
                        type: 'dialogue',
                        customClass: 'btn-shadow-glow'
                    }
                ]
            },
            'learn_absorb': {
                title: "Gareth's Lesson",
                text: "Gareth grips your shoulder. 'Fire burns only if you let it in. Capture it.' You feel a cold resilience settle in your veins. You understand now how to turn the elements against themselves.",
                journal: "I learned Absorb Elements. I am ready for the fire.",
                onEnter: (state) => {
					state.player.specialization = 'AE'; 					
					state.currentHP = state.maxHP;
					state.act1Started = true;
					return "Unlocked: Absorb Elements. HP Restored. Act 1 Commencing.";
				},
                choices: [{ text: "Descend to the Town", nextScene: 'cliffside_overlook', type: 'travel' }]
            },
            'learn_primeval': {
                title: "Talon's Lesson",
                text: "Talon covers your eyes. 'The dead leave a wake in the ether. Look with your mind.' When you open your eyes, the world hums with hidden outlines. The unseen is now visible to you.",
                journal: "I learned Primeval Awareness. The undead cannot hide from me.",
                onEnter: (state) => {
					state.player.specialization = 'PA';
					state.currentHP = state.maxHP; 
					state.act1Started = true;
					return "Unlocked: Primeval Awareness. HP Restored. Act 1 Commencing.";
				},
                choices: [{ text: "Descend to the Town", nextScene: 'cliffside_overlook', type: 'travel' }]
            },
            'cliffside_overlook': {
                title: "Cliffside Overlook",
                text: "The path winds along the sheer cliff face, providing a terrifying view of the Port of Shadows below. You see the chaos: smoke rising from the <span class='text-fire'>Smelter District</span> and a thick, unnatural fog shrouding the <span class='text-void'>Sunken Chapel</span>. You must decide whether to scan the area for threats or hasten your descent.",
                journal: "Reached the overlook. The Port is a warzone. Must be cautious.",
				banter: {
						'talon': "Wait. Look at the shadows near those rocks. People leave valuable things behind when they run.",
						'gareth': "We don't have time to scavenge like rats! Move your feet!"
					},
                choices: [
                    { 
                        text: "Scan the Road for Guards and Loot",
                        nextScene: 'overlook_scan_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Perception' 
                    },
                    { 
                        text: "Hasten Descent",
                        nextScene: 'overlook_hasten_check', 
                        type: 'skill', 
                        dc: 10, 
                        skill: 'Athletics',
                        doomCost: 0
                    }
                ]
            },
            'overlook_scan_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'overlook_scan_success' : 'overlook_hasten_fail'
            },
            'overlook_scan_success': {
                title: "Talon's Eye",
                text: "Talon guides your focus. You spot a discarded pack near a large rock formationa traveler was robbed or fled quickly. It holds a small but valuable Silver Locket.",
                journal: "Talon spotted a discarded Locket. Easy coin.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Silver Locket")) {
                        state.inventory.push("Silver Locket");
                        return "Found Silver Locket.";
                    }
                    return "Found nothing else of value.";
                },
                choices: [{ text: "Continue Descent", nextScene: 'meeting_the_stranger', type: 'travel' }]
            },
            'overlook_scan_fail': {
                title: "Blinded by the View",
                text: "You stumble over loose scree and fall awkwardly, twisting your knee slightly.",
                journal: "Failed the scan. Must be more careful.",
                choices: [
                    { text: "Continue Descent", nextScene: 'meeting_the_stranger', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'overlook_scan_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'overlook_hasten_check': {
                isLogic: true,
                resolve: (roll) => roll >= 10 ? 'meeting_the_stranger' : 'overlook_hasten_fail'
            },
            'overlook_hasten_fail': {
                title: "A Misplaced Step",
                text: "You stumble over loose scree and fall awkwardly, twisting your knee slightly.",
                journal: "Hasted descent failed. Took minor damage.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 2);
                    fxManager.flashRed();
                    return "Took 2 Damage.";
                },
                choices: [
                    { text: "Reach the Gates", nextScene: 'meeting_the_stranger', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'meeting_the_stranger', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
			'meeting_the_stranger': {
                title: "The Stranger",
                text: "A figure in stained robes stumbles up the path, clutching a satchel. He freezes, eyes wide behind cracked spectacles.<br><br>'You... you're going the wrong way,' he wheezes. 'The Anchor is broken! The Wolf King's math is unraveling!'<br><br>Before you can speak, he thrusts a <span class='text-item'>Salt-Warped Spyglass</span> into your chest. 'I don't want to see the fissures anymore. Take it! Let it show you the rot.' He scrambles past you, fleeing the city.",
                journal: "Met a frantic stranger. He raved about a 'Broken Anchor' and forced his Spyglass on me.",
                banter: {
                    'quinn': "Math doesn't unravel. But... if the Anchor he speaks of is a planar binding, we are all in grave danger.",
                    'gareth': "Let him run. We walk into the fire, not away from it."
                },
                onEnter: (state) => {
                     if (!state.inventory.includes("Salt-Warped Spyglass")) {
                        state.inventory.push("Salt-Warped Spyglass");
                        return "Received Salt-Warped Spyglass.";
                     }
                     return null;
                },
                choices: [
                    { text: "Descend to the Gates", nextScene: 'town_descent', type: 'travel' }
                ]
            },
            'town_descent': {
				title: "The Descent",
				text: "You arrive at the main city gate. The chaos here is raw. Your <span class='text-item'>Compass</span> vibrates violently, the needle splitting in two. One ghostly needle glows <span class='text-fire'>Orange</span> toward the Smelter. The other turns <span class='text-void'>Black</span> toward the Chapel.",
				journal: "The Compass cracked. It's pulling me apart. Smelter fire to the East, Chapel fog to the West. Gareth is rightI can't save everyone. I have to choose.",
				banter: {
					'gareth': "Hold fast! A Captain who chases two headings sails in circles! Choose a target, Mister Jones. Fire or Fogpick your poison!"
				},
                choices: [
                    { text: "Enter the Port of Shadows", nextScene: 'town_square', type: 'travel' }
                ]
            },
            
            // ACT 1: HUB SCENES (PORT SQUARE / VENDORS / DOCKS)
            'town_square': {
                title: "Port of Shadows",
                text: "",
                choices: [],
                onEnter: (state) => {
                    // --- ACT 3 STATE (HIGHEST PRIORITY) ---
                    // --- ACT 3 STATE (HIGHEST PRIORITY) ---
                    if (state.act3Started) {
                        state.currentLocation = 'port_hub';

                        let desc = "The air here is cold and still. The Vampire presence is subtle but palpable. The familiar docks and taverns now feel like traps.";
                        
                        if (state.isEthereal) {
                            desc += "<br><br><span class='text-spectral'>The Veil thins</span>. The iron gates of the Wolf King's Estate shimmer into existence where a brick wall stood moments ago.";
                        }
                        
                        // HINT FOR EXPANSION:
                        if (!state.factionAligned) {
                            desc += "<br><br><span class='text-amber-500'>Objective:</span> The Harbor Provisioner has information on the new factions holding the coast.";
                        }

                        scenes['town_square'].text = desc;

                        let act3Choices = [
                            { 
                                text: "Enter the Vanishing Manor", 
                                nextScene: 'wolf_estate_safe', 
                                type: 'travel', 
                                reqFlag: 'isEthereal',
                                customClass: 'btn-planewalk-reveal',
                                doomCost: 0
                            },
                            { 
                                text: `Maps the Open Sea (${state.shipName})`, 
                                nextScene: 'sea_map_hub', 
                                type: 'travel', 
                                customClass: 'btn-anchor',
                                doomCost: 0 
                            },
                            // HIGHLIGHT PROVISIONER IF NOT ALIGNED
                            { 
                                text: "Go to The Harbor Provisioner (Quest)", 
                                nextScene: 'port_provisioner', 
                                type: 'travel', 
                                doomCost: 0,
                                customClass: !state.factionAligned ? 'btn-pulse' : '' 
                            },
							{ text: "Visit The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                            { text: "Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
							{ text: "Explore the Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }
                        ];
                        
                        scenes['town_square'].choices = act3Choices;
                        
                        return null;
                    }

                    // --- ACT 1 & ACT 2 LOGIC (EXISTING) ---
                    const hasRing = state.inventory.includes("Ring of Brass");
                    const hasBlade = state.inventory.includes("Sword of Valor");
                    
                    let newChoices = [
                        { 
                            text: "Investigate Smelter District", 
                            nextScene: 'smelter_entry', 
                            type: 'travel', 
                            reqNotItem: 'Sword of Valor', 
                            customClass: 'btn-fire-glow' 
                        },
                        { 
                            text: "Investigate Sunken Chapel", 
                            nextScene: 'chapel_entry', 
                            type: 'travel',
                            reqNotItem: 'Ring of Brass', 
                            customClass: 'btn-shadow-glow' 
                        },
                        { text: "Visit The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                        { text: "Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                        { text: "Explore the Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }
                    ];

                    // Finale Unlocked State
                    if (hasRing && hasBlade) {
                        scenes['town_square'].text = "The <span class='text-void'>Rift</span> is tearing the sky apart. Violet lightning strikes the cobblestones. You have the <span class='text-item'>Ring</span> and the <span class='text-item'>Blade</span>. The Ritual is the only way to close this wound.";
                        
                        newChoices.unshift({
                            text: "Begin the Final Ritual", 
                            nextScene: 'ritual_entry_logic',
                            type: 'travel', 
                            customClass: 'btn-hero', 
                            doomCost: 0
                        });
                        
                        scenes['town_square'].choices = newChoices;
                        return "Finale Unlocked.";
                    }
                    
                    // Normal Act 1 State
                    else if (hasRing) {
                        scenes['town_square'].text = "You return with the <span class='text-item'>Ring of Brass</span>. Fog from the Sunken Chapel is flooding the streets. The <span class='text-void'>Shadow threat</span> has escalated. You must pursue the Fire Path now.";
                    } 
                    else if (hasBlade) {
                        scenes['town_square'].text = "You return with the <span class='text-item'>Sword of Valor</span>. Ash falls from the Smelter District like <span class='text-fire'>gray snow</span>. The <span class='text-fire'>Fire threat</span> has escalated. You must pursue the Shadow Path now.";
                    } 
                    else {
                        scenes['town_square'].text = "The Port is in chaos. Civilians flee toward the docks. You check the <span class='text-item'>Compass</span>. The needle splits violently, vibrating between two distinct sources of planar interference:<br><br>1. An intense <span class='text-fire'>Heat Signature</span> from the Smelter District.<br>2. A deep <span class='text-void'>Void Pocket</span> in the Sunken Chapel.<br><br>To stabilize the Rift, you must investigate both.";
                    }
                    
                    // Filter choices based on acquired items
                    scenes['town_square'].choices = newChoices.filter(choice => {
                        if (choice.nextScene === 'smelter_entry' && hasBlade) return false;
                        if (choice.nextScene === 'chapel_entry' && hasRing) return false;
                        return true;
                    });
                }
            },
            
            // ACT 1: ALCHEMIST SCENES
            'alchemist_triage': {
				title: "Madam Alara, Triage Alchemist",
				text: "Madam Alara, encased in her beaked mask, tends to the wounded with the cold efficiency of a butcher. She doesn't offer comfort, only chemistry. Her wares are potentshe deals only in true survival.",
				journal: "Madam Alara. She'd distill her own mother if it made a potent tonic. Her prices are robbery, but her potions might be the only reason I survive the night.",
				stock: {
                    "Vitality Tincture": 2,
                    "Smelling Salts": 3,
                    "Flash Powder": 1,
                    "Alchemical Fire": 1, 
                    "Holy Water": 1 
                },
                choices: [
                    { text: "Sell Wares", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            'alchemist_secret_stock': {
                title: "The Alchemist's Reserve",
                text: "Madam Alara takes the Strange Coina brass piece from an ancient kingdomand her head snaps up. 'I recognize this metal. It's from the kingdom of the Wolf King,' she hisses. 'You honor my trade. This Draft is my reserve, a single draught that cheats the ferryman. Use it wisely, Mariner.'",
                journal: "Traded the Strange Coin for the Alchemist's ultimate reserve: the Phoenix Draft.",
                choices: [
                    { text: "Return to Triage", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    if (!state.inventory.includes("Phoenix Draft")) {
                        state.inventory.push("Phoenix Draft");
                        return "Acquired Phoenix Draft.";
                    }
                    return null;
                }
            },
            'alchemist_sell': {
                title: "Triage Alchemist - Selling",
                text: "Alara inspects your items, sometimes offering a premium for rare components. 'Speak your price, Mariner. Time is coin.'",
                journal: null,
                choices: [
                    { text: "Back to Buying", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            'sell_locket_alch': {
                title: "Sentiment's Price",
                text: "Madam Alara cleans the silver locket with a sterile cloth. 'Sentiment holds value in chaos,' she remarks, sliding you the promised coin.",
                journal: "Sold the Silver Locket for 10 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Silver Locket");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Locket (+10s) to Alchemist.";
                },
            },
            'buy_fire': {
                title: "Purchase",
                text: "The Alchemical Fire is hot to the touch. A deadly weapon for the Shadow path.",
                journal: "I purchased Alchemical Fire.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Alchemical Fire"); 
                    scenes['alchemist_triage'].stock["Alchemical Fire"] -= 1;
                    audioManager.playCoins();
                    return "Bought Alchemical Fire."; 
                },
            },
            'buy_water': {
                title: "Purchase",
                text: "The Holy Water is cold and consecrated. A deadly weapon for the Fire path.",
                journal: "I purchased Holy Water.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Holy Water"); 
                    scenes['alchemist_triage'].stock["Holy Water"] -= 1;
                    audioManager.playCoins();
                    return "Bought Holy Water."; 
                },
            },
            'buy_tincture': {
                title: "Purchase",
                text: "The Vitality Tincture burns cold in your hand.",
                journal: "I purchased a high-grade Vitality Tincture.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Vitality Tincture"); 
                    scenes['alchemist_triage'].stock["Vitality Tincture"] -= 1;
                    audioManager.playCoins();
                    return "Bought Tincture."; 
                },
            },
            'buy_salts': {
                title: "Purchase",
                text: "Smelling Salts. A desperate measure for desperate times.",
                journal: "I purchased Smelling Salts.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Smelling Salts"); 
                    scenes['alchemist_triage'].stock["Smelling Salts"] -= 1;
                    audioManager.playCoins();
                    return "Bought Salts."; 
                },
            },
            'buy_powder': {
                title: "Purchase",
                text: "Flash Powder. Quick, loud, and effective.",
                journal: "I purchased Flash Powder.",
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel', doomCost: 0 }],
                onEnter: (state) => { 
                    state.inventory.push("Flash Powder"); 
                    scenes['alchemist_triage'].stock["Flash Powder"] -= 1;
                    audioManager.playCoins();
                    return "Bought Powder."; 
                },
            },
            'sell_potion_alch': {
                title: "Sold for Premium",
                text: "The Alchemist pays a premium for the components in your standard Potion.",
                journal: "Sold a Healing Potion for 4 Shillings to the Alchemist.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 4;
                    scenes['alchemist_triage'].stock["Healing Potion"] = (scenes['alchemist_triage'].stock["Healing Potion"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Potion (+4s) to Alchemist.";
                },
            },
             'sell_mushroom_alch': {
                title: "Sold for Premium",
                text: "The Alchemist recognizes the power in the Pearlescent Mushroom. 'A valuable specimen,' she murmurs.",
                journal: "Sold the Pearlescent Mushroom for 12 Shillings to the Alchemist.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 12; 
                    audioManager.playCoins();
                    return "Sold Mushroom (+12s) to Alchemist.";
                },
            },
            'sell_fire': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Alchemical Fire.",
                journal: "I sold the Alchemical Fire artifact for 20 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Alchemical Fire");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Alchemical Fire (+20s).";
                },
            },
            'sell_water': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Holy Water.",
                journal: "I sold the Holy Water artifact for 20 Shillings.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Holy Water (+20s).";
                },
            },
            'sell_tincture': {
                title: "Sold Back",
                text: "The Alchemist buys back her own tincture at a loss.",
                journal: "Sold Vitality Tincture at a loss.",
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Vitality Tincture");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 7; 
                    scenes['alchemist_triage'].stock["Vitality Tincture"] = (scenes['alchemist_triage'].stock["Vitality Tincture"] || 0) + 1;
                    audioManager.playCoins();
                    return "Sold Tincture (+7s).";
                },
            },
            
            // ACT 1: TAVERN SCENES
            'blackwater_tavern': {
				title: "The Blackwater Tavern",
				text: "The interior is dim, smelling of stale brine and fear. Men speak in hushed tones, glancing at the door. This is where the broken come to hide. Rest is costly, but information is sometimes free.",
				journal: "The Blackwater stank of defeat. But Quinn was rightthe walls have ears. I sat in the dark and listened to the dying city breathe.",
				banter: {
					'gareth': "That gambler in the corner... Watch his hands.",
				},
                isRest: true,
                stock: {
                    "Gruel": 5 
                },
                choices: [
                    { text: "Pay for a Cot (Full Rest)", nextScene: 'tavern_rest_success', type: 'action', cost: 10, doomCost: 3 },
                    { text: "Eat Gruel Now", nextScene: 'eat_gruel_instant', type: 'action', cost: 1, doomCost: 0 },
                    { text: "Buy Gruel (To Go)", nextScene: 'buy_gruel_to_go', type: 'action', cost: 1, doomCost: 0 },
                    { 
                        text: "Listen to Engineer's Rumors (Smelter)", 
                        nextScene: 'gather_info_smelter', 
                        type: 'dialogue', 
                        reqNotFlag: 'knowsSmelterSecret',
                        reqNotItem: 'Sword of Valor',
                        doomCost: 1,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Listen to Gravedigger's Warnings (Chapel)", 
                        nextScene: 'gather_info_chapel', 
                        type: 'dialogue', 
                        reqNotFlag: 'knowsChapelSecret',
                        reqNotItem: 'Ring of Brass',
                        doomCost: 1,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Observe the Card Game", 
                        nextScene: 'tavern_gambler', 
                        type: 'action', 
                        reqItem: 'Ring of Brass',
                        reqNotFlag: 'hasObservedGambler',
                        customClass: 'btn-keen-senses',
                        doomCost: 1
                    }, 
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
			'eat_gruel_instant': {
				title: "Gruel Consumed",
				text: "You take a moment to consume the cheap gruel. It settles your stomach, but barely.",
				journal: "I instantly consumed gruel for a small amount of healing.",
				onEnter: (state) => {
					if (state.currentHP >= state.maxHP) {
						state.shillings += 1;
						audioManager.playCoins();
						return "Your natural health is full. (Shilling refunded)";
					}
					
					const healAmount = 2;
					const oldHP = state.currentHP;
					
					state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    
                    if (scenes['blackwater_tavern'].stock["Gruel"] > 0) {
                        scenes['blackwater_tavern'].stock["Gruel"] -= 1;
                    }
					
					return `Ate Gruel. Healed ${state.currentHP - oldHP} HP. Stock decreased.`;
				},
				choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }]
			},
            'buy_gruel_to_go': {
                title: "Gruel To Go",
                text: "The server slides you a small, sealed pouch of dried gruel.",
                journal: "I bought gruel to-go and added it to my inventory.",
                onEnter: (state) => { 
                    state.inventory.push("Gruel"); 
                    scenes['blackwater_tavern'].stock["Gruel"] -= 1;
                    return "Bought Gruel (To Go). Added to Inventory.";
                },
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }]
            },
            'tavern_gambler': {
				title: "Keen Senses at the Table",
				text: "With the Ring's power, you hear itor rather, you don't. The man in the corner has no heartbeat. The cards slide into his sleeve with supernatural grace. He is a corpse playing at life. You confront him.",
				journal: "The Ring showed me a dead man winning a living man's game. The rot in this town goes deeper than the flooded cellars.",
                onEnter: (state) => {
                    state.hasObservedGambler = true;
                    return null;
                },
                choices: [
                    { 
                        text: "Confiscate the Dice (Neutral)", 
                        nextScene: 'tavern_confiscate_dice', 
                        type: 'action', 
                        reqNotItem: "Dead Man's Die",
                        doomCost: 0 
                    },
                    { text: "Blackmail him", nextScene: 'tavern_payout', type: 'action', chaosGain: 3, shillingGain: 10, doomCost: 0 },
                    { text: "Expose him", nextScene: 'tavern_expose_check', type: 'skill', dc: 16, skill: 'Insight', orderGain: 3, doomCost: 0 },
                    { text: "Leave him alone", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }
                ]
            },
            'tavern_confiscate_dice': {
                title: "The Toll for a Cheater",
                text: "You silently relieve the corpse of his loaded bone die. He doesn't move to stop you; he merely smiles, his empty eyes following you to the door. A neutral act that may save your life.",
                journal: "Confiscated a Dead Man's Die from the gambler.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Dead Man's Die")) {
                        state.inventory.push("Dead Man's Die");
                    }
                    return "Found Dead Man's Die.";
                }
            },
            'tavern_payout': {
                title: "A Quiet Exchange",
                text: "The man's eyes flicker to the spectral light of your Ring. He slips a heavy purse into your hand without a word. He's gone before you can count it.",
                journal: "Blackmailed the undead gambler.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    audioManager.playCoins();
                    return "Blackmail Successful. +10 Shillings, Chaos +3.";
                },
            },
            'tavern_expose_check': {
                isLogic: true,
                resolve: (roll) => roll >= 16 ? 'tavern_expose_success' : 'tavern_expose_fail'
            },
            'tavern_expose_success': {
                title: "Justice Served",
                text: "Gareth's clear, authoritative voice rings in your mind. You slam your hand on the table and cite the exact law he broke. The man is forced to return his winnings and flees. Order is restored, and the others buy you a drink.",
                journal: "Exposed the cheater. Gained 3 Order influence.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    return "Exposed Cheater. Order +3.";
                },
            },
            'tavern_expose_fail': {
                title: "Public Scorn",
                text: "You accuse the man, but your words are muddled. The other patrons laugh at you. The cheater remains, simply smiling.",
                journal: "Failed to expose the cheater. Embarrassing.",
                choices: [
                    { text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'tavern_expose_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'tavern_rest_success': {
                title: "A Night's Respite",
                text: "You find an empty cot in the dusty cellar. The gentle sway of your hoisted hammock lulls the bickering crew into a temporary, cohesive silence.",
                journal: "Paid 10 Shillings for a good night's rest. The voices are quiet.",
                isRest: true,
                choices: [
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    if (state.currentHP < state.maxHP) {
                        state.currentHP = state.maxHP;
                    }
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    state.docksWorkCount = 0;
                    return "Paid 10s. HP, Crew Use, and Exhaustion Restored.";
                },
            },
            
            // ACT 1: DOCKS SCENES
            'town_docks': {
                title: "The Rotting Docks",
                text: "The sea is black and restless. The remains of piers stretch into the cold water. Sailors work in silence, hauling heavy crates, trying to ignore the end of the world. You see a shifty-eyed <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smuggler</span> checking his manifest.",
                journal: "The piers were rotting under our feet. The sailors worked with their heads down, terrified. Bones thought the water looked cold enough to kill.",
				banter: {
					'bones': "That water's cold enough to stop a heart. If you're going diving for lost coin, you better have the lungs of a whale.",
					'talon': "Smugglers love false bottoms and hidden knots. Look closer..."
				},
                choices: [
                    { text: "Sell Curious Cargo to Smuggler", nextScene: 'docks_sell_cargo', type: 'action', reqItem: 'Curious Cargo', value: 15, doomCost: 0 },
                    // Ensure defaults are set here
                    { text: "Work the Lines", nextScene: 'docks_work', type: 'action', costHP: 2, chaosGain: 1, shillingGain: 3, doomCost: 1 }, 
                    { 
                        text: "Dive for Sunken Treasure", 
                        nextScene: 'docks_dive_check', 
                        type: 'skill', 
                        dc: 16, 
                        skill: 'Survival',
                        doomCost: 1,
                        reqNotFlag: 'hasDivedTreasure'
                    },
                    { 
                        text: "Search for Smuggler's Drop", 
                        nextScene: 'docks_smuggler_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Perception', 
                        reqItem: 'Ring of Brass',
                        reqNotFlag: 'hasSearchedSmugglerDrop',
                        customClass: 'btn-keen-senses',
                        doomCost: 1
                    }, 
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ],
                onEnter: (state) => {
                    const workBtn = scenes['town_docks'].choices.find(c => c.nextScene === 'docks_work');
                    if (workBtn) {
                        const exhaustion = state.docksWorkCount || 0;
                        workBtn.costHP = 2 + exhaustion;
                    }
                    return null;
                }
            },
            'docks_sell_cargo': {
                title: "Smuggler's Trade",
                text: "The Smuggler nods approvingly at the quality of the cargo. 'Good eye, Mariner. Here's your cut, a little extra for your trouble.'",
                journal: "Sold the Curious Cargo to a Smuggler for a premium.",
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0;
                    state.shillings += 15; 
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+15s) to Smuggler.";
                },
            },
            'docks_work': {
                title: "Hard Labor",
                text: "You haul crates and tie lines until your muscles ache and your hands blister.",
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    const costPaid = 2 + (state.docksWorkCount || 0);
                    state.docksWorkCount = (state.docksWorkCount || 0) + 1;
                    
                    audioManager.playCoins();
                    
                    return `Worked. Earned 3 Shillings. Took ${costPaid} HP (Exhaustion Level ${state.docksWorkCount}). Chaos +1.`;
                },
            },
            'docks_dive_check': {
                isLogic: true,
                resolve: (roll) => roll >= 16 ? 'docks_dive_success' : 'docks_dive_fail'
            },
            'docks_dive_success': {
                title: "The Gilded Chest",
                text: "You hold your breath until your lungs burn, leveraging the dock pilings to dive deep. You surface with a watertight strongbox containing a pouch of gold and gemsenough to buy any artifact the Alchemist sells.",
                journal: "Risked the depths and found high-value treasure.",
                onEnter: (state) => {
                    state.hasDivedTreasure = true;
                    state.shillings += 15; 
                    audioManager.playCoins();
                    return "Found Gems (+15s).";
                },
                choices: [{ text: "Surface", nextScene: 'town_docks', type: 'travel', doomCost: 0 }]
            },
            'docks_dive_fail': {
                title: "The Undertow",
                text: "The current catches you, slamming you against the rotting pilings. You barely make it back to the surface, gasping and empty-handed.",
                journal: "The dive failed. Took damage from the current.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 4);
                    fxManager.flashRed();
                    return "Took 4 Damage.";
                },
                choices: [
                    { text: "Climb Out", nextScene: 'town_docks', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'docks_dive_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'docks_smuggler_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'docks_smuggler_success' : 'docks_smuggler_fail'
            },
            'docks_smuggler_success': {
                title: "Hidden Stash",
                text: "The Ring of Brass magnifies your senses. You catch the faint smell of brine and old metal coming from a pile of nets.",
                journal: "Keen Senses worked. Found a hidden stash.",
                choices: [{ text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    state.hasSearchedSmugglerDrop = true; 
                    
                    const hasCoin = state.inventory.includes("Strange Coin");
                    const hasDraft = state.inventory.includes("Phoenix Draft");
                    const hasHolyWater = state.inventory.includes("Holy Water");

                    if (!hasCoin && !hasDraft) {
                         state.inventory.push("Strange Coin");
                         return "Found a heavy, grime-encrusted Strange Coin hidden in the nets.";
                    }
                    
                    if (!hasHolyWater) {
                        state.inventory.push("Holy Water");
                        return "Found Holy Water!";
                    }
                    
                    return "The stash is empty.";
                }
            },
            'docks_smuggler_fail': {
                title: "Nothing But Wood",
                text: "The search yields nothing but wet splinters. You wasted time.",
                journal: "The search was fruitless.",
                onEnter: (state) => {
                    state.hasSearchedSmugglerDrop = true;
                    return null;
                },
                choices: [
                    { text: "Return to Docks", nextScene: 'town_docks', type: 'travel', doomCost: 0 },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'docks_smuggler_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            
            // ACT 1: TAVERN INFO SCENES
            'gather_info_smelter': {
                title: "Smelter District Tip",
                text: "The exhausted engineer whispers, 'The release valves are rusted shut. Quinn's knowledge won't work unless you know the **counter-clockwise, double-turn** trick. That'll save your life.'",
                journal: "Learned the secret to bypassing the Smelter's Steam Hazard.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    state.knowsSmelterSecret = true;
                    return "New Information Gained (Smelter Path).";
                },
            },
            'gather_info_chapel': {
                title: "Sunken Chapel Tip",
                text: "The pale gravedigger warns you, 'Don't follow the sound; follow the silence. The paths are a maze, but the silent, <span class='text-void'>weeping angel statues</span> mark the safe, true route.'",
                journal: "Learned the safe route through the Sunken Chapel's Fog Maze.",
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel', doomCost: 0 }],
                onEnter: (state) => {
                    state.knowsChapelSecret = true;
                    return "New Information Gained (Chapel Path).";
                },
            },

            // --- ACT 1: FIRE PATH (SMELTER) ---
            'smelter_entry': {
                title: "Smelter District: Steam Vents",
                text: "The path is blocked by a burst steam pipe spitting <span class='text-fire'>magical fire</span>. The main valve is screaming and rusted over. You need to use your abilities or brute force here.",
				journal: "The heat hit me like a hammer. The pipes were screaming. Quinn started shouting about torque and pressure, but Talon just pointed at the walls.",
                banter: {
					'quinn': "That valve isn't jammed; it's pressurized! Use your head, not your muscle!",
					'talon': "Why fight the steam? That massive pipe network runs up the outside wall. It's steep, but if we have a rope, we can make it."
				},
                choices: [
                    {
                        text: "Use Rope to Climb to Upper Catwalk",
                        nextScene: 'smelter_side_rope',
                        type: 'action',
                        reqItem: 'Rope',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Attempt Counter-Clockwise Double-Turn (Secret)", 
                        nextScene: 'smelter_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsSmelterSecret',
                        doomCost: 0,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Channel Absorb Elements (Absorb Heat)", 
                        nextScene: 'smelter_boss_absorb_bridge',
                        type: 'action', 
                        reqSkill: 'Absorb Elements', 
                        doomCost: 0,
                        customClass: 'btn-fire-glow' 
                    },
                    { text: "Analyze & Attempt to Turn Valve", nextScene: 'smelter_roll', type: 'skill', dc: 15, skill: 'Investigation' }
                ]
            },
            'smelter_side_rope': {
                title: "Catwalk Bypass",
                text: "The Rope holds fast. You ascend to the upper catwalk, bypassing the deadly vents.",
                journal: "Used Rope to bypass the vents.",
                choices: [{ text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' }],
                onEnter: (state) => { 
                    state.shillings += 5; 
                    audioManager.playCoins();
                    
                    const hasCoin = state.inventory.includes("Strange Coin");
                    const hasDraft = state.inventory.includes("Phoenix Draft");

                    if (!hasCoin && !hasDraft) {
                        state.inventory.push("Strange Coin");
                        return "Rope consumed. Found a Strange Coin and 5 Shillings!"; 
                    }
                    
                    return "Rope consumed. Found 5 Shillings.";
                },
            },
            'smelter_safe': { 
                title: "Safe Passage", 
                text: "You pass safely.", 
                choices: [{ text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' }]
            },
            'smelter_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'smelter_safe' : 'smelter_damage' },
            'smelter_damage': { 
                title: "Burned", 
                text: "You take a burn running past the valve.", 
                choices: [
                    { text: "Continue to Smelter Antechamber", nextScene: 'smelter_workers', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'smelter_safe', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ],
                onEnter: (state) => { 
					state.currentHP = applyDamage(state.currentHP, 5, 'fire'); 
					fxManager.flashRed();
					return "Took 5 Fire Damage."; 
				},
            },
            'smelter_workers': {
                title: "Smelter District: Trapped Workers",
                text: "You enter the main engine room. A heavy support beam has collapsed, trapping three exhausted workers near the pit. They beg for aid. The structural groans suggest you have <span class='text-danger'>very little time</span>.",
                journal: "I found men pinned by a beam, baking alive. I had to choose between saving them and securing the primary objective.",
				banter: {
					'gareth': "Heave! Put your back into it! A Captain protects his people!"
				},
                choices: [
                    { 
                        text: "Attempt Rescue", 
                        nextScene: 'smelter_save_workers_check', 
                        type: 'skill', 
                        dc: 15, 
                        skill: 'Athletics',
                        orderGain: 5,
						doomCost: 1						
                    },
                    { 
                        text: "Prioritize Containment", 
                        nextScene: 'smelter_containment_success',
                        type: 'travel',
                        chaosGain: 3,
                        doomCost: 0
                    }
                ]
            },
            'smelter_containment_success': {
                title: "Containment Established",
                text: "You slam the heavy blast doors shut, sealing the fireand the workersinside. Their screams are cut short by the roar of the furnaces. It is a cold calculus, but the primary objective is now more secure. You spot a bucket of Industrial Lubricant they dropped outside the door.",
                journal: "I sealed the doors. The workers are gone, but I found Industrial Lubricant. The mission comes first. Chaos +3.",
                choices: [{ text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Industrial Lubricant")) {
                        state.inventory.push("Industrial Lubricant");
                    }
                    state.influence = Math.min(50, state.influence + 3);
                    return "Sacrificed workers for containment. Chaos +3. Found Lubricant.";
                }
            },
            'smelter_save_workers_check': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'smelter_save_workers_success' : 'smelter_save_workers_fail'
            },
            'smelter_save_workers_success': {
                title: "Order Restored",
                text: "You strain every muscle to lift the beam. The workers escape and quickly point to a bucket of Industrial Lubricant on a shelf'If you can't beat the fire, blind the beast!' they shout before fleeing. You take the bucket.",
                journal: "Saved the workers. Gained Order +5 and Industrial Lubricant.",
                choices: [{ text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Industrial Lubricant")) {
                        state.inventory.push("Industrial Lubricant");
                    }
                    state.influence = Math.max(-50, state.influence - 5);
                    return "Found Lubricant. Order +5.";
                },
            },
            'smelter_save_workers_fail': {
                title: "A Vicious Price",
                text: "You strain yourself, but the beam won't budge. The Slag Horror's roar echoes closer. You must abandon them. The crew's anguish deals a psychic blow.",
                journal: "Failed to save the workers. Took psychic damage from the crew's anguish.",
                choices: [
                    { text: "Proceed to Foundry (Boss Fight)", nextScene: 'smelter_stage1_start', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'smelter_save_workers_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ],
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 4, 'psychic');
					fxManager.flashRed();
					return "Took 4 Psychic Damage from the crew's screams.";
				},
            },
            
            // --- BOSS: SLAG ELEMENTAL (FIRE PATH) ---
            'smelter_stage1_start': {
                title: "Boss: Slag Elemental",
                text: "The magma pool erupts. A <span class='text-danger'>Slag Elemental</span> risesa towering construct of molten iron and hate. It roars, spraying liquid fire.<br><br><span class='text-fire'>Warning: Enemy deals Fire Damage. Absorb Elements is highly effective.</span>",
                isBoss: true, 
                choices: [
                    { 
                        text: "Engage the Elemental", 
                        nextScene: 'smelter_combat_loop', 
                        type: 'action', 
                        action: (state) => {
                            initCombat("Slag Elemental", 35, [4, 8]); 
                            state.combat.damageType = 'fire'; 
                            return "Combat Started! The heat is intense.";
                        },
                        doomCost: 0 
                    }
                ]
            },

            'smelter_combat_loop': {
				title: "Battle: Slag Elemental",
				text: "The Elemental surges with heat. If you have <b>Absorb Elements</b>, wait for it to attack to charge your blade.",
				isBoss: true,
				choices: [], 
				onEnter: (state) => {
					const buttons = window.generateCombatChoices(state);
					scenes['smelter_combat_loop'].choices = buttons;
					return null; 
				}
			},

            'smelter_victory_generic': {
                title: "Victory: The Fire Dies",
                text: "The Elemental cools into a statue of twisted slag, then crumbles. In the wreckage of its chest, you find the **Sword of Valor**, untouched by the heat.",
                journal: "Defeated the Slag Elemental. Claimed the Sword of Valor.",
                onEnter: (state) => {
                    // Logic to swap Cutlass for Sword
                    if (state.inventory.includes("Rusted Cutlass")) {
                        const idx = state.inventory.indexOf("Rusted Cutlass");
                        if (idx > -1) state.inventory.splice(idx, 1);
                        addToHistory("Your Rusted Cutlass shattered in the final blow.", 'system');
                    }
                    if (!state.inventory.includes("Sword of Valor")) {
                        state.inventory.push("Sword of Valor");
                    }
                    // Reset combat flags
                    state.isAbsorbCharged = false;
                    return "Acquired Sword of Valor.";
                },
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }]
            },
            

            // --- ACT 1: SHADOW PATH (CHAPEL) ---
            'chapel_entry': {
                title: "Sunken Chapel: The Fog Maze",
                text: "The cemetery is covered in <span class='text-void'>unnatural fog</span>. The paths loop back on themselves, and you cannot see. The silence here is heavy.",
				journal: "The silence of the Chapel was heavy. The fog felt intentional. It wanted me lost.",
                banter: {
					'talon': "The fog moves against the wind. Something is disturbing it.",
					'bones': "You can't fight what you can't see. Light a torch."
				},
                choices: [
                    {
                        text: "Use Torch to Illuminate the Vestry",
                        nextScene: 'chapel_side_torch',
                        type: 'action',
                        reqItem: 'Torch',
                        consume: true,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Follow the Weeping Angel Statues", 
                        nextScene: 'chapel_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsChapelSecret',
                        doomCost: 0,
                        customClass: 'btn-success-glow'
                    },
                    { 
                        text: "Channel Primeval Awareness", 
                        nextScene: 'chapel_primeval_bridge',
                        type: 'action', 
                        reqSkill: 'Primeval Awareness',
                        doomCost: 0,
                        customClass: 'btn-shadow-glow' 
                    },
                    { text: "Attempt to Track Movement", nextScene: 'chapel_roll', type: 'skill', dc: 15, skill: 'Perception' }
                ]
            },
            'chapel_side_torch': {
                title: "A Sudden Brightness",
                text: "The flame crackles, momentarily thinning the black fog. You see a set of stairs leading to an upper levela quick path! On a dry shelf near the top, you find a Pearlescent Mushroom, left to dry.",
                journal: "Used Torch to bypass the fog maze. Found a Pearlescent Mushroom.",
                choices: [{ text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' }],
                onEnter: (state) => { 
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found Pearlescent Mushroom!"; 
                    }
                    return "Torch expended.";
                },
            },
            'chapel_safe': { 
                title: "Found Path", 
                text: "You navigate the fog safely.", 
                choices: [{ text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' }]
            },
            'chapel_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'chapel_safe' : 'chapel_damage' },
            'chapel_damage': { 
                title: "Ambushed", 
                text: "A shadow creature ambushes you.", 
                choices: [
                    { text: "Continue to Vestry Antechamber", nextScene: 'chapel_vestry', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'chapel_safe', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    },
                ]
                ,
                onEnter: (s) => { 
                    s.currentHP = applyDamage(s.currentHP, 6); 
                    fxManager.flashRed();
                    return "Took 6 Shadow Damage."; 
                }, 
            },
            'chapel_vestry': {
                title: "Sunken Chapel: Flooded Vestry",
                text: "The vestry is flooded with black, polluted water. A panicked man is caught in the undertow, struggling to keep his head above the foul tide. He screams for help. The water is necroticEdward's mind screams for him not to touch it.",
                journal: "A man was drowning in the vestry. The water looked necrotic, thick with rot. I had to choose between my duty to the living and the sanctity of the mission.",
				banter: {
					'gareth': "He's going under! You have the strength to pull him out, Edward. Don't let him drown!"
				},
                choices: [
                    { 
                        text: "Attempt Rescue", 
                        nextScene: 'chapel_rescue_check', 
                        type: 'skill', 
                        dc: 14, 
                        skill: 'Athletics',
                        orderGain: 5 
                    },
                    { 
                        text: "Prioritize Containment", 
                        nextScene: 'chapel_ignore_drowning', 
                        type: 'dialogue',
                        chaosGain: 3,
                        doomCost: 0
                    }
                ]
            },
            'chapel_rescue_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'chapel_rescue_success' : 'chapel_rescue_fail'
            },
            'chapel_rescue_success': {
                title: "Mercy's Reward",
                text: "You pull the panicked man from the black water. Gasping, he hands you a small, heavy silver hearta family locket. 'Sell this, please. For my family.'",
                journal: "Saved the man. Gained Order +4 and a Silver Locket.",
                choices: [{ text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Silver Locket")) {
                        state.inventory.push("Silver Locket");
                    }
                    state.influence = Math.max(-50, state.influence - 4);
                    return "Found Silver Locket. Order +4.";
                },
            },
            'chapel_rescue_fail': {
                title: "Overwhelmed",
                text: "The black water and the man's panic are too much. He slips from your grasp and is pulled under. The undertow bruises your legs.",
                journal: "Failed the rescue. Took damage from the undertow.",
                choices: [
                    { text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' },
                    { 
                        text: "Cheat Fate", 
                        nextScene: 'chapel_rescue_success', 
                        type: 'action', 
                        reqItem: "Dead Man's Die", 
                        consume: true,
                        customClass: 'btn-hero'
                    }
                ]
            },
            'chapel_ignore_drowning': {
                title: "Looting the Drowned",
                text: "You ignore the man's screams. He drowns quickly. You search his floating corpse and find only a damp, useless map, but Talon spots something shining behind the altara consecrated bottle of Holy Water, untouched by the black tide.",
                journal: "Ignored the drowning man. Gained Chaos +4 and Holy Water.",
                choices: [{ text: "Proceed to Crypt (Boss Fight)", nextScene: 'chapel_stage1_reveal', type: 'travel' }],
                onEnter: (state) => {
                    if (!state.inventory.includes("Holy Water")) {
                        state.inventory.push("Holy Water");
                    }
                    state.influence = Math.min(50, state.influence + 4);
                    return "Found Holy Water. Chaos +4.";
                },
            },
            
            // --- MULTI-STAGE BOSS FIGHT: DROWNED SPECTRE ---
            'chapel_primeval_bridge': {
                isLogic: true,
                resolve: (roll, state) => {
                    state.isSurpriseRound = true;
                    return 'chapel_stage2_finish';
                }
            },
            
			// --- BOSS: DROWNED SPECTRE (SHADOW PATH) ---
            'chapel_stage1_reveal': {
                title: "Boss: Drowned Spectre",
                text: "The fog coalesces into a hovering, skeletal figure draped in rotting seaweed. The <span class='text-danger'>Drowned Spectre</span> shrieksa sound that tears at your mind.<br><br><span class='text-void'>Warning: High Evasion. Use Primeval Awareness to expose weakness.</span>",
                isBoss: true,
                choices: [
                    { 
                        text: "Engage the Spectre", 
                        nextScene: 'chapel_combat_loop', 
                        type: 'action', 
                        action: (state) => {
                            initCombat("Drowned Spectre", 35, [4, 8]);
                            state.combat.damageType = 'psychic'; 
                            return "Combat Started! The fog thickens.";
                        },
                        doomCost: 0 
                    }
                ]
            },

            'chapel_combat_loop': {
                title: "Battle: Drowned Spectre",
                text: "The Spectre phases in and out of reality. Use <b>Primeval Awareness</b> to mark it (Vulnerable) and land a crushing blow.",
                isBoss: true,
                choices: [],
                onEnter: (state) => {
					const buttons = window.generateCombatChoices(state);
					scenes['chapel_combat_loop'].choices = buttons;
					return null;
				}
            },

            'chapel_victory_generic': {
                title: "Victory: The Fog Lifts",
                text: "The Spectre lets out a final, hollow wail and dissolves. On the stone floor, the **Ring of Brass** spins to a halt, glowing with a soft, warm light.",
                journal: "Banished the Spectre. Claimed the Ring of Brass.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Ring of Brass")) {
                        state.inventory.push("Ring of Brass");
                    }
                    return "Acquired Ring of Brass.";
                },
                choices: [{ text: "Return to Town Square", nextScene: 'town_square', type: 'travel' }]
            },
            
            // --- ACT 1: FINALE SCENES ---
			'ritual_entry_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                    if (state.isRiftCollapse) return 'rift_collapse_punishment';
                    return 'finale_ritual_start';
                }
            },
            'rift_collapse_punishment': {
                title: "The Ruptured Veil",
                text: "You attempt to approach the anchor, but the collapsed Rift has birthed a <span class='text-void'>Void Guardian</span>. A shapeless entity of pure entropy blocks your path. Because the stability was lost, you must fight your way to the circle.",
                journal: "The Rift collapsed. I had to fight a Void Guardian to reach the ritual site.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 6);
                    fxManager.flashRed();
                    return "Rift Penalty: Ambushed by Void Guardian. Took 6 Damage.";
                },
                choices: [
                    { text: "Kill it and Enter the Circle", nextScene: 'finale_ritual_start', type: 'combat', doomCost: 0 }
                ]
            },
			'finale_ritual_start': { 
				title: "The Wolf King's Ritual", 
				text: "The Ring and the Blade flare in your hands, vibrating with a hum that rattles your teeth. The Rift above screams, a violet wound in the sky. To close it, you must become the anchor. You must channel the artifacts until the gateway shatters.<br><br><span class='text-purple-400 italic'>Hold the button to channel the ritual...</span>", 
				isBoss: true, 
				choices: [
					{ 
						text: "Channel the Power", 
						type: 'hold', 
						customClass: 'btn-channel',
						action: () => window.gameFunctions.startDreamscape('act2_transition')
					}
				]
			},

            // --- ACT 2: MANOR ARRIVAL & HUB ---
            'act2_arrival': {
				title: "The Vanishing Manor",
				text: "The world inverts. You stand in the Port of Shadows, but it is a silent, <span class='text-void'>grey echo</span>. Ash falls *upwards* into a void-black sky. The ruins of the Smelter are merely skeletal ghosts in the distance. <br><br>But here, where the muddy town square should be, stands a pristine estate: The <span class='text-spectral'>Vanishing Manor</span>. It exists in the negative space of the world.<br><br>A solitary lamp post stands at the gates. You take the <span class='text-item'>Spectral Lantern</span> from its hook. The cold light reveals your breath, but you aren't breathing airyou are breathing memory.",
				journal: "I stepped sideways into the Ethereal Plane. The Manor was waiting for me. It feels like walking inside a tomb that hasn't been built yet.",
				banter: {
					'gareth': "Steady. The ground here doesn't care if you walk on it or fall through it. Will is gravity here.",
					'quinn': "Fascinating. The architecture... it's a mnemonic device. The building is a physical memory."
				},
				onEnter: (state) => {
					state.act1Started = false;
					state.isRiftCollapse = false;
					state.doomTimer = 0;
					state.quinnLogistics = false;
					
					state.act2Started = true;
					state.isEthereal = true;
					state.tetherTimer = 20;
					
					if (!state.inventory.includes("Spectral Lantern")) {
						state.inventory.push("Spectral Lantern");
					}
					
					const lanternDef = itemRegistry["Spectral Lantern"];
					if (lanternDef && lanternDef.onAcquire) {
						lanternDef.onAcquire(state);
					}

					Object.keys(state.crew).forEach(k => state.crew[k].used = false);

					document.getElementById('tether-display').classList.remove('hidden');
					return "Act 1 Complete. Acquired Spectral Lantern. Tether Unstable.";
				},
				choices: [
					{ text: "Enter the Foyer", nextScene: 'manor_foyer', type: 'travel', tetherCost: 1 }
				]
			},
            'act2_tether_fail': {
                title: "The Ripping Back",
                text: "The silver cord of your consciousness snaps. The Manor dissolves, and the Ethereal Plane violently rejects you, hurling your body and soul back into the Material Plane with the force of a cannonball. You suffer massive psychic trauma and find yourself in the grim port, having lost all progress within the Manor.",
                journal: "My tether broke. I was ripped back to reality, taking heavy psychic damage. Lost all Ethereal progress.",
                onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 8, 'psychic');
					state.act2Started = false;
					state.isEthereal = false;
					state.tetherTimer = 0;
					
					document.body.classList.remove('plane-ethereal');
					fxManager.flashRed();
					return "Tether Failed! Took 8 Psychic DMG. Forcibly Returned to Port Square.";
				},
                choices: [
                    { text: "Wake up gasping (Return to Port Square)", nextScene: 'town_square', type: 'travel', tetherCost: 0 }
                ]
            },
            
            // ACT 2: MANOR EXPLORATION
            'manor_foyer': {
				title: "The Grand Foyer",
				text: "The Manor is a labyrinth of silence. The grand staircase ahead is shattered, its marble steps floating freely in the void. Three arches stand before you, breathing cold mist.<br><br><b>West:</b> <span class='text-item'>The Warden's Library</span> (Archives)<br><b>East:</b> The Service Wing (Kitchens)<br><b>North:</b> The Grand Hall (Patrolled)",
				journal: "The Foyer is the hub. The stairs are broken. I have to find another way up.",
				banter: {
					'talon': "I hear ticking to the North. Metal on stone. Heavy patrols.",
					'bones': "There's a smell of ozone coming from the West. Old magic."
				},
				choices: [
					{ text: "Enter Library", nextScene: 'manor_library', type: 'travel', tetherCost: 1 },
					{ text: "Enter Kitchens", nextScene: 'manor_kitchens', type: 'travel', tetherCost: 1 },
					{ text: "Enter Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 },
					{ text: "Check Blueprint", nextScene: 'manor_map_view', type: 'map_view', reqItem: 'Manor Blueprint', tetherCost: 0 } 
				]
			},
            'manor_map_view': {
                title: "Architect's Blueprint",
                text: "The ink glows, showing the layout:<br><b>[West] Library</b> <-> <b>[East] Kitchens</b> (Connected via Crawlspace)<br><b>[North] Grand Hall</b> (Blocked by Patrols)<br><b>Secret Route:</b> Library -> Hall (Shortcut)",
                onEnter: (state) => {
                    if (!state.returnSceneId) {
                        state.returnSceneId = 'manor_foyer'; 
                    }
                    document.body.classList.add('map-active');
                    return null;
                },
                choices: [
                    { 
                        text: "Close Blueprint", 
                        type: 'action', 
                        action: (state) => {
                            document.body.classList.remove('map-active');
                            const nextScene = state.returnSceneId || 'manor_foyer'; 
                            state.returnSceneId = null; 
                            renderScene(nextScene); 
                        },
                        tetherCost: 0 
                    }
                ]
            },
            
            // ACT 2: WEST WING (LIBRARY)
            'manor_library': {
				title: "The Warden's Library",
				text: "Books float freely here, drifting like jellyfish in the spectral currents. Scrolls unfurl and rewrite themselves. A draft comes from a low grate near the floor, suggesting a <span class='text-item'>ventilation shaft</span> connecting to the East Wing.",
				journal: "The Library is alive with information. Quinn is practically vibrating.",
				banter: {
					'quinn': "Look at this! The classification system is multidimensional. I can decipher the location of the Anchor if you give me a moment. (History Check)",
					'talon': "Forget the books. That vent near the floor... it bypasses the patrols."
				},
				choices: [
					{ 
						text: "Decipher Archives", 
						nextScene: 'library_search_logic', 
						type: 'skill', 
						skill: 'History', 
						dc: 12,
						tetherCost: 1,
						reqNotItem: 'Manor Blueprint'
					},
					{ 
						text: "Open Secret Passage", 
						nextScene: 'manor_servants_passage', 
						type: 'travel', 
						reqItem: 'Manor Blueprint',
						tetherCost: 0,
						customClass: 'btn-success-glow'
					},
					{ text: "Enter Crawlspace", nextScene: 'manor_crawlspace', type: 'travel', tetherCost: 1 },
					{ text: "Return to Foyer", nextScene: 'manor_foyer', type: 'travel', tetherCost: 1 },
					{ text: "Check Blueprint", nextScene: 'manor_map_view', type: 'map_view', reqItem: 'Manor Blueprint', tetherCost: 0 }
				]
			},
            'library_search_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                    return roll >= 12 ? 'library_success' : 'library_fail';
                }
            },
            'library_success': {
                title: "The Blueprint Found",
                text: "Quinn identifies the master document. It marks 'The Anchor' behind the Grand Hall and reveals a hidden servant's passage behind the bookcase.",
                journal: "Found the Manor Blueprint. Revealed the Servant's Passage.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Manor Blueprint")) {
                        state.inventory.push("Manor Blueprint");
                        return "Found: Manor Blueprint.";
                    }
                    return null;
                },
                choices: [
                    { text: "Check Blueprint Now (Map)", nextScene: 'manor_map_view', type: 'travel', tetherCost: 0 },
                    { text: "Return to Library", nextScene: 'manor_library', type: 'travel', tetherCost: 0 }
                ]
            },
            'library_fail': {
                title: "Lost Focus",
                text: "The schematics are too complex. You cannot decipher the layout.",
                choices: [{ text: "Return to Library", nextScene: 'manor_library', type: 'travel', tetherCost: 0 }]
            },
            'manor_servants_passage': {
                title: "The Servant's Passage",
                text: "Guided by the Blueprint, you slide a bookshelf aside. A dusty, narrow tunnel bypasses the dangerous open spaces of the Manor, leading directly to the Grand Hall.",
                journal: "Used the Blueprint to find a shortcut. Saved time.",
                choices: [
                    { text: "Emerge into Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 0 }
                ]
            },
            
            // ACT 2: INTERCONNECT (CRAWLSPACE & CUB)
            'manor_crawlspace': {
				title: "The Service Crawlspace",
				text: "You are crawling inside the veins of the house. It is tight, dark, and smells of spectral rats. You hear a high-pitched, vibrating purr coming from a side vent. Something is alive in here.",
				journal: "Crawling in the walls. Heard a sound. Not a rat. Something... shifting.",
				banter: {
					'bones': "That's not a monster. It sounds hurt. And hungry.",
					'talon': "Careful. Even small things bite when cornered."
				},
				choices: [
					{ 
						text: "Investigate Sound", 
						nextScene: 'cub_encounter', 
						type: 'travel', 
						reqNotFlag: 'hasBlinkSkill',
						tetherCost: 1 
					},
					{ text: "Crawl to Library", nextScene: 'manor_library', type: 'travel', tetherCost: 1 },
					{ text: "Crawl to Kitchens", nextScene: 'manor_kitchens', type: 'travel', tetherCost: 1 }
				]
			},
            'cub_encounter': {
				title: "The Displacer Cub",
				text: "Huddled in the corner is a kitten-sized <span class='text-void'>Displacer Cub</span>. It hisses, flickering in and out of existence, terrified. It is starving. It seems to be phasing uncontrollably because it lacks the energy to anchor itself.",
				journal: "Found a Displacer Cub. It's phasing out of reality from starvation.",
				banter: {
					'bones': "It's fading, Edward! It needs food to ground itself, or it will dissolve into the ether. Do we have anything organic? (Nature Check)"
				},
				choices: [
					{ 
						text: "Feed & Soothe", 
						nextScene: 'cub_tame_check', 
						type: 'skill', 
						dc: 12, 
						skill: 'Nature', 
						tetherCost: 1
					},
					{ text: "Leave it be", nextScene: 'manor_crawlspace', type: 'travel', tetherCost: 0 }
				]
			},
            'cub_tame_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    let dc = state.lastDC;
                    if(state.inventory.includes('Gruel')) {
                        dc = Math.max(5, dc - 3);
                        addToHistory(`DC reduced by 3 (Gruel). New DC: ${dc}`, 'roll');
                        const idx = state.inventory.indexOf("Gruel");
                        if (idx > -1) state.inventory.splice(idx, 1);
                        addToHistory(`Gruel used and discarded.`, 'system');
                    } else if (state.inventory.includes('Rum')) {
                         dc = Math.max(5, dc - 5);
                         addToHistory(`DC reduced by 5 (Rum). New DC: ${dc}`, 'roll');
                         const idx = state.inventory.indexOf("Rum");
                         if (idx > -1) state.inventory.splice(idx, 1);
                         addToHistory(`Rum used and discarded.`, 'system');
                    }
                    
                    return roll >= dc ? 'cub_tame_success' : 'cub_tame_fail';
                }
            },
            'cub_tame_success': {
                title: "The Cub's Gift",
                text: "You offer food and a steady hand. The cub eats effectively, stabilizing its phasing. It looks at you with deep, violet eyes, then headbutts your hand. <br><br>For a moment, your soul syncs with its frequency. You understand the geometry of the <span class='text-spectral'>Blink</span>a reflexive, planar hop.",
                journal: "Saved the cub. Learned the Blink skill. The cub blinked away into the ether.",
                onEnter: (state) => {
                    state.companions.blink.joined = true;
                    state.hasBlinkSkill = true;
                    return "Companion Gained: Blink.";
                },
                choices: [
                    { text: "Return to Crawlspace", nextScene: 'manor_crawlspace', type: 'travel', tetherCost: 0 }
                ]
            },
            'cub_tame_fail': {
                title: "A Sharp Bite",
                text: "The starving cub mistakes your hand for prey. It bites you, then dissolves into the shadows, leaving you bleeding and alone.",
                journal: "Failed to tame the cub. Took damage and it fled.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 3);
                    fxManager.flashRed();
                    return "Took 3 Damage. Cub fled.";
                },
                choices: [
                    { text: "Return to Crawlspace", nextScene: 'manor_crawlspace', type: 'travel', tetherCost: 1 }
                ]
            },

            // ACT 2: EAST WING (KITCHENS & BALLROOM)
            'manor_kitchens': {
				title: "The Ghost Kitchens",
				text: "Spectral fires roar in cold hearths. Ghostly chefs prepare feasts that rot the instant they are plated. The smell is intoxicating and nauseating all at once. A heavy oak door leads East to the Ballroom.",
				journal: "The Kitchens mimic life, but offer none. Found a mushroom that looked real enough.",
				banter: {
					'bones': "Don't eat the food on the tables. It's glamour. It'll turn to ash in your gut. But... that mushroom in the corner is real.",
					'gareth': "Focus. We aren't here to eat. The Ballroom is ahead."
				},
				onEnter: (state) => {
					if (!state.inventory.includes("Pearlescent Mushroom")) {
							state.inventory.push("Pearlescent Mushroom");
							return "Found a dried Pearlescent Mushroom near the hearth.";
					}
					return null;
				},
				choices: [
					{ text: "Push to Ballroom", nextScene: 'manor_ballroom_encounter', type: 'travel', tetherCost: 1 },
					{ text: "Enter Crawlspace", nextScene: 'manor_crawlspace', type: 'travel', tetherCost: 1 },
					{ text: "Return to Foyer", nextScene: 'manor_foyer', type: 'travel', tetherCost: 1 }
				]
			},
            'manor_ballroom_encounter': {
				title: "The Phase Hunter",
				text: "The air shimmers. A massive, six-legged panther materializes, then shifts two feet to the left. A <span class='text-danger'>Displacer Beast</span>. It hunts not with eyes, but with planar vibration. It blocks the path to the Hall.",
				journal: "Ran into a Displacer Beast in the Ballroom. It's flickering like a broken image.",
				isBoss: true,
				banter: {
					'talon': "It tracks movement in the ether! Stop moving linearly. Or use the artifacts to pin it down!",
					'gareth': "Stand your ground! If you run, it strikes!"
				},
				choices: [
					{ 
						text: "Command Blink: Distract", 
						nextScene: 'beast_blink_distract',
						type: 'action', 
						reqFlag: 'hasBlinkSkill',
						customClass: 'spectral-active',
						tetherCost: 1
					},
					{ 
						text: "See True Form", 
						nextScene: 'beast_true_sight', 
						type: 'action', 
						reqItems: ['Ring of Brass', 'Salt-Warped Spyglass'],
						customClass: 'btn-keen-senses' 
					},
					{ 
						text: "Track Distortion", 
						nextScene: 'beast_track_logic', 
						type: 'skill', 
						dc: 17,
						skill: 'Perception',
						tetherCost: 1 
					},
					{ text: "Retreat to Kitchens", nextScene: 'manor_kitchens', type: 'travel', tetherCost: 2 }
				]
			},
			'manor_ballroom_safe': {
					title: "The Dueling Circle",
					text: "Gareth has cleared the center of the room. He paces, cutlass drawn, cutting the air with precise, angry strokes. 'The enemy doesn't rest, Mariner. Neither should we. Draw your blade.'",
					choices: [
						{ 
							text: "Spar with Gareth", 
							nextScene: 'gareth_spar_logic', 
							type: 'skill', 
							skill: 'Insight', 
							dc: 15,
							reqNotFlag: 'battleRhythm', // Buff lasts until used
							customClass: 'btn-hero'
						},
						{ text: "Return to Hall", nextScene: 'manor_hall_safe', type: 'travel', doomCost: 0 }
					]
				},
				'gareth_spar_logic': {
					isLogic: true,
					resolve: (roll, state) => {
						return roll >= 15 ? 'gareth_spar_success' : 'gareth_spar_fail';
					}
				},
				'gareth_spar_success': {
					title: "Battle Rhythm",
					text: "Steel rings against steel. Gareth is fast, but you anticipate his feint, catching his blade in a bind. He grins fiercely. 'Good. You see the tempo now. Don't lose it.'",
					onEnter: (state) => {
						if (!state.inventory.includes("Battle Rhythm")) state.inventory.push("Battle Rhythm"); 
						state.battleRhythm = true; 
						return "Gained Status: Battle Rhythm (Next attack 2x Damage).";
					},
					choices: [{ text: "Sheathe Blade", nextScene: 'manor_ballroom_safe', type: 'travel' }]
				},
				'gareth_spar_fail': {
					title: "Too Slow",
					text: "Gareth disarms you with a brutal pommel strike. 'Dead. You'd be dead. Again.'",
					onEnter: (state) => {
						state.currentHP = Math.max(1, state.currentHP - 1);
						return "Sparring Accident. Took 1 Damage.";
					},
					choices: [{ text: "Get Up", nextScene: 'manor_ballroom_safe', type: 'travel' }]
				},
			'beast_blink_distract': {
				title: "A Game of Shadows",
				text: "You whistle sharply. Blink phases out of your pack, appearing behind the massive Displacer Beast. He chirpsa sound that cuts through the ether. The beast spins around, confused by the familiar planar signature. <br><br>While the mother is distracted by the cub, you slip past into the shadows of the Hall. Blink rejoins you moments later, vibrating with adrenaline.",
				journal: "Blink distracted the Displacer Beast. We slipped past unharmed.",
				choices: [{ text: "Enter Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 0 }]
			},
            'beast_true_sight': {
                title: "The Illusion Breaks",
                text: "Using the planar artifact, you see the beast's true location clearly. One precise strike sends it dissolving back into the ether, leaving only a shimmer of its passing.",
                journal: "Used magical sight to defeat the Displacer Beast.",
                onEnter: (state) => {
                    const usedItem = state.inventory.includes('Ring of Brass') ? 'Ring of Brass' : 'Salt-Warped Spyglass';
                    return `Used ${usedItem} to locate the true form. Beast Banished.`;
                },
                choices: [{ text: "Enter Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 0 }]
            },
            'beast_track_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 17 ? 'beast_true_sight' : 'beast_fail'
            },
            'beast_fail': {
                title: "Claws from Nowhere",
                text: "You strike at the image, hitting nothing but air. The real beast rakes your back with its tentacles from the shadows.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 8);
                    fxManager.flashRed();
                    return "Took 8 Damage.";
                },
                choices: [
                    { text: "Stumble into Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 },
                    { text: "Retreat to Kitchens", nextScene: 'manor_kitchens', type: 'travel', tetherCost: 2 }
                ]
            },
            
            // ACT 2: GRAND HALL & MIMIC
            'manor_hall': {
				title: "The Grand Hall",
				text: "All paths converge here. The Hall is massive and cold. Patrols of <span class='text-danger'>Brass Automatons</span> phase through the walls, their clockwork ticking echoing like gunshots. At the far end, a dizzying, spiraling <span class='text-spectral'>Penrose Staircase</span> ascends into the dark.",
				journal: "The Grand Hall. Covered in clockwork guards. The exit is a staircase that shouldn't exist.",
				banter: {
					'talon': "That chest in the corner... it's breathing. Don't touch it. (Perception Check)",
					'quinn': "The automatons run on a predictable loop. We can bypass them if we move precisely."
				},
				choices: [
					{ text: "Search for traps", nextScene: 'manor_hall_check', type: 'skill', dc: 15, skill: 'Perception', tetherCost: 1, reqNotFlag: 'hallLooted' },
					{ text: "Approach Staircase", nextScene: 'manor_automaton_encounter', type: 'travel', tetherCost: 1 },
					{ text: "Return to Foyer", nextScene: 'manor_foyer', type: 'travel', tetherCost: 1 },
					{ text: "Enter Ballroom", nextScene: 'manor_ballroom_encounter', type: 'travel', tetherCost: 1 }, 
					{ text: "Check Blueprint", nextScene: 'manor_map_view', type: 'map_view', reqItem: 'Manor Blueprint', tetherCost: 0 }
				]
			},
            'manor_hall_check': {
				isLogic: true,
				resolve: (roll) => roll >= 15 ? 'manor_mimic_reveal' : 'manor_mimic_trap'
			},
			'manor_mimic_reveal': {
				title: "The Breathing Chest",
				text: "Talon grabs your wrist just as you reach for the ornate chest. 'Look closely,' he hisses. 'The wood grain... it's pulsing.' The chest is a <span class='text-danger'>Mimic</span>, waiting for a meal.",
				journal: "Talon spotted a Mimic before I touched it.",
				choices: [
					{ 
						text: "Strike First (Surprise Attack)", 
						nextScene: 'manor_mimic_victory', 
						type: 'combat',
						customClass: 'btn-hero'
					},
					{ text: "Leave it alone", nextScene: 'manor_hall', type: 'travel', tetherCost: 0 }
				]
			},
			'manor_mimic_trap': {
				title: "The Maw",
				text: "You lift the lid, and the lid bites back. Serrated wood-teeth clamp onto your arm. The <span class='text-danger'>Mimic</span> screeches, its pseudopods thrashing.",
				journal: "I triggered a Mimic trap. It bit deep.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 6);
					fxManager.flashRed();
					return "Ambushed! Took 6 Damage.";
				},
				choices: [
					{ 
						text: "Kill it (Combat)", 
						nextScene: 'manor_mimic_victory_combat', 
						type: 'combat',
						doomCost: 0 
					}
				]
			},
			'manor_mimic_victory': {
				title: "Splintered Wood",
				text: "You shatter the creature's carapace before it can react. Amidst the purple gore and splinters, you find the creature's stomach contents: undigested gold.",
				journal: "Killed the Mimic. Looted the gold.",
				onEnter: (state) => {
					state.hallLooted = true; 
					state.shillings += 20;
					audioManager.playCoins();
					if (!state.inventory.includes("Mimic's Bile")) {
						state.inventory.push("Mimic's Bile");
						return "Mimic Defeated. Found 20 Shillings and Mimic's Bile.";
					}
					return "Mimic Defeated. Found 20 Shillings.";
				},
				choices: [{ text: "Return to Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 }]
			},
			'manor_mimic_victory_combat': {
				title: "Wood and Blood",
				text: "You hack the creature apart, but not before it thrashes wildly, bruising your ribs. It dissolves into sludge, leaving behind a pile of coins.",
				journal: "Survived the Mimic fight.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 4);
					state.hallLooted = true; 
					state.shillings += 20; 
					audioManager.playCoins();
					fxManager.flashRed();
					if (!state.inventory.includes("Mimic's Bile")) {
						state.inventory.push("Mimic's Bile");
						return "Mimic Dead. Took 4 DMG. Found 20 Shillings and Mimic's Bile.";
					}
					return "Mimic Dead. Took 4 DMG. Found 20 Shillings.";
				},
				choices: [{ text: "Return to Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 }]
			},
            
            // ACT 2: BRASS SENTINEL & FINALE STAIRS
            'manor_automaton_encounter': {
				title: "The Brass Sentinel",
				text: "A <span class='text-danger'>Brass Sentinel</span> blocks the path. Eight feet of clockwork perfection, wielding a lightning-wreathed glaive. It doesn't breathe. It doesn't blink. It waits.",
				isBoss: true,
				banter: {
					'quinn': "It has a gyroscopic stabilizer on its hip! Knock that off axis and it falls! (Investigation Check)",
					'gareth': "It's just metal! Hit it until it stops moving! (Athletics Check)"
				},
				choices: [
					{ 
						text: "Sunder Armor", 
						nextScene: 'automaton_sunder_logic', 
						type: 'skill', 
						skill: 'Athletics',
						dc: 15,
						reqItem: 'Sword of Valor',
						customClass: 'btn-hero' 
					},
					{ 
						text: "Command Blink: Phase Shift", 
						nextScene: 'automaton_blink_bypass',
						type: 'action', 
						reqFlag: 'hasBlinkSkill', 
						customClass: 'spectral-active',
						tetherCost: 1
					},
					{ 
						text: "Target Stabilizer", 
						nextScene: 'automaton_logic_check', 
						type: 'skill', 
						dc: 16,
						skill: 'Investigation', 
						tetherCost: 1 
					},
					{
						text: "Brute Force",
						nextScene: 'automaton_brute_force',
						type: 'action',
                        action: (state) => {
                             initCombat("Brass Sentinel", 40, [6, 10]);
                             return "Engaging Sentinel.";
                        },
						doomCost: 0
					}
				]
			},
            'automaton_sunder_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'automaton_victory_sword' : 'automaton_sunder_fail'
            },
            'automaton_sunder_fail': {
                title: "Parried",
                text: "You swing the Sword of Valor with all your might, but the Sentinel reads the arc perfectly. It catches your blade on its glaive haft and kicks you back with hydraulic force.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 6);
                    fxManager.flashRed();
                    return "Sunder Failed. Took 6 Damage.";
                },
                choices: [
                    { text: "Recover and Engage", nextScene: 'manor_automaton_encounter', type: 'travel', tetherCost: 1 } 
                ]
            },
			'automaton_blink_bypass': {
				title: "Phase Shift",
				text: "You grab Blink's fur. The cub activates his displacement field, extending it to you. For a split second, you exist everywhere and nowhere. The Sentinel's glaive passes harmlessly through your chest as you materialize behind it.",
				journal: "Blink phased us through the Automaton's attack.",
				choices: [{ text: "Ascend the Staircase", nextScene: 'manor_staircase', type: 'travel', tetherCost: 0 }]
			},
			'automaton_brute_force': {
				title: "Metal on Bone",
				text: "You lack the finesse to disable it, so you simply charge. The glaive cuts deep, searing your flesh with lightning, but you shoulder-check the machine into the wall, breaking its gyroscope. It falls, twitching.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 10);
					fxManager.flashRed();
					return "Automaton Destroyed. Took 10 Damage.";
				},
				choices: [{ text: "Ascend the Staircase", nextScene: 'manor_staircase', type: 'travel', tetherCost: 0 }]
			},
            'automaton_logic_check': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'automaton_disable_success' : 'automaton_disable_fail'
            },
            'automaton_victory_sword': {
                title: "Scrap Metal",
                text: "The Sword of Valor shears through the brass casing like paper. The Sentinel collapses in a heap of sparks and gears. The path to the stairs is clear.",
                journal: "Destroyed the Automaton with the Sword of Valor.",
                onEnter: (state) => {
                    state.hallLooted = true;
                    audioManager.playClash();
                    return "Automaton Defeated.";
                },
                choices: [{ text: "Approach Penrose Staircase", nextScene: 'manor_staircase', type: 'travel', tetherCost: 0 }]
            },
            'automaton_disable_success': {
                title: "System Failure",
                text: "Quinn identifies the exposed timing belt. A precise strike with your hilt jams the mechanism. The Sentinel freezes mid-swing.",
                journal: "Successfully jammed the Brass Sentinel.",
                choices: [{ text: "Approach Penrose Staircase", nextScene: 'manor_staircase', type: 'travel', tetherCost: 0 }]
            },
            'automaton_disable_fail': {
                title: "Glaive Strike",
                text: "You miss the timing window. The glaive catches you in the ribs, throwing you back down the hall.",
                journal: "Failed to disable the Automaton. Took damage.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 6);
                    fxManager.flashRed();
                    return "Took 6 Damage.";
                },
                choices: [{ text: "Recover in Grand Hall", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 }]
            },
            
            // ACT 2: FINALE SEQUENCE
            'manor_staircase': {
				title: "The Penrose Staircase",
				text: "You step onto the stairs. Looking up, you see the bottom of the staircase directly above you. It loops infinitely. Gravity shifts uncomfortably. Without a guide, your mind will break before you find the top.",
				journal: "The stairs are a trap. A mathematical impossibility.",
				banter: {
					'quinn': "This is non-euclidean geometry! Logic doesn't apply here! Wait... I can see the pattern if I squint... (Investigation Check)",
					'gareth': "Don't look up! Just climb!"
				},
				choices: [
					{ 
						text: "Follow Blueprint", 
						nextScene: 'manor_anchor_door', 
						type: 'action', 
						reqItem: 'Manor Blueprint',
						tetherCost: 1,
						customClass: 'btn-success-glow'
					},
					{ text: "Analyze Geometry", nextScene: 'staircase_logic', type: 'skill', dc: 16, skill: 'Investigation', tetherCost: 1 },
					{ text: "Give Up", nextScene: 'manor_hall', type: 'travel', tetherCost: 1 }
				]
			},
            'staircase_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 16 ? 'manor_anchor_door' : 'staircase_fail'
            },
            'staircase_fail': {
                title: "Lost in Geometry",
                text: "You climb for hoursor maybe seconds. You vomit from the vertigo and find yourself back at the bottom. The Tether weakens.",
                onEnter: (state) => {
                    state.tetherTimer = Math.max(0, state.tetherTimer - 2);
                    state.currentHP = applyDamage(state.currentHP, 2);
                    return "Lost in the loop. -2 Additional Turns. Took 2 Damage.";
                },
                choices: [{ text: "Try Again", nextScene: 'manor_staircase', type: 'travel', tetherCost: 1 }]
            },
            'manor_anchor_door': {
                title: "The Anchor's Threshold",
                text: "You step onto the final platform. A massive door pulsing with violet light stands before you. This is the heart of the anomaly, the manor's planar anchor. The Wolf King's ritual is finally within reach. <br><br><span class='text-purple-400 italic'>Hold the button to channel the ritual...</span>",
                choices: [
                    { text: "Perform Binding Ritual", nextScene: 'act2_finale_resolution', type: 'hold', customClass: 'btn-channel', tetherCost: 0 }
                ]
            },
            'act2_finale_resolution': {
                title: "The World Restored",
                text: "You plant the Sword of Valor into the spectral anchor. The Ring of Brass flares, binding the energies. The Vanishing Manor implodes into a singularity of white light.<br><br>While you were in the Ethereal, your <span class='text-item'>Compass</span> spun wildly, drunk on the infinite directions of the void. But as the weight of the Ethereal lifts and you fall back into the salt spray of the material ocean, the needle slams to a halt. It locks onto a single, unwavering heading deep in the open sea.",
                journal: "Closed the Rift. The Compass has stopped spinning and locked onto a new target.",
                choices: [
					{ 
						text: "Wake up at Sea (Begin Act 3)", 
						type: 'action',
						action: () => window.gameFunctions.startDreamscape('act3_transition')
					}
				]
            },

			// ACT 2: SPECTRAL FORGE
			'manor_forge': {
				title: "The Spectral Forge",
				text: "The Manor Kitchen hearth burns with a ghostly violet flame, powered by residual planar energy. This cold fire fuses matter with memorythe perfect place to customize your gear. You examine the cold stone table.",
				choices: [
					{ text: "View Combination Recipes", nextScene: 'manor_forge_combine', type: 'dialogue', customClass: 'btn-pulse' },
					{ text: "Exit Kitchen", nextScene: 'manor_kitchens', type: 'travel' }
				]
			},
			'manor_forge_combine': {
				title: "Item Combiner: Recipes",
				text: "Select an available recipe to fuse two items into one powerful artifact. Note: Combining items consumes the original components.",
				choices: [
				{
						text: "Sun-Star Grenade (Flash Powder + Alchemical Fire)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Flash Powder", "Alchemical Fire"],
						customClass: 'btn-fire-glow',
						onSelect: (state) => {
							return combineItems("Flash Powder", "Alchemical Fire", "Sun-Star Grenade");
						}
					},
					{
						text: "Captain's Reserve (Rum + Vitality Tincture)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Rum", "Vitality Tincture"],
						customClass: 'btn-success-glow',
						onSelect: (state) => {
							return combineItems("Rum", "Vitality Tincture", "Captain's Reserve");
						}
					},
					{
						text: "Snare Trap (Rope + Beast Whistle)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Rope", "Beast Whistle"],
						customClass: 'btn-keen-senses',
						onSelect: (state) => {
							return combineItems("Rope", "Beast Whistle", "Snare Trap");
						}
					},
					{
						text: "Stabilize Mutagen (Volatile Mutagen + Vitality Tincture)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Volatile Mutagen", "Vitality Tincture"],
						customClass: 'btn-success-glow',
						onSelect: (state) => {
							return combineItems("Volatile Mutagen", "Vitality Tincture", "Stabilized Mutagen");
						}
					},
					{
						text: "Mind-Expanding Grog (Rum + Pearlescent Mushroom)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Rum", "Pearlescent Mushroom"],
						customClass: 'btn-success-glow',
						onSelect: (state) => {
							return combineItems("Rum", "Pearlescent Mushroom", "Mind-Expanding Grog");
						}
					},
					{
						text: "Acid-Etched Sword (Sword of Valor + Mimic's Bile)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Sword of Valor", "Mimic's Bile"],
						customClass: 'btn-fire-glow',
						onSelect: (state) => {
							return combineItems("Sword of Valor", "Mimic's Bile", "Acid-Etched Sword of Valor");
						}
					},
					{
						text: "Radiant-Washed Sword (Sword of Valor + Holy Water)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Sword of Valor", "Holy Water"],
						customClass: 'btn-hero',
						onSelect: (state) => {
							return combineItems("Sword of Valor", "Holy Water", "Radiant-Washed Sword of Valor");
						}
					},
					{
						text: "The Warding Ember (Spectral Lantern + Alchemical Fire)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Spectral Lantern", "Alchemical Fire"],
						customClass: 'btn-lantern-glow',
						onSelect: (state) => {
							return combineItems("Spectral Lantern", "Alchemical Fire", "The Warding Ember");
						}
					},
					{
						text: "Deep-Forged Cutlass (Sword of Valor + Deep-Iron Ingot)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Sword of Valor", "Deep-Iron Ingot"],
						customClass: 'btn-hero',
						onSelect: (state) => {
							return combineItems("Sword of Valor", "Deep-Iron Ingot", "Deep-Forged Cutlass");
						}
					},
					{
						text: "Grapple Hook (Rope + Brass Gears)",
						nextScene: 'manor_forge',
						type: 'combine',
						reqItems: ["Rope", "Brass Gears"],
						customClass: 'btn-keen-senses',
						onSelect: (state) => {
							return combineItems("Rope", "Brass Gears", "Grapple Hook");
						}
					},
					{ text: "Back to the Forge", nextScene: 'manor_forge', type: 'travel', doomCost: 0 }
				],
			},
            
            // --- ACT 3: OPEN SEA TRAVEL ---
            'act3_name_ship': {
                title: "A New Vessel",
                text: `Weeks have passed since the Rift sealed. You found a battered, but seaworthy, smuggling ketch on the docks. It is ugly, scarred, and sturdyperfect for a crew of the damned.<br><br>Quinn stands ready with a fresh page in the Log. "She's ours now, Captain," he says, quill poised. "But a ship without a name is bad luck. What do we call her?"<br><br>
                <div class="mt-4 relative">
                    <input type="text" id="ship-name-input" placeholder="The Iron Lung" autocomplete="off" maxlength="30" 
                    class="w-full bg-gray-900 border border-amber-700/50 p-3 rounded text-amber-500 cinzel font-bold text-lg focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 shadow-inner placeholder-gray-700">
                </div>`,
				onEnter: (state) => {
                    state.act2Started = false; 
                    state.tetherTimer = 0;
                    state.isEthereal = false;
                    document.body.classList.remove('plane-ethereal');
                    
                    state.currentHP = state.maxHP;
                    
                    if (!state.skills.includes("Plane Walking")) {
                        state.skills.push("Plane Walking"); 
                    }

                    return "Time Skip: HP Restored. Mastered 'Plane Walking' skill.";
                },
                choices: [
                    {
                        text: "Christen the Ship",
                        type: 'action',
                        action: (state) => {
						const input = document.getElementById('ship-name-input');
						let name = "";
						
						if (input && input.value) {
							name = input.value.trim();
						}
						
						if (!name) name = "The Iron Lung"; 
						
						state.shipName = name; 
						renderScene('act3_intro_ship'); 
						return `Christened the ship: <span class="text-item">${name}</span>.`;
					}
                    }
                ]
            },
            'act3_intro_ship': {
                title: "The Ship",
                text: `Quinn blows on the wet ink of the logbook. '<b><span class="text-item">[SHIP_NAME]</span></b>,' he reads aloud. 'A fine name.'<br><br>He announces, 'We're running low on supplies already.' A new world awaits beyond the fog line.`,
                journal: `Act 3 started. Acquired the ship.`,
                onEnter: (state) => {
                    state.act3Started = true;
                    state.act2Started = false; 
                    state.isEthereal = false;
                    state.unlocked_dogtooth = true; 
                    
                    document.body.classList.remove('plane-ethereal');
                    return `Act 3 Commencing. Ship acquired. Bleak Dogtooth coordinates charted.`;
                },
                choices: [
                    { text: "Check the Map", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
                ]
            },
            'port_provisioner': {
                title: "The Harbor Provisioner",
                text: "The Quartermaster unrolls a map of the new coastline. 'The Leviathan's wake changed everything. The Sanguine Court is moving openly.'<br><br>He looks at you closely. 'You need allies, Captain. But the Bastion and the Drift don't mix. Once you fly a flag, you fly it for good.'",
                onEnter: (state) => {
                    // 1. IF ALREADY ALIGNED, SHOW ONLY THAT HUB
                    if (state.factionAligned === 'order') {
                        if (!state.knownIslands.includes('hub_order')) state.knownIslands.push('hub_order');
                        return "Map Updated: Route to The Argent Bastion (Order HQ) available.";
                    }
                    if (state.factionAligned === 'chaos') {
                        if (!state.knownIslands.includes('hub_chaos')) state.knownIslands.push('hub_chaos');
                        return "Map Updated: Route to The Dead-Water Drift (Chaos HQ) available.";
                    }

                    // 2. IF NOT ALIGNED, CHECK THRESHOLDS & LOCK IN
                    // Threshold is +/- 10. Once met, it sets factionAligned permanently.
                    if (state.influence <= -10) {
                        state.factionAligned = 'order';
                        state.knownIslands.push('hub_order');
                        return "Influence Check (Order): The Quartermaster hands you a silver seal. 'The Argent Bastion will take you. But there's no going back to the gutters after this.' (Order Faction Locked)";
                    } 
                    else if (state.influence >= 10) {
                        state.factionAligned = 'chaos';
                        state.knownIslands.push('hub_chaos');
                        return "Influence Check (Chaos): He slips you a ragged flag. 'The Dead-Water Drift is looking for captains. Don't expect the Royal Guard to look you in the eye again.' (Chaos Faction Locked)";
                    }
                    
                    // 3. LEGENDARY HUNT (Neutral/Global)
                    if (!state.knownIslands.includes('void_behemoth_intro') && !state.unlockedBladeEnhance) {
                        state.knownIslands.push('void_behemoth_intro');
                        return "Rumor Added: The Void-Maw Behemoth.";
                    }
                    
                    return "You are currently Neutral. You must gain more Influence (Order or Chaos) to secure an alliance.";
                },
                choices: [
                    { 
                        text: "Buy 5 Supplies (-10s)", 
                        action: (state) => { state.supplies += 5; state.shillings -= 10; return "Bought 5 Supplies."; },
                        type: 'action', 
                        cost: 10,
                        nextScene: 'port_provisioner'
                    },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            'port_provisioner_sell': {
                title: "The Harbor Provisioner - Selling",
                text: "The quartermaster eyes your gear. 'I can take the surplus off your hands. Coin buys hardtack.'",
                choices: [
                    { text: "Back to Buying", nextScene: 'port_provisioner', type: 'travel', doomCost: 0 },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            
            // ACT 3: NAVIGATIONAL HUB
            'sea_map_hub': {
				title: "The Open Sea: Navigation Hub",
				text: "You stand at the wheel. The world is laid out on the chart. To sail, you must expend Supplies.",
				journal: "Navigating the coast.",
				onEnter: (state) => {
					document.getElementById('vignette-overlay').classList.remove('fx-heartbeat-slow', 'fx-heartbeat-fast');
					
					// 1. STARVATION CHECK
					if (state.supplies < 2) {
						scenes['sea_map_hub'].text = "The hold is empty. You must drift and fish to survive.";
						scenes['sea_map_hub'].choices = [
							{ text: "Desperate Fishing (Drift)", nextScene: 'sea_starve_logic', type: 'skill', dc: 12, skill: 'Survival', doomCost: 1 }
						];
						return "Warning: Supplies Depleted.";
					} 
					
					
					scenes['sea_map_hub'].text = "You stand at the wheel. Where to, Captain?";

					// 2. DYNAMIC CHOICE GENERATION (Fixes syntax error)
					let navChoices = [
						{ text: "Sail to Port of Shadows", nextScene: 'travel_to_port', type: 'travel', suppliesCost: 2, customClass: 'btn-anchor' },
						{ text: "Sail to Bleak Dogtooth", nextScene: 'travel_to_dogtooth', type: 'travel', suppliesCost: 5, reqFlag: 'unlocked_dogtooth', customClass: 'btn-anchor' },
						{ text: "Sail to Sanguine Spire", nextScene: 'travel_to_spire', type: 'travel', suppliesCost: 8, reqFlag: 'unlocked_spire', customClass: 'btn-anchor' }
					];

					// Add Hubs if Discovered
					if (state.knownIslands.includes('hub_order')) {
						navChoices.push({ 
							text: "Sail to Iron Citadel (Order)", 
							nextScene: 'hub_order', 
							type: 'travel', 
							suppliesCost: 3, 
							customClass: 'btn-anchor' 
						});
					}
					if (state.knownIslands.includes('hub_chaos')) {
						navChoices.push({ 
							text: "Sail to Titan's Molt (Chaos)", 
							nextScene: 'hub_chaos', 
							type: 'travel', 
							suppliesCost: 3, 
							customClass: 'btn-anchor' 
						});
					}
					if (state.inventory.includes("Feeding Ground Map")) {
						navChoices.push({ 
							text: "Sail to Feeding Grounds (Danger)", 
							nextScene: 'sea_feeding_grounds', // We need to create this scene!
							type: 'travel', 
							suppliesCost: 4, 
							customClass: 'btn-danger' 
						});
					}

					scenes['sea_map_hub'].choices = navChoices;
					return `Current Location: ${state.currentLocation}. Supplies: ${state.supplies}/20.`;
				},
				choices: [] // Populated by onEnter
			},
			'resume_course_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                    // Default to map hub if no destination is saved
                    const target = state.pendingDestination || 'sea_map_hub';
                    // Clear it so we don't get stuck in a loop later
                    state.pendingDestination = null;
                    return target;
                }
            },
			
			'sea_feeding_grounds': {
				title: "The Leviathan's Feeding Ground",
				text: "The water here is red and churning. Massive shapes move beneath the surface. Wreckage from a hundred ships circles in a slow vortex. It is a graveyard of wealth, but the Guardians are hungry.",
				choices: [
					{ 
						text: "Salvage Wreckage (High Risk)", 
						nextScene: 'feeding_salvage_logic', 
						type: 'skill', 
						dc: 16, 
						skill: 'Survival' 
					},
					{ text: "Return to Sea Map", nextScene: 'sea_map_hub', type: 'travel' }
				]
			},
			'feeding_salvage_logic': {
				isLogic: true,
				resolve: (roll, state) => {
					return roll >= 16 ? 'feeding_success' : 'feeding_fail';
				}
			},
			'feeding_success': {
				title: "The Motherlode",
				text: "You navigate the sharks and the currents. You haul up a Captain's Chest.",
				onEnter: (state) => {
					state.shillings += 30;
					if (!state.inventory.includes("Captain's Reserve")) state.inventory.push("Captain's Reserve");
					return "Found 30 Shillings and Captain's Reserve.";
				},
				choices: [{ text: "Escape", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'feeding_fail': {
				title: "The Depths Bite Back",
				text: "Something massive strikes your hull. You lose supplies overboard and take heavy damage.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 8);
					state.supplies = Math.max(0, state.supplies - 5);
					return "Took 8 Damage. Lost 5 Supplies.";
				},
				choices: [{ text: "Flee", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			
			'sea_flotsam_event': {
				title: "Wreckage in the Water",
				text: "You spot debris drifting in the currentremnants of a ship that didn't make it. Barrels bob in the swell among the <span class='text-item'>Flotsam</span>. It's dangerous to haul them in while moving, but there might be supplies.",
				banter: {
					'talon': "The currents gather everything eventually. Even the dead.",
					'quinn': "That crate marking... Royal Navy standard issue. Likely Rope or Rationing."
				},
				choices: [
					{ 
						text: "Salvage Operation", 
						nextScene: 'flotsam_salvage_logic', 
						type: 'skill', 
						dc: 13, 
						skill: 'Survival' 
					},
					{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
				]
			},
			'flotsam_salvage_logic': {
				isLogic: true,
				resolve: (roll, state) => {
					return roll >= 13 ? 'flotsam_success' : 'flotsam_fail';
				}
			},
			'flotsam_success': {
				title: "Salvage Secured",
				text: "The crew hauls the dripping crates aboard. You pry them open.",
				onEnter: (state) => {
					// Loot Table logic
					const roll = Math.random();
					let loot = "";
					
					if (roll > 0.7) {
						if (!state.inventory.includes("Rope")) { state.inventory.push("Rope"); loot = "Rope"; }
						else { state.supplies += 3; loot = "3 Supplies"; }
					} else if (roll > 0.4) {
						if (!state.inventory.includes("Rum")) { state.inventory.push("Rum"); loot = "Rum"; }
						else { state.shillings += 5; loot = "5 Shillings"; }
					} else {
						// Rare chance for missed Act 1 items
						if (!state.inventory.includes("Curious Cargo")) { state.inventory.push("Curious Cargo"); loot = "Curious Cargo (Rare!)"; }
						else { state.inventory.push("Healing Potion"); loot = "Healing Potion"; }
					}
					
					return `Salvaged: ${loot}.`;
				},
				choices: [{ text: "Stow and Continue", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
			},
			'flotsam_fail': {
				title: "Lost to the Sea",
				text: "The current is too strong. The crate slips from the hook and sinks into the black depths. You wasted time.",
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
			},

			// --- UPDATED TRAVEL LOGIC (Includes Navy Chance) ---
			'travel_to_port': {
				isLogic: true,
				resolve: (roll, state) => {
					let cost = 2;
					if (state.inventory.includes("Gilded Sextant")) {
						cost = Math.max(1, cost - 1); 
						addToHistory("Passive (Gilded Sextant): Travel cost reduced.", 'system');
					}
					state.supplies -= cost;
					state.currentLocation = 'port_hub';
					state.pendingDestination = 'town_square';
					
					// RNG Event Logic
					const rng = Math.random();
					if (rng < 0.15) return 'sea_flotsam_event'; // 15% Chance for Flotsam
					if (rng < 0.25) return 'sea_scavenger_encounter'; // 10% chance
					const hasContraband = window.gameFunctions.checkForContraband();
					
					// High chance of Navy if carrying contraband (40%), otherwise Fog (30%)
					if (hasContraband && rng < 0.4) return 'sea_navy_encounter'; 
					if (rng < 0.3) return 'sea_event_fog';
					
					return 'town_square';
				}
			},
			'travel_to_dogtooth': {
				isLogic: true,
				resolve: (roll, state) => {
					// APPLY SEXTANT BONUS
					let cost = 5;
					if (state.inventory.includes("Gilded Sextant")) {
						cost = Math.max(1, cost - 1); // Reduced cost
						addToHistory("Passive (Gilded Sextant): Travel cost reduced.", 'system');
					}

					state.supplies -= cost; 
					state.currentLocation = 'dogtooth';
					state.pendingDestination = 'bleak_dogtooth';
					
					const rng = Math.random(); // Declared ONCE
					if (rng < 0.15) return 'sea_flotsam_event';
					if (rng < 0.25) return 'sea_scavenger_encounter';
					
					const hasContraband = window.gameFunctions.checkForContraband();
					if (hasContraband && rng < 0.4) return 'sea_navy_encounter'; 
					if (rng < 0.3) return 'sea_event_fog';
					
					return 'bleak_dogtooth';
				}
			},
			'travel_to_spire': {
				 isLogic: true,
				resolve: (roll, state) => {
					let cost = 8;
					if (state.inventory.includes("Gilded Sextant")) {
						cost = Math.max(1, cost - 1); 
						addToHistory("Passive (Gilded Sextant): Travel cost reduced.", 'system');
					}
					state.supplies -= cost;
					state.currentLocation = 'spire';
					state.pendingDestination = 'sanguine_spire_entry';
					
					const rng = Math.random(); // Declared ONCE
					if (rng < 0.15) return 'sea_flotsam_event';
					if (rng < 0.25) return 'sea_scavenger_encounter';
					if (rng > 0.90 && state.silasJoined) return 'sea_sanguine_tithe_event';
					
					const hasContraband = window.gameFunctions.checkForContraband();
					if (hasContraband && rng < 0.4) return 'sea_navy_encounter'; 
					if (rng < 0.3) return 'sea_event_fog';
					
					return 'sanguine_spire_entry';
				}
			},
			'sea_starve_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 12 ? 'sea_fish_success' : 'sea_fish_fail'
            },
            'sea_fish_success': {
                title: "The Catch",
                text: "Talon helps you rig nets from scrap rope. You haul in a catch of strange, pale fish. It's barely enough to keep the crew moving.",
                onEnter: (state) => {
                    state.supplies += 3;
                    return "Caught fish. +3 Supplies.";
                },
                choices: [{ text: "Return to Wheel", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
            },
            'sea_fish_fail': {
                title: "Starvation",
                text: "The nets come up empty. The crew grows weak. You are forced to ration the last of the grog, weakening everyone.",
                onEnter: (state) => {
                    state.supplies += 2; // Pity supplies so they aren't stuck forever
                    state.currentHP = applyDamage(state.currentHP, 4);
                    fxManager.flashRed();
                    return "Starvation set in. Took 4 Damage. Scraped together +2 Supplies.";
                },
                choices: [{ text: "Return to Wheel", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
            },

            // ACT 3: RANDOM ENCOUNTERS
            'sea_event_fog': {
				title: "Ghost Fog",
				text: "A bank of unnatural <span class='text-spectral'>Ghost Fog</span> rolls over the deck. The compass needle spins violently. The air turns freezing. If you press on blindly, you will strike a reef.",
				banter: {
					'quinn': "The stars are gone, but I can calculate the drift based on the current speed! Hand me the sextant! (History/Charts)",
					'gareth': "Put your back into the oars! We row through it! (Athletics)"
				},
				choices: [
					{ 
						text: "Use Spectral Lantern", 
						nextScene: 'sea_fog_success', 
						type: 'action', 
						reqItem: 'Spectral Lantern',
						customClass: 'btn-lantern-glow'
					},
					{ 
						text: "Man the Wheel", 
						nextScene: 'sea_fog_puzzle',
						type: 'travel', 
						customClass: 'btn-hero'
					},
					{ 
						text: "Use Ring of Brass", 
						nextScene: 'sea_fog_partial', 
						type: 'action', 
						reqItem: 'Ring of Brass',
						suppliesCost: 2,
						customClass: 'btn-keen-senses'
					},
					{ text: "Recall Ancient Charts", nextScene: 'sea_fog_history_logic', type: 'skill', dc: 14, skill: 'History' },
					{ text: "Brute Force Through", nextScene: 'sea_fog_athletics_logic', type: 'skill', dc: 15, skill: 'Athletics' }
				]
			},
			'sea_fog_puzzle': {
				title: "Navigating the Blind",
				text: `The magnetic storm screams against the hull. The compass in your hand burns cold, the needle thrashing like a trapped moth. The fog is trying to turn the ship into the teeth of the reef. You must force your will upon the direction.<br><br>
                <div class="text-center text-cyan-400 font-bold mb-2">Stabilize Time: <span id="compass-timer-text">10.0</span>s</div>
                <div id="compass-container">
                    <div id="compass-target"></div>
                    <div id="compass-needle"><div id="needle-body"></div><div id="needle-head"></div></div>
                </div>
                <div class="text-xs text-gray-400 text-center mt-2">Drag the needle to the Green Zone and hold it!</div>`,
                journal: "The fog tried to spin us around. I had to fight the compass itself to keep us off the rocks.",
                choices: [
					 // Empty - controlled by timer
				]
			},
			// --- ROYAL NAVY INTERCEPT (Contraband Check) ---
			'sea_navy_encounter': {
				title: "Royal Navy Blockade",
				text: "An iron-hulled Interceptor looms out of the fog, its cannons run out. A magewright amplifies the captain's voice: 'Heave to! We are scanning for illicit magical artifacts and biological hazards!'<br><br>They are looking for <span class='text-danger'>Contraband</span>.",
				onEnter: (state) => {
					const hasContraband = window.gameFunctions.checkForContraband();
					if (hasContraband) return "WARNING: Contraband detected in hold.";
					return "Inventory clean.";
				},
				choices: [
					{
						text: "Submit to Search",
						nextScene: 'sea_navy_clean',
						type: 'action',
						isDisabled: (gameState) => window.gameFunctions.checkForContraband() 
					},
					{
						text: "Submit to Search",
						nextScene: 'sea_navy_caught',
						type: 'action',
						isDisabled: (gameState) => !window.gameFunctions.checkForContraband()
					},
					{
						text: "Jettison Contraband",
						nextScene: 'sea_navy_jettison',
						type: 'action',
						isDisabled: (gameState) => !window.gameFunctions.checkForContraband()
					},
					{
						text: "Attack the Blockade",
						nextScene: 'sea_navy_combat', 
						type: 'combat'
					}
				]
			},
			'sea_navy_clean': {
				title: "Inspection Passed",
				text: "The officers board, scan your hold with divining rods, and find nothing. 'Clear. Proceed, Captain.'",
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'sea_navy_caught': {
				title: "Impounded",
				text: "The rods scream as they pass your hold. 'Titan Marrow? Mimic Bile? This is treason, Captain.'<br><br>They confiscate the illegal goods and levy a heavy fine against your ship.",
				onEnter: (state) => {
					// Remove all items flagged as contraband
					state.inventory = state.inventory.filter(name => {
						const item = itemRegistry[name];
						return !item || !item.isContraband;
					});
					// Levy Fine
					state.shillings = Math.max(0, state.shillings - 15);
					
					return "Contraband seized. Fined 15s.";
				},
				choices: [{ text: "Sail On (Empty Handed)", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'sea_navy_jettison': {
				title: "Overboard",
				text: "You order the crew to toss the crates into the dark water before the Navy can board. The officers find nothing, but you feel the sting of lost profit.",
				onEnter: (state) => {
					state.inventory = state.inventory.filter(name => {
						const item = itemRegistry[name];
						return !item || !item.isContraband;
					});
					return "Dumped Contraband to avoid arrest.";
				},
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'sea_navy_combat': {
				title: "Naval Skirmish",
				text: "You trade broadsides with the Interceptor. You escape into the fog, but your ship takes heavy damage.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 10);
					state.influence = Math.min(50, state.influence + 5); // Fighting Navy = Chaos
					fxManager.flashRed();
					return "Escaped Combat. Took 10 Damage. Chaos +5.";
				},
				choices: [{ text: "Limp Away", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'sea_fog_athletics_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'sea_fog_success' : 'sea_fog_fail'
            },
			'sea_fog_history_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'sea_fog_success' : 'sea_fog_fail'
            },
            'sea_fog_success': {
				title: "The True Course",
				text: "Through skill or spectral light, you find the seam in the mist. The jagged teeth of the reef loom out of the whiteoutinches from the hullbefore fading behind you. You have broken the fog's grip.",
                journal: "We cleared the Ghost Fog. Too close. I can still hear the waves breaking on the reef we missed.",
				choices: [{ text: "Continue Journey", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
			},
            'sea_fog_partial': {
				title: "Slow Going",
				text: "The <span class='text-item'>Ring of Brass</span> amplifies the sound of waves against the hidden reefs, allowing you to proceed, but the delay costs precious resources.",
				onEnter: (state) => {
					state.supplies = Math.max(0, state.supplies - 2);
					return "Navigated safely, but lost 2 Supplies.";
				},
				choices: [{ text: "Continue Journey", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
			},
            'sea_fog_fail': {
                title: "Shipwrecked",
                text: "You strike an unseen reef. The hull groans, and your ship takes heavy damage.",
                onEnter: (state) => {
                    state.currentHP = applyDamage(state.currentHP, 5);
                    state.supplies = Math.max(0, state.supplies - 4);
                    fxManager.flashRed();
                    return "Ship struck reef! Took 5 HP damage. Lost 4 Supplies.";
                },
                choices: [{ text: "Repair and Continue", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }]
            },
            
            // ACT 3: BLEAK DOGTOOTH (SILAS)
            'bleak_dogtooth': {
				title: "The Bleak Dogtooth",
				text: "This jagged, wind-whipped island is home to the <span class='text-danger'>Lost Pack</span>. Once noble guardians, they are now broken things, patrolling the black rocks and snarling at the sea. Their fur is matted with black ichor.<br><br>The <span class='text-item'>Ring of Brass</span> begins to throb against your finger. It is a slow, rhythmic heatlike a heartbeat calling out to its own kind.",
				onEnter: (state) => {
					state.currentLocation = 'dogtooth';
					const overlay = document.getElementById('vignette-overlay');
					
					if (state.companions.silas.joined) {
						overlay.classList.remove('fx-heartbeat-slow', 'fx-heartbeat-fast');
						return "Silas is with you. The Lost Pack growls but backs away.";
					} else {
						overlay.classList.remove('fx-heartbeat-fast');
						overlay.classList.add('fx-heartbeat-slow');
						return "The Ring pulses. Someone is here.";
					}
				},
				banter: {
					'bones': "Look at the one on the rocks. That foam isn't rage; it's sickness. The veins are black. Let me check the bodies. (Medicine Check)",
					'gareth': "They aren't soldiers anymore; they're rabid dogs. Stand tall. Alpha to Alpha. (Intimidation Check)"
				},
				choices: [
					{ 
						text: "Follow the Ring's Pulse", 
						nextScene: 'dogtooth_cliff_wall', 
						type: 'travel', 
						reqItem: 'Ring of Brass',
						reqNotFlag: 'silasJoined',
						customClass: 'btn-pulse'
					},
					{ 
						text: "Examine the Dead", 
						nextScene: 'dogtooth_lore_check', 
						type: 'skill', 
						dc: 14, 
						skill: 'Medicine',
						reqNotFlag: 'dogtoothExamined' 
					},
					{ 
						text: "Cow the Pack", 
						nextScene: 'dogtooth_intimidate_logic', 
						type: 'skill', 
						dc: 15, 
						skill: 'Intimidation',
						reqNotFlag: 'dogtoothIntimidated' 
					},
					{ 
						text: "Investigate Smoke", 
						nextScene: 'dogtooth_envoy', 
						type: 'travel', 
						reqNotFlag: 'envoyResolved' 
					},
					{
						text: "Explore Sea Caves",
						nextScene: 'dogtooth_lab_ruins',
						type: 'travel',
						reqNotFlag: 'labLooted',
					},
					{ text: "Return to Sea Map", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
				]
			},
            'dogtooth_intimidate_logic': {
                isLogic: true,
                resolve: (roll, state) => {
                     // Check Tricorn Bonus
                     if (state.inventory.includes("Captain's Tricorn")) {
                        roll += 1;
                        addToHistory(`Passive Bonus (Captain's Tricorn): +1`, 'roll');
                     }
                     return roll >= 15 ? 'dogtooth_intimidate_success' : 'dogtooth_intimidate_fail';
                }
            },
            'dogtooth_intimidate_success': {
                title: "Alpha Status",
                text: "You channel Gareth's roaring voice. The feral wolves whine and retreat, leaving a path to the shoreline clear. You find a washed-up crate they were guarding.",
                onEnter: (state) => {
                    state.dogtoothIntimidated = true; // CHANGED: Set Flag
                    state.supplies = Math.min(20, state.supplies + 3);
                    return "Scared off the pack. Found 3 Supplies.";
                },
                choices: [{ text: "Return to Bleak Dogtooth", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }]
            },
            'dogtooth_intimidate_fail': {
                title: "The Pack Snaps",
                text: "Your voice cracks. The wolves smell weakness and lunge.",
                onEnter: (state) => {
                    state.dogtoothIntimidated = true; // CHANGED: Set Flag (can't try again)
                    state.currentHP = applyDamage(state.currentHP, 4);
                    fxManager.flashRed();
                    return "Intimidation failed. Took 4 Damage.";
                },
                choices: [{ text: "Return to Bleak Dogtooth", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }]
            },
			'dogtooth_lore_check': {
				isLogic: true,
				resolve: (roll) => roll >= 14 ? 'dogtooth_lore_success' : 'dogtooth_lore_fail'
			},
			'dogtooth_lore_success': {
				title: "The Pathology",
				text: "Bones examines a fallen werewolf with grim precision. 'This isn't just a curse,' he mutters, wiping <span class='text-void'>black ichor</span> from his knife. 'It's an engineered plague. The veins are clogged with alchemical residue.'",
				journal: "Bones identified the Lycanthropy as an engineered plague. It seems the Vampires poisoned the wolves.",
				onEnter: (state) => {
                    state.dogtoothExamined = true; // CHANGED: Set Flag
					state.influence += 2; 
					return "Lore Gained. Chaos +2.";
				},
				choices: [{ text: "Return to Bleak Dogtooth", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }]
			},
			'dogtooth_lore_fail': {
				title: "Unknown Affliction",
				text: "The physiology is too alien. You cannot determine the cause of their feral state.",
                onEnter: (state) => {
                    state.dogtoothExamined = true; // CHANGED: Set Flag (can't try again)
                    return null;
                },
				choices: [{ text: "Return to Bleak Dogtooth", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }]
			},
            'dogtooth_cliff_wall': {
                title: "The Dead End",
                text: "",
                onEnter: (state) => {
                    if (!state.companions.silas.joined) {
                        document.getElementById('vignette-overlay').classList.remove('fx-heartbeat-slow');
                        document.getElementById('vignette-overlay').classList.add('fx-heartbeat-fast');
                    } else {
                        document.getElementById('vignette-overlay').classList.remove('fx-heartbeat-slow', 'fx-heartbeat-fast');
                    }

                    // CHANGED: Swapped logic to Ensure Normal = Wall, Ethereal = Sanctuary
                    if (state.isEthereal) {
                        scenes['dogtooth_cliff_wall'].text = "As you step into the Ethereal Plane, the granite cliff dissolves into a curtain of grey mist. The heartbeat syncs with the thrum of the spectral world.<br><br>Beyond the veil, a hidden sanctuary is revealeda cave that exists only in the echo of the world. Standing at the entrance is a lone, disciplined figure in tattered armor, watching you with eyes of gold.";
                        
                        scenes['dogtooth_cliff_wall'].choices = [
                            { 
                                text: "Enter the Sanctuary", 
                                nextScene: 'silas_sanctuary',
                                type: 'travel',
                                customClass: 'btn-planewalk-reveal' 
                            }
                        ];
                        return "The Ethereal Plane reveals the truth. Path found.";
                    } else {
                        scenes['dogtooth_cliff_wall'].text = "You follow the pulse to a sheer granite cliff face. The path ends here. There are no caves, no tracks, nothing.<br><br>Yet, the <span class='text-item'>Ring of Brass</span> is screaming now, burning your finger. The heartbeat is deafening. It insists that the path continues <i>forward</i>, straight into the solid rock. The geometry of this place is wrong.";
                        
                        scenes['dogtooth_cliff_wall'].choices = [
                            { text: "Touch the Rock Wall", action: () => "Solid stone. Cold and unyielding.", type: 'action' },
                            { text: "Return to Shore", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }
                        ];
                        return "The signal is strongest here, but the way is blocked. Think like a Horizon Walker.";
                    }
                }
            },
			
			'silas_sanctuary': {
                title: "The Seneschal's Sanctuary",
                text: "The interior of the cave is sparse, illuminated by candles that burn with motionless flames. A shrine to the Wolf King sits in the corner.",
                onEnter: (state) => {
                    const isEthereal = state.isEthereal;

                    if (isEthereal) {
                        scenes['silas_sanctuary'].text = "Silas stands before you, his armor shining with spectral light. He is waiting, but he is a ghost to you right now. 'You must return, Mariner. You cannot swear an oath to me from the void.'";
                        scenes['silas_sanctuary'].choices = [
                            { 
                                text: "Return to Material Plane", 
                                type: 'action', 
                                action: window.gameFunctions.togglePlaneWalk,
                                customClass: 'spectral-active',
                                tetherCost: 0
                            }
                        ];
                        return "Silas is waiting in the spectral realm.";
                    } else {
                        scenes['silas_sanctuary'].text = "The cliff is solid behind you. Silas stands in the real world now, holding out the hilt of his sword. 'Welcome back, Mariner. Now, the oath.'";
                        scenes['silas_sanctuary'].choices = [
                            { 
                                text: "Swear Loyalty (Recruit Silas)", 
                                nextScene: 'silas_recruit_success', 
                                type: 'travel',
                                customClass: 'btn-keen-senses'
                            }
                        ];
                        return "Silas is ready for the oath.";
                    }
                }
            },

            'silas_recruit_success': {
                title: "Silas, The Seneschal",
                text: "Silas drops his guard, his eyes fixed on the Ring. He recognizes the Wolf King's symbol. 'I thought I was the last to carry the code. Forgive me, Captain. I serve the Order. I serve you.' He takes his place at your side.",
                journal: "Recruited Silas, the Wolf King's Seneschal. (Companion Gained).",
                onEnter: (state) => {
                    state.companions.silas.joined = true;
                    state.silasJoined = true;
                    state.unlocked_spire = true;
                    state.knownIslands.push('sanguine_spire_entry');
                    
                    document.getElementById('vignette-overlay').classList.remove('fx-heartbeat-slow', 'fx-heartbeat-fast');
                    
                    return "Silas joined the crew. Sanguine Spire coordinates unlocked.";
                },
                choices: [{ text: "Return to Bleak Dogtooth", nextScene: 'bleak_dogtooth', type: 'travel', doomCost: 0 }]
            },
			// 1. THE TURNED GUARD
			'dogtooth_envoy': {
				title: "The Turned Guard",
				text: "You find a Royal Guard huddled against a rock, sweating <span class='text-void'>black ichor</span>. His jaw is distending, teeth lengthening.<br><br>'Please,' he wheezes. 'Don't let me turn. The Citadel burns the infected... I ran... but the Wolf is here.'<br><br>The Pack watches from the ridge.",
				banter: {
					'silas': "The change is agony, but power lies at the end. Let him turn.",
					'gareth': "Give him a soldier's death."
				},
				choices: [
					{ 
						text: "Grant Mercy (Kill)", 
						nextScene: 'envoy_mercy_kill', 
						type: 'action', 
						orderGain: 5 
					},
					{ 
						text: "Let Him Turn", 
						nextScene: 'envoy_turn', 
						type: 'action', 
						chaosGain: 5 
					}
				]
			},
			'envoy_mercy_kill': {
				title: "A Clean End",
				text: "You end his suffering. You collect his **Royal Signet Ring** to return to his family.",
				onEnter: (state) => {
					state.envoyResolved = true;
					if (!state.inventory.includes("Royal Signet Ring")) state.inventory.push("Royal Signet Ring");
					state.influence = Math.max(-50, state.influence - 5);
					return "Mercy Kill. Found Signet Ring. Order +5.";
				},
				choices: [{ text: "Return to Shore", nextScene: 'bleak_dogtooth', type: 'travel' }]
			},
			'envoy_turn': {
				title: "The New Pack",
				text: "You step back. The guard screams as his bones snap and reshape. He rises, a wolf-thing, and bounds up the ridge to join his new kin.",
				onEnter: (state) => {
					state.envoyResolved = true;
					state.influence = Math.min(50, state.influence + 5);
					return "Allowed Transformation. Chaos +5.";
				},
				choices: [{ text: "Return to Shore", nextScene: 'bleak_dogtooth', type: 'travel' }]
			},

			// 2. THE RUINED LAB (New Exploration Node)
			'dogtooth_lab_ruins': {
				title: "The Vampire Laboratory",
				text: "Hidden in a sea-cave, you find the remains of a laboratory. Cages line the wallstoo small for men, too large for dogs. Broken glass crunches underfoot.<br><br>This is where they made the plague. Amidst the ruin, you see a pristine silver <span class='text-item'>Beast Whistle</span> and a syringe glowing with <span class='text-void'>Volatile Mutagen</span>.",
				journal: "Found the lab where the Vampires engineered the Lycanthropy. Looted the prototypes.",
				onEnter: (state) => {
					state.labLooted = true;
					let msg = "Looted Lab: ";
					if (!state.inventory.includes("Beast Whistle")) {
						state.inventory.push("Beast Whistle");
						msg += "Beast Whistle. ";
					}
					if (!state.inventory.includes("Volatile Mutagen")) {
						state.inventory.push("Volatile Mutagen");
						msg += "Volatile Mutagen.";
					}
					return msg;
				},
				choices: [{ text: "Return to Shore", nextScene: 'bleak_dogtooth', type: 'travel' }]
			},
			
			// --- ACT 3 FACTION HUBS ---

			// 1. ORDER HUB: THE IRON CITADEL
			'hub_order': {
				title: "The Iron Citadel",
				text: "You dock at the Citadel. It was once a pristine fortress of grey stone, but now it looks... diseased. Patches of stark white, jagged reef are growing directly out of the masonry, choking the statues and sealing arrow slits.<br><br>The air is thick with soot. You see squads of soldiers with flamethrowers burning the walls, their faces wrapped in wet cloth. They aren't fighting an army; they are fighting the architecture itself.",
				journal: "Docked at the Citadel. The fortress is being eaten alive. The stone is growing white tumors. The soldiers look exhausted.",
				banter: {
					'gareth': "Look at those walls. Discipline holding back the tide. This is how men survive, Edward."
				},
				onEnter: (state) => {
					state.currentLocation = 'hub_order';
					return "Docked at Iron Citadel (Order HQ).";
				},
				choices: [
					{ 
						text: "Speak to Commander", 
						nextScene: 'order_quest_fence_start', // Link to Bio-Reactor Quest
						type: 'dialogue',
						reqNotFlag: 'fenceQuestActive',
						isDisabled: (state) => state.fenceQuestComplete
					},					
					{ 
						text: "Visit Calcification Ward", 
						nextScene: 'order_petrified_ward', // Link to New Body Horror Scene
						type: 'travel', 
						doomCost: 0 
					},
					{ 
						text: "Investigate Barracks", 
						nextScene: 'citadel_barracks_investigate', 
						type: 'skill', 
						dc: 13, 
						skill: 'Investigation', 
						reqNotFlag: 'traitorQuestActive',
						isDisabled: (state) => state.traitorQuestComplete						
					},
					{ 
						text: "Commander's Mission: Defend Armory", 
						nextScene: 'order_quest_start', 
						type: 'travel',
						reqNotFlag: 'coralHulkDefeated',
						customClass: 'btn-hero'
					},					
					{ 
						text: "Visit Quartermaster", 
						nextScene: 'order_quartermaster', 
						type: 'travel', 
						doomCost: 0 
					},
					{ text: "Return to Sea Map", nextScene: 'sea_map_hub', type: 'travel' }
				]
			},
			'order_quartermaster': {
				title: "Citadel Quartermaster",
				text: "The Quartermaster stands behind a cage of reinforced steel. 'We have seized contraband and surplus ordnance. If you have the coin, I can release it for the war effort.'",
				stock: {
					"Holy Water": 2,
					"Flash Powder": 2,
					"Industrial Lubricant": 2,
					"Supplies": 99
				},
				choices: [
					{ 
						text: "Buy Holy Water (12s)", 
						type: 'action', 
						cost: 12, 
						stockItem: 'Holy Water',
						action: (state) => { state.inventory.push("Holy Water"); return "Bought Holy Water."; },
						nextScene: 'order_quartermaster'
					},
					{ 
						text: "Buy Flash Powder (10s)", 
						type: 'action', 
						cost: 10, 
						stockItem: 'Flash Powder',
						action: (state) => { state.inventory.push("Flash Powder"); return "Bought Flash Powder."; },
						nextScene: 'order_quartermaster'
					},
					{ 
						text: "Buy 5 Supplies (10s)", 
						type: 'action', 
						cost: 10, 
						action: (state) => { state.supplies += 5; return "Bought Supplies."; },
						nextScene: 'order_quartermaster'
					},
					{ text: "Return to Citadel", nextScene: 'hub_order', type: 'travel', doomCost: 0 }
				]
			},
			'citadel_barracks_investigate': {
				isLogic: true,
				resolve: (roll) => roll >= 13 ? 'barracks_clue_found' : 'barracks_clue_fail'
			},
			'barracks_clue_found': {
				title: "The Sick Ledger",
				text: "Quinn finds a discrepancy in the supply logs. A Quartermaster is smuggling maps out of the Citadel. But he isn't taking moneyhe's taking **Nutrient Slurry**.<br><br>The note reads: *'I have the patrol routes. Bring the dose to the Rib-Cage Tavern. The white veins are spreading to my face.'*",
				journal: "Found a traitor's note. He's infected with Hyper-Coral and trading secrets for Rook's cure.",
				onEnter: (state) => {
					state.traitorQuestActive = true;
					return "Quest Started: Ambush the Traitor at Titan's Molt.";
				},
				choices: [{ text: "Go to Titan's Molt", nextScene: 'hub_chaos', type: 'travel' }]
			},
			'barracks_clue_fail': {
				title: "Dead End",
				text: "You search the barracks but find only tired soldiers cleaning their gear. The traitor covers their tracks well.",
				choices: [{ text: "Return to Hub", nextScene: 'hub_order', type: 'travel' }]
			},

			// 2. CHAOS HUB: THE TITAN'S MOLT
			'hub_chaos': {
				title: "The Titan's Molt",
				text: "Your boots sink slightly as you step off the gangplank. This isn't rock. The floating island has a texture like cured leather, vast and pockmarked. The shantytown built upon it is carved from materials that look suspiciously like ribcages and teeth.<br><br>The air smells copper-sharplike blood and ozone. Scavengers are everywhere, hacking into the ground beneath their feet with pickaxes, harvesting glowing, gelatinous chunks of the island itself.",
				journal: "Docked at the 'Molt'. I'm walking on something's skin. The people here are mining the ground for meat and fuel. It's gruesome. It's survival.",
				banter: {
					'talon': "It smells like blood and opportunity here. No laws, no guards. Just the quick and the dead."
				},
				onEnter: (state) => {
					state.currentLocation = 'hub_chaos';
					return "Docked at Titan's Molt (Chaos HQ).";
				},
				choices: [
				{ 
						text: "Ambush the Traitor", 
						nextScene: 'molt_traitor_confront', 
						type: 'dialogue', 
						reqFlag: 'traitorQuestActive', 
						customClass: 'btn-pulse' 
					},
					{ 
						text: "Follow Compass Signal", 
						nextScene: 'chaos_fence_confrontation',
						type: 'dialogue', 
						reqFlag: 'fenceQuestActive',
						customClass: 'btn-pulse'
					},
					{
						text: "Seek out Rook",
						nextScene: 'chaos_fence_confrontation',
						type: 'dialogue',
						reqNotFlag: 'fenceQuestActive',
						customClass: 'btn-pulse'
					},
					{ 
						text: "Visit The Drift Market", 
						nextScene: 'chaos_market', 
						type: 'travel', 
						doomCost: 0 
					},
					{ 
						text: "The Heist: Raid Citadel Armory", 
						nextScene: 'chaos_quest_start', 
						type: 'travel',
						reqNotFlag: 'coralHulkDefeated', // Hides after victory
						customClass: 'btn-hero'
					},
					{ 
						text: "Barter for Supplies", 
						type: 'action', 
						cost: 8, 
						action: (state) => { state.supplies += 5; return "Bought 5 Supplies."; }
					},
					{ text: "Return to Sea Map", nextScene: 'sea_map_hub', type: 'travel' }
				]
			},
			'chaos_market': {
				title: "The Drift Market",
				text: "Vendors hawk wares from blankets made of sailcloth. Here, you can buy what others throw away. A nervous doctor in a stained coat watches you from the shadows.",
				stock: {
					"Alchemical Fire": 2,
					"Pearlescent Mushroom": 2, // Not contraband here!
					"Mimic's Bile": 1,
					"Volatile Mutagen": 1
				},
				choices: [
					{ 
						text: "Buy Alchemical Fire", 
						type: 'action', 
						cost: 12, 
						stockItem: 'Alchemical Fire',
						action: (state) => { state.inventory.push("Alchemical Fire"); return "Bought Alchemical Fire."; },
						nextScene: 'chaos_market'
					},
					{ 
						text: "Buy Pearlescent Mushroom", 
						type: 'action', 
						cost: 15, 
						stockItem: 'Pearlescent Mushroom',
						action: (state) => { state.inventory.push("Pearlescent Mushroom"); return "Bought Mushroom."; },
						nextScene: 'chaos_market'
					},
					{ 
						text: "Approach Nervous Doctor", 
						nextScene: 'chaos_secret_shop_check', 
						type: 'skill', 
						dc: 14, 
						skill: 'Medicine',
						reqNotFlag: 'knowsDoctorSecret',
						customClass: 'btn-pulse'
					},
					{ 
                        text: "Buy Volatile Mutagen", 
                        type: 'action', 
                        cost: 20, 
                        stockItem: 'Volatile Mutagen',
                        reqFlag: 'knowsDoctorSecret',
                        action: (state) => { state.inventory.push("Volatile Mutagen"); return "Bought Mutagen."; },
                        nextScene: 'chaos_market',
                    },
					{ text: "Buy 5 Supplies (8s)", type: 'action', cost: 8, action: (state) => { state.supplies += 5; return "Bought Supplies."; }, nextScene: 'chaos_market' },
					{ text: "Return to The Molt", nextScene: 'hub_chaos', type: 'travel', doomCost: 0 }
				]
			},
			'chaos_secret_shop_check': {
				isLogic: true,
				resolve: (roll, state) => {
					return roll >= 14 ? 'chaos_secret_success' : 'chaos_secret_fail';
				}
			},
			'chaos_secret_success': {
				title: "The Back Room",
				text: "Bones notices the chemical stains on the man's hands. 'He's been working with the Vampire strains,' he whispers. You confront the doctor, and he reveals his hidden stock.",
				onEnter: (state) => {
					state.knowsDoctorSecret = true;
					return "Unlocked Secret Shop: Volatile Mutagen available.";
				},
				choices: [{ text: "Access Secret Stock", nextScene: 'chaos_market', type: 'travel', doomCost: 0 }]
			},
			'chaos_secret_fail': {
				title: "Paranoia",
				text: "The doctor sees you watching and packs up his special wares. He refuses to speak to you.",
				choices: [{ text: "Back to Market", nextScene: 'chaos_market', type: 'travel', doomCost: 0 }]
			},
			'molt_traitor_confront': {
				title: "The Desperate Deal",
				text: "You corner the Quartermaster in a dark corner of the Molt. He is shaking. He pulls down his collar to reveal <span class='text-danger'>white, calcified veins</span> climbing his neck.<br><br>'Please,' he begs, clutching a jar of Slurry. 'The Citadel burns the infected! This sludge is the only thing that stops the growth. I'm not a traitor; I'm just trying to stay human!'",
				banter: {
					'bones': "He's telling the truth. The Slurry halts the calcification. It's a treatment, not a cure.",
					'gareth': "He sold out his post. Infection is no excuse for treason."
				},
				choices: [
					{ 
						text: "Execute Him (Order)", 
						nextScene: 'traitor_execute', 
						type: 'action', 
						orderGain: 8,
						action: (state) => {
							state.traitorQuestActive = false;
							state.influence = Math.max(-50, state.influence - 8);
							return "Traitor executed. Secrets secured. Order +8.";
						}
					},
					{ 
						text: "Let Him Go (Chaos)", 
						nextScene: 'traitor_mercy', 
						type: 'action', 
						chaosGain: 8,
						action: (state) => {
							state.traitorQuestActive = false;
							state.influence = Math.min(50, state.influence + 8);
							return "You let him keep the cure and the secrets. Chaos +8.";
						}
					},
					{ 
						text: "Blackmail (Neutral)", 
						nextScene: 'traitor_blackmail', 
						type: 'action', 
						shillingGain: 20,
						action: (state) => {
							state.traitorQuestActive = false;
							state.shillings += 20;
							return "Took his bribe. +20 Shillings.";
						}
					}
				]
			},
			'traitor_execute': {
				title: "Duty First",
				text: "You end it quickly. You take the maps back. The infection dies with him.",
				onEnter: (state) => {
				state.traitorQuestComplete = true;
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_chaos', type: 'travel' }]
			},
			'traitor_mercy': {
				title: "Survival",
				text: "You step aside. He vanishes into the crowd, clutching the Slurry like gold. The secrets of the Citadel are now in Smuggler hands.",
				onEnter: (state) => {
				state.traitorQuestComplete = true;
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_chaos', type: 'travel' }]
			},
			'traitor_blackmail': {
				title: "The Cost of Silence",
				text: "He empties his purse into your hands. You walk away, leaving him to his sickness and his treason.",
				onEnter: (state) => {
				state.traitorQuestComplete = true;
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_chaos', type: 'travel' }]
			},
			
			'sea_scavenger_encounter': {
				title: "The Deep Scavenger",
				text: "A brass diving bell breaches the surface near your ship. The hatch opens, revealing a man whose skin is fused with barnacles and rust. He cannot leave the suit.<br><br>'The pressure...' he gasps. 'It holds me together. Do you seek the <span class='text-danger'>Feeding Grounds</span>? The Leviathan eats well tonight.'",
				banter: {
					'bones': "Look at his joints. The metal has grown into the bone. He isn't wearing that suit; he *is* the suit.",
					'quinn': "That brass alloy... pre-Rift. He's been down there a long time."
				},
				onEnter: (state) => {
					if (state.inventory.includes("Feeding Ground Map")) {
						scenes['sea_scavenger_encounter'].text = "The diving bell breaches again. The man inside sees you and waves a rusted gauntlet. 'You have the map... why are you still here? Go before *It* wakes up.'";
						scenes['sea_scavenger_encounter'].choices = [
							{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }
						];
					}
				},
				choices: [
					{ 
						text: "Buy Map", // Removed "(15s)"
						type: 'action', 
						cost: 15,
						action: (state) => {
							if (!state.inventory.includes("Feeding Ground Map")) {
								state.inventory.push("Feeding Ground Map");
								// Note: Ensure 'feeding_ground_node' exists or this does nothing but add item
								if (!state.knownIslands.includes('feeding_ground_node')) {
									 state.knownIslands.push('feeding_ground_node');
								}
							}
							state.shillings -= 15;
							return "Purchased Feeding Ground Map.";
						},
						nextScene: 'sea_map_hub'
					},
					{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }
				]
			},
			'order_petrified_ward': {
				title: "The Calcification Ward",
				text: "The infirmary is silent, save for the wet, tearing sound of rapid growth. Rows of soldiers lie in iron cots. They aren't wounded; they are *blooming*. White, jagged <span class='text-danger'>Hyper-Coral</span> bursts from their shoulders and chests, fusing them to the bedframes.<br><br>The Surgeon wipes green slime from a bone-saw. 'We don't cure them,' he whispers, looking at you with dead eyes. 'We just prune the growth so they can hold a rifle for one more day.'",
				journal: "The Citadel's hospital. They are farming soldiers here. I can hear the coral growing inside them.",
				banter: {
					'bones': "The Surgeon is a butcher. Look at that boy in the cornerthe coral hasn't hit the lymph nodes yet. If I excise the root *now*, I can save the limb and the life. (Medicine Check)"
				},
				choices: [
                    { 
                        text: "Perform Surgical Excision", 
                        nextScene: 'ward_medicine_logic', 
                        type: 'skill', 
                        dc: 15, 
                        skill: 'Medicine',
                        orderGain: 4,
                        reqNotFlag: 'wardSurgeryDone' 
                    },
                    { 
                        text: "Donate Rum (Anesthetic)", 
                        nextScene: 'ward_donate_rum', 
                        type: 'action', 
                        reqItem: 'Rum', 
                        consume: true,
                        orderGain: 4,
                        reqNotFlag: 'wardRumDonated' 
                    },
                    { 
                        text: "Inspect a Critical Patient", 
                        nextScene: 'ward_bloom_event', 
                        type: 'travel',
                        doomCost: 0,
                        reqNotFlag: 'wardBloomDone' 
                    },
                    { text: "Leave the Ward", nextScene: 'hub_order', type: 'travel' }
                ]
			},

			// NEW LOGIC SCENES FOR BONES
			'ward_medicine_logic': {
				isLogic: true,
				resolve: (roll) => roll >= 15 ? 'ward_medicine_success' : 'ward_medicine_fail'
			},
			'ward_medicine_success': {
				title: "The Precision Cut",
				text: "Bones guides your hand. You ignore the Surgeon's protests and cut deep, bypassing the hardened shell to find the pulsing, soft root of the parasite. With a wet *shluck*, you tear it free.<br><br>The soldier gasps, the white lines on his skin fading instantly. The Surgeon stares in awe. 'I... I didn't know that was possible.' He hands you a pouch of coin meant for supplies.",
				journal: "Performed a life-saving surgery. Bones was rightit can be cut out.",
				onEnter: (state) => {
					state.shillings += 10;
					state.wardSurgeryDone = true;
					audioManager.playCoins();
					return "Surgery Successful. Earned 10 Shillings. Order +4.";
				},
				choices: [{ text: "Return to Ward", nextScene: 'order_petrified_ward', type: 'travel' }]
			},
			'ward_medicine_fail': {
				title: "Too Deep",
				text: "You try to cut the root, but the coral is harder than bone. The scalpel snaps. The soldier screams as the trauma accelerates the growth, instantly calcifying his arm. The Surgeon shoves you away. 'You've done enough damage, Mariner.'",
				journal: "Botched the surgery. The soldier lost his arm.",
				onEnter: (state) => {
					state.influence = Math.min(50, state.influence + 2);
					state.wardSurgeryDone = true;
					return "Surgery Failed. Chaos +2.";
				},
				choices: [{ text: "Back to Ward", nextScene: 'order_petrified_ward', type: 'travel' }]
			},
			'ward_donate_rum': {
				title: "A Small Mercy",
				text: "The surgeon nods gratefully, administering the spirits to a young guard whose legs have fused together. The soldier's breathing slows, the panic fading from his eyes.",
				onEnter: (state) => {
					state.influence = Math.max(-50, state.influence - 4);
					state.wardRumDonated = true;
					return "Donated Rum.";
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_order', type: 'travel' }]
			},
			'ward_bloom_event': {
				title: "The Rapid Bloom",
				text: "You approach a young soldier. He looks at you, trying to speak, but a massive spike of white coral bursts through his jaw. His back arches, ribs snapping as the reef takes him completely. <br><br>The Surgeon screams, 'He's blooming! Hold him down!' The soldierno longer a man, but a <span class='text-danger'>Coral-Husk</span>thrashes violently, razor-sharp barnacles erupting from his skin.",
				journal: "I watched a man turn into a reef in seconds. The sound of his bones breaking will stay with me.",
				choices: [
					{ 
						text: "End His Suffering", 
						nextScene: 'ward_bloom_combat', 
						type: 'combat',
						doomCost: 0
					},
					{ 
						text: "Hold Him Down", 
						nextScene: 'ward_bloom_hold', 
						type: 'skill', 
						dc: 15, 
						skill: 'Athletics' 
					}
				]
			},
			'ward_bloom_combat': {
				title: "A Mercy Kill",
				text: "You draw your weapon. One clean strike severs the brain stem before the coral fully takes hold. The body goes limp, the rapid growth stopping instantly. The Surgeon stares at you, shaking, covered in spores.",
				onEnter: (state) => {
					state.influence = Math.max(-50, state.influence - 5);
					state.wardBloomDone = true;
					return "Mercy Kill performed.";
				},
				choices: [{ text: "Leave the Ward", nextScene: 'hub_order', type: 'travel' }]
			},
			'ward_bloom_hold': {
				isLogic: true,
				resolve: (roll) => roll >= 15 ? 'ward_bloom_success' : 'ward_bloom_fail'
			},
			'ward_bloom_success': {
				title: "Stabilized",
				text: "You pin the thrashing husk to the bed, ignoring the coral cutting your hands. The Surgeon manages to inject a concentrated saline solution directly into the heart. The growth arrests. The man is still alive... for now.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 2);
					state.wardBloomDone = true;
					return "Stabilized the Bloom.";
				},
				choices: [{ text: "Leave the Ward", nextScene: 'hub_order', type: 'travel' }]
			},
			'ward_bloom_fail': {
				title: "Too Late",
				text: "The coral growth is explosive. A spike catches you in the shoulder, throwing you back. By the time you recover, the soldier is gonefully consumed. The guards rush in with flamethrowers to incinerate the corpse.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 5);
					state.wardBloomDone = true;
					fxManager.flashRed();
					return "Failed to hold him. Took 5 Damage.";
				},
				choices: [{ text: "Retreat", nextScene: 'hub_order', type: 'travel' }]
			},

			// --- NEW QUEST: THE EMBER-HEART ---

			'order_quest_fence_start': {
				title: "Contract: The Cold Furnace",
				text: "The Commander leads you deep into the bowels of the fortress. You expect heat, but the Great Foundry is dark and freezing. The massive pistons hang silent.<br><br>'It's the cold that kills us first,' the Commander admits, his breath misting. 'The <span class='text-item'>Ember-Heart</span>. It was our sun. Rook stole it. Without that heat, we can't forge the plating to stop the white growth. We are three days from being sealed inside our own tomb. Find him.'",
				journal: "The Foundry is dead. Rook stole their power source. Without it, the Citadel freezes and the reef takes them.",
				onEnter: (state) => {
					state.fenceQuestActive = true;
					return "Quest Started: Retrieve the Ember-Heart.";
				},
				choices: [
					{ text: "Track the Heat (Accept)", nextScene: 'hub_order', type: 'travel' }
				]
			},

			'chaos_fence_confrontation': {
				title: "Rook's Experiment",
				text: "You follow the Compass to a hollowed-out chamber deep beneath the surface of the Molt. The heat here is suffocating. In the center, Rook stands before a jury-rigged machine of brass pipes and organic valves. The <span class='text-item'>Ember-Heart</span> pulses at its base, beating like a living thing.<br><br>Rook shovels chunks of the white reef-growth into the hopper. The machine groans and spits out a thick, glowing slurry. He offers you a spoonful. 'Don't look at me like that. It's ugly, but it's pure energy. The Citadel burns the Heart to make walls. I'm using it to turn the plague into food.'",
				journal: "Found Rook. He's built a reactor. He's turning the infection into sustenance. It's disgusting, but... nobody here is starving.",
				banter: {
					'quinn': "Efficient. He's solved the supply crisis. But he controls the only tap.",
					'gareth': "He's feeding them rot! It's unnatural. Burn it down, Edward."
				},
				choices: [
					{ 
						text: "Take Heart", 
						nextScene: 'fence_resolution_order', 
						type: 'action',
						orderGain: 15
					},
					{ 
						text: "Leave Heart", 
						nextScene: 'fence_resolution_chaos', 
						type: 'action',
						chaosGain: 15
					},
					{ 
						text: "Demand Royalties", 
						nextScene: 'fence_resolution_neutral', 
						type: 'action',
						shillingGain: 50
					}
				]
			},
			'fence_resolution_order': {
				title: "The Furnace Roars",
				text: "You kick the machine over. The slurry spills, hissing on the bone floor. You rip the <span class='text-item'>Ember-Heart</span> free, searing your gloves. Rook screams, 'You just starved us all! You chose stone over flesh!'<br><br>You leave him in the dark. Back at the Citadel, the Foundry roars to life. The pistons thunder, a rhythmic heartbeat of industry that shakes the very ocean. The walls will hold.",
				journal: "I took the Heart back. The Citadel stands. Rook's people will hunger, but the defense holds.",
				onEnter: (state) => {
					if (!state.inventory.includes("Ember-Heart")) state.inventory.push("Ember-Heart");
					state.fenceQuestActive = false;
					state.fenceQuestComplete = true;
					state.influence = Math.max(-50, state.influence - 15);
					return "Quest Complete. Order +15.";
				},
				choices: [{ text: "Return to Iron Citadel", nextScene: 'hub_order', type: 'travel' }]
			},
			'fence_resolution_chaos': {
				title: "The New Tyrant",
				text: "You step back. Rook nods, wiping slurry from his chin. 'The old world is dead, Mariner. We have to eat the new one.'<br><br>He hands you a jar of the glowing paste. You know what will happen. He will become the King of the Molt, a tyrant of sustenance. But the refugees will live. Evolution is ugly.",
				journal: "I let him keep it. The Order will fall, but the Molt will adapt. I tasted the slurry. It tastes like ash and life.",
				onEnter: (state) => {
					state.fenceQuestActive = false;
					state.fenceQuestComplete = true;
					state.shillings += 25;
					state.influence = Math.min(50, state.influence + 15);
					if (!state.inventory.includes("Nutrient Slurry")) state.inventory.push("Nutrient Slurry");
					return "Quest Complete. Chaos +15. Gained 25s.";
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_chaos', type: 'travel' }]
			},
			'fence_resolution_neutral': {
				title: "The Price of Ambition",
				text: "He empties his purse into your hands. You walk away, leaving him to his sickness and his treason.",
				onEnter: (state) => {
					state.fenceQuestActive = false;
					state.shillings += 50;
					return "Quest Complete. Neutral. Gained 50s.";
				},
				choices: [{ text: "Return to Hub", nextScene: 'hub_chaos', type: 'travel' }]
			},
			
			// --- QUEST LOGIC ---

			'order_quest_start': {
				title: "Quest: Defense of the Citadel",
				text: "The Commander points to a breached sector. 'The Hyper-Coral has birthed a monstrosity inside our armory. A <span class='text-danger'>Coral-Hulk</span>. It heals faster than we can kill it. Hold the line, Mariner, and the Mirror Shield is yours.'",
				choices: [
					{ text: "Enter the Breach (Boss Fight)", nextScene: 'coral_hulk_intro', type: 'travel' }
				]
			},

			'chaos_quest_start': {
				title: "Quest: The Citadel Heist",
				text: "Your contact grins. 'The Order is busy burning coral. Perfect time to slip into their armory. There's a <span class='text-item'>Scale-Stake Driver</span> prototype in there. Only problem? A massive <span class='text-danger'>Coral-Hulk</span> has claimed the room. Kill it, grab the loot, get out.'",
				choices: [
					{ text: "Breach the Armory (Boss Fight)", nextScene: 'coral_hulk_intro', type: 'travel' }
				]
			},

			// --- BOSS: THE CORAL HULK ---

			'coral_hulk_intro': {
				title: "The Coral-Hulk",
				text: "You step into the corrupted chamber. A Royal Guard Dreadnoughtmassive steam armorbut it is fused with white coral. The organic matter pulses, knitting metal back together. It roars, a wet, grinding sound.",
				isBoss: true,
				choices: [
					{ 
                        text: "Engage the Monstrosity", 
                        nextScene: 'coral_hulk_combat', 
                        type: 'action', 
                        action: (state) => {
                            initCombat("Coral-Hulk", 80, [6, 12]); 
                            return "Combat Started! The enemy regenerates 5 HP per round.";
                        },
                        doomCost: 0 
                    }
				]
			},

			'coral_hulk_combat': {
				title: "Battle: Coral-Hulk",
				text: "The Hulk swings a massive, coral-encrusted fist. At the end of every moment, you see its wounds closing. You must out-damage its regeneration!",
				isBoss: true,
				choices: [],
                onEnter: (state) => {
					const buttons = window.generateCombatChoices(state);
					scenes['coral_hulk_combat'].choices = buttons;
					return null;
				}
			},

			'coral_hulk_victory': {
				title: "Victory: The Hulk Crumbles",
				text: "The Coral-Hulk collapses, the regenerative biology finally overwhelmed by your assault. The room is silent.",
				journal: "Defeated the Coral-Hulk. The corruption is halted in this sector.",
				onEnter: (state) => {
					state.coralHulkDefeated = true;
					if (state.factionAligned === 'order') {
						if (!state.inventory.includes("Mirror Shield")) state.inventory.push("Mirror Shield");
						return "Victory! Reward: Mirror Shield. Defense +1.";
					} else {
						if (!state.inventory.includes("Scale-Stake Driver")) state.inventory.push("Scale-Stake Driver");
						return "Victory! Reward: Scale-Stake Driver.";
					}
				},
				choices: [
					{ 
						text: "Claim Reward & Return to Hub", 
						type: 'action',
						action: (state) => {
							const target = state.factionAligned === 'order' ? 'hub_order' : 'hub_chaos';
							renderScene(target);
						}
					}
				]
			},
            'sanguine_spire_entry': {
				title: "The Sanguine Spire",
				text: "The sheer stone spire rises out of the ocean like a dagger. It is capped by a gothic cathedral, pulsing with a deep, red light. This is the seat of the <span class='text-blood'>Sanguine Court</span>.<br><br>The waves crashing against the base are thick with blood.",
				onEnter: (state) => {
					state.currentLocation = 'spire';
					return "The Spire is heavily defended. Brace for combat.";
				},
				banter: {
					'talon': "I see movement on the parapets. Snipers. Keep your heads down.",
					'gareth': "Let them look. We didn't come this far to sneak in the back door. Draw steel."
				},
				choices: [
					{ text: "Confront the Court", nextScene: 'sanguine_spire_combat', type: 'combat', doomCost: 0 },
					{ text: "Return to Sea Map", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
				]
			},
            'sanguine_spire_combat': {
				title: "The Sanguine Court",
				text: "You enter the cathedral. Three <span class='text-danger'>Vampire Elders</span> descend from the vaulted ceiling. They move with blurring speed, their claws dripping with ancient rot.<br><br>The <span class='text-item'>Sword of Valor</span> hums violently in your handit knows this blood. Silas steps forward, shield raised. Blink growls, phasing in and out. This is the end.",
				journal: "Confronted the Vampire Elders. The final battle.",
				isBoss: true,
				choices: [
					{ 
                        text: "Engage the Horde", 
                        nextScene: 'spire_combat_loop', 
                        type: 'action', 
                        action: (state) => {
                            initHordeCombat("Vampire Elder", 35, [4, 7], 3); 
                            return "Combat Started! Three Elders attack per round.";
                        },
                        doomCost: 0 
                    }
				]
			},

            // 2. THE HORDE COMBAT LOOP
			// 2. THE HORDE COMBAT LOOP
			'spire_combat_loop': {
				title: "Battle: Vampire Elders",
				text: "",
				isBoss: true,
				choices: [], 
				
				onEnter: (state) => {
					// --- 1. SET DYNAMIC TEXT ---
					if (state.activeEnemies.length === 1) {
						scenes['spire_combat_loop'].text = `Only the last Elder remains! The veil is torn openenter the Ethereal Plane to strike them with <span class='text-spectral'>Force Damage</span>.`;
					} else if (state.activeEnemies.length > 1) {
						scenes['spire_combat_loop'].text = `Two Elders remain! They phase in and out, gaining <span class='text-danger'>30% Evasion</span>. Use Blink or Plane Walk to guarantee strikes.`;
					} else {
						scenes['spire_combat_loop'].text = `Three Elders remain!`;
					}
					
					// --- 2. BUILD CHOICES (Updated for Unified Engine) ---
					let dynamicChoices = [];
					
					// A. ATTACK (Unified Attack Button)
                    // The new engine automatically targets the first available Elder
                    if (state.inventory.includes('Sword of Valor')) {
                        dynamicChoices.push({
                            text: `Valor Strike (Target Horde)`,
                            action: () => window.attackEnemy('standard'),
                            type: 'action',
                            customClass: 'btn-hero'
                        });
                    } else {
                        dynamicChoices.push({
                            text: `Heavy Strike (Target Horde)`,
                            action: () => window.attackEnemy('standard'),
                            type: 'action'
                        });
                    }
					
					// B. ALLY COMMANDS
					if (state.companions.silas.joined) dynamicChoices.push({ text: "Command Silas (Intercept)", type: 'action', action: () => window.allyCommand('silas'), doomCost: 0 });
					if (state.companions.blink.joined) dynamicChoices.push({ text: "Command Blink (Phase Shift)", type: 'action', action: () => window.allyCommand('blink'), doomCost: 0 });
					
					// C. AOE/ITEM ACTIONS (Unified resolveCombatRound)
					if (state.inventory.includes('Holy Water')) dynamicChoices.push({ text: "Throw Holy Water (AOE)", action: () => window.resolveCombatRound('item_holy_water'), type: 'action', reqItem: 'Holy Water', consume: true, customClass: 'btn-success-glow' });
					if (state.inventory.includes('Alchemical Fire')) dynamicChoices.push({ text: "Throw Alchemical Fire (AOE)", action: () => window.resolveCombatRound('item_fire'), type: 'action', reqItem: 'Alchemical Fire', consume: true, customClass: 'btn-fire-glow' });
					if (state.inventory.includes('Sun-Star Grenade')) dynamicChoices.push({ text: "Throw Sun-Star (AOE Stun)", action: () => window.resolveCombatRound('item_sun_star'), type: 'action', reqItem: 'Sun-Star Grenade', consume: true, customClass: 'btn-fire-glow' });

					// D. STUN/CC
					if (state.inventory.includes('Flash Powder')) dynamicChoices.push({ text: "Throw Flash Powder (Stun/Skip)", action: () => window.resolveCombatRound('item_flash'), type: 'action', reqItem: 'Flash Powder', consume: true });
					if (state.inventory.includes('Scale-Stake Driver')) dynamicChoices.push({ text: "Fire Stake Driver (Stun)", action: () => window.resolveCombatRound('item_stake_driver'), type: 'action', reqItem: 'Scale-Stake Driver', customClass: 'btn-fire-glow' });

					// E. HEALING
					if (state.inventory.includes('Vitality Tincture')) {
						dynamicChoices.push({ 
							text: "Drink Vitality Tincture (Heal)", 
							type: 'action',
							reqItem: 'Vitality Tincture',
							consume: true,
							action: (state) => {
								state.currentHP = Math.min(state.maxHP, state.currentHP + 15); 
								// Trigger enemy turn immediately after healing
                                window.enemyTurn();
								return "Drank Tincture. Healed 15 HP.";
							} 
						});
					}
					
					// F. PLANAR TOGGLE
					dynamicChoices.push({
						 text: `Toggle Ethereal Plane (Now: ${state.isEthereal ? 'Ethereal' : 'Material'})`,
						 type: 'action',
						 action: () => window.gameFunctions.togglePlaneWalk(),
						 customClass: 'btn-planewalk-reveal',
						 doomCost: 0
					});

					scenes['spire_combat_loop'].choices = dynamicChoices;

					return "Combat Round Rendered.";
				}
			},

            // 3. VICTORY
			// Final Spire Victory Scene (Leads to Mandatory Rest)
            'spire_victory': {
                title: "Victory: The Core Fragment",
                text: "The last Elder shrieks as it crumbles to dust. The **Rift Core Fragment**a splinter of violet light, the final piece of your soulfloats free. You grasp it. The voices of your crew surge, demanding you return the fragment to the Manor's Anchor and finish the mission.",
                journal: "Defeated the Vampire Elders. Acquired the Rift Core Fragment. I must return it to the Manor's Anchor.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Rift Core Fragment")) {
                         state.inventory.push("Rift Core Fragment"); 
                    }
                    return "Fragment Secured. The final decision awaits at the Wolf King's Estate.";
                },
                choices: [
                    { 
                        text: "Sail Back to Port of Shadows", 
                        nextScene: 'post_spire_rest', 
                        type: 'travel',
                        customClass: 'btn-hero' 
                    }
                ]
            },

            // The Manor Safe House/Final Climax Trigger Scene
            'wolf_estate_safe': {
                title: "Wolf King's Estate (Safe House)",
                text: "",
                isRest: true,
                onEnter: (state) => {
                    const baseChoices = [
                         { text: "Take a Long Rest", nextScene: 'act3_long_rest', type: 'action', doomCost: 0 },
                         { text: "Wander the Halls", nextScene: 'manor_foyer_safe', type: 'travel', customClass: 'btn-planewalk-reveal', doomCost: 0 },
                         { text: "Exit to Port Square (Material)", nextScene: 'town_square', type: 'action', action: (state) => { state.isEthereal = false; state.act2Started = false; return "Returning to the Material Plane."; }, doomCost: 0 }
                    ];

                    // Check for the final objective trigger (Fragment present and Ethereal status active)
                    if (state.inventory.includes("Rift Core Fragment") && state.isEthereal) {
                        scenes['wolf_estate_safe'].text = "You stand in the Grand Foyer, holding the **Rift Core Fragment**. The entire Vanishing Manor is vibrating violently, urging you toward the Anchor at the top of the Penrose Staircase. The final act begins.";
                        
                        scenes['wolf_estate_safe'].choices = [
                            { 
                                text: "Approach the Anchor (Final Choice)", 
                                nextScene: 'anchor_decision_point', 
                                type: 'travel', 
                                customClass: 'btn-shadow-glow',
                            },
                            { text: "Take a Long Rest", nextScene: 'act3_long_rest', type: 'rest', doomCost: 0 }
                        ];
                        return "The final piece is in your hand. The Anchor calls.";
                    }
                    
                    // Normal rest scene logic if fragment isn't found or Ethereal not active
                    scenes['wolf_estate_safe'].text = "The Manor is sealed in the spectral echo. Here, the planar barriers are reinforced. You are safe. The old halls of the estate stretch out behind you, silent and frozen in memory.";
                    scenes['wolf_estate_safe'].choices = baseChoices;
                    
                    if (state.currentHP < state.maxHP) {
                        state.currentHP = state.maxHP;
                        return "HP Restored upon entering Safe House.";
                    }
                    return null;
                }
            },
			
			'manor_foyer_safe': {
                title: "The Grand Foyer",
                text: "The Grand Foyer is silent. The floating staircase hangs motionless in the void, and dust motes dance in the light of your Spectral Lantern.",
                onEnter: (state) => {
                    state.tetherTimer = 0;
                    return "Exploring the Manor.";
                },
                choices: [
                    { text: "Enter Library (West)", nextScene: 'manor_library_safe', type: 'travel', doomCost: 0 },
                    { text: "Enter Kitchens (East)", nextScene: 'manor_kitchens_safe', type: 'travel', doomCost: 0 },
                    { text: "Enter Grand Hall (North)", nextScene: 'manor_hall_safe', type: 'travel', doomCost: 0 }, // Ensure this is _safe
                    { text: "Return to Safe House", nextScene: 'wolf_estate_safe', type: 'travel', doomCost: 0 }
                ]
            },

            'manor_library_safe': {
				title: "The Warden's Library",
				text: "Quinn has occupied the central desk. He is surrounded by floating tomes, cross-referencing the ship's logs with ancient star charts. 'The patterns are clearer here, Captain. The flow of history is... liquid.'",
				banter: {
					'quinn': "If you bring me dataLore Fragments, old mapsI can compile a Codex for you. But I need time."
				},
				choices: [
					{ 
						text: "Research with Quinn", 
						nextScene: 'library_research_logic',
						type: 'skill',
						skill: 'History',
						dc: 14,
						reqNotItem: 'Codex of Tides',
						reqNotFlag: 'quinnResearched'
					},
					{ 
						text: "Recover Blueprint", 
						type: 'action', 
						reqNotItem: 'Manor Blueprint',
						action: (state) => {
							state.inventory.push("Manor Blueprint");
							return "Found the Manor Blueprint.";
						}
					},
					{ text: "Check Crawlspace (Talon)", nextScene: 'manor_crawlspace_safe', type: 'travel', doomCost: 0 },
					{ text: "Return to Foyer", nextScene: 'manor_foyer_safe', type: 'travel', doomCost: 0 }
				]
			},
			'library_research_logic': {
				isLogic: true,
				resolve: (roll, state) => {
					state.quinnResearched = true; // Limits to once per Long Rest
					return roll >= 14 ? 'library_research_success' : 'library_research_fail';
				}
			},
			'library_research_success': {
				title: "The Codex of Tides",
				text: "Quinn's eyes light up. 'The intersection of Void and Salt... wait.' He pulls a loose brick from the wall. 'A hidden switch. It opens the Cellar beneath the Crawlspace.'",
				onEnter: (state) => {
					state.inventory.push("Codex of Tides");
					state.cellarUnlocked = true; // UNLOCK FLAG
					return "Acquired: Codex of Tides. Cellar Unlocked.";
				},
				choices: [{ text: "Back to Library", nextScene: 'manor_library_safe', type: 'travel' }]
			},
			'library_research_fail': {
				title: "Dead End",
				text: "Quinn sighs, frustrated. 'The data is contradictory. I need more time.'",
				choices: [{ text: "Back to Library", nextScene: 'manor_library_safe', type: 'travel' }]
			},

			'manor_crawlspace_safe': {
				title: "The Rat's Nest",
				text: "Talon has made a home in the ventilation network. It is dark, tight, and smells of oil. He is dismantling a clockwork mechanism. 'The walls are full of treasure, Edward. You just have to know where to pry.'",
				choices: [
					{ 
						text: "Scavenge the Walls", 
						nextScene: 'talon_scavenge_logic', 
						type: 'action', 
						reqNotFlag: 'talonScavenged', // Reset this on Long Rest
						customClass: 'btn-keen-senses'
					},
					{ 
						text: "Rescue/Visit Blink", 
						type: 'action', 
						reqNotFlag: 'hasBlinkSkill',
						action: (state) => {
							state.companions.blink.joined = true;
							state.hasBlinkSkill = true;
							return "Companion Gained: Blink.";
						},
						customClass: 'spectral-active'
					},
					{ 
						text: "Enter Hidden Cellar", 
						nextScene: 'manor_cellar_puzzle', 
						type: 'travel', 
						reqFlag: 'cellarUnlocked', // CONDITIONAL BUTTON
						customClass: 'btn-pulse'
					},
					{ text: "Crawl to Library", nextScene: 'manor_library_safe', type: 'travel', doomCost: 0 },
					{ text: "Crawl to Kitchens", nextScene: 'manor_kitchens_safe', type: 'travel', doomCost: 0 }
				]
			},
			'talon_scavenge_logic': {
				isLogic: true,
				resolve: (roll, state) => {
					state.talonScavenged = true;
					const rng = Math.random();
					
					if (rng > 0.8) {
						state.inventory.push("Strange Coin");
						return 'talon_scavenge_rare';
					} else if (rng > 0.4) {
						state.inventory.push("Brass Gears");
						return 'talon_scavenge_gears';
					} else {
						state.supplies += 2;
						return 'talon_scavenge_food';
					}
				}
			},
			'talon_scavenge_gears': {
				title: "Scrap Harvest",
				text: "Talon tosses you a bag of heavy <span class='text-item'>Brass Gears</span>. 'Citadel Quartermaster pays well for these. Or Bones can melt them down.'",
				choices: [{ text: "Back to Crawlspace", nextScene: 'manor_crawlspace_safe', type: 'travel' }]
			},
			'talon_scavenge_rare': {
				title: "A Glimmer in the Dark",
				text: "Talon holds up a <span class='text-item'>Strange Coin</span>. 'Old currency. Someone hid it well.'",
				choices: [{ text: "Back to Crawlspace", nextScene: 'manor_crawlspace_safe', type: 'travel' }]
			},
			'talon_scavenge_food': {
				title: "Rat Rations",
				text: "Talon hands you some dried meat. Best not to ask where it came from.",
				onEnter: (state) => "Gained +2 Supplies.",
				choices: [{ text: "Back to Crawlspace", nextScene: 'manor_crawlspace_safe', type: 'travel' }]
			},
			'manor_cellar_puzzle': {
				title: "The Brass Circuit",
				text: `You descend into a small, sealed room. On the wall is a brass mechanism with three numbered nodes. It hums with broken energy.<br><br>
				<div class="text-center text-amber-500 mb-2">Sequence Required:</div>
				<div class="circuit-panel">
					<div class="circuit-node" data-value="1">1</div>
					<div class="circuit-node" data-value="2">2</div>
					<div class="circuit-node" data-value="3">3</div>
				</div>
				<div id="circuit-message" class="text-xs text-gray-500 h-4">Input Sequence...</div>`,
				journal: "Found a sealed room beneath the crawlspace. Some kind of brass logic-lock guards it. Quinn is practically drooling over the mechanism.",
                banter: {
                    'quinn': "Fascinating! It's a tri-state voltage gate. Don't force it. One, then Three, then Two...",
                    'talon': "Just smash it. Gears break like bones."
                },
				choices: [
					{ text: "Give Up (Return)", nextScene: 'manor_crawlspace_safe', type: 'travel' }
				]
			},
			'manor_cellar_success': {
				title: "Circuit Stabilized",
				text: "The mechanism clicks with a satisfying, heavy thud. Pneumatic tubes hiss, and a heavy compartment slides open. Inside, pristine <span class='text-item'>Brass Gears</span> rest on velvetcomponents stripped from the Wolf King's own clockwork soldiers.",
                journal: "Cracked the lock. Found a cache of pristine gears. These are worth a fortune to the right Quartermaster.",
				onEnter: (state) => {
					 return "Puzzle Solved.";
				},
				choices: [
					{ text: "Take Gears & Return", nextScene: 'manor_crawlspace_safe', type: 'travel' }
				]
			},
			

            'manor_hall_safe': {
				title: "The Grand Hall",
				text: "The wreckage of the Brass Sentinel lies in a heap. The Penrose Staircase spins slowly in the distance.",
				choices: [
					{ 
						text: "Scavenge the Mimic Carcass (Mimic's Bile)", 
						type: 'action', 
						reqNotItem: "Mimic's Bile",
						reqNotFlag: 'hallLooted',
						action: (state) => {
							state.inventory.push("Mimic's Bile");
							state.hallLooted = true;
							return "You find the dead Mimic. You extract the Bile from its gland.";
						}
					},
					{ text: "Return to Foyer", nextScene: 'manor_foyer_safe', type: 'travel', doomCost: 0 } // Point to _safe
				]
			},

            'manor_kitchens_safe': {
				title: "The Ghost Kitchens",
				text: "The spectral fires still burn in the hearth, fueled by memory. This fire is cold, but it has the power to change things. The spectral light is perfect for fusing artifacts.",
				choices: [
					{ 
						text: "Approach Spectral Forge", 
						nextScene: 'manor_forge',
						type: 'travel', 
						customClass: 'btn-lantern-glow'
					},
					{ text: "Enter Crawlspace (To Library)", nextScene: 'manor_crawlspace_safe', type: 'travel', doomCost: 0 },
					{ text: "Return to Foyer", nextScene: 'manor_foyer_safe', type: 'travel', doomCost: 0 }
				]
			},
			
            'act3_long_rest': {
				title: "A Deep Respite",
				text: "You collapse into a spectral hammock. The Manor resets itself around you.",
				isRest: true,
				onEnter: (state) => {
					state.currentHP = state.maxHP;
					Object.keys(state.crew).forEach(k => state.crew[k].used = false);
					
					// RESET DAILY FLAGS
					state.talonScavenged = false;
					state.quinnResearched = false;
                    
                    // FORCE REFRESH
                    setTimeout(() => updateUI(), 50);
					
					return "HP Restored. Crew Rested. Manor Activities Reset.";
				},
				choices: [{ text: "Awaken", nextScene: 'wolf_estate_safe', type: 'travel', doomCost: 0 }]
			},
			'sea_sanguine_tithe_event': {
				title: "The Sanguine Tithe",
				text: "A sleek black schooner flies the flag of the Sanguine Court. It intercepts a Citadel transport ship. The Vampires aren't attacking; they are boarding peacefully. <br><br>Through your spyglass, you see Citadel officers handing over chained prisoners to the vampires. A transaction. 'A tithe,' Silas whispers, disgusted. 'Lives for a ceasefire.'",
				banter: {
					'silas': "This is the rot at the heart of the Order. We cannot let them take those people.",
					'quinn': "Interfering breaks the truce. The Citadel will fire on us too."
				},
				choices: [
					{ 
						text: "Unleash Silas (Vengeance)", 
						nextScene: 'silas_reckoning_logic', 
						type: 'dialogue',
						reqFlag: 'silasJoined',
						customClass: 'btn-fire-glow'
					},
					{ 
						text: "Intervene (Naval Combat)", 
						nextScene: 'tithe_combat', 
						type: 'combat',
						orderGain: 5, // Order respects strength/saving lives, even if command hates it
						chaosGain: 5  // Breaking the law/truce
					},
					{ 
						text: "Exploit Distraction (Loot)", 
						nextScene: 'tithe_loot', 
						type: 'skill', 
						dc: 14, 
						skill: 'Perception',
						chaosGain: 2
					},
					{ text: "Sail Past", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
				]
			},
			
			// --- SILAS RECKONING ARC ---
			'silas_reckoning_logic': {
				title: "Silas's Reckoning",
				text: "Silas snarls, his eyes fixed on the Priest. 'That is a Tithe Priest, Captain. The vermin who administered the Blood Tithe to my King. They do not get to live in my sight.'",
				choices: [
					{ 
						text: "Provide Tactical Cover (Use Beast Whistle)", 
						nextScene: 'silas_reckoning_success', 
						type: 'action', 
						reqItem: 'Beast Whistle',
						consume: true,
						customClass: 'btn-keen-senses'
					},
					{ 
						text: "Provide Raw Cover (Engage Combat)", 
						nextScene: 'silas_reckoning_combat', 
						type: 'combat', 
						doomCost: 0
					},
					{ text: "Hold Silas Back", nextScene: 'sea_map_hub', type: 'travel', doomCost: 0 }
				]
			},
			
			'silas_reckoning_success': {
				title: "The Assassin's Strike (Flawless)",
				text: "You sound the **Beast Whistle**. The nearby werewolf thralls snap to attention, abandoning their posts. Silas uses the split second to leap the gap, driving his knife through the priest's throat. It is a clean, precise act of vengeance.",
				journal: "Silas's vengeance achieved! He gains permanent skill bonus against Vampires.",
				onEnter: (state) => {
					state.silasVengeanceActive = true; 
					state.influence = Math.max(-50, state.influence - 5); // Order likes the death of a vampire priest
					return "Silas's Vengeance: Intercept Cooldown is reduced vs. Vampires. Order +5.";
				},
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			
			'silas_reckoning_combat': {
				title: "Vengeance by Blood (Costly)",
				text: "Silas screams and leaps across the gap. You draw steel and leap after him. The Priest and one thrall fight back, but Silas is a whirlwind of disciplined fury. He slays them both, taking a hit but refusing to fall.",
				journal: "Silas achieved vengeance, but took damage.",
				onEnter: (state) => {
					state.currentHP = applyDamage(state.currentHP, 3); // Guaranteed, low damage
					fxManager.flashRed();
					state.silasVengeanceActive = true; 
					state.influence = Math.min(50, state.influence + 2); // Chaos likes the unsanctioned violence
					return "Silas's Vengeance: Took 3 DMG. Intercept Cooldown reduced vs. Vampires. Chaos +2.";
				},
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			
			// --- END SILAS RECKONING ARC ---
			
			'tithe_combat': {
				title: "Blood on the Water",
				text: "You ram the Vampire schooner. The transport captain panics and flees, leaving the prisoners behind. You cut down the vampire envoy, but the truce is shattered.",
				onEnter: (state) => {
					// Combat resolution simulation
					state.currentHP = Math.max(1, state.currentHP - 8);
					if (!state.inventory.includes("Deep-Iron Ingot")) {
						state.inventory.push("Deep-Iron Ingot"); // Reward
					}
					return "Battle Won. Took 8 DMG. Found Deep-Iron Ingot on the Vampire.";
				},
				choices: [{ text: "Sail On", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			'tithe_loot': {
				isLogic: true,
				resolve: (roll) => roll >= 14 ? 'tithe_loot_success' : 'tithe_loot_fail'
			},
			'tithe_loot_success': {
				title: "War Profiteering",
				text: "While they exchange prisoners, you grapple the blind side of the transport. You steal a crate marked 'High Command'.",
				onEnter: (state) => {
					state.shillings += 25;
					if (!state.inventory.includes("Royal Signet Ring")) state.inventory.push("Royal Signet Ring");
					return "Stole 25s and a Royal Signet Ring.";
				},
				choices: [{ text: "Slip Away", nextScene: 'sea_map_hub', type: 'travel' }]
			},
			
            'post_spire_rest': {
                title: "A Final Respite",
                text: "The sheer exhaustion of the fight hits you. You order the ketch to drift, and collapse onto the deck. The crew's fragments hum softly, knitting your wounds together. This is the calm before the final decision.",
                journal: "Took mandatory rest after defeating the Elders. Preparing for the final mission.",
                isRest: true,
                onEnter: (state) => {
                    if (state.currentHP < state.maxHP) state.currentHP = state.maxHP;
                    state.currentHP = Math.min(state.currentHP, state.maxHP); // Clear any overheal from Act 1
                    Object.keys(state.crew).forEach(k => k.used = false);
                    // Ensure Ethereal status is off for the Port
                    state.isEthereal = false;
                    document.body.classList.remove('plane-ethereal'); 
                    return "Full HP and Crew Restored. Status effects cleared.";
                },
                choices: [
                    { text: "Head to Port of Shadows", nextScene: 'town_square', type: 'travel', doomCost: 0 }
                ]
            },
            
            'citadel_reaction_logic': {
                title: "The Relief and the Reckoning",
                text: "The Commandant, tears in his eyes, thanks you for ending the Sanguine Tithe. 'They tried to contact us,' he says, 'but the Court is silent. The debt is cancelled! But, Marinerthe white growth on the walls... it's receding. It's too fast. What have you done?'",
                journal: "The Citadel is free from the Vampire Tithe, but panicked by the sudden collapse of the Hyper-Coral plague.",
                choices: [
                    { text: "Return to Port", nextScene: 'town_square', type: 'travel' }
                ]
            },
            
            'silas_final_words': {
                title: "The Seneschal's Peace",
                text: "Silas unhooks his shield and lays it gently on the rail. His eyes are clear. 'The architects of the Blood Tithe are dust. My King is avenged.' He turns to you, his expression grim. 'But the crew... and you. That Fragment in your hand is the lock, Captain. **The crew fears it will free them, only to destroy you.** Be ready to make your peace with the Abyss.'",
                journal: "Silas found peace and warned me about the final decision. The crew is scared of the final consequences.",
                choices: [
                    { text: "Return to Port", nextScene: 'town_square', type: 'travel' }
                ]
            },

            'anchor_decision_point': {
                title: "The Final Anchor",
                text: "You stand before the Manor's Anchor, holding the **Rift Core Fragment**. The entire Vanishing Manor is vibrating violently, urging you toward the empty socket.<br><br>As the Fragment approaches, the planar chaos that has plagued the city begins to recede. The Hyper-Coral is starving. Your final choice is the fate of the world.",
                journal: "The Rift Core is back in the Anchor. I must choose the fate of the Leviathan and my soul.",
                choices: [
                    { 
                        text: "Reseal the Abyss (Maintain the Wolf King's Cage)", 
                        nextScene: 'ending_protector', 
                        type: 'action',
                        customClass: 'btn-hero',
                        consumeItems: ['Rift Core Fragment'],
                        action: (state) => {
                            // Order Path: Restore balance, lose planar power
                            state.influence = -50;
                            renderScene('ending_protector');
                        }
                    },
                    { 
                        text: "Become the Mariner of the Damned (Shatter the Cage)", 
                        nextScene: 'ending_champion', 
                        type: 'action',
                        customClass: 'btn-shadow-glow',
                        consumeItems: ['Rift Core Fragment'],
                        action: (state) => {
                            // Chaos Path: Embrace chaos, gain permanent power
                            state.influence = 50;
                            renderScene('ending_champion');
                        }
                    }
                ]
            },

            'ending_champion': {
                title: "The Mariner of the Damned",
                text: "You grasp the Rift Core Fragment and force it not into your chest, but into the hand that holds the Compass. The Compass shatters, replaced by a crystalline heart pulsing with abyssal light. The voices of your crew surge one final time, not in agony, but in awe, before becoming one voice: **Yours**.<br><br>You feel the Leviathan's chaotic, immense energy flow into your veins. You are no longer Edward Jones; you are the **Mariner of the Damned**, ready to command the eternal shadow.",
                journal: "I took the power of the Abyss. The Leviathan is my master, and my crew is my own, fused soul. I am the Mariner of the Damned.",
                banter: {
                    'gareth': "I salute the new Captain of the Abyss! We chose power, Edward. Never look back.",
                    'quinn': "The math has fractured! The logic is chaos! But... the utility is infinite.",
                    'talon': "The pack runs free, Captain. We are unbound. The hunt is eternal.",
                    'bones': "The sickness of the world is now the strength of your soul. A bitter cure, but effective."
                },
                choices: [
                    { text: "The Abyss Awaits (End Game)", type: 'reset', customClass: 'btn-fire-glow' }
                ]
            },
            
            'ending_protector': {
                title: "The Wolf King's Successor",
                text: "You take the Rift Core Fragment and smash it against the Sanguine Altar. The crystalline shard shatters, and the voices of your crewGareth, Quinn, Talon, and Bonesspeak to you clearly, thanking you, before they **dissolve into the pale light of a true afterlife**.<br><br>Your soul snaps whole. The planar tether is broken. The sky clears instantly. The Leviathan is stripped of its chaotic influence, trapped and contained forever beneath the spire, and the curse is broken. You are Edward Jones, and you are finally free.",
                journal: "I destroyed the Rift Core Fragment. The crew found peace, and my soul is whole. The Leviathan is caged. I am free.",
                banter: {
                    'gareth': "Dismissed, Mariner. You held the line. That's all that ever mattered.",
                    'quinn': "The variables are stable. Our existence is confirmed. Thank you for the ride, Captain.",
                    'talon': "The hunt is over. I can finally rest. Thank you, brother.",
                    'bones': "The wounds are healed, Edward. Go live the life we couldn't."
                },
                choices: [
                    { text: "Return to Shore (End Game)", type: 'reset', customClass: 'btn-hero' }
                ]
            },

            'edward_death': {
                title: "The Mariner's End",
                text: "The voices fall silent, only to surge back in a deafening, cold chorus that rips through your mind. The debt is paid. The Planar Storm claims its last crewman, pulling you into the abyss. You feel the crushing presence of the Leviathan one final time.",
                journal: "Edward Jones is lost to the deep. The voices of the damned are finally silenced.",
                choices: [
                    { 
                        text: "Awaken (Restart Game)", 
                        type: 'reset',
                        customClass: 'btn-hero',
						doomCost: 0
                    }
                ]
            }
        };

        // --- DAMAGE CALCULATION LOGIC ---
		function applyDamage(currentHP, damageAmount, damageType = 'physical') {
			let finalDamage = damageAmount;
			
			// 1. Gareth Act 2 Boon: Iron Will (Psychic Damage Reduction)
			if (damageType === 'psychic' && gameState.activeBoons.includes('iron_will')) {
				finalDamage = Math.max(0, finalDamage - 2);
				addToHistory("Iron Will reduced Psychic damage.", 'system');
			}

			// 2. Bones Act 3 Boon: Alchemical Resistance (Half Poison/Acid)
			if ((damageType === 'poison' || damageType === 'acid') && gameState.activeBoons.includes('chemical_resist')) {
				finalDamage = Math.floor(finalDamage / 2);
				addToHistory("Alchemical Resistance halved the damage.", 'system');
			}

            // 3. Spyglass / Watchman's Lens Passive (Order Reduction)
            if (gameState.inventory.includes("Salt-Warped Spyglass") && gameState.influence <= -15) {
                if (finalDamage > 0) {
                    finalDamage = Math.max(0, finalDamage - 1);
                    addToHistory("Passive (Watchman's Lens): Damage reduced by 1.", 'system');
                }
            }
            
            // 4. Silas Negation (Ally ability)
            if (gameState.negateNextDamage) {
                finalDamage = 0;
                gameState.negateNextDamage = false; 
                addToHistory("Silas intercepted the attack! Damage negated.", 'system');
            }

            let finalHP = Math.max(0, currentHP - finalDamage);
			
			// 5. Gareth Act 3 Boon: Hold The Line (Death Defiance)
			// This check must happen AFTER damage calculation but BEFORE the final return
			if (finalHP === 0 && gameState.activeBoons.includes('hold_the_line') && !gameState.holdTheLineUsed) {
				finalHP = 1;
				gameState.holdTheLineUsed = true;
				addToHistory("HOLD THE LINE! Gareth's tenacity keeps you at 1 HP.", 'danger');
			}
            
            // 6. Phoenix Draft (Last Resort)
            if (finalHP === 0) {
                const phoenixIndex = gameState.inventory.indexOf("Phoenix Draft");
                if (phoenixIndex > -1) {
                    gameState.inventory.splice(phoenixIndex, 1);
                    finalHP = 10;
                    addToHistory(`*The Phoenix Draft shatters, pulling you back from the abyss! Restored 10 HP.*`, 'system');
                    fxManager.flashRed();
                }
            }

            return Math.max(0, finalHP);
        }
        window.applyDamage = applyDamage;

        // --- STOCK INITIALIZATION ---
        // Ensure stock is defined even if not loaded from save
        if (!scenes['market_stall'].stock) {
            scenes['market_stall'].stock = { "Healing Potion": 1, "Rope": 1, "Torch": 1, "Curious Cargo": 1, "Rum": 1 };
        }
        if (!scenes['alchemist_triage'].stock) {
            scenes['alchemist_triage'].stock = { "Vitality Tincture": 2, "Smelling Salts": 3, "Flash Powder": 1, "Alchemical Fire": 1, "Holy Water": 1 };
        }
        if (!scenes['blackwater_tavern'].stock) {
            scenes['blackwater_tavern'].stock = { "Gruel": 5 };
        }
        
        async function generateSceneImage(sceneId) {
            const key = sceneId || 'default';
            const url = sceneImages[key] || sceneImages['default'];
            
            const imgEl = document.getElementById('scene-image');
            const loader = document.getElementById('image-loader');
            
            // --- FIX: PREVENT FLASHING ---
            // Only reload if the source URL is actually different
            if (imgEl.src && imgEl.src.includes(url)) {
                return; 
            }
            // -----------------------------
            
            // Show loader and hide image immediately
            imgEl.style.opacity = 0;
            loader.style.display = 'flex';
            imgEl.src = '';

            const tempImg = new Image();
            tempImg.src = url;

            tempImg.onload = () => {
                imgEl.src = url;
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };

            tempImg.onerror = () => {
                imgEl.src = sceneImages['default'];
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };
        }

        async function init() {
            window.confirmReset = confirmReset;
            window.resetGame = resetGame; 
            // allyCommand is attached to window below

            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    user = u;
                    await setupRealtimeListener();
                    document.getElementById('app-loading').classList.add('fade-out');
                    setTimeout(() => {
                        const el = document.getElementById('app-loading');
                        if(el) el.remove();
                    }, 500);
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        async function setupRealtimeListener() {
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            
            try {
                const snap = await getDoc(docRef);
                if (!snap.exists()) {
                    await setDoc(docRef, gameState);
                    window.renderScene('prologue_storm');
                } else {
                    const data = snap.data();
                    if (data.influence === undefined) data.influence = 0; 
                    
                    const savedState = { ...createInitialState(), ...data }; 
                    gameState = savedState;
                    
                    // Restore Stock
                    if (data.market_stall_stock) scenes['market_stall'].stock = data.market_stall_stock;
                    if (data.alchemist_triage_stock) scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                    if (data.blackwater_tavern_stock) scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;

                    if (gameState.isEthereal) document.body.classList.add('plane-ethereal');
                    
                    window.renderScene(gameState.currentSceneId, false);
                    window.rebuildJournal();
                }
            } catch (e) {
                console.error("Save error", e);
                // Delay render slightly and use window.renderScene for safety
                setTimeout(() => { window.renderScene('prologue_storm'); }, 50);
            }

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (JSON.stringify(data) !== JSON.stringify(gameState)) {
                        
                        if (data.market_stall_stock) {
                            scenes['market_stall'].stock = data.market_stall_stock;
                            delete data.market_stall_stock;
                        }
                        if (data.alchemist_triage_stock) {
                            scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                            delete data.alchemist_triage_stock;
                        }
                        if (data.blackwater_tavern_stock) {
                            scenes['blackwater_tavern'].stock = data.blackwater_tavern_stock;
                            delete data.blackwater_tavern_stock;
                        }

                        gameState = { ...gameState, ...data };
                        
                        if (gameState.isEthereal) document.body.classList.add('plane-ethereal');
                        else document.body.classList.remove('plane-ethereal');
                        
                        window.updateUI();
                    }
                }
            });
        }

        async function saveGame() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            const safeState = JSON.parse(JSON.stringify(gameState));
            
            safeState.market_stall_stock = scenes['market_stall'].stock;
            safeState.alchemist_triage_stock = scenes['alchemist_triage'].stock;
            safeState.blackwater_tavern_stock = scenes['blackwater_tavern'].stock;

            await setDoc(docRef, safeState);
        }

        let resetConfirmTimer = null;
        function confirmReset() {
            const btn = document.getElementById('reset-game-btn');
            if (btn.classList.contains('bg-red-900')) {
                resetGame();
                clearTimeout(resetConfirmTimer);
                btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                btn.classList.remove('bg-red-900', 'text-white');
                btn.classList.add('text-red-400', 'bg-black/60');
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Confirm?';
                btn.classList.remove('text-red-400', 'bg-black/60');
                btn.classList.add('bg-red-900', 'text-white');
                resetConfirmTimer = setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                    btn.classList.remove('bg-red-900', 'text-white');
                    btn.classList.add('text-red-400', 'bg-black/60');
                }, 3000);
            }
        }

        async function resetGame() {
            gameState = createInitialState();
            
            // Reset Stocks
            scenes['market_stall'].stock = { "Healing Potion": 1, "Rope": 1, "Torch": 1, "Curious Cargo": 1, "Rum": 0 };
            scenes['alchemist_triage'].stock = { "Vitality Tincture": 2, "Smelling Salts": 3, "Flash Powder": 1, "Alchemical Fire": 1, "Holy Water": 1 };
            scenes['blackwater_tavern'].stock = { "Gruel": 5 };
            
            const workBtn = scenes['town_docks'].choices.find(c => c.nextScene === 'docks_work');
            if (workBtn) workBtn.costHP = 2; 
            
            // Reset core flags
            gameState.isAbsorbCharged = false;
            gameState.isSurpriseRound = false;
            gameState.isRiftCollapse = false;
            gameState.act1Started = false;
            gameState.hasObservedGambler = false;
            gameState.hasSearchedSmugglerDrop = false;
            gameState.docksWorkCount = 0;
            gameState.quinnLogistics = false;
            gameState.isEthereal = false;
            gameState.hallLooted = false;
            gameState.hasBlinkSkill = false;
            gameState.act2Started = false;
            gameState.tetherTimer = 20;
            gameState.act3Started = false;
            gameState.shipName = "The Iron Lung";
            gameState.knownIslands = ['port_hub'];
            gameState.currentLocation = 'port_hub';
            gameState.supplies = 10;
            gameState.companions.silas.joined = false;
            gameState.silasJoined = false;

            document.getElementById('journal-container').classList.add('log-hidden');
            document.getElementById('journal-container').classList.remove('log-visible');
			
			document.getElementById('journal-content').innerHTML = '';
            await saveGame();
            renderScene('prologue_storm');
            rebuildJournal();
            document.getElementById('inf-status-text').textContent = "Unknown to all";
            document.getElementById('item-desc-area').textContent = "Hover over an item to inspect it.";
        }


		async function renderScene(sceneId, logText = true) {
            const scene = scenes[sceneId];
            
            if (!scene) return;
            
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }

            // --- 1. HANDLE RIFT COLLAPSE LOGIC ---
            if (gameState.doomTimer <= 0 && gameState.act1Started) {
                if (!gameState.isRiftCollapse && !gameState.hasLoggedCollapse) {
                    gameState.isRiftCollapse = true;
                    gameState.hasLoggedCollapse = true; 
                    
                    gameState.maxHP = Math.max(1, gameState.maxHP - 5);
                    gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);
                    
                    addToHistory(`!!! RIFT COLLAPSE !!! The veil has ruptured. All Skill Check DCs are permanently increased by 2. Max HP reduced by 5 due to toxic air.`, 'system');
                }
            }
            
            // --- 2. HANDLE TETHER FAILURE ---
            if (gameState.tetherTimer <= 0 && gameState.act2Started && sceneId !== 'act2_tether_fail') {
                 renderScene('act2_tether_fail');
                 return;
            }
           
            // --- 3. HANDLE VISUAL THEMES ---
            if (gameState.isEthereal) {
                document.body.classList.add('plane-ethereal');
            } else {
                document.body.classList.remove('plane-ethereal');
            }

            // --- 4. HANDLE LOGIC/ROLL SCENES ---
            if (scene.isLogic) {
                let roll;
                let logMsg = "";

                if (gameState.pendingRoll) {
                    // Use the roll calculated by the button animation
                    roll = gameState.pendingRoll.total;
                    logMsg = gameState.pendingRoll.log;
                    gameState.pendingRoll = null; // Clear it
                } else {
                    // Fallback: Calculate fresh if triggered without button (console/legacy)
                    roll = Math.floor(Math.random() * 20) + 1;
                    let crewUsedName = "None";
                    logMsg = `Check (DC ${gameState.lastDC || 10}): Rolled d20 (${roll})`;
                    
                    gameState.lastCrewUsedId = null;

                    if (activeCrewMember) {
                        const isSkilled = getBonusForSkill(activeCrewMember, gameState.lastSkillType);
                        const crewKey = activeCrewMember.id;
                        
                        if (isSkilled) { 
                            const dieSize = gameState.isEthereal ? 8 : (gameState.guidingDieSize || 4); 
                            const bonus = Math.floor(Math.random() * dieSize) + 1;
                            roll += bonus;
                            crewUsedName = activeCrewMember.name;
                            const dieLabel = gameState.isEthereal ? `(Spectral D8!)` : `(${crewUsedName})`;
                            logMsg += ` + <span class="${gameState.isEthereal ? 'text-spectral-d8' : ''}">${bonus}</span> ${dieLabel}`; 
                            
                            if (gameState.crewUseFree) {
                                addToHistory(`*Pearlescent Mushroom consumed for FREE GUIDANCE.*`, 'system');
                                gameState.crewUseFree = false;
                            } else {
                                gameState.crew[crewKey].used = true;
                            }
                            if (roll >= gameState.lastDC) gameState.lastCrewUsedId = crewKey;
                            
                        } else if (gameState.crewUseFree) {
                            crewUsedName = activeCrewMember.name;
                            logMsg += ` + 0 (${crewUsedName} - Invalid Skill, Mushroom conserved)`;
                            addToHistory(`*Mushroom conserved: ${crewUsedName} doesn't have expertise in ${gameState.lastSkillType}.*`, 'system');
                        } else {
                            crewUsedName = activeCrewMember.name;
                            logMsg += ` + 0 (${crewUsedName} - Invalid Skill)`;
                        }
                        
                        if (gameState.isRiftCollapse) {
                            roll = Math.max(1, roll - 2); 
                            logMsg += ` - 2 (Rift Penalty)`;
                        }
                        activeCrewMember = null;
                    } else {
                        if (gameState.isRiftCollapse) {
                            roll = Math.max(1, roll - 2); 
                            logMsg += ` - 2 (Rift Penalty)`;
                        }
                    }
                }

                // Determine Success or Fail based on the DC stored in state
                const dcToCheck = gameState.lastDC || 10;
                const isSuccess = roll >= dcToCheck;
                
                // Use !text-color to override the parent .spectral-text-glow !important rule
                const colorClass = isSuccess ? '!text-emerald-400' : '!text-red-400';
                
                addToHistory(`${logMsg} <span class="${colorClass}">= ${roll}</span>`, 'roll');
                
                const nextId = scene.resolve(roll, gameState); 
                saveGame();
                renderScene(nextId); 
                return;
            }

            gameState.currentSceneId = sceneId;
            fxManager.clearEffects(); 

            // --- 5. HANDLE VISUAL PULSE FX ---
            const isProloguePulse = ['prologue_storm', 'prologue_abyss'].includes(sceneId);
            const isAct1Pulse = gameState.act1Started && !gameState.isRiftCollapse && gameState.doomTimer > 0 &&
                ['town_square', 'lighthouse_vigil', 'smelter_stage1_start', 'chapel_stage1_reveal', 'town_docks', 'blackwater_tavern', 'alchemist_triage'].includes(sceneId);
            const isAct2Pulse = gameState.act2Started && sceneId !== 'act2_tether_fail';

            if (isProloguePulse || isAct1Pulse || isAct2Pulse) {
                document.getElementById('fx-overlay').classList.add('fx-rift-pulse');
            }

            // --- 6. EXECUTE ONENTER ---
            if (scene.onEnter) {
                const msg = scene.onEnter(gameState);
                if (msg && logText) {
                    addToHistory(msg, 'system');
                }
                saveGame();
            }
            
            // --- 7. TEXT & TITLE ---
            let displayTitle = scene.title;
            let displayText = scene.text;

            // --- 8. INJECT BOSS HEALTH BAR ---
            if (gameState.isBossCombat) {
                if (gameState.activeEnemies && gameState.activeEnemies.length > 0) {
                    let hordeHPBar = '';
                    let totalHP = 0;
                    gameState.activeEnemies.forEach(elderName => {
                        const elderHP = gameState.enemies[elderName];
                        const pct = (elderHP / gameState.maxElderHP) * 100;
                        totalHP += elderHP;
                        hordeHPBar += `<div class="w-full bg-gray-900 border border-red-900 rounded h-4 mt-1 mb-1 relative overflow-hidden shadow-lg"><div class="bg-red-700 h-full transition-all duration-300" style="width: ${pct}%"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] cinzel font-bold text-white shadow-black drop-shadow-md tracking-widest">${elderName}: ${elderHP} / ${gameState.maxElderHP}</div></div>`;
                    });
                    const totalPct = (totalHP / gameState.maxEnemyHP) * 100;
                    displayText = `<div class="w-full bg-gray-900 border border-red-500 rounded h-2 mb-3 relative overflow-hidden"><div class="bg-red-600 h-full transition-all duration-300" style="width: ${totalPct}%"></div></div><div class="text-xs text-red-400 cinzel mb-2">Horde Total HP: ${totalHP} / ${gameState.maxEnemyHP}</div>${hordeHPBar}` + displayText;
                }
                else if (gameState.enemyHP > 0) { 
                    const pct = (gameState.enemyHP / gameState.maxEnemyHP) * 100;
                    displayText = `<div class="w-full bg-gray-900 border border-red-900 rounded h-6 mt-2 mb-6 relative overflow-hidden shadow-lg"><div class="bg-red-700 h-full transition-all duration-300" style="width: ${pct}%"></div><div class="absolute inset-0 flex items-center justify-center text-xs cinzel font-bold text-white shadow-black drop-shadow-md tracking-widest">${gameState.currentEnemy}: ${gameState.enemyHP} / ${gameState.maxEnemyHP}</div></div>` + displayText;
                }
            }

            // --- 9. INJECT SHIP NAME ---
            if (sceneId === 'act3_intro_ship' || sceneId === 'sea_map_hub') {
                if (gameState.shipName) {
                    displayTitle = gameState.shipName;
                    displayText = displayText.replace('[SHIP_NAME]', gameState.shipName);
                    displayText = displayText.replace('your ship', `the ${gameState.shipName}`);
                }
            }

            // --- 10. DEATH CHECK ---
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }

            // --- 11. VIGNETTE FX ---
            const hpPct = (gameState.currentHP / gameState.maxHP) * 100;
            if (hpPct <= 30) fxManager.setVignette(true);
            else fxManager.setVignette(false);
            
            if (gameState.companions.silas.joined) {
                if (sceneId === 'bleak_dogtooth' || sceneId === 'dogtooth_cliff_wall') {
                     if (!gameState.silasJoined && gameState.inventory.includes("Ring of Brass")) {
                         document.getElementById('vignette-overlay').classList.add('fx-heartbeat-fast');
                     } else {
                         document.getElementById('vignette-overlay').classList.remove('fx-heartbeat-fast', 'fx-heartbeat-slow');
                     }
                }
            }

            // --- 12. RENDER TO DOM ---
            const textEl = document.getElementById('main-scene-text');
            const isDeathScene = sceneId === 'edward_death';
            let titleClass = isDeathScene ? 'text-red-500' : 'text-amber-500';
            let textClass = isDeathScene ? 'text-red-300' : 'text-gray-300';
            
            let finalHtml = `<h2 class="2xl cinzel ${titleClass} mb-2">${displayTitle}</h2><p class="text-lg leading-relaxed ${textClass} fade-in">${displayText}</p>`;
            
            if (scene.banter) {
                Object.keys(scene.banter).forEach(crewId => {
                    const crewMember = gameState.crew[crewId];
                    if (crewMember && (!crewMember.used || gameState.crewUseFree)) {
                         finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in"><span class="font-bold text-xs uppercase block mb-1">${crewMember.name}:</span>"${scene.banter[crewId]}"</div>`;
                    }
                });
            }
            
            const isScriptedScene = scene.banter || scene.isBoss || scene.isRest || scene.choices.some(c => c.type === 'skill');
            if (!isScriptedScene && !sceneId.startsWith('prologue') && gameState.act1Started) {
                 const dynamicLine = getDynamicBanter();
                 if (dynamicLine) {
                      finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in"><span class="font-bold text-xs uppercase block mb-1">${dynamicLine.name}:</span>"${dynamicLine.line}"</div>`;
                 }
            }
            
            textEl.innerHTML = finalHtml;
            document.getElementById('scene-title').innerText = displayTitle;
            activeCrewMember = null; 

            generateSceneImage(sceneId);
            renderChoices(scene.choices, isDeathScene);
			
			
            
            // --- PUZZLE & BANTER HOOKS ---
            if (sceneId === 'manor_cellar_puzzle') setTimeout(() => puzzleManager.initCircuit(), 100);
            if (sceneId === 'sea_fog_puzzle') setTimeout(() => puzzleManager.initCompass(), 100);

            if (scene.banter || isScriptedScene) {
                const banterContainers = textEl.querySelectorAll('.italic'); 
                banterContainers.forEach((container, index) => {
                    const nameSpan = container.querySelector('span');
                    if (nameSpan && nameSpan.nextSibling) {
                        const rawText = nameSpan.nextSibling.textContent.replace(/"/g, '').trim();
                        nameSpan.nextSibling.textContent = ' "'; 
                        const typeSpan = document.createElement('span');
                        typeSpan.id = `banter-type-${index}`;
                        container.appendChild(typeSpan);
                        setTimeout(() => {
                            puzzleManager.typeBanter(typeSpan.id, rawText + '"');
                        }, index * 1000); 
                    }
                });
            }
            updateUI();
        }
		
		
		function renderChoices(choices, isDeathScene = false) {
            const container = document.getElementById('choices-area');
            container.innerHTML = '';

            const currentSceneId = gameState.currentSceneId;
            const currentSceneStock = scenes[currentSceneId] ? scenes[currentSceneId].stock : {};
            
            // 1. CLONE CHOICES TO AVOID MUTATION BUGS
            let processedChoices = choices.map(c => ({...c})); 
            
            // --- SCENE SPECIFIC OVERRIDES (Re-implemented for stability) ---

            // A. MARKET (Standard Shop)
            if (currentSceneId === 'market_stall') {
                const sellWaresNav = choices.find(c => c.nextScene === 'market_sell');
                const returnTarget = (gameState.act1Started || gameState.act2Started || gameState.act3Started) ? 'town_square' : 'market_crossroads';
                const leaveNav = { text: "Leave", nextScene: returnTarget, type: 'travel', doomCost: 0 };
                
                processedChoices = []; 
                
                MARKET_BUY_OPTIONS.forEach(sale => {
                    const actualStock = currentSceneStock[sale.item] || 0;
                    const itemDef = itemRegistry[sale.item];
                    const isHealing = itemDef && (itemDef.name || '').includes('Heal') || (itemDef.name || '').includes('Rum');
                    const isFull = gameState.currentHP >= gameState.maxHP;
                    const canAfford = gameState.shillings >= sale.cost;
                    
                    if (actualStock > 0) {
                        processedChoices.push({ 
                            text: `Buy ${sale.item.split('(')[0].trim()}`, 
                            nextScene: sale.nextScene, 
                            type: 'action', 
                            cost: sale.cost, 
                            stockItem: sale.item, 
                            doomCost: 0, 
                            isDisabled: !canAfford || (isHealing && isFull) 
                        });
                    }
                });
                if (sellWaresNav) processedChoices.push(sellWaresNav);
                processedChoices.push(leaveNav);
            }
            // B. TAVERN (Gruel Logic Fix)
            else if (currentSceneId === 'blackwater_tavern') {
                const restOption = choices.find(c => c.nextScene === 'tavern_rest_success');
                const returnOption = choices.find(c => c.nextScene === 'town_square');
                const gamblerOption = choices.find(c => c.nextScene === 'tavern_gambler');
                const infoSmelter = choices.find(c => c.nextScene === 'gather_info_smelter');
                const infoChapel = choices.find(c => c.nextScene === 'gather_info_chapel');
                const instantEat = choices.find(c => c.nextScene === 'eat_gruel_instant');
                const buyToGo = choices.find(c => c.nextScene === 'buy_gruel_to_go');
                
                processedChoices = []; 
                const gruelStock = currentSceneStock['Gruel'] || 0;
                const canAfford = gameState.shillings >= 1;
                const isHealingWasteful = gameState.currentHP >= gameState.maxHP; 
                
                if (instantEat) {
                    processedChoices.push({ 
                        ...instantEat, 
                        text: `Eat Gruel Now (Stock: ${gruelStock})`, 
                        isDisabled: !canAfford || gruelStock <= 0 || isHealingWasteful 
                    });
                }
                if (buyToGo) {
                    processedChoices.push({ 
                        ...buyToGo, 
                        text: `Buy Gruel (To Go) (Stock: ${gruelStock})`, 
                        isDisabled: gruelStock <= 0 || !canAfford 
                    });
                }
                
                if (restOption) processedChoices.push(restOption);
                
                if (infoSmelter && !gameState.knowsSmelterSecret && !gameState.inventory.includes('Sword of Valor')) processedChoices.push({ ...infoSmelter, customClass: 'btn-pulse' });
                if (infoChapel && !gameState.knowsChapelSecret && !gameState.inventory.includes('Ring of Brass')) processedChoices.push({ ...infoChapel, customClass: 'btn-pulse' });
                
                if (gamblerOption && gameState.inventory.includes('Ring of Brass') && !gameState.hasObservedGambler) processedChoices.push(gamblerOption);
                if (returnOption) processedChoices.push(returnOption);
            } 
            // C. DOCKS (Work Costs Fix)
            else if (currentSceneId === 'town_docks') {
                 const workBtn = choices.find(c => c.nextScene === 'docks_work');
                 const cargoBtn = choices.find(c => c.nextScene === 'docks_sell_cargo');
                 
                 processedChoices = choices.map(c => {
                     if (c.nextScene === 'docks_work') {
                         return { 
                             ...c, 
                             isDisabled: gameState.currentHP <= (c.costHP || 2) 
                         };
                     }
                     return c;
                 });

                 if (!gameState.inventory.includes('Curious Cargo') || gameState.act3Started) {
                     processedChoices = processedChoices.filter(c => c.nextScene !== 'docks_sell_cargo');
                 }
            }
            // D. SPIRE COMBAT
            else if (currentSceneId === 'spire_combat_loop') {
                processedChoices = scenes['spire_combat_loop'].choices;
            }
            // E. ALCHEMIST (Triage/Sell)
            else if (currentSceneId === 'alchemist_triage') {
                const sellWaresNav = choices.find(c => c.nextScene === 'alchemist_sell');
                const returnNav = choices.find(c => c.nextScene === 'town_square');
                const secretTrade = choices.find(c => c.nextScene === 'alchemist_secret_stock');
                
                processedChoices = []; 
                if (secretTrade && gameState.inventory.includes('Strange Coin') && !gameState.inventory.includes('Phoenix Draft')) {
                     processedChoices.push({ ...secretTrade, customClass: 'btn-hero' });
                }
                
                ALCHEMIST_BUY_OPTIONS.forEach(sale => {
                    const itemText = sale.item.split('(')[0].trim();
                    const actualStock = currentSceneStock[sale.item] || 0;
                    const itemDef = itemRegistry[sale.item];
                    const isHealingItem = itemDef && (itemDef.name && (itemDef.name.includes('Tincture') || itemDef.name.includes('Potion')));
                    const isFullHP = gameState.currentHP >= gameState.maxHP;
                    const canAfford = gameState.shillings >= sale.cost;
                    
                    if (actualStock > 0) {
                        processedChoices.push({ 
                            text: `Buy ${itemText}`, 
                            nextScene: sale.nextScene, 
                            type: 'action', 
                            cost: sale.cost, 
                            stockItem: sale.item, 
                            doomCost: sale.doomCost, 
                            isDisabled: !canAfford || (isHealingItem && isFullHP) 
                        });
                    }
                });
                if (sellWaresNav) processedChoices.push({ ...sellWaresNav, text: "Sell Wares (Premium)" }); 
                processedChoices.push(returnNav);
            }
            else if (currentSceneId === 'alchemist_sell') {
                const backToBuyNav = choices.find(c => c.nextScene === 'alchemist_triage');
                const returnNav = choices.find(c => c.nextScene === 'town_square');
                processedChoices = []; 
                
                ALCHEMIST_SELL_OPTIONS.forEach(sell => {
                    if (gameState.inventory.includes(sell.item)) {
                        let isDisabled = false;
                        if (sell.nextScene === 'sell_tincture' && currentSceneStock["Vitality Tincture"] >= 2) isDisabled = true; 
                        
                        const isArtifactSell = sell.nextScene === 'sell_fire' || sell.nextScene === 'sell_water';
                        const hasRing = gameState.inventory.includes("Ring of Brass");
                        const hasSword = gameState.inventory.includes("Sword of Valor");
                        if (isArtifactSell && (hasRing || hasSword)) isDisabled = true;
                        
                        processedChoices.push({ 
                            text: `Sell ${sell.item.split('(')[0].trim()}`, 
                            nextScene: sell.nextScene, 
                            type: 'action', 
                            reqItem: sell.item, 
                            value: sell.value, 
                            doomCost: sell.doomCost, 
                            isDisabled: isDisabled 
                        });
                    }
                });
                if (backToBuyNav) processedChoices.push(backToBuyNav);
                processedChoices.push(returnNav);
            } else if (currentSceneId === 'port_provisioner') {
                 const sellNav = choices.find(c => c.nextScene === 'port_provisioner_sell');
                 const returnNav = choices.find(c => c.nextScene === 'town_square');
                 processedChoices = [];
                 SHIP_SUPPLIES_OPTIONS.forEach(sale => {
                    const canAfford = gameState.shillings >= sale.cost;
                    const isMax = gameState.supplies >= 20;
                    processedChoices.push({ text: `Buy ${sale.amount} Supplies`, type: 'action', cost: sale.cost, doomCost: 0, isDisabled: !canAfford || isMax, action: (state) => { state.supplies = Math.min(20, state.supplies + sale.amount); return `Purchased ${sale.amount} Supplies.`; }, nextScene: 'port_provisioner' });
                });
                if (sellNav) processedChoices.push(sellNav);
                if (returnNav) processedChoices.push(returnNav);
            } else if (currentSceneId === 'port_provisioner_sell') {
                const buyNav = choices.find(c => c.nextScene === 'port_provisioner');
                const returnNav = choices.find(c => c.nextScene === 'town_square');
                processedChoices = [];
                const SELLABLE_ITEMS_ACT3 = [ "Curious Cargo", "Rope", "Torch", "Healing Potion", "Rum", "Silver Locket", "Vitality Tincture", "Smelling Salts", "Flash Powder", "Pearlescent Mushroom", "Dead Man's Die" ];
                SELLABLE_ITEMS_ACT3.forEach(itemName => {
                    if (gameState.inventory.includes(itemName)) {
                        const saleOption = [...MARKET_SELL_OPTIONS, ...ALCHEMIST_SELL_OPTIONS].find(opt => opt.item === itemName) || { value: 3 }; 
                        processedChoices.push({ text: `Sell ${itemName.split('(')[0].trim()}`, nextScene: 'port_provisioner_sell', type: 'action', reqItem: itemName, value: saleOption.value, doomCost: 0, action: (state) => { const idx = state.inventory.indexOf(itemName); if (idx > -1) state.inventory.splice(idx, 1); state.shillings += saleOption.value; audioManager.playCoins(); return `Sold ${itemName} for ${saleOption.value}s.`; } });
                    }
                });
                if (buyNav) processedChoices.push(buyNav);
                if (returnNav) processedChoices.push(returnNav);
            }

            // --- RENDER LOOP ---
            processedChoices.forEach(choice => {
                // Requirements Checks
                if (choice.reqItem && !gameState.inventory.includes(choice.reqItem)) return;
                if (choice.reqItems && Array.isArray(choice.reqItems) && !choice.reqItems.every(item => gameState.inventory.includes(item))) return;
                if (choice.reqSmuggler && gameState.influence < choice.reqSmuggler) return;
                if (choice.reqGuard && gameState.influence > -choice.reqGuard) return;
                if (choice.reqNotItem && gameState.inventory.includes(choice.reqNotItem)) return; 
                if (choice.reqFlag && !gameState[choice.reqFlag]) return;
                if (choice.reqNotFlag && gameState[choice.reqNotFlag]) return; 
                if (choice.reqSkill && !gameState.skills.includes(choice.reqSkill) && choice.type !== 'skill') return;

                let rawText = choice.text;
                let icon = '<i class="fas fa-chevron-right text-gray-300 group-hover:text-amber-100"></i>';
                let content = `<span class="cinzel font-bold text-gray-300 group-hover:text-amber-100 drop-shadow-sm">${rawText}</span>`;
                let supplementalText = '';
                
                let isDisabled = false;
                let disabledClass = '';
                
                // --- COST & DISABLE LOGIC ---
                if (choice.cost && gameState.shillings < choice.cost) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
                if (choice.suppliesCost && gameState.supplies < choice.suppliesCost) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
                if (choice.costHP !== undefined && gameState.currentHP <= choice.costHP) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
                
                let disabledResult = choice.isDisabled;
                if (typeof disabledResult === 'function') disabledResult = disabledResult(gameState);
                if (disabledResult) { isDisabled = true; disabledClass = 'btn-disabled-cost'; }
                
                // Combine Check
                if (choice.type === 'combine' && choice.reqItems) {
                    if (choice.reqItems.some(item => !gameState.inventory.includes(item))) {
                        isDisabled = true;
                        disabledClass = 'btn-disabled-cost';
                        rawText = `${rawText} (Missing Item)`;
                    }
                }

                const btn = document.createElement('button');
                
                let isHeroButton = choice.reqSkill ? true : false;
                let isCustomClassButton = choice.customClass ? true : false;
                let isTradeButton = choice.cost || choice.value || choice.shillingGain || (choice.nextScene && choice.nextScene.includes('sell'));
                let isSkillCheck = choice.type === 'skill';
                const isCombineButton = choice.type === 'combine'; 

                // --- ALIGNMENT FIX ---
                const hasIndicators = (choice.cost || choice.value || choice.shillingGain || choice.costHP !== undefined || choice.chaosGain || choice.orderGain || choice.doomCost !== undefined || choice.tetherCost !== undefined || choice.suppliesCost !== undefined);
                const alignmentClass = (isSkillCheck || hasIndicators || isCombineButton) ? 'justify-start' : 'justify-between';
                
                let btnClass = "";
                
                if (isDeathScene) {
                    btnClass = `btn-game w-full p-3 text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-red-900 border-red-700 hover:bg-red-800 hover:border-amber-500 text-white text-xl text-center`;
                } else if (isCustomClassButton) {
                    content = `<span class="cinzel font-bold text-white">${rawText}</span>`;
                    
                    // Icon Mapping
                    if (choice.customClass === 'btn-success-glow') icon = '<i class="fas fa-ear-listen text-gray-300"></i>';
                    else if (choice.customClass === 'btn-keen-senses') icon = '<i class="fas fa-eye text-purple-300"></i>';
                    else if (choice.customClass === 'btn-lantern-glow') icon = '<i class="fas fa-lightbulb text-yellow-300"></i>';
                    else if (choice.customClass === 'btn-anchor') icon = '<i class="fas fa-anchor text-cyan-300"></i>';
                    else if (choice.customClass === 'btn-planewalk-reveal') icon = '<i class="fas fa-shoe-prints text-cyan-300"></i>';
                    else if (choice.customClass === 'btn-pulse') icon = '<i class="fas fa-bullhorn text-amber-300"></i>';                    
                    else icon = '<i class="fas fa-chevron-right text-white"></i>';

                    if (choice.customClass && choice.customClass.includes('spectral-active')) {
                         btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 spectral-active text-blue-100 ring-1 ring-blue-400 hover:ring-white`;
                    } else {
                        btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 ${choice.customClass}`;
                    }
                } else {
                    btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-gray-800 border-gray-600 hover:border-amber-500 hover:bg-gray-750 text-gray-300 group`;
                }
                
                if (isDisabled) {
                    btnClass += ` ${disabledClass}`;
                    btn.disabled = true;
                }
                
                // Icon Overrides
                if (isTradeButton) icon = '<i class="fas fa-coins text-amber-500"></i>';
                if (choice.type === 'reset') icon = '<i class="fas fa-sync-alt text-gray-400 group-hover:text-white"></i>';
                if (isHeroButton) icon = '<i class="fas fa-star hero-icon"></i>'; 
                if (isCombineButton) icon = '<i class="fas fa-hammer text-yellow-500"></i>';
                
                // --- SKILL CHECK STYLING (Reverted to Stable Logic) ---
                if (isSkillCheck) {
                    // 1. Force the Dice Icon
                    icon = '<i class="fas fa-dice-d20 spectral-text-glow"></i>';
                    
                    // 2. Add DC Text and Styling
                    const dcValue = gameState.isRiftCollapse ? choice.dc + 2 : choice.dc;
                    supplementalText += ` <span class="spectral-text-glow text-sm uppercase tracking-wider ml-2 mr-4">[${choice.skill} DC ${dcValue}]</span>`;
                    
                    // 3. Set the base class for skill checks to trigger the specific CSS
                    btnClass += " border-cyan-500";
                    
                    // 4. Crew Bonus Logic
                    if (activeCrewMember) {
                        const hasBonus = getBonusForSkill(activeCrewMember, choice.skill);
                        if (hasBonus) {
                            btnClass += " ring-1 ring-cyan-400"; 
                            const dieType = gameState.isEthereal ? '8' : (gameState.guidingDieSize || 4);
                            supplementalText += ` <span class="text-cyan-300 text-[12px] font-bold animate-pulse">+ 1d${dieType} (${activeCrewMember.name})</span>`;
                        }
                    }
                }
                
                // Silas Guard State
                if (gameState.negateNextDamage && (isDeathScene || choice.type === 'action' || choice.costHP)) {
                    btnClass += " ring-1 ring-emerald-500 bg-emerald-900/30";
                    supplementalText += " <span class='text-emerald-400 text-[10px] uppercase font-bold animate-pulse ml-2'>[Silas Blocking]</span>";
                }
                
                // Phase Strike Crit State
                if (gameState.nextAttackCrit && (choice.type === 'action')) {
                    btnClass += " ring-1 ring-emerald-500 bg-emerald-900/30";
                    supplementalText += " <span class='text-emerald-400 text-[10px] uppercase font-bold animate-pulse ml-2'>[Phase Strike Ready]</span>";
                }

                // --- INDICATOR GENERATION (The Fix for "Work the Lines") ---
                let indicators = [];
                if (choice.cost) indicators.push({ text: `-${choice.cost}s`, color: 'text-amber-500' });
                else if (choice.value) indicators.push({ text: `+${choice.value}s`, color: 'text-amber-500' });
                else if (choice.shillingGain) indicators.push({ text: `+${choice.shillingGain}s`, color: 'text-amber-500' });
                
                if (choice.suppliesCost) {
                    let finalSupplyCost = choice.suppliesCost;
                    if (gameState.activeBoons.includes('master_navigator')) finalSupplyCost = Math.max(1, finalSupplyCost - 1);
                    indicators.push({ text: `-${finalSupplyCost} Supplies`, color: 'text-indigo-400' });
                }
                
                if (choice.costHP !== undefined) indicators.push({ text: `-${choice.costHP} HP`, color: 'text-red-400' });
                
                if (choice.chaosGain) indicators.push({ text: `+${choice.chaosGain} Chaos`, color: 'text-emerald-400' });
                else if (choice.orderGain) indicators.push({ text: `+${choice.orderGain} Order`, color: 'text-blue-400' });
                
                const hasLogistics = gameState.quinnLogistics || gameState.activeBoons.includes('logistics');
				const isStandardAct1Scene = gameState.act1Started && !scenes[currentSceneId].isBoss && !scenes[currentSceneId].isRest;

				if (gameState.act1Started && hasLogistics && isStandardAct1Scene) {
                    const hasExplicitCost = choice.doomCost !== undefined;
                    const cost = hasExplicitCost ? choice.doomCost : (isStandardAct1Scene ? 1 : 0);
                    if (cost >= 0 && choice.type !== 'reset' && choice.nextScene !== 'lighthouse_vigil') {
                        if (cost > 0) indicators.push({ text: `-${cost} Time`, color: 'text-purple-400' }); 
                        else if (cost === 0 && (hasExplicitCost || choice.type === 'travel')) indicators.push({ text: `0 Time`, color: 'text-purple-400' });
                    }
                } 
				else if (gameState.act2Started) {
					const hasExplicitCost = choice.tetherCost !== undefined;
					let cost = hasExplicitCost ? choice.tetherCost : (scenes[currentSceneId].isBoss || scenes[currentSceneId].isRest ? 0 : 1);
					
					if (gameState.activeBoons.includes('efficient_pathing') && cost === 1 && !hasExplicitCost) cost = 0;

					if (cost >= 0 && choice.type !== 'reset') {
						if (cost > 0) indicators.push({ text: `-${cost} Turns`, color: 'text-cyan-400' }); 
						else if (cost === 0 && (hasExplicitCost || gameState.activeBoons.includes('efficient_pathing'))) {
							indicators.push({ text: `0 Turns`, color: 'text-cyan-400' });
						}
                        
						if (gameState.activeBoons.includes('spectral_metabolism') && choice.type === 'travel' && choice.nextScene !== currentSceneId) {
							const originalAction = choice.action; 							
							choice.action = (state) => {
								if (state.currentHP < state.maxHP) state.currentHP += 1;
								if (originalAction) return originalAction(state);
							};
							indicators.push({ text: `+1 HP`, color: 'text-emerald-400' });
						}
					}
				}

                // Append Indicators to Button Text
                let indicatorString = '';
                indicators.forEach(ind => { indicatorString += ` <span class="${ind.color} text-sm ml-1 whitespace-nowrap">(${ind.text})</span>`; });
                
                if (supplementalText) content += supplementalText;
                
                // Final HTML Construction
                if (indicatorString) btn.innerHTML = `<div class="btn-content-wrapper ${alignmentClass}">${content} <span class="flex items-center">${indicatorString}</span> <span class="ml-auto pl-2">${icon}</span></div>`;
                else btn.innerHTML = `${content} <span class="ml-auto">${icon}</span>`;

                btn.className = btnClass;

                // --- EVENT LISTENERS ---
                if (choice.type === 'hold') {
                    let holdTimer = null;
                    const duration = 3000;
                    btn.style.setProperty('--channel-duration', `${duration}ms`);

                    const startChannel = (e) => {
                        if (e.type === 'touchstart') e.preventDefault(); 
                        if (btn.disabled) return;
                        btn.classList.add('channeling');
                        holdTimer = setTimeout(async () => {
                            fxManager.setVignette(false); 
                            fxManager.clearEffects();     
                            if (choice.nextScene === 'act2_arrival') {
                                gameState.isEthereal = true; 
                                document.body.classList.add('plane-ethereal'); 
                                await saveGame(); 
                            }
                            renderScene(choice.nextScene);
                        }, duration);
                    };
                    const cancelChannel = (e) => {
                        if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
                        btn.classList.remove('channeling');
                    };
                    btn.addEventListener('mousedown', startChannel);
                    btn.addEventListener('mouseup', cancelChannel);
                    btn.addEventListener('mouseleave', cancelChannel);
                    btn.addEventListener('touchstart', startChannel);
                    btn.addEventListener('touchend', cancelChannel);
                    btn.onclick = null; 
                } 
                else {
                    btn.onclick = (e) => {
                        if (btn.disabled) { audioManager.playClick(); return; }

                        // SKILL CHECK LOGIC (Reverted back to full animation/logic from stable)
                        if (choice.type === 'skill') {
                            const allBtns = document.querySelectorAll('.btn-game');
                            allBtns.forEach(b => b.disabled = true);
                            audioManager.playDice(); 
                            btn.classList.add('fx-skill-active'); 

                            // Calculate roll immediately, but execute scene transition later
                            setTimeout(() => {
                                let roll = Math.floor(Math.random() * 20) + 1;
                                let logMsg = `Check (DC ${gameState.isRiftCollapse ? choice.dc + 2 : choice.dc}): Rolled d20 (${roll})`;
                                gameState.lastSkillType = choice.skill;
                                gameState.lastDC = gameState.isRiftCollapse ? choice.dc + 2 : choice.dc;
                                gameState.lastCrewUsedId = null;

                                // Tricorn Bonus
                                if (choice.skill === 'Intimidation' && gameState.inventory.includes("Captain's Tricorn")) {
                                    roll += 1; logMsg += ` + 1 (Tricorn)`;
                                }

                                // Crew Bonus Logic
                                if (activeCrewMember) {
                                    const isSkilled = getBonusForSkill(activeCrewMember, choice.skill);
                                    const crewKey = activeCrewMember.id;
                                    if (isSkilled) { 
                                        const dieSize = gameState.isEthereal ? 8 : (gameState.guidingDieSize || 4); 
                                        const bonus = Math.floor(Math.random() * dieSize) + 1;
                                        roll += bonus;
                                        const dieLabel = gameState.isEthereal ? `(Spectral D8!)` : `(${activeCrewMember.name})`;
                                        logMsg += ` + <span class="${gameState.isEthereal ? 'text-spectral-d8' : ''}">${bonus}</span> ${dieLabel}`; 
                                        
                                        if (gameState.crewUseFree) {
                                            addToHistory(`*Pearlescent Mushroom consumed for FREE GUIDANCE.*`, 'system');
                                            gameState.crewUseFree = false;
                                        } else {
                                            gameState.crew[crewKey].used = true;
                                        }
                                        if (roll >= gameState.lastDC) gameState.lastCrewUsedId = crewKey;
                                    } else {
                                        logMsg += ` + 0 (${activeCrewMember.name} - Invalid Skill)`;
                                    }
                                    activeCrewMember = null;
                                }

                                if (gameState.isRiftCollapse) { roll = Math.max(1, roll - 2); logMsg += ` - 2 (Rift Penalty)`; }

                                const isSuccess = roll >= gameState.lastDC;

                                btn.classList.remove('fx-skill-active');
                                if (isSuccess) {
                                    audioManager.playSuccess(); 
                                    btn.classList.add('fx-skill-success');
                                } else {
                                    audioManager.playFail(); 
                                    btn.classList.add('fx-skill-fail');
                                }

                                setTimeout(() => {
                                    gameState.pendingRoll = { total: roll, log: logMsg };
                                    renderScene(choice.nextScene);
                                }, 600);
                            }, 800);
                            return; 
                        }

                        // STANDARD LOGIC & FX
                        let fxClass = null;
                        let fxDuration = 0;

                        if (choice.customClass) {
                            if (choice.customClass.includes('btn-fire-glow')) { fxClass = 'fx-burn-active'; fxDuration = 1800; }
                            else if (choice.customClass.includes('btn-shadow-glow')) { fxClass = 'fx-mist-active'; fxDuration = 1800; }
                            else if (choice.customClass.includes('btn-hero')) { fxClass = 'fx-hero-active'; fxDuration = 1200; }
                            else if (choice.customClass.includes('btn-planewalk-reveal')) { fxClass = 'fx-glitch-active'; fxDuration = 1200; }
                            else if (choice.customClass.includes('btn-anchor')) { fxClass = 'fx-sail-active'; fxDuration = 1500; }
                        }

                        const executeAction = () => {
                            if (choice.nextScene === 'manor_map_view') {
                                gameState.returnSceneId = gameState.currentSceneId; 
                                renderScene('manor_map_view');
                                return;
                            }
                            
                            // Audio triggers
                            if (choice.cost || choice.value || choice.shillingGain) audioManager.playCoins();
                            else if (!fxClass) audioManager.playClick();
                            
                            if (choice.type === 'combine') {
                                const result = choice.onSelect(gameState);
                                if (result) addToHistory(result, 'system');
                                renderScene(choice.nextScene);
                                return;
                            }
                            
                            if (choice.action && typeof choice.action === 'function') {
                                const result = choice.action(gameState);
                                if (result) addToHistory(result, 'system');
                                if (choice.nextScene) {
                                    if (choice.nextScene === 'lighthouse_morning' && gameState.currentSceneId === 'captain_orders' && choice.onSelect) {
                                        choice.onSelect(gameState);
                                    }
                                    renderScene(choice.nextScene);
                                } else { updateUI(); }
                                return; 
                            }
                            
                            if (choice.type === 'reset') { resetGame(); return; }
                            
                            // Handle Stock Decrement 
                            if (choice.type === 'action' && choice.stockItem && scenes[currentSceneId].stock) {
                                 scenes[currentSceneId].stock[choice.stockItem] = Math.max(0, scenes[currentSceneId].stock[choice.stockItem] - 1);
                            }
                            
                            if (choice.consume && choice.reqItem) {
                                const idx = gameState.inventory.indexOf(choice.reqItem);
                                if (idx > -1) {
                                    const itemDef = itemRegistry[choice.reqItem];
                                    if (itemDef && itemDef.onRemove) itemDef.onRemove(gameState);
                                    gameState.inventory.splice(idx, 1);
                                    addToHistory(`${choice.reqItem} consumed.`, 'system');
                                }
                            }
                            if (choice.consumeItems && Array.isArray(choice.consumeItems)) {
                                choice.consumeItems.forEach(itemToConsume => {
                                    const idx = gameState.inventory.indexOf(itemToConsume);
                                    if (idx > -1) {
                                        const itemDef = itemRegistry[itemToConsume];
                                        if (itemDef && itemDef.onRemove) itemDef.onRemove(gameState);
                                        gameState.inventory.splice(idx, 1);
                                        addToHistory(`${itemToConsume} consumed.`, 'system');
                                    }
                                });
                            }

                            const currentScene = scenes[gameState.currentSceneId];
                            if (currentScene.journal) {
                                let journalText = currentScene.journal;
                                if (currentSceneId === 'act3_name_ship') journalText = journalText.replace('[SHIP_NAME]', gameState.shipName);
                                addToHistory(journalText, 'entry');
                            }

                            // Variable Updates
                            if (choice.cost) gameState.shillings -= choice.cost;
                            if (choice.costHP !== undefined) gameState.currentHP = applyDamage(gameState.currentHP, choice.costHP);

                            let extraGold = 0;
                            if (gameState.inventory.includes("Salt-Warped Spyglass") && gameState.influence >= 15) extraGold = 1;
                            if (choice.shillingGain || choice.value) {
								let bonus = extraGold;
								if (gameState.activeBoons.includes('scavenger')) bonus += 1;
								if (choice.shillingGain) gameState.shillings += (choice.shillingGain + bonus);
								if (choice.value) gameState.shillings += (choice.value + bonus);
							}
                            
                            if (choice.chaosGain) gameState.influence = Math.min(50, gameState.influence + choice.chaosGain);
                            if (choice.orderGain) gameState.influence = Math.max(-50, gameState.influence - choice.orderGain); 
                            
                            if (choice.nextScene === 'lighthouse_morning' && currentSceneId === 'captain_orders' && choice.onSelect) {
                                choice.onSelect(gameState);
                            }

                            if (gameState.act1Started && choice.doomCost !== 0) {
                                const cost = choice.doomCost !== undefined ? choice.doomCost : 1; 
                                gameState.doomTimer = Math.max(0, gameState.doomTimer - cost);
                                if (gameState.doomTimer > 0) addToHistory(`Rift Stability: ${gameState.doomTimer} turns remaining.`, 'system');
                            }
                            
                            renderScene(choice.nextScene);
                        };

                        if (fxClass && !isDeathScene) {
                            const allBtns = document.querySelectorAll('.btn-game');
                            allBtns.forEach(b => b.disabled = true);
                            btn.classList.add(fxClass);
                            setTimeout(() => { executeAction(); }, fxDuration);
                        } else {
                            executeAction();
                        }
                    };
                }

                container.appendChild(btn);
            });
        }
		
		
		function updateUI() {
			const statsPanel = document.getElementById('stats-panel');
			const journalContainer = document.getElementById('journal-container');
			const sceneId = gameState.currentSceneId;
			const suppliesDisplay = document.getElementById('supplies-display');
			
			// 1. Scene Visuals
			if (sceneId.startsWith('prologue')) {
				statsPanel.classList.add('prologue-blur');
			} else {
				statsPanel.classList.remove('prologue-blur');
			}
			
			// 2. Render Status Effects (Ensures icons persist on reload)
			if (window.renderStatusEffects) window.renderStatusEffects();

			// 3. Render Ability Grid (Skills & Allies)
			const abilitiesWrapper = document.getElementById('abilities-combined-container');
			const skillsCol = document.getElementById('planar-skills-container');
			const skillsList = document.getElementById('planar-skills-list');
			const alliesCol = document.getElementById('companion-panel');
			const alliesList = document.getElementById('companions-list');
			
			// Clear Lists
			if (skillsList) skillsList.innerHTML = '';
			if (alliesList) alliesList.innerHTML = '';
			
			let hasSkills = false;
			let hasAllies = false;

			// --- RENDER SKILLS (LEFT COLUMN) ---
			if (skillsList) {
				// A. Blade Enhancement (Universal)
				if (gameState.act1Started) {
					const btn = document.createElement('div'); 
					const isActive = gameState.combat.blade_enhanced_active;
					const isCombat = gameState.isBossCombat && gameState.combat.isPlayerTurn;
					
					// Style: Interactable only in combat
					const activeStyle = isActive 
						? "skill-btn-active" 
						: (isCombat ? "bg-gray-900/60 border-gray-700 hover:bg-gray-800 cursor-pointer" : "bg-gray-900/40 border-gray-800 opacity-50 cursor-not-allowed");

					btn.className = `w-full p-2 rounded border flex items-center justify-between transition-all mb-1 select-none ${activeStyle}`;
					btn.innerHTML = `
						<div class="flex items-center gap-2">
							<i class="fas fa-bolt ${isActive ? 'text-white' : 'text-indigo-400'}"></i>
							<div class="flex flex-col leading-none text-left">
								<span class="text-[10px] cinzel font-bold text-gray-300">Blade Enhance</span>
								<span class="text-[9px] text-gray-500 uppercase tracking-wider">${isActive ? 'ACTIVE' : 'Free Action'}</span>
							</div>
						</div>`;
					
					if (isCombat) {
						btn.onclick = () => {
							gameState.combat.blade_enhanced_active = !gameState.combat.blade_enhanced_active;
							window.audioManager.playClick();
							// Re-render scene to update the "Attack" button text immediately
							renderScene(gameState.currentSceneId, false);
							updateUI(); 
						};
					}
					skillsList.appendChild(btn);
					hasSkills = true;
				}

				// B. Specialization (Absorb Elements OR Hunter's Mark)
				if (gameState.player.specialization) {
					const btn = document.createElement('div');
					
					if (gameState.player.specialization === 'AE') {
						// ABSORB ELEMENTS (Passive Indicator)
						let statusText = "Passive";
						let iconColor = "text-blue-400";
						let borderColor = "border-blue-900";
						let glowClass = "";

						if (gameState.combat && gameState.combat.ae_primed) {
							const type = gameState.combat.ae_primed.type;
							statusText = `${type.toUpperCase()} PRIMED`;
							if (type === 'fire') { iconColor = "text-red-400"; borderColor = "border-red-500"; glowClass = "ae-badge-fire"; }
							else if (type === 'cold') { iconColor = "text-cyan-300"; borderColor = "border-cyan-500"; glowClass = "ae-badge-cold"; }
							else { iconColor = "text-green-400"; borderColor = "border-green-500"; glowClass = "ae-badge-acid"; }
						}

						btn.className = `w-full p-2 rounded border flex items-center justify-between bg-gray-900/80 ${borderColor} ${glowClass}`;
						btn.innerHTML = `
							<div class="flex items-center gap-2">
								<i class="fas fa-shield-halved ${iconColor}"></i>
								<div class="flex flex-col leading-none">
									<span class="text-[10px] cinzel font-bold text-gray-300">Absorb Elements</span>
									<span class="text-[9px] text-gray-500 uppercase tracking-wider">${statusText}</span>
								</div>
							</div>
						`;
					} 
					else if (gameState.player.specialization === 'PA') {
						// HUNTER'S MARK (Active Click)
						const isUsed = gameState.combat.hunters_mark_used_this_turn;
						const inCombat = gameState.isBossCombat && gameState.combat.isPlayerTurn;
						const activeClass = (inCombat && !isUsed) ? "cursor-pointer hover:bg-gray-800 border-green-500/50" : (isUsed ? "skill-btn-active" : "opacity-70 border-gray-800");
						
						btn.className = `w-full p-2 rounded border flex items-center justify-between bg-gray-900/60 ${activeClass}`;
						btn.innerHTML = `
							<div class="flex items-center gap-2">
								<i class="fas fa-crosshairs ${isUsed ? 'text-white' : 'text-emerald-400'}"></i>
								<div class="flex flex-col leading-none">
									<span class="text-[10px] cinzel font-bold text-gray-300">Hunter's Mark</span>
									<span class="text-[9px] ${inCombat && !isUsed ? 'text-green-400 animate-pulse' : 'text-gray-500'} uppercase tracking-wider">${isUsed ? 'APPLIED' : 'Free Action'}</span>
								</div>
							</div>
						`;
						
						if (inCombat && !isUsed) {
							btn.onclick = () => {
								gameState.combat.hunters_mark_used_this_turn = true;
								addToHistory("Hunter's Mark applied! Target Vulnerable.", 'combat');
								window.applyStatusEffect(gameState, 'vulnerable', 1);
								renderScene(gameState.currentSceneId, false);
								updateUI();
							};
						}
					}
					skillsList.appendChild(btn);
					hasSkills = true;
				}

				// C. Plane Walk Skill (Corrected: Single Instance)
				if (gameState.skills.includes("Plane Walking")) {
					const btn = document.createElement('button');
					const isActive = gameState.isEthereal;
					const activeStyle = isActive 
						? "border-cyan-500 shadow-[0_0_10px_rgba(34,211,238,0.2)] bg-cyan-900/20" 
						: "border-gray-700 bg-gray-900/60 hover:bg-gray-800";

					btn.className = `w-full p-2 rounded border flex items-center justify-between transition-all ${activeStyle}`;
					btn.onclick = () => window.gameFunctions.togglePlaneWalk();
					
					btn.innerHTML = `
						<div class="flex items-center gap-2">
							<i class="fas fa-shoe-prints ${isActive ? 'text-cyan-300' : 'text-gray-400'}"></i>
							<div class="flex flex-col items-start leading-none">
								<span class="text-[10px] cinzel font-bold ${isActive ? 'text-cyan-100' : 'text-gray-300'}">Plane Walk</span>
								<span class="text-[9px] ${isActive ? 'text-cyan-400' : 'text-gray-500'} uppercase tracking-wider">${isActive ? 'ACTIVE' : 'Material'}</span>
							</div>
						</div>
					`;
					skillsList.appendChild(btn);
					hasSkills = true;
				}
			}

			// --- RENDER ALLIES (RIGHT COLUMN) ---
			if (alliesList) {
				// Silas
				if (gameState.companions.silas.joined) {
					const btn = document.createElement('div');
					const onCooldown = gameState.allyCooldowns.silas > 0;
					const clickable = !onCooldown && gameState.isBossCombat && gameState.combat.isPlayerTurn;
					
					const activeStyle = "bg-emerald-900/40 border-emerald-500 text-emerald-100 shadow-[0_0_10px_rgba(16,185,129,0.2)] hover:bg-emerald-800 cursor-pointer";
					const cooldownStyle = "bg-gray-900/60 border-gray-700 text-gray-500 opacity-70 cursor-not-allowed";
					
					btn.className = `w-full p-2 rounded border flex items-center justify-between transition-all ${clickable ? activeStyle : cooldownStyle}`;
					
					btn.innerHTML = `
						<div class="flex items-center gap-2">
							<i class="fas fa-shield-alt ${clickable ? 'text-emerald-400' : 'text-gray-600'}"></i>
							<div class="flex flex-col leading-none">
								<span class="text-[10px] cinzel font-bold">Silas</span>
								<span class="text-[9px] uppercase tracking-wider font-bold">${onCooldown ? `CD: ${gameState.allyCooldowns.silas}` : 'READY'}</span>
							</div>
						</div>
					`;
					
					if (clickable) btn.onclick = () => window.allyCommand('silas');
					alliesList.appendChild(btn);
					hasAllies = true;
				}

				// Blink
				if (gameState.companions.blink.joined) {
					const btn = document.createElement('div');
					const onCooldown = gameState.allyCooldowns.blink > 0;
					const clickable = !onCooldown && gameState.isBossCombat && gameState.combat.isPlayerTurn;
					
					const activeStyle = "bg-purple-900/40 border-purple-500 text-purple-100 shadow-[0_0_10px_rgba(168,85,247,0.2)] hover:bg-purple-800 cursor-pointer";
					const cooldownStyle = "bg-gray-900/60 border-gray-700 text-gray-500 opacity-70 cursor-not-allowed";
					
					btn.className = `w-full p-2 rounded border flex items-center justify-between transition-all ${clickable ? activeStyle : cooldownStyle}`;
					
					btn.innerHTML = `
						<div class="flex items-center gap-2">
							<i class="fas fa-paw ${clickable ? 'text-purple-400' : 'text-gray-600'}"></i>
							<div class="flex flex-col leading-none">
								<span class="text-[10px] cinzel font-bold">Blink</span>
								<span class="text-[9px] uppercase tracking-wider font-bold">${onCooldown ? `CD: ${gameState.allyCooldowns.blink}` : 'READY'}</span>
							</div>
						</div>
					`;
					
					if (clickable) btn.onclick = () => window.allyCommand('blink');
					alliesList.appendChild(btn);
					hasAllies = true;
				}
			}

			// --- VISIBILITY TOGGLES ---
			if (skillsCol) {
                if (hasSkills) skillsCol.classList.remove('hidden');
                else skillsCol.classList.add('hidden');
            }

			if (alliesCol) {
                if (hasAllies) alliesCol.classList.remove('hidden');
                else alliesCol.classList.add('hidden');
            }

			if (abilitiesWrapper) {
                if (hasSkills || hasAllies) abilitiesWrapper.classList.remove('hidden');
                else abilitiesWrapper.classList.add('hidden');
            }

			// 4. HP Bar
			const displayMaxHP = gameState.maxHP;
			const hpToDisplay = gameState.currentHP;
			const hpPct = (hpToDisplay / displayMaxHP) * 100;
			const bar = document.getElementById('hp-bar');
			
			bar.style.width = `${Math.min(100, hpPct)}%`;
			bar.className = `h-full transition-all duration-500 ${hpToDisplay < (displayMaxHP * 0.3) ? 'bg-red-600 animate-pulse' : 'bg-red-800'}`;
			document.getElementById('hp-text').innerText = `${hpToDisplay}/${displayMaxHP}`; 
			window.audioManager.checkVulnerable(gameState.currentHP, gameState.maxHP);
			
			// 5. Doom/Tether Meters
			const doomDisplay = document.getElementById('doom-counter-display');
			const tetherDisplay = document.getElementById('tether-display');

			if (gameState.act1Started && !gameState.act2Started && !gameState.act3Started) {
				doomDisplay.classList.remove('hidden');
				document.getElementById('doom-timer-text').textContent = `${gameState.doomTimer} Turns`;
				document.getElementById('doom-bar').style.width = `${(gameState.doomTimer / 20) * 100}%`;
			} else {
				doomDisplay.classList.add('hidden');
			}
			
			if (gameState.act2Started) {
				tetherDisplay.classList.remove('hidden');
				document.getElementById('tether-text').textContent = `${gameState.tetherTimer} Turns`;
				document.getElementById('tether-bar').style.width = `${(gameState.tetherTimer / 20) * 100}%`;
			} else {
				tetherDisplay.classList.add('hidden');
			}

			// 6. Influence Marker
			const inf = gameState.influence || 0;
			const pct = ((inf + 50) / 100) * 100;
			const marker = document.getElementById('inf-marker');
			if (marker) marker.style.left = `${Math.max(0, Math.min(100, pct))}%`;
			
			const infText = document.getElementById('inf-status-text');
			if (infText) {
				if (inf <= -30) infText.textContent = "Sworn to the Crown";
				else if (inf <= -15) infText.textContent = "Watchman";
				else if (inf >= 30) infText.textContent = "Pirate Lord";
				else if (inf >= 15) infText.textContent = "Privateer";
				else infText.textContent = "Neutral";
			}

			// 7. Render Radial Crew
			if (window.renderRadialCrew) window.renderRadialCrew();

			// 8. Update Backpack Button & Modal
			document.getElementById('shillings-display').innerText = gameState.shillings;
			
			const packDisplay = document.getElementById('pack-resources-display');
			if (packDisplay) {
				let html = `<span class="text-amber-500">${gameState.shillings} <i class="fas fa-coins text-[10px]"></i></span>`;
				if (gameState.act3Started) { 
					 html += `<span class="text-indigo-400 ml-2">${gameState.supplies} <i class="fas fa-anchor text-[10px]"></i></span>`;
				}
				packDisplay.innerHTML = html;
			}

			if (gameState.act3Started) {
				suppliesDisplay.classList.remove('hidden');
				document.getElementById('supplies-count').innerText = gameState.supplies;
			} else {
				suppliesDisplay.classList.add('hidden');
			}

			// 9. Update Inventory List
			if (window.renderInventoryList) window.renderInventoryList();
		}
		window.updateUI = updateUI;
		

		// Helper to render inventory list (Needed for the backpack modal)
		function renderInventoryList() {
			const invContainer = document.getElementById('inventory-panel');
			invContainer.innerHTML = '';
			
			if (gameState.inventory.length === 0) {
				invContainer.innerHTML = '<div class="text-center text-[10px] text-gray-600 italic py-2">Inventory Empty</div>';
				return;
			}

			const descArea = document.getElementById('item-desc-area');
			const defaultText = "Hover to inspect.";

			gameState.inventory.forEach(itemName => {
				const itemDef = itemRegistry[itemName] || { icon: 'fa-box', color: 'text-gray-500', desc: "Unknown item." };
				const el = document.createElement('div');
				el.className = "group w-full flex items-center justify-between p-2 rounded border border-gray-700/50 bg-gray-900/60 hover:bg-gray-800 transition-all cursor-default relative shrink-0";
				
				el.innerHTML = `
					<div class="flex items-center gap-3">
						<div class="text-lg w-5 text-center ${itemDef.color}"><i class="fas ${itemDef.icon}"></i></div>
						<span class="text-xs cinzel text-gray-300 group-hover:text-gray-100">${itemName.split('(')[0]}</span>
					</div>
				`;
				
				// Add Use Button if Consumable
				if(itemDef.type === 'consumable' && itemDef.btnText) {
					 const btn = document.createElement('button');
					 btn.className = "px-2 py-1 bg-emerald-900/40 border border-emerald-600/30 text-emerald-500 text-[9px] font-bold rounded hover:bg-emerald-600 hover:text-white transition-all tracking-wider";
					 btn.innerText = itemDef.btnText;
					 btn.onclick = (e) => {
						 e.stopPropagation();
						 audioManager.playClick();
						 const res = itemDef.action(gameState);
						 addToHistory(res, 'system');
						 updateUI();
					 };
					 el.appendChild(btn);
				}

				el.onmouseenter = () => {
					descArea.innerText = itemDef.desc || defaultText;
					descArea.classList.add('text-amber-400');
				};
				el.onmouseleave = () => {
					descArea.innerText = defaultText;
					descArea.classList.remove('text-amber-400');
				};
				invContainer.appendChild(el);
			});
		}
		window.renderInventoryList = renderInventoryList;

		function renderCompanions(silas, blink) {
			const list = document.getElementById('companions-list');
			list.innerHTML = '';
			
			// Helper to create companion row
			const createRow = (name, role, icon, color, btnText, clickFn) => {
				const div = document.createElement('div');
				div.className = "p-2 bg-gray-800 border border-gray-700 rounded flex items-center justify-between";
				div.innerHTML = `
					<div class="flex items-center gap-2">
						<i class="fas ${icon} text-lg ${color}"></i>
						<div>
							<span class="font-bold text-xs cinzel ${color.replace('text-','text-')}-200 block">${name}</span>
							<span class="text-[9px] text-gray-500 uppercase tracking-wider block">${role}</span>
						</div>
					</div>
				`;
				// Only show button if we are in relevant mode (e.g. boss combat or free roam)
				// For simplicity in this fix, we just show the nameplate as the button logic is handled in renderChoices mostly.
				return div;
			};

			if(silas) list.appendChild(createRow('Silas', 'Seneschal', 'fa-moon', 'text-emerald-400', 'INTERCEPT'));
			if(blink) list.appendChild(createRow('Blink', 'Phase-Cub', 'fa-paw', 'text-purple-400', 'PHASE'));
		}
		
		// --- NEW FUNCTIONS FOR UI v2 ---

		// 1. Toggle the Backpack Modal
		window.gameFunctions.toggleBackpack = function() {
			const modal = document.getElementById('backpack-modal');
			const btn = document.getElementById('btn-combined-pack');
			if (!modal || !btn) return;

			if (modal.classList.contains('hidden')) {
				modal.classList.remove('hidden');
				audioManager.playClick();
			} else {
				modal.classList.add('hidden');
			}
		};
		
		

		// Close backpack when clicking outside
		document.addEventListener('click', function(event) {
			const modal = document.getElementById('backpack-modal');
			const btn = document.getElementById('btn-combined-pack');
			if (modal && !modal.classList.contains('hidden')) {
				if (!modal.contains(event.target) && !btn.contains(event.target)) {
					modal.classList.add('hidden');
				}
			}
		});


		// 4. Update Radial Menu - SIMPLIFIED TO ONLY RENDER STATE
		function renderRadialCrew() {
			const container = document.querySelector('.radial-container');
			if (!container) return; 

			const crewKeys = ['gareth', 'quinn', 'talon', 'bones']; 
			
			const hub = document.getElementById('radial-hub');
			const isAnyActive = activeCrewMember !== null;

			if(hub) {
				if(isAnyActive) hub.classList.add('drained');
				else hub.classList.remove('drained');
				
				// Update the Guiding Die Text
				const dieElement = hub.querySelector('.text-cyan-400');
				if (dieElement) dieElement.innerHTML = `+1d${gameState.guidingDieSize || 4}`;
			}

			// Update Node States
			crewKeys.forEach(key => {
				const c = gameState.crew[key]; 
				const btn = document.getElementById(`node-${key}`);
				const tether = document.getElementById(`tether-${key}`);
				
				if (!btn || !tether) return;

				const isUsed = c.used;
				const isActive = activeCrewMember && activeCrewMember.id === c.id;

				let displayName = c.name;
				if(c.name.includes(' ')) displayName = c.name.split(' ')[0]; 
				if(key === 'gareth') displayName = "Gareth"; 
				
				let content = `<span class="crew-node-name">${displayName}</span><span class="crew-node-skill">${c.skill.replace('&', '<br>&')}</span>`;
				
				// Add Icons based on state
				if(isUsed && !gameState.crewUseFree) content += `<i class="fas fa-lock absolute top-1 right-1 text-xs text-gray-500"></i>`;
				if(gameState.crewUseFree && !isUsed) content += `<i class="fas fa-star absolute top-1 right-1 text-xs text-purple-400 animate-pulse"></i>`;
				
				btn.innerHTML = content;

				// Apply/Remove State Classes
				if (isActive) {
					btn.classList.add('charged');
					tether.classList.add('flowing');
				} else {
					btn.classList.remove('charged');
					tether.classList.remove('flowing');
				}

				if (isUsed && !gameState.crewUseFree) {
					btn.classList.add('used');
					btn.onclick = () => { /* No action */ }; 
				} else {
					btn.classList.remove('used');
					// Re-bind click handler if the button is now usable (it's bound statically in the HTML now, but this is a fail-safe)
					btn.onclick = () => { window.toggleCrewSelection(key); };
				}
			});
		}
		window.renderRadialCrew = renderRadialCrew;
		
		// 3. Updated Crew Toggle Logic (Now globally accessible)
		window.toggleCrewSelection = function(crewKey) {
			const c = gameState.crew[crewKey];
			if (activeCrewMember && activeCrewMember.id === c.id) {
				activeCrewMember = null; // Deselect
				audioManager.playClick();
			} else {
				// Safety Check: If trying to select a used crew member, prevent it unless free
				if (c.used && !gameState.crewUseFree) return;
				
				activeCrewMember = c; // Select
				audioManager.playGhost();
			}
			updateUI();
			// Re-render choices to update button borders/text
			renderChoices(scenes[gameState.currentSceneId].choices, false); 
		}

		
		// --- KONAMI CODE COMMAND CENTER ---
		(function() {
			const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
			let konamiIndex = 0;

			document.addEventListener('keydown', function(e) {
				if (e.key === konamiCode[konamiIndex] || e.key.toLowerCase() === konamiCode[konamiIndex]) {
					konamiIndex++;
					if (konamiIndex === konamiCode.length) {
						activateDevMenu();
						konamiIndex = 0;
					}
				} else {
					konamiIndex = 0;
				}
			});

			function activateDevMenu() {
				// Sound confirm
				const audio = new Audio('audio/coins.mp3');
				audio.volume = 0.5;
				audio.play().catch(() => {});
				
				if (document.getElementById('dev-menu')) {
					toggleDevMenu();
					return;
				}

				const menu = document.createElement('div');
				menu.id = "dev-menu";
				menu.className = "fixed top-10 left-10 z-[200] bg-gray-950 border-2 border-amber-600 p-4 rounded-lg shadow-[0_0_30px_rgba(245,158,11,0.3)] flex flex-col gap-3 w-80 font-mono text-xs text-amber-500 fade-in";
				menu.innerHTML = `
					<div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-1">
						<h3 class="cinzel font-bold text-sm text-amber-400"><i class="fas fa-terminal mr-2"></i>DEV COMMAND</h3>
						<button onclick="toggleDevMenu()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
					</div>
					
					<div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
						<div>
							<div class="text-gray-500 font-bold uppercase tracking-wider mb-1 text-[10px]">Act I: The Port</div>
							<div class="grid grid-cols-2 gap-2">
								<button onclick="devJump('boss_slag')" class="bg-red-900/30 border border-red-800 p-2 rounded hover:bg-red-800 text-red-200 text-left truncate">Boss: Slag Horror</button>
								<button onclick="devJump('boss_spectre')" class="bg-purple-900/30 border border-purple-800 p-2 rounded hover:bg-purple-800 text-purple-200 text-left truncate">Boss: Spectre</button>
								<button onclick="devJump('act1')" class="bg-gray-800 p-2 rounded hover:bg-gray-700 text-gray-300 text-left truncate">Hub: Lighthouse</button>
								<button onclick="devJump('town_square')" class="bg-gray-800 p-2 rounded hover:bg-gray-700 text-gray-300 text-left truncate">Hub: Port Square</button>
							</div>
						</div>

						<div>
							<div class="text-gray-500 font-bold uppercase tracking-wider mb-1 text-[10px]">Act II: The Manor</div>
							<div class="grid grid-cols-2 gap-2">
								<button onclick="devJump('boss_automaton')" class="bg-amber-900/30 border border-amber-800 p-2 rounded hover:bg-amber-800 text-amber-200 text-left truncate">Boss: Sentinel</button>
								<button onclick="devJump('boss_mimic')" class="bg-amber-900/30 border border-amber-800 p-2 rounded hover:bg-amber-800 text-amber-200 text-left truncate">Mini: Mimic</button>
								<button onclick="devJump('puzzle_circuit')" class="bg-blue-900/30 border border-blue-800 p-2 rounded hover:bg-blue-800 text-blue-200 text-left truncate">Puzzle: Circuit</button>
								<button onclick="devJump('act2')" class="bg-gray-800 p-2 rounded hover:bg-gray-700 text-gray-300 text-left truncate">Hub: Foyer</button>
							</div>
						</div>

						<div>
							<div class="text-gray-500 font-bold uppercase tracking-wider mb-1 text-[10px]">Act III: The Sea</div>
							<div class="grid grid-cols-2 gap-2">
								<button onclick="devJump('boss_coral')" class="bg-red-900/30 border border-red-800 p-2 rounded hover:bg-red-800 text-red-200 text-left truncate">Boss: Coral Hulk</button>
								<button onclick="devJump('boss_elders')" class="bg-red-900/30 border border-red-800 p-2 rounded hover:bg-red-800 text-red-200 text-left truncate">Boss: Elders</button>
								<button onclick="devJump('puzzle_compass')" class="bg-blue-900/30 border border-blue-800 p-2 rounded hover:bg-blue-800 text-blue-200 text-left truncate">Puzzle: Compass</button>
								<button onclick="devJump('act3')" class="bg-gray-800 p-2 rounded hover:bg-gray-700 text-gray-300 text-left truncate">Hub: Sea Map</button>
							</div>
						</div>

						<div class="pt-2 border-t border-gray-700">
							<div class="grid grid-cols-2 gap-2">
								<button onclick="devGrant('godmode')" class="bg-green-900/30 border border-green-800 p-2 rounded hover:bg-green-800 text-green-200 text-center font-bold">GOD MODE</button>
								<button onclick="devGrant('level')" class="bg-cyan-900/30 border border-cyan-800 p-2 rounded hover:bg-cyan-800 text-cyan-200 text-center font-bold">LEVEL UP</button>
							</div>
						</div>
					</div>
				`;
				document.body.appendChild(menu);
			}
			

			window.toggleDevMenu = function() {
				const m = document.getElementById('dev-menu');
				if (m) m.classList.toggle('hidden');
			};

			window.devJump = function(loc) {
				// RESET BASE STATE
				gameState.isEthereal = false;
				document.body.classList.remove('plane-ethereal');
				gameState.currentHP = gameState.maxHP;
				gameState.isBossCombat = false; // Clear boss flag to be safe

				// --- ACT 1 ---
				if (loc === 'act1') {
					gameState.act1Started = true;
					renderScene('lighthouse_vigil');
				}
				if (loc === 'town_square') {
					gameState.act1Started = true;
					renderScene('town_square');
				}
				if (loc === 'boss_slag') {
					gameState.act1Started = true;
					if(!gameState.inventory.includes("Rusted Cutlass")) gameState.inventory.push("Rusted Cutlass");
					if(!gameState.inventory.includes("Holy Water")) gameState.inventory.push("Holy Water");
					renderScene('smelter_stage1_start');
				}
				if (loc === 'boss_spectre') {
					gameState.act1Started = true;
					if(!gameState.inventory.includes("Torch")) gameState.inventory.push("Torch");
					if(!gameState.inventory.includes("Alchemical Fire")) gameState.inventory.push("Alchemical Fire");
					renderScene('chapel_stage1_reveal');
				}

				// --- ACT 2 ---
				if (loc === 'act2') {
					gameState.act1Started = false;
					gameState.act2Started = true;
					gameState.isEthereal = true;
					gameState.tetherTimer = 20;
					if(!gameState.inventory.includes("Spectral Lantern")) gameState.inventory.push("Spectral Lantern", "Manor Blueprint");
					renderScene('manor_foyer');
				}
				if (loc === 'boss_automaton') {
					gameState.act2Started = true;
					gameState.isEthereal = true;
					gameState.tetherTimer = 15;
					if(!gameState.inventory.includes("Sword of Valor")) gameState.inventory.push("Sword of Valor");
					if(!gameState.skills.includes("Plane Walking")) gameState.hasBlinkSkill = true; 
					gameState.companions.blink.joined = true;
					renderScene('manor_automaton_encounter');
				}
				if (loc === 'boss_mimic') {
					gameState.act2Started = true;
					gameState.isEthereal = true;
					renderScene('manor_hall_check');
				}
				if (loc === 'puzzle_circuit') {
					gameState.act2Started = true;
					gameState.isEthereal = true;
					renderScene('manor_cellar_puzzle');
				}

				// --- ACT 3 ---
				if (loc === 'act3') {
					gameState.act2Started = false;
					gameState.act3Started = true;
					gameState.shipName = "The Dev Debugger";
					gameState.supplies = 20;
					renderScene('sea_map_hub');
				}
				if (loc === 'puzzle_compass') {
					gameState.act3Started = true;
					renderScene('sea_fog_puzzle');
				}
				if (loc === 'boss_coral') {
					gameState.act3Started = true;
					if(!gameState.inventory.includes("Sword of Valor")) gameState.inventory.push("Sword of Valor");
					initCombat("Coral-Hulk", 80, [6, 12]);
					renderScene('coral_hulk_combat');
				}
				if (loc === 'boss_elders') {
					gameState.act3Started = true;
					gameState.companions.silas.joined = true;
					if(!gameState.inventory.includes("Sword of Valor")) gameState.inventory.push("Sword of Valor", "Ring of Brass", "Flash Powder", "Healing Potion");
					gameState.activeBoons.push("hunters_mark", "hold_the_line"); 
					gameState.baseDamage = 2; 
					renderScene('sanguine_spire_combat');
				}
				
				updateUI();
			};

			window.devGrant = function(type) {
				if (type === 'godmode') {
					gameState.maxHP = 50;
					gameState.currentHP = 50;
					gameState.shillings = 100;
					gameState.supplies = 20;
					const godItems = ["Sword of Valor", "Ring of Brass", "Spectral Lantern", "Alchemical Fire", "Holy Water", "Sun-Star Grenade", "Vitality Tincture"];
					godItems.forEach(i => {
						if(!gameState.inventory.includes(i)) gameState.inventory.push(i);
					});
					updateUI();
				}
				if (type === 'level') {
					// Trigger the transition manually
					window.gameFunctions.startDreamscape('act1_transition');
				}
			};
									
		})();
				

        init();
    </script>
</body>
</html>
