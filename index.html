<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edward Jones: The Mariner of the Damned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS Font Awesome for dynamic icon switching -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Crimson Text', serif;
            background-color: #050a10;
            color: #cdd5e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1, h2, h3, .cinzel {
            font-family: 'Cinzel', serif;
        }
        .journal-font {
            font-family: 'Dancing Script', cursive;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #94a3b8; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .btn-game {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .btn-game:active { transform: translateY(1px); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); border-color: #60a5fa; }
        }
        .crew-active { animation: pulse-glow 2s infinite; background-color: rgba(30, 58, 138, 0.3); }

        /* --- TUTORIAL PULSE --- */
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); border-color: #f59e0b; }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); border-color: #fbbf24; }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; }
        }
        .tutorial-pulse { 
            animation: pulse-amber 2s infinite; 
            border-color: #f59e0b !important; 
            z-index: 10;
        }

        @keyframes item-pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 10px 0 rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
        }
        .item-consumable { animation: item-pulse 3s infinite; }

        #inf-marker { transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- LORE TOOLTIPS --- */
        .memory-keyword {
            color: #60a5fa; /* Blue-400 */
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5); /* Soft Glow */
            cursor: help;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 1px solid transparent; 
        }
        .memory-keyword:hover {
            text-shadow: 0 0 12px rgba(59, 130, 246, 0.9), 0 0 2px #fff; /* Intense Glow */
            color: #bfdbfe; /* Blue-200 */
        }
        /* Tooltip Box */
        .memory-keyword:hover::after {
            content: attr(data-lore);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #0f172a; /* Slate-900 */
            border: 1px solid #3b82f6; /* Blue-500 */
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            width: 240px;
            font-size: 0.85rem;
            line-height: 1.4;
            z-index: 100;
            pointer-events: none;
            font-family: 'Crimson Text', serif;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            text-align: center;
            white-space: normal;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* Tooltip Arrow */
        .memory-keyword:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0px);
            border-width: 6px;
            border-style: solid;
            border-color: #3b82f6 transparent transparent transparent;
            z-index: 100;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }

        /* --- ATMOSPHERIC FX --- */
        #fx-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
            transition: box-shadow 0.5s ease;
        }

        @keyframes pulse-violet-anim {
            0%, 100% { box-shadow: inset 0 0 20px 0px rgba(139, 92, 246, 0.1); background-color: rgba(139, 92, 246, 0.05); }
            50% { box-shadow: inset 0 0 80px 20px rgba(139, 92, 246, 0.4); background-color: rgba(139, 92, 246, 0.15); }
        }
        .fx-pulse-violet {
            animation: pulse-violet-anim 4s infinite ease-in-out;
            mix-blend-mode: overlay;
        }

        @keyframes flash-red-anim {
            0% { background-color: rgba(220, 38, 38, 0.6); }
            100% { background-color: transparent; }
        }
        .fx-flash-red {
            animation: flash-red-anim 0.4s ease-out forwards;
        }

        .fx-vignette-low {
            box-shadow: inset 0 0 80px 30px rgba(127, 29, 29, 0.3);
        }

        .water-stained {
            background-color: #1e293b;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23334155' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Blur UI when in prologue */
        .prologue-blur { filter: blur(4px); opacity: 0.5; pointer-events: none; transition: all 1s; }
        .prologue-active { opacity: 1; filter: none; }
        
        /* Hidden Log State */
        .log-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .log-visible { opacity: 1; pointer-events: auto; transform: translateY(0); transition: all 1s ease-out; }
    </style>
</head>
<body>

    <div id="app-loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white">
        <div class="text-4xl cinzel text-blue-500 mb-4 animate-pulse text-center px-4">Edward Jones:<br>The Mariner of the Damned</div>
        <div class="text-gray-400 cinzel text-sm">Summoning the Crew...</div>
    </div>

    <!-- Audio Toggle Button (Fixed Position) -->
    <div class="fixed top-4 right-4 z-50">
        <button id="audio-toggle" class="bg-gray-800/80 border border-gray-600 text-gray-400 p-2 rounded-full hover:text-amber-500 transition-colors w-10 h-10 flex items-center justify-center shadow-lg backdrop-blur">
            <!-- Default Icon: Muted -->
            <i class="fas fa-volume-mute"></i>
        </button>
    </div>

    <div class="grid grid-cols-1 md:flex md:flex-row max-w-7xl mx-auto w-full p-2 md:p-4 gap-4 mb-8">
        
        <div class="contents md:flex md:flex-col md:w-1/3 gap-3 shrink-0">
            
            <div class="order-1 md:order-none relative w-full aspect-square md:aspect-[4/3] bg-gray-900 rounded border border-gray-700 overflow-hidden shadow-2xl shrink-0 group">
                <button id="reset-game-btn" onclick="confirmReset()" class="absolute top-2 left-2 z-30 text-[10px] border border-red-900/50 text-red-400 bg-black/60 hover:text-red-200 hover:bg-red-900/80 px-2 py-1 rounded transition-all cinzel font-bold backdrop-blur-sm">
                    <i class="fas fa-skull mr-1"></i>New Game
                </button>

                <!-- New FX Overlay -->
                <div id="fx-overlay"></div>

                <img id="scene-image" src="" alt="Scene Visualization" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000">
                
                <!-- NEW IMAGE LOADER STRUCTURE FIX -->
                <div id="image-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-amber-600"></i>
                        <span class="text-xs cinzel tracking-widest text-amber-600">Manifesting Vision...</span>
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4">
                    <h2 id="scene-title" class="text-xl cinzel text-amber-500 text-shadow"></h2>
                </div>
            </div>

            <div id="stats-panel" class="order-4 md:order-none bg-gray-800/80 rounded border border-gray-700 p-3 flex flex-col gap-3 shadow-lg backdrop-blur-sm relative transition-all duration-1000">
                
                <div>
                    <div class="flex justify-between text-xs cinzel text-gray-400 mb-1">
                        <span>Vitality</span>
                        <span id="hp-text">20/20</span>
                    </div>
                    <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-gray-700">
                        <div id="hp-bar" class="bg-red-800 h-full w-full transition-all duration-500"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 text-sm">
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex items-center justify-between">
                        <span class="text-amber-500 cinzel"><i class="fas fa-coins mr-2"></i>Shillings</span>
                        <span id="shillings-display" class="font-bold text-gray-200">0</span>
                    </div>

                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative">
                        <div class="flex justify-between items-center cinzel text-[10px] uppercase tracking-wider font-bold">
                            <span class="text-blue-400"><i class="fas fa-shield-alt mr-1"></i>Order</span>
                            <span class="text-gray-500">Neutral</span>
                            <span class="text-emerald-400">Chaos<i class="fas fa-skull-crossbones ml-1"></i></span>
                        </div>
                        
                        <div class="relative w-full h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-gray-800 to-emerald-900 opacity-60"></div>
                            
                            <div class="absolute left-1/2 top-0 bottom-0 w-px bg-gray-500 z-0"></div>
                            
                            <div id="inf-marker" class="absolute top-0 bottom-0 w-1.5 bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] z-10 rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
                        </div>
                        <div class="text-center text-[10px] text-gray-500 italic" id="inf-status-text">Unknown to all</div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400">Guiding Voice (+1d4)</span>
                        <span class="text-[10px] text-gray-600 italic">Resets on Long Rest</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2" id="crew-panel">
                        </div>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400"><i class="fas fa-briefcase mr-1"></i> Inventory</span>
                    </div>

                    <div id="item-desc-area" class="text-[12px] text-gray-400 h-8 italic mb-2 text-center leading-tight flex items-center justify-center bg-gray-900/50 border border-gray-700/50 rounded px-2 transition-all duration-300">
                        Hover over an item to inspect it.
                    </div>

                    <div id="inventory-panel" class="flex flex-col gap-1">
                        </div>
                </div>
            </div>
        </div>

        <div class="contents md:flex md:flex-col md:w-2/3 gap-4">
            
            <div id="main-scene-text" class="order-2 md:order-none bg-[#111318] rounded border border-gray-700 p-6 shadow-inner relative flex flex-col justify-center min-h-[160px]">
                <div class="text-center text-gray-500 italic">Initializing Story...</div>
            </div>

            <div class="order-3 md:order-none shrink-0 flex flex-col gap-2">
                 <div id="active-crew-indicator" class="hidden text-center text-blue-400 text-xs cinzel animate-pulse mb-1">
                    <i class="fas fa-ghost mr-1"></i> <span id="active-crew-name"></span> is guiding your next move...
                </div>
                <div id="choices-area" class="grid grid-cols-1 gap-2">
                    </div>
            </div>

            <div id="journal-container" class="order-5 md:order-none log-hidden h-96 md:h-[476px] shrink-0 rounded border border-gray-600 bg-gray-800 shadow-2xl flex flex-col overflow-hidden relative">
                <div class="bg-[#0f172a] text-center py-1 border-b border-gray-700 z-10 shadow-md">
                    <h3 class="cinzel text-amber-600 text-sm tracking-[0.2em] font-bold">The Log of The Trident's Kiss</h3>
                </div>
                <div id="journal-scroll-area" class="flex-1 water-stained p-6 overflow-y-auto">
                    <div id="journal-content" class="space-y-6">
                         </div>
                    <div class="h-4"></div>
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
			apiKey: "AIzaSyDlg5dETZJpbJ9GzMV01pUYA06XbFmySbw",
			authDomain: "edward-jones-75546.firebaseapp.com",
			projectId: "edward-jones-75546",
			storageBucket: "edward-jones-75546.firebasestorage.app",
			messagingSenderId: "76799051768",
			appId: "1:76799051768:web:fdd3641b597adfc6a0780d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "edward-jones-standalone";
        let user;

        // --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                // Setup Ambience Loop
                this.ambience = new Audio('audio/ambience.mp3');
                this.ambience.loop = true;
                this.ambience.volume = 0.3; // Quiet by default
                
                // Setup SFX
                this.clickSound = new Audio('audio/click.mp3');
                this.clickSound.volume = 0.5;
                
                this.gaspSound = new Audio('audio/gasp.mp3');
                this.gaspSound.volume = 0.6;
                
                this.clashSound = new Audio('audio/clash.mp3');
                this.clashSound.volume = 0.5;
                
                this.coinsSound = new Audio('audio/coins.mp3');
                this.coinsSound.volume = 0.5;
                
                this.vulnerableSound = new Audio('audio/vulnerable.mp3');
                this.vulnerableSound.volume = 0.6;
                this.vulnerableSound.loop = true; // Loop the panting sound
                
                this.ghostSound = new Audio('audio/ghost.mp3');
                this.ghostSound.volume = 0.4;

                this.isMuted = true;
                this.hasInteracted = false;
                
                // Track if vulnerable sound played this scene to prevent looping
                this.playedVulnerable = false;

                // Bind toggle button
                const btn = document.getElementById('audio-toggle');
                btn.onclick = () => this.toggleMute();
            }

            playSFX(soundObj) {
                if (!this.isMuted) {
                    // Clone to allow overlapping sounds
                    const sound = soundObj.cloneNode();
                    sound.volume = soundObj.volume;
                    sound.play().catch(e => console.log("Audio play blocked"));
                }
            }

            playClick() { this.playSFX(this.clickSound); }
            playGasp() { this.playSFX(this.gaspSound); }
            playClash() { this.playSFX(this.clashSound); }
            playCoins() { this.playSFX(this.coinsSound); }
            playGhost() { this.playSFX(this.ghostSound); }
            
            checkVulnerable(currentHP, maxHP) {
                const pct = (currentHP / maxHP) * 100;
                
                if (pct <= 30) {
                    // Player is vulnerable
                    if (!this.playedVulnerable && !this.isMuted) {
                        // Play the looping sound directly (not a clone)
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                        this.playedVulnerable = true;
                    }
                } else {
                    // Player is healed above threshold - Stop Sound
                    this.vulnerableSound.pause();
                    this.vulnerableSound.currentTime = 0;
                    this.playedVulnerable = false;
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById('audio-toggle');
                const icon = btn.querySelector('i');

                if (!this.isMuted) {
                    // Active State
                    this.ambience.play().catch(e => console.log("Autoplay blocked"));
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-high'); // Active Speaker Icon
                    btn.classList.add('text-amber-500', 'border-amber-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                    
                    // Resume vulnerable sound if active
                    if(this.playedVulnerable) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                    }
                } else {
                    // Muted State
                    this.ambience.pause();
                    this.vulnerableSound.pause(); // Ensure panting stops on mute
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-volume-mute'); // Muted Speaker Icon
                    btn.classList.remove('text-amber-500', 'border-amber-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
            }
        }

        const audioManager = new AudioManager();

        // --- FX MANAGER ---
        class FXManager {
            constructor() {
                this.overlay = document.getElementById('fx-overlay');
            }

            clearEffects() {
                // Remove all effects except flash animations (they remove themselves)
                this.overlay.classList.remove('fx-pulse-violet', 'fx-vignette-low');
            }

            flashRed() {
                this.overlay.classList.add('fx-flash-red');
                setTimeout(() => this.overlay.classList.remove('fx-flash-red'), 400);
            }
            
            setPulse(active) {
                if(active) this.overlay.classList.add('fx-pulse-violet');
                else this.overlay.classList.remove('fx-pulse-violet');
            }

            setVignette(active) {
                if(active) this.overlay.classList.add('fx-vignette-low');
                else this.overlay.classList.remove('fx-vignette-low');
            }
        }
        
        const fxManager = new FXManager();

        // --- STATIC IMAGE MAPPING ---
		const sceneImages = {
			'prologue_storm': 'images/storm.jpg',
			'prologue_abyss': 'images/abyss.jpg',
			'start': 'images/wreckage.jpg',
			'wreckage_success': 'images/chest.jpg',
			'wreckage_fail': 'images/sand_empty.jpg', 
			'treeline': 'images/forest.jpg',
			'treeline_prepared': 'images/forest.jpg',
			'road_encounter': 'images/guard_road.jpg',
			'trail_success': 'images/smuggler_cove_high.jpg',
			'trail_success_talon': 'images/smuggler_cove_high.jpg',
			'trail_fail': 'images/stumble_guard.jpg', 
			'guard_talk': 'images/guard_face.jpg',
			'guard_respect': 'images/guard_salute.jpg', 
			'guard_bribe': 'images/guard_bribe.jpg', 
			'guard_scared': 'images/guard_scared.jpg', 
			'combat_guard': 'images/combat_hammer.jpg', 
			'smuggler_meet': 'images/smuggler_standoff.jpg',
            'smuggler_cargo': 'images/smuggler_pay.jpg',			
			'smuggler_friend': 'images/smuggler_rum.jpg', 
			'smuggler_pay': 'images/smuggler_pay.jpg', 
			'market_crossroads': 'images/market.jpg',
			'market_stall': 'images/merchant.jpg',
			'market_sell': 'images/merchant.jpg', 
			'buy_potion': 'images/merchant.jpg',
			'buy_rope': 'images/merchant.jpg',
			'buy_torch': 'images/merchant.jpg',
			'sell_rope': 'images/merchant.jpg',
			'sell_torch': 'images/merchant.jpg',
            'sell_cargo': 'images/merchant.jpg', 
			'sell_potion': 'images/merchant.jpg',
			'sell_rum': 'images/merchant.jpg',
			'lighthouse_split': 'images/lighthouse_far.jpg',
			'cliff_climb': 'images/cliff.jpg',
			'climb_fail': 'images/fall_cliff.jpg', 
			'dark_caves': 'images/caves.jpg',
            'dark_caves_illuminated': 'images/caves.jpg', 
			'dark_fail': 'images/cave_injury.jpg', 
			'lighthouse_arrival': 'images/lighthouse_door.jpg',
            'lighthouse_neutralized': 'images/lighthouse_door.jpg', 
			'ending_order': 'images/guards_win.jpg',
			'ending_chaos': 'images/smugglers_win.jpg',
			'ending_neutral': 'images/lockpick.jpg', 
			'lighthouse_vigil': 'images/dream.jpg',
			'lighthouse_rest': 'images/dream.jpg',
			'default': 'https://placehold.co/600x400/0f172a/1e293b?text=The+Void' 
		};
        
        // --- GAME DATA FACTORY ---
        function createInitialState() {
            return {
                currentSceneId: 'prologue_storm', 
                currentHP: 20,
                maxHP: 20,
                shillings: 0, 
                inventory: [], 
                influence: 0, 
                crewUseFree: false, 
                lastCrewUsedId: null, 
                // REMOVED GLOBAL ITEM STOCK
                crew: {
                    gareth: { id: 'gareth', name: 'Captain Gareth', skill: 'Insight', used: false, desc: 'Add +1d4 to Initiative & Insight' },
                    quinn: { id: 'quinn', name: 'Quinn', skill: 'Investigation', used: false, desc: 'Add +1d4 to Investigation & History' },
                    talon: { id: 'talon', name: 'Talon', skill: 'Perception', used: false, desc: 'Add +1d4 to Survival & Perception' },
                    bones: { id: 'bones', name: 'Bones', skill: 'Survival', used: false, desc: 'Add +1d4 to Nature & Foraging' }
                },
                history: [] 
            };
        }

        let gameState = createInitialState();
        let activeCrewMember = null;

        // Interactive Items Definition
        const itemRegistry = {
            "Ship's Log": { type: 'key', icon: 'fa-book-skull', color: 'text-amber-700', desc: "Key Item: Records of the damned. Unlocks your history." },
            "Captain's Tricorn": { type: 'key', icon: 'fa-hat-cowboy', color: 'text-blue-500', desc: "Passive: The heavy felt hat of your predecessor." },
            "Rum (Heal 5)": {
                name: "Rum (Heal 5)",
                type: 'consumable',
                icon: 'fa-wine-bottle',
                color: 'text-amber-500',
                btnText: "DRINK",
                desc: "Consumable: Potent grog. Restores 5 HP immediately.",
                action: (state) => {
                    const healAmount = 5;
                    const oldHP = state.currentHP;
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    const idx = state.inventory.indexOf("Rum (Heal 5)");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Rum. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Healing Potion": {
                name: "Healing Potion",
                type: 'consumable',
                icon: 'fa-flask',
                color: 'text-red-500',
                btnText: "DRINK",
                desc: "Consumable: Alchemical vitality. Restores 10 HP.",
                action: (state) => {
                    const healAmount = 10;
                    const oldHP = state.currentHP;
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Potion. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Pearlescent Mushroom": { 
                type: 'consumable',
                icon: 'fa-cloud-meatball', 
                color: 'text-purple-300',
                btnText: "MUNCH",
                desc: "Consumable: A subterranean mushroom. Provides mental clarity, making your next Guiding Voice check FREE (crew member is not expended).",
                action: (state) => {
                    state.crewUseFree = true;
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Consumed Pearlescent Mushroom. Your next Guiding Voice check will be FREE.`;
                }
            },
            "Curious Cargo": { // NEW ITEM: Influence driver
                name: "Curious Cargo",
                type: 'key',
                icon: 'fa-box-open', 
                color: 'text-yellow-600',
                desc: "Passive: A heavy crate of smuggled goods. Can be sold to the Merchant for coin or traded to the smugglers for influence.",
                btnText: "SELL",
                action: (state) => {
                    return "Must be sold at the Market or traded at the Cove.";
                }
            },
            "Rusted Cutlass": { type: 'key', icon: 'fa-khanda', color: 'text-gray-400', desc: "Passive: A reliable blade. Required for certain combat events." },
            "Rope": { type: 'key', icon: 'fa-om', color: 'text-yellow-700', desc: "Passive: Essential for climbing cliffs." },
            "Torch": { type: 'key', icon: 'fa-fire', color: 'text-orange-500', desc: "Passive: Illuminates dark caves." },
            "Strange Coin": { type: 'key', icon: 'fa-circle-notch', color: 'text-yellow-600', desc: "Passive: Ancient currency. May open doors not made of wood." },
            "Compass": { type: 'key', icon: 'fa-compass', color: 'text-blue-400', desc: "Passive: Points not north, but towards something unholy." }
        };
        
        function getBonusForSkill(crewMember, skillType) {
            // Mapping based on character sheet
            const expertise = {
                'Captain Gareth': ['Insight', 'Initiative'],
                'Quinn': ['Investigation', 'History'],
                'Talon': ['Survival', 'Perception'],
                'Bones': ['Survival', 'Nature', 'Medical'] // Bones has overlaps
            };

            const allowedSkills = expertise[crewMember.name] || [];
            return allowedSkills.includes(skillType);
        }

        // --- SCENE DATABASE ---
        const scenes = {
            'prologue_storm': {
                title: "The Planar Storm",
                text: "The deck of The Trident's Kiss heaves violently. Above, the sky isn't black, but a bleeding violet bruise. Captain Gareth stands at the wheel, singing against the gale. '...But who pays the toll for the army of dead?!' he roars, laughing at the violet sky. Quinn, the Quartermaster, is frantically tying down crates on the main deck.",
                journal: "It started with the sky tearing open. Gareth tried to hold the course. Quinn tried to save the cargo. I just tried to stand.",
                // REMOVED GARETH BANTER HERE
                choices: [
                    { text: "Help Quinn secure the cargo", nextScene: 'prologue_abyss', type: 'travel' },
                    { text: "Stand with the Captain", nextScene: 'prologue_abyss', type: 'travel' }
                ]
            },
            'prologue_abyss': {
                title: "The God of the Deep",
                text: "A wave of pure magical force shatters the hull like glass. The freezing dark claims you instantly. As you sink, drifting into the abyss, you see IT rising from the depths—a colossal shadow, vast as a mountain, with eyes like dying stars. The screams of Gareth, Quinn, Talon, and Bones are silenced by the water... then they echo *inside* your skull.",
                journal: "The ship shattered. I sank. I saw a... Shadow... something ancient. And then the voices began.",
                choices: [
                    { text: "Gasp for air (Wake Up)", nextScene: 'start', type: 'travel' }
                ]
            },
            'start': {
                title: "The Wreckage",
                text: "You gasp, lungs burning, and retch salt water onto the grey sand. The storm has passed. 'The Trident's Kiss' lies shattered across the shore. The voices are loud now—Gareth's command, Quinn's panic—bickering inside your head. You are alive, but you are a vessel for the dead.",
                journal: "I awoke on the shore. Alive. But they are with me now. Bound to me.",
                banter: {
                    'quinn': "The answers are in the debris, Edward. Dig."
                },
                onEnter: (state) => {
                    // AUDIO: Gasp sound on wake up
                    audioManager.playGasp();
                    return null;
                },
                choices: [
                    { text: "Search the debris (Investigation)", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'wreckage_search': {
                isLogic: true,
                resolve: (roll) => roll >= 8 ? 'wreckage_success' : 'wreckage_fail'
            },
            'wreckage_success': {
                title: "Salvage",
                text: "Quinn guides your hand to a buried chest. Inside, you find a Rusted Cutlass, a pouch of Shillings, and Captain Gareth's Tricorn Hat. You place the hat on your head, and the voices quiet slightly. Quinn then points frantically to a damp book nearby—the Ship's Log.",
                journal: "Found a blade, coin, and the Captain's Hat. Quinn insisted I take the Logbook. It holds our history.",
                onEnter: (state) => {
                    const items = ["Rusted Cutlass", "Captain's Tricorn", "Ship's Log"];
                    let found = false;
                    items.forEach(i => {
                        if(!state.inventory.includes(i)) {
                            state.inventory.push(i);
                            found = true;
                        }
                    });
                    if (found) {
                        state.shillings += 7; 
                        audioManager.playCoins();
                        return "Found: Cutlass, Hat, Log & 7 Shillings.";
                    }
                    return null;
                },
                choices: [{ text: "Move to Treeline", nextScene: 'treeline_prepared', type: 'travel' }]
            },
            'wreckage_fail': {
                title: "Empty Sands",
                text: "You dig through the driftwood until your fingers bleed, but find nothing of value. The tide is rising.",
                journal: "Scavenging yielded nothing but splinters.",
                choices: [{ text: "Move to Treeline", nextScene: 'treeline', type: 'travel' }]
            },
            'treeline_prepared': {
                title: "The Whispering Woods",
                text: "The forest looms ahead, trees twisted like grasping hands. You adjust the weight of the cutlass and logbook. The voices are a dull murmur, satisfied for the moment. A well-traveled road cuts through the center, but Talon notices a faint game trail disappearing into the brush.",
                journal: "I reached the treeline with the Log and my gear. The voices are quieter now. Talon pointed out a hidden path.",
                banter: {
                    'gareth': "Stick to the road, lad. We need steady ground.",
                    'talon': "The road is watched. The wild is ours.",
                    'bones': "Game trail. Good eating, safe walking." 
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead (Survival DC 12 - Talon/Bones)", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'treeline': {
                title: "The Whispering Woods",
                text: "The forest looms ahead. As you step forward, Quinn screams in your mind. 'The Log! Don't leave the history!' You stumble, looking down to see the water-logged Ship's Log at your feet. You pick it up to silence him.",
                journal: "Quinn wouldn't let me leave without the Log. I found it at the treeline.",
                onEnter: (state) => {
                    if(!state.inventory.includes("Ship's Log")) {
                        state.inventory.push("Ship's Log");
                        return "Obtained Ship's Log (Required).";
                    }
                    return null;
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead (Survival DC 12 - Talon/Bones)", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'road_encounter': {
                title: "The King's Guard",
                text: "A heavy-set <span class='memory-keyword' data-lore='The iron fist of the Crown. They despise the supernatural and govern with martial law.'>Royal Guard</span> in plate armor blocks the path. He's nailing a 'WANTED' poster to a tree. He spots you immediately. 'Halt! Identify yourself, traveler.'",
                journal: "Ran into a Royal Guard on the main road. No way to hide now.",
                choices: [
                    { text: "Speak diplomatically", nextScene: 'guard_talk', type: 'dialogue' },
                    { text: "Attack him", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
            // Modified Logic Scene to check for Talon being used
            'trail_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    const success = roll >= state.lastDC;
                    
                    if (success) {
                        // If successful AND Talon was the crew used, go to special cargo scene
                        if (state.lastCrewUsedId === 'talon') {
                            return 'trail_success_talon';
                        }
                        // Otherwise (success with Bones or no crew), send to normal success
                        return 'trail_success';
                    }
                    
                    return 'trail_fail';
                }
            },
            // Original trail_success text is now for Bones or no crew (no cargo)
            'trail_success': {
                title: "Hidden Signs",
                text: "You struggle through the thorns but emerge near a hidden cove, overlooking a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "The trail was tough, but we found a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    // RE-IMPLEMENTED BASE CHAOS GAIN
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to the Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            // NEW SCENE for Talon's specific success (acquiring cargo)
            'trail_success_talon': {
                title: "Smuggler's Route",
                text: "Talon guides your movement, emphasizing silence and observation. You emerge near a hidden cove, spotting a marked crate abandoned near the tideline—Curious Cargo. You grab it just before noticing a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "Talon's skill led me through the brush. Found Curious Cargo and reached a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    // RE-IMPLEMENTED BASE CHAOS GAIN
                    state.influence = Math.min(20, state.influence + 4); 
                    if (!state.inventory.includes("Curious Cargo")) {
                        state.inventory.push("Curious Cargo");
                        return "Found Curious Cargo. Secrets Learned (Chaos +4).";
                    }
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to the Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'trail_fail': {
                title: "Lost",
                text: "The undergrowth fights you. You stumble out of the brush, loud and covered in burrs, right in front of a Royal Guard.",
                journal: "Tried the hidden path, but made too much noise. Stumbled right into a Guard.",
                onEnter: (state) => { 
                    state.currentHP -= 2; 
                    fxManager.flashRed();
                    return "Took 2 Scratch Damage."; 
                },
                choices: [{ text: "Confront the Guard", nextScene: 'road_encounter', type: 'dialogue' }] 
            },
            'guard_talk': {
                title: "The Interrogation",
                text: "The Guard eyes your ragged clothes. 'You look like wreckage refuse. We have reports of smugglers. Make it worth my while, or I'll haul you in.'",
                journal: "The Guard is corrupt. He wants a bribe or a reason to let me go.",
                banter: {
                    'gareth': "Stand tall. Authority respects strength, or gold."
                },
                choices: [
                    { text: "Bribe him (5 Shillings)", nextScene: 'guard_bribe', type: 'action', cost: 5 },
                    { text: "Show Respect (Diplomacy)", nextScene: 'guard_respect', type: 'dialogue' },
                    { text: "Intimidate him (Insight DC 13)", nextScene: 'guard_intimidate_check', type: 'skill', dc: 13, skill: 'Insight' },
                    { text: "Attack", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
            'guard_respect': {
                title: "Order and Law",
                text: "You salute with practiced discipline. 'Just a shipwrecked sailor, sir. Keeping to the road.' The Guard straightens, recognizing the posture. 'Carry on then. Watch for the cove rats.'",
                journal: "I showed the Guard respect. He treated me like a man, not a rat.",
                onEnter: (state) => {
                    state.influence = Math.max(-20, state.influence - 4); 
                    return "Showed Respect (Order -4)";
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'guard_bribe': {
                title: "The Toll",
                text: "He bites the gold. 'Get moving. Head to the Market, don't linger here.'",
                journal: "Paid the toll. I played the game and walked away neutral.",
                onEnter: (state) => { 
                    audioManager.playCoins();
                    return "Bribed Guard (Neutral Act)."; 
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'guard_intimidate_check': {
                isLogic: true,
                resolve: (roll) => roll >= 13 ? 'guard_scared' : 'combat_guard'
            },
            'guard_scared': {
                title: "Spectral Fear",
                text: "You channel Gareth's command. Your eyes flare with pale light. The Guard stumbles back, terrified. 'Go! Just go!'",
                journal: "Gareth spoke through me. The Guard fled in terror.",
                onEnter: (state) => { 
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Guard Terrified (Chaos +4)."; 
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'combat_guard': {
                title: "Steel Clashes",
                text: "He draws his hammer. The fight is brutal and short. You survive, but you are now an enemy of the crown.",
                journal: "Had to fight the Guard. I am an outlaw now.",
                onEnter: (state) => { 
                    audioManager.playClash();
                    const dmg = Math.floor(Math.random() * 6) + 10; // Increased damage: 10-15
                    state.currentHP -= dmg;
                    fxManager.flashRed(); // Trigger Visual Damage
                    state.influence = 20; // Max Chaos
                    return `Took ${dmg} damage. Became Outlaw (Max Chaos).`;
                },
                choices: [{ text: "Limp to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_meet': {
                title: "The Cove",
                text: "The men draw blades as you approach. 'One step closer and you're fish food!'",
                journal: "Found the smugglers. They aren't friendly.",
                choices: [
                    { text: "Flash 'The Mariner's Sign' (Req: Chaos +3)", nextScene: 'smuggler_friend', type: 'dialogue', reqSmuggler: 3 },
                    // CHOICE: Offer Curious Cargo (Chaos Only)
                    { text: "Offer Curious Cargo (+6 Chaos)", nextScene: 'smuggler_cargo', type: 'action', reqItem: 'Curious Cargo' },
                    { text: "Buy safe passage (5 Shillings)", nextScene: 'smuggler_pay', type: 'action', cost: 5 },
                    { text: "Run to Market", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            // SMUGGLER TRADE SCENE (Chaos Only, No Coin)
            'smuggler_cargo': {
                title: "A Smuggler's Trust",
                text: "The lead smuggler inspects the crate, nodding slowly. 'This is high-value. You've earned our trust, Mariner. Your loyalty is payment enough.'",
                journal: "Traded Curious Cargo directly to the smugglers for high influence.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    // Stock is handled by consuming the item from player inventory (since this isn't a merchant sale)
                    state.influence = Math.min(20, state.influence + 6); // High Chaos gain
                    return "Gave Cargo. Chaos +6.";
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_friend': {
                title: "Old Alliances",
                text: "They recognize the sign. 'The Mariner lives? We have something of yours.' They hand you a bottle of Rum.",
                journal: "The smugglers recognized the code. Gave me Rum.",
                onEnter: (state) => {
                     state.inventory.push("Rum (Heal 5)");
                     return "Received Rum.";
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_pay': {
                title: "Business",
                text: "They take the coin. 'Don't let the Guard see you.'",
                journal: "Paid the smugglers off.",
                onEnter: (state) => {
                    audioManager.playCoins();
                    return "Paid Smugglers.";
                },
                choices: [{ text: "Head to Market Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'market_crossroads': {
                title: "The Port of Shadows",
                text: "You arrive at the edge of the ramshackle port town. Merchants hawk their wares under tattered awnings. The Lighthouse looms in the distance, but the path is treacherous.",
                journal: "Reached the Port Market. I should stock up before the final push.",
                choices: [
                    { text: "Visit the Merchant", nextScene: 'market_stall', type: 'travel' },
                    { text: "Head to the Lighthouse", nextScene: 'lighthouse_split', type: 'travel' }
                ]
            },
            'market_stall': {
                title: "The Merchant",
                text: "A hooded figure displays goods on a crate. 'Coin for survival, traveler?'",
                journal: null,
                // --- LOCAL STOCK DEFINITION ---
                stock: {
                    "Healing Potion": 1,
                    "Rope": 1,
                    "Torch": 1,
                    "Curious Cargo": 1 // Tracks how many times this merchant will buy the cargo
                },
                // --- END LOCAL STOCK ---
                banter: {
                    'quinn': "Supplies are the difference between a legend and a corpse. Buy what you can."
                },
                choices: [
                    // Dynamic Buy Options checking local stock
                    // NOTE: Need to hardcode strings here since dynamic generation is limited by static choice array definition
                    { text: `Buy Healing Potion (5s, Stock: ${scenes['market_stall'].stock['Healing Potion']})`, nextScene: 'buy_potion', type: 'action', cost: 5, reqStock: {item: "Healing Potion", scene: 'market_stall'} },
                    { text: `Buy Rope (3s, Stock: ${scenes['market_stall'].stock['Rope']})`, nextScene: 'buy_rope', type: 'action', cost: 3, reqStock: {item: "Rope", scene: 'market_stall'} },
                    { text: `Buy Torch (2s, Stock: ${scenes['market_stall'].stock['Torch']})`, nextScene: 'buy_torch', type: 'action', cost: 2, reqStock: {item: "Torch", scene: 'market_stall'} },
                    
                    { text: "Sell Wares (Earn Coin)", nextScene: 'market_sell', type: 'travel' },
                    { text: "Leave", nextScene: 'lighthouse_split', type: 'travel' }
                ]
            },
            'market_sell': {
                title: "The Merchant - Selling",
                text: "The merchant eyes your gear. 'I can take some of that off your hands for a fair price.'",
                journal: null,
                choices: [
                    // Selling Option to Merchant - checks player inventory AND merchant buy stock
                    ...(gameState.inventory.includes("Curious Cargo") && scenes['market_stall'].stock['Curious Cargo'] > 0 ? [{ text: "Sell Curious Cargo (+10s)", nextScene: 'sell_cargo', type: 'action', reqItem: 'Curious Cargo', reqStock: {item: "Curious Cargo", scene: 'market_stall'} }] : []),
                    
                    { text: "Sell Rope (+2s)", nextScene: 'sell_rope', type: 'action', reqItem: 'Rope' },
                    { text: "Sell Torch (+1s)", nextScene: 'sell_torch', type: 'action', reqItem: 'Torch' },
                    { text: "Sell Potion (+3s)", nextScene: 'sell_potion', type: 'action', reqItem: 'Healing Potion' },
                    { text: "Sell Rum (+2s)", nextScene: 'sell_rum', type: 'action', reqItem: 'Rum (Heal 5)' }, 
                    { text: "Back to Buying", nextScene: 'market_stall', type: 'travel' }
                ]
            },
            // Merchant Sale Scene (Coin Only, No Influence)
            'sell_cargo': {
                title: "The Transaction",
                text: "The merchant accepts the crate without comment, paying the agreed price.",
                journal: "Sold the Curious Cargo for coin.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0; // Consume stock on the merchant's scene definition
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+10s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_rope': {
                title: "Sold",
                text: "You hand over the rope.",
                journal: "I sold the rope.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rope");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2;
                    audioManager.playCoins();
                    return "Sold Rope (+2s)";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_torch': {
                title: "Sold",
                text: "You hand over the torch.",
                journal: "I sold the torch.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Torch");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 1;
                    audioManager.playCoins();
                    return "Sold Torch (+1s)";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_potion': {
                title: "Sold",
                text: "You hand over the potion.",
                journal: "I sold the potion.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 3;
                    audioManager.playCoins();
                    return "Sold Potion (+3s)";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_rum': {
                title: "Sold",
                text: "You hand over the bottle of rum.",
                journal: "I handed over the bottle of rum.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rum (Heal 5)");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2; 
                    audioManager.playCoins();
                    return "Sold Rum (+2s)";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'buy_potion': {
                title: "Purchase",
                text: "You exchange coin for the red liquid.",
                journal: "I bought a healing potion.",
                onEnter: (state) => { 
                    state.inventory.push("Healing Potion"); 
                    scenes['market_stall'].stock["Healing Potion"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Potion."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'buy_rope': {
                title: "Purchase",
                text: "You coil the sturdy hemp rope over your shoulder.",
                journal: "I bought a coil of rope.",
                onEnter: (state) => { 
                    state.inventory.push("Rope"); 
                    scenes['market_stall'].stock["Rope"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Rope."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'buy_torch': {
                title: "Purchase",
                text: "A simple torch, dipped in pitch.",
                journal: "I bought a torch.",
                onEnter: (state) => { 
                    state.inventory.push("Torch"); 
                    scenes['market_stall'].stock["Torch"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Torch."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'lighthouse_split': {
                title: "The Final Approach",
                text: "The Lighthouse stands atop a jagged cliff. Two paths present themselves: a sheer climb up the rock face, or a dark, winding tunnel through the sea caves below.",
                journal: "Two ways to the top: climb the cliff or brave the dark caves.",
                choices: [
                    { text: "Climb the Cliff", nextScene: 'cliff_climb', type: 'travel' },
                    { text: "Enter the Sea Caves", nextScene: 'dark_caves', type: 'travel' }
                ]
            },
            'cliff_climb': {
                title: "The Precipice",
                text: "The wind howls, threatening to tear you from the rock.",
                choices: [
                    { text: "Use Rope (Safe Climb)", nextScene: 'lighthouse_arrival', type: 'action', reqItem: 'Rope', consume: true },
                    { text: "Free Solo (Athletics DC 14)", nextScene: 'climb_check', type: 'skill', dc: 14, skill: 'Athletics' } 
                ]
            },
            'climb_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'lighthouse_arrival' : 'climb_fail'
            },
            'climb_fail': {
                title: "Slip and Fall",
                text: "Your grip fails. You slide twenty feet, shredding skin against stone before catching a root.",
                journal: "Almost fell to my death. Climbing without rope was foolish.",
                onEnter: (state) => { 
                    state.currentHP -= 5; 
                    fxManager.flashRed();
                    return "Took 5 Damage."; 
                },
                choices: [{ text: "Keep Climbing", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'dark_caves': {
                title: "The Abyss Below",
                text: "The air is thick and smells of rot. It is pitch black.",
                banter: {
                    'bones': "Damp... dark... good place for mushrooms, bad for ankles."
                },
                choices: [
                    { text: "Light Torch (Safe Passage)", nextScene: 'dark_caves_illuminated', type: 'action', reqItem: 'Torch', consume: true },
                    { text: "Stumble in Dark (Perception DC 14)", nextScene: 'dark_check', type: 'skill', dc: 14, skill: 'Perception' }
                ]
            },
            // Updated Mushroom Scene
            'dark_caves_illuminated': {
                title: "Torch's End",
                text: "The fire dies, but not the light. A patch of pale, smooth mushrooms provides an eerie illumination. You remember Bones's banter and collect the specimen for its promised clarity.",
                journal: "Bones was right. Used the torch and found the Pearlescent Mushroom.",
                onEnter: (state) => {
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found: Pearlescent Mushroom.";
                    }
                    return "Torch expended.";
                },
                choices: [{ text: "Proceed to Exit", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'dark_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'lighthouse_arrival' : 'dark_fail'
            },
            'dark_fail': {
                title: "Unseen Dangers",
                text: "In the dark, you trip over unseen rocks and twist your ankle. Something scuttles away in the shadows.",
                journal: "The caves were too dark. I got hurt.",
                onEnter: (state) => { 
                    state.currentHP -= 4; 
                    fxManager.flashRed();
                    return "Took 4 Damage."; 
                },
                choices: [{ text: "Limp to the Exit", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'lighthouse_arrival': {
                title: "The Beacon",
                text: "You reach the heavy iron doors of the Lighthouse. But you are not alone.",
                journal: "Made it to the Lighthouse doors. Someone is waiting.",
                choices: [
                    { text: "Confront them", nextScene: 'faction_check', type: 'travel' }
                ]
            },
            'faction_check': {
                isLogic: true,
                resolve: (r, state) => {
                    if (state.influence <= -4) return 'ending_order'; 
                    if (state.influence >= 4) return 'ending_chaos'; 
                    return 'ending_neutral';
                }
            },
            'ending_order': {
                title: "The Deputy",
                text: "A squad of Royal Guards stands at the door. Their captain salutes you. 'We heard you cleared out the riff-raff on the road. The Lighthouse is yours to secure, Deputy.' They open the doors for you.",
                journal: "The Guards respect me. They let me pass without question. Order has its perks.",
                choices: [{ text: "Enter and Rest", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_chaos': {
                title: "Smuggler's Ally",
                text: "Smugglers lounge by the entrance. They grin as you approach. 'The Mariner! We heard you made a fool of the Guard. This haven is open to you, brother.' They toss you a key.",
                journal: "The smugglers see me as one of their own. They gave me the key.",
                choices: [{ text: "Enter and Rest (Demo End)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral': {
                title: "The Shadow",
                text: "The door is barred. No one is here to welcome you. You must pick the lock yourself, slipping in like a ghost, unseen by Guard or Smuggler alike.",
                journal: "I arrived alone. I enter alone. No allies, no enemies.",
                choices: [{ text: "Enter and Rest (Demo End)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'lighthouse_vigil': {
                title: "Charting Course",
                text: "The lighthouse lamp cuts a bright path through the dark, but your gaze is fixed on the water-warped pages of the Ship's Log. The ink has run on the coordinates, but Gareth's handwriting remains clear on the final page—the lyrics to the 'Wolf King's Toll'.<br><br>The bickering voices in your mind fall silent. Then, softly, they begin to hum the melody in unison. It is not a myth; it is a map. To ferry your crew to the afterlife, you must locate these lost artifacts known as the Wolves of Valor.",
                journal: null,
                onEnter: (state) => {
                    const shanty = `The shanty holds the truth. I must find the Ring and the Blade to save my crew. I am the Captain now.<br><br>
                      <i class='text-blue-300'>“There’s a tax for the coin and a tax for the bread,<br>
                      But who pays the toll for the army of dead?<br>
                      The Wolf King did, so the legends say,<br>
					  To call back the souls who lost their way.<br><br>
					  He found the Ring of ancient Brass,<br>
					  And the Blade that lets no Vampire pass.<br>
					  He gave them a home and a people to keep,<br>
					  And woke the crew from their deep cold sleep.<br><br>
					  The dead stood fast 'til the war was won,<br>
					  Then vanished like mist in the morning sun.<br>
                      Now the Ring and the Blade are lost at sea,<br>
                      Waiting for a Captain as cursed as he.“</i>`;
                    
                    addToHistory(shanty, 'entry');
                    
                    state.currentHP = state.maxHP;
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    return "Mission Accepted: Find the Wolves of Valor.";
                },
                choices: [
                    { text: "Search for the Wolves of Valor (End Demo)", type: 'reset' },
					{ text: "Rest one more night", nextScene: 'lighthouse_rest', type: 'rest' }
                ]
            },
			'lighthouse_rest': {
                title: "Extra Rest",
                text: "The lantern's warm glow offers a calming sanctuary as the storm crashes against the lighthouse walls. After securing your hoisted hammock, its soft, steady sway swiftly lulls you to sleep",
                journal: null,
                onEnter: (state) => {
                    const restNote = "I took an extra night at the lighthouse to rest up and prepare a charter.";
                    addToHistory(restNote, 'entry');
                    state.currentHP = state.maxHP;
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                },
                choices: [
                    { text: "Search for the Wolves of Valor (End Demo)", type: 'reset' }
                ]
            }
        };

        // --- CORE FUNCTIONS ---

        async function generateSceneImage(sceneId) {
            const key = sceneId || 'default';
            const url = sceneImages[key] || sceneImages['default'];
            
            const imgEl = document.getElementById('scene-image');
            const loader = document.getElementById('image-loader');
            
            // Hide image, show loader immediately for visual feedback
            imgEl.style.opacity = 0;
            loader.style.display = 'flex';
            imgEl.src = ''; // Clear previous image

            // Use a temporary image object to manage loading state reliably
            const tempImg = new Image();
            tempImg.src = url;

            tempImg.onload = () => {
                // Once loaded, apply source, hide loader, and fade in
                imgEl.src = url;
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };

            tempImg.onerror = () => {
                // Fallback to placeholder on error
                console.warn(`Failed to load image for scene: ${sceneId}. Falling back to placeholder.`);
                imgEl.src = sceneImages['default'];
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };
        }

        async function init() {
            window.confirmReset = confirmReset;
            window.resetGame = resetGame; 

            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    user = u;
                    await setupRealtimeListener();
                    document.getElementById('app-loading').classList.add('fade-out');
                    setTimeout(() => document.getElementById('app-loading').remove(), 500);
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        async function setupRealtimeListener() {
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            
            try {
                const snap = await getDoc(docRef);
                if (!snap.exists()) {
                    await setDoc(docRef, gameState);
                    renderScene('prologue_storm');
                } else {
                    const data = snap.data();
                    if (data.influence === undefined) {
                        data.influence = 0; 
                        delete data.guardInfluence;
                        delete data.smugglerInfluence;
                    }
                    // Merge saved data with default to ensure new fields are included
                    const savedState = { ...createInitialState(), ...data }; 
                    gameState = savedState;
                    
                    // --- PERSIST SCENE STOCK CHANGES ---
                    // This ensures any purchases/sales made before the last save persist 
                    // on the scene object, not just in the state.
                    if (data.market_stall_stock) {
                         scenes['market_stall'].stock = data.market_stall_stock;
                    }
                    
                    renderScene(gameState.currentSceneId, false);
                    rebuildJournal();
                }
            } catch (e) {
                console.error("Save error", e);
                renderScene('prologue_storm');
            }

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (JSON.stringify(data) !== JSON.stringify(gameState)) {
                        
                        // Apply scene specific stock changes from Firestore to the runtime scene object
                        if (data.market_stall_stock) {
                            scenes['market_stall'].stock = data.market_stall_stock;
                            delete data.market_stall_stock; // Don't overwrite gameState with this old field
                        }

                        gameState = { ...gameState, ...data };
                        updateUI();
                    }
                }
            });
        }

        async function saveGame() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            const safeState = JSON.parse(JSON.stringify(gameState));
            
            // --- ATTACH SCENE STOCK TO SAVED STATE ---
            safeState.market_stall_stock = scenes['market_stall'].stock;

            await setDoc(docRef, safeState);
        }

        let resetConfirmTimer = null;
        function confirmReset() {
            const btn = document.getElementById('reset-game-btn');
            if (btn.classList.contains('bg-red-900')) {
                resetGame();
                clearTimeout(resetConfirmTimer);
                btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                btn.classList.remove('bg-red-900', 'text-white');
                btn.classList.add('text-red-400', 'bg-black/60');
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Confirm?';
                btn.classList.remove('text-red-400', 'bg-black/60');
                btn.classList.add('bg-red-900', 'text-white');
                resetConfirmTimer = setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                    btn.classList.remove('bg-red-900', 'text-white');
                    btn.classList.add('text-red-400', 'bg-black/60');
                }, 3000);
            }
        }

        async function resetGame() {
            // Reset state
            gameState = createInitialState();
            // Reset scene data manually (needed for market stock)
            scenes['market_stall'].stock = createInitialState().itemStock;

            document.getElementById('journal-content').innerHTML = '';
            await saveGame();
            renderScene('prologue_storm');
            rebuildJournal();
            document.getElementById('inf-status-text').textContent = "Unknown to all";
            document.getElementById('item-desc-area').textContent = "Hover over an item to inspect it.";
        }

        function rebuildJournal() {
            const container = document.getElementById('journal-content');
            container.innerHTML = gameState.history.join('');
            scrollToBottom();
        }

        function scrollToBottom() {
            const area = document.getElementById('journal-scroll-area');
            area.scrollTop = area.scrollHeight;
        }

        function addToHistory(text, type = 'entry') {
            let html = '';
            if (type === 'entry') {
                html = `<div class="journal-font pb-4 border-b border-gray-700/30 text-gray-400 fade-in">${text}</div>`;
            } else if (type === 'system') {
                html = `<div class="text-xs text-amber-500 font-mono mb-2 fade-in">> ${text}</div>`;
            } else if (type === 'roll') {
                html = `<div class="text-xs text-blue-400 font-bold mb-2 fade-in font-serif">${text}</div>`;
            }
            gameState.history.push(html);
            rebuildJournal();
        }

        async function renderScene(sceneId, logText = true) {
            const scene = scenes[sceneId];
            if (!scene) return;

            // Check for death before rendering
            if (gameState.currentHP <= 0 && sceneId !== 'start' && !sceneId.includes('prologue')) {
                document.getElementById('main-scene-text').innerHTML = 
                    `<div class="text-red-600 font-bold text-xl text-center cinzel">Edward has fallen.</div>
                     <div class="text-center mt-4">The voices consume you.</div>`;
                document.getElementById('choices-area').innerHTML = 
                    `<button onclick="window.resetGame()" class="w-full p-4 bg-red-900 text-white rounded cinzel border border-red-500 hover:bg-red-800">Resurrect (Restart)</button>`;
                return;
            }

            if (scene.isLogic) {
                let roll = Math.floor(Math.random() * 20) + 1;
                let crewUsedName = "None";
                let logMsg = `Check (DC ${gameState.lastDC || 10}): Rolled d20 (${roll})`;
                
                // Clear last used crew ID before a new check
                gameState.lastCrewUsedId = null;

                if (activeCrewMember) {
                    const isSkilled = getBonusForSkill(activeCrewMember, gameState.lastSkillType);
                    
                    if (isSkilled || gameState.crewUseFree) {
                        const bonus = Math.floor(Math.random() * 4) + 1;
                        roll += bonus;
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + ${bonus} (${crewUsedName})`;

                        const crewKey = activeCrewMember.id;
                        
                        // If it's not a free use, mark as used
                        if (!gameState.crewUseFree) {
                            gameState.crew[crewKey].used = true;
                            // Store the ID of the crew member used on this successful check
                            if (roll >= gameState.lastDC) {
                                gameState.lastCrewUsedId = crewKey;
                            }
                        }
                        gameState.crewUseFree = false; // Consume the free use if it existed
                    } else {
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + 0 (${crewUsedName} - Invalid Skill)`;
                        // Do not mark as used if skill was invalid
                    }
                    activeCrewMember = null;
                }

                addToHistory(`${logMsg} = ${roll}`, 'roll');
                
                // Resolve logic scene immediately based on this roll
                const nextId = scene.resolve(roll, gameState); 
                saveGame();
                renderScene(nextId); 
                return;
            }

            gameState.currentSceneId = sceneId;
            
            // --- FX TRIGGER LOGIC ---
            fxManager.clearEffects();

            // Violet Pulse scenes
            if (['prologue_storm', 'prologue_abyss', 'guard_scared', 'lighthouse_vigil'].includes(sceneId)) {
                fxManager.setPulse(true);
            } else {
                fxManager.setPulse(false);
            }

            if (scene.onEnter && logText) {
                const msg = scene.onEnter(gameState);
                if (msg) addToHistory(msg, 'system');
                saveGame();
            }

            const textEl = document.getElementById('main-scene-text');
            let finalHtml = `<h2 class="2xl cinzel text-amber-500 mb-2">${scene.title}</h2><p class="text-lg leading-relaxed text-gray-300 fade-in">${scene.text}</p>`;
            
            // --- BANTER INJECTION (AUTOMATIC) ---
            if (scene.banter) {
                Object.keys(scene.banter).forEach(crewId => {
                    if (gameState.crew[crewId] && !gameState.crew[crewId].used) {
                         finalHtml += `<div class="mt-4 text-blue-400 italic border-l-2 border-blue-500 pl-3 fade-in">
                                <span class="font-bold text-xs uppercase block mb-1">${gameState.crew[crewId].name}:</span>
                                "${scene.banter[crewId]}"
                              </div>`;
                    }
                });
            }
            
            textEl.innerHTML = finalHtml;
            document.getElementById('scene-title').innerText = scene.title;
            
            activeCrewMember = null; 
            
            generateSceneImage(sceneId);
            renderChoices(scene.choices);
            updateUI();
        }

        function renderChoices(choices) {
            const container = document.getElementById('choices-area');
            container.innerHTML = '';

            // --- LOCAL STOCK UTILITY ---
            const currentSceneId = gameState.currentSceneId;
            const currentSceneStock = scenes[currentSceneId] ? scenes[currentSceneId].stock : {};
            const marketStock = scenes['market_stall'].stock; // Reference for selling logic
            
            // Pre-calculate available items based on local scene stock and player inventory
            const itemsForSale = [
                { item: "Healing Potion", nextScene: 'buy_potion', cost: 5 },
                { item: "Rope", nextScene: 'buy_rope', cost: 3 },
                { item: "Torch", nextScene: 'buy_torch', cost: 2 }
            ];

            const sellableItems = [
                { item: "Curious Cargo", nextScene: 'sell_cargo', value: 10, checkStock: true }, // Check merchant's capacity
                { item: "Rope", nextScene: 'sell_rope', value: 2 },
                { item: "Torch", nextScene: 'sell_torch', value: 1 },
                { item: "Healing Potion", nextScene: 'sell_potion', value: 3 },
                { item: "Rum (Heal 5)", nextScene: 'sell_rum', value: 2 } 
            ];
            // --- END LOCAL STOCK UTILITY ---


            if (currentSceneId === 'market_stall') {
                // Generate Dynamic Buy Options
                itemsForSale.forEach(sale => {
                    const stock = currentSceneStock[sale.item] || 0;
                    if (stock > 0) {
                        choices.unshift({ // Add to top of the list
                            text: `Buy ${sale.item.split('(')[0].trim()} (${sale.cost}s, Stock: ${stock})`,
                            nextScene: sale.nextScene,
                            type: 'action',
                            cost: sale.cost
                        });
                    }
                });
            }
            
            if (currentSceneId === 'market_sell') {
                // Generate Dynamic Sell Options
                // We clear the hardcoded options and rebuild them based on player inventory, excluding the back/leave buttons
                const permanentChoices = choices.filter(c => c.nextScene === 'market_stall' || c.nextScene === 'lighthouse_split');
                choices = [];

                sellableItems.forEach(sell => {
                    if (gameState.inventory.includes(sell.item)) {
                        // Special check for Curious Cargo: Merchant won't buy it if already bought/traded
                        if (sell.item === 'Curious Cargo' && marketStock['Curious Cargo'] === 0) {
                            return;
                        }

                        choices.push({
                            text: `Sell ${sell.item.split('(')[0].trim()} (+${sell.value}s)`,
                            nextScene: sell.nextScene,
                            type: 'action',
                            reqItem: sell.item
                        });
                    }
                });
                // Add back the navigation choices
                choices = choices.concat(permanentChoices);
            }

            choices.forEach(choice => {
                // Check stock for purchasing/selling Curious Cargo at the cove (only checking inventory here, not stock)
                if (choice.type === 'action' && choice.reqItem === 'Curious Cargo' && currentSceneId === 'smuggler_meet' && !gameState.inventory.includes("Curious Cargo")) {
                    return; // Skip if player doesn't have the cargo
                }
                
                // Re-check general requirements
                if (choice.reqSmuggler && gameState.influence < choice.reqSmuggler) return;
                if (choice.reqGuard && gameState.influence > -choice.reqGuard) return;
                if (choice.cost && gameState.shillings < choice.cost) return;
                if (choice.reqItem && !gameState.inventory.includes(choice.reqItem)) return;

                const btn = document.createElement('button');
                btn.className = "btn-game w-full p-3 bg-gray-800 border border-gray-600 hover:border-amber-500 hover:bg-gray-750 text-left rounded shadow flex items-center justify-between group";
                
                btn.onclick = (e) => {
                    audioManager.playClick();
                    
                    if (choice.type === 'reset') {
                        resetGame();
                        return;
                    }

                    if (choice.consume && choice.reqItem) {
                        const idx = gameState.inventory.indexOf(choice.reqItem);
                        if (idx > -1) {
                            gameState.inventory.splice(idx, 1);
                            addToHistory(`${choice.reqItem} used and discarded.`, 'system');
                        }
                    }

                    const currentScene = scenes[gameState.currentSceneId];
                    const entryText = currentScene.journal !== undefined ? currentScene.journal : currentScene.text;
                    if (entryText !== null) {
                        addToHistory(entryText, 'entry');
                    }

                    if (choice.cost) gameState.shillings -= choice.cost;
                    
                    // --- SKILL CHECK LOGIC WITH COMPLEX CREW TRACKING ---
                    if (choice.type === 'skill') {
                        // Store required skill type and DC for the logic scene resolution
                        gameState.lastSkillType = choice.skill;
                        gameState.lastDC = choice.dc;
                        
                        // Handle the roll in the next scene to allow for complex logic checks (like Talon's Cargo)
                        renderScene(choice.nextScene);
                        return;
                    }
                    
                    // Non-skill choices or if logic flow differs
                    if (choice.type !== 'skill') {
                        renderScene(choice.nextScene);
                    }
                };
                
                let label = choice.text;
                let icon = '<i class="fas fa-chevron-right text-gray-600 group-hover:text-amber-500"></i>';

                if (choice.type === 'skill') {
                    label += ` <span class="text-blue-400 text-xs uppercase tracking-wider ml-1">[${choice.skill} DC ${choice.dc}]</span>`;
                    icon = '<i class="fas fa-dice-d20 text-blue-500"></i>';
                }
                if (choice.cost) {
                    label += ` <span class="text-amber-500 text-xs ml-1">(-${choice.cost}s)</span>`;
                }
                if (choice.type === 'reset') {
                     icon = '<i class="fas fa-undo text-amber-500"></i>';
                     btn.className += " border-amber-900/50";
                }

                btn.innerHTML = `<span class="cinzel font-bold text-gray-300 group-hover:text-amber-100">${label}</span>${icon}`;
                container.appendChild(btn);
            });
        }

        function updateUI() {
            // PROLOGUE & LOG UI HANDLING
            const statsPanel = document.getElementById('stats-panel');
            const journalContainer = document.getElementById('journal-container');
            const sceneId = gameState.currentSceneId;
            
            if (sceneId && sceneId.startsWith('prologue')) {
                statsPanel.classList.add('prologue-blur');
                journalContainer.classList.add('log-hidden');
                journalContainer.classList.remove('log-visible');
            } else {
                statsPanel.classList.remove('prologue-blur');
                statsPanel.classList.add('prologue-active');
                
                if(gameState.inventory.includes("Ship's Log")) {
                    journalContainer.classList.remove('log-hidden');
                    journalContainer.classList.add('log-visible');
                } else {
                    journalContainer.classList.add('log-hidden');
                    journalContainer.classList.remove('log-visible');
                }
            }

            // HP
            const hpPct = (gameState.currentHP / gameState.maxHP) * 100;
            const bar = document.getElementById('hp-bar');
            bar.style.width = `${hpPct}%`;
            bar.className = `h-full transition-all duration-500 ${hpPct < 30 ? 'bg-red-600 animate-pulse' : 'bg-red-800'}`;
            document.getElementById('hp-text').innerText = `${gameState.currentHP}/${gameState.maxHP}`;

            // Check for low health audio & vignette
            audioManager.checkVulnerable(gameState.currentHP, gameState.maxHP);
            if (hpPct <= 30) {
                fxManager.setVignette(true);
            } else {
                fxManager.setVignette(false);
            }

            // Money
            document.getElementById('shillings-display').innerText = gameState.shillings;
            
            // Influence
            const inf = gameState.influence || 0;
            const pct = ((inf + 20) / 40) * 100;
            const marker = document.getElementById('inf-marker');
            if (marker) marker.style.left = `${Math.max(0, Math.min(100, pct))}%`;
            
            const infText = document.getElementById('inf-status-text');
            if (infText) {
                if (inf < -10) infText.textContent = "Sworn to the Crown";
                else if (inf < -5) infText.textContent = "Respected by Guards";
                else if (inf > 10) infText.textContent = "Pirate Lord";
                else if (inf > 5) infText.textContent = "Known Smuggler";
                else infText.textContent = "Unknown / Neutral";
            }

            // Crew UI
            const ind = document.getElementById('active-crew-indicator');
            const nameSpan = document.getElementById('active-crew-name');
            if (activeCrewMember) {
                ind.classList.remove('hidden');
                nameSpan.innerText = activeCrewMember.name;
            } else {
                ind.classList.add('hidden');
            }

            const crewContainer = document.getElementById('crew-panel');
            crewContainer.innerHTML = '';
            
            // Define fixed order of keys
            const crewOrder = ['gareth', 'quinn', 'talon', 'bones'];
            
            crewOrder.forEach(key => {
                const c = gameState.crew[key];
                if (!c) return; // Safety check

                const btn = document.createElement('button');
                const isSelected = activeCrewMember && activeCrewMember.name === c.name;
                
                let baseClass = "p-2 rounded border text-left transition-all relative overflow-hidden ";
                
                // Add crew-active pulse if the free use is available and this crew member is selected
                const isFreeUseActive = gameState.crewUseFree && isSelected;
                
                if (c.used && !isFreeUseActive) {
                    baseClass += "bg-black/50 border-gray-800 text-gray-700 cursor-not-allowed opacity-50";
                } else if (isSelected) {
                    baseClass += "bg-blue-900/40 border-blue-400 text-blue-100 crew-active ring-1 ring-blue-400";
                    if (isFreeUseActive) {
                         baseClass += " bg-purple-900/40 border-purple-400 crew-active";
                    }
                } else {
                    baseClass += "bg-gray-800 border-gray-600 text-gray-300 hover:border-gray-400 hover:bg-gray-700";
                }

                // --- TUTORIAL PULSE LOGIC ---
                if (gameState.currentSceneId === 'start' && c.name === 'Quinn' && !c.used && !activeCrewMember) {
                    baseClass += " tutorial-pulse";
                }

                btn.className = baseClass;
                // Only disable if USED and NOT free-use selected
                btn.disabled = c.used && !isFreeUseActive;
                btn.innerHTML = `
                    <div class="font-bold text-[12px] cinzel leading-tight">${c.name}</div>
                    <div class="text-[10px] ${isSelected ? 'text-blue-200' : 'text-gray-500'}">${c.skill}</div>
                    ${c.used ? '<i class="fas fa-lock absolute top-1 right-1 text-[10px]"></i>' : ''}
                    ${isFreeUseActive ? '<i class="fas fa-gift absolute top-1 right-1 text-[10px] text-purple-300"></i>' : ''}
                `;
                btn.onclick = () => {
                    audioManager.playClick();
                    
                    if (isSelected) {
                        activeCrewMember = null;
                    } else {
                        activeCrewMember = c;
                        audioManager.playGhost(); // Only play when selecting
                    }
                    updateUI();
                };
                crewContainer.appendChild(btn);
            });

            // Inventory List View
            const invContainer = document.getElementById('inventory-panel');
            invContainer.innerHTML = '';
            const descArea = document.getElementById('item-desc-area');
            
            if (gameState.inventory.length === 0) {
                invContainer.innerHTML = '<div class="text-center text-[10px] text-gray-600 italic py-2">Inventory Empty</div>';
            } else {
                gameState.inventory.forEach(itemName => {
                    const itemDef = itemRegistry[itemName] || { type: 'misc', icon: 'fa-box', color: 'text-gray-500', desc: "A strange item." };
                    const isConsumable = itemDef.type === 'consumable';
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = `group w-full flex items-center justify-between p-2 rounded border transition-all cursor-default relative ${
                        isConsumable 
                        ? 'bg-gray-900/80 border-emerald-900/50 hover:border-emerald-500 hover:bg-gray-800' 
                        : 'bg-gray-900/60 border-gray-800 hover:border-gray-600'
                    }`;

                    // Left Side: Icon + Name
                    const leftSide = document.createElement('div');
                    leftSide.className = 'flex items-center gap-3';
                    leftSide.innerHTML = `
                        <div class="text-lg w-5 text-center ${itemDef.color}"><i class="fas ${itemDef.icon}"></i></div>
                        <span class="text-xs cinzel text-gray-300 group-hover:text-gray-100 transition-colors">${itemName.split('(')[0].trim()}</span>
                    `;
                    itemRow.appendChild(leftSide);

                    // Right Side: Action Button or Tag
                    const rightSide = document.createElement('div');
                    if (isConsumable) {
                        const actionBtn = document.createElement('button');
                        actionBtn.className = "px-2 py-1 bg-emerald-900/40 border border-emerald-600/30 text-emerald-500 text-[9px] font-bold rounded hover:bg-emerald-600 hover:text-white transition-all tracking-wider";
                        actionBtn.innerText = itemDef.btnText || "USE";
                        actionBtn.onclick = (e) => {
                            e.stopPropagation();
                            // Audio Hook for Item Use
                            audioManager.playClick();
                            const result = itemDef.action(gameState);
                            addToHistory(result, 'system');
                            saveGame();
                            updateUI();
                        };
                        rightSide.appendChild(actionBtn);
                    } else {
                        const tag = document.createElement('span');
                        tag.className = "text-[9px] text-gray-600 uppercase tracking-wider font-bold opacity-50 group-hover:opacity-100 transition-opacity";
                        tag.innerText = "PASSIVE";
                        rightSide.appendChild(tag);
                    }
                    itemRow.appendChild(rightSide);

                    // Hover Description Logic
                    const defaultText = "Hover over an item to inspect it.";
                    itemRow.onmouseenter = () => {
                        descArea.innerText = itemDef.desc || defaultText;
                        descArea.classList.add('text-amber-400');
                        descArea.classList.remove('text-gray-400');
                    };
                    itemRow.onmouseleave = () => {
                        descArea.innerText = defaultText;
                        descArea.classList.remove('text-amber-400');
                        descArea.classList.add('text-gray-400');
                    };

                    invContainer.appendChild(itemRow);
                });
            }
        }

        init();
    </script>
</body>
</html>