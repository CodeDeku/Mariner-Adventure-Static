<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edward Jones: The Mariner of the Damned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS Font Awesome for dynamic icon switching -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Crimson Text', serif;
            background-color: #050a10;
            color: #cdd5e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1, h2, h3, .cinzel {
            font-family: 'Cinzel', serif;
        }
        .journal-font {
            font-family: 'Dancing Script', cursive;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #94a3b8; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .btn-game {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            padding: 12px; /* Consistent p-3 size for all base buttons */
        }
        .btn-game:active { transform: translateY(1px); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        /* SPECTRAL BLUE/GLOW DEFINITIONS (Centralized Theme) */
        
        /* Crew Selection Active Glow (Border/Shadow) */
        @keyframes spectral-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); border-color: #3b82f6; }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); border-color: #60a5fa; }
        }
        /* Applies to crew box and active crew indicator */
        .spectral-active { 
            animation: spectral-pulse 2s infinite; 
            background-color: rgba(30, 58, 138, 0.3); /* Dark Blue Background */
            border-color: #60a5fa !important;
        }

        /* Text Color for all spectral elements (Skill Check, Banter, Lore, Journal Links, Dice Icon) */
        .spectral-text-glow {
            color: #93c5fd; /* Light Blue-300: High contrast, ghostly tone */
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.6);
            font-weight: 700;
        }
        /* End Spectral Definitions */


        /* Custom glow for FREE USE / Mushroom */
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.5); border-color: #a855f7; }
            50% { box-shadow: 0 0 18px rgba(192, 132, 252, 0.8); border-color: #c084fc; }
        }
        .crew-free-use-glow {
            animation: pulse-purple 2s infinite;
            background-color: rgba(88, 28, 135, 0.5); /* deep violet */
            border-color: #a855f7 !important;
            color: #f3e8ff !important;
        }


        /* --- TUTORIAL PULSE (AMBER) --- */
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); border-color: #f59e0b; }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); border-color: #fbbf24; }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; }
        }
        .tutorial-pulse { 
            animation: pulse-amber 2s infinite; 
            border: 2px solid #f59e0b !important; 
            background-color: rgba(180, 83, 9, 0.4); /* Dark Amber background */
            z-index: 10;
        }

        @keyframes item-pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 10px 0 rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
        }
        .item-consumable { animation: item-pulse 3s infinite; }

        #inf-marker { transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- HERO / ABILITY BUTTON STYLING (UNIFIED SIZE) --- */
        
        /* Base styles for all glowing/custom buttons */
        .btn-hero, .btn-fire-glow, .btn-shadow-glow, .btn-success-glow {
            padding: 12px; /* FORCED CONSISTENT PADDING (p-3 equivalent) */
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        @keyframes hero-pulse {
            0% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); border-color: #93c5fd; }
            100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }
        }

        .btn-hero {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); /* Blue gradient */
            border: 1px solid #60a5fa;
            color: #dbeafe; /* Very light blue text */
            animation: hero-pulse 2s infinite;
        }
        
        .btn-hero:hover {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
            transform: translateY(-1px);
        }
        
        /* Icon styling for hero buttons */
        .hero-icon {
            color: #60a5fa;
            filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.8));
        }

        /* --- FIRE ELEMENTAL GLOW (Absorb Elements) - DIALED BACK --- */
        @keyframes fire-pulse {
            /* Softer glow spread and opacity */
            0%, 100% { box-shadow: 0 0 3px rgba(239, 68, 68, 0.3); border-color: #f87171; }
            50% { box-shadow: 0 0 10px rgba(248, 113, 113, 0.5); border-color: #fca5a5; } /* Max spread reduced from 20px to 10px; Opacity reduced to 0.5 */
        }
        .btn-fire-glow {
            /* Reduced base opacity of background */
            background: linear-gradient(90deg, rgba(185, 28, 28, 0.3) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid #f87171;
            color: #fecaca;
            animation: fire-pulse 2s infinite;
        }

        /* --- SHADOW/VOID GLOW (Primeval Awareness) - DIALED BACK --- */
        @keyframes shadow-pulse {
            /* Softer glow spread and opacity */
            0%, 100% { box-shadow: 0 0 3px rgba(139, 92, 246, 0.3); border-color: #a78bfa; }
            50% { box-shadow: 0 0 10px rgba(167, 139, 250, 0.5); border-color: #d8b4fe; } /* Max spread reduced from 20px to 10px; Opacity reduced to 0.5 */
        }
        .btn-shadow-glow {
            /* Reduced base opacity of background */
            background: linear-gradient(90deg, rgba(88, 28, 135, 0.3) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid #a78bfa;
            color: #e9d5ff;
            animation: shadow-pulse 2s infinite;
        }

        /* --- SUCCESS GLOW (Info Bypass) --- */
        /* Changed generic btn-game class to specific class to control styling */
        .btn-success-glow {
            background-color: rgba(4, 120, 87, 0.4); /* Dark green */
            border: 1px solid #34d399; /* Light green */
            color: #d1fae5;
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.4);
            transition: all 0.2s;
        }
        .btn-success-glow:hover {
            background-color: rgba(4, 120, 87, 0.6);
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.8);
        }

        /* --- UNAFFORDABLE STYLING (New) --- */
        .btn-disabled-cost {
            opacity: 0.4;
            cursor: not-allowed;
            /* Override hover effects for visual feedback */
            background-color: #1f2937 !important; /* Dark slate */
            border-color: #475569 !important; /* Slate-600 */
        }
        .btn-disabled-cost:hover {
             transform: none; /* No lift effect on hover */
             box-shadow: none;
        }


        /* --- LORE TOOLTIPS --- */
        /* Updated LORE Tooltip styling to use SPECTRAL GLOW for consistency */
        .memory-keyword {
            color: #93c5fd; /* Spectral text color */
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5); /* Soft Glow */
            cursor: help;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 1px solid transparent; 
        }
        .memory-keyword:hover {
            text-shadow: 0 0 12px rgba(59, 130, 246, 0.9), 0 0 2px #fff; /* Intense Glow */
            color: #bfdbfe; /* Lighter Spectral Blue */
        }
        /* Tooltip Box */
        .memory-keyword:hover::after {
            content: attr(data-lore);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #0f172a; /* Slate-900 */
            border: 1px solid #3b82f6; /* Blue-500 */
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            width: 240px;
            font-size: 0.85rem;
            line-height: 1.4;
            z-index: 100;
            pointer-events: none;
            font-family: 'Crimson Text', serif;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            text-align: center;
            white-space: normal;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* Tooltip Arrow */
        .memory-keyword:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0px);
            border-width: 6px;
            border-style: solid;
            border-color: #3b82f6 transparent transparent transparent;
            z-index: 100;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }

        /* --- ATMOSPHERIC FX --- */
        #fx-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
            transition: box-shadow 0.5s ease;
        }

        @keyframes pulse-violet-anim {
            0%, 100% { box-shadow: inset 0 0 20px 0px rgba(139, 92, 246, 0.1); background-color: rgba(139, 92, 246, 0.05); }
            50% { box-shadow: inset 0 0 80px 20px rgba(139, 92, 246, 0.4); background-color: rgba(139, 92, 246, 0.15); }
        }
        .fx-pulse-violet {
            animation: pulse-violet-anim 4s infinite ease-in-out;
            mix-blend-mode: overlay;
        }

        @keyframes flash-red-anim {
            0% { background-color: rgba(220, 38, 38, 0.6); }
            100% { background-color: transparent; }
        }
        .fx-flash-red {
            animation: flash-red-anim 0.4s ease-out forwards;
        }

        .fx-vignette-low {
            box-shadow: inset 0 0 80px 30px rgba(127, 29, 29, 0.3);
        }

        .water-stained {
            background-color: #1e293b;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23334155' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Blur UI when in prologue */
        .prologue-blur { filter: blur(4px); opacity: 0.5; pointer-events: none; transition: all 1s; }
        .prologue-active { opacity: 1; filter: none; }
        
        /* Hidden Log State */
        .log-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .log-visible { opacity: 1; pointer-events: auto; transform: translateY(0); transition: all 1s ease-out; }
    </style>
</head>
<body>

    <div id="app-loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white">
        <div class="text-4xl cinzel text-blue-500 mb-4 animate-pulse text-center px-4">Edward Jones:<br>The Mariner of the Damned</div>
        <div class="text-gray-400 cinzel text-sm">Summoning the Crew...</div>
    </div>

    <!-- Audio Toggle Button (Fixed Position) -->
    <div class="fixed top-4 right-4 z-50">
        <button id="audio-toggle" class="bg-gray-800/80 border border-gray-600 text-gray-400 p-2 rounded-full hover:text-amber-500 transition-colors w-10 h-10 flex items-center justify-center shadow-lg backdrop-blur">
            <!-- Default Icon: Muted -->
            <i class="fas fa-volume-mute"></i>
        </button>
    </div>

    <div class="grid grid-cols-1 md:flex md:flex-row max-w-7xl mx-auto w-full p-2 md:p-4 gap-4 mb-8">
        
        <div class="contents md:flex md:flex-col md:w-1/3 gap-3 shrink-0">
            
            <div class="order-1 md:order-none relative w-full aspect-square md:aspect-[4/3] bg-gray-900 rounded border border-gray-700 overflow-hidden shadow-2xl shrink-0 group">
                <button id="reset-game-btn" onclick="confirmReset()" class="absolute top-2 left-2 z-30 text-[10px] border border-red-900/50 text-red-400 bg-black/60 hover:text-red-200 hover:bg-red-900/80 px-2 py-1 rounded transition-all cinzel font-bold backdrop-blur-sm">
                    <i class="fas fa-skull mr-1"></i>New Game
                </button>

                <!-- New FX Overlay -->
                <div id="fx-overlay"></div>

                <img id="scene-image" src="" alt="Scene Visualization" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000">
                
                <!-- NEW IMAGE LOADER STRUCTURE FIX -->
                <div id="image-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-amber-600"></i>
                        <span class="text-xs cinzel tracking-widest text-amber-600">Manifesting Vision...</span>
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4">
                    <h2 id="scene-title" class="text-xl cinzel text-amber-500 text-shadow"></h2>
                </div>
            </div>

            <div id="stats-panel" class="order-4 md:order-none bg-gray-800/80 rounded border border-gray-700 p-3 flex flex-col gap-3 shadow-lg backdrop-blur-sm relative transition-all duration-1000">
                
                <div>
                    <div class="flex justify-between text-sm cinzel text-gray-400 mb-1">
                        <span>Edward Jones</span>
                        <span id="hp-text">20/20</span>
                    </div>
                    <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-gray-700">
                        <div id="hp-bar" class="bg-red-800 h-full w-full transition-all duration-500"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 text-sm">
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex items-center justify-between">
                        <span class="text-amber-500 cinzel"><i class="fas fa-coins mr-2"></i>Shillings</span>
                        <span id="shillings-display" class="font-bold text-gray-200">0</span>
                    </div>

                    <div class="bg-gray-900 p-2 rounded border border-gray-700 flex flex-col text-[10px] gap-2 relative">
                        <div class="flex justify-between items-center cinzel text-[10px] uppercase tracking-wider font-bold">
                            <span class="text-blue-400"><i class="fas fa-shield-alt mr-1"></i>Order</span>
                            <span class="text-gray-500">Neutral</span>
                            <span class="text-emerald-400">Chaos<i class="fas fa-skull-crossbones ml-1"></i></span>
                        </div>
                        
                        <div class="relative w-full h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-gray-800 to-emerald-900 opacity-60"></div>
                            
                            <div id="inf-marker" class="absolute top-0 bottom-0 w-1.5 bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] z-10 rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
                        </div>
                        <div class="text-center text-[10px] text-gray-500 italic" id="inf-status-text">Unknown to all</div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400">Guiding Voice (+1d4)</span>
                        <span class="text-[10px] text-gray-600 italic">Resets on Long Rest</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2" id="crew-panel">
                        </div>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-1 mb-2">
                        <span class="text-xs cinzel text-gray-400"><i class="fas fa-briefcase mr-1"></i> Inventory</span>
                    </div>

                    <div id="item-desc-area" class="text-[12px] text-gray-400 h-8 italic mb-2 text-center leading-tight flex items-center justify-center bg-gray-900/50 border border-gray-700/50 rounded px-2 transition-all duration-300">
                        Hover over an item to inspect it.
                    </div>

                    <div id="inventory-panel" class="flex flex-col gap-1">
                        </div>
                </div>
            </div>
        </div>

        <div class="contents md:flex md:flex-col md:w-2/3 gap-4">
            
            <div id="main-scene-text" class="order-2 md:order-none bg-[#111318] rounded border border-gray-700 p-6 shadow-inner relative flex flex-col justify-center min-h-[160px]">
                <div class="text-center text-gray-500 italic">Initializing Story...</div>
            </div>

            <div class="order-3 md:order-none shrink-0 flex flex-col gap-2">
                 <div id="active-crew-indicator" class="hidden text-center text-blue-400 text-xs cinzel animate-pulse mb-1">
                    <i class="fas fa-ghost mr-1"></i> <span id="active-crew-name"></span> is guiding your next move...
                </div>
                <div id="choices-area" class="grid grid-cols-1 gap-2">
                    </div>
            </div>

            <div id="journal-container" class="order-5 md:order-none log-hidden h-96 md:h-[476px] shrink-0 rounded border border-gray-600 bg-gray-800 shadow-2xl flex flex-col overflow-hidden relative">
                <div class="bg-[#0f172a] text-center py-1 border-b border-gray-700 z-10 shadow-md">
                    <h3 class="cinzel text-amber-600 text-sm tracking-[0.2em] font-bold">The Log of The Trident's Kiss</h3>
                </div>
                <div id="journal-scroll-area" class="flex-1 water-stained p-6 overflow-y-auto">
                    <div id="journal-content" class="space-y-6">
                         </div>
                    <div class="h-4"></div>
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
			apiKey: "AIzaSyDlg5dETZJpbJ9GzMV01pUYA06XbFmySbw",
			authDomain: "edward-jones-75546.firebaseapp.com",
			projectId: "edward-jones-75546",
			storageBucket: "edward-jones-75546.firebasestorage.app",
			messagingSenderId: "76799051768",
			appId: "1:76799051768:web:fdd3641b597adfc6a0780d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "edward-jones-standalone";
        let user;

        // --- AUDIO MANAGER ---
        class AudioManager {
            constructor() {
                // Setup Ambience Loop
                this.ambience = new Audio('audio/ambience.mp3');
                this.ambience.loop = true;
                this.ambience.volume = 0.3; // Quiet by default
                
                // Setup SFX
                this.clickSound = new Audio('audio/click.mp3');
                this.clickSound.volume = 0.5;
                
                this.gaspSound = new Audio('audio/gasp.mp3');
                this.gaspSound.volume = 0.6;
                
                this.clashSound = new Audio('audio/clash.mp3');
                this.clashSound.volume = 0.5;
                
                this.coinsSound = new Audio('audio/coins.mp3');
                this.coinsSound.volume = 0.5;
                
                this.vulnerableSound = new Audio('audio/vulnerable.mp3');
                this.vulnerableSound.volume = 0.6;
                this.vulnerableSound.loop = true; // Loop the panting sound
                
                this.ghostSound = new Audio('audio/ghost.mp3');
                this.ghostSound.volume = 0.4;

                this.isMuted = true;
                this.hasInteracted = false;
                
                // Track if vulnerable sound played this scene to prevent looping
                this.playedVulnerable = false;

                // Bind toggle button
                const btn = document.getElementById('audio-toggle');
                btn.onclick = () => this.toggleMute();
            }

            playSFX(soundObj) {
                if (!this.isMuted) {
                    // Clone to allow overlapping sounds
                    const sound = soundObj.cloneNode();
                    sound.volume = soundObj.volume;
                    sound.play().catch(e => console.log("Audio play blocked"));
                }
            }

            playClick() { this.playSFX(this.clickSound); }
            playGasp() { this.playSFX(this.gaspSound); }
            playClash() { this.playSFX(this.clashSound); }
            playCoins() { this.playSFX(this.coinsSound); }
            playGhost() { this.playSFX(this.ghostSound); }
            
            checkVulnerable(currentHP, maxHP) {
                const pct = (currentHP / maxHP) * 100;
                
                if (pct <= 30) {
                    // Player is vulnerable
                    if (!this.playedVulnerable && !this.isMuted) {
                        // Play the looping sound directly (not a clone)
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                        this.playedVulnerable = true;
                    }
                } else {
                    // Player is healed above threshold - Stop Sound
                    this.vulnerableSound.pause();
                    this.vulnerableSound.currentTime = 0;
                    this.playedVulnerable = false;
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const btn = document.getElementById('audio-toggle');
                const icon = btn.querySelector('i');

                if (!this.isMuted) {
                    // Active State
                    this.ambience.play().catch(e => console.log("Autoplay blocked"));
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-high'); // Active Speaker Icon
                    btn.classList.add('text-amber-500', 'border-amber-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                    
                    // Resume vulnerable sound if active
                    if(this.playedVulnerable) {
                        this.vulnerableSound.play().catch(e => console.log("Audio play blocked"));
                    }
                } else {
                    // Muted State
                    this.ambience.pause();
                    this.vulnerableSound.pause(); // Ensure panting stops on mute
                    // Icon Swap Logic
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-volume-mute'); // Muted Speaker Icon
                    btn.classList.remove('text-amber-500', 'border-amber-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
            }
        }

        const audioManager = new AudioManager();

        // --- FX MANAGER ---
        class FXManager {
            constructor() {
                this.overlay = document.getElementById('fx-overlay');
            }

            clearEffects() {
                // Remove all effects except flash animations (they remove themselves)
                this.overlay.classList.remove('fx-pulse-violet', 'fx-vignette-low');
            }

            flashRed() {
                this.overlay.classList.add('fx-flash-red');
                setTimeout(() => this.overlay.classList.remove('fx-flash-red'), 400);
            }
            
            setPulse(active) {
                if(active) this.overlay.classList.add('fx-pulse-violet');
                else this.overlay.classList.remove('fx-pulse-violet');
            }

            setVignette(active) {
                if(active) this.overlay.classList.add('fx-vignette-low');
                else this.overlay.classList.remove('fx-vignette-low');
            }
        }
        
        const fxManager = new FXManager();

        // --- STATIC IMAGE MAPPING ---
		const sceneImages = {
			'prologue_storm': 'images/storm.jpg',
			'prologue_abyss': 'images/abyss.jpg',
			'start': 'images/wreckage.jpg',
			'wreckage_success': 'images/chest.jpg',
			'wreckage_fail': 'images/sand_empty.jpg', 
			'treeline': 'images/forest.jpg',
			'treeline_prepared': 'images/forest.jpg',
			'road_encounter': 'images/guard_road.jpg',
			'trail_success': 'images/smuggler_cove_high.jpg',
			'trail_success_talon': 'images/smuggler_cove_high.jpg',
			'trail_fail': 'images/stumble_guard.jpg', 
			'guard_talk': 'images/guard_face.jpg',
			'guard_respect': 'images/guard_salute.jpg', 
			'guard_bribe': 'images/guard_bribe.jpg', 
			'guard_scared': 'images/guard_scared.jpg', 
			'combat_guard': 'images/combat_hammer.jpg', 
			'smuggler_meet': 'images/smuggler_standoff.jpg',
            'smuggler_cargo': 'images/smuggler_pay.jpg',			
			'smuggler_friend': 'images/smuggler_rum.jpg', 
			'smuggler_pay': 'images/smuggler_pay.jpg', 
			'market_crossroads': 'images/market.jpg',
			'market_stall': 'images/merchant.jpg',
			'market_sell': 'images/merchant.jpg', 
			'buy_potion': 'images/merchant.jpg',
			'buy_rope': 'images/merchant.jpg',
			'buy_torch': 'images/merchant.jpg',
			'sell_rope': 'images/merchant.jpg',
			'sell_torch': 'images/merchant.jpg',
            'sell_cargo': 'images/merchant.jpg', 
			'sell_potion': 'images/merchant.jpg',
			'sell_rum': 'images/merchant.jpg',
			'lighthouse_split': 'images/lighthouse_far.jpg',
			'cliff_climb': 'images/cliff.jpg',
			'climb_fail': 'images/fall_cliff.jpg', 
			'dark_caves': 'images/caves.jpg',
            'dark_caves_illuminated': 'images/caves.jpg', 
			'dark_fail': 'images/cave_injury.jpg', 
			'lighthouse_arrival': 'images/lighthouse_door.jpg',
            'edward_death': 'images/abyss.jpg', // Renamed Death Scene
			'ending_order': 'images/guards_win.jpg',
			'ending_chaos': 'images/smugglers_win.jpg',
			'ending_neutral_check': 'images/lockpick.jpg', 
            'ending_neutral_success': 'images/lockpick.jpg',
			'lighthouse_vigil': 'images/dream.jpg',
			'lighthouse_rest': 'images/dream.jpg',
            // --- ACT 1 SCENE IMAGES ---
            'lighthouse_morning': 'images/lighthouse_morning.jpg', // Placeholder for new scene
            'town_descent': 'images/town_descent.jpg', // Placeholder
            'town_square': 'images/town_square.jpg', // Hub: Wide shot of the chaotic port
            'alchemist_triage': 'images/plague_doctor.jpg', // Merchant: Plague doctor theme
            'blackwater_tavern': 'images/tavern_dark.jpg', // Rest/Info Hub: Dark tavern interior
            'smelter_entry': 'images/steam_pipe.jpg', // Fire Path: Steam Hazard
            'chapel_entry': 'images/fog_cemetery.jpg', // Shadow Path: Fog Maze
            // --- END ACT 1 SCENE IMAGES ---
			'default': 'https://placehold.co/600x400/0f172a/1e293b?text=The+Void' 
		};
        
        // --- GAME DATA FACTORY ---
        function createInitialState() {
            // Note: Initial stock is defined on the scene objects (e.g., scenes['market_stall'].stock)
            return {
                currentSceneId: 'prologue_storm', 
                currentHP: 20,
                maxHP: 20,
                shillings: 0, 
                inventory: [], 
                skills: [], // NEW: Hidden tracking for Absorb Elements / Primeval Awareness
                influence: 0, 
                crewUseFree: false, 
                lastCrewUsedId: null, 
                crew: {
                    gareth: { id: 'gareth', name: 'Captain Gareth', skill: 'Insight', used: false, desc: 'Add +1d4 to Initiative & Insight' },
                    quinn: { id: 'quinn', name: 'Quinn', skill: 'Investigation', used: false, desc: 'Add +1d4 to Investigation & History' },
                    talon: { id: 'talon', name: 'Talon', skill: 'Survival', used: false, desc: 'Add +1d4 to Survival & Perception' },
                    bones: { id: 'bones', name: 'Bones', skill: 'Survival', used: false, desc: 'Add +1d4 to Nature & Foraging' }
                },
                history: [],
                // NEW: Information Flags for Act 1 Shortcuts
                knowsSmelterSecret: false,
                knowsChapelSecret: false
            };
        }

        let gameState = createInitialState();
        let activeCrewMember = null;

        // Interactive Items Definition
        const itemRegistry = {
            "Ship's Log": { type: 'key', icon: 'fa-book-skull', color: 'text-amber-700', desc: "Key Item: Records of the damned. Unlocks your history." },
            "Captain's Tricorn": { type: 'key', icon: 'fa-hat-cowboy', color: 'text-blue-500', desc: "Passive: A symbol of authority. +1 to Intimidation checks." },
            "Rum (Heal 5)": {
                name: "Rum (Heal 5)",
                type: 'consumable',
                icon: 'fa-wine-bottle',
                color: 'text-amber-500',
                btnText: "DRINK",
                desc: "Consumable: Potent grog. Restores 5 HP immediately.",
                action: (state) => {
                    const healAmount = 5;
                    const oldHP = state.currentHP;
                    // HP Clamping applied here
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    const idx = state.inventory.indexOf("Rum (Heal 5)");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Rum. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Healing Potion": {
                name: "Healing Potion",
                type: 'consumable',
                icon: 'fa-flask',
                color: 'text-red-500',
                btnText: "DRINK",
                desc: "Consumable: Alchemical vitality. Restores 10 HP.",
                action: (state) => {
                    const healAmount = 10;
                    const oldHP = state.currentHP;
                    // HP Clamping applied here
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Potion. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Pearlescent Mushroom": { 
                type: 'consumable',
                icon: 'fa-cloud-meatball', 
                color: 'text-purple-300',
                btnText: "EAT",
                desc: "Consumable: A medicinal mushroom used for mental clarity. (Free Guiding Voice)",
                action: (state) => {
                    // Set flag to true. It is consumed on the next successful skill check, 
                    // preventing accidental consumption without a skill check.
                    if (state.crewUseFree) {
                        return "The residual clarity remains. You can only benefit from one mushroom at a time.";
                    }
                    state.crewUseFree = true;
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Consumed Pearlescent Mushroom. Clarity gained! (Free Guiding Voice available)`;
                }
            },
            "Curious Cargo": { // NEW ITEM: Influence driver
                name: "Curious Cargo",
                type: 'key',
                icon: 'fa-box-open', 
                color: 'text-yellow-600',
                desc: "Passive: A heavy crate of mysterious goods.",
                btnText: "SELL",
                action: (state) => {
                    return "Must be sold at the Market or traded at the Cove.";
                }
            },
            "Rusted Cutlass": { type: 'key', icon: 'fa-khanda', color: 'text-gray-400', desc: "Passive: Reduces damage taken in combat events." },
            "Rope": { type: 'key', icon: 'fa-om', color: 'text-yellow-700', desc: "Passive: Essential for climbing cliffs." },
            "Torch": { type: 'key', icon: 'fa-fire', color: 'text-orange-500', desc: "Passive: Illuminates dark caves." },
            "Strange Coin": { type: 'key', icon: 'fa-circle-notch', color: 'text-yellow-600', desc: "Passive: Ancient currency. May open doors not made of wood." },
            "Ring of Brass": { type: 'key', icon: 'fa-ring', color: 'text-orange-500', desc: "Legendary Item: The Wolves of Valor set. Grants fire resistance." },
            "Sword of Valor": { type: 'key', icon: 'fa-sword', color: 'text-blue-500', desc: "Legendary Item: The Wolves of Valor set. Deals extra damage to undead." },
			"Compass": { type: 'key', icon: 'fa-compass', color: 'text-indigo-400', desc: "Passive: Violently hums near planar energy." },
            
            // --- NEW ALCHEMIST ITEMS ---
            "Vitality Tincture": { 
                name: "Vitality Tincture",
                type: 'consumable',
                icon: 'fa-heart-circle-plus', 
                color: 'text-red-300',
                btnText: "DRINK",
                desc: "Consumable: High-grade restorative. Restores 15 HP.",
                action: (state) => {
                    const healAmount = 15;
                    const oldHP = state.currentHP;
                    state.currentHP = Math.min(state.maxHP, state.currentHP + healAmount);
                    const idx = state.inventory.indexOf("Vitality Tincture");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Drank Tincture. Healed ${state.currentHP - oldHP} HP.`;
                }
            },
            "Smelling Salts": { 
                name: "Smelling Salts",
                type: 'consumable',
                icon: 'fa-spray-can', 
                color: 'text-purple-400',
                btnText: "USE",
                desc: "Consumable: Revives a single used Crew Member (except the last one used).",
                action: (state) => {
                    const usedCrew = Object.values(state.crew).filter(c => c.used);
                    if (usedCrew.length === 0) {
                        return "No crew members are currently exhausted.";
                    }
                    
                    // Cannot revive the last crew member used in a skill check
                    const revivableCrew = usedCrew.filter(c => c.id !== state.lastCrewUsedId);

                    if (revivableCrew.length === 0) {
                        return `Cannot revive ${state.lastCrewUsedId.charAt(0).toUpperCase() + state.lastCrewUsedId.slice(1)}: they were last used for a check.`;
                    }
                    
                    // For simplicity, just revive the first revivable one found
                    const crewToRevive = revivableCrew[0];
                    state.crew[crewToRevive.id].used = false;
                    
                    const idx = state.inventory.indexOf("Smelling Salts");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    
                    return `Used Salts. ${crewToRevive.name} is now available.`;
                }
            },
            "Flash Powder": { 
                name: "Flash Powder",
                type: 'consumable',
                icon: 'fa-sparkles', 
                color: 'text-yellow-300',
                btnText: "THROW",
                desc: "Consumable: Guarantees escape from current combat (if in combat).",
                action: (state) => {
                    // This item will require scene-specific logic to actually implement the escape,
                    // but for now, it's a placeholder consumable.
                    const idx = state.inventory.indexOf("Flash Powder");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Used Flash Powder. Prepared for immediate escape. (Need to implement scene logic)`;
                }
            },
            // --- NEW ARTIFACT ITEMS ---
            "Alchemical Fire": { 
                name: "Alchemical Fire",
                type: 'consumable',
                icon: 'fa-fire-alt', 
                color: 'text-orange-600',
                btnText: "IGNITE",
                desc: "Path Reward: Volatile mixture. Deals high Fire damage over time. Especially potent against Undead.",
                action: (state) => {
                    const idx = state.inventory.indexOf("Alchemical Fire");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Used Alchemical Fire. Enemy takes damage over time. (Need to implement scene logic)`;
                }
            },
            "Holy Water": { 
                name: "Holy Water",
                type: 'consumable',
                icon: 'fa-cross', 
                color: 'text-blue-200',
                btnText: "SPLASH",
                desc: "Path Reward: Consecrated water. Deals high Radiant damage. Especially potent against Fire Elementals.",
                action: (state) => {
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    return `Used Holy Water. Enemy takes Radiant damage. (Need to implement scene logic)`;
                }
            },
        };
        
        function getBonusForSkill(crewMember, skillType) {
            // Mapping based on character sheet
            const expertise = {
                'Captain Gareth': ['Insight', 'Initiative'],
                'Quinn': ['Investigation', 'History'],
                'Talon': ['Survival', 'Perception'],
                'Bones': ['Survival', 'Nature', 'Medical'] // Bones has overlaps
            };

            const allowedSkills = expertise[crewMember.name] || [];
            return allowedSkills.includes(skillType);
        }

        // --- MARKET BLUEPRINTS (Global Definitions for all merchants) ---
        // This is the single source of truth for item pricing and scene flow
        const MARKET_BUY_OPTIONS = [
            { item: "Healing Potion", nextScene: 'buy_potion', cost: 5 },
            { item: "Rope", nextScene: 'buy_rope', cost: 3 },
            { item: "Torch", nextScene: 'buy_torch', cost: 2 },
            { item: "Rum (Heal 5)", nextScene: 'buy_rum', cost: 4 } // NEW: Rum is now a purchasable blueprint item
        ];
        
        // NEW: Triage Alchemist Stock Definition
        const ALCHEMIST_BUY_OPTIONS = [
            { item: "Vitality Tincture", nextScene: 'buy_tincture', cost: 15 },
            { item: "Smelling Salts", nextScene: 'buy_salts', cost: 8 },
            { item: "Flash Powder", nextScene: 'buy_powder', cost: 10 }
        ];

        const MARKET_SELL_OPTIONS = [
            { item: "Curious Cargo", nextScene: 'sell_cargo', value: 10 },
            { item: "Rope", nextScene: 'sell_rope', value: 2 },
            { item: "Torch", nextScene: 'sell_torch', value: 1 },
            { item: "Healing Potion", nextScene: 'sell_potion', value: 3 },
            { item: "Rum (Heal 5)", nextScene: 'sell_rum', value: 2 }
        ];
        
        // NEW: Alchemist Sell Options (Can sell artifacts back for emergency cash)
        const ALCHEMIST_SELL_OPTIONS = [
            { item: "Alchemical Fire", nextScene: 'sell_fire', value: 20 },
            { item: "Holy Water", nextScene: 'sell_water', value: 20 },
            // Can sell the demo's high-value items to the Alchemist for a higher price
            { item: "Healing Potion", nextScene: 'sell_potion_alch', value: 4 }, 
            { item: "Pearlescent Mushroom", nextScene: 'sell_mushroom_alch', value: 12 }
        ];
        // --- END MARKET BLUEPRINTS ---
        

        // --- SCENE DATABASE ---
        const scenes = {
            'prologue_storm': {
                title: "The Planar Storm",
                text: "The deck of The Trident's Kiss heaves violently. Above, the sky isn't black, but a bleeding violet bruise. Captain Gareth stands at the wheel, singing against the gale. '...But who pays the toll for the army of dead?!' he roars, laughing at the violet sky. Quinn, the Quartermaster, is frantically tying down crates on the main deck.",
                journal: "It started with the sky tearing open. Captain Gareth tried to hold the course. Quinn tried to save the cargo. I just tried to stand.",
                // REMOVED GARETH BANTER HERE
                choices: [
                    { text: "Help Quinn secure the cargo", nextScene: 'prologue_abyss', type: 'travel' },
                    { text: "Stand with the Captain", nextScene: 'prologue_abyss', type: 'travel' }
                ]
            },
            'prologue_abyss': {
                title: "The God of the Deep",
                text: "A wave of pure magical force shatters the hull like glass. The freezing dark claims you instantly. As you sink, drifting into the abyss, you see IT rising from the depths—a colossal shadow, vast as a mountain, with eyes like dying stars. The screams of Gareth, Quinn, Talon, and Bones are silenced by the water... then they echo *inside* your skull.",
                journal: "The ship shattered. I sank. I saw a... Shadow... something ancient. And then the voices began.",
                choices: [
                    { text: "Gasp for air (Wake Up)", nextScene: 'start', type: 'travel' }
                ]
            },
			'start': {
                title: "The Wreckage",
                text: "You gasp, lungs burning, and retch salt water onto the grey sand. The storm has passed, but the silence of the beach is a lie. Inside your mind, the scream of the dying ship continue. Gareth is barking orders to hold the line; Quinn is sobbing over the manifest. They don't realize they are dead.<br><br>You find your hand cramping, clutching the Captain's Tricorn Hat with a death grip. Beside you, your Compass hums with a faint, violet vibration, its needle locking onto the cliffs ahead. You are alive, but you have become a life raft for the damned.",
                journal: "I awoke on the shore clutching the Captain Gareth's Tricorn Hat. My Compass is acting strange, vibrating against the sand. The crew's souls are bound to me. Confused, loud, and terrified.",
                banter: {
                    'quinn': "The answers are in the debris, Edward. Dig."
                },
                onEnter: (state) => {
                    audioManager.playGasp();
                    let msg = "";
                    if (!state.inventory.includes("Captain's Tricorn")) {
                        state.inventory.push("Captain's Tricorn");
                        msg += "Started with Tricorn. ";
                    }
                    if (!state.inventory.includes("Compass")) {
                        state.inventory.push("Compass");
                        msg += "Found Compass. ";
                    }
                    return msg;
                },
                choices: [
                    { text: "Search the debris", nextScene: 'wreckage_search', type: 'skill', dc: 8, skill: 'Investigation' },
                    { text: "Head toward the treeline", nextScene: 'treeline', type: 'travel' }
                ]
            },
            'wreckage_search': {
                isLogic: true,
                resolve: (roll) => roll >= 8 ? 'wreckage_success' : 'wreckage_fail'
            },
			'wreckage_success': {
                title: "Salvage",
                text: "Quinn guides your hand to a buried chest partially exposed by the tide. Inside, you find a small pouch of Shillings and a Rusted Cutlass. You strap the blade to your belt—it feels like an extension of your arm. As you turn to leave, Quinn points frantically to a damp book lying nearby—the Ship's Log.",
                journal: "Scavenged a blade, coin, and the Logbook from the wreckage.",
                onEnter: (state) => {
                    const items = ["Rusted Cutlass", "Ship's Log"];
                    let found = false;
                    items.forEach(i => {
                        if(!state.inventory.includes(i)) {
                            state.inventory.push(i);
                            found = true;
                        }
                    });
                    state.shillings += 7; 
                    audioManager.playCoins();
                    
                    if (found) return "Found: Cutlass, Log & 7 Shillings.";
                    return "Found: 7 Shillings.";
                },
                choices: [{ text: "Move to Treeline", nextScene: 'treeline_prepared', type: 'travel' }]
            },
            'wreckage_fail': {
                title: "Empty Sands",
                text: "You dig through the driftwood until your fingers bleed, but the tide has claimed the rest. You find nothing but wet sand and splinters.",
                journal: "Scavenging yielded nothing. I am leaving the shore with empty pockets.",
                choices: [{ text: "Move to Treeline", nextScene: 'treeline', type: 'travel' }]
            },
            'treeline_prepared': {
                title: "The Whispering Woods",
                text: "The forest looms ahead, trees twisted like grasping hands. You adjust the weight of your gear, clutching the heavy Ship's Log against your side. The voices are a dull murmur, satisfied for the moment. A well-traveled road cuts through the center, but Talon notices a faint game trail disappearing into the brush.",
                journal: "I reached the treeline with the Log and my gear. The voices are quieter now. Talon pointed out a hidden path.",
                banter: {
                    'gareth': "Stick to the road, lad. We need steady ground.",
                    'talon': "The road is watched. The wild is ours.",
                    'bones': "Game trail. Good eating, safe walking." 
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'treeline': {
                title: "The Whispering Woods",
                text: "The forest looms ahead. As you step forward, Quinn screams in your mind. 'The Log! Don't leave the history!' You stumble, looking down to see the water-logged Ship's Log at your feet. You pick it up to silence him.",
                journal: "Quinn wouldn't let me leave without the Log. I found it at the treeline.",
                onEnter: (state) => {
                    if(!state.inventory.includes("Ship's Log")) {
                        state.inventory.push("Ship's Log");
                        return "Obtained Ship's Log.";
                    }
                    return null;
                },
                choices: [
                    { text: "Take the Main Road", nextScene: 'road_encounter', type: 'travel' },
                    { text: "Follow Talon's Lead", nextScene: 'trail_check', type: 'skill', dc: 12, skill: 'Survival' }
                ]
            },
            'road_encounter': {
                title: "The King's Guard",
                text: "A heavy-set <span class='memory-keyword' data-lore='The iron fist of the Crown. They despise the supernatural and govern with martial law.'>Royal Guard</span> in plate armor blocks the path. He's nailing a 'WANTED' poster to a tree. He spots you immediately. 'Halt! Identify yourself!'",
                journal: "Ran into a Royal Guard on the main road. No way to hide now.",
                choices: [
                    { text: "Speak diplomatically", nextScene: 'guard_talk', type: 'dialogue' },
                    { text: "Attack him", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
            // Modified Logic Scene to check for Talon being used
            'trail_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    const success = roll >= state.lastDC;
                    
                    if (success) {
                        // If successful AND Talon was the crew used, go to special cargo scene
                        if (state.lastCrewUsedId === 'talon') {
                            return 'trail_success_talon';
                        }
                        // Otherwise (success with Bones or no crew), send to normal success
                        return 'trail_success';
                    }
                    
                    return 'trail_fail';
                }
            },
            // Original trail_success text is now for Bones or no crew (no cargo)
            'trail_success': {
                title: "Hidden Signs",
                text: "You struggle through the thorns but emerge near a hidden cove, overlooking a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "The trail was tough, but we found a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    // RE-IMPLEMENTED BASE CHAOS GAIN
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            // NEW SCENE for Talon's specific success (acquiring cargo)
            'trail_success_talon': {
                title: "Smuggler's Route",
                text: "Talon guides your movement, emphasizing silence and observation. You emerge near a hidden cove, spotting a marked crate abandoned near the tideline. You grab it just before noticing a group of men loading crates. <span class='memory-keyword' data-lore='The unseen veins of the coast. They value coin above law.'>Smugglers</span>.",
                journal: "Talon's skill led me through the brush. Found some mysterious Cargo and reached a Smuggler's Cove unseen.",
                banter: {
                    'bones': "I smell rum... and unwashed men."
                },
                onEnter: (state) => { 
                    state.influence = Math.min(20, state.influence + 4); 
                    if (!state.inventory.includes("Curious Cargo")) {
                        state.inventory.push("Curious Cargo");
                        return "Found Curious Cargo. Secrets Learned (Chaos +4).";
                    }
                    return "Secrets Learned (Chaos +4)"; 
                },
                choices: [
                    { text: "Approach them", nextScene: 'smuggler_meet', type: 'travel' },
                    { text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'trail_fail': {
                title: "Lost",
                text: "The undergrowth fights you. You stumble out of the brush, loud and covered in burrs, right in front of a Royal Guard.",
                journal: "Tried the hidden path, but made too much noise. Stumbled right into a Guard.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Scratch Damage."; 
                },
                choices: [{ text: "Confront the Guard", nextScene: 'road_encounter', type: 'dialogue' }] 
            },
            'guard_talk': {
                title: "The Interrogation",
                text: "The Guard eyes your ragged clothes. 'You look like wreckage refuse. We have reports of smugglers. Make it worth my while, or I'll haul you in.'",
                journal: "The Guard is corrupt. He wants a bribe or a reason to let me go.",
                banter: {
                    'gareth': "Stand tall. Authority respects strength, or gold."
                },
                choices: [
                    { text: "Bribe him", nextScene: 'guard_bribe', type: 'action', cost: 5 }, 
                    // Order Gain Choice
                    { text: "Show Respect (Diplomacy)", nextScene: 'guard_respect', type: 'dialogue', orderGain: 4 },
                    { text: "Intimidate him", nextScene: 'guard_intimidate_check', type: 'skill', dc: 13, skill: 'Insight' },
                    { text: "Attack", nextScene: 'combat_guard', type: 'combat' }
                ]
            },
			'guard_respect': {
                title: "Order and Law",
                text: "You salute with practiced discipline. 'Just a shipwrecked sailor, sir. Keeping to the road.' The Guard straightens, recognizing the posture. 'Carry on then. And take these—get yourself a warm meal.' He flicks two silver coins at you.",
                journal: "I showed the Guard a little respect. He let me pass and gave me coin.",
                onEnter: (state) => {
                    // APPLY NEGATIVE INFLUENCE SHIFT (Order)
                    state.influence = Math.max(-20, state.influence - 4); 
                    state.shillings += 2; // Add 2 Shillings
                    audioManager.playCoins();
                    return "Showed Respect (+4 Order). Received 2 Shillings.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'guard_bribe': {
                title: "The Toll",
                text: "He bites the gold. 'Get moving. Head to the Market, don't linger here.'",
                journal: "Paid the toll. I played the game and walked away unscathed.",
                onEnter: (state) => { 
                    audioManager.playCoins();
                    return "Bribed Guard (Neutral Act)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'guard_intimidate_check': {
                isLogic: true,
                resolve: (roll, state) => {
                    let finalRoll = roll;
                    
                    // Passive Bonus: Captain's Tricorn (+1 Intimidation)
                    if (state.inventory.includes("Captain's Tricorn")) {
                        finalRoll += 1;
                        // Passing 'roll' as the type makes this text Blue/Spectral to match the dice log
                        addToHistory(`Passive Bonus (Captain's Tricorn): +1. Final Result: ${finalRoll}`, 'roll');
                    }
                    
                    return finalRoll >= 13 ? 'guard_scared' : 'combat_guard';
                }
            },
            'guard_scared': {
                title: "Spectral Fear",
                text: "You channel Gareth's command. Your eyes flare with pale light. The Guard stumbles back, terrified. 'Go! Just go!'",
                journal: "Gareth spoke through me. The Guard fled in terror.",
                onEnter: (state) => { 
                    state.influence = Math.min(20, state.influence + 4); 
                    return "Guard Terrified (Chaos +4)."; 
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
			'combat_guard': {
                title: "The Clash",
                text: "He unhooks a heavy warhammer from his belt. You move to intercept him, driving the momentum into a brutal close-quarters struggle. You barely deflect the crushing weight of his strikes, fighting until he finally falls. You survive, but you are now an enemy of the crown.",
                journal: "Had to fight the Guard. I am an outlaw now.",
                onEnter: (state) => { 
                    audioManager.playClash();
                    let minDmg = 10;
                    let varDmg = 6;
                    
                    // Passive Bonus: Rusted Cutlass (Reduces Damage)
                    if (state.inventory.includes("Rusted Cutlass")) {
                        minDmg = 6; // Reduced base damage
                        addToHistory("Passive: Cutlass reduced combat damage.", 'system');
                    }
                    
                    const dmg = Math.floor(Math.random() * varDmg) + minDmg; 
                    state.currentHP = applyDamage(state.currentHP, dmg);
                    fxManager.flashRed(); 
                    state.influence = 20; // Max Chaos
                    return `Took ${dmg} damage. Became Outlaw (Max Chaos).`;
                },
                choices: [{ text: "Limp to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_meet': {
                title: "The Cove",
                text: "The men draw blades as you approach. 'One step closer and you're fish food!'",
                journal: "Found the smugglers. They aren't friendly.",
                choices: [
                    { text: "Flash 'The Mariner's Sign'", nextScene: 'smuggler_friend', type: 'dialogue', reqSmuggler: 3 },
                    // CHOICE: Offer Curious Cargo (Chaos Only)
                    { text: "Offer Curious Cargo", nextScene: 'smuggler_cargo', type: 'action', reqItem: 'Curious Cargo', chaosGain: 6 },
                    { text: "Buy safe passage", nextScene: 'smuggler_pay', type: 'action', cost: 5 },
                    { text: "Run to Market", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            // SMUGGLER TRADE SCENE (Chaos Only, No Coin)
            'smuggler_cargo': {
                title: "A Smuggler's Trust",
                text: "The lead smuggler inspects the crate, nodding slowly. 'This is high-value. You've earned our trust, Mariner. Your loyalty is payment enough.'",
                journal: "Traded Curious Cargo directly to the smugglers.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0; // Consume merchant's willingness to buy this type of cargo
                    state.influence = Math.min(20, state.influence + 6); // High Chaos gain
                    return "Gave Cargo. Chaos +6.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_friend': {
                title: "Old Alliances",
                text: "They recognize the sign. 'The Mariner lives? Then you drink for free tonight.' They toss you a bottle from their own supply.",
                journal: "The smugglers recognized the code. Shared their Rum.",
                onEnter: (state) => {
                     state.inventory.push("Rum (Heal 5)");
                     return "Received Rum.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'smuggler_pay': {
                title: "Business",
                text: "They take the coin. 'Don't let the Guard see you.'",
                journal: "Paid the smugglers off.",
                onEnter: (state) => {
                    audioManager.playCoins();
                    return "Paid Smugglers.";
                },
                choices: [{ text: "Head to The Crossroads", nextScene: 'market_crossroads', type: 'travel' }]
            },
            'market_crossroads': {
                title: "The Crossroads", // RENAMED TO AVOID HUB CONFUSION
                text: "You arrive at a ramshackle market outside of the port town. You can buy basic supplies here, or push on toward the Lighthouse.",
                journal: "Reached the a small Market. I should stock up before the final push.",
                choices: [
                    { text: "Visit the Market Merchant", nextScene: 'market_stall', type: 'travel' },
                    { text: "Head to the Lighthouse", nextScene: 'lighthouse_split', type: 'travel' }
                ]
            },
            'market_stall': {
                title: "The Merchant",
                text: "A hooded figure displays goods on a crate. 'Coin for survival, traveler?'",
                journal: null,
                // --- LOCAL STOCK DEFINITION ---
                stock: {
                    "Healing Potion": 1,
                    "Rope": 1,
                    "Torch": 1,
                    "Curious Cargo": 1, 
                    "Rum (Heal 5)": 0 
                },
                // --- END LOCAL STOCK ---
                banter: {
                    'quinn': "Supplies are the difference between a legend and a corpse. Buy what you can."
                },
                choices: [
                    // NOTE: Buy/Sell options are generated dynamically in renderChoices
                    { text: "Sell Wares", nextScene: 'market_sell', type: 'travel' }, 
                    { text: "Leave", nextScene: 'market_crossroads', type: 'travel' }
                ]
            },
            'market_sell': {
                title: "The Merchant - Selling",
                text: "The merchant eyes your gear. 'I can take some of that off your hands for a fair price.'",
                journal: null,
                // NOTE: Sell options are generated dynamically in renderChoices
                choices: [
                    { text: "Back to Buying", nextScene: 'market_stall', type: 'travel' }
                ]
            },
            // Merchant Sale Scene (Coin Only, No Influence)
            'sell_cargo': {
                title: "The Transaction",
                text: "The merchant accepts the crate without comment, paying the agreed price.",
                journal: "Sold the Curious Cargo for coin.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Curious Cargo");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    scenes['market_stall'].stock["Curious Cargo"] = 0; // Consume stock on the merchant's scene definition
                    state.shillings += 10; 
                    audioManager.playCoins();
                    return "Sold Curious Cargo (+10s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_rope': {
                title: "Sold",
                text: "You hand over the rope.",
                journal: "I sold the rope.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rope");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2;
                    scenes['market_stall'].stock["Rope"] = (scenes['market_stall'].stock["Rope"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Rope (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_torch': {
                title: "Sold",
                text: "You hand over the torch.",
                journal: "I sold the torch.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Torch");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 1;
                    scenes['market_stall'].stock["Torch"] = (scenes['market_stall'].stock["Torch"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Torch (+1s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_potion': {
                title: "Sold",
                text: "You hand over the potion.",
                journal: "I sold the potion.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 3;
                    scenes['market_stall'].stock["Healing Potion"] = (scenes['market_stall'].stock["Healing Potion"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Potion (+3s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            'sell_rum': {
                title: "Sold",
                text: "You hand over the bottle of rum.",
                journal: "I handed over the bottle of rum.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Rum (Heal 5)");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 2; 
                    scenes['market_stall'].stock["Rum (Heal 5)"] = (scenes['market_stall'].stock["Rum (Heal 5)"] || 0) + 1; // INCREMENT STOCK
                    audioManager.playCoins();
                    return "Sold Rum (+2s). Merchant stock increased.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'market_sell', type: 'travel' }]
            },
            // NEW SCENE: buy_rum (for dynamic repurchasing)
             'buy_rum': {
                title: "Purchase",
                text: "You exchange coin for the bottle of grog.",
                journal: "I bought a bottle of rum.",
                onEnter: (state) => { 
                    state.inventory.push("Rum (Heal 5)"); 
                    scenes['market_stall'].stock["Rum (Heal 5)"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Rum."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'buy_potion': {
                title: "Purchase",
                text: "You exchange coin for the red liquid.",
                journal: "I bought a healing potion.",
                onEnter: (state) => { 
                    state.inventory.push("Healing Potion"); 
                    scenes['market_stall'].stock["Healing Potion"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Potion."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'buy_rope': {
                title: "Purchase",
                text: "You coil the sturdy hemp rope over your shoulder.",
                journal: "I bought a coil of rope.",
                onEnter: (state) => { 
                    state.inventory.push("Rope"); 
                    scenes['market_stall'].stock["Rope"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Rope."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'buy_torch': {
                title: "Purchase",
                text: "A simple torch, dipped in pitch.",
                journal: "I bought a torch.",
                onEnter: (state) => { 
                    state.inventory.push("Torch"); 
                    scenes['market_stall'].stock["Torch"] -= 1; // Decrease local stock
                    audioManager.playCoins();
                    return "Bought Torch."; 
                },
                choices: [{ text: "Return to Merchant", nextScene: 'market_stall', type: 'travel' }]
            },
            'lighthouse_split': {
                title: "The Final Approach",
                text: "The Lighthouse stands atop a jagged cliff. Two paths present themselves: a sheer climb up the rock face, or a dark, winding tunnel through the sea caves below.",
                journal: "Two ways to the top: climb the cliff or brave the dark caves.",
                choices: [
                    { text: "Climb the Cliff", nextScene: 'cliff_climb', type: 'travel' },
                    { text: "Enter the Sea Caves", nextScene: 'dark_caves', type: 'travel' }
                ]
            },
            'cliff_climb': {
                title: "The Precipice",
                text: "The wind howls, threatening to tear you from the rock.",
                choices: [
                    { text: "Use Rope (Safe Climb)", nextScene: 'lighthouse_arrival', type: 'action', reqItem: 'Rope', consume: true },
                    { text: "Free Solo", nextScene: 'climb_check', type: 'skill', dc: 14, skill: 'Athletics' } 
                ]
            },
            'climb_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'lighthouse_arrival' : 'climb_fail'
            },
            'climb_fail': {
                title: "Slip and Fall",
                text: "Your grip fails. You slide twenty feet, shredding skin against stone before catching a root.",
                journal: "Almost fell to my death. Climbing without rope was foolish.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 5); 
                    fxManager.flashRed();
                    return "Took 5 Damage."; 
                },
                // Redirects to death scene if HP hit 0, otherwise continues
                choices: [{ text: "Keep Climbing", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'dark_caves': {
                title: "The Abyss Below",
                text: "The air is thick and smells of rot. It is pitch black.",
                banter: {
                    'bones': "Damp... dark... good place for mushrooms, bad for ankles."
                },
                choices: [
                    { text: "Light Torch (Safe Passage)", nextScene: 'dark_caves_illuminated', type: 'action', reqItem: 'Torch', consume: true },
                    { text: "Stumble in Dark", nextScene: 'dark_check', type: 'skill', dc: 14, skill: 'Perception' } 
                ]
            },
            // Updated Mushroom Scene
            'dark_caves_illuminated': {
                title: "Torch's End",
                text: "The damp, choking air of the caves extinguishes your torch within minutes, plunging you into darkness. But then, a pale glow reveals itself. A patch of smooth mushrooms provides an eerie illumination. You remember Bones's banter and collect the specimen for its promised clarity.",
                journal: "The torch died in the damp air, but I found the Pearlescent Mushroom by its own light.",onEnter: (state) => {
                    if (!state.inventory.includes("Pearlescent Mushroom")) {
                        state.inventory.push("Pearlescent Mushroom");
                        return "Torch expended. Found: Pearlescent Mushroom.";
                    }
                    return "Torch expended.";
                },
                choices: [{ text: "Proceed to Exit", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'dark_check': {
                isLogic: true,
                resolve: (roll) => roll >= 14 ? 'lighthouse_arrival' : 'dark_fail'
            },
            'dark_fail': {
                title: "Unseen Dangers",
                text: "In the dark, you trip over unseen rocks and twist your ankle. Something scuttles away in the shadows.",
                journal: "The caves were too dark. I got hurt.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 4); 
                    fxManager.flashRed();
                    return "Took 4 Damage."; 
                },
                choices: [{ text: "Limp to the Exit", nextScene: 'lighthouse_arrival', type: 'travel' }]
            },
            'lighthouse_arrival': {
                title: "The Beacon",
                text: "You reach the heavy iron doors of the Lighthouse. But you are not alone.",
                journal: "Made it to the Lighthouse doors. Someone is waiting.",
                choices: [
                    { text: "Confront them", nextScene: 'faction_check', type: 'travel' }
                ]
            },
            'faction_check': {
                isLogic: true,
                resolve: (r, state) => {
                    if (state.influence <= -4) return 'ending_order'; 
                    if (state.influence >= 4) return 'ending_chaos'; 
                    // Neutral path now leads to the skill check scene for testing
                    return 'ending_neutral_check'; 
                }
            },
            'ending_order': {
                title: "The Deputy",
                text: "A squad of Royal Guards stands at the door, pikes grounded. Their captain steps forward, his gauntlet striking his breastplate in a sharp salute. 'We have eyes on the road, citizen. In a land governed by rot, you kept to the code. The Lighthouse is yours to secure, Deputy.' They part ranks, granting you passage with the discipline of a king's court.",
                journal: "The Guards respect me. They let me pass without question. Order has its perks.",
                choices: [{ text: "Enter and Rest", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
			'ending_chaos': {
                title: "Smuggler's Ally",
                text: "Smugglers lounge by the entrance. They grin as you approach. 'The Mariner! Word travels fast on the tide. You walk the crooked path as well as any of us. This haven is open to you, brother.' They toss you a key.",
                journal: "The smugglers see me as one of their own. They gave me the key.",
                choices: [{ text: "Enter and Rest (Demo End)", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            // NEW SCENE: Skill check to enter neutral ending
            'ending_neutral_check': {
                title: "The Locked Door",
                text: "The clearing is empty. The presence you sensed was only the crew's anticipation screaming in your mind. There is no welcome party—just the wind and a barred door. You must find a way to breach the lock alone.",
                journal: "The Lighthouse is sealed. I need to find the mechanism to enter.",
                choices: [
                    // Insight DC 15 (Captain Gareth)
                    { text: "Analyze the mechanism", nextScene: 'neutral_lock_logic', type: 'skill', dc: 15, skill: 'Insight' } 
                ]
            },
            'neutral_lock_logic': {
                isLogic: true,
                resolve: (roll) => roll >= 15 ? 'ending_neutral_success' : 'ending_neutral_fail'
            },
            'ending_neutral_success': {
                title: "The Shadow Entrance",
                // Updated narrative text to reference Gareth
                text: "Captain Gareth's voice is calm, analyzing the door's weak points instantly. The ancient mechanism bows to your superior insight, and the heavy bolt slides back. You slip inside, unseen and unopposed.",
                journal: "I forced the lock open and entered the lighthouse. Nobody saw me.",
                // REDIRECTED to Lighthouse Vigil
                choices: [{ text: "Enter and Rest", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'ending_neutral_fail': {
                title: "The Shadow Fails",
                text: "Your attempt to understand the mechanism jams the lock further. The noise echoes in the wind, and you must hurry before someone investigates. You quickly force the door, abandoning subtlety.",
                journal: "I failed the mechanism check. I forced the door and entered the lighthouse.",
                onEnter: (state) => { 
                    state.currentHP = applyDamage(state.currentHP, 2); 
                    fxManager.flashRed();
                    return "Took 2 Damage (Hurry)."; 
                },
                // REDIRECTED to Lighthouse Vigil
                choices: [{ text: "Enter and Rest", nextScene: 'lighthouse_vigil', type: 'rest' }]
            },
            'lighthouse_vigil': {
                title: "Charting Course",
                text: "The lighthouse lamp cuts a bright path through the dark, but your gaze is fixed on the water-warped pages of the Ship's Log. The ink has run on the coordinates, but Gareth's handwriting remains clear on the final page—the lyrics to the 'Wolf King's Toll'.<br><br>The bickering voices in your mind fall silent. Then, softly, they begin to hum the melody in unison. It is not a myth; it is a map. To ferry your crew to the afterlife, you must locate these lost artifacts known as the Wolves of Valor.",
                journal: null,
                onEnter: (state) => {
                    const shanty = `The shanty holds the truth. I must find the Ring and the Blade to save my crew. I am the Captain now.<br><br>
                      <i class='spectral-text-glow'>“He found the Ring of ancient Brass,<br>
					  And the Blade that lets no Vampire pass.<br>
                      Now the Ring and the Blade are lost at sea,<br>
                      Waiting for a Captain as cursed as he.“</i>`;
                    
                    addToHistory(shanty, 'entry');
                    
                    state.currentHP = state.maxHP;
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    return "Mission Accepted: Find the Wolves of Valor.";
                },
                choices: [
                    { text: "Continue to Act 1", nextScene: 'lighthouse_morning', type: 'travel' }, // MODIFIED
					{ text: "Rest one more night", nextScene: 'lighthouse_rest', type: 'rest' }
                ]
            },
			'lighthouse_rest': {
                title: "Extra Rest",
                text: "The lantern's warm glow offers a calming sanctuary as waves crash against the lighthouse walls. After securing your hoisted hammock, its soft, steady sway swiftly lulls you to sleep.",
                journal: null,
                onEnter: (state) => {
                    const restNote = "I took an extra night at the lighthouse to rest up and prepare a charter.";
                    addToHistory(restNote, 'entry');
                    state.currentHP = state.maxHP;
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    return "Rested. HP and Crew Use Restored.";
                },
                choices: [
                    { text: "Continue to Act 1", nextScene: 'lighthouse_morning', type: 'travel' } // MODIFIED
                ]
            },
            // --- ACT 1: LEVEL UP SEQUENCE (SKILL UNLOCK) ---
            'lighthouse_morning': {
                title: "The First Morning",
                text: "The chaotic surge of power that courses through you is threatening to splinter your mind. You pull the **Compass** from your belt—its needle is violently vibrating, demanding command. You must give the raw planar energy shape by focusing entirely on a single technique. **This choice is absolute.** The path you forge now is permanent, Mariner; it will determine your strength and define the immediate danger you face in the Port of Shadows.",
                journal: "The crew warned me of Fire and Shadow. I must choose how to prepare.",
                banter: { // Now uses the built-in Banter system
                    'gareth': "The town is bleeding. Fire and ruin in the Smelter District.",
                    'talon': "Things that refuse to stay dead hide in the fog of the Sunken Chapel."
                },
                choices: [
                    { 
                        text: "Learn to Endure (Absorb Elements)", 
                        nextScene: 'learn_absorb', 
                        type: 'dialogue',
                        customClass: 'btn-fire-glow' // NEW: Custom Class for Fire Style
                    }, 
                    { 
                        text: "Learn to See (Primeval Awareness)", 
                        nextScene: 'learn_primeval', 
                        type: 'dialogue',
                        customClass: 'btn-shadow-glow' // NEW: Custom Class for Shadow Style
                    }
                ]
            },
            'learn_absorb': {
                title: "Gareth's Lesson",
                text: "Gareth grips your shoulder. 'Fire burns only if you let it in. Capture it.' You feel a cold resilience settle in your veins. You understand now how to turn the elements against themselves.",
                journal: "I learned Absorb Elements. I am ready for the fire.",
                onEnter: (state) => {
                    if (!state.skills.includes("Absorb Elements")) {
                        state.skills.push("Absorb Elements");
                    }
                    state.currentHP = state.maxHP;
                    return "Unlocked: Absorb Elements. HP Restored.";
                },
                choices: [{ text: "Descend to the Town", nextScene: 'town_descent', type: 'travel' }]
            },
            'learn_primeval': {
                title: "Talon's Lesson",
                text: "Talon covers your eyes. 'The dead leave a wake in the ether. Look with your mind.' When you open your eyes, the world hums with hidden outlines. The unseen is now visible to you.",
                journal: "I learned Primeval Awareness. The undead cannot hide from me.",
                onEnter: (state) => {
                    if (!state.skills.includes("Primeval Awareness")) {
                        state.skills.push("Primeval Awareness");
                    }
                    state.currentHP = state.maxHP;
                    return "Unlocked: Primeval Awareness. HP Restored.";
                },
                choices: [{ text: "Descend to the Town", nextScene: 'town_descent', type: 'travel' }]
            },
            // --- ACT 1: THE HUB SETUP ---
            'town_descent': {
                title: "The Descent",
                text: "The path to the Port of Shadows is treacherous. As you near the city gates, your Compass vibrates violently. You pull it out, and the needle splits in two.<br><br>One ghostly needle glows <span class='text-orange-500'>Orange</span>, pointing toward the burning Smelter District.<br><br>The other needle turns <span class='text-gray-500'>Black</span>, pointing toward the fog of the Sunken Chapel.",
                journal: "The Compass has split. It tracks two distinct threats: Fire and Shadow.",
                choices: [
                    { text: "Enter the Port of Shadows", nextScene: 'town_square', type: 'travel' }
                ]
            },
            'town_square': {
                title: "Port of Shadows",
                text: "", // Dynamic text populated by onEnter
                onEnter: (state) => {
                    const hasRing = state.inventory.includes("Ring of Brass");
                    const hasBlade = state.inventory.includes("Sword of Valor");
                    
                    // Base choices for the hub
                    let newChoices = [
                        { 
                            text: "Investigate Smelter (Fire Path)", 
                            nextScene: 'smelter_entry', 
                            type: 'travel', 
                            reqNotItem: 'Sword of Valor', // Blade from Fire Path
                            customClass: 'btn-fire-glow' 
                        },
                        { 
                            text: "Investigate Chapel (Shadow Path)", 
                            nextScene: 'chapel_entry', 
                            type: 'travel',
                            reqNotItem: 'Ring of Brass', // Ring from Shadow Path
                            customClass: 'btn-shadow-glow' 
                        },
                        { text: "Visit Madam Alara, The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel' },
                        { text: "Find Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel' }, 
                    ];

                    // STATE 2: FINALE UNLOCKED - Remove exploration choices, force ritual preparation
                    if (hasRing && hasBlade) {
                        scenes['town_square'].text = "The Rift is tearing the sky apart. Violet lightning strikes the cobblestones. You have the Ring and the Blade. The Wolf King's ritual is the only way to close this wound.";
                        // Only offer the ritual button and the Tavern/Crossroads link (for supplies)
                        newChoices = [
                            { text: "Prepare the Wolf King's Ritual", nextScene: 'finale_ritual_start', type: 'combat', customClass: 'btn-hero' },
                            { text: "Visit Madam Alara, The Triage Alchemist", nextScene: 'alchemist_triage', type: 'travel' },
                            { text: "Find Rest at The Blackwater Tavern", nextScene: 'blackwater_tavern', type: 'travel' }
                        ];
                        // Finale scene TBD: finale_ritual_start
                        return "Finale Unlocked.";
                    } 
                    
                    // Filter choices based on acquired items
                    scenes['town_square'].choices = newChoices.filter(choice => {
                        // Hide Fire Path if Blade is acquired
                        if (choice.nextScene === 'smelter_entry' && hasBlade) return false;
                        // Hide Shadow Path if Ring is acquired
                        if (choice.nextScene === 'chapel_entry' && hasRing) return false;
                        return true;
                    });
                    
                },
                choices: []
            },
            
            // --- NEW HUB SCENES ---
            'alchemist_triage': {
                title: "Madam Alara, Triage Alchemist",
                text: "Madam Alara, encased in her beaked mask, tends to the wounded with clinical detachment. Her prices are steep, but her wares are potent—she deals only in true survival.",
                journal: null,
                stock: {
                    "Vitality Tincture": 2,
                    "Smelling Salts": 3,
                    "Flash Powder": 1
                },
                choices: [
                    { text: "Sell Wares", nextScene: 'alchemist_sell', type: 'travel' },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel' }
                ]
            },
            'alchemist_sell': {
                title: "Triage Alchemist - Selling",
                text: "Alara inspects your items, sometimes offering a premium for rare components. 'Speak your price, Mariner. Time is coin.'",
                journal: null,
                choices: [
                    { text: "Back to Buying", nextScene: 'alchemist_triage', type: 'travel' },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel' }
                ]
            },
            // NEW BUY SCENES FOR ALCHEMIST STOCK
            'buy_tincture': {
                title: "Purchase",
                text: "The Vitality Tincture burns cold in your hand.",
                journal: "I purchased a high-grade Vitality Tincture.",
                onEnter: (state) => { 
                    state.inventory.push("Vitality Tincture"); 
                    scenes['alchemist_triage'].stock["Vitality Tincture"] -= 1;
                    audioManager.playCoins();
                    return "Bought Tincture."; 
                },
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel' }]
            },
            'buy_salts': {
                title: "Purchase",
                text: "Smelling Salts. A desperate measure for desperate times.",
                journal: "I purchased Smelling Salts.",
                onEnter: (state) => { 
                    state.inventory.push("Smelling Salts"); 
                    scenes['alchemist_triage'].stock["Smelling Salts"] -= 1;
                    audioManager.playCoins();
                    return "Bought Smelling Salts."; 
                },
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel' }]
            },
            'buy_powder': {
                title: "Purchase",
                text: "Flash Powder. Quick, loud, and effective.",
                journal: "I purchased Flash Powder.",
                onEnter: (state) => { 
                    state.inventory.push("Flash Powder"); 
                    scenes['alchemist_triage'].stock["Flash Powder"] -= 1;
                    audioManager.playCoins();
                    return "Bought Flash Powder."; 
                },
                choices: [{ text: "Return to Alchemist", nextScene: 'alchemist_triage', type: 'travel' }]
            },
            // NEW SELL SCENES FOR ALCHEMIST STOCK (Higher value for some items)
            'sell_potion_alch': {
                title: "Sold for Premium",
                text: "The Alchemist pays a premium for the components in your standard Potion.",
                journal: "Sold a Healing Potion for 4 Shillings to the Alchemist.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Healing Potion");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 4; // Higher value than market merchant (3s)
                    audioManager.playCoins();
                    return "Sold Potion (+4s) to Alchemist.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel' }]
            },
             'sell_mushroom_alch': {
                title: "Sold for Premium",
                text: "The Alchemist recognizes the power in the Pearlescent Mushroom. 'A valuable specimen,' she murmurs.",
                journal: "Sold the Pearlescent Mushroom for 12 Shillings to the Alchemist.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Pearlescent Mushroom");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 12; 
                    audioManager.playCoins();
                    return "Sold Mushroom (+12s) to Alchemist.";
                },
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel' }]
            },
            'sell_fire': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Alchemical Fire.",
                journal: "I sold the Alchemical Fire artifact for 20 Shillings.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Alchemical Fire");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Alchemical Fire (+20s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel' }]
            },
            'sell_water': {
                title: "Sold Path Artifact",
                text: "A necessary sacrifice. The Alchemist gives you a heavy coin purse for the Holy Water.",
                journal: "I sold the Holy Water artifact for 20 Shillings.",
                onEnter: (state) => {
                    const idx = state.inventory.indexOf("Holy Water");
                    if (idx > -1) state.inventory.splice(idx, 1);
                    state.shillings += 20; 
                    audioManager.playCoins();
                    return "Sold Holy Water (+20s).";
                },
                choices: [{ text: "Continue Selling", nextScene: 'alchemist_sell', type: 'travel' }]
            },

            // --- BLACKWATER TAVERN SCENES (REST & INFO) ---
            'blackwater_tavern': {
                title: "The Blackwater Tavern",
                text: "The interior is dim and smells of stale brine and fear. This is where refugees and broken men hide. Rest is costly, but information is sometimes free.",
                journal: null,
                choices: [
                    // PAID REST OPTION
                    { text: "Pay 10 Shillings for a Cot (Full Rest)", nextScene: 'tavern_rest_success', type: 'action', cost: 10 },
                    // INFORMATION GATHERING
                    { text: "Listen to Engineer's Rumors (Smelter)", nextScene: 'gather_info_smelter', type: 'dialogue' },
                    { text: "Listen to Gravedigger's Warnings (Chapel)", nextScene: 'gather_info_chapel', type: 'dialogue' },
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel' }
                ]
            },
            'tavern_rest_success': {
                title: "A Night's Respite",
                text: "You find an empty cot in the dusty cellar. The gentle sway of your hoisted hammock lulls the bickering crew into a temporary, cohesive silence.",
                journal: "Paid 10 Shillings for a good night's rest. The voices are quiet.",
                onEnter: (state) => {
                    state.currentHP = state.maxHP;
                    Object.keys(state.crew).forEach(k => state.crew[k].used = false);
                    return "Paid 10s. HP and Crew Use Restored.";
                },
                choices: [
                    { text: "Return to Port Square", nextScene: 'town_square', type: 'travel' }
                ]
            },
            // NEW: INFORMATION SCENES
            'gather_info_smelter': {
                title: "Smelter District Tip",
                text: "The exhausted engineer whispers, 'The release valves are rusted shut. Quinn's knowledge won't work unless you know the **counter-clockwise, double-turn** trick. That'll save your life.'",
                journal: "Learned the secret to bypassing the Smelter's Steam Hazard.",
                onEnter: (state) => {
                    state.knowsSmelterSecret = true;
                    return "New Information Gained (Smelter Path).";
                },
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel' }]
            },
            'gather_info_chapel': {
                title: "Sunken Chapel Tip",
                text: "The pale gravedigger warns you, 'Don't follow the sound; follow the silence. The paths are a maze, but the silent, **weeping angel statues** mark the safe, true route.'",
                journal: "Learned the safe route through the Sunken Chapel's Fog Maze.",
                onEnter: (state) => {
                    state.knowsChapelSecret = true;
                    return "New Information Gained (Chapel Path).";
                },
                choices: [{ text: "Return to Tavern", nextScene: 'blackwater_tavern', type: 'travel' }]
            },
            // --- END HUB SCENES ---

            // --- TBD PATH SCENES (UPDATED FOR NEW LOGIC) ---
            'smelter_entry': {
                title: "Smelter District: Steam Vents",
                text: "The path is blocked by a burst steam pipe spitting magical fire. The main valve is screaming and rusted over. You need to use your abilities or brute force here.",
                choices: [
                    // OPTION 1: INFO CHECK (Automatic Success)
                    { 
                        text: "Attempt Counter-Clockwise Double-Turn (Secret)", 
                        nextScene: 'smelter_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsSmelterSecret',
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 2: HERO BUTTON (Absorb Elements)
                    { 
                        text: "Channel Absorb Elements (Negate Damage)", 
                        nextScene: 'smelter_safe_charged', 
                        type: 'action', 
                        reqSkill: 'Absorb Elements', 
                        customClass: 'btn-fire-glow' 
                    },
                    // OPTION 3: SKILL CHECK (Quinn/Investigation) - High DC because of rust
                    { text: "Analyze & Attempt to Turn Valve", nextScene: 'smelter_roll', type: 'skill', dc: 15, skill: 'Investigation' }
                ]
            },
            'smelter_safe_charged': { 
                title: "Absorbed Charge", 
                text: "You pass safely, the fire damage absorbed. The excess heat now crackles on your blade, ready for the next fight.", 
                journal: "Used Absorb Elements. Blade is Charged.",
                choices: [{ text: "Continue to Foundry (Combat)", nextScene: 'smelter_foundry', type: 'travel' }] // TBD COMBAT SCENE
            },
            'smelter_safe': { 
                title: "Safe Passage", 
                text: "You pass safely.", 
                choices: [{ text: "Continue to Foundry (Combat)", nextScene: 'smelter_foundry', type: 'travel' }] // TBD COMBAT SCENE
            },
            'smelter_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'smelter_safe' : 'smelter_damage' },
            'smelter_damage': { 
                title: "Burned", 
                text: "You take a burn running past the valve.", 
                onEnter: (s) => { 
                    s.currentHP = applyDamage(s.currentHP, 5); 
                    fxManager.flashRed();
                    return "Took 5 Fire Damage."; 
                }, 
                choices: [{ text: "Continue to Foundry (Combat)", nextScene: 'smelter_foundry', type: 'travel' }] 
            },
            // NEW SCENE: Placeholder for the combat encounter we discussed
            'smelter_foundry': {
                title: "The Foundry",
                text: "You find the Sword of Valor, but it is guarded by the Slag Horror (Fire Elemental). Prepare for combat.",
                choices: [{ text: "Begin Combat", nextScene: 'town_square', type: 'travel' }] // Temporary return
            },

            'chapel_entry': {
                title: "Sunken Chapel: The Fog Maze",
                text: "The cemetery is covered in unnatural fog. The paths loop back on themselves, and you cannot see.",
                choices: [
                    // OPTION 1: INFO CHECK (Automatic Success)
                    { 
                        text: "Follow the Weeping Angel Statues (Secret)", 
                        nextScene: 'chapel_safe', 
                        type: 'dialogue', 
                        reqFlag: 'knowsChapelSecret',
                        customClass: 'btn-success-glow'
                    },
                    // OPTION 2: HERO BUTTON (Primeval Awareness)
                    { 
                        text: "Channel Primeval Awareness (See Ambushers)", 
                        nextScene: 'chapel_safe_surprise', 
                        type: 'action', 
                        reqSkill: 'Primeval Awareness', 
                        customClass: 'btn-shadow-glow' 
                    },
                    // OPTION 3: SKILL CHECK (Talon/Perception)
                    { text: "Attempt to Track Movement", nextScene: 'chapel_roll', type: 'skill', dc: 15, skill: 'Perception' }
                ]
            },
            'chapel_safe_surprise': { 
                title: "Ambush Avoided", 
                text: "You bypass the maze and surprise the Spectre. You get a free hit.", 
                journal: "Used Primeval Awareness. Gained Surprise Round.",
                choices: [{ text: "Continue to Crypt (Combat)", nextScene: 'chapel_crypt', type: 'travel' }] // TBD COMBAT SCENE
            },
            'chapel_safe': { 
                title: "Found Path", 
                text: "You navigate the fog safely.", 
                choices: [{ text: "Continue to Crypt (Combat)", nextScene: 'chapel_crypt', type: 'travel' }] // TBD COMBAT SCENE
            },
            'chapel_roll': { isLogic: true, resolve: (roll) => roll >= 15 ? 'chapel_safe' : 'chapel_damage' },
            'chapel_damage': { 
                title: "Ambushed", 
                text: "A shadow creature ambushes you.", 
                onEnter: (s) => { 
                    s.currentHP = applyDamage(s.currentHP, 6); 
                    fxManager.flashRed();
                    return "Took 6 Shadow Damage."; 
                }, 
                choices: [{ text: "Continue to Crypt (Combat)", nextScene: 'chapel_crypt', type: 'travel' }] 
            },
            // NEW SCENE: Placeholder for the combat encounter we discussed
            'chapel_crypt': {
                title: "The Flooded Crypt",
                text: "You find the Ring of Brass, but it is guarded by the Drowned Spectre (Undead). Prepare for combat.",
                choices: [{ text: "Begin Combat", nextScene: 'town_square', type: 'travel' }] // Temporary return
            },

            // --- END TBD PATH SCENES ---
            
            'finale_ritual_start': { title: "The Ritual", text: "Ritual start scene.", choices: [{ text: "End", type: 'reset' }] },

            'edward_death': {
                title: "The Mariner's End",
                text: "The voices fall silent, only to surge back in a deafening, cold chorus that rips through your mind. The debt is paid. The Planar Storm claims its last crewman, pulling you into the abyss. You feel the crushing presence of the Leviathan one final time.",
                journal: "Edward Jones is lost to the deep. The voices of the damned are finally silenced.",
                choices: [
                    { text: "Awaken (Restart Game)", type: 'reset' }
                ]
            }
        };

        // --- CORE FUNCTIONS ---
        // NEW HELPER: Applies damage while ensuring HP doesn't go below 0.
        function applyDamage(currentHP, damageAmount) {
            // Clamps HP at 0
            return Math.max(0, currentHP - damageAmount);
        }

        // Helper function to provide initial stock data structure
        scenes['market_stall'].stock = {
            "Healing Potion": 1,
            "Rope": 1,
            "Torch": 1,
            "Curious Cargo": 1, // Tracks how many times this merchant will buy the cargo
            "Rum (Heal 5)": 0 // Rum starts at zero stock
        };
        // NEW: Alchemist stock initialization
        scenes['alchemist_triage'].stock = {
            "Vitality Tincture": 2,
            "Smelling Salts": 3,
            "Flash Powder": 1
        };
        
        async function generateSceneImage(sceneId) {
            const key = sceneId || 'default';
            const url = sceneImages[key] || sceneImages['default'];
            
            const imgEl = document.getElementById('scene-image');
            const loader = document.getElementById('image-loader');
            
            // Hide image, show loader immediately for visual feedback
            imgEl.style.opacity = 0;
            loader.style.display = 'flex';
            imgEl.src = ''; // Clear previous image

            // Use a temporary image object to manage loading state reliably
            const tempImg = new Image();
            tempImg.src = url;

            tempImg.onload = () => {
                // Once loaded, apply source, hide loader, and fade in
                imgEl.src = url;
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };

            tempImg.onerror = () => {
                // Fallback to placeholder on error
                console.warn(`Failed to load image for scene: ${sceneId}. Falling back to placeholder.`);
                imgEl.src = sceneImages['default'];
                loader.style.display = 'none';
                imgEl.style.opacity = 1;
            };
        }

        async function init() {
            window.confirmReset = confirmReset;
            window.resetGame = resetGame; 

            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    user = u;
                    await setupRealtimeListener();
                    document.getElementById('app-loading').classList.add('fade-out');
                    setTimeout(() => document.getElementById('app-loading').remove(), 500);
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        async function setupRealtimeListener() {
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            
            try {
                const snap = await getDoc(docRef);
                if (!snap.exists()) {
                    await setDoc(docRef, gameState);
                    renderScene('prologue_storm');
                } else {
                    const data = snap.data();
                    if (data.influence === undefined) {
                        data.influence = 0; 
                        delete data.guardInfluence;
                        delete data.smugglerInfluence;
                    }
                    // Merge saved data with default to ensure new fields are included
                    const savedState = { ...createInitialState(), ...data }; 
                    gameState = savedState;
                    
                    // --- PERSIST SCENE STOCK CHANGES ---
                    // This ensures any purchases/sales made before the last save persist 
                    // on the scene object, not just in the state.
                    if (data.market_stall_stock) {
                         scenes['market_stall'].stock = data.market_stall_stock;
                    }
                    if (data.alchemist_triage_stock) {
                        scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                    }
                    
                    renderScene(gameState.currentSceneId, false);
                    rebuildJournal();
                }
            } catch (e) {
                console.error("Save error", e);
                renderScene('prologue_storm');
            }

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (JSON.stringify(data) !== JSON.stringify(gameState)) {
                        
                        // Apply scene specific stock changes from Firestore to the runtime scene object
                        if (data.market_stall_stock) {
                            scenes['market_stall'].stock = data.market_stall_stock;
                            delete data.market_stall_stock; // Don't overwrite gameState with this old field
                        }
                        if (data.alchemist_triage_stock) {
                            scenes['alchemist_triage'].stock = data.alchemist_triage_stock;
                            delete data.alchemist_triage_stock;
                        }

                        gameState = { ...gameState, ...data };
                        updateUI();
                    }
                }
            });
        }

        async function saveGame() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'game_save');
            const safeState = JSON.parse(JSON.stringify(gameState));
            
            // --- ATTACH SCENE STOCK TO SAVED STATE ---
            safeState.market_stall_stock = scenes['market_stall'].stock;
            safeState.alchemist_triage_stock = scenes['alchemist_triage'].stock;

            await setDoc(docRef, safeState);
        }

        let resetConfirmTimer = null;
        function confirmReset() {
            const btn = document.getElementById('reset-game-btn');
            if (btn.classList.contains('bg-red-900')) {
                resetGame();
                clearTimeout(resetConfirmTimer);
                btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                btn.classList.remove('bg-red-900', 'text-white');
                btn.classList.add('text-red-400', 'bg-black/60');
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Confirm?';
                btn.classList.remove('text-red-400', 'bg-black/60');
                btn.classList.add('bg-red-900', 'text-white');
                resetConfirmTimer = setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-skull mr-1"></i>New Game';
                    btn.classList.remove('bg-red-900', 'text-white');
                    btn.classList.add('text-red-400', 'bg-black/60');
                }, 3000);
            }
        }

        async function resetGame() {
            // Reset state
            gameState = createInitialState();
            // Reset scene data manually (needed for market stock)
            scenes['market_stall'].stock = {
                "Healing Potion": 1,
                "Rope": 1,
                "Torch": 1,
                "Curious Cargo": 1, 
                "Rum (Heal 5)": 0 
            };
            scenes['alchemist_triage'].stock = {
                "Vitality Tincture": 2,
                "Smelling Salts": 3,
                "Flash Powder": 1
            };

            document.getElementById('journal-content').innerHTML = '';
            await saveGame();
            renderScene('prologue_storm');
            rebuildJournal();
            document.getElementById('inf-status-text').textContent = "Unknown to all";
            document.getElementById('item-desc-area').textContent = "Hover over an item to inspect it.";
        }

        function rebuildJournal() {
            const container = document.getElementById('journal-content');
            container.innerHTML = gameState.history.join('');
            scrollToBottom();
        }

        function scrollToBottom() {
            const area = document.getElementById('journal-scroll-area');
            area.scrollTop = area.scrollHeight;
        }

        function addToHistory(text, type = 'entry') {
            let html = '';
            if (type === 'entry') {
                // Apply spectral-text-glow to crew names in the journal
                const processedText = text.replace(/(Captain Gareth|Gareth|Quinn|Talon|Bones|Wolf King|Ring|Blade)/g, '<span class="spectral-text-glow">$1</span>');
                html = `<div class="journal-font pb-4 border-b border-gray-700/30 text-gray-400 fade-in">${processedText}</div>`;
            } else if (type === 'system') {
                html = `<div class="text-xs text-amber-500 font-mono mb-2 fade-in">> ${text}</div>`;
            } else if (type === 'roll') {
                // Apply spectral-text-glow to roll results
                html = `<div class="text-xs spectral-text-glow font-bold mb-2 fade-in font-serif">${text}</div>`;
            }
            gameState.history.push(html);
            rebuildJournal();
        }
        
        async function renderScene(sceneId, logText = true) {
            const scene = scenes[sceneId];
            if (!scene) return;
            
            // --- DEATH CHECK 0: Check previous state before processing current scene logic ---
            // If the player entered this scene already dead (e.g., from damage applied in a previous scene's logic)
            // This prevents a journal entry from the current scene being added before the death scene loads
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }


            if (scene.isLogic) {
                let roll = Math.floor(Math.random() * 20) + 1;
                let crewUsedName = "None";
                let logMsg = `Check (DC ${gameState.lastDC || 10}): Rolled d20 (${roll})`;
                
                // Clear last used crew ID before a new check
                gameState.lastCrewUsedId = null;

                if (activeCrewMember) {
                    const isSkilled = getBonusForSkill(activeCrewMember, gameState.lastSkillType);
                    const crewKey = activeCrewMember.id;
                    
                    if (isSkilled) { 
                        const bonus = Math.floor(Math.random() * 4) + 1;
                        roll += bonus;
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + ${bonus} (${crewUsedName})`;
                        
                        // MUSHROOM LOGIC CHECK (APPLY COST OR FREE USE)
                        if (gameState.crewUseFree) {
                            // Free use: DO NOT mark as used, but consume the mushroom effect.
                            addToHistory(`*Pearlescent Mushroom consumed for FREE GUIDANCE.*`, 'system');
                            gameState.crewUseFree = false; // CONSUME EFFECT
                        } else {
                            // Normal use: Mark as used.
                            gameState.crew[crewKey].used = true;
                        }
                        
                        // Store the ID of the crew member used on this check (used for Talon Cargo logic)
                        if (roll >= gameState.lastDC) {
                            gameState.lastCrewUsedId = crewKey;
                        }
                        
                    } else if (gameState.crewUseFree) {
                         // Crew selected, mushroom active, but SKILL DOESN'T MATCH.
                         // No bonus is granted. Mushroom effect is conserved.
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + 0 (${crewUsedName} - Invalid Skill, Mushroom conserved)`;
                        addToHistory(`*Mushroom conserved: ${crewUsedName} doesn't have expertise in ${gameState.lastSkillType}.*`, 'system');
                        // DO NOT set crewUseFree = false here
                    } else {
                        // Crew selected, mushroom inactive, skill doesn't match.
                        crewUsedName = activeCrewMember.name;
                        logMsg += ` + 0 (${crewUsedName} - Invalid Skill)`;
                        // Do not mark as used if skill was invalid
                    }
                    
                    activeCrewMember = null;
                }

                addToHistory(`${logMsg} = ${roll}`, 'roll');
                
                // Resolve logic scene immediately based on this roll
                const nextId = scene.resolve(roll, gameState); 
                saveGame();
                renderScene(nextId); 
                return;
            }

            gameState.currentSceneId = sceneId;
            
            // --- FX TRIGGER LOGIC ---
            fxManager.clearEffects();

            // Violet Pulse scenes
            if (['prologue_storm', 'prologue_abyss', 'guard_scared', 'lighthouse_vigil', 'town_square', 'smelter_foundry', 'chapel_crypt'].includes(sceneId)) {
                fxManager.setPulse(true);
            } else {
                fxManager.setPulse(false);
            }

            if (scene.onEnter && logText) {
                const msg = scene.onEnter(gameState);
                // Apply damage and then check death immediately
                if (msg) addToHistory(msg, 'system');
                saveGame();
            }

            // --- DEATH CHECK 1: Immediately check if onEnter killed the player ---
            if (gameState.currentHP === 0 && sceneId !== 'edward_death') {
                renderScene('edward_death');
                return;
            }

            const textEl = document.getElementById('main-scene-text');
            // Check if we are in the Death scene to apply unique styling
            const isDeathScene = sceneId === 'edward_death';
            
            // Restore default text styling for normal scenes, use red only for death scene
            let titleClass = isDeathScene ? 'text-red-500' : 'text-amber-500';
            let textClass = isDeathScene ? 'text-red-300' : 'text-gray-300';

            
            let finalHtml = `<h2 class="2xl cinzel ${titleClass} mb-2">${scene.title}</h2><p class="text-lg leading-relaxed ${textClass} fade-in">${scene.text}</p>`;
            
            // --- BANTER INJECTION (AUTOMATIC) ---
            if (scene.banter) {
                Object.keys(scene.banter).forEach(crewId => {
                    if (gameState.crew[crewId] && !gameState.crew[crewId].used) {
                        // Apply spectral glow to banter text (MODIFIED)
                         finalHtml += `<div class="mt-4 spectral-text-glow italic border-l-2 border-blue-500 pl-3 fade-in">
                                <span class="font-bold text-xs uppercase block mb-1">${gameState.crew[crewId].name}:</span>
                                "${scene.banter[crewId]}"
                              </div>`;
                    }
                });
            }
            
            textEl.innerHTML = finalHtml;
            document.getElementById('scene-title').innerText = scene.title;
            
            activeCrewMember = null; 
            
            generateSceneImage(sceneId);
            renderChoices(scene.choices, isDeathScene); // Pass death status to renderChoices
            updateUI();
        }

        function renderChoices(choices, isDeathScene = false) {
            const container = document.getElementById('choices-area');
            container.innerHTML = '';

            // --- LOCAL STOCK UTILITY ---
            const currentSceneId = gameState.currentSceneId;
            const currentSceneStock = scenes[currentSceneId] ? scenes[currentSceneId].stock : {};
            const marketStock = scenes['market_stall'].stock; // Reference for selling logic
            
            // Collect all choices, starting with static ones
            let processedChoices = [...choices]; 

            // Handle dynamic generation for Market Scenes
            if (currentSceneId === 'market_stall') {
                // Isolate navigation choices and prepare to regenerate buy options
                const permanentChoices = processedChoices.filter(c => c.nextScene === 'market_sell' || c.nextScene === 'market_crossroads');
                processedChoices = []; 

                // 1. Generate Dynamic Buy Options
                MARKET_BUY_OPTIONS.forEach(sale => {
                    // Check local stock for this item name
                    const actualStock = currentSceneStock[sale.item] || 0;
                    
                    // RULE: Only display if in stock (actualStock > 0)
                    if (actualStock > 0) {
                        processedChoices.push({
                            text: `Buy ${sale.item.split('(')[0].trim()} (Stock: ${actualStock})`,
                            nextScene: sale.nextScene,
                            type: 'action',
                            cost: sale.cost,
                            stockItem: sale.item 
                        });
                    }
                });
                
                // 2. Add static navigation back in
                // Rename the selling button text
                const sellWaresChoice = permanentChoices.find(c => c.nextScene === 'market_sell');
                if (sellWaresChoice) {
                    sellWaresChoice.text = "Sell Wares"; 
                    processedChoices.push(sellWaresChoice);
                }
                
                processedChoices.push(permanentChoices.find(c => c.nextScene === 'market_crossroads'));

            } else if (currentSceneId === 'market_sell') {
                // Isolate navigation choices and prepare to regenerate sell options
                const permanentChoices = choices.filter(c => c.nextScene === 'market_stall' || c.nextScene === 'market_crossroads');
                processedChoices = []; 

                // Generate Dynamic Sell Options
                MARKET_SELL_OPTIONS.forEach(sell => {
                    // Check if the player has the item in inventory
                    // RULE: Only display if player has the item in inventory (reqItem check is implicit here)
                    if (gameState.inventory.includes(sell.item)) {
                        
                        // Special check for Curious Cargo: Merchant won't buy it if stock is 0 (one-time buy)
                        if (sell.item === 'Curious Cargo' && marketStock['Curious Cargo'] === 0) {
                            return; 
                        }
                        
                        processedChoices.push({
                            text: `Sell ${sell.item.split('(')[0].trim()} (+${sell.value}s)`, 
                            nextScene: sell.nextScene,
                            type: 'action',
                            reqItem: sell.item,
                            value: sell.value 
                        });
                    }
                });
                // Add back the navigation choices
                processedChoices = processedChoices.concat(permanentChoices);
            } else if (currentSceneId === 'alchemist_triage') {
                 // Isolate navigation choices and prepare to regenerate buy options
                const permanentChoices = processedChoices.filter(c => c.nextScene === 'alchemist_sell' || c.nextScene === 'town_square');
                processedChoices = []; 

                // 1. Generate Dynamic Buy Options
                ALCHEMIST_BUY_OPTIONS.forEach(sale => {
                    const itemText = sale.item.split('(')[0].trim();
                    const actualStock = currentSceneStock[sale.item] || 0;
                    
                    // RULE: Only display if in stock (actualStock > 0)
                    if (actualStock > 0) {
                        processedChoices.push({
                            text: `Buy ${itemText} (${sale.cost}s)`,
                            nextScene: sale.nextScene,
                            type: 'action',
                            cost: sale.cost,
                            stockItem: sale.item,
                        });
                    }
                });
                
                // 2. Add static navigation back in
                const sellWaresChoice = permanentChoices.find(c => c.nextScene === 'alchemist_sell');
                if (sellWaresChoice) {
                    sellWaresChoice.text = "Sell Wares (Premium)"; 
                    processedChoices.push(sellWaresChoice);
                }
                
                processedChoices.push(permanentChoices.find(c => c.nextScene === 'town_square'));

            } else if (currentSceneId === 'alchemist_sell') {
                // Isolate navigation choices and prepare to regenerate sell options
                const permanentChoices = choices.filter(c => c.nextScene === 'alchemist_triage' || c.nextScene === 'town_square');
                processedChoices = []; 
                
                // Generate Dynamic Sell Options (Alchemist Stock)
                ALCHEMIST_SELL_OPTIONS.forEach(sell => {
                    // RULE: Only display if player has the item in inventory
                    if (gameState.inventory.includes(sell.item)) {
                        
                        processedChoices.push({
                            text: `Sell ${sell.item.split('(')[0].trim()} (+${sell.value}s)`, 
                            nextScene: sell.nextScene,
                            type: 'action',
                            reqItem: sell.item,
                            value: sell.value,
                        });
                    }
                });
                // Add back the navigation choices
                processedChoices = processedChoices.concat(permanentChoices);
            }
            // NEW: Blackwater Tavern Rest Logic (Only appears if current HP < Max HP)
            else if (currentSceneId === 'blackwater_tavern') {
                const restOption = processedChoices.find(c => c.nextScene === 'tavern_rest_success');
                if (restOption && gameState.currentHP === gameState.maxHP) {
                    // Filter out the rest option if at full HP
                    processedChoices = processedChoices.filter(c => c.nextScene !== 'tavern_rest_success');
                } else if (restOption) {
                    // Rename the rest option to include current cost
                    restOption.text = `Pay ${restOption.cost} Shillings for a Cot (Full Rest)`;
                }
            }


            // --- Process Choices and Create Buttons ---
            processedChoices.forEach(choice => {
                
                // --- VISIBILITY (OMIT) CHECKS: Apply OMIT logic first ---
                
                const isTradeButton = choice.cost || choice.value;

                // OMIT 1: Non-Merchant Choices that require an item (Rope/Torch/etc.)
                // This correctly omits choices if the item is NOT a trade item AND the item is missing.
                if (choice.reqItem && !isTradeButton && !gameState.inventory.includes(choice.reqItem)) {
                     return;
                }
                
                // --- GENERAL REQUIREMENTS CHECK (Remaining visibility checks) ---
                
                if (choice.reqSmuggler && gameState.influence < choice.reqSmuggler) return;
                if (choice.reqGuard && gameState.influence > -choice.reqGuard) return;
                
                if (choice.reqNotItem && gameState.inventory.includes(choice.reqNotItem)) return; // NEW NOT ITEM CHECK
                // NEW: Information Flag Check
                if (choice.reqFlag && !gameState[choice.reqFlag]) return;

                // SKILL CHECK: If choice requires a skill, hide it if player hasn't learned the Hero Skill
                if (choice.reqSkill && !gameState.skills.includes(choice.reqSkill)) return;


                // --- DISABILITY (GREY OUT) CHECKS ---
                let isDisabled = false;
                let disabledClass = '';
                
                // Check 1: Affordability (Cost is defined for this choice AND player can't afford it)
                if (choice.cost && gameState.shillings < choice.cost) {
                    isDisabled = true;
                    disabledClass = 'btn-disabled-cost';
                }
                
                const btn = document.createElement('button');
                
                // Determine styling: Is this a Hero/Skill moment?
                let isHeroButton = choice.reqSkill ? true : false;
                let isCustomClassButton = choice.customClass ? true : false;

                const alignmentClass = (choice.type === 'skill' || isTradeButton || choice.chaosGain || choice.orderGain) ? 'justify-start' : 'justify-between';
                
                let btnClass = "";
                
                if (isDeathScene) {
                    // Death button is always full red and large
                    btnClass = `btn-game w-full p-3 text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-red-900 border-red-700 hover:bg-red-800 hover:border-amber-500 text-white text-xl text-center`;
                } else if (isCustomClassButton) {
                    // HERO/PATH/SECRET BUTTONS: Use the dedicated custom classes for color/glow
                    btnClass = `w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold mb-2 ${choice.customClass}`;
                } else {
                    // STANDARD NARRATIVE/TRADE BUTTONS (Default grey button)
                    btnClass = `btn-game w-full text-left rounded shadow flex items-center ${alignmentClass} cinzel font-bold bg-gray-800 border-gray-600 hover:border-amber-500 hover:bg-gray-750 text-gray-300 group`;
                }
                
                // Apply disability visual override if necessary
                if (isDisabled) {
                    btnClass += ` ${disabledClass}`;
                    btn.disabled = true;
                }

                btn.className = btnClass;
                
                // --- ONCLICK HANDLER ---
                btn.onclick = (e) => {
                    // If disabled, just play click sound and stop execution
                    if (btn.disabled) {
                         audioManager.playClick();
                         return;
                    }
                    
                    // ... (rest of the action logic remains the same)
                    audioManager.playClick();
                    
                    if (choice.type === 'reset') {
                        resetGame();
                        return;
                    }
                    
                    // --- MUSHROOM CHECK: If mushroom is active and click is NOT a skill check, log a warning ---
                    if (gameState.crewUseFree && choice.type !== 'skill' && choice.type !== 'dialogue') {
                        addToHistory(`*Warning: The Pearlescent Mushroom's clarity is best saved for a crucial skill check.*`, 'system');
                        // Do NOT consume the free use, just continue the scene flow
                    }

                    // --- FINAL STOCK CHECK BEFORE TRANSACTION (Crucial Fix) ---
                    // This is still needed for asynchronous stock changes (e.g., two players buying the last item in MP mode)
                    if (choice.type === 'action' && (currentSceneId === 'market_stall' || currentSceneId === 'alchemist_triage') && choice.stockItem) {
                         const currentStock = scenes[currentSceneId].stock[choice.stockItem] || 0;
                         if (currentStock <= 0) {
                            addToHistory(`${choice.stockItem} is out of stock.`, 'system');
                            renderScene(currentSceneId); // Reload scene to update choices
                            return;
                        }
                    }
                    // 3. Check selling stock (Curious Cargo at Market)
                    if (choice.type === 'action' && choice.reqItem === 'Curious Cargo' && currentSceneId === 'market_sell') {
                         if (marketStock['Curious Cargo'] <= 0) {
                            addToHistory(`The Market Merchant has no need for another Curious Cargo.`, 'system');
                            renderScene(currentSceneId);
                            return;
                        }
                    }


                    if (choice.consume && choice.reqItem) {
                        const idx = gameState.inventory.indexOf(choice.reqItem);
                        if (idx > -1) {
                            gameState.inventory.splice(idx, 1);
                            addToHistory(`${choice.reqItem} used and discarded.`, 'system');
                        }
                    }

                    const currentScene = scenes[gameState.currentSceneId];
                    // IMPORTANT: Only log the journal entry text if the current scene is NOT a hub/merchant scene.
                    if (currentScene.journal !== null && currentScene.journal !== undefined) {
                        addToHistory(currentScene.journal, 'entry');
                    }

                    // --- APPLY ACTIONS ---
                    if (choice.cost) gameState.shillings -= choice.cost;
                    if (choice.chaosGain) gameState.influence = Math.min(20, gameState.influence + choice.chaosGain);
                    
                    // RP FIX: Player perceives Order gain, even though it's technically negative influence shift
                    if (choice.orderGain) gameState.influence = Math.max(-20, gameState.influence - choice.orderGain); 
                    
                    // --- SKILL CHECK LOGIC WITH COMPLEX CREW TRACKING ---
                    if (choice.type === 'skill') {
                        // Store required skill type and DC for the logic scene resolution
                        gameState.lastSkillType = choice.skill;
                        gameState.lastDC = choice.dc;
                        
                        // Handle the roll in the next scene to allow for complex logic checks (like Talon's Cargo)
                        renderScene(choice.nextScene);
                        return;
                    }
                    
                    // Non-skill choices or if logic flow differs
                    if (choice.type !== 'skill') {
                        renderScene(choice.nextScene);
                    }
                };
                
                // --- Conditional Content & Icon Generation ---

                // Determine hover state based on disability check
                const hoverClass = isDisabled ? '' : 'group-hover:text-amber-100';
                const baseTextColor = isDisabled ? 'text-gray-500' : 'text-gray-300';
                
                let icon = `<i class="fas fa-chevron-right ${baseTextColor} ${hoverClass}"></i>`;
                let content = `<span class="cinzel font-bold ${baseTextColor} ${hoverClass}">${choice.text}</span>`;
                
                // Check if button is colored and adjust default icon color
                if (isCustomClassButton) {
                    // For custom color buttons (path/hero/secret), the icon and text should be white/light color
                    // Ensure hover effect is applied only if NOT disabled
                    const customContentColor = isDisabled ? 'text-gray-500' : 'text-white';
                    const customIconColor = isDisabled ? 'text-gray-500' : 'text-white';

                    icon = `<i class="fas fa-chevron-right ${customIconColor} ${hoverClass}"></i>`;
                    content = `<span class="cinzel font-bold ${customContentColor} ${hoverClass}">${choice.text}</span>`;
                }
                
                // Override icon for trade buttons
                if (isTradeButton) {
                    // Trade buttons always have a coin icon and amber color base (but stripped on disability)
                    const tradeIconColor = isDisabled ? 'text-gray-500' : 'text-amber-500';
                    icon = `<i class="fas fa-coins ${tradeIconColor}"></i>`;
                    
                    // The text content needs the hover effect removed if disabled
                    content = `<span class="cinzel font-bold ${baseTextColor} ${hoverClass}">${choice.text}</span>`;

                    // Special case for skill checks with dice icon that use glow, need to reset icon back
                    if (choice.type === 'skill') {
                         icon = '<i class="fas fa-dice-d20 spectral-text-glow"></i>';
                    }
                }

                if (choice.type === 'skill') {
                    // Skill notation and dice icon are aligned immediately after the label
                    // Apply spectral glow effect (MODIFIED)
                    supplementalText += ` <span class="spectral-text-glow text-sm uppercase tracking-wider ml-2 mr-4">[${choice.skill} DC ${choice.dc}]</span>`;
                    // Dice icon also receives spectral glow (MODIFIED)
                    icon = '<i class="fas fa-dice-d20 spectral-text-glow"></i>';
                } else if (isHeroButton) {
                    // Hero Button Icon (NEW)
                    icon = '<i class="fas fa-star hero-icon"></i>'; 
                }
                
                // --- Consistent Currency/Value/Influence Display ---
                let transactionIndicator = '';
                let indicatorColor = 'text-amber-500';

                if (choice.cost) {
                    // Cost (Negative) for Buy/Bribe
                    transactionIndicator = `(-${choice.cost}s)`;
                    indicatorColor = isDisabled ? 'text-red-700' : 'text-amber-500'; // Make cost red if disabled
                } else if (choice.value) {
                    // Value (Positive) for Sell actions
                    transactionIndicator = `(+${choice.value}s)`;
                } else if (choice.chaosGain) {
                    // Chaos Gain (Positive) for Smuggler trade (Emerald color for Chaos)
                    transactionIndicator = `(+${choice.chaosGain} Chaos)`;
                    indicatorColor = 'text-emerald-400';
                } else if (choice.orderGain) {
                    // Order Gain (Negative Influence Shift) - Use primary blue-400 (MODIFIED)
                    // RP FIX: Display as +Gain
                    transactionIndicator = `(+${choice.orderGain} Order)`; 
                    indicatorColor = 'text-blue-400'; // Primary Order Faction Color
                }

                if (transactionIndicator) {
                    // Increase size to text-sm
                    supplementalText += ` <span class="${indicatorColor} text-sm ml-1">${transactionIndicator}</span>`;
                }
                // --- End Transaction Display ---
                
                if (choice.type === 'reset') {
                     icon = '<i class="fas fa-undo text-white"></i>'; // Ensure reset button icon is white/visible
                     // Content is already set in death scene to Awaken (Restart Game)
                }
                
                // If there is supplemental text (skill/cost/value), merge it with the main content
                if (supplementalText) {
                    content += supplementalText;
                    btn.innerHTML = `${content} <span class="ml-auto">${icon}</span>`;
                } else {
                     // Default travel/dialogue button using justify-between
                     btn.innerHTML = `${content}${icon}`;
                }


                container.appendChild(btn);
            });
        }

        function updateUI() {
            // PROLOGUE & LOG UI HANDLING
            const statsPanel = document.getElementById('stats-panel');
            const journalContainer = document.getElementById('journal-container');
            const sceneId = gameState.currentSceneId;
            
            if (sceneId && sceneId.startsWith('prologue')) {
                statsPanel.classList.add('prologue-blur');
                journalContainer.classList.add('log-hidden');
                journalContainer.classList.remove('log-visible');
            } else {
                statsPanel.classList.remove('prologue-blur');
                statsPanel.classList.add('prologue-active');
                
                if(gameState.inventory.includes("Ship's Log")) {
                    journalContainer.classList.remove('log-hidden');
                    journalContainer.classList.add('log-visible');
                } else {
                    journalContainer.classList.add('log-hidden');
                    journalContainer.classList.remove('log-visible');
                }
            }

            // HP
            const hpPct = (gameState.currentHP / gameState.maxHP) * 100;
            const bar = document.getElementById('hp-bar');
            bar.style.width = `${hpPct}%`;
            bar.className = `h-full transition-all duration-500 ${hpPct < 30 ? 'bg-red-600 animate-pulse' : 'bg-red-800'}`;
            document.getElementById('hp-text').innerText = `${gameState.currentHP}/${gameState.maxHP}`;

            // Check for low health audio & vignette
            audioManager.checkVulnerable(gameState.currentHP, gameState.maxHP);
            if (hpPct <= 30) {
                fxManager.setVignette(true);
            } else {
                fxManager.setVignette(false);
            }

            // Money
            document.getElementById('shillings-display').innerText = gameState.shillings;
            
            // Influence
            const inf = gameState.influence || 0;
            const pct = ((inf + 20) / 40) * 100;
            const marker = document.getElementById('inf-marker');
            if (marker) marker.style.left = `${Math.max(0, Math.min(100, pct))}%`;
            
            const infText = document.getElementById('inf-status-text');
            if (infText) {
                if (inf < -10) infText.textContent = "Sworn to the Crown";
                else if (inf < -5) infText.textContent = "Respected by Guards";
                else if (inf > 10) infText.textContent = "Pirate Lord";
                else if (inf > 5) infText.textContent = "Known Smuggler";
                else infText.textContent = "Unknown / Neutral";
            }

            // Crew UI
            const ind = document.getElementById('active-crew-indicator');
            const nameSpan = document.getElementById('active-crew-name');
            if (activeCrewMember) {
                ind.classList.remove('hidden');
                nameSpan.innerText = activeCrewMember.name;
            } else {
                ind.classList.add('hidden');
            }

            const crewContainer = document.getElementById('crew-panel');
            crewContainer.innerHTML = '';
            
            // Define fixed order of keys
            const crewOrder = ['gareth', 'quinn', 'talon', 'bones'];
            
            crewOrder.forEach(key => {
                const c = gameState.crew[key];
                if (!c) return; // Safety check

                const btn = document.createElement('button');
                const isSelected = activeCrewMember && activeCrewMember.name === c.name;
                // Determine if this crew member is available for FREE USE
                const isAvailableForFreeUse = gameState.crewUseFree && !c.used;

                let baseClass = "p-2 rounded border text-left transition-all relative overflow-hidden ";
                
                
                if (c.used) { 
                    // Used crew members are disabled
                    baseClass += "bg-black/50 border-gray-800 text-gray-700 cursor-not-allowed opacity-50";
                } else if (gameState.crewUseFree && isSelected) {
                     // Mushroom active AND this member is SELECTED: Apply purple glow to selected member
                     baseClass += "crew-free-use-glow";
                } else if (gameState.crewUseFree && !isSelected) {
                    // Mushroom active but NOT SELECTED: Apply purple pulse *only* if no crew member is active
                    if (!activeCrewMember) {
                        baseClass += "crew-free-use-glow";
                    } else {
                         baseClass += "bg-gray-800 border-gray-600 text-gray-300 hover:border-gray-400 hover:bg-gray-700"; // Normal styling if another crew member is already selected
                    }
                } else if (isSelected) {
                    // Standard selection glow
                    // Use new spectral-active class (MODIFIED)
                    baseClass += "spectral-active text-blue-100 ring-1 ring-blue-400";
                } else {
                    baseClass += "bg-gray-800 border-gray-600 text-gray-300 hover:border-gray-400 hover:bg-gray-700";
                }

                // --- TUTORIAL PULSE LOGIC FIX ---
                // Only pulse Quinn at the start if he is not used AND no one is selected
                if (gameState.currentSceneId === 'start' && c.name === 'Quinn' && !c.used && !activeCrewMember) {
                    baseClass += " tutorial-pulse";
                }
                // --- END TUTORIAL PULSE FIX ---

                btn.className = baseClass;
                // Only disable if USED
                btn.disabled = c.used; 
                btn.innerHTML = `
                    <div class="font-bold text-[12px] cinzel leading-tight">${c.name}</div>
                    <div class="text-[10px] ${isSelected || isAvailableForFreeUse ? 'text-white' : 'text-gray-500'}">${c.skill}</div>
                    ${c.used ? '<i class="fas fa-lock absolute top-1 right-1 text-[10px]"></i>' : ''}
                    ${isAvailableForFreeUse ? '<i class="fas fa-star absolute top-1 right-1 text-[10px] text-purple-300"></i>' : ''}
                `;
                btn.onclick = () => {
                    audioManager.playClick();
                    
                    if (isSelected) {
                        activeCrewMember = null;
                    } else {
                        activeCrewMember = c;
                        audioManager.playGhost(); // Only play when selecting
                    }
                    updateUI();
                };
                crewContainer.appendChild(btn);
            });

            // Inventory List View
            const invContainer = document.getElementById('inventory-panel');
            invContainer.innerHTML = '';
            
            // SCALABILITY FIX: Add scrolling for large inventories
            invContainer.className = "flex flex-col gap-1 max-h-[220px] overflow-y-auto pr-1"; // Added max-height & scroll

            const descArea = document.getElementById('item-desc-area');
            const defaultText = "Hover over an item to inspect it.";

            // Reset description area appearance
            descArea.innerText = defaultText;
            descArea.classList.remove('text-amber-400');
            descArea.classList.add('text-gray-400'); 
            
            if (gameState.inventory.length === 0) {
                invContainer.innerHTML = '<div class="text-center text-[10px] text-gray-600 italic py-2">Inventory Empty</div>';
            } else {
                // SORTING LOGIC: Consumables First, then Alphabetical
                const sortedInventory = [...gameState.inventory].sort((a, b) => {
                    const itemA = itemRegistry[a] || { type: 'misc' };
                    const itemB = itemRegistry[b] || { type: 'misc' };

                    // Priority 1: Consumables float to the top
                    if (itemA.type === 'consumable' && itemB.type !== 'consumable') return -1;
                    if (itemA.type !== 'consumable' && itemB.type === 'consumable') return 1;

                    // Priority 2: Alphabetical for tidiness
                    return a.localeCompare(b);
                });

                sortedInventory.forEach(itemName => {
                    const itemDef = itemRegistry[itemName] || { type: 'misc', icon: 'fa-box', color: 'text-gray-500', desc: "A strange item." };
                    const isConsumable = itemDef.type === 'consumable';
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = `group w-full flex items-center justify-between p-2 rounded border transition-all cursor-default relative shrink-0 ${
                        isConsumable 
                        ? 'bg-gray-900/80 border-emerald-900/50 hover:border-emerald-500 hover:bg-gray-800' 
                        : 'bg-gray-900/60 border-gray-800 hover:border-gray-600'
                    }`;

                    // Left Side: Icon + Name
                    const leftSide = document.createElement('div');
                    leftSide.className = 'flex items-center gap-3';
                    leftSide.innerHTML = `
                        <div class="text-lg w-5 text-center ${itemDef.color}"><i class="fas ${itemDef.icon}"></i></div>
                        <span class="text-xs cinzel text-gray-300 group-hover:text-gray-100 transition-colors">${itemName.split('(')[0].trim()}</span>
                    `;
                    itemRow.appendChild(leftSide);

                    // Right Side: Action Button or Tag
                    const rightSide = document.createElement('div');
                    if (isConsumable) {
                        const actionBtn = document.createElement('button');
                        actionBtn.className = "px-2 py-1 bg-emerald-900/40 border border-emerald-600/30 text-emerald-500 text-[9px] font-bold rounded hover:bg-emerald-600 hover:text-white transition-all tracking-wider";
                        actionBtn.innerText = itemDef.btnText || "USE";
                        actionBtn.onclick = (e) => {
                            e.stopPropagation();
                            audioManager.playClick();
                            const result = itemDef.action(gameState);
                            addToHistory(result, 'system');
                            saveGame();
                            updateUI();
                        };
                        rightSide.appendChild(actionBtn);
                    } else {
                        const tag = document.createElement('span');
                        tag.className = "text-[9px] text-gray-600 uppercase tracking-wider font-bold opacity-50 group-hover:opacity-100 transition-opacity";
                        tag.innerText = "PASSIVE";
                        rightSide.appendChild(tag);
                    }
                    itemRow.appendChild(rightSide);

                    // Hover Description Logic
                    itemRow.onmouseenter = () => {
                        descArea.innerText = itemDef.desc || defaultText;
                        descArea.classList.add('text-amber-400');
                        descArea.classList.remove('text-gray-400');
                    };
                    itemRow.onmouseleave = () => {
                        descArea.innerText = defaultText;
                        descArea.classList.remove('text-amber-400');
                        descArea.classList.add('text-gray-400');
                    };

                    invContainer.appendChild(itemRow);
                });
            }
        }

        init();
    </script>
</body>
</html>